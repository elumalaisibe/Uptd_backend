/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../Basemap","../../Ground","../../WebScene","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/extensions/serializableProperty/type","../../layers/GroupLayer","../../layers/KMLLayer","../../layers/mixins/operationalLayerModuleMap","../../layers/mixins/operationalLayers","../../layers/support/Sublayer","../../layers/support/source/DataLayerSource","../../layers/support/source/MapLayerSource","./utils"],(function(e,t,n,a,r,y,p,s,o,u,l,i,c,f,m){"use strict";async function d(e){return M(null,{typeName:"json",type:e},new m.ScanContext)}async function b(e,t,n){switch(t.typeName){case"array":await v(e,t,n);break;case"union":await S(e,t,n);break;case"json":await M(e,t,n);break;case"native":await w(e,t,n);break;case"enum":await g(e,t,n)}}async function w(e,t,n){n.addProperty({name:e,type:_(t),default:t.default})}function N(e){const t=e.slice();return t.sort(),t}async function g(e,t,n){const a=t.values.slice();t.nullable&&a.push(null),n.currentClass&&n.currentClass.typeValue&&"type"===e?n.addProperty({name:e,type:"string",enum:`"${n.currentClass.typeValue}"`}):n.addProperty({name:e,type:_(t),enum:N(a).map((e=>"string"==typeof e?`"${e}"`:`${e}`)).join("|"),default:t.default})}async function v(e,t,n){await b(`${e}[]`,t.elementType,n)}function T(e,t){if("json"===e.typeName){const t=e.type.__accessorMetadata__,n=t?.type,a=n&&E(n),r=a&&a.type,y=r||n&&n.type;if(y&&Array.isArray(y)&&1===y.length&&"string"==typeof y[0])return r?y[0]:B(n,y[0])}return t}async function S(e,t,n){const a=[];for(const r of t.types)if("native"!==r.type.typeName&&t.key){const t=`${e}<${T(r.type,r.value)}>`;await b(t,r.type,n)}else a.push(r.type);if(a.length){const r=a.map(_);t.nullable&&r.push("null"),r.sort(),n.addProperty({type:r.join("|"),name:e,default:t.default})}}async function k(e,r){return e.type===a&&"layers"===r?P("web-scene/operational-layers"):e.type!==t||"baseLayers"!==r&&"baseMapLayers"!==r?e.type===t&&"elevationLayers"===r||e.type===n&&"layers"===r?P("web-scene/ground"):e.type===s&&"layers"===r?P("web-scene/operational-layers",(e=>e!==s)):e.type!==c.JoinTableDataSource||"leftTableSource"!==r&&"rightTableSource"!==r?null:I({key:"type",base:null,typeMap:{"data-layer":c.DataLayerSource,"map-layer":f.MapLayerSource}}):P("web-scene/basemap")}async function h(e,t,n){const a=await k(e,t);return a||A(n)}function j(e){return e.prototype.declaredClass.replaceAll(".","/")}async function M(e,t,n){const a=t.type.__accessorMetadata__,r=j(t.type);if(!a)return e&&n.addProperty({name:e,type:"unknown"}),null;let y=r,p=null;const s=e&&e.match(/<([^>]+)>$/);s&&(y+=`--${s[1]}`,p=s[1]),t.type===i&&(y+=`--${n.currentClass?.name}`,p=n.currentClass?.name);const o=n.seen.get(y);if(o&&e)return n.addProperty({name:e,type:o}),o;const u={type:t.type,name:r,id:y,properties:[]};e&&(n.addProperty({name:e,type:u}),u.typeValue=p),n.push(e,u);for(const l in a){const e=a[l],r=F(e);if(!r||!r.enabled)continue;if(t.type===i){const e="esri/layers/TileLayer"===n.stack[n.stack.length-2].klass.name;if(e&&i.test.isMapImageLayerOverridePolicy(r.overridePolicy)||!e&&i.test.isTileImageLayerOverridePolicy(r.overridePolicy))continue}const y=r.target;if("string"==typeof y||null==y){const a=await h(t,l,e);if(!a)continue;await b("string"==typeof y?y:l,a,n)}else await L(t,y,n)}return n.pop()}async function L(e,t,n){for(const a in t){let r=await k(e,a);if(!r){const e=t[a];r=e.types?I(e.types):G(e.type),r.default=e.default,r=$(r)}await b(a,r,n)}}async function P(e,t){const n={typeName:"union",key:"layerType",types:[]};for(const a in l.supportedTypes[e]){if("web-scene/operational-layers"===e&&"ArcGISTiledElevationServiceLayer"===a)continue;const r=await u.typeModuleMap[a]();r&&(t&&!t(r)||r!==o&&n.types.push({type:{typeName:"json",type:r},value:a}))}if(0===n.types.length)return null;return{typeName:"array",elementType:1===n.types.length?n.types[0].type:n}}function _(e){switch(e.typeName){case"array":return`${_(e.elementType)}[]`;case"union":{const t=e.types.map((e=>_(e.type)));return e.nullable&&t.push("null"),t.sort(),`${t.join(" | ")}`}case"native":switch(e.type){case Number:return"number";case y.Integer:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string"}}function C(e){const t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:G(t)};if(t.typeMap){const e=[];for(const n in t.typeMap){const a=t.typeMap[n];e.push({type:G(a),value:z(a)?null:n})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:e}}}}function O(e){if("json"!==e.typeName)return null;const t=e.type.__accessorMetadata__,n=t?.type,a=n&&E(n),r=a&&a.type,y=r||n&&n.type;return y&&Array.isArray(y)&&"string"==typeof y[0]?r||n.type.map((e=>B(n,e))):null}function $(e){if("array"===e.typeName)return e.elementType=$(e.elementType),e;const t=O(e);return t?{typeName:"union",key:"type",nullable:e.nullable,types:t.map((t=>({value:t,type:e})))}:e}function A(e){const t=E(e);return t?.types?I(t.types):!t?.type&&e.types?I(e.types):x($(D(e)))}function x(e){return e.nullable&&"native"===e.typeName?{typeName:"union",key:null,types:[{value:null,type:e}],nullable:!0}:e}function I(e){if(Array.isArray(e))return{typeName:"array",elementType:I(e[0])};const t=[];for(const n in e.typeMap){const a=e.typeMap[n];t.push({type:G(a),value:z(a)?null:n})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function J(e){return null!=e&&e.isJSONMapWriter}function B(e,t){const n=F(e);if(n&&J(n.writer)){const e={value:""};return n.writer?.(t,e,"value"),e.value}return t}function D(e){const t=E(e),n=F(e),a=G(t&&t.type||e.type);return t&&void 0!==t.default&&"function"!=typeof t.default&&(a.default=B(e,t.default)),n?.allowNull&&(a.nullable=!0),a}function G(e){return e?y.isLongFormType(e)?V(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map((e=>({type:G(e),value:null})))}:{typeName:"array",elementType:G(e[0])}:p.isCollection(e)?C(e):z(e)?{typeName:"native",type:e}:W(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function V(e){switch(e.type){case"native":return{typeName:"native",type:e.value};case"array":return{typeName:"array",elementType:G(e.value)};case"one-of":return{typeName:"union",key:null,types:e.values.map((e=>({type:V(e),value:null})))}}}function W(e){let t=e;for(;t;){if(t.prototype&&("esri.core.JSONSupport"===t.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===t.prototype.declaredClass))return!0;t=Object.getPrototypeOf(t)}return!1}function z(e){return e===String||e===Boolean||e===Number||e===y.Integer||e===Object}function E(e){if(!e.json)return null;const t=e.json.origins,n=e.json,a=t&&t["web-scene"],r=t&&t["web-document"];return a||r||n||null}function F(e){if(!e.json)return null;const t=e.json.origins,n=e.json.write,a=t&&t["web-scene"]&&t["web-scene"].write,r=t&&t["web-document"]&&t["web-document"].write;return a||r||n||null}e.scan=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
