/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../symbols","../core/Error","../core/lang","../core/Logger","../core/object","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/diffUtils","../core/accessorSupport/ensureType","../layers/support/fieldUtils","../portal/Portal","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","./support/LegendOptions","./support/UniqueValue","./support/UniqueValueClass","./support/UniqueValueGroup","./support/UniqueValueInfo","../support/arcadeOnDemand","../chunks/persistableUrlUtils","../symbols/support/styleUtils","../symbols/WebStyleSymbol"],(function(e,t,s,i,o,l,r,n,u,a,c,p,d,f,h,y,_,m,b,v,V,g,q,I,S,w,U,F,O,G){"use strict";var D;const x="esri.renderers.UniqueValueRenderer",E=l.getLogger(x),j="uvInfos-watcher",M="uvGroups-watcher",k=",",N=y.ensureType(w);function P(e){const{field1:t,field2:s,field3:i,fieldDelimiter:o,uniqueValueInfos:l,valueExpression:r}=e,n=!(!t||!s);return[{classes:(l??[]).map((e=>{const{symbol:l,label:u,value:a,description:c}=e,[p,d,f]=n?a?.toString()?.split(o||"")||[]:[a],h=[];return(t||r)&&h.push(p),s&&h.push(d),i&&h.push(f),{symbol:l,label:u,values:[h],description:c}}))}]}let R=D=function(t){function l(e){var s;return(s=t.call(this,e)||this)._valueInfoMap={},s._isDefaultSymbolDerived=!1,s._isInfosSource=null,s.type="unique-value",s.backgroundFillSymbol=null,s.orderByClassesEnabled=!1,s.valueExpressionTitle=null,s.legendOptions=null,s.defaultLabel=null,s.portal=null,s.styleOrigin=null,s.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let s=!1;const i={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let o=0;o<t.length;o++){const l=e.find((e=>e.value===t[o].value));l?h.diff(l,t[o])?(i.changed.push({type:"complete",oldValue:l,newValue:t[o]}),s=!0):i.unchanged.push({oldValue:l,newValue:t[o]}):(i.added.push(t[o]),s=!0)}for(let o=0;o<e.length;o++){t.find((t=>t.value===e[o].value))||(i.removed.push(e[o]),s=!0)}return s?i:void 0}},s._set("uniqueValueInfos",[]),s._set("uniqueValueGroups",[]),s}e._inherits(l,t);var r=l.prototype;return r.castField=function(e){return null==e||"function"==typeof e?e:y.ensureString(e)},r.writeField=function(e,t,s,o){"string"==typeof e?t[s]=e:o&&o.messages?o.messages.push(new i("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):E.error(".field: cannot write field to JSON since it's not a string value")},r.readPortal=function(e,t,s){return s.portal||m.getDefault()},r.readStyleOrigin=function(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=F.fromJSON(t.styleUrl,s);return Object.freeze({styleUrl:e})}},r.writeStyleOrigin=function(e,t,s,i){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=F.toJSON(e.styleUrl,i))},r.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void E.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let i;i="object"==typeof e?N(e):new w({value:e,symbol:s.ensureType(t)}),this.uniqueValueInfos?.push(i),this._valueInfoMap[i.value]=i,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()},r.removeUniqueValueInfo=function(e){if(this.styleOrigin)return void E.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const t=this.uniqueValueInfos;if(t)for(let s=0;s<t.length;s++){if(t[s].value===e+""){delete this._valueInfoMap[e],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()},r.getUniqueValueInfo=async function(e,t){let s=t;return!this.valueExpression||null!=t&&null!=t.arcade||(s={...s,arcade:await U.loadArcade()}),this._getUniqueValueInfo(e,s)},r.getSymbol=function(e,t){if(this.valueExpression&&(null==t||null==t.arcade))return void E.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this._getUniqueValueInfo(e,t);return s&&s.symbol||this.defaultSymbol},r.getSymbolAsync=async function(e,t){let s=t;if(this.valueExpression&&(null==s||null==s.arcade)){const e=await U.loadArcade(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&await t.enableGeometryOperations(),s={...s,arcade:e}}const i=this._getUniqueValueInfo(e,s);return i&&i.symbol||this.defaultSymbol},r.getSymbols=function(){const e=[];for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e},r.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")},r.getMeshHash=function(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=this.uniqueValueInfos?.reduce(((e,t)=>e+t.getMeshHash()),"");return`${e}.${t}.${s}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`},r.clone=function(){const e=new D({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:o.clone(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:o.clone(this.visualVariables),legendOptions:o.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:o.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=o.clone(this.uniqueValueInfos),s=o.clone(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(o.clone(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e},r.collectRequiredFields=async function(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)},r.collectSymbolFields=async function(e,t){const s=[...this.getSymbols().map((s=>s.collectRequiredFields(e,t))),_.collectArcadeFieldNames(e,t,this.valueExpression)];_.collectField(e,t,this.field),_.collectField(e,t,this.field2),_.collectField(e,t,this.field3),await Promise.all(s)},r.populateFromStyle=function(){return O.fetchStyle(this.styleOrigin,{portal:this.portal}).then((e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach((s=>{const i=new G({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:s.name});this.defaultSymbol||s.name!==e.data.defaultItem||(this.defaultSymbol=i,this._isDefaultSymbolDerived=!0);const o=new w({value:s.name,symbol:i});t.push(o),this._valueInfoMap[s.name]=o})),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this}))},r._updateFieldDelimiter=function(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",k)},r._updateUniqueValues=function(){null!=this._isInfosSource&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())},r._updateValueInfoMap=function(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[t.value+""]=t},r._watchUniqueValueInfosAndGroups=function(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()},r._watchUniqueValueInfos=function(){this.removeHandles(j);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const s of e)t.push(n.watch((()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description})),((e,t)=>{e!==t&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)}),{sync:!0}));this.addHandles(t,j)}},r._watchUniqueValueGroups=function(){this.removeHandles(M);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const s of e){t.push(n.watch((()=>({classes:s.classes})),((e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)}),{sync:!0}));for(const e of s.classes??[])t.push(n.watch((()=>({symbol:e.symbol,values:e.values,label:e.label,description:e.description})),((e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)}),{sync:!0}))}this.addHandles(t,M)}},r._updateInfosFromGroups=function(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const e=[],{field:t,field2:s,field3:i,fieldDelimiter:o,uniqueValueGroups:l,valueExpression:r}=this;if(!t&&!r)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const n=!(!t||!s);for(const u of l)for(const t of u.classes??[]){const{symbol:l,label:r,values:u,description:a}=t;for(const t of u??[]){const{value:u,value2:c,value3:p}=t,d=[u];s&&d.push(c),i&&d.push(p);const f=n?d.join(o||""):d[0];e.push(new w({symbol:l,label:r,value:f,description:a}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()},r._updateGroupsFromInfos=function(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:t,field2:s,valueExpression:i,fieldDelimiter:o,uniqueValueInfos:l}=this;if(!t&&!i||!l.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const r=!(!t||!s),n=l.map((e=>{const{symbol:t,label:s,value:i,description:l}=e,[n,u,a]=r?i?.toString()?.split(o||"")||[]:[i];return new I({symbol:t,label:s,description:l,values:[new q({value:n,value2:u,value3:a})]})})),u=[new S({classes:n})];e&&Object.freeze(u),this._set("uniqueValueGroups",u),this._watchUniqueValueGroups()},r._getUniqueValueInfo=function(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)},r._getUnqiueValueInfoForExpression=function(e,t){const{viewingMode:s,scale:i,spatialReference:o,arcade:l}=t??{};let r=this._cache.compiledFunc;const n=l.arcadeUtils;if(!r){const e=n.createSyntaxTree(this.valueExpression);r=n.createFunction(e),this._cache.compiledFunc=r}const u=n.executeFunction(r,n.createExecContext(e,n.getViewInfo({viewingMode:s,scale:i,spatialReference:o})));return this._valueInfoMap[u+""]},r._getUnqiueValueInfoForFields=function(e){const t=this.field,s=e.attributes;let i;if("function"!=typeof t&&this.field2){const e=this.field2,o=this.field3,l=[];t&&l.push(s[t]),e&&l.push(s[e]),o&&l.push(s[o]),i=l.join(this.fieldDelimiter||"")}else"function"==typeof t?i=t(e):t&&(i=s[t]);return this._valueInfoMap[i+""]},l.fromPortalStyle=function(e,t){const s=new D(t&&t.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",t&&t.portal||m.getDefault());const i=s.populateFromStyle();return i.catch((t=>{E.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)})),i},l.fromStyleUrl=function(e,t){const s=new D(t&&t.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));const i=s.populateFromStyle();return i.catch((t=>{E.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)})),i},e._createClass(l,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"field",set:function(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}},{key:"field2",set:function(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}},{key:"field3",set:function(e){this._set("field3",e),this._updateUniqueValues()}},{key:"valueExpression",set:function(e){this._set("valueExpression",e),this._updateUniqueValues()}},{key:"defaultSymbol",set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}},{key:"fieldDelimiter",set:function(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}},{key:"uniqueValueGroups",set:function(e){this.styleOrigin?E.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}},{key:"uniqueValueInfos",set:function(e){this.styleOrigin?E.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]),l}(v.VisualVariablesMixin(b));t.__decorate([u.property({readOnly:!0})],R.prototype,"_cache",null),t.__decorate([c.enumeration({uniqueValue:"unique-value"})],R.prototype,"type",void 0),t.__decorate([u.property(V.rendererBackgroundFillSymbolProperty)],R.prototype,"backgroundFillSymbol",void 0),t.__decorate([u.property({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],R.prototype,"field",null),t.__decorate([a.cast("field")],R.prototype,"castField",null),t.__decorate([f.writer("field")],R.prototype,"writeField",null),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],R.prototype,"field2",null),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],R.prototype,"field3",null),t.__decorate([u.property({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],R.prototype,"orderByClassesEnabled",void 0),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],R.prototype,"valueExpression",null),t.__decorate([u.property({type:String,json:{write:!0}})],R.prototype,"valueExpressionTitle",void 0),t.__decorate([u.property({type:g.LegendOptions,json:{write:!0}})],R.prototype,"legendOptions",void 0),t.__decorate([u.property({type:String,json:{write:!0}})],R.prototype,"defaultLabel",void 0),t.__decorate([u.property(r.deepMerge({...V.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],R.prototype,"defaultSymbol",null),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],R.prototype,"fieldDelimiter",null),t.__decorate([u.property({type:m,readOnly:!0})],R.prototype,"portal",void 0),t.__decorate([p.reader("portal",["styleName"])],R.prototype,"readPortal",null),t.__decorate([u.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],R.prototype,"styleOrigin",void 0),t.__decorate([p.reader("styleOrigin",["styleName","styleUrl"])],R.prototype,"readStyleOrigin",null),t.__decorate([f.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],R.prototype,"writeStyleOrigin",null),t.__decorate([u.property({type:[S],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,s)=>(t.uniqueValueGroups||P(t)).map((e=>S.fromJSON(e,s)))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],R.prototype,"uniqueValueGroups",null),t.__decorate([u.property({type:[w],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],R.prototype,"uniqueValueInfos",null),R=D=t.__decorate([d.subclass(x)],R);return R}));
