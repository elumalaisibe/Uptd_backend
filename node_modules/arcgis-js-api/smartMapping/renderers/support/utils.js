/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../Color","../../../symbols","../../../core/has","../../../core/Error","../../../intl/date","../../../renderers/support/numberUtils","../../../renderers/support/pointCloud/PointSizeSplatAlgorithm","../../heuristics/outline","../../statistics/classBreaks","../../statistics/summaryStatistics","../../support/utils","../../../symbols/edges/SketchEdges3D","../../../symbols/edges/SolidEdges3D","../../../views/support/colorUtils","../../../symbols/MeshSymbol3D","../../../symbols/FillSymbol3DLayer","../../../symbols/SimpleFillSymbol","../../../symbols/PolygonSymbol3D","../../../symbols/ExtrudeSymbol3DLayer","../../../symbols/SimpleLineSymbol","../../../symbols/LineSymbol3D","../../../symbols/LineSymbol3DLayer","../../../symbols/PathSymbol3DLayer","../../../symbols/SimpleMarkerSymbol","../../../symbols/PointSymbol3D","../../../symbols/IconSymbol3DLayer","../../../symbols/ObjectSymbol3DLayer"],(function(e,t,n,l,o,i,s,a,r,u,c,m,d,f,y,p,h,b,g,w,S,D,v,V,x,z,B,k){"use strict";const F=/^(\d+(\.\d+)?)\s*(%)$/i,L=[0,0,0,.4],U=["hours","minutes","seconds"],I=[...m.defaultBasemapGroups.light,...m.defaultBasemapGroups.dark];function T(e,t,n){if("string"==typeof e){const t=n.getField(e);if(t&&"date"===t.type)return t.alias||t.name}else if("number"==typeof e||e instanceof Date){const n=null!=t&&U.includes(t)?"short-date-short-time":"short-date";return i.formatDate(e,i.convertDateFormatToIntlOptions(n))}return e}function A(e,t,n){return e+t>0&&0>e-t&&n<0?0:e}function C(e,t,n,l,o){const i="90-10"===n&&t?{min:t.classBreakInfos[0].maxValue,max:t.classBreakInfos[t.classBreakInfos.length-1].minValue,avg:null,stddev:null}:e,{avg:s,stddev:a,min:r,max:u}=i,c=M(i,!!l,o??!0);let m=c?c[0]:r,d=c?c[1]:u;return c?{minDataValue:m,maxDataValue:d,defaultValuesUsed:!0}:("above"===n?m=A(s,a,r):"below"===n&&(d=A(s,a,r)),{minDataValue:m,maxDataValue:d,defaultValuesUsed:!1})}function M(e,t,n){let l,o;const i=P({statistics:e,isDate:t});return i.defaultValuesUsed?(l=i.min,o=i.max):!n||null!=e.avg&&e.stddev||(l=e.min,o=e.max),null!=l&&null!=o?[l,o]:null}function P(e){let t,n,l=e&&e.statistics;if(l||(l={}),null==l.min)if(e.isDate){const e=R();t=e[0],n=e[1]}else t=0,n=100;else if(l.min===l.max)if(e.isDate){const e=R(l.min);t=e[0],n=e[1]}else l.min<0?(t=2*l.min,n=0):l.min>0?(t=0,n=2*l.min):(t=0,n=100);return{min:null!=t?t:l.min,max:null!=n?n:l.max,defaultValuesUsed:null!=t||null!=n}}function R(e){const t=("number"==typeof e?new Date(e):new Date).getUTCFullYear();let n=Date.UTC(t,0,1,12,0,0,0),l=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>l&&(l=e)),[n,l]}function j(e,n){const l=[],o=e.length;for(let i=0;i<n;i++)l.push(new t(e[i%o]));return l}function E({minDataValue:e,maxDataValue:t,defaultValuesUsed:n},l,o,i=!0){return n||"above"===o||"below"===o||"90-10"===o?Y(e,t,5):W(l,i)}function O(e,t){const{avg:n,stddev:l}=e,o=e.min,i=e.max;if(null==n||null==l){const[n,l]=M(e,t,!0);return Y(n,l,5)}const a=A(n,l,o),r=i-a,u=a-o,c=Math.max(r,u),m=a+c,d=a-c,f=a-c/2,y=c/2+a;return s.round([d,f,a,y,m],{strictBounds:!0})}function G(e,t){const{min:n,max:l}=t,[o,i,a,r,u]=e,c=null!=n&&o<n,m=null!=l&&u>l;if(null==n||null==l||!c&&!m)return e;const d=c?n:o,f=c?d+(a-d)/2:i,y=m?l:u,p=m?a+(y-a)/2:r;return s.round([d,f,a,p,y],{strictBounds:!0})}function Y(e,t,n){const l=(t-e)/(n-1),o=[e];for(let i=1;i<=n-2;i++)o.push(e+i*l);return o.push(t),s.round(o,{strictBounds:!0})}function W({min:e,max:t,avg:n,stddev:l},o=!0){if(null==e||null==t||null==n||null==l)return[];let i=n-l,a=n+l;i<e&&(i=e),a>t&&(a=t),o&&(n=i+(a-i)/2);let r=s.round([i,a],{strictBounds:!0});return i=r[0],a=r[1],r=[i,i+(n-i)/2,n,n+(a-n)/2,a],s.round(r,{strictBounds:!0})}function q(e,t,n){switch(t){case"point":case"multipoint":return n?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return n?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;default:return}}function N(e,t,n){switch(t){case"point":case"multipoint":case"polygon":{if(!("outline"in e))return null;const t={color:e.outline.color,width:e.outline.width};if(null!=n&&t.color){const e=t.color.clone();e.a=n,t.color=e}return t}default:return}}function $(e,t){const{type:n,size:l,color:o,outline:i}=t;let s;switch(e){case"point":case"multipoint":if("2d"===n)s=new x({color:o,size:l,outline:{color:i.color,width:i.width}});else if("3d-flat"===n)s=new z({symbolLayers:[new B({size:l,resource:{primitive:"circle"},material:{color:o},outline:{color:i.color,size:i.width}})]});else if(n?.includes("3d-volumetric")){const e="3d-volumetric-uniform"===n,i=new k({height:l,resource:{primitive:e?"sphere":"cylinder"},material:{color:o}});e||(i.width=t.widthAndDepth,i.depth=t.widthAndDepth),s=new z({symbolLayers:[i]})}break;case"polyline":"2d"===n?s=new S({color:o,width:l}):"3d-flat"===n?s=new D({symbolLayers:[new v({size:l,material:{color:o}})]}):"3d-volumetric"===n&&(s=new D({symbolLayers:[new V({width:"number"==typeof l?l:parseFloat(l),height:"number"==typeof l?l:parseFloat(l),material:{color:o}})]}));break;case"polygon":"2d"===n?s=new b({color:o,outline:{color:i.color,width:i.width}}):"3d-flat"===n?s=new g({symbolLayers:[new h({material:{color:o},outline:{color:i.color,size:i.width}})]}):"3d-volumetric"===n&&(s=new g({symbolLayers:[new w({size:l,material:{color:o}})]}));break;case"mesh":{const e=t.meshInfo?.colorMixMode,n=t.meshInfo?.edgesType;s=new p({symbolLayers:[new h({material:{color:o,colorMixMode:e||null},edges:"solid"===n?new f({color:L}):"sketch"===n?new d({color:L}):null})]});break}}return s}function H(e,t,n){const l=J({layer:e,fields:t});if(l.length)return new o(n,"Unknown fields: "+l.join(", ")+". You can only use fields defined in the layer schema");const i=K({layer:e,fields:t});return i.length?new o(n,"Unsupported fields: "+i.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}function J(e){const t=e.layer;return e.fields.filter((e=>!t.getField(e)))}function K(e){const t=e.layer;return e.fields.filter((e=>{const n=t.getFieldUsageInfo(e);return!n||!n.supportsRenderer}))}async function Q(e,t){const n={layer:e.layer,view:e.view,signal:e.signal},[l,o]=await Promise.all([u(e).catch(le),t?r(n).catch(le):null]),i=M({min:l?.minValue,max:l?.maxValue,avg:null,stddev:null},!1,!1);return{result:i?await u({...e,classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:i[0],maxValue:i[1],normalizationTotal:i[0]+i[1]}):l,defaultValuesUsed:!!i,outlineResult:o}}function X(e){return c(e)}function Z(e,t){let{minSize:n,maxSize:l}=e;if("height"===t){n=((l-n)/2+n)/(2*2.3),l*=2}return{minSize:n,maxSize:l}}function _(e){return F.test(e)}function ee(e){if(null==e)return;const t=e.match(F),n=Number(t[1]);return"%"===t[3]?new a({scaleFactor:n/100}):void 0}function te(e,t,n,l){e.startTime=t instanceof Date?t.getTime():t,e.endTime=n instanceof Date?n.getTime():n,e.units=l,e.field="string"==typeof t?t:"string"==typeof n?n:null}async function ne(e,t){let n=null,l=null;if(!e&&!t)return{basemapId:n,basemapTheme:l};if(!e&&t&&(e=t&&t.map?.basemap),e&&(n=m.getBasemapId(e,I,!1),n)){const e=m.getBasemapGroup(n);null!=e&&(l=e)}return n||"2d"!==t?.type||(l=await y.getBackgroundColorTheme(t),null!=l&&(n="dark"===l?"dark-gray":"gray")),{basemapId:n,basemapTheme:l}}function le(e){const t=e.name?.toLowerCase();if(!t||t?.includes(":insufficient-info")||t?.includes(":insufficient-data"))return null;throw e}e.clampAboveAndBelowStopValues=G,e.createColors=j,e.createDataValues=E,e.createDefaultStopValues=Y,e.createStopValues=W,e.createStopValuesForAboveBelow=O,e.createSymbol=$,e.errorCallback=le,e.formatDate=T,e.getBaseValueForAboveBelow=A,e.getBasemapInfo=ne,e.getClassBreaks=Q,e.getDataRange=C,e.getDefaultDataRange=M,e.getPointSizeAlgorithm=ee,e.getSizeRangeForAxis=Z,e.getSummaryStatistics=X,e.getSymbolOutlineFromScheme=N,e.getSymbolSizeFromScheme=q,e.isValidPointSize=_,e.updateAgeRendererAuthoringInfoVV=te,e.verifyBasicFieldValidity=H,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
