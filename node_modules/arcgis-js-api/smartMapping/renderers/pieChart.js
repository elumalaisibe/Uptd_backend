/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../symbols","../../core/arrayUtils","../../core/Error","../../core/screenUtils","../../intl/messages","../../layers/support/AggregateField","../../layers/support/ExpressionInfo","../../renderers/support/AttributeColorInfo","../../renderers/support/OthersCategory","../heuristics/outline","../heuristics/sizeRange","./size","./support/utils","../statistics/predominantCategories","../statistics/support/utils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/pieChart","../../symbols/support/cimSymbolUtils","../../symbols/SimpleLineSymbol"],(function(e,r,a,n,t,i,s,l,o,u,p,c,d,m,f,b,y,h,g,w,v,S,z,C,E,T,V,x,L,$,I,O){"use strict";const k=[L.LayerType.CSVLayer,L.LayerType.FeatureLayer,L.LayerType.OGCFeatureLayer,L.LayerType.GeoJSONLayer,L.LayerType.StreamLayer,L.LayerType.WFSLayer];async function B(e){if(!(e&&e.layer&&e.view&&e.attributes?.length))throw new m("pie-chart-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>10)throw new m("pie-chart-renderer:invalid-parameters","PieChart renderer does not support more than 10 attributes");e.forBinning&&V.verifyBinningParams(e,"pie-chart-renderer");const r={...e,layer:e.layer,view:e.view,attributes:e.attributes};r.shape=r.shape||"pie",r.othersCategoryEnabled??(r.othersCategoryEnabled=!0),r.includeSizeVariable=e.includeSizeVariable||!1;const a=e.forBinning?L.binningCapableLayerTypes:k,n=L.createLayerAdapter(r.layer,a,e.forBinning);if(!n)throw new m("pie-chart-renderer:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(a).join(", "));r.layer=n;const t=null!=r.signal?{signal:r.signal}:null;await Promise.all([e.view.when(),n.load(t)]);const i=n.geometryType,s="polygon"===i,l="point"===i||"multipoint"===i||s;if(r.outlineOptimizationEnabled=!!s&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=!!l&&r.sizeOptimizationEnabled,!l)throw new m("pie-chart-renderer:not-supported","PieChart renderer is only supported for point and polygon layers");const o=[],u=r.attributes;for(const c of u){const e=await x.getFieldsList({field:c.field,valueExpression:c.valueExpression});o.push(...e)}const p=C.verifyBasicFieldValidity(n,o.filter(Boolean),"pie-chart-renderer:invalid-parameters");if(p)throw p;return r}async function q(e){let r=e.pieChartScheme,a=null,n=null;const t=await C.getBasemapInfo(e.basemap,e.view);if(a=null!=t.basemapId?t.basemapId:null,n=null!=t.basemapTheme?t.basemapTheme:null,r)return{scheme:$.cloneScheme(r),basemapId:a,basemapTheme:n};const i=$.getSchemes({basemap:a,numColors:e.attributes.length,geometryType:e.layer.geometryType,basemapTheme:n});return i&&(r=i.primaryScheme,a=i.basemapId,n=i.basemapTheme),{scheme:r,basemapId:a,basemapTheme:n}}async function F(e,r){const{valueExpression:a,sqlExpression:n,sqlWhere:t}=T.getSumOfAttributesExpr(e.attributes),i=await b.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return z.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:a,sqlExpression:n,sqlWhere:t,sizeScheme:r,sizeOptimizationEnabled:e.sizeOptimizationEnabled,legendOptions:{title:i.sumOfCategories},view:e.view,signal:e.signal})}async function R(e){const[r,a]=await Promise.all([B(e),b.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")]),n=await q(r),t=n?.scheme;if(!t)throw new m("pie-chart-renderer:insufficient-info","Unable to find pie-chart scheme");const i=r.layer,{includeSizeVariable:l,sizeOptimizationEnabled:o,outlineOptimizationEnabled:u,view:p,signal:c}=r,y=t.sizeScheme,h=r.attributes,z=h.map((e=>e.field)).filter(d.isSome),[T,V,x,L]=await Promise.all([z.length>1?E({layer:i,fields:z,view:p,signal:c}):null,l?F(r,y):null,!l&&o?S({layer:i,view:p,signal:c}).catch(C.errorCallback):null,u?v({layer:i,view:p,signal:c}).catch(C.errorCallback):null]),I=T&&T.predominantCategoryInfos?{uniqueValueInfos:T.predominantCategoryInfos}:{uniqueValueInfos:z.map((e=>({value:e,count:0})))},k=C.createColors(t.colors,h.length),R=h.map(((e,r)=>new g({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:k[r]}))),P=i.geometryType,M=null!=y&&"background"in y&&y.background,U=new s({attributes:R,othersCategory:new w.OthersCategory({label:a.other,color:r.othersCategoryEnabled?t.colorForOthersCategory:null,threshold:.04}),holePercentage:"donut"===r.shape?.45:0,backgroundFillSymbol:M?C.createSymbol(P,{type:"2d",color:M.color,outline:C.getSymbolOutlineFromScheme(M,P,L?.opacity)}):null,size:f.toPt(t.size),outline:new O(C.getSymbolOutlineFromScheme(t,"point",L?.opacity)),legendOptions:r.legendOptions});if(V&&(o||V.visualVariables.forEach((e=>{"number"==typeof e.minSize&&"number"==typeof e.maxSize&&(e.minSize*=2.5,e.maxSize*=1.8)})),o&&"point"===P&&V.visualVariables.forEach((e=>{e?.minSize&&"object"==typeof e.minSize&&e.minSize?.stops?.forEach((e=>{e.size*=1.8}))})),U.authoringInfo=V.authoringInfo.clone(),U.visualVariables=V.visualVariables?.map((e=>e.clone()))),L?.visualVariables?.length){const e=L.visualVariables.map((e=>e.clone()));U.visualVariables?U.visualVariables.push(...e):U.visualVariables=e}return x?.minSize&&("point"===P&&x.minSize.stops?.forEach((e=>{e.size*=2.5})),"polygon"===P&&x.minSize.stops?.forEach((e=>{e.size*=1.8})),U.visualVariables?U.visualVariables.push(x.minSize):U.visualVariables=[x.minSize]),{renderer:U,pieChartScheme:$.cloneScheme(t),size:V,basemapId:n.basemapId,basemapTheme:n.basemapTheme,statistics:I}}const P=["unique-value","class-breaks"],M=new r("#aaaaaa"),U=new r("#5c5c5c"),j=[new r("#e60049"),new r("#0bb4ff"),new r("#50e991"),new r("#e6d800"),new r("#9b19f5"),new r("#ffa300"),new r("#dc0ab4"),new r("#b3d4ff"),new r("#00bfa0"),new r("#f0cccc")];async function A(e){if(!e||!e.layer)throw new m("pie-chart-cluster-renderer:missing-parameters","'layer' parameter is required");const r={...e};r.shape=r.shape||"pie",r.defaultSymbolEnabled??(r.defaultSymbolEnabled=!0);const a=e.layer;if(!L.getLayerTypes(k).includes(a.type))throw new m("pie-chart-cluster-renderer:invalid-parameters","'layer' must be one of these types: "+L.getLayerTypeLabels(k).join(", "));const n=null!=r.signal?{signal:r.signal}:null;await a.load(n);if(!("point"===a.geometryType))throw new m("pie-chart-cluster-renderer:invalid-parameters","Cluster renderers are only supported for point layers");const{renderer:t}=a;if(!t)throw new m("pie-chart-cluster-renderer:invalid-parameters","input layer does not have a renderer.");if(!P.includes(t.type))throw new m("pie-chart-cluster-renderer:invalid-parameters",`Cannot create a pie chart renderer for clusters based on a ${t.type} renderer.`);if("valueExpression"in t&&t.valueExpression)throw new m("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer whose renderer contains a valueExpression.");if("unique-value"===t.type){if(t.field2)throw new m("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a UniqueValueRenderer using more than one field.");if(null!=t.uniqueValueInfos&&t.uniqueValueInfos.length>10)throw new m("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer cannot be created from a UniqueValueRenderer with more than 10 unique value infos.")}if("class-breaks"===t.type){if(t.classBreakInfos.length<2)throw new m("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer renderer with a continuous color or size gradient.");if(t.classBreakInfos.length>10)throw new m("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with more than 10 class break infos.");if("class-breaks-size"===t?.authoringInfo?.type)throw new m("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with breaks varied by size instead of color.")}return r}async function N(e){const r=await A(e),{layer:a,shape:n,defaultSymbolEnabled:t,legendOptions:i}=r,{renderer:l}=a,o=(await b.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")).other;let u=[];"unique-value"===l?.type&&(u=_({renderer:l,defaultSymbolEnabled:t,defaultLabelBackup:o})),"class-breaks"===l?.type&&(u=D({renderer:l,defaultSymbolEnabled:t,defaultLabelBackup:o}));const p=[],c=[];for(const s of u){const{field:e,color:r}=s;p.push(e),c.push(new g({color:r,field:e.name,label:e.alias}))}return{fields:p,renderer:new s({attributes:c,legendOptions:i,holePercentage:"donut"===n?.45:0,outline:null,size:18,othersCategory:null})}}function _(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:n}=e,{field:t,defaultSymbol:i,defaultLabel:s}=r,l=r.uniqueValueInfos??[],o=i&&a,u=o?9:10,p=C.createColors(j,u),c=l.slice(0,u).map(((e,r)=>{const a=e.label,n=p[r];return{field:new y({name:W(e.value?.toString()),alias:a,onStatisticExpression:new h({title:`Field definition - ${a}`,expression:H(t,e),returnType:"number"}),statisticType:"sum"}),color:G(e.symbol,n)}}))??[];if(o){const e="cluster_default",r=s||n;c.push({field:new y({name:W(e),alias:r,onStatisticExpression:new h({title:`Field definition - ${r}`,expression:J(t,l),returnType:"number"}),statisticType:"sum"}),color:G(i,U)})}return c}function D(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:n}=e,{field:t,classBreakInfos:i,defaultSymbol:s,defaultLabel:l}=r,o=s&&a,u=o?9:10,p=C.createColors(j,u),c=i.slice(0,u).map(((e,r)=>{const a=e.label||`${e.minValue} - ${e.maxValue}`,n=p[r];return{field:new y({name:W(a),alias:a,onStatisticExpression:new h({title:`Field definition - ${a}`,expression:Z(t,e),returnType:"number"}),statisticType:"sum"}),color:G(e.symbol,n)}}));if(o){const e="cluster_default",r=l||n;c.push({field:new y({name:W(e),alias:r,onStatisticExpression:new h({title:`Field definition - ${r}`,expression:K(t,i),returnType:"number"}),statisticType:"sum"}),color:G(s,U)})}return c}function W(e){return"SUM_"+(e+"").replaceAll(/[^a-zA-Z0-9_]/g,"_")}function G(e,r){if("simple-marker"===e?.type&&e.color)return e.color.clone();if("cim"===e?.type){const r=I.getCIMSymbolColor(e);if(r)return r.clone()}return r?r.clone():M.clone()}function H(e,r){return`Number(Text($feature["${e}"]) == "${r.value+""}")`}function J(e,r){return`Number(!(${r.map((r=>`(Text($feature["${e}"]) == "${r.value+""}")`)).join(" || ")}))`}function Z(e,r){return`Number($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`}function K(e,r){return`Number(!(${r.map((r=>`($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`)).join(" || ")}))`}e.createRenderer=R,e.createRendererForClustering=N,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
