/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../Color","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../core/Error","../../renderers/support/AuthoringInfo","../../renderers/support/HeatmapColorStop","../../renderers/support/heatmapUtils","./support/utils","../statistics/heatmapStatistics","../support/utils","../support/adapters/support/layerUtils","../symbology/heatmap"],(function(e,a,r,t,n,s,i,o,l,d,m,p,u,c,f,y,h,w,b,R){"use strict";const g=.01;async function T(e){if(!(e&&e.layer&&e.view))throw new p("heatmap-renderer:missing-parameters","'layer' and 'view' parameters are required");const a={...e,layer:e.layer,view:e.view};a.radius??(a.radius=null==a.blurRadius?18:f.gaussianBlurRadiusPxToKernelDensityRadiusPt(a.blurRadius)),a.minRatio??(a.minRatio=.01),a.maxRatio??(a.maxRatio=1),a.fadeRatio??(a.fadeRatio=.2),a.fadeToTransparent??(a.fadeToTransparent=!0);const r=[b.LayerType.CSVLayer,b.LayerType.FeatureLayer,b.LayerType.OGCFeatureLayer,b.LayerType.GeoJSONLayer,b.LayerType.StreamLayer,b.LayerType.WFSLayer],t=b.createLayerAdapter(a.layer,r);if(!t)throw new p("heatmap-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(r).join(", "));a.layer=t;const n=null!=a.signal?{signal:a.signal}:null;await t.load(n);const s=await w.getFieldsList({field:a.field}),i=y.verifyBasicFieldValidity(t,s,"heatmap-renderer:invalid-parameters");if(i)throw i;return a}async function L(e){let a=e.scheme,r=null,t=null;const n=await y.getBasemapInfo(e.basemap,e.view);if(r=null!=n.basemapId?n.basemapId:null,t=null!=n.basemapTheme?n.basemapTheme:null,a)return{scheme:R.cloneScheme(a),basemapId:r,basemapTheme:t};const s=R.getSchemes({basemap:r,basemapTheme:t});return s&&(a=s.primaryScheme,r=s.basemapId,t=s.basemapTheme),{scheme:a,basemapId:r,basemapTheme:t}}async function S(e,r){const{fieldOffset:t}=e,{field:n,basemap:i,radius:o,fadeToTransparent:l,heatmapScheme:d,view:m}=r,{scheme:p,basemapId:f,basemapTheme:h}=await L({basemap:i,scheme:d,view:m}),w=p.colors,b=w.length,T=!e.count,S=T?[0,.04]:[e.min,e.max];let v;const x=r.fadeRatio??0,C=r.maxRatio??0,O=r.minRatio??0,D=(C-O)/(b-1),F=w[0],U=l?O:g,B=[new c({ratio:0,color:new a([F.r,F.g,F.b,0])}),new c({ratio:g,color:new a([F.r,F.g,F.b,0])}),new c({ratio:U,color:new a([F.r,F.g,F.b,U])})];y.createColors(w,b).forEach(((e,a)=>{const r=O+D*a;B.push(new c({ratio:r,color:e}))})),l&&(I(B,x),v=new u({fadeRatio:x}));const P=new s({authoringInfo:v,radius:o,colorStops:B,field:n,minDensity:S[0],maxDensity:S[1]});return null!=t&&(P.fieldOffset=t),{renderer:P,statistics:e,defaultValuesUsed:T,scheme:R.cloneScheme(p),basemapId:f,basemapTheme:h}}function I(e,a){const r=10*(1-a)+1;e.forEach(((e,t)=>{if(t<=2)return;const{ratio:n,color:s}=e;s.a=0===a?1:Math.min(Math.max(n*r,0),1)}))}async function v(e){const a=await T(e);return S(a.statistics??await h({layer:a.layer,field:a.field,fieldOffset:a.fieldOffset,radius:a.radius,view:a.view,signal:a.signal}),a)}function x(e){const{fadeRatio:a,renderer:r}=e,t=r.clone(),n=a??(t?.authoringInfo?.fadeRatio||0);return I(t.colorStops,n),t.authoringInfo?t.authoringInfo.fadeRatio=n:t.authoringInfo=new u({fadeRatio:n}),t}e.createRenderer=v,e.updateRenderer=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
