/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/support/rasterFunctions/stretchUtils","./RasterLayerAdapter"],(function(t,e,r,a,s,i,o,n,l,c,h){"use strict";let p=function(e){function a(){return e.apply(this,arguments)||this}t._inherits(a,e);var s=a.prototype;return s.generateRasterInfo=async function(t){const{layer:e}=this,r=t?.rasterFunction;if("imagery-tile"===e.type&&r)try{return e.generateRasterInfo(r,{signal:t?.signal})}catch{return e.rasterInfo}return this.rasterInfo},s.estimateStatisticsHistograms=async function(t){if(null!==this._statsCache)return this._statsCache;const{raster:e}=this.layer,{extent:a,width:s,height:i}=this._getSamplePixelBlockDescriptor(e.rasterInfo),{pixelBlock:o}=await e.fetchPixels(a,s,i,t);if(null==o)throw new r("raster-layer-adapter","Unable to estimate histograms");return this._statsCache=c.estimateStatisticsHistograms(o),this._statsCache},s.supportsMultidirectionalHillshade=function(){return!0},s.load=function(t){return this.addResolvingPromise(this.layer.load(t).then((()=>this.rasterInfo=this.layer.raster.rasterInfo))),Promise.resolve(this)},s._getSamplePixelBlockDescriptor=function(t,e=1e3){const{pyramidScalingFactor:r,maximumPyramidLevel:a}=t.storageInfo;let{extent:s,width:i,height:o,pixelSize:n}=t,c=Math.ceil(Math.log(Math.max(i,o)/e)/Math.log(r))-1,h=0,p=0;if(c<=a){const t=r**c;i=Math.floor(i/t),o=Math.floor(o/t)}else c=0,i=Math.min(i,e),o=Math.min(o,e),h=Math.max(Math.floor(i/2-500),0),p=Math.max(Math.floor(o/2-500),0),s=new l({xmin:s.xmin+h*n.x,xmax:Math.min(s.xmax,s.xmin+h*n.x*e),ymin:s.ymin+p*n.y,ymax:Math.min(s.ymax,s.ymin+p*n.y*e)});return{extent:s,width:i,height:o,origin:{x:h,y:p}}},t._createClass(a)}(h);e.__decorate([a.property()],p.prototype,"layer",void 0),p=e.__decorate([n.subclass("esri.smartMapping.support.adapters.ImageryTileLayerAdapter")],p);return p}));
