/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../core/Error","../../core/has","../../core/promiseUtils","../../layers/support/infoFor3D","../../layers/support/source/DataLayerSource","./executeQueryJSON","./executeQueryPBF","../support/FeatureSet","../support/Query"],(function(e,t,r,o,a,n,s,u,i,c,l){"use strict";async function f(e,t,r,o){return p(t,await m(e,t,r,o),r,o)}async function m(e,t,r,a){const n={...a},s=y(t,r),c=null!=t.outStatistics?.[0],l=o("featurelayer-pbf-statistics"),f=!c||l;let m;if("pbf"===r?.format&&f)try{m=await i.executeRawQueryPBF(e,s,n)}catch(p){if("query:parsing-pbf"!==p.name)throw p;r.format="json"}return"json"!==r?.format&&f||(m=await u.executeRawQueryJSON(e,s,n)),d(r?.fieldsIndex,m.fields),m}function d(e,t){if(null!=e&&null!=t)for(const r of t){const t=e.get(r.name);t&&Object.assign(r,t.toJSON())}}async function p(t,r,o,n){const s=o?.infoFor3D;if(!(F(t,s)&&null!=s&&r.assetMaps&&r.features&&r.features.length))return c.fromJSON(r);const{meshFeatureSetFromJSON:u}=await a.whenOrAbort(new Promise(((t,r)=>e(["../support/meshFeatureSet"],t,r))),n);return u(t,s,r)}function y(e,t){let o=l.from(e);o.sourceSpatialReference=o.sourceSpatialReference??t?.sourceSpatialReference??null,(t?.gdbVersion||t?.dynamicDataSource)&&(o=o===e?o.clone():o,o.gdbVersion=e.gdbVersion||t.gdbVersion,o.dynamicDataSource=e.dynamicDataSource?s.DataLayerSource.from(e.dynamicDataSource):t.dynamicDataSource);const a=t?.infoFor3D;if(null!=a&&F(e,a)){o=o===e?o.clone():o,o.formatOf3DObjects=null;const{supportedFormats:t,queryFormats:s}=a,u=n.getMimeTypeFormatId("model/gltf-binary",t)??n.getFilenameFormatId("glb",t),i=n.getMimeTypeFormatId("model/gltf+json",t)??n.getFilenameFormatId("gtlf",t);for(const e of s){if(e===u){o.formatOf3DObjects=e;break}e!==i||o.formatOf3DObjects||(o.formatOf3DObjects=e)}if(!o.formatOf3DObjects)throw new r("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==o.outFields||!o.outFields.includes("*")){o=o===e?o.clone():o,null==o.outFields&&(o.outFields=[]);const{originX:t,originY:r,originZ:n,translationX:s,translationY:u,translationZ:i,scaleX:c,scaleY:l,scaleZ:f,rotationX:m,rotationY:d,rotationZ:p,rotationDeg:y}=a.transformFieldRoles;o.outFields.push(t,r,n,s,u,i,c,l,f,m,d,p,y)}}return o}function F(e,t){return null!=t&&!0===e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics}t.executeQuery=f,t.executeRawQuery=m,t.normalizeFields=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
