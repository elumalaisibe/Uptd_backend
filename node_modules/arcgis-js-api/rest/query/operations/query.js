/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../request","../../../core/urlUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../operations/urlUtils","./pbfQueryUtils","./queryZScale"],(function(e,t,n,r,u,i,a,o){"use strict";const l="Layer does not support extent calculation.";function s(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const n=e.toJSON();return delete n.spatialReference,JSON.stringify(n)}function y(e,t){const n=e.geometry,u=e.toJSON();delete u.compactGeometryEnabled,delete u.defaultSpatialReferenceEnabled;const i=u;let a,o,l;if(null!=n&&(o=n.spatialReference,l=n.spatialReference.wkid||JSON.stringify(n.spatialReference),i.geometryType=r.getJsonType(n),i.geometry=s(n,e.compactGeometryEnabled),i.inSR=l),u.groupByFieldsForStatistics&&(i.groupByFieldsForStatistics=u.groupByFieldsForStatistics.join(",")),u.objectIds&&(i.objectIds=u.objectIds.join(",")),u.orderByFields&&(i.orderByFields=u.orderByFields.join(",")),!u.outFields||!u.returnDistinctValues&&(t?.returnCountOnly||t?.returnExtentOnly||t?.returnIdsOnly)?delete i.outFields:u.outFields.includes("*")?i.outFields="*":i.outFields=u.outFields.join(","),u.outSR?(i.outSR=u.outSR.wkid||JSON.stringify(u.outSR),a=e.outSpatialReference):n&&(u.returnGeometry||u.returnCentroid)&&(i.outSR=i.inSR,a=o),u.returnGeometry&&delete u.returnGeometry,u.outStatistics&&(i.outStatistics=JSON.stringify(u.outStatistics)),u.fullText&&(i.fullText=JSON.stringify(u.fullText)),u.pixelSize&&(i.pixelSize=JSON.stringify(u.pixelSize)),u.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=o&&null!=e.quantizationParameters&&null!=e.quantizationParameters.extent&&o.equals(e.quantizationParameters.extent.spatialReference)&&delete u.quantizationParameters.extent.spatialReference,i.quantizationParameters=JSON.stringify(u.quantizationParameters)),u.parameterValues&&(i.parameterValues=JSON.stringify(u.parameterValues)),u.rangeValues&&(i.rangeValues=JSON.stringify(u.rangeValues)),u.dynamicDataSource&&(i.layer=JSON.stringify({source:u.dynamicDataSource}),delete u.dynamicDataSource),u.timeExtent){const e=u.timeExtent,{start:t,end:n}=e;null==t&&null==n||(i.time=t===n?t:`${t??"null"},${n??"null"}`),delete u.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=o&&null!=a&&o.equals(a)&&(i.defaultSR=i.inSR,delete i.inSR,delete i.outSR),i}async function c(e,t,n,r){const u=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await x(e,t,"json",r);return o.applyFeatureSetZUnitScaling(t,n,u.data),u}async function d(e,t,n,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:n.createFeatureResult()};const u=await f(e,t,r),i=u;return i.data=a.parsePBFFeatureQuery(u.data,n),i}function f(e,t,n){return x(e,t,"pbf",n)}function m(e,t,n){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):x(e,t,"json",n,{returnIdsOnly:!0})}function p(e,t,n){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):x(e,t,"json",n,{returnIdsOnly:!0,returnCountOnly:!0})}async function S(e,t,n){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const r=await x(e,t,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}),u=r.data;if(u.hasOwnProperty("extent"))return r;if(u.features)throw new Error(l);if(u.hasOwnProperty("count"))throw new Error(l);return r}async function x(e,r,a,o={},l={}){const s="string"==typeof e?n.urlToObject(e):e,c=r.geometry?[r.geometry]:[];o.responseType="pbf"===a?"array-buffer":"json";const d=await u.normalizeCentralMeridian(c,null,o),f=d&&d[0];null!=f&&((r=r.clone()).geometry=f);const m=i.mapParameters({...s.query,f:a,...l,...y(r,l)});return t(n.join(s.path,g(r,l)?"query3d":"query"),{...o,query:{...m,...o.query}})}function g(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}e.encodeGeometry=s,e.executeQuery=c,e.executeQueryForCount=p,e.executeQueryForExtent=S,e.executeQueryForIds=m,e.executeQueryPBF=d,e.executeQueryPBFBuffer=f,e.queryToQueryStringParameters=y,e.runQuery=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
