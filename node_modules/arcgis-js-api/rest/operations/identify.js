/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../core/sql","../../geometry/support/jsonUtils","../../geometry/support/scaleUtils","../../layers/support/floorFilterUtils","../../layers/support/sublayerUtils"],(function(e,t,r,n,i,s){"use strict";const l=e=>e.spatialReference.wkid||JSON.stringify(e.spatialReference);function o(e,t){const{dpi:n,gdbVersion:i,geometry:s,geometryPrecision:o,height:y,layerOption:f,mapExtent:p,maxAllowableOffset:u,returnFieldName:c,returnGeometry:d,returnUnformattedValues:m,returnZ:g,spatialReference:x,timeExtent:S,tolerance:b,width:E}=e.toJSON(),{dynamicLayers:O,layerDefs:h,layerIds:N}=a(e),J=t&&null!=t.geometry?t.geometry:null,R={geometryPrecision:o,maxAllowableOffset:u,returnFieldName:c,returnGeometry:d,returnUnformattedValues:m,returnZ:g,tolerance:b},I=J&&J.toJSON()||s;if(R.imageDisplay=`${E},${y},${n}`,i&&(R.gdbVersion=i),I&&(delete I.spatialReference,R.geometry=JSON.stringify(I),R.geometryType=r.getJsonType(I)),x?R.sr=x.wkid||JSON.stringify(x):I&&I.spatialReference?R.sr=l(I):p&&p.spatialReference&&(R.sr=l(p)),R.time=S?[S.start,S.end].join(","):null,p){const{xmin:e,ymin:t,xmax:r,ymax:n}=p;R.mapExtent=`${e},${t},${r},${n}`}return h&&(R.layerDefs=h),O&&!h&&(R.dynamicLayers=O),R.layers="popup"===f?"visible":f,N&&!O&&(R.layers+=`:${N.join(",")}`),R}function a(e){const{mapExtent:t,floors:r,width:l,sublayers:o,layerIds:a,layerOption:f,gdbVersion:p}=e,u=o?.find((e=>null!=e.layer))?.layer?.serviceSublayers,c="popup"===f,d={},m={extent:t,width:l,spatialReference:t?.spatialReference},g=n.getScale(m),x=[],S=e=>{const t=0===g,r=0===e.minScale||g<=e.minScale,n=0===e.maxScale||g>=e.maxScale;if(e.visible&&(t||r&&n))if(e.sublayers)e.sublayers.forEach(S);else{if(!1===a?.includes(e.id)||c&&(!e.popupTemplate||!e.popupEnabled))return;x.unshift(e)}};if(o?.forEach(S),o&&!x.length)d.layerIds=[];else{const e=s.isExportDynamic(x,u,p),t=x.map((e=>{const t=i.getLayerFloorFilterClause(r,e);return e.toExportImageJSON(t)}));if(e)d.dynamicLayers=JSON.stringify(t);else{if(o){let e=x.map((({id:e})=>e));a&&(e=e.filter((e=>a.includes(e)))),d.layerIds=e}else a?.length&&(d.layerIds=a);const e=y(r,x);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(d.layerDefs=JSON.stringify(t))}}}return d}function y(e,r){const n=!!e?.length,s=r.filter((e=>null!=e.definitionExpression||n&&null!=e.floorInfo));return s.length?s.map((r=>{const n=i.getLayerFloorFilterClause(e,r),s=t.sqlAnd(n,r.definitionExpression);return{id:r.id,definitionExpression:s??void 0}})):null}e.identifyToIdentifyRESTParameters=o,e.toDynamicLayersJSON=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
