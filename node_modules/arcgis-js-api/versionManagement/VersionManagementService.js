/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../request","../core/JSONSupport","../core/Loadable","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../rest/utils","./support/versionManagementUtils"],(function(e,t,r,o,n,i,s,a,l,u,c,d,f,p,m,g){"use strict";const h=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var V;let v=V=function(r){function n(e){var t;return(t=r.call(this,e)||this).sourceJSON=null,t.capabilities=null,t}t._inherits(n,r);var i=n.prototype;return i.initialize=function(){V.versionCollection.has(this.url)||V.versionCollection.set(this.url,new Map);const e=(V.versionCollectionCount.get(this.url)??0)+1;V.versionCollectionCount.set(this.url,e)},i.destroy=function(){const e=(V.versionCollectionCount.get(this.url)??1)-1;V.versionCollectionCount.set(this.url,e),0===e&&V.versionCollection.delete(this.url)},i.read=function(e,r){this.sourceJSON=e,t._get(t._getPrototypeOf(n.prototype),"read",this).call(this,e,r)},i.readDefaultVersionIdentifier=function(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}},i.writeDefaultVersionIdentifier=function(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid},i.load=function(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)},i.createVersion=async function(t){const[{createVersion:r},{default:o}]=await Promise.all([new Promise(((t,r)=>e(["../rest/versionManagement/createVersion"],t,r))),new Promise(((t,r)=>e(["../rest/versionManagement/support/CreateVersionParameters"],(e=>t(h(e))),r)))]),n=o.from(t);return r(this.url,n)},i.deleteVersion=async function(t){const[{deleteVersion:r},{default:o}]=await Promise.all([new Promise(((t,r)=>e(["../rest/versionManagement/deleteVersion"],t,r))),new Promise(((t,r)=>e(["../rest/versionManagement/support/DeleteVersionParameters"],(e=>t(h(e))),r)))]);let n;t.guid&&V.versionCollection.get(this.url)?.has(t.guid)&&(n=g.currentSessionId??void 0);const i=new o({versionName:t.name,sessionId:n});return r(this.url,i)},i.getVersionInfoExtended=async function(t){const{getVersion:r}=await new Promise(((t,r)=>e(["../rest/versionManagement/getVersion"],t,r)));return r(this.url,t.guid)},i.getVersionInfos=async function(t={}){const[{getVersionInfos:r},{default:o}]=await Promise.all([new Promise(((t,r)=>e(["../rest/versionManagement/getVersionInfos"],t,r))),new Promise(((t,r)=>e(["../rest/versionManagement/support/GetVersionInfosParameters"],(e=>t(h(e))),r)))]),n=o.from(t);return r(this.url,n)},i.getLockType=function(e){const t=V.versionCollection.get(this.url)?.get(e.guid)?.lockType;return t??"none"},i.changeVersion=function(e,t,r){let o;o="layers"in e?e.allTables.concat(e.allLayers):e;const n=new s.Url(this.url).host;let i=null,a=null,l=null,u=null;const c=e=>!e||e===this.defaultVersionIdentifier.name,d=e=>{const t=V.versionCollection?.get(this.url)?.get(e.guid);l=e.name,u=t?.moment??null},f=(e,t)=>!e&&!t||!(!e||!t)&&e.toISOString()===t.toISOString();if("name"in t){if("none"!==this.getLockType(t))return!1;i=t.name,a=null,"name"in r?d(r):(l=this.defaultVersionIdentifier.name,u=r)}else i=this.defaultVersionIdentifier.name,a=t,"name"in r?d(r):(l=this.defaultVersionIdentifier.name,u=r);const p=c(i);for(const m of o)if("feature"===m.type){const e=m,t=new s.Url(e.url??null).host;n.toLowerCase()===t.toLowerCase()&&(p&&c(m.gdbVersion)&&f(m.historicMoment,a)||i===m.gdbVersion&&f(m.historicMoment,a))&&(m.gdbVersion=l,m.historicMoment=u)}return!0},i._fetchService=async function(e,t){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:m.parseUrl(e)});const r=await o(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data)},t._createClass(n)}(n.JSONSupportMixin(i));v.versionCollection=new Map,v.versionCollectionCount=new Map,r.__decorate([a.property()],v.prototype,"url",void 0),r.__decorate([a.property()],v.prototype,"sourceJSON",void 0),r.__decorate([a.property({type:String,json:{write:!0}})],v.prototype,"name",void 0),r.__decorate([a.property({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],v.prototype,"defaultVersionIdentifier",void 0),r.__decorate([d.reader("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],v.prototype,"readDefaultVersionIdentifier",null),r.__decorate([p.writer("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],v.prototype,"writeDefaultVersionIdentifier",null),r.__decorate([a.property({json:{write:!0}})],v.prototype,"capabilities",void 0),v=V=r.__decorate([f.subclass("esri.versionManagement.VersionManagementService")],v);return v}));
