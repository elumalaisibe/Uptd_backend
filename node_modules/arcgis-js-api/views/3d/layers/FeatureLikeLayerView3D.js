/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/hydratedFeatures","../../../layers/graphics/controllers/FeatureTileController3D","../../../rest/support/Query","../../../symbols/support/utils","./graphics/elevationAlignPointsInFeatures","./graphics/Graphics3DFeatureProcessor","./graphics/QueryEngine","./graphics/queryForSymbologySnapping","./support/HeatmapFeatureProcessor","./support/projectExtentUtils","../webgl-engine/lib/UpdatePolicy","../../support/Scheduler"],(function(e,t,r,o,s,i,n,a,l,p,c,u,y,h,d,g,f,m,_,b,E,v,P){"use strict";const w=e=>{let a=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).controller=null,t.updatePolicy=v.UpdatePolicy.SYNC,t.suspendResumeExtentMode="computed",t.slicePlaneEnabled=!1,t.fullExtentInLocalViewSpatialReference=null,t.suspendResumeExtent=null,t._controllerCreated=!1,t.supportsHeightUnitConversion=!0,t._pendingController=null,t.queryEngine=null,t}t._inherits(r,e);var n=r.prototype;return n.initialize=function(){const e=this.layer;if("isTable"in e&&e.isTable)return void this.addResolvingPromise(Promise.reject(new o("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e})));this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add((()=>this.layer.renderer),(e=>this._recreateProcessor(e)),i.initial),this.addResolvingPromise((async()=>{const e=await E.toViewIfLocal(this);this.fullExtentInLocalViewSpatialReference=e,await this._initializeController()})()),this.updatingHandles.add((()=>this.updatePolicy),(e=>this.processor.preferredUpdatePolicy=e));const t=()=>this.processor.featureStore;this.queryEngine=new m.QueryEngine({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return t()},hasZ:this.hasZ,hasM:this.hasM},priority:P.TaskPriority.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")},n.destroy=function(){this._destroyPendingController(),this.controller=s.destroyMaybe(this.controller),this._set("processor",s.destroyMaybe(this.processor)),this.queryEngine=s.destroyMaybe(this.queryEngine),this.loadedGraphics=null},n._destroyPendingController=function(){this._pendingController=s.destroyMaybe(this._pendingController)},n.getHit=function(e){let t;return this.loadedGraphics?.forEach((r=>{r.uid===e&&(t=u.hydrateGraphic(r,this.layer))})),t?{type:"graphic",graphic:t,layer:t.layer}:null},n.whenGraphicBounds=function(e,t){return this.processor?.whenGraphicBounds(e,t)},n.computeAttachmentOrigin=function(e,t){return this.processor?.computeAttachmentOrigin(e,t)},n.elevationAlignPointsInFeatures=async function(e,t){const r=this.graphics3DProcessor;if(null==r)throw new o("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return g.elevationAlignPointsInFeatures(this.view,this.layer,(e=>r.getGraphics3DGraphicByObjectId(e)),e,t)},n.queryForSymbologySnapping=async function(e,t){return this.symbologySnappingSupported?_.queryForSymbologySnapping(this.graphics3DProcessor,e,t):{candidates:[],sourceCandidateIndices:[]}},n.queryFeatures=function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),t?.signal)},n.queryObjectIds=function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),t?.signal)},n.queryFeatureCount=function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),t?.signal)},n.queryExtent=function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),t?.signal)},n._ensureQuery=function(e){return null==e?this.createQuery():h.from(e)},n.highlight=function(e){return this.processor.highlight(e,this.layer.objectIdField)},n.maskOccludee=function(e){return this.processor.maskOccludee(e)},n.canResume=function(){return t._get(t._getPrototypeOf(r.prototype),"canResume",this).call(this)&&!this.processor?.scaleVisibilitySuspended},n.getSuspendInfo=function(){const e=t._get(t._getPrototypeOf(r.prototype),"getSuspendInfo",this).call(this);return this.processor?{...e,...this.processor.suspendInfo}:e},n.isUpdating=function(){return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)},n._initializeController=async function(){const e=this.createController();this._pendingController=e,await e.when(),this._setControllerWhenInitialized(e)},n._setControllerWhenInitialized=async function(e){try{await this.when()}catch(t){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await i.whenOnce((()=>this.view?.basemapTerrain?.ready)),this.beforeSetController(e),this._pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this._destroyPendingController()},n._updateClippingExtent=function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}},n._validateGeometryType=async function(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new o("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}},n._recreateProcessor=function(e){const t="heatmap"===e?.type,r="heatmap"===this.processor?.type,o=this.processor;if(o&&t===r)return;const s=t?new b.HeatmapFeatureProcessor({owner:this}):new f({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this._set("processor",s),o?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(s.initializePromise)},n._getResourceInfo=function(){const e=this.controller instanceof y.FeatureTileController3D?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics?.length,maximumNumberOfFeatures:e?.maximumNumberOfFeatures??-1,totalNumberOfFeatures:e?.serviceDataCount??-1,nodes:0,...this.processor.performanceInfo}},t._createClass(r,[{key:"legendEnabled",get:function(){return this.canResume()&&this.processor?.legendEnabled}},{key:"graphics3DProcessor",get:function(){return"graphics-3d"===this.processor?.type?this.processor:null}},{key:"heatmapProcessor",get:function(){return"heatmap"===this.processor?.type?this.processor:null}},{key:"symbologySnappingSupported",get:function(){const e=this.layer?.renderer?.getSymbols();return e?.some(d.symbolHasExtrudeSymbolLayer)??!1}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return r.__decorate([n.property()],a.prototype,"loadedGraphics",void 0),r.__decorate([n.property()],a.prototype,"suspended",void 0),r.__decorate([n.property({readOnly:!0})],a.prototype,"legendEnabled",null),r.__decorate([n.property()],a.prototype,"updating",void 0),r.__decorate([n.property()],a.prototype,"controller",void 0),r.__decorate([n.property()],a.prototype,"processor",void 0),r.__decorate([n.property({readOnly:!0})],a.prototype,"updatePolicy",void 0),r.__decorate([n.property({readOnly:!0})],a.prototype,"suspendResumeExtentMode",void 0),r.__decorate([n.property({type:Boolean})],a.prototype,"slicePlaneEnabled",void 0),r.__decorate([n.property({readOnly:!0})],a.prototype,"suspendInfo",void 0),r.__decorate([n.property()],a.prototype,"graphics3DProcessor",null),r.__decorate([n.property()],a.prototype,"heatmapProcessor",null),r.__decorate([n.property()],a.prototype,"symbologySnappingSupported",null),a=r.__decorate([c.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],a),a};e.FeatureLikeLayerView3D=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
