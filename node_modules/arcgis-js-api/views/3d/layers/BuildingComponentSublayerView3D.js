/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Error","../../../core/Logger","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../core/sql/WhereClause","../../../layers/buildingSublayers/BuildingComponentSublayer","../../../layers/support/FeatureFilter","../../../layers/support/fieldUtils","../../../rest/support/Query","./BuildingSublayerView3D","./I3SMeshView3D","./II3SMeshView3D","./i3s/BuildingFilterUtil","./i3s/I3SGeometryUtil","./i3s/I3SMeshViewFilter","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","../../layers/BuildingComponentSublayerView","../../layers/support/popupUtils","../../support/Scheduler"],(function(e,t,r,i,s,n,l,a,u,o,d,p,y,c,h,f,g,F,_,b,E,w,S,x,I,v,m,Q,q,R){"use strict";let V=function(t){function l(){var e;return(e=t.apply(this,arguments)||this).type="building-component-sublayer-3d",e.layerView=null,e._elevationContext="scene",e._isIntegratedMesh=!1,e._supportsLabeling=!1,e.requiredFields=[],e.progressiveLoadFactor=1,e._queryEngine=null,e}e._inherits(l,t);var a=l.prototype;return a.initialize=function(){this.updatingHandles.add((()=>[this.sublayer.renderer,this.definitionExpressionFields,this.filterExpressionFields]),(()=>this._updateRequiredFields())),this.updatingHandles.add((()=>this.sublayer.renderer),(e=>this._rendererChange(e)),n.initial);const e=()=>this._filterChange();this.updatingHandles.add((()=>this.parsedDefinitionExpression),e),this.updatingHandles.add((()=>null!=this._filter?this._filter.sortedObjectIds:null),e),this.updatingHandles.add((()=>null!=this._filter?this._filter.parsedWhereClause:null),e),this.updatingHandles.add((()=>[null!=this._filter?this._filter.parsedGeometry:null,null!=this.filter?this.filter.spatialRelationship:null]),(()=>this._geometryFilterChange())),this.updatingHandles.add((()=>this.parsedFilterExpressions),(()=>this._updateSymbologyOverride()),n.initial),this.addResolvingPromise(this._updateRequiredFields())},a.isUpdating=function(){return e._get(e._getPrototypeOf(l.prototype),"isUpdating",this).call(this)||null!=this._filter&&this._filter.updating},a._updateSymbologyOverride=function(){const e=this.parsedFilterExpressions;e.length>0?this._setSymbologyOverride(((t,r)=>{for(const[s,n]of e)try{if(s.testFeature(t))return b.applyFilterMode(r,n)}catch(i){this.logError(i)}return b.applyFilterMode(r,null)}),this.filterExpressionFields):this._setSymbologyOverride(null,null)},a._createLayerGraphic=function(e){const t=new r(null,null,e);return t.layer=this.sublayer.layer,t.sourceLayer=this.sublayer,t},a.canResume=function(){return e._get(e._getPrototypeOf(l.prototype),"canResume",this).call(this)&&(!this._controller||this._controller.rootNodeVisible)},a.fetchPopupFeatures=async function(e,t){const r=this._validateFetchPopupFeatures(t);if(r)throw r;if(null==t||!t.clientGraphics||0===t.clientGraphics.length)return[];const i=[],n=[],l=null!=this.sublayer.associatedLayer?await this.sublayer.associatedLayer.load():this.sublayer,a=h.unpackFieldNames(this.sublayer.fieldsIndex,await q.getRequiredFields(l,q.getFetchPopupTemplate(this.sublayer,t))),u=new Set;for(const s of t.clientGraphics)h.populateMissingFields(a,s,u)?n.push(s):i.push(s);return 0===n.length?i:(null!=this.sublayer.associatedLayer&&await this.sublayer.associatedLayer.load().catch((()=>s.getLogger(this).warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes."))),this.whenGraphicAttributes(n,Array.from(u)).catch((()=>n)).then((e=>i.concat(e))))},a._updateRequiredFields=async function(){const e=h.fixFields(this.sublayer.fieldsIndex,[...this.sublayer.renderer?await this.sublayer.renderer.getRequiredFields(this.sublayer.fieldsIndex):[],...this.definitionExpressionFields||[],...this.filterExpressionFields||[]]);this._set("requiredFields",e)},a._validateFetchPopupFeatures=function(e){const{sublayer:t}=this,{popupEnabled:r}=t;return r?q.getFetchPopupTemplate(t,e)?void 0:new i("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:t}):new i("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:t})},a.getFilters=function(){const t=e._get(e._getPrototypeOf(l.prototype),"getFilters",this).call(this);return this.addSqlFilter(t,this.parsedDefinitionExpression,this.logError),null!=this._filter&&this._filter.addFilters(t,this.view,this._controller.crsIndex,this._collection),t},a.createQuery=function(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return null!=this.filter?this.filter.createQuery(e):new f(e)},a.queryExtent=function(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),t?.signal)},a.queryFeatureCount=function(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),t?.signal)},a.queryFeatures=function(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),t?.signal).then((e=>{if(!e?.features)return e;const t=this.sublayer,r=t.layer;for(const i of e.features)i.layer=r,i.sourceLayer=t;return e}))},a.queryObjectIds=function(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),t?.signal)},a._ensureQueryEngine=function(){return null==this._queryEngine&&(this._queryEngine=this._createQueryEngine()),this._queryEngine},a._createQueryEngine=function(){const e=E.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new S.I3SQueryEngine({layerView:this,priority:R.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new I.I3SQueryFeatureStore({featureAdapter:new x.I3SQueryFeatureAdapter({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e({id:t,index:r,meta:i})),t,_.ForAllFeaturesMode.QUERYABLE),getFeatureExtent:e,sourceSpatialReference:v.getIndexCrs(this.sublayer),viewSpatialReference:this.view.spatialReference})})},a._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(null==e?this.createQuery():f.from(e))},e._createClass(l,[{key:"i3slayer",get:function(){return this.sublayer}},{key:"layerUid",get:function(){return this.sublayer.layer.uid}},{key:"sublayerUid",get:function(){return this.sublayer.uid}},{key:"layerId",get:function(){return this.sublayer.layer.id}},{key:"sublayerId",get:function(){return this.sublayer.id}},{key:"layerPopupEnabledAndHasTemplate",get:function(){return this.sublayer.popupEnabled&&q.hasPopupTemplate(this.sublayer,this.layerView?.view.popup?.defaultPopupTemplateEnabled)}},{key:"lodFactor",get:function(){return this.view.qualitySettings.sceneService.object.lodFactor}},{key:"parsedFilterExpressions",get:function(){return"Overview"!==this.sublayer.modelName&&this.layerView?this.layerView.filterExpressions.map((([e,t])=>{let r;try{r=p.WhereClause.create(e,this.sublayer.fieldsIndex)}catch(l){return s.getLogger(this).error("Failed to parse filterExpression: "+l),null}if(!r.isStandardized)return s.getLogger(this).error("filterExpression is using non standard function"),null;const i=[],n=r.fieldNames;return v.findFieldsCaseInsensitive(n,this.sublayer.fields,{missingFields:i}),i.length>0?(s.getLogger(this).error(`filterExpression references unknown fields: ${i.join(", ")}`),null):[r,t]})).filter((e=>null!=e)):[]}},{key:"filter",get:function(){return null!=this._filter?this._filter.viewFilter:null},set:function(e){null!=e&&w.I3SMeshViewFilter.checkSupport(e)?null!=this._filter?this._filter.viewFilter=e:this._filter=new w.I3SMeshViewFilter({viewFilter:e,layerFieldsIndex:this.sublayer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):this._filter=null}},{key:"filterExpressionFields",get:function(){return h.fixFields(this.sublayer.fieldsIndex,this.parsedFilterExpressions.reduce(((e,[t])=>e.concat(t.fieldNames)),new Array))}},{key:"availableFields",get:function(){const e=this.sublayer,t=e.fieldsIndex;let r=this.requiredFields;if(e.outFields||e.layer.outFields){const i=[...e.outFields||[],...e.layer.outFields||[]];r=[...h.unpackFieldNames(t,i),...r]}return h.fixFields(t,r)}}]),l}(m.DefinitionExpressionSceneLayerView(F.I3SMeshView3D(g.BuildingSublayerView3DMixin(Q))));t.__decorate([l.property()],V.prototype,"i3slayer",null),t.__decorate([l.property()],V.prototype,"layerView",void 0),t.__decorate([l.property()],V.prototype,"lodFactor",null),t.__decorate([l.property({readOnly:!0})],V.prototype,"parsedFilterExpressions",null),t.__decorate([l.property({type:c})],V.prototype,"filter",null),t.__decorate([l.property()],V.prototype,"_filter",void 0),t.__decorate([l.property({type:[String],readOnly:!0})],V.prototype,"filterExpressionFields",null),t.__decorate([l.property({type:[String],readOnly:!0})],V.prototype,"requiredFields",void 0),t.__decorate([l.property({type:[String],readOnly:!0})],V.prototype,"availableFields",null),V=t.__decorate([d.subclass("esri.views.3d.layers.BuildingComponentSublayerView3D")],V);return V}));
