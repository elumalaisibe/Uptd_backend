/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../ViewingMode","./I3SUtil","./Intersector","../../support/orientedBoundingBox","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,n,i,r,s,l,o,c){"use strict";let a=function(){function e(e){this.type=o.IntersectorType.I3S,this._needVerticalOffset=!1,this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}var a=e.prototype;return a.updateElevationAlignState=function(e,t){this._needVerticalOffset=e&&t===n.ViewingMode.Global},a.intersect=function(e,t,n,a){const u=e.results,b=e.options.store===o.StoreResults.ALL,f=e.ray.direction,h=e.tolerance;let y=e=>e,g=e=>e;const p=c.getVerticalOffsetI3S(null!=e.verticalOffset?e.verticalOffset:this._needVerticalOffset?0:null);null!=e.verticalOffset&&null!=p&&(y=e=>p.applyToMbs(e),g=e=>p.applyToObb(e)),this._traverseNodeHierarchy(((o,c)=>{if(0===o.childrenLoaded)return!1;const O=null!=o.serviceObbInRenderSR&&i.isValidObb(o.serviceObbInRenderSR)?o.serviceObbInRenderSR:null;return!(null!=O&&!s.intersectLine(g(O),n,f,h))&&(!c||null==O&&i.isValidMbs(o.renderMbs)&&!d(y(o.renderMbs),n,f,h)||null!=o.geometryObb&&!s.intersectLine(g(o.geometryObb),n,f,h)||this._collection.intersect(c,n,a,h,p,((i,s,c,d)=>{if(s>=0){if(null!=t&&!t(n,a,s))return;const f=e=>{const t=new r.I3sTarget(this.layerUid,this.sublayerUid,o.index,i,d);e.set(this.type,t,s,c)};if(this.isGround&&(null==u.ground.dist||s<u.ground.dist)&&f(u.ground),e.options.isFiltered)return;if((null==u.min.dist||s<u.min.dist)&&f(u.min),(null==u.max.dist||s>u.max.dist)&&f(u.max),b){const t=l.newIntersectorResult(e.ray);f(t),e.results.all.push(t)}}})),!0)}))},t._createClass(e)}();function d(e,t,n,i=0){const r=e[3]+i,s=t[0]-e[0],l=t[1]-e[1],o=t[2]-e[2],c=n[0],a=n[1],d=n[2],u=c*s+a*l+d*o;return u*u-(c*c+a*a+d*d)*(s*s+l*l+o*o-r*r)>=0}e.I3SIntersectionHandler=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
