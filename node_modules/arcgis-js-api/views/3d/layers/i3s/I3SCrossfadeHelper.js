/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/scheduling","../support/I3SLayerView"],(function(e,s,t,i,o){"use strict";let d=s._createClass((function(){this.lodCrossfadeSignedDuration=0})),n=function(){function e(e){this._view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}var d=e.prototype;return d.destroy=function(){this._preRenderFrameTaskHandle?.remove(),this._preRenderFrameTaskHandle=null,this._view=null},d.stopNodeFading=function(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=t.removeMaybe(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))},d._startNodeFading=function(e,s,t){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=i.addFrameTask({preRender:e=>this._updateAllNodeFading(e)}),this._view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),e.lodCrossfadeSignedDuration=t,e.lodCrossfadeProgress=s},d._updateAllNodeFading=function(e){const s=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode(((t,i)=>{if(null!=i&&null!=i.lodCrossfadeProgress){const o=i.lodCrossfadeSignedDuration,d=o>0?this._view.fullOpacity:0,n=e.deltaTime/o,a=i.lodCrossfadeProgress+Math.abs(n),r=!s||a>=1||0===o,l=d-(r?0:o>0?1:-1)*(1-a);r?(this.stopNodeFading(i),o<0&&this._view.markNodeToRemove(t)):i.lodCrossfadeProgress=a,this._view.setNodeOpacityByIndex(t,l)}})),this._view.removeMarkedNodes()},d.stopAllNodeFading=function(){this._view.foreachCrossfadeNode(((e,s)=>{if(null!=s&&null!=s.lodCrossfadeProgress){this.stopNodeFading(s);const t=s.lodCrossfadeSignedDuration;t<0&&this._view.markNodeToRemove(e);const i=t>0?this._view.fullOpacity:0;this._view.setNodeOpacityByIndex(e,i)}})),this._view.removeMarkedNodes()},d.fadeNode=function(e,s,t,i){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const d=this._view,n=d.nodeCrossfadingEnabled,r=t===o.FadeDirection.FadeIn?d.fullOpacity:0,l=n?i?t===o.FadeDirection.FadeIn?d.lodCrossfadeinDuration:d.lodCrossfadeoutDuration:d.lodCrossfadeUncoveredDuration:0,u=this._view.getNodeOpacityByIndex(e);if(n&&u!==r&&l>0){const e=1-Math.abs(r-u);this._startNodeFading(s,e,a(t)*l)}else this.stopNodeFading(s),this._view.setNodeOpacityByIndex(e,r),t===o.FadeDirection.FadeOut&&this._view.removeNode(e)},d.isNodeFullyFadedIn=function(e){const s=this._view.getNodeCrossfadeMetaData(e);return null==s||null==s.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(e)===this._view.fullOpacity},s._createClass(e,[{key:"updating",get:function(){return this._numFadingNodes>0}}]),e}();function a(e){return e===o.FadeDirection.FadeIn?1:-1}e.I3SCrossfadeHelper=n,e.NodeCrossfadeMetaData=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
