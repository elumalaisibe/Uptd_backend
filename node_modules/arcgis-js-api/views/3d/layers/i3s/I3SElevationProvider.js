/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces"],(function(e,t,r,n,i,o,s,c,a,l,p,h,u,d,f,_,v,m,y){"use strict";const g=_.empty(),E=h.create(),x=v.fromValues(0,0,0,0),w=d.create(),R=d.create(),S=d.create();let b=function(t){function r(e){var r;return(r=t.call(this,e)||this)._tmpEvent={spatialReference:null,extent:g,context:"scene"},r}e._inherits(r,t);var n=r.prototype;return n.initialize=function(){this.view=this.layerView.view,this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersector=m.newIntersector(this.view.state.viewingMode),this._intersector.options.store=y.StoreResults.MIN;const e=this.layerView.i3slayer.fullExtent;null==e?i.getLogger(this).error("I3SElevationProvider expected fullExtent on I3SLayer."):(this._zmin=e.zmin,this._zmax=e.zmax),this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"},n.getElevation=function(e,t,r,n){if(w[0]=e,w[1]=t,w[2]=r,!this._renderCoordsHelper.toRenderCoords(w,n,w))return i.getLogger(this).error("could not project point to compute elevation"),null;const o=this.layerView.elevationOffset,s=this._zmin+o,c=this._zmax+o;return this._renderCoordsHelper.setAltitude(R,c,w),this._renderCoordsHelper.setAltitude(S,s,w),this._intersector.reset(R,S,null),this.intersectionHandler.intersect(this._intersector,null,R,S),this._intersector.results.min.getIntersectionPoint(w)?this._renderCoordsHelper.getAltitude(w):null},n.getSphereElevationBounds=function(e,t){return f.projectBoundingSphere(e,t,x,this._renderCoordsHelper.spatialReference),this.layerView.getElevationRange(x)},n.layerChanged=function(){this.spatialReference&&(this._tmpEvent.extent=this._computeLayerExtent(),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))},n.objectChanged=function(e){this.spatialReference&&(this._tmpEvent.extent=this._computeObjectExtent(e),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))},n._computeObjectExtent=function(e){return _.empty(g),this._expandExtent(e,g),g},n._computeLayerExtent=function(){_.empty(g);for(const e of this.layerView.getVisibleNodes())this._expandExtent(e,g);return g},n._expandExtent=function(e,t){const r=this.spatialReference;if(null==r)return;const n=this.layerView.getNodeComponentObb(e);if(null!=n){p.fromQuat(E,n.quaternion),E[12]=n.center[0],E[13]=n.center[1],E[14]=n.center[2];for(let e=0;e<8;++e)w[0]=1&e?n.halfSize[0]:-n.halfSize[0],w[1]=2&e?n.halfSize[1]:-n.halfSize[1],w[2]=4&e?n.halfSize[2]:-n.halfSize[2],u.transformMat4(w,w,E),this._renderCoordsHelper.fromRenderCoords(w,w,r),_.expand(t,w,t)}},e._createClass(r,[{key:"spatialReference",get:function(){return this.view?.elevationProvider?.spatialReference}}]),r}(n.EventedMixin(r));t.__decorate([o.property({constructOnly:!0})],b.prototype,"layerView",void 0),t.__decorate([o.property({constructOnly:!0})],b.prototype,"intersectionHandler",void 0),t.__decorate([o.property()],b.prototype,"view",void 0),t.__decorate([o.property()],b.prototype,"spatialReference",null),b=t.__decorate([l.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],b);return b}));
