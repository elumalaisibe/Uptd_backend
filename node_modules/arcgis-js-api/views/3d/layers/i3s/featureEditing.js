/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../core/lang","../support/attributeUtils"],(function(t,e,n){"use strict";const o={setAttribute(){},setGeometry(t){},rollback(){},commit(){}};var r;function s(t,n){const s=n.attributes[t.objectIdField],u=t.sessions.get(s);if(u)return u;const i=e.clone(n.attributes),l=new Set;if(null==s)return o;const a=t.i3sOverrides.createInteractiveEditSession(s),c=new Map,d=(t,e)=>{const n=c.get(t);if(null==n){const n=e.indexOf(s);return c.set(t,n),n}return n};let f=r.EDITING;const b={setAttribute(e,o){if(f!==r.EDITING)return;const s=t.fieldsIndex.get(e);if(!s)return;const u=t.attributeStorageInfo.findIndex((t=>t.name===s.name));if(u<0)return;a.setAttribute(u,o);const i=t.attributeStorageInfo[u];let c=!1;l.add(e),t.forEachNode(((e,r)=>{const s=d(e,r);if(-1===s)return;const u=t.getAttributeData(e.index);if(u){const r=u[i.name];r&&(r[s]=o,t.setAttributeData(e.index,u,n),c=!0)}})),c&&t.clearMemCache()},setGeometry(t){f===r.EDITING&&a.setGeometry(t)},rollback(){if(f===r.EDITING){for(const t of l)this.setAttribute(t,i[t]);a.rollback(),f=r.ROLLED_BACK,t.sessions.delete(s)}},commit(){f===r.EDITING&&(a.commit(),f=r.COMMITTED,t.sessions.delete(s))}};return t.sessions.set(s,b),b}function u(t,e){const o=t.fieldsIndex,r=t.objectIdField,s=t.globalIdField;if(null==s)return;const u=new Map,i=b(e.addedFeatures),l=e.edits.addFeatures,a=I(e.updatedFeatures),c=e.edits.updateFeatures,d=f(o,r,s,e.edits?.deleteFeatures),g=I(e.deletedFeatures,d),m=e.edits.deleteFeatures;if(null!=l&&l.length>0)for(const f of l){const t=n.attributeLookup(o,f.attributes,s),e=i.get(t);null!=f.geometry&&"mesh"===f.geometry.type&&null!=e&&u.set(e,f.geometry)}if(null!=c&&c.length>0)for(const f of c){const t=n.attributeLookup(o,f.attributes,r);null!=f.geometry&&"mesh"===f.geometry.type&&a.has(t)&&u.set(t,f.geometry)}if(null!=m&&m.length>0)for(const f of m){let t=null;t="attributes"in f?n.attributeLookup(o,f.attributes,r):f.objectId,null!=t&&g.has(t)&&u.set(t,null)}for(const[n,f]of u)t.i3sOverrides.updateGeometry(n,f)}function i(t,e){const n=a(t,e),o=l(t,e);if(0===n.size&&0===o.size)return;const r=new Map;for(let l=0;l<t.attributeStorageInfo.length;l++)r.set(t.attributeStorageInfo[l].name,l);let s=!1;n.forEach(((e,n)=>{const o=t.getAttributeData(n);let u=!1;e.forEach(((e,n)=>{const i=null!=o?o[n]:null,l=r.get(n);for(const{featureIndex:o,value:r,featureId:a}of e)i&&(i[o]=r,u=!0,s=!0),t.i3sOverrides.updateAttributeValue(a,l,r)})),u&&t.setAttributeData(n,o,null)})),s&&t.clearMemCache();const{fieldsIndex:u,i3sOverrides:i,objectIdField:c,globalIdField:d}=t,f=i.layer.associatedLayer?.infoFor3D,b=new Set(f?[...Object.values(f.assetMapFieldRoles),...Object.values(f.transformFieldRoles)]:[]);for(const[l,a]of o){i.featureAdded(l);const{attributes:t}=a;for(const e in t){if(e!==c&&e!==d&&b.has(e))continue;const n=u.normalizeFieldName(e),o=null!=n?r.get(n):null;if(null==o)continue;const s=t[e];i.updateAttributeValue(l,o,s)}}}function l(t,{edits:e,addedFeatures:o}){const r=new Map,s=e.addAssetFeatures,{fieldsIndex:u,globalIdField:i}=t;if(!s||0===s.length||null==i)return r;const l=b(o);for(const a of s){const t=n.attributeLookup(u,a.attributes,i),e=l.get(t);null!=a.geometry&&"mesh"===a.geometry.type&&null!=e&&r.set(e,a)}return r}function a(t,e){const o=e.edits.updateFeatures;if(!o||0===o.length)return new m;const r=I(e.updatedFeatures),s=new m,u=new Map;for(let n=0;n<t.attributeStorageInfo.length;n++)u.set(t.attributeStorageInfo[n].name,n);const i=t.fieldsIndex,l=t.objectIdField,a=o.filter((t=>{const e=n.attributeLookup(i,t.attributes,l);return r.has(e)}));return t.forEachNode(((e,o)=>{const r=new Set(o);for(const u of a){const a=n.attributeLookup(i,u.attributes,l);if(!r.has(a))continue;const d=o.indexOf(a);for(const n in u.attributes){const o=t.fieldsIndex.normalizeFieldName(n),r=c(s,e.index,o),i=u.attributes[n];r.push({featureIndex:d,featureId:a,value:i})}}})),s}function c(t,e,n){const o=d(t,e),r=null!=n&&o.get(n);if(r)return r;const s=new Array;return o.set(n,s),s}function d(t,e){const n=t.get(e);if(n)return n;const o=new g;return t.set(e,o),o}function f(t,e,o,r){const s=new Map;if(!r)return s;for(const u of r){let r=null,i=null;"attributes"in u?(r=n.attributeLookup(t,u.attributes,e),i=n.attributeLookup(t,u.attributes,o)):(r=u.objectId,i=u.globalId),null!=i&&null!=r&&s.set(i,r)}return s}function b(t){const e=new Map;if(!t)return e;for(const n of t)null!=n.globalId&&null!=n.objectId&&null==n.error&&e.set(n.globalId,n.objectId);return e}function I(t,e=null){const n=new Set;if(!t)return n;for(const o of t)if(null==o.error)if(null!=o.objectId&&-1!==o.objectId)n.add(o.objectId);else if(null!=o.globalId&&null!=e){const t=e.get(o.globalId);null!=t&&n.add(t)}return n}!function(t){t[t.EDITING=0]="EDITING",t[t.ROLLED_BACK=1]="ROLLED_BACK",t[t.COMMITTED=2]="COMMITTED"}(r||(r={}));const g=Map,m=Map;t.createInteractiveEditSession=s,t.processAttributeEdits=i,t.processGeometryEdits=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
