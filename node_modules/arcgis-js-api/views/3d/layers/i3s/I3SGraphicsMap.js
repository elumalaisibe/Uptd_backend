/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Evented","../../../../core/MapUtils"],(function(e,t,n,o){"use strict";let s=function(e){function n(t,n){var o;return(o=e.call(this)||this)._updateAndCompare=t,o._notifyUpdated=n,o._nodes=new Map,o._graphics=new Map,o._duplicates=new Map,o}t._inherits(n,e);var s=n.prototype;return s.clear=function(){if(this._graphics.size>0){const e=this.toArray();this._graphics.clear(),this.emit("change",{added:[],removed:e})}this._nodes.clear()},s.get=function(e){return this._graphics.get(e)},s.getNode=function(e){return this._nodes.get(e)},s.hasNode=function(e){return this._nodes.has(e)},s.nodes=function(){return this._nodes.values()},s.addNode=function(e,t){this._nodes.set(e,t);const n=t.graphics;if(0===n.length)return;const o=new Set;for(let i=0;i<n.length;i++){const t=n[i],s=t.objectId,r=this._graphics.get(s);if(r){o.add(s),t!==r&&(n[i]=r);const c=this._duplicates.get(s);c?c.push(e):this._duplicates.set(s,[r.nodeIndex,e])}else t.nodeIndex=e,this._graphics.set(s,t)}o.size&&this._updateForeignGraphics(t);const s=o.size>0?n.filter((e=>!o.has(e.objectId))):n;s.length>0&&this.emit("change",{added:s,removed:[]})},s.removeNode=function(e){const t=this._nodes.get(e);if(!t)return void console.error("Removing unknown node");this._nodes.delete(e);const n=new Set,o=[];for(const s of t.graphics){const t=s.objectId,i=this._graphics.get(t);if(!i)continue;const r=this._duplicates.get(t);if(r){const o=r.indexOf(e);if(-1===o){console.error("error: removing graphic from node that should not reference it.");continue}if(r.splice(o,1),i.nodeIndex===e){let e=this.getNode(r[0]);for(let t=1;t<r.length;t++){const n=this.getNode(r[t]);(null==e||null!=n&&n.node.level>e.node.level)&&(e=n)}null!=e&&n.add(e)}1===r.length&&this._duplicates.delete(t)}else this._graphics.delete(t),o.push(s)}o.length>0&&this.emit("change",{added:[],removed:o}),n.forEach((e=>this._updateForeignGraphics(e)))},s._updateForeignGraphics=function(e){const t=[],n=e.node.index,o=e.node.level;let s=0;for(;s<e.graphics.length;){const i=e.graphics[s].nodeIndex;if(i===n){s++;continue}let r=1;for(;s+r<e.graphics.length&&e.graphics[s+r].nodeIndex===i;)r++;const c=this.getNode(i);if(null!=c&&c.node.level>o)s+=r;else{for(let o=s;o<s+r;o++){const s=e.graphics[o];s.nodeIndex=n,this._updateAndCompare(s,e,o)&&t.push(s)}s+=r}}this._notifyUpdated(t)},s.toArray=function(){return Array.from(this._graphics.values())},s.find=function(e){let t;return o.someMap(this._graphics,(n=>!!e(n)&&(t=n,!0))),t},s.forEach=function(e){this._graphics.forEach((t=>e(t)))},s.forEachNode=function(e){this._nodes.forEach(((t,n)=>e(t,n)))},s._checkInvariants=function(){const e=new Map;this._nodes.forEach(((t,n)=>{n!==t.node.index&&console.error("Mismatched node index"),t.graphics.forEach((t=>{e.set(t.objectId,1+(e.get(t.objectId)??0));const o=this._duplicates.get(t.objectId);o&&!o.includes(n)&&console.error("Node not listed in duplicate list"),o||t.nodeIndex===n||console.error("Unique graphic does not reference owning node index")}))})),this._graphics.size!==e.size&&console.error("Mismatch between actual and expected number of graphics");let t=0;e.forEach(((e,n)=>{t+=e>1?1:0;const o=this._graphics.get(n);if(!o)return void console.error("Missing graphic entry");const s=this._nodes.get(o.nodeIndex);if(!s)return void console.error("Graphic references unkown node");const i=this._duplicates.get(n);i?(i.length!==e&&console.error("Wrong number of entries in duplicate list"),i.forEach((e=>{const t=this._nodes.get(e);t?t.node.level>s.node.level&&console.error("Duplicated graphic does not reference highest level node"):console.error("Unknown node in duplicate list")}))):e>1&&console.error("Missing duplicates entry")})),this._duplicates.size!==t&&console.error("Mismatch between expected and actual number of duplicate entries")},t._createClass(n,[{key:"length",get:function(){return this._graphics.size}},{key:"nodeCount",get:function(){return this._nodes.size}}]),n}(n);e.I3SGraphicsMap=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
