/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/PooledArray","./I3SNode","../support/I3SLayerView"],(function(e,i,n,o){"use strict";let t=function(){function i(e){this._layerView=e,this._lodGlobalDirty=!1}var t=i.prototype;return t.startNodeLoading=function(e,i,n,o){this._maxLodLevel=o.maxLodLevel,this._index=n,this._isNodeInScaleBounds=e,this._removeNodes=i},t.shouldLoadNode=function(e){if(null==e)return!1;const i=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(i)||!!i.isChosen&&this._childrenRequireLoading(e)},t.setLodGlobalDirty=function(){this._lodGlobalDirty=!0},t.lodGlobalHandling=function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this._layerView.view.resourceController.memoryController.usedMemory,n=Math.max(0,Math.floor(10*(i-1)));d.clear(),this._lodGlobalHandling(this._index.rootNode,n,!1,!!this._layerView.nodeCrossfadingEnabled);const o=d.length;this._removeNodes(d,e);const t=d.length<o;return 0!==d.length&&(this._lodGlobalDirty=!0),d.clear(),t},t._lodGlobalHandling=function(e,i,t,s){if(null==e)return!1;const l=e.index,r=this._index,a=this._layerView,h=r.nodeTraversalState(e),u=this._isChosenMaxLOD(h),c=e.resources.isEmpty;if(u&&c)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const _=a.isNodeLoaded(l);if(s&&_&&u){const i=!t&&this.hasNoVisibleChildren(e);a.fadeNode(l,o.FadeDirection.FadeIn,!i)}const x=_&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(l));if(_&&(a.updateNodeState(l,u?n.NodeState.Leaf:n.NodeState.Hole),u))return x&&this._removeChildrenRecursive(e),x;const f=e.childCount>0;let L=f;if(f)for(let n=0;n<e.childCount;n++){const e=r.getChildIndex(l,n),o=r.getNode(e);if(null!=o){!(!r.isGeometryVisible(e)||this._lodGlobalHandling(o,i,t||x,s))&&this._isNodeInScaleBounds(o)&&(L=!1)}else r.isNodeVisible(e)&&(L=!1)}const y=_&&!u&&(L||d.length<i);y&&d.push(l),!s||y||!_||t||L||a.fadeNode(l,o.FadeDirection.FadeIn,!1);const N=e.resources.isEmpty;return L||x&&!y||N},t._removeChildrenRecursive=function(e){this._index.traverseChildren(e,(e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&d.push(e.index),e.childrenLoaded>0)))},t.hasNoVisibleChildren=function(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0))),i},t._childrenRequireLoading=function(e){let i=!1,n=!0;return this._index.traverseChildren(e,(e=>{if(!n||!this._index.isNodeVisible(e.index))return!1;const o=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(o)&&this._index.isGeometryVisible(e.index)&&(i=!0),this._layerView.isNodeLoaded(e.index)?(n=!1,!1):e.childrenLoaded>0})),n&&i},t._isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e._createClass(i,[{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}}]),i}();const d=new i({deallocator:null});return t}));
