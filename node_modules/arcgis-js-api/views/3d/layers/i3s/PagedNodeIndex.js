/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../geometry/support/aaBoundingBox","./I3SUtil","../../support/orientedBoundingBox"],(function(e,t,n,s){"use strict";function i(e,n,i){const o=e.index;if(!o.hasNodes(0,1))return;const r=e.queue;r.length=0,r.push(0);const a=e.masks;for(a.length=0,a.push(0);r.length>0;){const h=r.pop();let p=a.pop();const c=o.getNode(h),g=o.getRenderObb(h);let l=!0;if(null!=n.clippingBox){const i=1<<n.frustum.length;if(0==(p&i)){const o=s.toAaBoundingBox(g,e.tempAabb);t.contains(n.clippingBox,o)?p|=i:t.intersects(n.clippingBox,o)||(l=!1)}}for(let e=0;e<n.frustum.length&&l;e++){const t=1<<e;if(0==(p&t)){const i=s.intersectPlane(g,n.frustum[e]);i>0?l=!1:i<0&&(p|=t)}}if(i.predicate(h,c,l)){const e=c.firstChild,t=c.childCount;let n=!1;const s=u(e,o.pageSize),g=u(e+t-1,o.pageSize);for(let r=s;r<=g;r++)if(!o.hasPage(r)){i.pageMiss(h,r),n=!0;break}if(!n)for(let i=0;i<t;i++)r.push(e+i),a.push(p)}}}function o(e,t,i,o){const r=new s.ObbArray(e.length);for(let s=0;s<e.length;s++)n.transformObb(e[s].obb,t,r.obbs[s],i,o);return r.obbs}function r(e,t){const n=[0];for(;n.length;){const s=n.pop(),i=e[u(s,t)].nodes[a(s,t)];for(let o=0;o<i.childCount;o++){const r=i.firstChild+o;null!=e[u(r,t)]&&(e[u(r,t)].parents[a(r,t)]=s,n.push(r))}}}function u(e,t){return e/t|0}function a(e,t){return e%t}return function(){function n(e,t,n){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=n}var h=n.prototype;return h.addPage=function(e,t,n=0){for(;this._pages.length<e;)this._pages.push(null);const s=o(t,this._nodeSR,this._renderSR,n);this._pages[e]={nodes:t,renderObbs:s,parents:new Uint32Array(this.pageSize)},r(this._pages,this.pageSize)},h.hasPage=function(e){return!!this._pages[e]},h.getNode=function(e){const t=this.pageSize;return this._pages[u(e,t)].nodes[a(e,t)]},h.getRenderObb=function(e){const t=this.pageSize;return this._pages[u(e,t)].renderObbs[a(e,t)]},h.getRenderCenter=function(e){return this.getRenderObb(e).center},h.setRenderObb=function(e,t){const n=this.pageSize;s.set(t,this._pages[u(e,n)].renderObbs[a(e,n)])},h.getParentId=function(e){const t=this.pageSize;return this._pages[u(e,t)].parents[a(e,t)]},h.hasNodes=function(e,t){const n=u(e,this.pageSize),s=u(e+t-1,this.pageSize);for(let i=n;i<=s;i++)if(null==this._pages[i])return!1;return!0},h.forEachNodeId=function(e){for(let t=0;t<this._pages.length;t++){const n=this._pages[t];if(n)for(let s=0;s<n.nodes.length;s++)e(t*this.pageSize+s)}},h.createVisibilityTraverse=function(){const e={index:this,queue:[],masks:[],tempAabb:t.create()};return(t,n)=>i(e,t,n)},e._createClass(n)}()}));
