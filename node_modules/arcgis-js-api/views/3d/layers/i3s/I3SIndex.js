/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../chunks/vec3","../../../../geometry/projection","../../../../chunks/sphere","../../../../support/featureFlags","./I3SNode","./I3SUtil","../../support/orientedBoundingBox"],(function(e,t,i,n,s,o,r,l,a,d,h){"use strict";let u=t._createClass((function(e,t,i,n,s){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=n,this.node=s,this.useAsHole=0,this.filterImpact=a.NodeFilterImpact.NotChecked})),c=function(){function e(e,t,n,s,o,r,d,h,u,c,_,g,m,b,p){this._layer=e,this._streamDataController=n,this._clientNodeLoader=s,this._viewportQueries=o,this._logger=r,this.holeFilling=d,this._isLoaded=h,this._isReloading=u,this._isSelected=c,this._enable=_,this._needsUpdate=g,this._canRequest=m,this._computeVisibilityObb=b,this._computeNodeFiltering=p,this._dirty=!0,this._nodePages=new Array,this._clientNodePage=null,this._nodeCount=0,this._nodesPerPage=0,this._rootIndex=0,this._lodMetric=a.LodMetric.None,this._lodConversion=e=>e,this._isEditable=!1,this._urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=v(0),this._visibilityCacheVersion=v(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new i({deallocator:null}),this._prefetch=new i({deallocator:null}),this._updates=new f(this._missing),this._imModificationUncategorized=new i({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._isEditable=l.i3sPatchingEnabled()&&null!=e.associatedLayer&&null!=e.associatedLayer.infoFor3D,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this._lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(t)}var c=e.prototype;return c._init=function(e){if("page"===e.type){const t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._nodesPerPage=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=a.LodMetric.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=a.LodMetric.MaxScreenThreshold,this._lodConversion=S}if(this._isEditable){this._rootIndex=-1;const i=x(e.rootIndex,e.pageSize),n=t.nodes[i],s={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:n.obb,lodThreshold:n.lodThreshold}]};this._addPage(N(this._rootIndex,this._nodesPerPage),s),this.getNode(-1).serviceObb=void 0}else this._rootIndex=e.rootIndex;this._addPage(N(e.rootIndex,this._nodesPerPage),t),this._updateParentsAndLevel()}else if("node"===e.type){if(this._urlPrefix=e.urlPrefix,this._nodePages.push(P()),this._isEditable){this._clientNodePage=P();const t={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new a.NodeBase(t.id,null),-1);const i=this._validateNode(t.id,t);i&&this._addNode(i,this._rootIndex)}else this._rootIndex=this._makeRefNode(new a.NodeBase(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}},c.addClientNodeToIndex=function(e,t){const i=-1,n=new a.NodeBase(e,t),s=this._makeClientRefNode(n,i);return this._linkChildToParentNode(i,s),this.requestUpdate(),s},c.removeClientNodeFromIndex=function(e,t,i){this._destroyClientRefNode(e,t,i),this.requestUpdate()},c._loadPage=function(e){this._loading.add(e);const t=this._urlPrefix+e;this._streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t})})).catch((t=>{this._loading.delete(e),n.isAbortError(t)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._layer,`Error when loading page ${e}`,t))}))},c._addQueuedPages=function(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loading.delete(t),e.madeProgress()}this._updateParentsAndLevel()},c._addPage=function(e,t){const i=[],n=[],o=t.nodes.map(((t,o)=>{const l=i.length,d=t.children?t.children.length:0;n.push(this._rootIndex);for(let e=0;e<d;e++)i.push(t.children[e]);const c=`${t.index}`,_=h.clone(t.obb),f=r.fromValues(_.center[0],_.center[1],_.center[2],s.length(_.halfSize)),g=t.mesh&&t.mesh.attribute,v=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,p={hasSharedResource:!1,isEmpty:null==v,attributes:g&&null!=g.resource?`${g.resource}`:void 0,geometry:v&&null!=v.resource?`${v.resource}`:void 0,texture:b&&null!=b.resource?`${b.resource}`:void 0,geometryDefinition:v?v.definition:-1,materialDefinition:b?b.definition:-1},y=new a.Node(c,I(o,e,this._nodesPerPage),f,d,0,p,this._lastUpdate,this._lodMetric,this._lodConversion(t.lodThreshold),v?v.featureCount:null);return y.serviceObb=_,y.visibilityObb=this._computeVisibilityObb(y),y.vertexCount=v?v.vertexCount:0,new u(l,d,m(this._visibilityCacheVersion),null,y)}));if(-1===e)this._clientNodePage=P(o,i,n);else{for(let t=this._nodePages.length;t<e;t++)this._nodePages[t]=null;this._nodePages[e]=P(o,i,n)}this._nodeCount+=o.length},c._updateParentsAndLevel=function(){const e=new Array,t=(t,i,n)=>{const s=this._getPage(t);if(null!=s){const o=x(t,this._nodesPerPage);s.parents[o]=null!=i?i:-1;const r=s.nodes[o].node;null!=r&&(r.level=n,e.push(t))}};for(t(this._rootIndex,null,0);e.length;){const i=e.pop(),n=this.getNode(i);if(null!=n)for(let e=0;e<n.childCount;e++){t(this.getChildIndex(n.index,e),i,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},c._getPage=function(e){const t=N(e,this._nodesPerPage);return t<0?this._clientNodePage:this._nodePages[t]},c._getNodeInternal=function(e){const t=this._getPage(e);return null==t?null:t.nodes[x(e,this._nodesPerPage)]},c._addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);const i=this.getParent(t),n=null!=i?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?n+1:n);const{lodMetric:s,maxError:o}=M(e.lodSelection),r=this._getNodeInternal(t);return r.node=new a.Node(e.id,t,e.mbs,r.childCount,n,e.resources,e.version,s,o,e.numFeatures),e.obb&&(r.node.serviceObb=h.clone(e.obb)),r.node.visibilityObb=this._computeVisibilityObb(r.node),null!=r.ref&&(null==r.ref.mbs&&(r.ref.mbs=e.mbs),r.node.renderMbs=r.ref.renderMbs,r.node.serviceObbInRenderSR=r.ref.serviceObbInRenderSR,r.ref.visibilityObb=r.node.visibilityObb),r.node},c._makeRefNode=function(e,t){const i=this._nodePages[0];if(t<-1)return this._makeClientRefNode(e,t);if(null==i)return-1;const n=i.nodes.length;return i.nodes.push(new u(0,0,m(this._visibilityCacheVersion),e,null)),this._nodeCount++,i.parents.push(t),d.invalidateMbs(e.renderMbs),d.invalidateObb(e.serviceObbInRenderSR),n},c._makeClientRefNode=function(e,t){const i=this._clientNodePage;if(null==i)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const n=-(i.nodes.length+1);return i.nodes.push(new u(0,0,m(this._visibilityCacheVersion),e,null)),this._nodeCount++,i.parents.push(t),d.invalidateMbs(e.renderMbs),d.invalidateObb(e.serviceObbInRenderSR),n},c._linkChildToParentNode=function(e,t){const i=this._clientNodePage;if(null==i||e>=0)return;const n=x(e,this._nodesPerPage),s=x(t,this._nodesPerPage),o=i.nodes[n],r=o.childOffset;i.children.splice(o.childOffset+o.childCount,0,t);const l=1;o.childCount+=l,null!=o.node&&(o.node.childCount+=l);for(const a of i.nodes)a.childOffset>r&&(a.childOffset+=l);i.parents[s]=e,this._updateParentBoundingInformation(e)},c._destroyClientRefNode=function(e,t,i){const n=this._clientNodePage;if(null==n)return;const s=this.getParentIndex(e);if(null==s)return;const o=new Set,r=new Map,l=e=>{const i=x(e,this._nodesPerPage),s=n.nodes[i];if(s.childCount>0)for(let t=s.childOffset;t<s.childOffset+s.childCount;++t)l(n.children[t]);t(s.node?.id,e),o.add(s),this._nodeTraversalState.delete(e)};l(e);const a=n.nodes,d=n.children,h=n.nodes.map((()=>-1)),u=[],c=[];for(let f=0;f<a.length;++f){const e=a[f];if(o.has(e))continue;const t=u.length,n=I(f,-1,this._nodesPerPage),s=I(t,-1,this._nodesPerPage);e.node&&(e.node.index=s),h[f]=s,u.push(e),n!==s&&(i(e.node?.id,n,s),r.set(n,s))}this._nodeCount-=a.length-u.length;const _=u.map((()=>-1));for(let f=0;f<u.length;++f){const e=I(f,-1,this._nodesPerPage),t=u[f],i=c.length;for(let n=t.childOffset;n<t.childOffset+t.childCount;++n){const t=d[n];if(t>=0)c.push(t);else{const i=x(t,this._nodesPerPage),n=a[i];if(o.has(n))continue;const s=h[i];c.push(s);_[x(s,this._nodesPerPage)]=e}}t.childOffset=i,t.childCount=c.length-i,t.node&&(t.node.childCount=t.childCount)}n.nodes=u,n.children=c,n.parents=_,this._updateParentBoundingInformation(h[x(s,this._nodesPerPage)])},c._updateParentBoundingInformation=function(e){let t=e;do{let e=null;const i=this._clientNodeLoader.indexSR,n=this._clientNodeLoader.renderSR,s=this._getNodeInternal(t);if(null==s)return;for(let a=0;a<s.childCount;a++){const s=this.getChildIndex(t,a),l=this._getNodeInternal(s),d=null!=l?l.ref||l.node:null;if(null!=d&&d.mbs[3]>0)if(null==e)e=r.copy(d.mbs,O);else{const t=E,s=R,l=k;o.projectBoundingSphere(d.mbs,i,t,n),o.projectBoundingSphere(e,i,s,n),r.union(t,s,l),o.projectBoundingSphere(l,n,e,i)}}const l=s.ref||s.node;null!=l&&(null!=e?l.mbs=r.copy(e,null!=l.mbs?l.mbs:r.create()):d.invalidateMbs(l.mbs),d.invalidateMbs(l.renderMbs),d.invalidateObb(l.serviceObbInRenderSR),l.geometryObb=null),this.invalidateNodeVisibilityCacheInternal(s),t=this.getParentIndex(t)}while(null!=t)},c.populateChildren=function(e,t){const i=this._getNodeInternal(e),n=this._getPage(e);i.childOffset=n.children.length,i.childCount=t.length;for(let s=0;s<t.length;s++){const i=this._makeRefNode(t[s],e);n.children.push(i)}},c.getNode=function(e){const t=this._getNodeInternal(e);return null!=t?t.node:null},c.getIndexById=function(e){let t;return this._forAllNodes(((i,n)=>{(null!=i.node&&i.node.id===e||null!=i.ref&&i.ref.id===e)&&(t=n)})),t},c.getNodeById=function(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null},c.getChildIndex=function(e,t){const i=this._getPage(e);if(null==i)return-1;const n=i.nodes[x(e,this._nodesPerPage)];return i.children[n.childOffset+t]},c.getParentIndex=function(e){const t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.parents[x(e,this._nodesPerPage)]:null},c.getParent=function(e){const t=this.getParentIndex(e);return null!=t?this.getNode(t):null},c.isLeaf=function(e){const t=this._getNodeInternal(e);return null!=t&&0===t.childCount},c.removeAllGeometryObbs=function(){this._forAllNodes((e=>{null!=e.node&&(e.node.geometryObb=null)}))},c.invalidateVisibilityCache=function(){this._visibilityCacheVersion=v(this._visibilityCacheVersion)},c.invalidateNodeVisibilityCache=function(e){const t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)},c.invalidateNodeVisibilityCacheInternal=function(e){e.visibilityCache=m(this._visibilityCacheVersion)},c.invalidateBoundingVolumeCache=function(e){const t=this._getNodeInternal(e);null!=t&&(g(t),this.invalidateNodeVisibilityCacheInternal(t))},c.updateElevationChanged=function(e){const t=this._getNodeInternal(e);if(null==t)return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const i=null!=t.node?t.node:t.ref;if(null==i)return;const n=i.elevationRange;null!=n&&(n.valid=!1)},c.invalidateGeometryVisibility=function(e){const t=this._getNodeInternal(e);null!=t&&null!=t.node&&(t.node.geometryObb=null,d.invalidateMbs(t.node.renderMbs),d.invalidateObb(t.node.serviceObbInRenderSR))},c.invalidateVisibilityObbs=function(){null!=this.rootNode&&this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)))},c._updateElevationRange=function(e){const t=this._getNodeInternal(e);if(null==t)return null;const i=null!=t.node?t.node:t.ref;if(null==i)return null;const n=i.elevationRange;if(null!=n&&n.valid)return n;const s=new a.ElevationRange;let o=!1;for(let r=0;r<t.childCount;r++){const t=this._updateElevationRange(this.getChildIndex(e,r));null!=t?(s.min=Math.min(s.min,t.min),s.max=Math.max(s.max,t.max)):o=!0}if(0===t.childCount||o&&null!=t.node&&t.node.resources.geometry){const e=this._viewportQueries.getElevationRange(i);null!=e&&(s.min=Math.min(s.min,e.min),s.max=Math.max(s.max,e.max))}return null!=n&&n.min===s.min&&n.max===s.max?(n.valid=!0,n):(s.valid=!0,null!=t.node&&(t.node.elevationRange=s),null!=t.ref&&(t.ref.elevationRange=s),this.invalidateBoundingVolumeCache(e),s)},c.isNodeVisible=function(e){const t=this._getNodeInternal(e);if(null==t||null!=t.ref&&!t.ref.mbs)return!0;if(this.needNodeElevationRange&&this._updateElevationRange(e),!p(t.visibilityCache,this._visibilityCacheVersion)){const e=t.node,i=!e||t.ref&&!e.visibilityObb?t.ref??null:e;if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=e||null!=t.ref)&&t.filterImpact===a.NodeFilterImpact.NotChecked){const i=null!=e?e.mbs:null!=t.ref?t.ref.mbs:null;t.filterImpact=null!=i?this._computeNodeFiltering(i):a.NodeFilterImpact.Unmodified}const n=null!=e&&t.filterImpact===a.NodeFilterImpact.Culled,s=!(null!=e&&e.imModificationImpact===a.NodeIMModificationImpact.Culled)&&(!i||this._viewportQueries.isNodeVisible(i))&&!n;return t.visibilityCache=b(s,this._visibilityCacheVersion),s}return y(t.visibilityCache)},c.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!!(null==t||null==t.node||null==t.node.geometryObb||this.layerHasModifications&&t.node.imModificationImpact===a.NodeIMModificationImpact.NotChecked)||this._viewportQueries.isGeometryVisible(t.node)},c._traverseCoverage=function(e,t,i,n,s){const o=this._getPage(e);if(null==o||0===t.childCount)return;const r=t.childOffset+t.childCount,l=new Array;for(let a=t.childOffset;a<r;++a){const e=o.children[a],t=this._getNodeInternal(e);null!=t&&null!=t.node&&this.isGeometryVisible(e)&&l.push(t)}n/=l.length;for(const a of l){const e=a.node.index;this._isLoaded(e)||this._isReloading(e)?(s.delta=Math.max(s.delta,i),s.coverage+=n):this._traverseCoverage(e,a,i+1,n,s)}},c.useNodeAsHole=function(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(p(t.useAsHole,this._version))return y(t.useAsHole);const i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);const n=i.delta*i.coverage<=.5;return t.useAsHole=b(n,this._version),n},c.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},c.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,this._version=v(this._version)},c.imModificationsChanged=function(e){this.layerHasModifications=e,this._forAllNodes((({node:e})=>{null!=e&&(e.imModificationImpact=a.NodeIMModificationImpact.NotChecked,e.visibilityObb=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()},c.layerFilterChanged=function(e){this._layerHasFilter=e,this._forAllNodes((e=>{if(null!=e){e.filterImpact=a.NodeFilterImpact.NotChecked;const t=e.node;null!=t&&this.invalidateNodeVisibilityCache(t.index)}})),this.invalidateVisibilityCache()},c.update=function(e,t,i){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),_.clear();let n=!0;const s=new w,o=new w,r=this._imModificationUncategorized;r.clear();const l=new Set,d=(d,h,u)=>{if(null==h){let e=this._entryPriority(d);e===1/0&&(e=this._entryPriority(u));const t=N(d,this._nodesPerPage);return _.set(t,Math.max(e,_.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const c=h.node;if(this._updateNodeFeatureEstimate(c,o),null==c){const e=this._entryPriority(d);return this._loading.has(d)||this._failedNodes.has(d)||(this._missing.push(d),_.set(d,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=this._getPage(d);if(0===this._missing.length&&0===this._nodesPerPage)for(let e=0;e<h.childCount;e++){const t=f.children[h.childOffset+e],i=this._getNodeInternal(t);null==i||i.node||this._loading.has(t)||this._failedNodes.has(t)||(_.set(t,this._entryPriority(t)),this._prefetch.push(t))}if(c.failed||c.resources.isEmpty)return void(n&&h.childCount>0&&this._isSelected(c)&&(n=!1));if(l.add(c.id),this._isLoaded(d)){if(s.known+=c.memory,++s.knownNodes,this._isSelected(c)?h.childCount>0&&(n=!1):(s.unremoved+=c.memory,n=!1),this._needsUpdate(c)){const e=this._entryPriority(d);_.set(d,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(d)}return}if(c.memory&&(s.known+=c.memory,++s.knownNodes),!this._isSelected(c))return void(this._isReloading(d)&&this._updates.remove.push(d));if(h.childCount>0&&(n=!1),c.memory?(s.missing+=c.memory,s.known+=c.memory,++s.knownNodes):++s.missingNodes,e.includes(c.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(d)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==c.index)));if(!t.done&&this._enable(c))return void t.madeProgress();const g=this._entryPriority(d);_.set(d,g),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,g),this._updates.add.push(d),this.layerHasModifications&&i&&null!=c&&c.imModificationImpact===a.NodeIMModificationImpact.NotChecked&&r.push(d)};this.traverseVisible(d);const h=this._updates.add;h.length>0&&this.layerHasModifications&&(r.length>0&&i?.(r),h.filterInPlace((e=>{const t=this._getNodeInternal(e),i=null==t||null==t.node||t.node.imModificationImpact!==a.NodeIMModificationImpact.Culled;return i||this.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=s.missing-s.unremoved,s.knownNodes>3&&s.missingNodes>0&&(this._unloadedMemoryEstimate+=s.known/s.knownNodes*s.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(o),this._featureEstimate.leavesReached=n,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>_.get(e)-_.get(t))),this._missing.length>0&&(this._maxUnloadedPrio=_.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((e=>_.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>_.get(e)-_.get(t))),this._updates.update.sort(((e,t)=>_.get(e)-_.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,_.clear()},c.checkFeatureTarget=function(e,t){const i=this._viewportQueries.updateScreenSpaceErrorBias(t);let n=t,s=t,o=i,r=10;for(;r--;){const i=new w;this._updateFeatureEstimate(n,i);if(this._computeFeatureEstimate(i)<=e){if(n>=t||i.missingNodes>0||0===r)break;o=n,n=.5*(n+s)}else s=n,n=.5*(n+o)}return this._version=v(this._version),this._viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,n)},c._updateFeatureEstimate=function(e,t){this._version=v(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,i)=>this._updateNodeFeatureEstimate(null!=i?i.node:void 0,t)))},c._updateNodeFeatureEstimate=function(e,t){if(null!=e&&!e.failed&&null!=e.numFeatures)return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(null!=e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},c._computeFeatureEstimate=function(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},c.load=function(){return this._load(this._missing)},c.prefetch=function(){return this._prefetch.sort(((e,t)=>_.get(e)-_.get(t))),this._load(this._prefetch)},c._load=function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)if(0===this._nodesPerPage)this._loadNode(e.pop());else{const t=e.pop();t>=0?this._loadPage(t):this._loadNode(t)}return!0},c.nodeTraversalState=function(e){if(null==e)return null;let t=this._nodeTraversalState.get(e.index);if(t&&p(t.version,this._version))return t;const i=this._viewportQueries.getLodLevel(e),n=this._viewportQueries.hasLOD(e);let s=!0;if(n){const t=this.getParentIndex(e.index);if(null!=t){const e=this._nodeTraversalState.get(t);s=!!e&&i>e.lodLevel}else s=i>0}else s=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=s,t.version=b(!0,this._version),t):(t=new a.NodeTraversalState(n,s,i,b(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)},c._loadNode=async function(e){this._loading.add(e);const t=this._getNodeInternal(e).ref;if(null==t)return void this._failedNodes.add(e);const i=t.id,s=this._urlPrefix+i,o=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};let r=null;try{r=e>=0?await this._streamDataController.request(s,"json"):await this._clientNodeLoader.loadNodeJSON(i)}catch(d){return o(),void(n.isAbortError(d)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+s),this._failedNodes.add(e)))}o();const l=this._validateNode(i,r);if(null==l)return;l.obb&&this.invalidateNodeVisibilityCache(e);const a=this._addNode(l,e);this.nodeTraversalState(a)},c._validateNode=function(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${e}"`);const i=t.geometryData;null==i||Array.isArray(i)&&0===i.length||Array.isArray(i)&&1===i.length&&"./geometries/0"===i[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${e}"`);const n=t.attributeData,s=this._layer.attributeStorageInfo;null==n||Array.isArray(n)&&!n.some(((e,t)=>e.href!==`./attributes/${s?.[t]?.key??`f_${t}`}/0`))||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const o=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,r=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,l=t=>{if(null==t)return null;const i=t=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${e}"`);const n=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,s=new a.NodeBase(`${t.id}`,t.mbs);return s.serviceObb=n,s.visibilityObb=this._computeVisibilityObb(s),s},d=Array.isArray(t.children)?t.children.map(l).filter((e=>null!=e)):null,h=t.featureData&&t.featureData.length>1,u=t.isEmpty&&!0===t.isEmpty;return{id:e,mbs:t.mbs,obb:o,children:d,resources:{isEmpty:!h&&u,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:r}},c.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((e=>{null!=e.node&&(e.node.failed=!1)}))},c._entryPriority=function(e){const t=this._getNodeInternal(e),i=this.getParentIndex(e);if(null==t||null==i&&null==t.node)return null==i?1/0:this._entryPriority(i);let n=0;if(t.node&&null!=i){const e=this._nodeTraversalState.get(i);null!=e&&(n=e.lodLevel)}let s=this.progressiveLoadPenalty;for(let r=e;null!=r;r=this.getParentIndex(r))if(this._isLoaded(r)){s=0;break}const o=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-o-n*(o+this.progressiveLoadPenalty)+s},c.traverseVisible=function(e){const t=this._getNodeInternal(this._rootIndex);null!=t?this._traverseVisible(this._rootIndex,null,t,e):e(this._rootIndex,null,null)},c._traverseVisible=function(e,t,i,n){if(i.node&&0===i.childCount)return void(this.isGeometryVisible(e)&&n(e,i,t));if(!this.isNodeVisible(e))return;if(n(e,i,t),null==i.node)return;const s=this.nodeTraversalState(i.node);if(s?.nodeHasLOD&&s.lodLevel===this._maxLodLevel)return;const o=this._getPage(e);for(let r=0;r<i.childCount;r++){const t=o.children[i.childOffset+r],s=this._getNodeInternal(t);null!=s?this._traverseVisible(t,e,s,n):n(t,null,e)}},c.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},c.traverseChildren=function(e,t){const i=e.index,n=this._getNodeInternal(i);null!=n&&this._traverseChildren(i,n,t)},c._traverseChildren=function(e,t,i){const n=this._getPage(e);if(null==n)return;const s=t.childOffset+t.childCount;for(let o=t.childOffset;o<s;++o){const e=n.children[o],t=this._getNodeInternal(e);null!=t&&null!=t.node&&i(t.node)&&this._traverseChildren(e,t,i)}},c.updateChildrenLoaded=function(e,t){let i=this.getNode(e);for(;null!=i;)i.childrenLoaded+=t,i=this.getParent(i.index)},c.checkChildrenLoadedInvariant=function(){if(null==this.rootNode)return!0;const e=[],t=i=>{let n=this._isLoaded(i.index)||this._isReloading(i.index)?1:0;return this.traverseChildren(i,(e=>(n+=t(e),!1))),i.childrenLoaded!==n&&e.push(i.index),n};return t(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0},c.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},c.updateElevationInfo=function(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()},c.invalidateAllElevationRanges=function(){this._forAllNodes((e=>{g(e),null!=e.node&&(e.node.elevationRange=null),null!=e.ref&&(e.ref.elevationRange=null)}))},c._forAllNodes=function(e){if(null!=this._clientNodePage){const t=this._clientNodePage;for(let i=0;i<t.nodes.length;i++)e(t.nodes[i],-(i+1))}for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const n=t*this._nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],n+t)}}},t._createClass(e,[{key:"rootNode",get:function(){return this.getNode(this._rootIndex)}},{key:"size",get:function(){return this._nodeCount}},{key:"isEditable",get:function(){return this._isEditable}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"isLoading",get:function(){return this._indexMissing>0}},{key:"isPrefetching",get:function(){return this._prefetch.length>0}},{key:"indexLoading",get:function(){return this._loading.size}},{key:"indexMissing",get:function(){return this._indexMissing}},{key:"unloadedMemoryEstimate",get:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"maxPriority",get:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"test",get:function(){return{addNode:(e,t)=>this._addNode(e,t)}}}]),e}();const _=new Map;let f=function(){function e(e){this.missing=e,this.update=new i({deallocator:null}),this.add=new i({deallocator:null}),this.remove=new i({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e){this.add.clear(),this.update.clear(),this.cancel=e},t._createClass(e)}();function g(e){null!=e.node&&(d.invalidateMbs(e.node.renderMbs),d.invalidateObb(e.node.serviceObbInRenderSR)),null!=e.ref&&(d.invalidateMbs(e.ref.renderMbs),d.invalidateObb(e.ref.serviceObbInRenderSR))}function m(e){return d.addWraparound(e,-2)}function v(e){return d.addWraparound(e,2)}function b(e,t){return t+(e?1:0)}function p(e,t){return(-2&e)===t}function y(e){return 1==(1&e)}function N(e,t){return e<0?-1:0===t?0:e/t|0}function P(e=[],t=[],i=[]){return{nodes:e,children:t,parents:i}}function x(e,t){return e<0?-e-1:0===t?e:e%t}function I(e,t,i){return-1===t?-(e+1):0===i?e:t*i+e}const C=[["maxScreenThreshold",a.LodMetric.MaxScreenThreshold],["screenSpaceRelative",a.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",a.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",a.LodMetric.DistanceRangeFromDefaultCamera]];function M(e){if(e)for(let t=0;t<e.length;t++)for(const i of C)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:a.LodMetric.None,maxError:0}}let w=t._createClass((function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}));function S(e){return Math.sqrt(e*(4/Math.PI))}const O=r.create(),E=r.create(),R=r.create(),k=r.create();e.I3SIndex=c,e.selectErrorMetric=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
