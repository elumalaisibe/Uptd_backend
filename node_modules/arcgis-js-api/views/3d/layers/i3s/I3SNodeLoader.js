/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/asyncUtils","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","./enums","./I3SBinaryReader","./I3SMaterialUtil"],(function(e,t,r,n,i,o,s,a,u){"use strict";function l(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}function f(e){if(!e)return null;for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const r of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[r]}}return null}function d(e){if(!e)return null;const t=new Array;for(const r of e.featureData)null!=r.position&&t.push({featureIds:[r.id],featureDataPosition:r.position,geometries:[]});return t}function c(e,t){if(!e||!t||!t.materialDefinitions)return e;const r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=n.clone(e)).vertexAttributes.region,e}function h(e,t){const n={bufferDefinition:null,bufferIndex:0},i=t.resources.geometryDefinition;if(null==e||null==i||i<0)return n;const o=i>=0?e[i].geometryBuffers:null;if(null==o)return n;for(let s=0;s<o.length;s++){const e=o[s];if(null==e.compressedAttributes)n.bufferIndex=s,n.bufferDefinition=o[s];else if("draco"===e.compressedAttributes.encoding&&!r("disable-feature:i3s-draco"))return n.bufferIndex=s,n.bufferDefinition=e,n}return n}return function(){function r(e,t,r,n,i,o){if(this._streamDataController=t,this._logger=r,this._defaultGeometrySchema=n,this._requiredAttributes=i,this._options=o,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map((e=>u.getMaterialAndTextures(t,e)))}}var n=r.prototype;return n._load=function(e,t,r){return this._streamDataController.request(e,t,r)},n._loadAttribute=function(e,t,r){const n=`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this._load(n,"binary",r).then((e=>a.readBinaryAttribute(t,e)))},n.loadAttributes=function(e,t,r){return i.eachAlways(t.map((t=>this._loadAttribute(e,t.attributeStorageInfo,r)))).then((r=>{const n={};for(let o=0;o<t.length;++o){const s=r[o].value;if(s)n[t[o].name]=s;else{if(i.isAbortError(r[o].error))throw r[o].error;this._logger.error("#loadAttributes",this._logLayer,`Failed to load attributeData for '${t[o].name}' on node '${e.id}'`,r[o].error)}}return n}))},n.loadNodeData=async function(e,r){const n=null!=this._requiredAttributes&&e.resources.attributes?t.result(this.loadAttributes(e,this._requiredAttributes,r)):null,{bufferDefinition:i,bufferIndex:o}=h(this._geometryDefinitions,e),s=!!e.resources.geometry,g=s?t.result(this._loadGeometry(e.resources.geometry,o,r)):null,m=e.resources.hasSharedResource?await this._loadShared(e,r):null,_=e.resources.materialDefinition,b=this._materialAndTextures&&null!=_&&_>=0?this._materialAndTextures[_]:null!=m?u.getMaterialAndTexturesFromShared(m):null,y=b?.material,D=b?.textures??[],x=`${e.id}`,p=!s&&this._options.loadFeatureData,A=p?await this._loadFeatureData(x,r):null,T=p?f(A):l(y),w=null==T?d(A):null,$=D.length>0?t.result(this.loadTextures(e,D,r)):null;let I=null,S=null;if(g){I=t.assertResult(await g);const e=c(this._defaultGeometrySchema,m);S=a.createGeometryDescriptor(i,e)}const U=$?t.assertResult(await $):null,E=n?t.assertResult(await n):{},k=E?{attributeData:E,loadedAttributes:this._requiredAttributes}:null;if(null!=T)return{geometryData:T,attributeDataInfo:k,geometryBuffer:I,geometryDescriptor:S,requiredTextures:D,textureData:U};if(null!=w)return{pointData:w,attributeDataInfo:k,geometryBuffer:I,geometryDescriptor:S,requiredTextures:D,textureData:U};throw new Error},r._addAbsoluteHrefTexture=function(e,t){const r=e.textureDefinitions;if(null!=r)for(const n of Object.keys(r))for(const e of r[n].images)Array.isArray(e.href)?e.hrefConcat=e.href.map((e=>o.makeAbsolute(e,t))):e.hrefConcat=o.makeAbsolute(e.href,t)},r._fixTextureEncodings=function(e){const t=e.textureDefinitions;if(null!=t)for(const r in t){const e=t[r];if(Array.isArray(e.encoding))for(let t=0;t<e.encoding.length;t++){const r=e.encoding[t];"data:"===r.substring(0,5)&&(e.encoding[t]=r.substring(5))}else{const t=e.encoding;"data:"===t.substring(0,5)&&(e.encoding=t.substring(5))}}},n._loadShared=function(e,t){const n=`${this._layerUrl}/nodes/${e.resources.geometry}/shared`;return this._load(n,"json",t).then((e=>(r._fixTextureEncodings(e),r._addAbsoluteHrefTexture(e,n),e)))},n._loadTexture=function(e,t,r,n,i,o){let a=!1;return i===s.TextureEncoding.DDS_S3TC||i===s.TextureEncoding.KTX2||i===s.TextureEncoding.Basis?this._load(e,"binary",o).then((e=>({id:t,usage:r,data:e,encoding:i,downsampled:a}))):this._load(e,"image",o).then((e=>{let o=e;const s=4096,u=2;if(n&&e.width*e.height>=s){const t=Math.ceil(e.width/u),r=Math.ceil(e.height/u),n=document.createElement("canvas");n.width=t,n.height=r;n.getContext("2d").drawImage(e,0,0,t,r),o=n,a=!0}return{id:t,usage:r,data:o,encoding:i,downsampled:a}}))},n.loadTextures=function(e,t,r){const n=!!this._options.uncompressedTextureDownsamplingEnabled,i=this._options.textureUsageMask;return Promise.all(t.map((t=>{if(0==(t.usage&i))return null;const o=u.selectEncoding(t.encodings,this._options.textureEncodings);if(null==o)return this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const s=e.resources.texture||e.id,a=`${this._layerUrl}/nodes/${s}/textures/${o.name}`;return this._loadTexture(a,t.id,t.usage,n,o.encoding,r)})))},n._loadFeatureData=function(e,t){const r=`${this._layerUrl}/nodes/${e}/features/0`;return this._load(r,"json",t)},n._loadGeometry=function(e,t,r){const n=`${this._layerUrl}/nodes/${e}/geometries/${t}`;return this._load(n,"binary",r)},e._createClass(r)}()}));
