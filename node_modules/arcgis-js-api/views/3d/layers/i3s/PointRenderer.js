/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/PooledArray","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./Intersector","./PointHighlights","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/ShaderOutput","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/VertexArrayObject","../../webgl-engine/lib/VertexAttribute","../../../../chunks/PointRenderer.glsl","../../webgl-engine/shaders/PointRendererTechnique","../../webgl-engine/shaders/PointRendererTechniqueConfiguration","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],(function(e,t,i,s,n,r,o,a,l,h,u,c,d,g,p,f,_,m,P,b,S,x,y,R,q){"use strict";const w={positions:[new q.VertexElementDescriptor(P.VertexAttribute.POSITION,3,R.DataType.FLOAT,0,12)],colors:[new q.VertexElementDescriptor(P.VertexAttribute.COLOR,3,R.DataType.UNSIGNED_BYTE,0,3,!0)]};let z=function(){function e(e){this._params=e,this.type=_.IntersectorType.PCL,this.isGround=!1,this._passParameters=new b.PointRendererPassParameters,this._highlights=new c.PointHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,i)=>this._addHighlight(e,t,i),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new x.PointRendererTechniqueConfiguration,this._nodes=new s}var P=e.prototype;return P.initializeRenderContext=function(e){this._context=e,this._techniqueRepository=this._context.techniqueRepository,e.requestRender()},P.uninitializeRenderContext=function(){},P.intersect=function(e,t,i,s){const c=r.create(),g=r.create(),p=r.create(),m=r.create(),P=l.create(),b=e.camera.perScreenPixelRatio/2,S=e.camera.near;n.subtract(g,s,i);const x=1/n.length(g);n.scale(g,g,x),n.negate(p,g),o.set(P,g[0],g[1],g[2],-n.dot(g,i));const y=new D,R=new D,q=new Array,w=a.create(),z=a.create(this._passParameters.clipBox);a.offset(z,-i[0],-i[1],-i[2],z),this._nodes.forAll((r=>{const o=r.splatSize*this._passParameters.scaleFactor;let l=d.minimumDistancePlane(r.obb,P),h=d.maximumDistancePlane(r.obb,P);l-=T(o,l+S,this._passParameters,b,r.isLeaf),h-=T(o,h+S,this._passParameters,b,r.isLeaf);const u=h<0,f=null!=y.dist&&null!=R.dist&&y.dist<l*x&&R.dist>h*x;if(u||f)return;const I=A(o,h+S,this._passParameters,b,r.isLeaf);if(!d.intersectLine(r.obb,i,g,I))return;const O=I*I;d.toAaBoundingBox(r.obb,w),a.offset(w,-i[0],-i[1],-i[2],w);const C=!a.contains(z,w);n.subtract(m,r.origin,i);const N=r.coordinates.length/3;for(let d=0;d<N;d++){if(c[0]=m[0]+r.coordinates[3*d],c[1]=m[1]+r.coordinates[3*d+1],c[2]=m[2]+r.coordinates[3*d+2],C&&!a.containsPoint(z,c))continue;const l=n.dot(c,g),h=n.squaredLength(c)-l*l;if(h>O)continue;let u=l+S;const f=T(o,u,this._passParameters,b,r.isLeaf);if(l-f<0)continue;u-=f;const P=A(o,u,this._passParameters,b,r.isLeaf);if(h>P*P)continue;const w=(l-f)*x,I=e=>(e.point=v(r,d,e.point),e.dist=w,e.normal=p,e.node=r,e.pointId=d,e.layerUid=this.layerUid,e);if((null==y.dist||w<y.dist)&&(null==t||t(i,s,w))&&I(y),e.options.store!==_.StoreResults.MIN&&(null==R.dist||w>R.dist)&&(null==t||t(i,s,w))&&I(R),e.options.store===_.StoreResults.ALL&&(null==t||t(i,s,w))){const e=new D;q.push(I(e))}}}));const I=e=>{const{layerUid:t,node:i,pointId:s}=e;return new u.PclTarget(e.point,t,s,(()=>this._params.createGraphic(i,s,e.point)))},O=(e,t)=>{const i=I(t);e.set(this.type,i,t.dist,t.normal)};if(F(y)){const t=e.results.min;(null==t.dist||y.dist<t.dist)&&O(t,y)}if(F(R)&&e.options.store!==_.StoreResults.MIN){const t=e.results.max;(null==t.dist||R.dist>t.dist)&&O(t,R)}if(e.options.store===_.StoreResults.ALL){const t=h.fromPoints(i,s);for(const i of q){const s=f.newIntersectorResult(t);O(s,i),e.results.all.push(s)}}},P.prepareTechnique=function(e){return 0===this._nodes.length||e.output!==g.ShaderOutput.Color&&e.output!==g.ShaderOutput.Depth&&e.output!==g.ShaderOutput.Highlight?null:(this._nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)})),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output===g.ShaderOutput.Depth?g.ShaderOutput.Depth:e.output===g.ShaderOutput.Highlight?g.ShaderOutput.Highlight:g.ShaderOutput.Color,this._techniqueRepository.releaseAndAcquire(S.PointRendererTechnique,this._techniqueConfig,this._technique))},P.render=function(e,t){const i=e.rctx,s=i.bindTechnique(t,this._passParameters,e.bindParameters),n=e.output===g.ShaderOutput.Highlight;this._nodes.forAll((t=>{0===t.coordinates.length||n&&!t.highlights||(s.bindDraw(t,e.bindParameters,this._passParameters),i.bindVAO(t.vao),n?this._renderHighlightFragments(i,t):i.drawArrays(R.PrimitiveType.POINTS,0,t.coordinates.length/3))}))},P._renderHighlightFragments=function(e,t){const i=t.highlights;if(null==i)return;let s=i[0].component,n=s+1;for(let o=1;o<i.length;o++){const t=i[o].component;if(t!==n){const i=n-s;i>0&&e.drawArrays(R.PrimitiveType.POINTS,s,i),s=t}n=t+1}const r=n-s;r>0&&e.drawArrays(R.PrimitiveType.POINTS,s,r)},P.addNode=function(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},P.removeNode=function(e){let t=null;return this._nodes.filterInPlace((s=>s.id!==e||(t=s,s.vao=i.disposeMaybe(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),t},P.forEachNode=function(e){this._nodes.forAll(e)},P.removeAll=function(){this._nodes.forAll((e=>e.vao=i.disposeMaybe(e.vao))),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()},P.highlight=function(e){return this._highlights.add(e)},P._addHighlight=function(e,t,i){e.highlights=N(e.highlights,t,i),this._requestRender()},P._removeHighlight=function(e,t){e.highlights=E(e.highlights,t),this._requestRender()},P._initNode=function(e,t){const i=e.rctx;t.vao=new m.VertexArrayObject(i,p.Default3D,w,{positions:y.BufferObject.createVertex(i,R.Usage.STATIC_DRAW,t.coordinates),colors:y.BufferObject.createVertex(i,R.Usage.STATIC_DRAW,t.rgb)})},P._requestRender=function(){this._context&&this._context.requestRender()},t._createClass(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._passParameters.useFixedSizes},set:function(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._passParameters.scaleFactor},set:function(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._passParameters.minSizePx},set:function(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._passParameters.useRealWorldSymbolSizes},set:function(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._passParameters.size},set:function(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._passParameters.sizePx},set:function(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){a.set(this._passParameters.clipBox,e||a.POSITIVE_INFINITY)}},{key:"_clippingEnabled",get:function(){return!a.equals(this._passParameters.clipBox,a.POSITIVE_INFINITY,((e,t)=>e===t))}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}}]),e}(),I=function(e){function i(t,i,s,n,r,o,a,l,h=null,u=null){var c;return(c=e.call(this,s,r,i)||this).id=t,c.obb=n,c.coordinates=o,c.rgb=a,c.attributes=l,c.pointIdFilterMap=h,c.highlights=u,c}return t._inherits(i,e),t._createClass(i)}(b.PointRendererDrawParameters);function O(e){return e.hasOwnProperty("splatSize")}function A(e,t,i,s,n){if(i.drawScreenSpace)return i.fixedSize*t*s;const r=b.getMaxPointSizeScreenspace(n)*t*s;return i.useFixedSizes?Math.min(i.fixedSize/2,r):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*s,e/2),r):Math.min(e/2,r)}function T(e,t,i,s,n){return i.drawScreenSpace?0:A(e,t,i,s,n)}function v(e,t,i){return null==i&&(i=r.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}function C(e){return null!=e.component?e.component:-1}function N(e,t,i){null==e&&(e=[]);const s={component:t,id:i};e.push(s);const n=C(s);let r=e.length-1;for(;r>0&&n<C(e[r-1]);)[e[r-1],e[r]]=[e[r],e[r-1]],--r;return e}function E(e,t){if(null==e)return e;const i=e.filter((e=>e.id!==t));return 0===i.length?null:i}let D=t._createClass((function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}));function F(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}e.PointRenderer=z,e.PointRendererNode=I,e.isInstanceOfNode=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
