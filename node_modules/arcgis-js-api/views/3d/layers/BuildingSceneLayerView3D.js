/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/arrayUtils","../../../core/Collection","../../../core/handleUtils","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../layers/buildingSublayers/BuildingGroupSublayer","./BuildingComponentSublayerView3D","./BuildingSublayerView3D","./LayerView3D","./i3s/BuildingFilterUtil","./i3s/I3SUtil","../support/updatingProperties","../../layers/BuildingSceneLayerView"],(function(e,r,t,i,n,s,o,l,a,u,c,p,y,h,d,g,f,b,w,V,_,m,C){"use strict";const S=b.BuildingSublayerView3DMixin(i);let v=function(r){function i(e){var t;return(t=r.call(this,e)||this).type="building-scene-3d",t.sublayerViews=new s,t._abortController=new AbortController,t._loadingComponents=0,t._pendingWhenSublayerViews=new Map,t.ignoresMemoryFactor=!1,t}e._inherits(i,r);var p=i.prototype;return p.isUpdating=function(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((e=>e.updating))},p.initialize=function(){_.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this._initializeSubLayerViews(this.layer.sublayers,this)},p.destroy=function(){this.sublayerViews&&(this.sublayerViews.forEach((e=>e.destroy())),this.sublayerViews=null),this._abortController=a.abortMaybe(this._abortController)},p._initializeSubLayerViews=function(e,r){const t=this,i=this.view;e.forEach((e=>{if(!e.isEmpty)if("building-group"===e.type){const t=new S({sublayer:e,view:i,parent:r});this._initializeSubLayerViews(e.sublayers,t)}else"mesh"===e.geometryType&&(this._loadingComponents++,e.load({signal:this._abortController.signal}).then((()=>{const n=new f({sublayer:e,layerView:t,view:i,parent:r});this.sublayerViews.push(n);const s=this._pendingWhenSublayerViews.get(e);if(s){for(const e of s)e.resolve(n);this._pendingWhenSublayerViews.delete(e)}this.handles.add([c.watch((()=>n.updating),(()=>this.notifyChange("updating")),c.syncAndInitial),c.watch((()=>n.updatingProgress),(()=>this.notifyChange("updatingProgressValue")),c.syncAndInitial)])})).catch((r=>{u.isAbortError(r)||l.getLogger(this).error(`Error while creating view for sublayer ${e.id}\nLayer: ${this.layer.url}\n`,r)})).then((()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})))}))},p.getGraphicFromIntersectorTarget=function(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getGraphicFromIntersectorTarget(e);return null},p.fetchPopupFeatures=async function(e,r){if(null==r||!r.clientGraphics||0===r.clientGraphics.length)return[];const t=n.groupToMap(r.clientGraphics,(e=>e.sourceLayer)),i=[];for(const[n,s]of t){const t=this._findComponent(n);null!=t&&i.push(t.fetchPopupFeatures(e,{...r,clientGraphics:s}))}return u.eachAlwaysValues(i).then((e=>e.flat()))},p.whenGraphicBounds=function(e){const r=this._findComponent(e.sourceLayer);return null==r?Promise.reject():r.whenGraphicBounds(e)},p.getAABBFromIntersectorTarget=function(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getAABBFromIntersectorTarget(e);return null},p.whenSublayerView=async function(e){const r=this._findComponent(e);if(null!=r)return r;const t=this._pendingWhenSublayerViews.get(e),i=u.createResolver();return t?t.push(i):this._pendingWhenSublayerViews.set(e,[i]),i.promise},p._findComponent=function(e){return this.sublayerViews.find((r=>e===r.sublayer))},p.highlight=function(e){e instanceof t?e=[e]:e instanceof s&&(e=e.toArray());const r=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof t){const t=e,i=new Map;for(const e of t){let r=i.get(e.sourceLayer);null==r&&(r=[],i.set(e.sourceLayer,r)),r.push(e)}this.sublayerViews.forEach((e=>{const t=i.get(e.sublayer);t&&r.push(e.highlight(t))}))}return o.handlesGroup(r)},e._createClass(i,[{key:"filterExpression",get:function(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null,t=null!=r?r.filterBlocks?.find((e=>"solid"===e.filterMode.type)):null;return t?t.filterExpression:null}},{key:"filterExpressions",get:function(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null;return r&&r.filterBlocks?r.filterBlocks.toArray().map((e=>[e.filterExpression??"",V.parseFilterMode(e)])):[]}},{key:"updatingProgressValue",get:function(){const e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce(((e,r)=>e+r.updatingProgress),0)/r}},{key:"usedMemory",get:function(){return this.sublayerViews.reduce(((e,r)=>e+r.usedMemory),0)}},{key:"unloadedMemory",get:function(){return this.sublayerViews.reduce(((e,r)=>e+r.unloadedMemory),0)}}]),i}(w.LayerView3D(C));r.__decorate([p.property()],v.prototype,"sublayerViews",void 0),r.__decorate([p.property({readOnly:!0})],v.prototype,"filterExpression",null),r.__decorate([p.property({readOnly:!0})],v.prototype,"filterExpressions",null),r.__decorate([p.property(m.updatingProgress)],v.prototype,"updatingProgress",void 0),r.__decorate([p.property({readOnly:!0,dependsOn:[]})],v.prototype,"updatingProgressValue",null),v=r.__decorate([d.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],v);return v}));
