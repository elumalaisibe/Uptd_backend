/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Logger","../../../core/maybe","../../../core/ReactiveSet","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../core/sql/WhereClause","../../../layers/support/FeatureFilter","../../../layers/support/floorFilterUtils","../../../rest/support/Query","../../../support/featureFlags","./I3SMeshView3D","./II3SMeshView3D","./LayerView3D","./i3s/featureEditing","./i3s/I3SGeometryUtil","./i3s/I3SMeshViewFilter","./i3s/I3SNode","./i3s/I3SOverrides","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/PopupSceneLayerView","./support/SceneLayerViewRequiredFields","../support/updatingProperties","../../layers/SceneLayerView","../../layers/support/popupUtils","../../support/Scheduler"],(function(e,t,i,r,s,n,l,o,a,d,u,c,h,p,y,g,f,_,F,b,I,S,v,w,E,O,C,j,x,Q,m,V,H,D,L,q,k){"use strict";const P=m.defineFieldProperties();let A=function(t){function o(){var e;return(e=t.apply(this,arguments)||this).type="scene-layer-3d",e._setVisibilityHiddenObjectIds=new n,e.progressiveLoadFactor=1,e._elevationContext="scene",e._isIntegratedMesh=!1,e._supportsLabeling=!0,e._interactiveEditingSessions=new Map,e._queryEngine=null,e}e._inherits(o,t);var a=o.prototype;return a.tryRecycleWith=function(e,t){return e.url===this.layer.url&&this.i3sOverrides.isEmpty?e.load(t).then((()=>{x.checkRecyclable(this.layer,e,this.i3sOverrides),this.layer=e,this.i3sOverrides.destroy();const t=this.view.resourceController?.memoryController;this.i3sOverrides=new E.I3SOverrides({view:this.view,layer:e,memoryController:t}),this.resetHighlights()})):null},a.initialize=function(){this._fieldsHelper=new H.SceneLayerViewRequiredFields({layerView:this}),this.updatingHandles.add((()=>this.layer.rangeInfos),(e=>this._rangeInfosChanged(e)),l.initial),this.updatingHandles.add((()=>this.layer.renderer),(e=>this.updatingHandles.addPromise(this._rendererChange(e))),l.initial);const e=()=>this._filterChange();this.updatingHandles.add((()=>this.parsedDefinitionExpression),e),this.updatingHandles.add((()=>this.filter),e),this.updatingHandles.add((()=>this._floorFilterClause),e),this.updatingHandles.add((()=>this._excludeObjectIdsSorted),e),this.updatingHandles.add((()=>this._setVisibilityHiddenObjectIdsSorted),e),this.updatingHandles.add((()=>null!=this.viewFilter?this.viewFilter.sortedObjectIds:null),e),this.updatingHandles.add((()=>null!=this.viewFilter?this.viewFilter.parsedWhereClause:null),e),this.updatingHandles.add((()=>[null!=this.viewFilter?this.viewFilter.parsedGeometry:null,null!=this.filter?this.filter.spatialRelationship:null,null!=this.layer.filter?this.layer.filter.spatialRelationship:null]),(()=>this._geometryFilterChange())),f.sceneLayerEditingEnabled()&&this.i3sOverrides.is3DOFL&&this.updatingHandles.add((()=>this.i3sOverrides.sortedGeometryChangedObjectIds),e),this.handles.add(this.layer.on("apply-edits",(e=>this.updatingHandles.addPromise(e.result)))),this.handles.add(this.layer.on("edits",(e=>this._handleEdits(e))))},a.destroy=function(){this._fieldsHelper=s.destroyMaybe(this._fieldsHelper)},a._rangeInfosChanged=function(e){null!=e&&e.length>0&&r.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},a.createQuery=function(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return null!=this.filter?this.filter.createQuery(e):new g(e)},a.queryExtent=function(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),t?.signal)},a.queryFeatureCount=function(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),t?.signal)},a.queryFeatures=function(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),t?.signal).then((e=>{if(!e?.features)return e;const t=this.layer;for(const i of e.features)i.layer=t,i.sourceLayer=t;return e}))},a.queryObjectIds=function(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),t?.signal)},a._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},a._createQueryEngine=function(){const e=S.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new O.I3SQueryEngine({layerView:this,priority:k.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new j.I3SQueryFeatureStore({featureAdapter:new C.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo??[],getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,i,r)=>e({id:t,index:i,meta:r})),t,F.ForAllFeaturesMode.QUERYABLE),getFeatureExtent:e,sourceSpatialReference:x.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})},a.highlight=function(t){const i=this._highlights;if(t instanceof g){const{set:e,handle:r}=i.acquireSet();return this.queryObjectIds(t).then((t=>i.setFeatureIds(e,t))),r}return e._get(e._getPrototypeOf(o.prototype),"highlight",this).call(this,t)},a.createInteractiveEditSession=function(e){return I.createInteractiveEditSession(this._attributeEditingContext,e)},a._createLayerGraphic=function(e){const t=new i(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t},a.getFilters=function(){const t=e._get(e._getPrototypeOf(o.prototype),"getFilters",this).call(this);f.sceneLayerEditingEnabled()&&this.i3sOverrides.is3DOFL&&this.i3sOverrides.sortedGeometryChangedObjectIds.length>0&&t.push(((e,t)=>{t.node.index>=0&&x.objectIdFilter(this.i3sOverrides.sortedGeometryChangedObjectIds,!1,e)}));const i=this._setVisibilityHiddenObjectIdsSorted;null!=i&&t.push((e=>x.objectIdFilter(i,!1,e)));const r=this._excludeObjectIdsSorted;return null!=r&&t.push((e=>x.objectIdFilter(r,!1,e))),this._floorFilterClause&&this.addSqlFilter(t,this._floorFilterClause,this.logError),this.addSqlFilter(t,this.parsedDefinitionExpression,this.logError),null!=this.viewFilter&&this.viewFilter.addFilters(t,this.view,this._controller.crsIndex,this._collection),t},a.setVisibility=function(e,t){t?this._setVisibilityHiddenObjectIds.delete(e):this._setVisibilityHiddenObjectIds.add(e)},a.isUpdating=function(){return e._get(e._getPrototypeOf(o.prototype),"isUpdating",this).call(this)||this.layerFilterUpdating||null!=this.viewFilter&&this.viewFilter.updating||null!=this.i3sOverrides&&this.i3sOverrides.updating},a._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(null==e?this.createQuery():g.from(e))},a._handleEdits=function(e){f.sceneLayerEditingEnabled()&&I.processGeometryEdits(this._attributeEditingContext,e),I.processAttributeEdits(this._attributeEditingContext,e)},a.computeNodeFiltering=function(e){const t=this.viewFilter;return null==t||!this.view.spatialReference||t.isMBSGeometryVisible(e,this.view.spatialReference,this._controller.crsIndex)?w.NodeFilterImpact.Unmodified:w.NodeFilterImpact.Culled},e._createClass(o,[{key:"i3slayer",get:function(){return this.layer}},{key:"layerPopupEnabledAndHasTemplate",get:function(){return this.layer.popupEnabled&&q.hasPopupTemplate(this.layer,this.view.popup?.defaultPopupTemplateEnabled)}},{key:"filter",get:function(){return this._get("filter")},set:function(e){this._set("filter",v.I3SMeshViewFilter.checkSupport(e)?e:null)}},{key:"viewFilter",get:function(){const e=this.filter,t=this.layerFilter;if(null==e&&null==t)return null;const i=this._get("viewFilter");return null==i?new v.I3SMeshViewFilter({layerFilter:t,viewFilter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):(i.viewFilter=e,i.layerFilter=t,i)}},{key:"requiredFields",get:function(){return this._fieldsHelper?.requiredFields??[]}},{key:"_floorFilterClause",get:function(){const e=y.getFloorFilterClause(this);return null!=e?h.WhereClause.create(e,this.layer.fieldsIndex):null}},{key:"_excludeObjectIdsSorted",get:function(){const e=this.layer.excludeObjectIds.toArray();return e.length?e.sort(((e,t)=>e-t)):null}},{key:"_setVisibilityHiddenObjectIdsSorted",get:function(){return this._setVisibilityHiddenObjectIds.size?Array.from(this._setVisibilityHiddenObjectIds).sort(((e,t)=>e-t)):null}},{key:"_objectQualitySettings",get:function(){return this.view?.qualitySettings?.sceneService?.object}},{key:"lodFactor",get:function(){return this._objectQualitySettings?.lodFactor??1}},{key:"lodCrossfadeinDuration",get:function(){return this._objectQualitySettings.lodCrossfadeinDuration??0}},{key:"lodCrossfadeoutDuration",get:function(){return this._objectQualitySettings.lodCrossfadeoutDuration??0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return this._objectQualitySettings.lodCrossfadeUncoveredDuration??0}},{key:"updatingProgressValue",get:function(){return this._controller?.updatingProgress??0}},{key:"_attributeEditingContext",get:function(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),globalIdField:this._getGlobalIdField(),forEachNode:e=>this._forAllNodes((t=>null!=t?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this.i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}},{key:"hasGeometryFilter",get:function(){const e=this.viewFilter;return null!=e&&null!=e.parsedGeometry}}]),o}(_.I3SMeshView3D(Q.DefinitionExpressionSceneLayerView(V.PopupSceneLayerView(b.LayerView3D(L)))));t.__decorate([o.property()],A.prototype,"i3slayer",null),t.__decorate([o.property(D.updatingProgress)],A.prototype,"updatingProgress",void 0),t.__decorate([o.property({type:p})],A.prototype,"filter",null),t.__decorate([o.property({readOnly:!0})],A.prototype,"viewFilter",null),t.__decorate([o.property(P.requiredFields)],A.prototype,"requiredFields",null),t.__decorate([o.property(P.availableFields)],A.prototype,"availableFields",void 0),t.__decorate([o.property()],A.prototype,"_fieldsHelper",void 0),t.__decorate([o.property()],A.prototype,"_floorFilterClause",null),t.__decorate([o.property()],A.prototype,"_excludeObjectIdsSorted",null),t.__decorate([o.property()],A.prototype,"_setVisibilityHiddenObjectIds",void 0),t.__decorate([o.property()],A.prototype,"_setVisibilityHiddenObjectIdsSorted",null),t.__decorate([o.property()],A.prototype,"_objectQualitySettings",null),t.__decorate([o.property()],A.prototype,"lodFactor",null),t.__decorate([o.property()],A.prototype,"updatingProgressValue",null),A=t.__decorate([c.subclass("esri.views.3d.layers.SceneLayerView3D")],A);return A}));
