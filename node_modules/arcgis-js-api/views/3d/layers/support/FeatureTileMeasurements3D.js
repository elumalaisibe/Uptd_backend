/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/screenUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/triangle","./FeatureTileDescriptor3D","./FeatureTileVisibility3D","../../webgl-engine/lib/Camera"],(function(e,t,i,r,s,n,o,a,c,l,u,h){"use strict";let _=function(){function e(e){this._camera=new h.Camera,this._focusOnMap=[0,0],this._screenRect=n.create(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new u.FeatureTileVisibility3D(e.renderCoordsHelper)}var i=e.prototype;return i.begin=function(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,n.fromValues(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)},i.end=function(){this._visibility.end()},i.updateTile=function(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=n.distance(e.extent,this._focusOnMap),e.measures.visibility!==l.Visibility.INVISIBLE&&this._updateScreenMeasure(e)},i._updateScreenMeasure=function(e){const t=p,i=1<<t,r=e.measures.screenRect;n.empty(r);let s=0;const o=e.lij[0]+t,a=e.lij[1]<<t,c=e.lij[2]<<t,l=this._tileSizeWithBias(e),u=l*l;for(let n=0;n<i;n++)for(let t=0;t<i;t++)if(s+=this._computeScreenArea(e,o,a+n,c+t,r),s>u)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1},i._tileSizeWithBias=function(e){return e.measures.visibility===l.Visibility.VISIBLE_WHEN_EXTENDED?this._tileSize*m:this._tileSize},i._computeScreenArea=function(e,t,i,r,s){const o=e.measures.visibility===l.Visibility.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,i,r,o,f),n.empty(d);for(let a=0;a<4;a++)n.expandPointInPlace(d,f[a]);return n.expand(s,d,s),c.areaPoints2d(f[0],f[1],f[2])+c.areaPoints2d(f[0],f[2],f[3])},i._projectToScreen=function(e,t,i,r,s){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,t,i,S),this._toRenderCoords(S,0,3,g[0]),this._toRenderCoords(S,2,3,g[1]),this._toRenderCoords(S,2,1,g[2]),this._toRenderCoords(S,0,1,g[3]),r&&(this._projectToPlane(g,this._camera.frustum[o.PlaneIndex.NEAR]),this._projectToPlane(g,this._camera.frustum[o.PlaneIndex.TOP]),this._projectToPlane(g,this._camera.frustum[o.PlaneIndex.BOTTOM]));for(let n=0;n<4;n++)this._camera.projectToRenderScreen(g[n],P),this._camera.renderToScreen(P,s[n])},i._projectToPlane=function(e,t){for(let r=0;r<4;r++)b[r]=a.signedDistance(t,e[r]);const i=Math.max(b[0],b[1],b[2],b[3]);if(i>0){const s=r.scale(y,a.normal(t),-i);for(let t=0;t<4;t++)r.add(e[t],e[t],s)}},i._toRenderCoords=function(e,t,i,r){return y[0]=e[t],y[1]=e[i],y[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(y,this._tilingScheme.spatialReference,r),r},t._createClass(e)}();const d=n.create(),p=2,m=5,f=[i.createScreenPointArray(),i.createScreenPointArray(),i.createScreenPointArray(),i.createScreenPointArray()],S=n.create(),y=s.create(),g=[s.create(),s.create(),s.create(),s.create()],b=[0,0,0,0],P=i.createRenderScreenPointArray3();e.FeatureTileMeasurements3D=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
