/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/asyncUtils","../../../../core/HandleOwner","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/FeatureFilter","../../../../layers/support/floorFilterUtils","../graphics/QueryEngine","../../../support/Scheduler"],(function(e,t,r,i,l,s,a,n,u,o,p,c,y,_,d,h,F,f){"use strict";e.FeatureVisibilityFilter=function(e){function r(r){var i;return(i=e.call(this,r)||this)._updateTask=null,i._frameTask=null,i._queryEngine=null,i._updateRequested=!0,i._updateVisibility=async e=>{if(null==i._compositedFeatureFilter&&null==i._sceneFilter||0===i.context.getFeatureCount())return i._frameTask.schedule((()=>i.clear()),e);try{const t=await i._queryEngine.executeQueryForIdSet(i._compositedFeatureFilter,i._sceneFilter,e);return i._frameTask.schedule((()=>{i.context.updateFeatureVisibilities((e=>t.has(e)))}),e)}catch(r){return n.throwIfAbortError(r),s.getLogger(t._assertThisInitialized(i)).warn(`FeatureFilter query failed: ${r}`,{error:r}),i._frameTask.schedule((()=>{i.context.setAllFeaturesVisibility(!0)}),e)}},i}t._inherits(r,e);var l=r.prototype;return l.initialize=function(){const e=f.TaskPriority.FILTER_VISIBILITY,{layer:t,view:r}=this._layerView,{featureStore:i}=this.context,l="hasZ"in this._layerView&&this._layerView.hasZ,s="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new F.QueryEngine({context:{spatialReference:r.spatialReference,layer:t,scheduler:r.resourceController.scheduler,featureStore:i,hasM:s,hasZ:l},priority:e}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(e,this),this.updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),u.initial)},l.destroy=function(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=a.abortMaybe(this._updateTask),this._frameTask=a.removeMaybe(this._frameTask),this._queryEngine=a.destroyMaybe(this._queryEngine),this._set("context",null)},l.reapply=function(){this._updateRequested=!0},l.clear=function(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()},l.runTask=function(e){this._updateRequested&&(this._updateTask=a.abortMaybe(this._updateTask),this._updateTask=i.createTask(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e)},t._createClass(r,[{key:"updating",get:function(){return this.running||this.updatingHandles.updating||null!=this._updateTask&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return h.getFloorFilterClause(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){const{_featureFilter:e,_timeExtent:t,_floorFilter:r}=this;if(null==t&&null==r)return e;const i=null!=e?e.clone():new d;if(null!=t&&(i.timeExtent=null!=i.timeExtent?i.timeExtent.intersection(t):t),null!=r){const e=null==i.where||""===i.where;i.where=e?r:`(${i.where}) AND (${r})`}return i}},{key:"_layerView",get:function(){return this.context.layerView}}]),r}(l.HandleOwner),r.__decorate([o.property({constructOnly:!0})],e.FeatureVisibilityFilter.prototype,"context",void 0),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"updating",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"running",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"defaultVisibility",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_featureFilter",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_sceneFilter",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_floorFilter",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_timeExtent",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_layerView",null),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_updateTask",void 0),r.__decorate([o.property()],e.FeatureVisibilityFilter.prototype,"_updateRequested",void 0),e.FeatureVisibilityFilter=r.__decorate([_.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],e.FeatureVisibilityFilter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
