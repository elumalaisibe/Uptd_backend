/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../../../core/ObjectPool","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../ViewingMode","./FeatureTileDescriptor3D","../../state/Frustum","../../support/FrustumExtentIntersection"],(function(e,t,i,n,s,r,o,u,l,d,a,c,_,h){"use strict";let I=function(){function e(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustum=new _.Frustum(e),this._extendedFrustum=new _.Frustum(e),this._intersector=new h.FrustumExtentIntersection({renderCoordsHelper:e}),this._renderCoordsHelper=e}var n=e.prototype;return n.begin=function(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)},n.end=function(){this._cache.clear()},n.calculate=function(e){if(this._allTilesInvisible)return c.Visibility.INVISIBLE;const t=this._renderCoordsHelper.viewingMode===a.ViewingMode.Global&&e.lij[0]>=T&&e.lij[0]<m,i=this._getOrCalculateSingleTileVisibility(e,!t);return i!==c.Visibility.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):i},n._shortenFrustumFarPlane=function(e){const t=_.Frustum.nearFarLineIndices,i=e.mutablePoints;for(const n of t){const[e,t]=n,r=i[e],o=i[t];s.subtract(E,o,r),s.scale(E,E,P),s.add(i[t],r,E)}e.updatePoints(i)},n._calculateAggregatedChildrenVisibility=function(e){let t=c.Visibility.INVISIBLE;const i=this._cache.get(e.id);if(null!=i)return i;const n=b.acquire();e.getChildren(n);for(const s of n){const e=this.calculate(s);if(e!==c.Visibility.INVISIBLE&&(t=e,e===c.Visibility.VISIBLE_ON_SURFACE))break}return b.release(n),this._cache.set(e.id,t),t},n._getOrCalculateSingleTileVisibility=function(e,t){const i=this._cache.get(e.id);if(null!=i)return i;const n=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,n),n},n._calculateSingleTileVisibility=function(e){if(!this._aboveGround&&this._renderCoordsHelper.viewingMode===a.ViewingMode.Global&&e.lij[0]<F){return this._calculateSingleTileVisibilitySided(e,!1)===c.Visibility.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0}return this._calculateSingleTileVisibilitySided(e,this._aboveGround)},n._calculateSingleTileVisibilitySided=function(e,t){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);const i=o.getReferenceEllipsoid(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,i)?this._intersector.isVisibleInFrustum(this._frustum,i,!0)?c.Visibility.VISIBLE_ON_SURFACE:c.Visibility.VISIBLE_WHEN_EXTENDED:c.Visibility.INVISIBLE},n._updateExtendedFrustum=function(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,E);this._aboveGround||s.negate(t,t);const n=i.acosClamped(-s.dot(t,e.viewForward));if(this._allTilesInvisible=n>(Math.PI+e.fovY)/2,this._allTilesInvisible)return;if(this._hasExtendedFrustum=n>e.fovY/2,!this._hasExtendedFrustum)return;const r=this._extendedFrustumParameters(),o=this._extendedFrustum.mutablePoints;for(let i=0;i<4;i++){const e=r.pointIndices[i],t=o[e],n=this._renderCoordsHelper.getAltitude(t);if(r.needsAltitudeAdjustment(n)){switch(this._renderCoordsHelper.worldUpAtPosition(t,E),e){case u.PointIndex.FAR_BOTTOM_LEFT:case u.PointIndex.FAR_TOP_LEFT:case u.PointIndex.NEAR_BOTTOM_LEFT:case u.PointIndex.NEAR_TOP_LEFT:l.projectVector(this._extendedFrustum.planes[u.PlaneIndex.LEFT],E,E);break;case u.PointIndex.FAR_BOTTOM_RIGHT:case u.PointIndex.FAR_TOP_RIGHT:case u.PointIndex.NEAR_BOTTOM_RIGHT:case u.PointIndex.NEAR_TOP_RIGHT:l.projectVector(this._extendedFrustum.planes[u.PlaneIndex.RIGHT],E,E)}s.scale(E,E,r.direction),this._renderCoordsHelper.intersectInfiniteManifold(d.wrap(t,E),r.zWithMargin,t)}}if(this._extendedFrustum.updatePoints(o),l.fromPoints(o[u.PointIndex.NEAR_BOTTOM_LEFT],o[u.PointIndex.NEAR_BOTTOM_RIGHT],o[u.PointIndex.NEAR_TOP_RIGHT],f),l.fromPoints(o[u.PointIndex.NEAR_BOTTOM_RIGHT],o[u.PointIndex.NEAR_TOP_RIGHT],o[u.PointIndex.NEAR_TOP_LEFT],x),s.dot(l.normal(f),l.normal(x))<0){const e=this._extendedFrustum.mutablePoints;this._aboveGround?[e[u.PointIndex.NEAR_BOTTOM_LEFT],e[u.PointIndex.NEAR_BOTTOM_RIGHT]]=[e[u.PointIndex.NEAR_BOTTOM_RIGHT],e[u.PointIndex.NEAR_BOTTOM_LEFT]]:[e[u.PointIndex.NEAR_TOP_LEFT],e[u.PointIndex.NEAR_TOP_RIGHT]]=[e[u.PointIndex.NEAR_TOP_RIGHT],e[u.PointIndex.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(e)}},n._extendedFrustumParameters=function(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()},n._extendedFrustumParametersAboveSurface=function(){const e=this._surfaceElevation-p;return{zWithMargin:e,pointIndices:_.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}},n._extendedFrustumParametersBelowSurface=function(){const e=this._surfaceElevation+p;return{zWithMargin:e,pointIndices:_.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}},t._createClass(e)}();const T=2,m=6,F=12,P=.95,p=1,E=r.create(),f=l.create(),x=l.create(),b=new n(Array,(e=>{4!==e.length&&(e[0]=new c.FeatureTileDescriptor3D,e[1]=new c.FeatureTileDescriptor3D,e[2]=new c.FeatureTileDescriptor3D,e[3]=new c.FeatureTileDescriptor3D)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));e.FeatureTileVisibility3D=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
