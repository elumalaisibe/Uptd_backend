/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../symbols","../../../core/Accessor","../../../core/arrayUtils","../../../core/Handles","../../../core/lang","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/uid","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/diffUtils","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/DoubleArray","../../../layers/graphics/dehydratedFeatures","./graphics/Graphics3DCore","./graphics/Graphics3DScaleVisibility","./i3s/I3SGeometryUtil","../support/LimitGraphicsMap","../webgl-engine/lib/UpdatePolicy","../../../symbols/PointSymbol3D"],(function(e,t,r,i,o,a,s,n,c,l,p,h,d,u,y,f,_,g,b,I,m,E,M,v,D){"use strict";let G=e._createClass((function(e,t){this.meta=e,this.index=t})),C=e._createClass((function(e,t){this.graphic=e,this.geometry=t,this.components=[],this.overridesDirty=!1})),w=function(t){function r(e){var r;return(r=t.call(this,e)||this).loadedGraphics=new M.LimitGraphicsMap(5e4),r.slicePlaneEnabled=!1,r._renderingInfo={symbol:new D},r._handles=new a,r._featuresMap=new Map,r}e._inherits(r,t);var i=r.prototype;return i.initialize=function(){const e=this.view.basemapTerrain;this._graphicsCore=new I.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:v.UpdatePolicy.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:e=>this.view.deconflictor.addGraphicsOwner(e),labeler:(e,t)=>this.view.labeler.addGraphicsOwner(e,t,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(t,r)=>new m({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:r,graphicsCore:t,basemapTerrain:e,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then((()=>this._graphicsCore.startCreateGraphics())).catch((()=>{})),this._handles.add(l.watch((()=>this.layer.labelingInfo),((e,t)=>{y.diff(e,t)&&this._graphicsCore.updateLabelingInfo()})))},i.destroy=function(){this._handles=c.destroyMaybe(this._handles),this._graphicsCore=c.destroyMaybe(this._graphicsCore),this.loadedGraphics=c.destroyMaybe(this.loadedGraphics),this.view=null},i.addNodeMeta=function(e,t){let r=0;const i=e.filteredIds,o=this.view.spatialReference,a=[];for(let s=0;s<e.featureIds.length;s++){const n=e.featureIds[s];let c=null==i;if(i&&r<i.length&&n===i[r]&&(c=!0,r++),!this._enabledForFeatureInNode(e,s))continue;const l=this._featuresMap.get(n);if(l){l.components.push(new G(e,s)),this._updateLabelPosition(n);continue}const h=t(s,e),d=b.makeDehydratedPoint(0,0,0,o),u={objectId:n,uid:p.generateUID(),attributes:h,visible:c,geometry:d},y=new C(u,d);y.components.push(new G(e,s)),this._featuresMap.set(n,y),this._updateLabelGeometry(n),a.push(u)}this.loadedGraphics.addMany(a)},i.updateLabelPositions=function(e){const t=this.view.renderCoordsHelper;this._forEachGraphic(e,((r,i,o)=>{const a=this._graphicsCore.getGraphics3DGraphicById(i.uid);null!=a&&this._updateLabelGeometry(e.featureIds[r])&&a.alignWithAbsoluteElevation(o.z??0,t,!1)}))},i.setNodeMetaAttributes=function(e,t){const r=new Array;this._forEachGraphic(e,((i,o)=>{const a=t(i,e);s.equalsShallow(o.attributes,a)||(o.attributes=a,r.push(o.uid))})),this._graphicsCore.updateLabelingInfo(r)},i.applyFilterChange=function(e){this._forEachFeature(e,((t,r,i)=>{if(!this._enabledForFeatureInNode(e,t)){const i=e.featureIds[t];switch(this._removeFeature(r,e,t)){case F.REMOVED:this.loadedGraphics.removeManyByObjectId([i]);break;case F.MODIFIED:this._updateLabelPosition(i)}return}const o=r.graphic,a=o.visible;a!==i&&(o.visible=i,O.graphic=o,O.property="visible",O.oldValue=a,O.newValue=i,this._graphicsCore.graphicUpdateHandler(O))}))},i.removeNodeMeta=function(e){const t=[];this._forEachGraphic(e,(r=>{const i=e.featureIds[r],o=this._featuresMap.get(i);if(!o)return;switch(this._removeFeature(o,e,r)){case F.MODIFIED:this._updateLabelPosition(i);break;case F.REMOVED:t.push(i)}})),this.loadedGraphics.removeManyByObjectId(t)},i._removeFeature=function(e,t,r){const i=e.components.length;return o.filterInPlace(e.components,(e=>!(e.meta===t&&e.index===r))),0===e.components.length?(this._featuresMap.delete(t.featureIds[r]),F.REMOVED):i!==e.components.length?F.MODIFIED:F.UNMODIFIED},i.getRenderingInfo=function(){return this._renderingInfo},i.notifyGraphicGeometryChanged=function(){},i.notifyGraphicVisibilityChanged=function(){},i._updateLabelPosition=function(e){const t=this._featuresMap.get(e);t&&this._updateLabelGeometry(e)&&(this.loadedGraphics.removeManyByObjectId([e]),this.loadedGraphics.addMany([t.graphic]))},i._updateLabelGeometry=function(e){const t=this._featuresMap.get(e);if(!t)return!1;const r=t.geometry,i=this.view.spatialReference,o=this.view.renderCoordsHelper,a=r.x,s=r.y,c=r.z??0,l=t.components.length,p=g.newDoubleArray(l*E.BOUNDING_BOX_CORNERS_POINTS_STRIDE);let h=0;for(const{meta:n,index:d}of t.components)E.boundingBoxCornerPoints(d,this.collection,n.objectHandle,p,h),h+=E.BOUNDING_BOX_CORNERS_POINTS_STRIDE;return f.projectBuffer(p,o.spatialReference,0,p,i,0,p.length/3),_.set(N,_.NEGATIVE_INFINITY),_.expandWithBuffer(N,p),r.x=(N[0]+N[3])/2,r.y=(N[1]+N[4])/2,r.z=N[5],!n.floatEqualUlp(r.x,a)||!n.floatEqualUlp(r.y,s)||!n.floatEqualUlp(r.z,c)},i._forEachGraphic=function(e,t){this._forEachFeature(e,((r,{graphic:i,geometry:o},a)=>{this._enabledForFeatureInNode(e,r)&&t(r,i,o,a)}))},i._forEachFeature=function(e,t){let r=0;for(let i=0;i<e.featureIds.length;i++){const o=this._featuresMap.get(e.featureIds[i]);let a=null==e.filteredIds;e.filteredIds&&e.filteredIds[r]===e.featureIds[i]&&(a=!0,r++),o&&t(i,o,a)}},i._enabledForFeatureInNode=function(e,t){return e.node.index<0||!this.overrides?.featureHasGeometryChanges(e.featureIds[t])},e._createClass(r,[{key:"updating",get:function(){return this._graphicsCore?.updating??!1}},{key:"updatePolicy",get:function(){return this._graphicsCore.effectiveUpdatePolicy}},{key:"usedMemory",get:function(){return this._graphicsCore.usedMemory}},{key:"unloadedMemoryEstimate",get:function(){return this._graphicsCore.unprocessedMemoryEstimate}},{key:"test",get:function(){return{graphicsCore:this._graphicsCore}}}]),r}(i);t.__decorate([h.property()],w.prototype,"view",void 0),t.__decorate([h.property()],w.prototype,"layer",void 0),t.__decorate([h.property()],w.prototype,"collection",void 0),t.__decorate([h.property()],w.prototype,"loadedGraphics",void 0),t.__decorate([h.property()],w.prototype,"overrides",void 0),t.__decorate([h.property()],w.prototype,"updating",null),t.__decorate([h.property()],w.prototype,"slicePlaneEnabled",void 0),t.__decorate([h.property()],w.prototype,"_graphicsCore",void 0),w=t.__decorate([u.subclass("esri.views.3d.layers.I3SMeshViewLabeler")],w);const O={graphic:null,property:null,oldValue:null,newValue:null};var F;!function(e){e[e.UNMODIFIED=0]="UNMODIFIED",e[e.MODIFIED=1]="MODIFIED",e[e.REMOVED=2]="REMOVED"}(F||(F={}));const N=_.create();return w}));
