/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/has","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../2d/engine/vectorTiles/SchemaHelper","../../2d/engine/vectorTiles/TileHandler3D","../../2d/engine/vectorTiles/VTLPainter3D","../../2d/engine/vectorTiles/style/StyleRepository","./LayerView3D","./TiledLayerView3D","../terrain/terrainUtils","../../layers/LayerView"],(function(e,t,i,l,r,a,s,n,o,c,h,d,p,y,m,u,f,_,g){"use strict";let v=function(t){function n(){var e;return(e=t.apply(this,arguments)||this)._tileHandlerController=null,e.type="vector-tile-3d",e.levelShift=l("disable-feature:vtl-level-shift")?0:1,e.contentZoom=l("disable-feature:vtl-level-shift")?1:1.5,e}e._inherits(n,t);var o=n.prototype;return o.initialize=function(){if(null==this.layer.fullExtent)return void this.addResolvingPromise(Promise.reject(new i("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:e,spatialReference:t,state:l,viewingMode:r}=this.view,n="local"===r&&!_.vtlAssumes256PixelSizeAsDefault(t)||_.test.force512VTL,o=this.layer.tileInfo.spatialReference.isGeographic,c=n?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,o?1:2),h=this._getTileInfoSupportError(c,this.layer.fullExtent);if(null!=h)return this.addResolvingPromise(Promise.reject(h));const u=s.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const t=e.tilingScheme,i=t.pixelSize,l=256===i?1:2,r=e.spatialReference?.isGeographic&&256===i?1:0,a=e.spatialReference?.isGeographic||256!==i?0:1;let s;if(this.schemaHelper=new d.SchemaHelper(l,r,this.levelShift+a),256===i){const e=this.layer.tileInfo.spatialReference.isGeographic;s=this.layer.tileInfo.getOrCreateCompatible(256,e?1:2)}else s=this.view.spatialReference?.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const n=this._getTileInfoCompatibilityError(s,t);if(n)throw n;this.tileInfo=s}));this._tileHandlerController=new AbortController;const f=this.view.resourceController;this._memCache=f.memoryController.newCache(`vtl-${this.layer.uid}`,(e=>{e.release()})),this.handles.add(s.watch((()=>this.view.qualitySettings.memoryLimit),(e=>this._memCache.maxSize=Math.ceil(e/10*1048576)),s.syncAndInitial));const g=new m(this.layer.currentStyleInfo.style);this._tileHandler=new p(this.layer,g,l.contentPixelRatio,this._memCache);const v=this._tileHandlerController.signal,C=S(f),w=this._tileHandler.start({signal:v,schedule:C}),H=this._tileHandler.spriteMosaic;H.then((e=>{!a.isAborted(v)&&this._tileHandler&&(this.painter=new y(e,this._tileHandler.glyphMosaic))})),w.then((()=>this._tileHandlerController=null)),this.updatingHandles.add((()=>({style:this.layer.currentStyleInfo.style,pixelRatio:this.view.state?.contentPixelRatio})),(({style:e,pixelRatio:t})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const i=new m(e),l=new p(this.layer,i,t,this._memCache),r=l.start({signal:this._tileHandlerController.signal,schedule:C}),a=l.spriteMosaic;r.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([r,a]).then((([,e])=>{const t=this._tileHandler,i=this.painter;this.painter=new y(e,l.glyphMosaic),this._tileHandler=l,this.emit("data-changed"),t.destroy(),i&&i.dispose()})))}));const R=Promise.all([u,w,H]);this.addResolvingPromise(R)},o.destroy=function(){this.painter=r.disposeMaybe(this.painter),this._tileHandlerController=r.abortMaybe(this._tileHandlerController),this._tileHandler=r.destroyMaybe(this._tileHandler),this._memCache=r.destroyMaybe(this._memCache)},o.fetchTile=async function(e,t,i,l){return this._tileHandler.getVectorTile(e,t,i,l)},e._createClass(n,[{key:"displayLevelRange",get:function(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,i=this.layer.maxScale||e[e.length-1].scale,l=this.levelRangeFromScaleRange(t,i);return this.layer.maxScale?l.maxLevel++:l.maxLevel+=this.levelShift,l}},{key:"dataScaleRange",get:function(){const e=this.tileInfo.lods;return{minScale:e[0].scale,maxScale:e[e.length-1].scale}}},{key:"dataLevelRange",get:function(){const{minScale:e,maxScale:t}=this.dataScaleRange,i=this.levelRangeFromScaleRange(e,t);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i.maxLevel+=this.levelShift,i}}]),n}(f.TiledLayerView3D(u.LayerView3D(g)));t.__decorate([n.property()],v.prototype,"layer",void 0),t.__decorate([n.property()],v.prototype,"levelShift",void 0),t.__decorate([n.property()],v.prototype,"contentZoom",void 0),t.__decorate([n.property()],v.prototype,"displayLevelRange",null),t.__decorate([n.property()],v.prototype,"tileInfo",void 0),t.__decorate([n.property()],v.prototype,"dataScaleRange",null),t.__decorate([n.property()],v.prototype,"dataLevelRange",null),t.__decorate([n.property()],v.prototype,"updatingProgressValue",void 0),v=t.__decorate([h.subclass("esri.views.3d.layers.VectorTileLayerView3D")],v);function S(e){return t=>e.immediate.schedule(t)}return v}));
