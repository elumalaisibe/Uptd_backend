/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/promiseUtils","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCreationContext","./Graphics3DSymbolLayerFactory","./interfaces","./Loadable","./symbolComplexity"],(function(e,t,r,s,o,n,a,i,l,y,c){"use strict";let h=function(a){function h(e,t,r){var s;return(s=a.call(this,t.schedule)||this)._symbol=e,s._context=t,s._backgroundLayers=r,s._destroyed=!1,s.symbolLayers=new Array,s.referenced=0,s._extentPadding=0,s}e._inherits(h,a);var f=h.prototype;return f.doLoad=async function(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const o=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const n=[];for(let r=0;r<o;r++){const a=t.at(r);if(!1===a.enabled)continue;u.renderPriority=1-(1+r)/o,u.renderPriorityStep=1/o,u.ignoreDrivers=a.ignoreDrivers;const l=i.make(this.symbol,a,this._context,u),y=s.onAbortOrThrow(e,(()=>{this.symbolLayers[r]=null,l.destroy()}));y&&n.push(y),this.symbolLayers[r]=l}if(await r.forEach(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),n.forEach((e=>e.remove())),s.throwIfAborted(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error},f.getSymbolLayerSize=function(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null},f.createGraphics3DGraphic=function(e,t){const r=e.graphic,s=this.symbolLayers.map((t=>t?.createGraphics3DGraphic(e)??null)),n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new o(r,t||this,s,e.layer,n)},f.globalPropertyChanged=function(e,t){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const r=this.symbolLayers[s],o=e=>{const t=e.layers[s];return t instanceof n.Graphics3DObject3DGraphicLayer?t:null};if(null!=r&&!r.globalPropertyChanged(e,t,o))return!1}return!0},f.applyRendererDiff=function(e,t){return this.loadStatus!==y.LoadStatus.LOADED?l.ApplyRendererDiffResult.RecreateSymbol:this.symbolLayers.reduce(((r,s)=>r!==l.ApplyRendererDiffResult.RecreateSymbol&&null!=s?Math.min(r,s.applyRendererDiff(e,t)):r),l.ApplyRendererDiffResult.FastUpdate)},f.prepareSymbolPatch=function(e){if(this.loadStatus===y.LoadStatus.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach(((t,s)=>{if(null==t)return;const o=r[s];if(o){const r={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const o=e.layers[s];null!=o&&r.graphics3DGraphicPatches.forEach((e=>e(o,t)))}))}}))},f.updateGeometry=function(e,t){return this._updateGeometryOrTransform(e,((e,r)=>e.updateGeometry(r,t)))},f.updateTransform=function(e,t,r,s){return this._updateGeometryOrTransform(e,((e,o)=>e.updateTransform(o,t,r,s)))},f._updateGeometryOrTransform=function(e,t){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(null==s)continue;const o=e.layers[r];if(!o||!t(s,o))return!1}return!0},f.onRemoveGraphic=function(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(null==r)continue;const s=e.layers[t];null!=s&&r.onRemoveGraphic(s)}},f.getFastUpdateStatus=function(){let e=0,t=0,r=0;return this.symbolLayers.forEach((s=>{null!=s&&(s.loadStatus===y.LoadStatus.LOADING?e++:s.isFastUpdatesEnabled()?r++:t++)})),{loading:e,slow:t,fast:r}},f.queryForSnapping=async function(e,r,o,n){const a=this.symbolLayers.filter(t.isSome).filter((e=>null!=e.queryForSnapping)).map((t=>t.queryForSnapping(e,r,o,n))),i=await Promise.all(a);return s.throwIfAborted(n),i.flat()},f.destroy=function(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{e._get(e._getPrototypeOf(h.prototype),"destroy",this).call(this);for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}},e._createClass(h,[{key:"symbol",get:function(){return this._symbol},set:function(e){this._symbol=e,e.symbolLayers.forEach(((t,r)=>{const s=this.symbolLayers[r];null!=s&&(s.symbol=e,s.symbolLayer=t)}))}},{key:"extentPadding",get:function(){return this._extentPadding}},{key:"symbologySnappingSupported",get:function(){return this.symbolLayers.some((e=>null!=e&&e.queryForSnapping))}},{key:"complexity",get:function(){return c.totalSymbolComplexities(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}},{key:"destroyed",get:function(){return this._destroyed}}]),h}(y.Loadable);const u=new a.Graphics3DSymbolLayerCreationContext;return h}));
