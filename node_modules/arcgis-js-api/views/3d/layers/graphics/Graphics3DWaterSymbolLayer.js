/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec4","../../../../chunks/common","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/DoubleArray","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./polygonUtils","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],(function(e,t,r,n,o,i,a,s,l,c,u,h,d,p,y,g,m,f,_,v,b,x,C,D){"use strict";const S=["polyline","polygon","extent"];let A=function(e){function f(t,r,n,o){return e.call(this,t,r,n,o)||this}t._inherits(f,e);var A=f.prototype;return A.doLoad=async function(){},A.destroy=function(){t._get(t._getPrototypeOf(f.prototype),"destroy",this).call(this),this._context.stage.remove(this._material),this._material=null},A.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,S,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new y.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)},A.ensureMaterial=function(){if(null!=this._material)return;const e=new C.WaterMaterialParameters,t=this.symbolLayer.color;null!=t&&(e.color=r.toUnitRGBA(t));const n=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],n],e.transparent=n<1||this.needsDrivenTransparentPass,e.waveDirection=null!=this.symbolLayer.waveDirection?f.headingVectorFromAngle(this.symbolLayer.waveDirection):a.fromValues(0,0);const o=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,i=D.wavePresets[o];e.waveStrength=i.waveStrength,e.waveTextureRepeat=i.textureRepeat,e.waveVelocity=i.waveVelocity,e.flowStrength=i.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new C.WaterMaterial(e),this._context.stage.add(this._material)},A.layerOpacityChanged=function(){if(null==this._material)return;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:r})},A.layerElevationInfoChanged=function(e,t,r){const n=this._elevationContext.mode,o=p.elevationModeChangeUpdateType(f.elevationModeChangeTypes,r,n);if(o!==p.SymbolUpdateType.UPDATE)return o;const i=p.needsElevationUpdates2D(n);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>i))},A.slicePlaneEnabledChanged=function(){return null!=this._material&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0},A.physicalBasedRenderingChanged=function(){return!0},A._createAs3DShape=function(e,t,r){const n=_.geometryAsPolygon(e.geometry);if(null==n)return null;const o=v.geometryToRenderInfo(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),i=o.position.length/3,a=h.newDoubleArray(2*i);this._createUVCoordsFromVertices(a,o.mapPositions,i,this._context.elevationProvider.spatialReference);const s=new O(o,a,this._context.layer.uid,e.uid);if(s.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(s),this._create3DShapeGeometries(s),this._logGeometryCreationWarnings(s.renderData,n.rings,"rings","WaterSymbol3DLayer"),0===s.outGeometries.length)return null;const l=new b.Object3D({geometries:s.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:r}),c=new m.Graphics3DObject3DGraphicLayer(this,l,s.outGeometries,null,null,d.perVertexElevationAligner,t);return c.alignedSampledElevation=s.renderData.sampledElevation,c.needsElevationUpdates=p.needsElevationUpdates2D(t.mode),c},A._createUVCoordsFromVertices=function(e,t,r,o){const a=n.getMetersPerUnitForSR(o);u.empty(w);for(let n=0;n<r;n++)i.set(P,t[3*n],t[3*n+1]),u.expandPointInPlace(w,P);s.scale(w,w,a);const l=w[0]%f.unitSizeOfTexture,c=w[1]%f.unitSizeOfTexture;G[0]=w[0]-l,G[1]=w[1]-c;for(let n=0;n<r;n++)e[2*n]=(t[3*n]*a-G[0])/f.unitSizeOfTexture,e[2*n+1]=(t[3*n+1]*a-G[1])/f.unitSizeOfTexture},A._create3DShapeGeometries=function(e){const t=e.renderData.polygons,r=e.uvCoords;for(const{count:n,index:i,position:a,mapPositions:s,holeIndices:l}of t){if(null!=this._context.clippingExtent&&(c.empty(E),c.expandWithBuffer(E,s),!c.intersectsClippingArea(E,this._context.clippingExtent)))continue;const t=o.earcut(s,l,3);if(0===t.length)continue;const u=h.doubleSubArray(r,2*i,2*n),d=_.createWaterGeometry({material:this._material,indices:t,mapPositions:s,attributeData:{position:a,uv0:u}},e.objectAndLayerIdColor);e.outGeometries.push(d)}},A._createAsOverlay=function(e){const t=_.geometryAsPolygon(e.geometry);if(null==t)return null;this._material.renderPriority=this._renderPriority;const r=v.geometryToRenderInfoDraped(t,this._context.overlaySR),n=r.position.length/3,o=h.newDoubleArray(2*n);this._createUVCoordsFromVertices(o,r.position,n,this._context.overlaySR);const i=new T(r,o,this._context.layer.uid,e.uid);return i.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(i),i.outBoundingBox=c.empty(),this._createAsOverlayWater(i),this._logGeometryCreationWarnings(i.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===i.outGeometries.length?null:new g(this,i.outGeometries,i.outBoundingBox,this._context.drapeSourceRenderer)},A._createAsOverlayWater=function(e){const t=e.uvCoords,r=e.renderData.polygons;for(const{position:n,holeIndices:i,index:a,count:s}of r){if(c.empty(E),c.expandWithBuffer(E,n),!c.intersectsClippingArea(E,this._context.clippingExtent))continue;c.expandWithAABB(e.outBoundingBox,E);const r=o.earcut(n,i,3);if(0===r.length)continue;const l=h.doubleSubArray(t,2*a,2*s),u=_.createWaterGeometry({material:this._material,indices:r,attributeData:{position:n,uv0:l}},e.objectAndLayerIdColor);e.outGeometries.push(new x.RenderGeometry(u,e))}},f.headingVectorFromAngle=function(e){const t=a.create(),r=l.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},A.test=function(){return{...t._get(t._getPrototypeOf(f.prototype),"test",this).call(this),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}},t._createClass(f)}(f.Graphics3DSymbolLayer);A.unitSizeOfTexture=100,A.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.RECREATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE};const G=a.create(),w=u.create(),P=a.create(),E=c.create();let O=function(e){function r(t,r,n,o){var i;return(i=e.call(this,t,n,o)||this).uvCoords=r,i}return t._inherits(r,e),t._createClass(r)}(_.PolygonCreationDataBase),T=function(e){function r(t,r,n,o){var i;return(i=e.call(this,t,n,o)||this).uvCoords=r,i}return t._inherits(r,e),t._createClass(r)}(_.PolygonCreationDataBase);e.Graphics3DWaterSymbolLayer=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
