/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Handles","../../../../core/MapUtils","../../../../core/reactiveUtils","../../../../core/Logger","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/boundedPlane","./Deconflictor","./enums","./LabelDeconflictor","../../../support/Scheduler"],(function(e,t,i,s,n,a,r,c,o,l,h,u,p,d,f,_,y){"use strict";function g(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function b(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(f.VisibilityGroup.GRAPHIC,f.VisibilityFlag.DECONFLICTION,!0)))}e.GraphicsDeconflictor=function(e){function i(){var t;return(t=e.apply(this,arguments)||this)._handles=new s,t._contexts=new Map,t._viewState=new d.DeconflictorViewState,t.visibilityGroup=f.VisibilityGroup.GRAPHIC,t._iconMarginFactor=-.1,t}t._inherits(i,e);var r=i.prototype;return r.initialize=function(){this._handles.add([a.watch((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),a.watch((()=>this.view?.map?.ground?.opacity),((e,t)=>{1!==e&&1!==t||this.setDirty()})),a.watch((()=>this.view?.slicePlane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),a.initial)]),this._frameTask=this.view.resourceController.scheduler.registerTask(y.TaskPriority.GRAPHICS_DECONFLICTOR,this),this._labels=new _.LabelDeconflictor({view:this.view,parent:this})},r.destroy=function(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)},r.setDirty=function(){this._contexts.size>0&&(t._get(t._getPrototypeOf(i.prototype),"setDirty",this).call(this),this._labels.setDirty())},r.runTask=function(e){t._get(t._getPrototypeOf(i.prototype),"runTask",this).call(this,e),this.running||this._labels.setDirty()},r.setInitialIconVisibilityFlag=function(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&g(e));t.setVisibilityFlag(f.VisibilityGroup.GRAPHIC,f.VisibilityFlag.DECONFLICTION,i)},r._updateViewState=function(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())},r._updateSlicePlane=function(){const e=this.view?this.view.slicePlane:null;null!=e&&p.transform(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e},r._slicePlaneChanged=function(){n.someMap(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()},r.addGraphicsOwner=function(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic)))}},r.removeGraphicsOwner=function(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())},r._addGraphic=function(e,t,i){const s=i.graphic.uid,n=new d.DeconflictorGraphic(i,e.symbolCreationContext.slicePlaneEnabled);t.set(s,n),g(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&this._labels.addToActiveGraphics(n)},r._removeGraphic=function(e,t){const i=t.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(i),this.setDirty())},r.enabledChanged=function(e,t){const i=g(e);i||b(e),this.modifyGraphics(t,i)},r._slicePlaneEnabledChanged=function(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()},r.getGraphicsLayers=function(e){return e.layers},r._graphicSupportsDeconfliction=function(e){if(e.isDraped)return!1;const t=e.layers;if(!t||!t.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1},r._getGraphicsContext=function(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i},t._createClass(i,[{key:"labels",get:function(){return this._labels}},{key:"viewState",get:function(){return this._viewState}},{key:"iconMarginFactor",get:function(){return this._iconMarginFactor},set:function(e){this._iconMarginFactor=e,this.setDirty()}}]),i}(d.Deconflictor),e.GraphicsDeconflictor=i.__decorate([u.subclass("esri.views.3d.layers.graphics.GraphicsDeconflictor")],e.GraphicsDeconflictor),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
