/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/byteSizeEstimations","../../../../core/ObjectPool","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/Polygon","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./enums","./featureExpressionInfoUtils"],(function(e,i,t,r,s,n,a,o,l,c,h,u,y,p,b,d,f,g){"use strict";const m=new s(Array,(e=>u.set(e,u.ZERO)),null,10,5),_=y.create();return function(){function s(e,i,t,r,s){this.graphic=e,this.graphics3DSymbol=i,this.layers=t,this._visibleFlags=f.VisibilityFlag.ALL_LABEL,this.deconflictionPriority=0,++i.referenced,this._featureExpressionFeature=s?g.createFeature(s,e,r):null}var L=s.prototype;return L.initialize=function(e){this._layer=e,this._forEachSymbolLayerGraphic((i=>{i.initialize(e),i.setVisibility(this.isVisible())}))},L.destroy=function(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},L.clearLabelGraphics=function(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers=null},L.addLabelGraphic=function(e,i){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(i),e.setVisibility(this.isVisible(f.VisibilityGroup.LABEL))},L.setCalloutGraphic=function(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))},L.isVisible=function(e=f.VisibilityGroup.GRAPHIC,i){const t=i?this._visibleFlags|i|f.VisibilityGroup.LABEL*i:this._visibleFlags;return e===f.VisibilityGroup.GRAPHIC?(t&f.VisibilityFlag.ALL_GRAPHIC)===f.VisibilityFlag.ALL_GRAPHIC:(t&f.VisibilityFlag.ALL_LABEL)===f.VisibilityFlag.ALL_LABEL},L.setVisibilityFlag=function(e,i,t){const r=this.isVisible(e);t?this._visibleFlags|=e*i:this._visibleFlags&=~(e*i);const s=this.isVisible(e);if(r===s)return!1;if(e===f.VisibilityGroup.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(s)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(f.VisibilityGroup.LABEL);this._forEachLabelGraphic((i=>i.setVisibility(e)))}return!0},L.getVisibilityFlag=function(e,i){return 0!=(this._visibleFlags&e*i)},L.computeExtent=function(e){if(!this._extent){const i=this.graphic.geometry;if(null==i)return!1;this._extent=y.create(),b.computeAABR(i,this._extent);const t=i.spatialReference;if(!p.equals(t,e)&&!h.projectBoundingRect(this._extent,t,this._extent,e))return this._extent=null,!1}return!0},L.getAsOptimizedGeometry=function(e,i){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i)),this._optimizedGeometry},L._convertGraphicToOptimizedGeometry=function(e,i,t){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=c.fromExtent("mesh"===r.type?r.extent:r)),d.convertFromGeometry(r,i,t)},L.computeAttachmentOrigin=function(){const e={render:{origin:l.create(),num:0},draped:{origin:a.create(),num:0}};for(const i of this.layers)null!=i&&i.computeAttachmentOrigin(e);return e.render.num>1&&o.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&n.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e},L.getProjectedBoundingBox=async function(e,i,r,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?u.empty(n.boundingBox):n.boundingBox=u.empty(),n.requiresDrapedElevation=!1,await t.forEach(this.layers,(async t=>{if(null==t)return;const a="draped"===t.type?i:e,o=m.acquire(),l=await t.getProjectedBoundingBox(a,r,n.screenSpaceObjects,s,o);isFinite(l[2])&&isFinite(l[5])||(n.requiresDrapedElevation=!0),l&&u.expandWithAABB(n.boundingBox,o),m.release(o)})),u.allFinite(n.boundingBox)||y.allFinite(u.toRect(n.boundingBox,_))?n:null},L.needsElevationUpdates=function(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some((e=>e?.needsElevationUpdates??!1))??!1},L.alignWithElevation=function(e,i,t){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,i,this._featureExpressionFeature,t)}))},L.alignWithAbsoluteElevation=function(e,i,t){this._forEachRenderedGraphic((r=>{"object3d"===r.type&&r.alignWithAbsoluteElevation(e,i,t)}))},L.addObjectStateSet=function(e,i){this._forEachSymbolLayerGraphic((t=>t.addObjectState(e,i)))},L.removeObjectState=function(e){this._forEachSymbolLayerGraphic((i=>i.removeObjectState(e)))},L._forEachGraphicList=function(e,i){e?.forEach((e=>e&&i(e)))},L._forEachSymbolLayerGraphic=function(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)},L._forEachLabelGraphic=function(e){this._forEachGraphicList(this._labelLayers,e)},L._forEachRenderedGraphic=function(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)},e._createClass(s,[{key:"labelLayers",get:function(){return this._labelLayers||i.EmptyArray}},{key:"extent",get:function(){return this._extent}},{key:"isElevationSource",get:function(){return this.layers.some((e=>e?.isElevationSource))}},{key:"destroyed",get:function(){return null==this.layers}},{key:"calloutLayer",get:function(){return this._calloutLayer}},{key:"isDraped",get:function(){let e=!1;return this._forEachSymbolLayerGraphic((i=>{"draped"===i.type&&(e=!0)})),e}},{key:"usedMemory",get:function(){let e=r.estimateAttributesObjectSize(this.graphic.attributes);return this._forEachSymbolLayerGraphic((i=>{const t=i.graphics3DSymbolLayer.complexity;if(null==t)return;const r="draped"===i.type?t.memory.draped:t.memory;e+=r.bytesPerFeature,r.bytesPerCoordinate&&(e+=b.numVertices(this.graphic.geometry)*r.bytesPerCoordinate)})),e}},{key:"test",get:function(){const e=this;return{addLabelLayer:i=>{e._labelLayers||(e._labelLayers=new Array),e._labelLayers.push(i)}}}}]),s}()}));
