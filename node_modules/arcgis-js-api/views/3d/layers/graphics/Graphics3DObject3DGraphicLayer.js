/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../chunks/sphere","./elevationAlignmentUtils","./featureExpressionInfoUtils","./graphicUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/edgeRendering/interfaces"],(function(e,t,i,s,a,n,r,o,c,l,h){"use strict";let g=t._createClass((function(e,t,i){this.baseMaterial=e,this.edgeMaterials=t,this.properties=i})),d=function(){function e(e,t,i,s,a,n,r,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=s,this._sharedResource=a,this.elevationAligner=n,this.elevationContext=r,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}var h=e.prototype;return h.initialize=function(e){this._stageLayer=e;const t=e.stage;t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)},h.destroy=function(){if(!this._stageLayer)return;const e=this._stageLayer.stage;e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=e.renderer.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),null!=this._sharedResource&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null},h.layerOpacityChanged=function(e,t){if(null==this._edgeState)return;const i=u(this._edgeState.baseMaterial);let s=!1;for(const a of this._edgeState.edgeMaterials)a.objectTransparency!==i&&(a.objectTransparency=i,s=!0);s&&this.resetEdgeObject(t);this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])},h.slicePlaneEnabledChanged=function(e,t){if(null==this._edgeState)return;this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!t),this._edgeState.properties.hasSlicePlane=e},h.setVisibility=function(e){if(null!=this._stageLayer&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),this._edgeState)){const t=this._stageLayer.stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}},h.alignWithElevation=function(e,t,i,s){if(null==this.elevationAligner)return;null!=i&&o.setContextFeature(this.elevationContext.featureExpressionInfoContext,i);const a=(i,s)=>r.evaluateElevationInfoAtPoint(i,e,this.elevationContext,t,s);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,a,t),this.resetEdgeObject(s)},h.alignWithAbsoluteElevation=function(e,t,i){const s=(t,i)=>{i.sampledElevation=e,i.verticalDistanceToGround=0,i.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,s,t),this.resetEdgeObject(i)},h.getCenterObjectSpace=function(e=s.create()){return i.copy(e,n.getCenter(this.stageObject.boundingVolumeObjectSpace.bounds))},h.getBoundingBoxObjectSpace=function(e=a.create()){const t=this.stageObject.boundingVolumeObjectSpace;return a.setMin(e,t.min),a.setMax(e,t.max),e},h.computeAttachmentOrigin=function(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.shaderTransformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else for(const t of this.stageObject.geometries)t.computeAttachmentOrigin(j)&&(i.transformMat4(j,j,this.stageObject.shaderTransformation),i.add(e.render.origin,e.render.origin,j),e.render.num++)},h.getProjectedBoundingBox=async function(e,t,s,n,r){const o=this.getBoundingBoxObjectSpace(r),l=f,h=a.isPoint(o)?1:l.length;for(let a=0;a<h;a++){const e=l[a];O[0]=o[e[0]],O[1]=o[e[1]],O[2]=o[e[2]],i.transformMat4(O,O,this.stageObject.transformation),b[3*a]=O[0],b[3*a+1]=O[1],b[3*a+2]=O[2]}if(!e(b,0,h))return null;a.empty(o);let g=null;this.calculateRelativeScreenBounds&&(g=this.calculateRelativeScreenBounds());for(let i=0;i<3*h;i+=3){for(let e=0;e<3;e++)o[e]=Math.min(o[e],b[i+e]),o[e+3]=Math.max(o[e+3],b[i+e]);g&&s.push({location:b.slice(i,i+3),screenSpaceBoundingRect:g})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){a.center(o,j);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=t.service.getElevation(j[0],j[1],e)??0;else try{const s=c.demResolutionForBoundingBox(o,t.service.spatialReference,t);i=await t.service.queryElevation(j[0],j[1],n,s,e)??0}catch(d){}a.offset(o,0,0,-this.alignedSampledElevation+i)}return o},h.addObjectState=function(e,t){e===l.Object3DState.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===l.Object3DState.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())},h.removeObjectState=function(e){e.removeObject(this.stageObject)},h.resetEdgeObject=function(e){if(null==this._edgeState)return;const t=this._stageLayer.stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)},h._addOrUpdateEdgeObject=function(e,t){const i=this._edgeState;if(null==i)return;const s=u(i.baseMaterial);for(const a of i.edgeMaterials)a.objectTransparency=s;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t).then((()=>this._stageLayer?.sync()))},t._createClass(e,[{key:"isElevationSource",get:function(){return!!this.stageObject.lastValidElevationBB}},{key:"visible",get:function(){return this._visible}}]),e}();function u(e){return e.isVisible()?e.parameters.transparent?h.Transparency.TRANSPARENT:h.Transparency.OPAQUE:h.Transparency.INVISIBLE}const b=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],O=s.create(),j=s.create(),f=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];e.Graphics3DObject3DGraphicLayer=d,e.Object3DEdgeState=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
