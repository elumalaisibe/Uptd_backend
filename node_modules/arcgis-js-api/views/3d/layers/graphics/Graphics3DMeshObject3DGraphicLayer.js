/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Logger","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","./ElevationAligners","./elevationAlignmentUtils","./featureExpressionInfoUtils","./Graphics3DObject3DGraphicLayer"],(function(t,e,a,r,s,i,n,o,l,m,c,f){"use strict";r.getLogger("esri.views.3d.layers.graphics.Graphics3DMeshObject3DGraphicLayer");let h=function(t){function a(){var e;return(e=t.apply(this,arguments)||this)._originalGeometries=[],e._fastTransformUpdatesEnabled=!1,e}e._inherits(a,t);var r=a.prototype;return r.enableFastTransformUpdates=function(t,e){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:a}=this,r=a.geometries.slice();a.removeAllGeometries();const i=s.getTranslation(g,a.transformation),n=e.getOrigin(i);for(const s of r){const e=t(s.material),r=s.instantiate({material:e});r.localOrigin=n,a.addGeometry(r)}this._originalGeometries=r},r.disableFastTransformUpdates=function(t){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:e}=this,a=e.geometries.map((e=>t(e.material)));e.removeAllGeometries();for(let r=0;r<this._originalGeometries.length;r++){const t=this._originalGeometries[r],s=a[r];s.setParameters({modelTransformation:null}),s===t.material?e.addGeometry(t):e.addGeometry(t.instantiate({material:s}))}this._originalGeometries.length=0},r.updateFastLocalOrigin=function(t,e,a){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:r}=this;if(0===r.geometries.length)return;const n=r.geometries[0].localOrigin,o=s.getTranslation(g,t),l=a.getOrigin(o);if(l===n)return;const m=e?.localMatrix??i.IDENTITY;r.clearShaderTransformation(),r.transformation=t,r.geometries.forEach((t=>{t.transformation=m,t.localOrigin=l}))},r.updateTransform=function(t,e,a){const{stageObject:r}=this,n=e?.localMatrix??i.IDENTITY;if(!this._fastTransformUpdatesEnabled)return r.clearShaderTransformation(),r.transformation=t,r.geometries.forEach((t=>{t.transformation=n})),void this.resetEdgeObject(a);const o=r.transformation,l=r.geometries[0].transformation,m=t,c=n,f=s.multiply(d,o,l),h=s.multiply(p,m,c);r.shaderTransformation=m,this._setFastMaterialTransformation({matA:f,matB:h});const g=()=>c;for(const s of r.geometries)s.shaderTransformer=g;this.resetEdgeObject(a)},r.alignWithElevation=function(t,r,i,n){if(!this._fastTransformUpdatesEnabled)return void e._get(e._getPrototypeOf(a.prototype),"alignWithElevation",this).call(this,t,r,i,n);null!=i&&c.setContextFeature(this.elevationContext.featureExpressionInfoContext,i);const o=(e,a)=>m.evaluateElevationInfoAtPoint(e,t,this.elevationContext,r,a),{stageObject:f}=this;if(!f.geometries[0].material.parameters.modelTransformation)return;const h=f.transformation,g=f.geometries[0].transformation,T=s.multiply(d,h,g),b=s.copy(u,f.shaderTransformation);this.alignedSampledElevation=l.perObjectElevationAligner(this,this.elevationContext,t.spatialReference,o,r,b),f.shaderTransformation=b;const E=f.geometries[0].shaderTransformation,v=s.multiply(p,b,E);this._setFastMaterialTransformation({matA:T,matB:v}),this.resetEdgeObject(n)},r._setFastMaterialTransformation=function({matA:t,matB:e}){const{stageObject:a}=this;if(0===a.geometries.length)return;const r=a.geometries[0].localOrigin,i=s.fromTranslation(E,n.scale(g,r.vec3,-1)),o=s.multiply(T,i,t),l=s.multiply(b,i,e),m=s.invert(T,o),c=s.multiply(b,l,m);for(const s of a.geometries)s.material.setParameters({modelTransformation:c})},e._createClass(a,[{key:"fastTransformUpdatesEnabled",get:function(){return this._fastTransformUpdatesEnabled}}]),a}(f.Graphics3DObject3DGraphicLayer);const g=o.create(),d=i.create(),p=i.create(),u=i.create(),T=i.create(),b=i.create(),E=i.create();t.Graphics3DMeshObject3DGraphicLayer=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
