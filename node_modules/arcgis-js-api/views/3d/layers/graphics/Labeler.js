/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../symbols/callouts/calloutUtils","./CreateLabelParameters","./enums","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DLineCalloutSymbolLayer","./graphicSymbolUtils","./labelPlacement","./placementUtils","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/WebGLLayer","../../../support/Scheduler"],(function(e,t,i,l,s,a,r,n,o,c,h,b,u,d,y,p,g,f,_,C,x,m,L,v,T,A,w,G,D,I,R,P){"use strict";let S=t._createClass((function(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array})),E=t._createClass((function(e,t,i,l,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=l,this.labelFunction=s,this.calloutSymbolLayerIndex=0})),O=function(){function e(e,t,i,l,s,a,r,n){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=l,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=a,this.disablePlacement=r,this.active=n,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new R.WebGLLayer(e,{pickable:!0,disableOctree:!0},t.uid)}return e.prototype.destroy=function(){this.stageLayer.destroy()},t._createClass(e)}();function V(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function F(e){return e.labelClassContexts&&e.labelClassContexts.length}function M(e){return null===e.labelClassContexts}function z(e){return!0===e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}e.Labeler=function(e){function i(t){var i;return(i=e.call(this,t)||this)._dirty=!1,i._labels=new Map,i._labelsToAdd=new Map,i._labelsToRemove=new Map,i._labelingContexts=new Array,i}t._inherits(i,e);var l=i.prototype;return l.setup=function(){this.dispose(),this._handles=new a,this._handles.add([h.watch((()=>this.view.state?.camera),(()=>this.setDirty())),h.watch((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(P.TaskPriority.LABELER,this)]),this._textTextureAtlas=new I.TextTextureAtlas({view:this.view}),this._hudMaterialCollection=new w.MaterialCollection(this.view._stage),this._calloutMaterialCollection=new w.MaterialCollection(this.view._stage)},l.dispose=function(){this._handles=o.destroyMaybe(this._handles),this._textTextureAtlas=o.disposeMaybe(this._textTextureAtlas),this._hudMaterialCollection=o.disposeMaybe(this._hudMaterialCollection),this._calloutMaterialCollection=o.disposeMaybe(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()},l.destroy=function(){this.dispose(),k.graphic=null,k.renderingInfo=null,k.layer=null},l._activateLabelingContext=function(e){e.graphics.forEach(((t,i)=>{const l=new S(e,t);this._labels.set(i,l),e.labelsToInitialize.set(i,l),t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.USER,!0)})),e.active=!0},l._deactivateLabelingContext=function(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.USER,!1),this.setLabelGraphicVisibility(e,!1),this._labels.delete(t)})),e.active=!1},l._addLabelTextureToAtlas=function(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0},l._removeLabelTextureFromAtlas=function(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];null!=i&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1},l.runTask=function(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),P.Task.YIELD},l._updateLabels=function(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(!F(t)){if(M(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),V(t)){this._dirty=!0;continue}if(!F(t))continue}n.someMap(t.labelsToInitialize,((i,l)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(l,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(l),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}},l._createLabelClassContextAsync=async function(e){const t=e.labelClassAbortController?.signal;await(e.layer.when?.()),c.throwIfAborted(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,l=i.layer,a=l.labelingInfo&&l.labelingInfo.filter((e=>!!e.symbol));if(!a||0===a.length)return;let n=!1;await s.forEach(a,(async(l,a)=>{const o=l.symbol,h=v.getGraphics3DSymbol(i.getOrCreateGraphics3DSymbol(o));if(null==h)return void r.getLogger(this).error("Failed to create Graphics3DSymbol for label");await h.load(),c.throwIfAborted(t);let b=null;_.hasCalloutSupport(o)&&o.hasVisibleCallout()&&(b=m.make(o,i.symbolCreationContext),await b.load(),c.throwIfAborted(t));const u=await s.result(f.createLabelFunction(l,e.layer.fieldsIndex,this.view.spatialReference));if(c.throwIfAborted(t),!0===u.ok){const i=await this._createTextRenderParameters(h.symbol);c.throwIfAborted(t),e.labelClassContexts[a]=new E(l,h,b,i,u.value)}else r.getLogger(this).error(`Label expression failed to evaluate: ${u.error}`),n=!0})),c.throwIfAborted(t)},l._createLabelClassContext=async function(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(c.isAbortError(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise},l._createTextRenderParameters=async function(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:D.TextRenderParameters.fromSymbol(t,this.view.state.rasterPixelRatio)},l._destroyLabelClassContext=function(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,o.abortMaybe(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")},l._createTextSymbolGraphic=function(e,t,i,l,s){const a=new C.CreateLabelParameters(i.verticalOffset,A.horizontalPlacementFromAnchor(i.anchor),A.verticalPlacementFromAnchor(i.anchor),e.text,i.translation,i.elevationOffset,i.centerOffset,i.screenOffset,i.centerOffsetUnits,e.displayWidth,e.displayHeight);return k.graphic=t,k.renderingInfo=null,k.layer=l,s.createLabel(k,a,this._hudMaterialCollection,this._textTextureAtlas)},l._createLineCalloutGraphic=function(e,t,i,l,s){return k.graphic=e,k.layer=s,k.renderingInfo=new L.LineCalloutSymbolLayerRenderingInfo(null,t,l.translation,l.centerOffset,l.screenOffset,l.centerOffsetUnits,l.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(k)},l._ensureGraphics3DResources=function(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,l=i.labelClassContexts;if(!l||0===l.length||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let s=!1;const a=t.graphic,r=i.layer,n=z(i.layer);for(let o=0;o<l.length;o++){const c=e.textRenderers[o],h=e.textLabelPlacements[o];if(null==c||null==h)continue;const b=l[o],u=b.graphics3DSymbol,d=u.symbol&&"label-3d"===u.symbol.type?u.symbol:null,y=u.symbolLayers[0];if(!y)continue;y.setElevationInfoOverride(i.elevationInfoOverride);const p=this._createTextSymbolGraphic(c,a,h,r,y);if(null==p)return!1;p._labelClass=b.labelClass,p._labelIndex=o,t.addLabelGraphic(p,i.stageLayer),t.deconflictionPriority=b.textRenderParameters?.definition.size??0,t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.USER,n),t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.SCALE_RANGE,!0),t.setVisibilityFlag(x.VisibilityGroup.LABEL,x.VisibilityFlag.DECONFLICTION,!1),s=!0;const g=b.graphics3DCalloutSymbolLayer;if(g&&h.hasLabelVerticalOffset){g.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(a,d,g,h,r);null!=e&&(b.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return i.scaleVisibility&&s&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},l._destroyGraphics3DResources=function(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},l._ensureTextTextureResources=function(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(!i||0===i.length)return;const l=e.graphics3DGraphic.graphic;for(let a=0;a<i.length;a++){const r=i[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,null==r?.textRenderParameters)continue;const n=r.labelFunction;let o;if("arcade"===n.type)try{const e=n.needsHydrationToEvaluate()?g.hydrateGraphic(l,t.layer):l;o=n.evaluate(e)}catch(s){o=null}else o=n.evaluate(l);if(null==o||""===o||/^\s+$/.test(o))continue;const c=r.graphics3DSymbol,h="label-3d"===c.symbol?.type?c.symbol:null;if(!c.symbolLayers[0])continue;const b=e.graphics3DGraphic,u=r.labelClass,d=t.disablePlacement,y=T.get({graphics3DGraphic:b,labelSymbol:h,labelClass:u,disablePlacement:d});if(null==y)continue;const p=A.horizontalPlacementFromAnchor(y.anchor),f=A.textRenderAlignmentFromHorizontalPlacement(p);e.textRenderers[a]=new G.TextRenderer(o,f,r.textRenderParameters),e.textLabelPlacements[a]=y}e.textInitialized=!0},l._destroyTextTextureResources=function(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0},l._addGraphic=function(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const l=new S(e,t);this._labels.set(i,l),e.labelsToInitialize.set(i,l)}this.setDirty(),this.deconflictor.setDirty()},l._removeGraphic=function(e,t){const i=t.graphic.uid,l=this._labels.get(i);e.graphics.delete(i),l&&(this._destroyGraphic(l,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())},l._destroyGraphic=function(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)},l._labelingInfoChange=async function(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}},l._globalPropertyChanged=function(e,t){for(const i of t.labelClassContexts){const l=new Map;t.graphics.forEach((e=>l.set(e.graphic.uid,e)));const s=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,l,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,l,t)}}},l._visibilityInfoChange=function(e){const t=z(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()},l._resetAllLabels=function(){for(const e of this._labelingContexts)this._resetLabels(e)},l._resetLabels=function(e){e.graphics.forEach(((t,i)=>{const l=this._labels.get(i);l&&(this._destroyGraphic(l,i),l.visible=!1,l.rendered=!1,e.labelsToInitialize.set(i,l))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()},l._findLabelingContext=function(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null},l.addGraphicsOwner=function(e,t,i){const l=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,a=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,n=new O(this.view._stage,r,e,t,l,s,a,z(r));return this._labelingContexts.push(n),this.setDirty(),{addGraphic:e=>this._addGraphic(n,e),removeGraphic:e=>this._removeGraphic(n,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>z(n.layer),labelingInfoChange:e=>this._labelingInfoChange(n,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",n),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",n),visibilityInfoChange:()=>this._visibilityInfoChange(n),reset:()=>this._resetLabels(n),clear:()=>{}}},l.removeGraphicsOwner=function(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()},l.setLabelGraphicVisibility=function(e,t){const i=e.graphic.uid,l=this._labels.get(i);l&&l.visible!==t&&(t&&!l.rendered?(this._labelsToAdd.set(i,l),this._labelsToRemove.delete(i),l.textInitialized||l.labelingContext.labelsToInitialize.set(i,l)):!t&&l.rendered&&(this._labelsToRemove.set(i,l),this._labelsToAdd.delete(i)),l.visible=t,this.setDirty())},l.setDirty=function(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))},t._createClass(i,[{key:"running",get:function(){return this.view.ready&&(this._dirty||this.deconflictor.running)}},{key:"updating",get:function(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>V(e)))}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(V(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}}]),i}(l),i.__decorate([b.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),i.__decorate([b.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),i.__decorate([b.property()],e.Labeler.prototype,"_textTextureAtlas",void 0),i.__decorate([b.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=i.__decorate([p.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const k=new L.LineCalloutCreationContext(null,null,null);e.areLabelsVisible=z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
