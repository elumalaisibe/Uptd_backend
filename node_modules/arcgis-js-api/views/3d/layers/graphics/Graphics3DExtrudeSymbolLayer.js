/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Error","../../../../core/lang","../../../../core/unitUtils","../../../../chunks/earcut","../../../../chunks/mat3","../../../../chunks/mat3f64","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray","../../../../geometry/support/Indices","../../../../chunks/vec32","../../../../layers/graphics/data/SnappingCandidate","../../../../renderers/support/renderingInfoUtils","../../../ViewingMode","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./polygonUtils","../support/edgeUtils","../../support/debugFlags","../../support/ElevationProvider","../../support/renderInfoUtils/polygon","../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/ContentObjectType","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryWithMapPositions","../../webgl-engine/lib/Normals","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,n,r,i,a,s,o,l,c,h,u,d,p,g,y,m,b,f,_,x,S,A,P,v,E,C,w,M,O,D,L,I,R,z,G,V,T,U,B,k,j){"use strict";const N=["polygon","extent"];let F=function(e){function n(t,n,r,i){var a;return(a=e.call(this,t,n,r,i)||this).ensureDrapedStatus(!1),a}t._inherits(n,e);var u=n.prototype;return u.doLoad=async function(){if(!this._drivenProperties.size){const e=E.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new r("graphics3dextrudesymbollayer:invalid-size",e)}const e=this.symbolLayer?.material?.color,t=this._getCombinedOpacityAndColor(e),n=d.fromArray(t),i=t[3],a=i<1||this.needsDrivenTransparentPass,s={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:i,transparent:a,cullFace:a?z.CullFaceOptions.None:z.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:I.NormalType.Compressed};this._material=new j.DefaultMaterial(s),this._bottomMaterial=new j.DefaultMaterial({...s,cullFace:z.CullFaceOptions.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)},u.destroy=function(){t._get(t._getPrototypeOf(n.prototype),"destroy",this).call(this),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))},u.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,N,this.symbolLayer.type))return null;const n=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new A.ElevationContext);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)},u.layerOpacityChanged=function(e,t){const n=this.symbolLayer?.material?.color,r=this._getCombinedOpacity(n),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:i}),this._bottomMaterial.setParameters({opacity:r,transparent:i});const a=this._getLayerOpacity();e.forEach((e=>{const n=t(e);null!=n&&n.layerOpacityChanged(a,this._context.isAsync)}))},u.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,S.needsElevationUpdates3D)},u.slicePlaneEnabledChanged=function(e,t){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const n=t(e);null!=n&&n.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0},u.physicalBasedRenderingChanged=function(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},u._getExtrusionSize=function(e){let t;return t=e.size&&this._drivenProperties.size?_.getDriverAxisSizeValue(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t},u.applyRendererDiff=function(e,t){return this._drivenPropertiesChanged(t)?C.ApplyRendererDiffResult.RecreateSymbol:C.ApplyRendererDiffResult.RecreateGraphics},u.queryForSnapping=async function(e,t,n,r){const s=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/a.getMetersPerVerticalUnitForSR(t),{objectId:o,target:l}=e,c=i.clone(l);switch(c.z=(c.z??0)+s,e.type){case"edge":{const{start:t,end:n}=e,r=i.clone(t),a=i.clone(n);return r.z=(r.z??0)+s,a.z=(a.z??0)+s,[f.makeEdgeCandidate(o,c,1/0,r,a)]}case"vertex":return[f.makeVertexCandidate(o,c,1/0),f.makeEdgeCandidate(o,l,1/0,l,c)];default:return[]}},u._getSymbolSize=function(){return this.symbolLayer.size??1},u._createAs3DShape=function(e,t,n,r,i){const a=w.geometryAsPolygon(e.geometry);if(null==a)return null;if(0===a.rings.length||!a.rings.some((e=>e.length>0)))return this._logGeometryValidationWarnings(a.rings,"rings","ExtrudeSymbol3DLayer"),null;const u=L.geometryToRenderInfo(a,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(u,a.rings,"rings","ExtrudeSymbol3DLayer");const f=E.computeCentroid(a);if(null==f)return null;const _=new Array,A=new Array,v=g.create(),C=h.create(),O=d.create(),D=this._context.renderCoordsHelper.viewingMode===x.ViewingMode.Global;D||this._context.renderCoordsHelper.worldUpAtPosition(null,O),p.computeTranslationToOriginAndRotation(a.spatialReference,[f.x,f.y,0],C,this._context.renderCoordsHelper.spatialReference);const I=h.create();c.invert(I,C);const R=l.create();o.normalFromMat4(R,I);const{polygons:z,mapPositions:G,position:V}=u;for(const o of z){const e=o.count;if(this._context.clippingExtent&&(g.empty(v),g.expandWithBuffer(v,o.mapPositions),!g.intersectsClippingArea(v,this._context.clippingExtent)))continue;const r=s.earcut(o.mapPositions,o.holeIndices,3);if(0===r.length)continue;const a=r.length,l=6*e,c=l+a,h=m.newIndexArray(c),u=m.newIndexArray(a),d=y.newDoubleArray(3*l),p=y.newDoubleArray(3*l),f=y.newDoubleArray(3*l),x=y.newDoubleArray(l);W(V,G,r,o,d,f,p,x,h,u,this._getExtrusionSize(t),O,D),b.transformMat4(d,d,I);const S=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),P=new he(d,f,U.compressNormals(p),x);_.push(H(this._material,h,h.length-u.length,P,n,S),H(this._bottomMaterial,u,0,P,n,S)),A.push(P.heights)}if(0===_.length)return null;const T=new B.Object3D({geometries:_,layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0});T.transformation=C;const k=M.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),j=null!=k?{baseMaterial:this._material,edgeMaterials:[k],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,N=(e,t,n,r,i)=>re(e,t,n,r,i,A),F=new P.Graphics3DObject3DGraphicLayer(this,T,_,null,null,N,r,j);return F.alignedSampledElevation=u.sampledElevation,F.needsElevationUpdates=S.needsElevationUpdates3D(r.mode),F},t._createClass(n)}(v.Graphics3DSymbolLayer);function H(e,t,n,r,i,a){const s=m.getZeroIndexArray(t.length),o=[[k.VertexAttribute.POSITION,new R.Attribute(r.positions,3,!0)],[k.VertexAttribute.NORMALCOMPRESSED,new R.Attribute(r.normals,2,!0)],[k.VertexAttribute.COLOR,new R.Attribute(i,4,!0)]],l=[[k.VertexAttribute.POSITION,t],[k.VertexAttribute.NORMALCOMPRESSED,t],[k.VertexAttribute.COLOR,s]];return new V.Geometry(e,o,l,r.elevation,G.ContentObjectType.Mesh,a,n)}function W(e,t,n,r,i,a,s,o,l,c,h,u,d){const p=n.length/3;let g=0,y=2*r.count;Z(e,t,r.index,r.count,n,0,p,i,a,s,o,l,c,y,h,u,d);let m=2*r.count;y=0,K(i,a,o,s,g,r.pathLengths[0],r.count,m,l,y,h),m+=4*r.pathLengths[0],y+=2*r.pathLengths[0],g+=r.pathLengths[0];for(let b=1;b<r.pathLengths.length;++b)K(i,a,o,s,g,r.pathLengths[b],r.count,m,l,y,h),m+=4*r.pathLengths[b],y+=2*r.pathLengths[b],g+=r.pathLengths[b]}function Z(e,t,n,r,i,a,s,o,l,c,h,d,p,g,y,m,b){u.copy(ae,m);const f=y>0?1:-1;let _=3*n,x=0,S=3*x,A=r,P=3*A;for(let C=0;C<r;++C)b&&(ae[0]=e[_],ae[1]=e[_+1],ae[2]=e[_+2],u.normalize(ae,ae)),o[S]=e[_],o[S+1]=e[_+1],o[S+2]=e[_+2],l[S]=t[_],l[S+1]=t[_+1],l[S+2]=t[_+2],c[S]=-f*ae[0],c[S+1]=-f*ae[1],c[S+2]=-f*ae[2],h[x]=0,o[P]=e[_]+y*ae[0],o[P+1]=e[_+1]+y*ae[1],o[P+2]=e[_+2]+y*ae[2],l[P]=t[_],l[P+1]=t[_+1],l[P+2]=t[_+2],c[P]=f*ae[0],c[P+1]=f*ae[1],c[P+2]=f*ae[2],h[A]=y,S+=3,P+=3,_+=3,x+=1,A+=1;_=3*a,S=0,P=3*g;const v=y<0?le:oe,E=y<0?oe:le;for(let u=0;u<s;++u)p[S]=i[_+v[0]],p[S+1]=i[_+v[1]],p[S+2]=i[_+v[2]],d[P]=i[_+E[0]]+r,d[P+1]=i[_+E[1]]+r,d[P+2]=i[_+E[2]]+r,S+=3,P+=3,_+=3}function q(e,t,n,r,i,a,s){r[a]=r[s],s*=3,e[a*=3]=e[s],e[a+1]=e[s+1],e[a+2]=e[s+2],t[a]=t[s],t[a+1]=t[s+1],t[a+2]=t[s+2],n[a]=i[0],n[a+1]=i[1],n[a+2]=i[2]}const J=d.create();function K(e,t,n,r,i,a,s,o,l,c,h){let u=i,d=i+1,p=i+s,g=i+s+1,y=o,m=o+1,b=o+2*a,f=o+2*a+1;h<0&&(u=i+s+1,g=i),c*=3;for(let _=0;_<a;++_)_===a-1&&(h>0?(d=i,g=i+s):(d=i,u=i+s)),te(e,u,d,p,J),q(e,t,r,n,J,y,u),q(e,t,r,n,J,m,d),q(e,t,r,n,J,b,p),q(e,t,r,n,J,f,g),l[c++]=y,l[c++]=b,l[c++]=f,l[c++]=y,l[c++]=f,l[c++]=m,u++,d++,p++,g++,y+=2,m+=2,b+=2,f+=2}const Q=d.create(),X=d.create(),Y=d.create(),$=d.create(),ee=d.create();function te(e,t,n,r,i){t*=3,n*=3,r*=3,u.set(Q,e[t++],e[t++],e[t++]),u.set(X,e[n++],e[n++],e[n++]),u.set(Y,e[r++],e[r++],e[r++]),u.subtract($,X,Q),u.subtract(ee,Y,Q),u.cross(i,ee,$),u.normalize(i,i)}const ne=d.create();function re(e,t,n,r,i,a){const s=e.stageObject,o=s.geometries,l=o.length,d="absolute-height"!==t.mode;let p=0;const g=s.transformation,y=c.invertOrIdentity(h.create(),g);for(let c=0;c<l;c+=2){const e=o[c];if(!T.isGeometryWithMapPositions(e))continue;const t=e.getMutableAttribute(k.VertexAttribute.POSITION).data,l=a[c/2],h=new D.SamplePosition(e.mapPositions),m=t.length/3;let b=0,f=!1,_=0;for(let a=0;a<m;a++){ne[0]=t[b],ne[1]=t[b+1],ne[2]=t[b+2],r(h,se),d&&(_+=se.sampledElevation),O.TESTS_DISABLE_OPTIMIZATIONS?(u.set(ie,h.array[h.offset],h.array[h.offset+1],se.z+l[b/3]),null!=n&&i.toRenderCoords(ie,n,ie),u.transformMat4(ie,ie,y)):(u.set(ie,t[b],t[b+1],t[b+2]),u.transformMat4(ie,ie,g),i.setAltitude(ie,se.z+l[b/3]),u.transformMat4(ie,ie,y)),t[b]=ie[0],t[b+1]=ie[1],t[b+2]=ie[2];const e=ce/i.unitInMeters;(Math.abs(ne[0]-t[b])>=e||Math.abs(ne[1]-t[b+1])>=e||Math.abs(ne[2]-t[b+2])>=e)&&(f=!0),h.offset+=3,b+=3}f&&(e.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(o[c]),o[c+1].invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(o[c+1])),p+=_/m}return p/l}const ie=d.create(),ae=d.create(),se=new S.SampleElevationInfo,oe=[0,2,1],le=[0,1,2],ce=.01;let he=t._createClass((function(e,t,n,r){this.positions=e,this.elevation=t,this.normals=n,this.heights=r}));e.Graphics3DExtrudeSymbolLayer=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
