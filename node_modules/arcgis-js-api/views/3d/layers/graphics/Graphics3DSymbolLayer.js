/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../core/has","../../../../core/Logger","../../../../chunks/vec3f64","../../../../chunks/vec4f64","./elevationAlignmentUtils","./ElevationContext","./featureExpressionInfoUtils","./graphicUtils","./interfaces","./Loadable","./symbolComplexity","../support/FastSymbolUpdates"],(function(e,t,n,i,o,r,a,s,l,u,c,p,d,f,y){"use strict";const h=o.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");let g=function(e){function i(t,n,i,o){var r;return(r=e.call(this,i.schedule)||this).symbol=t,r.symbolLayer=n,r._context=i,r._elevationInfoOverride=null,r.ignoreDrivers=!1,r._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},r.complexity=null,r.logger=h,r._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},r.skipHighSymbolLodsChanged=!0,r._renderPriority=o.renderPriority,r._renderPriorityStep=o.renderPriorityStep,r._elevationContext=new l.ElevationContext,r.complexity=r.computeComplexity(),r.ignoreDrivers=o.ignoreDrivers,r.ignoreDrivers||(r._drivenProperties=v(r._context.renderer)),r._updateElevationContext(),r}t._inherits(i,e);var o=i.prototype;return o.getCachedSize=function(){return null},o._drivenPropertiesChanged=function(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,n=v(e);return n.color!==t.color||n.opacity!==t.opacity||n.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||n.size!==t.size},o._logGeometryCreationWarnings=function(e,t,n,i){const o=e.projectionSuccess,r="polygons"in e?e.polygons:null,a=`${i} geometry failed to be created`;let s=null;o?!this._logGeometryValidationWarnings(t,n,i)&&r&&0===r.length&&"rings"===n&&t.length>0&&t[0].length>2&&(s=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):s=`${a} (failed to project geometry to view spatial reference)`,s&&h.warnOncePerTick(s)},o._logGeometryValidationWarnings=function(e,t,n){const i=`${n} geometry failed to be created`;return!e.length||1===e.length&&!e[0].length?(h.warnOncePerTick(`${i} (no ${t} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(h.warnOncePerTick(`${i} (${t} should be defined as a 2D array)`),!0)},o._validateGeometry=function(e,t=null,n=null){if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+n+` symbol: ${e.type}`),!1;if("point"===e.type){const t=e;if(!isFinite(t.x)||!isFinite(t.y))return h.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0},o._defaultElevationInfoNoZ=function(){return _},o._defaultElevationInfoZ=function(){return m},o._updateElevationContext=function(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()},o.getDefaultElevationInfo=function(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()},o.getGeometryElevationMode=function(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode},o.setElevationInfoOverride=function(e){this._elevationInfoOverride=e,this._updateElevationContext()},o.setGraphicElevationContext=function(e,t){const n=e.geometry,i=this.getDefaultElevationInfo(n);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:i.unit,t.mode=this.getGeometryElevationMode(n,i),t.offsetMeters=this._elevationContext.meterUnitOffset??i.offset??0;const o=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;o&&(t.mode="relative-to-ground",t.offsetMeters=0);const r=o?u.zeroContext:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(r,e,this._context.layer),t},o.prepareSymbolLayerPatch=function(e){},o.updateGeometry=function(e,t){return!1},o.updateTransform=function(e,t,n,i){return!1},o.onRemoveGraphic=function(e){},o._getLayerOpacity=function(){if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity??0;const e=this._context.layer.opacity;return e??1},o._getCombinedOpacity=function(e,t=C){let n=1;return this.draped||(n*=this._getLayerOpacity()),this._drivenProperties.opacity||(null!=e?n*=e.a:t.hasIntrinsicColor||(n=0)),n},o._getCombinedOpacityAndColor=function(e,t=C){const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return c.mixinColorAndOpacity(null,i);const o=null!=e?n.toUnitRGB(e):r.ONES;return c.mixinColorAndOpacity(o,i)},o._getVertexOpacityAndColor=function(e,t=null){const n=this._drivenProperties.color?e.color:null,i=this._drivenProperties.opacity?e.opacity:null,o=c.mixinColorAndOpacity(n,i);return t&&(o[0]*=t,o[1]*=t,o[2]*=t,o[3]*=t),o},o.isFastUpdatesEnabled=function(){return null!=this._fastUpdates},o.computeComplexity=function(){return f.defaultSymbolLayerComplexity(this.symbol,this.symbolLayer)},o.globalPropertyChanged=function(e,t,n){switch(e){case"opacity":return this.layerOpacityChanged(t,n),!0;case"elevationInfo":{const e=this._elevationContext.mode;this._updateElevationContext();return this.layerElevationInfoChanged(t,n,e)!==s.SymbolUpdateType.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,n);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}},o.updateGraphics3DGraphicElevationInfo=function(e,t,n){let i=s.SymbolUpdateType.UPDATE;return e.forEach((e=>{const o=t(e);if(null!=o){const t=e.graphic;this.setGraphicElevationContext(t,o.elevationContext),o.needsElevationUpdates=n(o.elevationContext.mode)}else i=s.SymbolUpdateType.RECREATE})),i},o.applyRendererDiff=function(e,t){return p.ApplyRendererDiffResult.RecreateSymbol},o.getFastUpdateAttrValues=function(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,n=t.size?y.getAttributeValue(t.size.field,e):0,i=t.color?y.getAttributeValue(t.color.field,e):0,o=t.opacity?y.getAttributeValue(t.opacity.field,e):0;return a.fromValues(n,i,o,0)},o.ensureDrapedStatus=function(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&h.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)},o.test=function(){const e=()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null});return{drivenProperties:this._drivenProperties,getVisVarFields:e}},t._createClass(i,[{key:"extentPadding",get:function(){return 0}},{key:"needsDrivenTransparentPass",get:function(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}},{key:"pixelRatioChanged",get:function(){return!0}},{key:"draped",get:function(){return this._draped}}]),i}(d.Loadable);function v(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let n=0;n<e.stops.length;n++){const i=e.stops[n].color;i&&(t.opacity=!0,i.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),t}const _={mode:"on-the-ground",offset:0,unit:"meters"},m={mode:"absolute-height",offset:0,unit:"meters"},C={hasIntrinsicColor:!1};e.Graphics3DSymbolLayer=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
