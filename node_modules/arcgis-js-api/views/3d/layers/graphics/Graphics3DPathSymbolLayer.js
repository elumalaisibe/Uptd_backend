/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Error","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DPathSymbolLayerConstants","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","../support/FastSymbolUpdates","../../support/ElevationProvider","../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Path","../../webgl-engine/lib/PathBuilder","../../webgl-engine/lib/PathCapBuilder","../../webgl-engine/lib/PathExtruder","../../webgl-engine/lib/PathGeometry","../../webgl-engine/lib/PathGeometryData","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/lib/PathProfile","../../webgl-engine/lib/PathVertex","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/PathMaterial"],(function(e,t,i,r,a,s,n,o,l,c,h,p,u,d,f,m,y,g,_,b,v,P,S,w,x,D,C,A,U,V,R,E,L,B,I,O){"use strict";const k=["polyline"];let G=function(e){function i(t,i,r,a){var s;return(s=e.call(this,t,i,r,a)||this)._intrinsicSize=o.fromValues(1,1),s._upVectorAlignment=V.UpVectorAlignment.Path,s._stencilWidth=.1,s.ensureDrapedStatus(!1),s}t._inherits(i,e);var g=i.prototype;return g.doLoad=async function(){const e=null!=this.symbolLayer.width?this.symbolLayer.width:this.symbolLayer.height,t=null!=this.symbolLayer.height?this.symbolLayer.height:e;this._vvConvertOptions=new v.ConvertOptions({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[e,1,t],this._context.renderCoordsHelper.unitInMeters),this._fastUpdates=this._context.renderer?.visualVariables?.length>0?v.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):null;const i=this.symbolLayer.anchor||"center";this._upVectorAlignment="heading"===this.symbolLayer.profileRotation?V.UpVectorAlignment.World:V.UpVectorAlignment.Path;const a=this.symbolLayer.profile||"circle";switch(a){default:case"circle":this._profile=L.circleProfiles[i];break;case"quad":this._profile=L.quadProfiles[i]}switch(this.symbolLayer.join){case"round":this._extruder=new U.MiterExtruder(0,y.PATH_NUM_ROUND_JOIN_SUBDIVISIONS);break;case"bevel":this._extruder=new U.MiterExtruder(0,1);break;case"miter":this._extruder=new U.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new U.SimpleExtruder}const s=this.symbolLayer.cap||"butt";switch(s){case"none":this._startCap=new A.NoCapBuilder,this._endCap=new A.NoCapBuilder;break;case"butt":default:this._startCap=new A.TriangulationCapBuilder(this._profile,0),this._endCap=new A.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new A.TriangulationCapBuilder(this._profile,-.5),this._endCap=new A.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":{const e="quad"===a;this._startCap=new A.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:e,subdivisions:y.PATH_NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new A.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:e,subdivisions:y.PATH_NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS});break}}const l=this.symbolLayer?.material?.color,h=this._getCombinedOpacityAndColor(l),p=c.fromArray(h),u=h[3],d=u<1||this.needsDrivenTransparentPass,f={diffuse:p,ambient:p,opacity:u,transparent:d,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:d||"none"===s?w.CullFaceOptions.None:w.CullFaceOptions.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(n.set(this._intrinsicSize,e,t),!_.isValidSize(this._intrinsicSize[0])||!_.isValidSize(this._intrinsicSize[1])))throw new r("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates&&this._fastUpdates.visualVariables.size||n.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates){const e={...f,...this._fastUpdates.materialParameters,size:o.fromArray(this._intrinsicSize)};this._material=new O.PathMaterial(e)}else f.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,f.normalType=S.NormalType.Compressed,this._material=new I.DefaultMaterial(f);this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)},g.destroy=function(){t._get(t._getPrototypeOf(i.prototype),"destroy",this).call(this),this._context.stage.remove(this._material),this._material=null},g.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,k,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new f.ElevationContext),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)},g.layerOpacityChanged=function(){const e=this.symbolLayer?.material?.color,t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:t,transparent:i})},g.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,d.needsElevationUpdates3D)},g.slicePlaneEnabledChanged=function(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0},g.physicalBasedRenderingChanged=function(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},g.applyRendererDiff=function(e,t){for(const i in e.diff){if("visualVariables"!==i)return b.ApplyRendererDiffResult.RecreateSymbol;if(!v.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return b.ApplyRendererDiffResult.RecreateSymbol;this._material.setParameters(this._fastUpdates.materialParameters)}return b.ApplyRendererDiffResult.FastUpdate},g._getVertexData=function(e){let t=0;const i=e.paths,r=[],a=e.spatialReference,s=this._context.elevationProvider.spatialReference,n=this._context.renderCoordsHelper.spatialReference;for(const h of i)t+=h.length;const o=u.newDoubleArray(3*t);let l,c=0;for(const h of i){r.push({offset:c,numVertices:h.length});for(const t of h)o[c++]=t[0],o[c++]=t[1],o[c++]=e.hasZ?t[2]:0}return null==s||a.equals(s)||h.projectBuffer(o,a,0,o,s,0,t)?(null==s||s.equals(n)?l=u.doubleArrayFrom(o):(l=u.newDoubleArray(3*t),h.projectBuffer(o,s,0,l,n,0,t)),{pathVertexDataInfos:r,vertexDataES:o,vertexDataRS:l}):null},g._createAs3DShape=function(e,t,i,r){const n=e.geometry,o=this._getVertexData(n);if(null==o)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===o.pathVertexDataInfos.length)return 0!==n.paths.length&&n.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;const c=new Array,h=n.spatialReference,u=p.create(),f=this._context.renderCoordsHelper,y=new P.SamplePosition(o.vertexDataES);for(const m of o.pathVertexDataInfos){const n=m.numVertices;if(n<2)continue;const g=m.offset;if(null!=this._context.clippingExtent&&(p.empty(u),p.expandWithBuffer(u,o.vertexDataES,g,n),!p.intersectsClippingArea(u,this._context.clippingExtent)))continue;const _=new Array,b=g+3*n;for(let e=g;e<b;e+=3){y.offset=e;const t=d.evaluateElevationAlignmentAtPoint(y,this._context.elevationProvider,i,f);l.set(j,o.vertexDataRS[e],o.vertexDataRS[e+1],o.vertexDataRS[e+2]),f.setAltitude(j,t),o.vertexDataRS[e]=j[0],o.vertexDataRS[e+1]=j[1],o.vertexDataRS[e+2]=j[2],_.push(B.newPathVertex(this._upVectorAlignment))}const P=new D.Path(_,o.vertexDataES,o.vertexDataRS,g);z(P,this._upVectorAlignment,this._context.renderCoordsHelper);const S=new C.PathBuilder(P,this._profile,this._extruder,this._startCap,this._endCap);let w=null;if(this._fastUpdates){const t=this._fastUpdates.visualVariables,i=v.getAttributeValue(t.size?.field,e)??0,r=v.getAttributeValue(t.color?.field,e)??0,a=v.getAttributeValue(t.opacity?.field,e)??0;w=new R.FastUpdatePathGeometry(S,i,r,a)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const i=t.size;e[0]*=N(i[0],"symbol-value"===i[2]?this.symbolLayer.height||0:i[2],this.symbolLayer.width||0),e[1]*=N(i[2],"symbol-value"===i[0]?this.symbolLayer.width||0:i[0],this.symbolLayer.height||0)}let i;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new R.StaticPathGeometry(S);r.bake(e),i&&r.bakeVertexColors(i),w=r}const{vertexAttributes:x,indices:A}=w.createGeometryData(),U=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:this._context.layer.uid}),E=new V.PathGeometry(this._material,x,A,w,h,this._stencilWidth,U);E.transformation=a.translate(s.create(),s.IDENTITY,S.path.origin),c.push(E)}if(0===c.length)return null;const g=new x.Object3D({geometries:c,layerUid:this._context.layer.uid,graphicUid:r}),_=new m.Graphics3DObject3DGraphicLayer(this,g,c,null,null,((e,t,i,r,a)=>M(e,t,r,a,this._upVectorAlignment)),i);return _.alignedSampledElevation=0,_.needsElevationUpdates=d.needsElevationUpdates3D(i.mode),_},t._createClass(i)}(g.Graphics3DSymbolLayer);function z(e,t,i){const{origin:r,positions:a}=e;let s=e.offset;switch(t){default:case V.UpVectorAlignment.World:for(const t of e.vertices)j[0]=a[s++]+r[0],j[1]=a[s++]+r[1],j[2]=a[s++]+r[2],i.worldUpAtPosition(j,j),t.setFrameFromUpVector(j);break;case V.UpVectorAlignment.Path:j[0]=a[s]+r[0],j[1]=a[s+1]+r[1],j[2]=a[s+2]+r[2],i.worldUpAtPosition(j,j),E.computeMinimumRotationTangentFrame(e,j)}}function N(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function T(e,t,i,r){let a=0;const{origin:s,vertices:n,positions:o,positionsES:c}=e,h=e.offset+3*n.length;for(let p=e.offset;p<h;p+=3)l.set(j,c[p],c[p+1],c[p+2]),i(j,F),a+=F.sampledElevation,j[0]=o[p]+s[0],j[1]=o[p+1]+s[1],j[2]=o[p+2]+s[2],r.setAltitude(j,F.z),o[p]=j[0]-s[0],o[p+1]=j[1]-s[1],o[p+2]=j[2]-s[2];return e.updatePathVertexInformation(),a/n.length}function M(e,t,i,r,a){const s=e.stageObject,n=s.geometries;let o=0;for(const l of n){if(!V.isPathGeometry(l))continue;const e=l.path,n=e.builder.path;o+=T(n,t,i,r),a!==V.UpVectorAlignment.World&&z(n,a,r),e.onPathChanged(l),l.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(l)}return o/n.length}const j=c.create(),F=new d.SampleElevationInfo;e.Graphics3DPathSymbolLayer=G,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
