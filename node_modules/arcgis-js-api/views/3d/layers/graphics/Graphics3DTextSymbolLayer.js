/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../chunks/vec2f64","../../../../symbols/callouts/calloutUtils","./CreateLabelParameters","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./placementUtils","./pointUtils","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureFactory","../../webgl-engine/materials/HUDMaterial"],(function(e,t,n,r,a,i,l,o,s,c,h,u,d,p,m,f,y,g,b,x,v){"use strict";const P=[0,0,1];let O=function(e){function p(t,n,r,a){var i;return(i=e.call(this,t,n,r,a)||this)._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},i.ensureDrapedStatus(!1),i}t._inherits(p,e);var O=p.prototype;return O.doLoad=async function(){if(!this._drivenProperties.size){const e=m.validateSymbolLayerSize(this.symbolLayer.size);if(e)throw new n("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()},O._createTextRenderParameters=async function(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await b.TextRenderParameters.fromSymbol(this.symbolLayer,e)},O.destroy=function(){t._get(t._getPrototypeOf(p.prototype),"destroy",this).call(this)},O.createGraphics3DGraphic=function(e){const t=e.graphic,n=y.placePointOnGeometry(t.geometry);if(null==n)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const r=this.symbolLayer.text;if(null==r||""===r)return null;const a=l.hasCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=a&&!l.textSymbolLayerSupportsVerticalOffset(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const i=new o.CreateLabelParameters(a,this.symbolLayer.horizontalAlignment,f.verticalPlacementFromAlignment(this.symbolLayer.verticalAlignment));return this._createAs3DShape(t,n,r,i)},O.createLabel=function(e,t,n,r){const a=e.graphic,i=y.placePointOnGeometry(a.geometry);if(null==i)return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;const l=t.text;return!l||/^\s+$/.test(l)?null:this._createAs3DShape(a,i,l,t,n,r)},O.setGraphicElevationContext=function(e,n,r=0){const a=t._get(t._getPrototypeOf(p.prototype),"setGraphicElevationContext",this).call(this,e,n);return a.addOffsetRenderUnits(r),a},O.layerOpacityChanged=function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},O.layerElevationInfoChanged=function(e,t){return S(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),c.SymbolUpdateType.UPDATE},O.slicePlaneEnabledChanged=function(e,t){return S(e,t,(e=>{for(const t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0},O.physicalBasedRenderingChanged=function(){return!0},O.updateGraphicElevationContext=function(e,t){const n=t.elevationContext;this.setGraphicElevationContext(e,n,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=c.needsElevationUpdates2D(n.mode)||"absolute-height"===n.mode},O._defaultElevationInfoNoZ=function(){return E},O._createAs3DShape=function(e,t,n,l,o,p){const m=this.setGraphicElevationContext(e,new h.ElevationContext,l.elevationOffset),b="polyline"===e.geometry?.type,O=e.uid;let S=null,E=null;if(null==p){const e=f.textRenderAlignmentFromHorizontalPlacement(l.horizontalPlacement);S=new x(n,e,this._textRenderParameters);let t=null;if(null!=this._context.sharedResources.textures){E=this._context.sharedResources.textures.fromData(S.key,(()=>S.create()),(()=>{null!=t&&t.release()}));const e=this._context.stage.renderView.textureRepository.acquire(E.texture.id);if(null==e||r.isPromiseLike(e))return E.release(),null;t=e}}const L=_(S,l),w={occlusionTest:!0,screenOffset:l.screenOffset,anchorPosition:L,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:l.centerOffsetUnits,drawInSecondSlot:!0};if(null!=p?w.textureId=p.id:null!=E&&(w.textureId=E.texture.id),null!=l.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:n}=l.verticalOffset;w.verticalOffset={screenLength:a.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=n?n:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;w.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),w.screenSizePerspectiveAlignment=e}let G;if(b&&(w.shaderPolygonOffset=1e-4),w.hasSlicePlane=this._context.slicePlaneEnabled,null!=o){const e=JSON.stringify(w);G=o.get(e),null==G&&(G=new v.HUDMaterial(w),o.add(e,G))}else G=new v.HUDMaterial(w);const D=l.translation,C=S?i.fromValues(S.displayWidth,S.displayHeight):i.ZEROS,U=l.centerOffset,z=P,A=[0,0],R=g.createPointGeometry(G,z,D,null,C,U,A,null),T=y.createStageObject(this._context,t,R,m,O);if(null==T)return null;const j=new u.Graphics3DObject3DGraphicLayer(this,T.object,[R],null==o?[G]:null,E,s.perObjectElevationAligner,m);j.alignedSampledElevation=T.sampledElevation,j.needsElevationUpdates=c.needsElevationUpdates2D(m.mode)||"absolute-height"===m.mode;const{displayWidth:H,displayHeight:k}=null!=S?S:l;j.getScreenSize=(e=i.create())=>(e[0]=H,e[1]=k,e);const M=new d.Graphics3DObjectMetadata(l.elevationOffset,n);return j.metadata=M,y.extendPointGraphicElevationContext(j,t,this._context.elevationProvider),j},t._createClass(p,[{key:"pixelRatioChanged",get:function(){return!1}}]),p}(p.Graphics3DSymbolLayer);function S(e,t,n){e&&e.forEach((e=>{const r=t(e);null!=r&&n(r,e.graphic)}))}function _(e,t){if("baseline"===t.verticalPlacement){const n=f.horizontalPlacementToAnchorX[t.horizontalPlacement],r=null!=e?e.baselineAnchorY:0;return i.fromValues(n,r)}const n=f.anchorFromPlacements(t.horizontalPlacement,t.verticalPlacement);return f.namedAnchorToHUDMaterialAnchorPos[n]}const E={mode:"relative-to-ground",offset:0};e.Graphics3DTextSymbolLayer=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
