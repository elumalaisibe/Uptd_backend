/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../symbols","../../../../core/asyncUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../chunks/mat4f64","../../../../chunks/vec2f64","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../support/arcadeOnDemand","../../../../symbols/support/IconSymbol3DLayerResource","../../../../symbols/support/utils","../../../2d/arcade/callExpressionWithFeature","./constants","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./placementUtils","./pointUtils","../support/FastSymbolUpdates","../../support/engineContent/sdfPrimitives","../../terrain/OverlayRenderer","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial","../../../../symbols/CIMSymbol"],(function(e,t,i,r,s,a,n,o,l,c,h,u,d,m,_,p,y,f,g,x,S,b,v,P,R,z,M,T,C,I,U,E,O,D,A,w,L,F,G,V){"use strict";const H=u.create(),j=m.fromValues(0,0,1),B=16,N=1.5,k=D.DEFAULT_TEX_SIZE,q=D.DEFAULT_SYMBOL_SIZE_RATIO,W=[q/2,q/2,1-q/2,1-q/2],Z=[k*q,k*q];let $=function(t){i._inherits(u,t);var s=u.prototype;function u(e,i,r,s){var a;return(a=t.call(this,e,i,r,s)||this)._cimLayers=null,a._cimSymbolMaterials=new Map,a._cimSymbolTextures=new Map,a._cimMaterialParametersInfo=null,a._cimRequiredFields=null,a._cimScaleFactorOrFunction=null,a._size=null,a._symbolTextureRatio=1,a._outlineSize=0,a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},a}return s.getCachedSize=function(){return{size:this._getIconSize()}},s.doLoad=async function(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(null!=i)this._prepareResourcesPrimitive(t,i);else{const i=x.getIconHref(this.symbolLayer),r=h.dataComponents(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}},s._validateOrThrow=function(){if(this._drivenProperties.size)return;const e=C.validateSymbolLayerSize(this._getIconSize());if(e)throw new n("graphics3diconsymbollayer:invalid-size",e)},s._getIconSize=function(){const e=this.symbolLayer,t=Math.round(null!=e.size?c.pt2px(e.size):B);return this._drivenProperties.size?Math.max(t,64):t},s._generateTextureCIM=function(e){const t=this._getGraphicHash(e);let i=""===t?null:this._cimSymbolTextures.get(t);if(!i){const r={scaleFactor:this._cimScaleFactorOrFunction},s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,e,"esriGeometryPoint",r,void 0,void 0);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",s.anchorPosition);const a={width:s.imageData.width,height:s.imageData.height};i=new F.Texture(s.imageData,a),this._cimSymbolTextures.set(t,i),this._context.stage.add(i)}return i},s._prepareMaterialParameters=function(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(J(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:c.pt2px(i),minWorldLength:r||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e},s._prepareResourcesPrimitive=function(e,t){const i=this._getOutlineSize();if(X(t)&&0===i)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,null!=this._context.sharedResources.textures){const i=this._context.sharedResources.textures.fromData(`${t}-icon`,(()=>D.createTexture(t)));this._texture=i.texture,this._releaseTexture=i,e.textureId=this._texture.id}e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=W;const r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=1/q,this._createMaterialAndAddToStage(e,this._context.stage)},s._prepareResourcesHref=async function(e,t,i){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),s=r*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(null!=this._context.sharedResources.textures){const o=await a.result(this._context.sharedResources.textures.fromUrl(t,s,{signal:i}));if(!1===o.ok){l.throwIfAbortError(o.error);throw new n("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`)}this._releaseTexture=o.value;const c=o.value.texture,h=c.parameters.width/c.parameters.height;this._size=h>1?[r,Math.round(r/h)]:[Math.round(r*h),r],e.textureId=c.id}this._createMaterialAndAddToStage(e,this._context.stage)},s._prepareResourcesCIM=async function(t,i,r){const s=new V({data:i});if(!this._context.sharedResources.cimSymbolRasterizer){const t=(await new Promise(((t,i)=>e(["../../../../symbols/cim/CIMSymbolRasterizer"],t,i)))).CIMSymbolRasterizer;l.throwIfAborted(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new t(this._context.renderCoordsHelper.spatialReference,!0))}const a=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let n,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol3D(s,a,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,i=await f.createRendererExpression(t,this._context.layer.spatialReference,a);o=(e,t,r)=>{const s=S(i,e,{$view:r},"esriGeometryPoint",t);return null!==s?s:1}}else n=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=n||o||1;const c=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];l.throwIfAborted(r);const h=this._context.layer.fieldsIndex;this._cimRequiredFields=c.map((e=>h.get(e).name)),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1},s._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||g.defaultPrimitive},s._getOutlineSize=function(){let e=0;const t=this.symbolLayer;if(null!=t.outline&&null!=t.outline.size)return Math.max(c.pt2px(t.outline.size),0);return e=X(this._getPrimitive())?N:0,Math.max(e,0)},s._getOutlineColor=function(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=t?.outline?.color;if(null!=i){const t=r.toUnitRGB(i),s=i.a*e;return[t[0],t[1],t[2],s]}return[0,0,0,0]},s._getFillColor=function(){if(X(this._getPrimitive()))return b.TRANSPARENT_UNIT;const e=null==this._getPrimitive(),t=this.symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})},s._getAnchorPos=function(e,t){return"relative"===e?d.fromValues((t.x||0)+.5,.5-(t.y||0)):e in U.namedAnchorToHUDMaterialAnchorPos?U.namedAnchorToHUDMaterialAnchorPos[e]:U.namedAnchorToHUDMaterialAnchorPos.center},s._createMaterialAndAddToStage=function(e,t){if(this._cimLayers){this._fastUpdates=null;let i=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return i||(i=new G.HUDMaterial(e),this._cimSymbolMaterials.set(e.textureId??0,i),t.add(i)),i}return this._fastUpdates=O.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e={...e,...this._fastUpdates.materialParameters}),this._material=new G.HUDMaterial(e),t.add(this._material),this._material},s._setDrapingDependentMaterialParameters=function(){this.draped&&(this._forEachMaterial((e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())},s.destroy=function(){i._get(i._getPrototypeOf(u.prototype),"destroy",this).call(this),this._forEachMaterial((e=>this._context.stage.remove(e))),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._releaseTexture=o.releaseMaybe(this._releaseTexture)},s._getScaleFactor=function(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=c.pt2px(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1},s.createGraphics3DGraphic=function(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i,r=[0,0];if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(t),s={textureId:e.id,...this._cimMaterialParametersInfo};i=this._createMaterialAndAddToStage(s,this._context.stage),r=[e.parameters.width,e.parameters.height]}else r=this._size,i=this._material;const s=E.placePointOnGeometry(t.geometry);if(null==s)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const a=e.renderingInfo,n=this._getVertexOpacityAndColor(a);let o=1;if(!this._fastUpdates?.visualVariables.size){const e=r[0]>r[1]?r[0]:r[1];o=this._getScaleFactor(a,e)}o*=this._symbolTextureRatio;const l=d.fromValues(r[0]*o,r[1]*o),c=this.setGraphicElevationContext(t,new R.ElevationContext);return this.ensureDrapedStatus("on-the-ground"===c.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,s,i,n,l,e.layer.uid):this._createAs3DShape(t,s,i,n,l,c,t.uid)},s.layerOpacityChanged=function(){const e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial((i=>{i.setParameters({color:e}),i.setParameters({outlineColor:t})}))},s.layerElevationInfoChanged=function(e,t,i){const r=this._elevationContext.mode,s=P.elevationModeChangeUpdateType(u.elevationModeChangeTypes,i,r);if(s!==P.SymbolUpdateType.UPDATE)return s;const a=P.needsElevationUpdates2D(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))},s.slicePlaneEnabledChanged=function(){return this.draped||this._forEachMaterial((e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0},s.physicalBasedRenderingChanged=function(){return!0},s.applyRendererDiff=function(e,t){for(const i in e.diff){if("visualVariables"!==i)return I.ApplyRendererDiffResult.RecreateSymbol;if(!O.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return I.ApplyRendererDiffResult.RecreateSymbol;null!=this._material&&this._material.setParameters(this._fastUpdates.materialParameters)}return I.ApplyRendererDiffResult.FastUpdate},s._defaultElevationInfoNoZ=function(){return Y},s._createAs3DShape=function(e,t,i,r,s,a,n){const o=this.getFastUpdateAttrValues(e),l=o&&this._fastUpdates?e=>O.evaluateModelTransform(this._fastUpdates.materialParameters,o,e):void 0,c=this._context.layer.uid,h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerUid:c}),u=w.createPointGeometry(i,j,null,r,s,K,null,o,h),d=E.createStageObject(this._context,t,u,a,n,l);if(null==d)return null;const m=new M.Graphics3DObject3DGraphicLayer(this,d.object,[u],null,null,v.perObjectElevationAligner,a);return m.alignedSampledElevation=d.sampledElevation,m.needsElevationUpdates=P.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode,m.getScreenSize=this._createScreenSizeGetter(s,l),m.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(m.getScreenSize(),1,e),E.extendPointGraphicElevationContext(m,t,this._context.elevationProvider),m},s._createAsOverlay=function(e,t,i,r,s,a){i.renderPriority=this._renderPriority;const n=_.create();p.projectPointToVector(t,n,this._context.overlaySR),n[2]=A.DRAPED_Z;const o=this._context.clippingExtent;if(null!=o&&!y.containsPoint(o,n))return null;const l=this.getFastUpdateAttrValues(e),c=l&&this._fastUpdates?e=>O.evaluateModelTransform(this._fastUpdates.materialParameters,l,e):void 0,h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),u=w.createPointGeometry(i,j,n,r,s,null,null,l,h),d=new L.RenderGeometry(u,{layerUid:a,graphicUid:e.uid,shaderTransformer:c}),m=new z(this,[d],null,this._context.drapeSourceRenderer);return m.getScreenSize=this._createScreenSizeGetter(s,c),m.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(m.getScreenSize(),1,e),m},s._createScreenSizeGetter=function(e,t){const i=this._outlineSize+2;if(this._fastUpdates&&t){const r=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return(e=d.create())=>{const a=t(H);return e[0]=a[0]*r+i,e[1]=a[5]*s+i,e}}{const t=e[0]/this._symbolTextureRatio+i,r=e[1]/this._symbolTextureRatio+i;return(e=d.create())=>(e[0]=t,e[1]=r,e)}},s._fastVisualVariableConvertOptions=function(){const e=Math.max(this._size[0],this._size[1]),t=m.fromValues(e,e,e),i=c.px2pt(1),r=e*i,s=m.fromValues(r,r,r);return new O.ConvertOptions({size:!0,color:!0,rotation:!0,opacity:!1},t,s,i)},s._getGraphicHash=function(e){let t="";for(const i of this._cimRequiredFields)t+=i+e.attributes[i];return t},s._forEachMaterial=function(e){null!=this._material&&e(this._material),this._cimSymbolMaterials.forEach(e)},s.test=function(){return{...i._get(i._getPrototypeOf(u.prototype),"test",this).call(this),material:this._material}},i._createClass(u,[{key:"pixelRatioChanged",get:function(){return null!=this._getPrimitive()}}]),u}(T.Graphics3DSymbolLayer);function J(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}function X(e){return null!=e&&("cross"===e||"x"===e)}$.PRIMITIVE_SIZE=Z,$.elevationModeChangeTypes={definedChanged:P.SymbolUpdateType.UPDATE,staysOnTheGround:P.SymbolUpdateType.NONE,onTheGroundChanged:P.SymbolUpdateType.RECREATE};const Y={mode:"relative-to-ground",offset:0},K=_.fromValues(0,0,0,1);t.Graphics3DIconSymbolLayer=$,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
