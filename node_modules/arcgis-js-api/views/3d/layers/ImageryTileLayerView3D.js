/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./LayerView3D","./TiledLayerView3D","../terrain/RasterTile","../../layers/ImageryTileLayerView","../../layers/LayerView","../../layers/RefreshableLayerView","../../support/drapedUtils","../../webgl/capabilities"],(function(e,t,i,r,a,s,n,l,o,c,h,y,p,u,d,m,f){"use strict";let b=function(t){function a(){var e;return(e=t.apply(this,arguments)||this).type="imagery-tile-3d",e.isAlignedMapTile=!0,e}e._inherits(a,t);var s=a.prototype;return s.initialize=function(){this.layer.increaseRasterJobHandlerUsage(),null==this.fullExtent&&this.addResolvingPromise(Promise.reject(new i("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=r.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo,i=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t);this.isAlignedMapTile=i;const r=i?t:e.toTileInfo();this.tileInfo=r,this.updatingHandles.add((()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent]),(()=>this.refresh()))}));this.addResolvingPromise(e)},s.destroy=function(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null},s._getfullExtent=function(){return this.projectFullExtent(this.view.basemapTerrain&&null!=this.view.basemapTerrain.spatialReference?this.view.basemapTerrain.spatialReference:this.view.spatialReference)},s.fetchTile=async function(e,t,i,r){const a=this.tileInfo,s=this._canSymbolizeInWebGL(),n={tileInfo:a,requestRawData:s,signal:r.signal,timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile},l=await this.layer.fetchTile(e,t,i,n);if(l instanceof HTMLImageElement)return l;let o=l&&l.pixelBlock;if(null==o)return this._blankTile;if(!s&&(o=await this.layer.applyRenderer(l),null==o))return this._blankTile;const c=new y.RasterTile([e,t,i],o,a.size[0],a.size[1]);return s?(c.symbolizerRenderer=this.layer.symbolizer.rendererJSON,c.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),c.transformGrid=l.transformGrid):c.isRendereredSource=!0,c.interpolation=this.layer.interpolation,c.bandIds=this.layer.bandIds,c},s._getSymbolizerOptions=function(e){const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain&&null!=this.view.basemapTerrain.spatialReference?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}},s.ensureSymbolizerParameters=function(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))},s.createFetchPopupFeaturesQueryGeometry=function(e,t){return m.createQueryGeometry(e,t,this.view)},s.refresh=function(){this.emit("data-changed")},s.doRefresh=async function(){this.suspended||this.emit("data-changed")},s._canSymbolizeInWebGL=function(){return f.getWebGLCapabilities("3d").supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL},e._createClass(a,[{key:"_blankTile",get:function(){const e=document.createElement("canvas"),t=e.getContext("2d"),[i,r]=this.tileInfo.size;return e.width=i,e.height=r,t.clearRect(0,0,i,r),t.getImageData(0,0,i,r)}},{key:"imageFormatIsOpaque",get:function(){return"jpg"===this.layer.tileInfo.format}},{key:"hasMixedImageFormats",get:function(){return"mixed"===this.layer.tileInfo.format}},{key:"dataLevelRange",get:function(){const e=this.tileInfo.lods,t=this.layer.tileInfo.lods,i=e[0].scale,r=t[t.length-1].scale;return this.levelRangeFromScaleRange(i,r)}}]),a}(p(d(h.TiledLayerView3D(c.LayerView3D(u)))));t.__decorate([a.property({readOnly:!0})],b.prototype,"_blankTile",null),t.__decorate([a.property({readOnly:!0})],b.prototype,"imageFormatIsOpaque",null),t.__decorate([a.property({readOnly:!0})],b.prototype,"hasMixedImageFormats",null),t.__decorate([a.property({readOnly:!0})],b.prototype,"dataLevelRange",null),b=t.__decorate([o.subclass("esri.views.3d.layers.ImageryTileLayerView3D")],b);return b}));
