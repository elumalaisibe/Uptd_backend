/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/Logger","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/spatialReferenceUtils","./LayerView3D","./support/PopupSceneLayerView","../../layers/LayerView","../../../geometry/SpatialReference"],(function(e,s,t,i,a,o,r,l,n,c,h,u,d,y,m,p,b,w,_,f){"use strict";var V;!function(e){e[e.API=1]="API",e[e.VerboseAPI=2]="VerboseAPI",e[e.Error=3]="Error"}(V||(V={}));const v=d.create(),W=d.create();let g=function(s){function t(){var e;return(e=s.apply(this,arguments)||this)._suspendedHandle=null,e._usedMemory=0,e._futureMemory=0,e.type="voxel-3d",e.slicePlaneEnabled=!1,e._wasmLayerId=-1,e.ignoresMemoryFactor=!0,e._dbgFlags=new Set,e}e._inherits(t,s);var r=t.prototype;return r.initialize=function(){if(this._dbgFlags.add(V.Error),"local"!==this.view.viewingMode)throw new i("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if(!!!this.view._stage.renderView.renderingContext.capabilities.colorBufferFloat?.textureFloat)throw new i("voxel:missing-color-buffer-float","Voxel layers require the WebGL2 extension EXT_color_buffer_float",{});const e=this.layer.spatialReference;if(!p.equals(e,this.view.spatialReference))throw new i("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const s=this.layer.currentVariableId,t=this.layer.getVolume(s),a=this.layer.getVariable(s);if(null!=t&&null!=a){const e=t.dimensions[0],s=t.dimensions[1],i=t.zDimension;if(i>1){const o=t.dimensions[i],r=e.size*s.size*o.size;let l=1;switch(a.renderingFormat.type){case"Int16":case"UInt16":l=2;break;case"Int32":case"UInt32":case"Float32":l=4}this._futureMemory=l*r}}const r=this.view.addVoxelLayerViewToWasm(this).then((e=>{this._wasmLayerId=e,this._suspendedHandle=o.watch((()=>this.suspended),(e=>{const s=this.view.voxelWasm;null!=s&&s.setEnabled(this,!e)}),o.initial),this.handles.add([o.watch((()=>this.layer.renderMode),(e=>this._pushRenderModeToWasm(e))),o.watch((()=>this.layer.currentVariableId),(e=>this._pushCurrentVariableIdToWasm(e))),o.watch((()=>this.layer.getSections()),(e=>this._pushSectionsToWasm(e))),o.watch((()=>this.layer.getVariableStyles()),(e=>this._pushVariableStylesToWasm(e))),o.watch((()=>this.layer.getVolumeStyles()),(e=>this._pushVolumeStylesToWasm(e))),o.watch((()=>this.layer.enableDynamicSections),(e=>this._pushEnableDynamicSectionsToWasm(e))),o.watch((()=>this.layer.enableIsosurfaces),(e=>this._pushEnableIsosurfacesToWasm(e))),o.watch((()=>this.layer.enableSections),(e=>this._pushEnableSectionsToWasm(e))),o.watch((()=>this.layer.enableSlices),(e=>this._pushEnableSlicesToWasm(e))),o.watch((()=>this.slicePlaneEnabled),(e=>this._pushAnalysisSliceToWasm(e,this.view.slicePlane))),o.watch((()=>this.view.slicePlane),(e=>this._pushAnalysisSliceToWasm(this.slicePlaneEnabled,e)))])})).catch((e=>{if(this.view.removeVoxelLayerViewFromWasm(this),this._wasmLayerId=-1,-1===e)throw new i("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===e)throw new i("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{})}));this.addResolvingPromise(r)},r.destroy=function(){this.view.removeVoxelLayerViewFromWasm(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null)},r.isUpdating=function(){const e=this.view.voxelWasm;return!(this._wasmLayerId<0||null==e)&&e.isUpdating(this._wasmLayerId)},r.updatingFlagChanged=function(){this.notifyChange("updating")},r.whenGraphicBounds=function(e,s){const t=e.attributes["Voxel.WorldPosition"];if(t){const e=m.empty(),s=JSON.parse(t);if(y.projectVectorToVector(s,this.view.renderSpatialReference,W,this.view.spatialReference||f.WGS84))return m.expandWithVec3(e,W),Promise.resolve({boundingBox:e,screenSpaceObjects:[]})}return Promise.reject()},r.setUsedMemory=function(e){this._usedMemory=e,this._futureMemory=0},r.captureFrustum=function(){const e=this.view.voxelWasm;null!=e&&e.captureFrustum()},r.toggleFullVolumeExtentDraw=function(){const e=this.view.voxelWasm;null!=e&&e.toggleFullVolumeExtentDraw(this)},r.getLayerTimes=function(){let e=[];const s=this.view.voxelWasm;return null!=s&&(e=s.getLayerTimes(this)),e},r.getCurrentLayerTimeIndex=function(){let e=0;const s=this.view.voxelWasm;return null!=s&&(e=s.getCurrentLayerTimeIndex(this)),e},r._pushRenderModeToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushRenderModeToWasm() called, "+(s?"have WASM":"don't have WASM!!!"));null!=s&&s.setRenderMode(this,e)||this._dbg(V.Error,"VoxelLayerView3D._pushRenderModeToWasm() failed!")},r._pushSectionsToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushSectionsToWasm() called, "+(s?"have WASM":"don't have WASM!!!"));null!=s&&s.setStaticSections(this,e)||this._dbg(V.Error,"VoxelLayerView3D._pushSectionsToWasm() failed!")},r._pushCurrentVariableIdToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushCurrentVariableIdToWasm() called!, "+(null!=s?"have WASM":"don't have WASM!!!"));null!=s&&s.setCurrentVariable(this,e)||this._dbg(V.Error,"VoxelLayerView3D._pushCurrentVariableIdToWasm() failed!")},r._pushVariableStylesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushVariableStylesToWasm() called, "+(s?"have WASM":"don't have WASM!!!"));let t=!1;null!=s&&(t=s.setVariableStyles(this,e),t||this._dbg(V.Error,"VoxelLayerView3D._pushVariableStylesToWasm() failed!"))},r._accountForEnableSlices=function(e,s){const t=null!=s?s:this.layer.enableSlices;for(let i=0;i<e.length;++i){const s=e[i];for(const e of s.slices)e.enabled=e.enabled&&t}},r._pushVolumeStylesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushVolumeStylesToWasm() called, "+(s?"have WASM":"don't have WASM!!!"));let t=!1;null!=s&&(this._accountForEnableSlices(e,null),t=s.setVolumeStyles(this,e),t||this._dbg(V.Error,"VoxelLayerView3D._pushVolumeStylesToWasm() failed!"))},r._pushAnalysisSliceToWasm=function(e,s){const t=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushAnalysisSliceToWasm() called, "+(t?"have WASM":"don't have WASM!!!"));let i=!1;if(null!=t){if(null!=s){const a=s.origin;u.cross(v,s.basis1,s.basis2),u.normalize(v,v),i=t.setAnalysisSlice(this,e,a,v)}else u.set(v,0,0,1),i=t.setAnalysisSlice(this,!1,v,v);i||this._dbg(V.Error,"VoxelLayerView3D._pushAnalysisSliceToWasm() failed!")}},r._pushEnableDynamicSectionsToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushEnableDynamicSectionsToWasm() called, "+(null!=s?"have WASM":"don't have WASM!!!"));let t=!1;null!=s&&(t=s.setEnableDynamicSections(this,e),t||this._dbg(V.Error,"VoxelLayerView3D._pushEnableDynamicSectionsToWasm() failed!"))},r._pushEnableSlicesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushEnableSlicesToWasm() called, "+(s?"have WASM":"don't have WASM!!!"));let t=!1;if(null!=s){const i=this.layer.getVolumeStyles();this._accountForEnableSlices(i,e),t=s.setVolumeStyles(this,i),t||this._dbg(V.Error,"VoxelLayerView3D._pushEnableSlicesToWasm() failed!")}},r._pushEnableIsosurfacesToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushEnableIsosurfacesToWasm() called, "+(null!=s?"have WASM":"don't have WASM!!!"));let t=!1;null!=s&&(t=s.setEnableIsosurfaces(this,e),t||this._dbg(V.Error,"VoxelLayerView3D._pushEnableIsosurfacesToWasm() failed!"))},r._pushEnableSectionsToWasm=function(e){const s=this.view.voxelWasm;this._dbg(V.VerboseAPI,"VoxelLayerView3D._pushEnableSectionsToWasm() called, "+(s?"have WASM":"don't have WASM!!!"));let t=!1;null!=s&&(t=s.setEnableSections(this,e),t||this._dbg(V.Error,"VoxelLayerView3D._pushEnableSectionsToWasm() failed!"))},r.whenGraphicAttributes=async function(e,s){return e},r._dbg=function(e,s){this._dbgFlags.has(e)&&(e===V.Error?a.getLogger(this).error(s):a.getLogger(this).warn(s))},e._createClass(t,[{key:"baseUrl",get:function(){return this.layer.parsedUrl?.path??""}},{key:"wasmLayerId",get:function(){return this._wasmLayerId}},{key:"usedMemory",get:function(){return this._usedMemory}},{key:"unloadedMemory",get:function(){return this._futureMemory}},{key:"performanceInfo",get:function(){return{nodes:0,displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null}}}]),t}(w.PopupSceneLayerView(b.LayerView3D(_)));s.__decorate([r.property()],g.prototype,"layer",void 0),s.__decorate([r.property()],g.prototype,"baseUrl",null),s.__decorate([r.property({type:Boolean})],g.prototype,"slicePlaneEnabled",void 0),g=s.__decorate([h.subclass("esri.views.3d.layers.VoxelLayerView3D")],g);return g}));
