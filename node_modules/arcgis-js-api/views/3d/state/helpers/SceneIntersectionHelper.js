/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/PooledArray","../../../../core/screenUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/ray","../../../../geometry/support/vectorStacks","../../../ViewingMode","../../support/geometryUtils/ray","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/intersectorUtils"],(function(e,t,n,r,i,s,o,c,l,a,u,d,h,p){"use strict";let y=function(){function e(e,t,r){this.viewingMode=e,this._forEachLayer=t,this._view=r,this._externalIntersectionHandlers=new n,this._tolerance=d.DEFAULT_TOLERANCE,this._tmpRay=c.create(),this._tmpRegion=o.create(),this._validateHUDIntersector=d.newIntersector(this.viewingMode),this._validateHUDIntersector.options.hud=!1}var s=e.prototype;return s.intersectScreen=function(e,t,n){return this.intersectRay(this._getPickRay(e,this._tmpRay),m(this.viewingMode),t,n)},s.intersectScreenFreePointFallback=function(e,t,n){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,n)},s.intersectRayFreePointFallback=function(e,t,n){return this.intersectRay(e,m(this.viewingMode),t,n)||this._intersectRayFreePointLocal(e,t)},s.intersectRay=function(e,t,n,r){return t.options.selectionMode=!1,t.options.store=h.StoreResults.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(n)},s.getCenterRayWithSubpixelOffset=function(e,t,n=.5,r=.5){return e.getRenderCenter(P,n,r),P[0]+=.0466,P[1]-=.0123,u.fromRenderAtEye(e,P,t)},s.intersectIntersectorScreen=function(e,t,n){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,n)},s.intersectToolIntersectorScreen=function(e,t,n){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,n)},s.intersectToolIntersectorRay=function(e,t,n){t.options.selectionMode=!0,this.computeIntersection(e,t,n);const r=t.results.min;!!this._view.basemapTerrain&&this._view.basemapTerrain.opaque||p.isValidIntersectorResult(r)&&r.intersector!==h.IntersectorType.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,n))},s.setTolerance=function(e=d.DEFAULT_TOLERANCE){this._tolerance=e},s.addIntersectionHandler=function(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===h.IntersectorType.TERRAIN?1:t.type===h.IntersectorType.TERRAIN?-1:0))},s.removeIntersectionHandler=function(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===h.IntersectorType.TERRAIN?1:t.type===h.IntersectorType.TERRAIN?-1:0))},s._getPickRay=function(e,t){const n=this._view.state.camera;return u.fromScreen(n,e,t)},s._intersectRayFreePointLocal=function(e,t){return this.viewingMode!==a.ViewingMode.Local||null==e||i.add(t,e.origin,i.normalize(l.sv3d.get(),e.direction)),!1},s.intersectElevationFromScreen=function(e,t,n=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,n,r)},s._intersectElevation=function(e,t,n=0,s=null){if(null==e)return null;const o=null!=t?t.mode:"absolute-height",c=t?.offset??0,a="on-the-ground"!==o?c+n:0,u=a/this._view.renderCoordsHelper.unitInMeters;if("absolute-height"===o){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,a,w)){const e=this._view.computeMapPointFromVec3d(w);return e.z??(e.z=0),e.z-=c,e}return null}const y=this._view.state.camera,f=r.castRenderScreenPointArray3(l.sv3d.get());y.projectToRenderScreen(e.origin,f);const g=new I(null,this._forEachLayer),_=this._view.slicePlane,R=null!=_?p.sliceFilterPredicate(_):null,m=d.newIntersector(this.viewingMode);m.options.store=h.StoreResults.MIN,m.options.verticalOffset=u;const v=e.origin,P=i.add(l.sv3d.get(),v,e.direction);m.reset(v,P,y),m.point=f;const b=s?"type"in s&&"graphics"===s.type?e=>e.layerUid!==s.uid:e=>e.graphicUid!==s.uid:null;switch(o){case"relative-to-scene":{const e=e=>(!b||b(e))&&!!e.lastValidElevationBB;m.intersect(g.layers,f,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===h.IntersectorType.I3S||e.type===h.IntersectorType.TERRAIN){const t=e.slicePlaneEnabled?R:null;e.intersect(m,t,m.rayBegin,m.rayEnd,f)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?R:null;e.intersect(m,t,m.rayBegin,m.rayEnd,f)}}))}if(m.results.min.getIntersectionPoint(w)){const e=this._view.computeMapPointFromVec3d(w);return e.z=n,e}return null},s.computeIntersection=function(e,t,n){if(null==e)return;const s=this._view.state.camera,o=r.castRenderScreenPointArray3(l.sv3d.get());s.projectToRenderScreen(e.origin,o);const c=new I(n,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!n||!("include"in n||"exclude"in n);const a=e.origin,u=i.add(l.sv3d.get(),e.origin,e.direction);t.reset(a,u,s),t.intersect(c.layers,o,this._tolerance);const d=this._view.slicePlane,h=null!=d?p.sliceFilterPredicate(d):null;t.intersect(c.sliceableLayers,o,this._tolerance,h);const y=n&&(n.requiresGroundFeedback||n.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const n=e.layerUid,r=Array.isArray(n),i=r?n:[n];r&&(t.options.filteredLayerUids=[]);let s=!1;for(const o of i){!c.filterLayerUid(o)?r&&t.options.filteredLayerUids.push(o):s=!0}if(t.options.isFiltered=!s,e.isGround&&y||!t.options.isFiltered){const n=e.slicePlaneEnabled?h:null;e.intersect(t,n,a,u,o)}}));const f=l.sv3d.get(),g=this._view.basemapTerrain;if(n&&n.enableDraped&&null!=g.spatialReference&&t.results.ground.getIntersectionPoint(f)){const e=g.overlayManager.renderer,n=this._view.renderCoordsHelper.spatialReference,r=l.sv3d.get();this._view.renderCoordsHelper.fromRenderCoords(f,r,g.spatialReference),r[2]=this._view.elevationProvider?.getElevation(f[0],f[1],f[2],n,"ground")??0,e.intersect(t,r,t.results.ground,(e=>c.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)},s._processHUDResults=function(e){const t=e.results.hud;o.copy(this._tmpRegion,o.NEGATIVE_INFINITY);const n=this._view.state.camera,r=[],i=this._tmpRegion,s=e=>{const t=new R(e);n.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),r.push(t),o.expandPointInPlace(i,t.screenPoint)};e.sortResults(t.all),null!=t.min.dist&&s(t.min);for(const o of t.all)t.min.target.object!==o.target.object&&t.max.target.object!==o.target.object&&s(o);if(null!=t.max.dist&&t.max.target.object!==t.min.target.object&&s(t.max),!r.length)return;i[0]===i[2]&&(i[2]+=1),i[1]===i[3]&&(i[3]+=1);const c=n.fullWidth,l=n.fullHeight,a=Math.max(0,i[0]-f),u=Math.max(0,i[1]-f),d=Math.min(o.width(i)+2*f,c-a),p=Math.min(o.height(i)+2*f,l-u),y=new Uint8Array(d*p*4);this._view._stage.renderer.readHUDVisibility(a,u,d,p,y);let _=!0;const m=null==e.results.max.dist;let I=0;for(const o of r)for(const t of g){if(y[4*(Math.min(o.screenPoint[0]+t[0],c)-i[0]+(Math.min(o.screenPoint[1]+t[1],l)-i[1])*d)]){_&&(e.results.min.copy(o.result),_=!1),m&&e.results.max.copy(o.result),e.options.store===h.StoreResults.ALL&&e.results.all.splice(I++,0,o.result);break}}},t._createClass(e)}();const f=1,g=(()=>{const e=[],t=f;for(let n=-t;n<=t;n++)for(let r=-t;r<=t;r++)e.push([r+t,n+t]);return e})();let _,R=t._createClass((function(e){this.result=e,this.screenPoint=r.createRenderScreenPointArray3()}));function m(e){return _&&_.viewingMode===e||(_=d.newIntersector(e)),_}let I=function(){function e(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.pickable&&this.filterLayerUid(e.apiLayerUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}var n=e.prototype;return n.filterLayerUid=function(e){const{include:t,exclude:n}=this;return null==e?null==t&&null==n:(null==t||t.has(e))&&(null==n||!n.has(e))},n.filterRenderGeometry=function(e){return this.filterLayerUid(e.layerUid)},t._createClass(e)}();function v(e){return"object"==typeof e&&"intersect"in e}const w=s.create(),P=r.createRenderScreenPointArray3();e.SceneIntersectionHelper=y,e.isIntersectionHandler=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
