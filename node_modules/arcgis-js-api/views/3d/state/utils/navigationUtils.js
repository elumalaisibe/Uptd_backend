/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl-engine/lib/Camera","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,n,a,o,r,c,i,s,l,d,u,m,h,p,g,f,M,y,P){"use strict";var I;e.SpherePickPointFallback=void 0,(I=e.SpherePickPointFallback||(e.SpherePickPointFallback={}))[I.Ellipsoid=0]="Ellipsoid",I[I.Silhouette=1]="Silhouette";const A=30,S=[1,3e8],b=80,E=8,T=200,v=1508e5,R=5,O=50,_=5,x=10,z=90,N={exclude:new Set([P.TERRAIN_ID])};function D(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function k(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function C(e,t,n){const a=o.fromRotation(g.sm4d.get(),n[3],d.axis(n));null==a||o.exactEquals(a,r.IDENTITY)||(s.subtract(xe,e.eye,t),s.transformMat4(xe,xe,a),e.eye=s.add(xe,xe,t),s.subtract(xe,e.center,t),s.transformMat4(xe,xe,a),e.center=s.add(xe,xe,t),e.up=s.transformMat4(xe,e.up,a))}function F(e,t,n,a){return m.intersectRay(e,f.fromScreen(t,n,Ce),a)}function w(e,t,n,a){return m.intersectRay(e,f.fromScreenAtEye(t,n,Ce),a)}function H(e,t,n,a){const o=g.sv3d.get();let r=1-n;s.subtract(o,t,e.eye);const c=s.length(o);let i=c*(1-r);r>=0&&i<a&&(i=a,r=-(i-c)/c),Math.abs(c-i)<1e-6||(s.scale(o,o,r),e.eye=s.add(xe,e.eye,o),e.center=s.lerp(xe,e.center,t,r))}function V(e,t,n){t.getScreenCenter(q),M.intersectScreen(e,t,q,xe)&&(t.center=xe);const a=t.distance,o=a*n;if(Math.abs(a-o)<1e-6)return;const r=s.scale(g.sv3d.get(),t.viewForward,o);t.eye=s.subtract(xe,t.center,r)}const q=a.createScreenPointArray();function G(e,t){s.set(t,0,0,0);for(const n of e)s.add(t,t,n);s.scale(t,t,1/e.length)}function U(e,t,n,a){return Math.sin(e/s.length(t))*(n+a.radius)}function L(e,t,n,a){return U(Math.PI/2,t,n,a)+(e-Math.PI/2)}var Z;e.NavigationMode=void 0,(Z=e.NavigationMode||(e.NavigationMode={}))[Z.Vertical=0]="Vertical",Z[Z.Horizontal=1]="Horizontal";const X={Elevation:3e4,Angle:n.deg2rad(16)},W={Pole:.95,Angle:n.deg2rad(18),Tilt:45},j=n.deg2rad(80);function Y(t,n,a,o,r,c){const i=l.create(),d=h.create();let u=!0,m=!0;return t.intersectScreen(a,i,c)?d[3]=s.length(i):(m=!1,n.aboveGround&&r!==e.SpherePickPointFallback.Ellipsoid?d[3]=Math.max(s.length(n.center),.9*o.radius):d[3]=s.length(n.eye)-n.relativeElevation,r===e.SpherePickPointFallback.Silhouette?Q(d,n,a,i):u=M.intersectScreen(d,n,a,i)),{sphere:d,scenePickPoint:u?i:null,hasGeometryIntersection:m}}function B(t,n,a){if(s.length(t.eye)-a.radius>X.Elevation)return e.NavigationMode.Horizontal;f.fromScreenAtEye(t,n,Fe);return-Math.sign(t.relativeElevation)*(.5*Math.PI+p.angle(t.eye,Fe.direction))<X.Angle?e.NavigationMode.Vertical:e.NavigationMode.Horizontal}function J(e,t,n){s.subtract(K,n,t),e.eye=s.subtract(xe,e.eye,K),e.center=s.subtract(xe,e.center,K)}const K=l.create();function Q(e,t,n,a){const o=f.fromScreenAtEye(t,n,Ce);return null!=o&&(h.closestPointOnSilhouette(e,o,$),h.intersectRay(e,o,a)?!(s.squaredDistance($,o.origin)<s.squaredDistance(a,o.origin))||(s.copy(a,$),!1):(s.subtract(ee,t.eye,t.center),s.normalize(ee,ee),m.fromNormalAndOffset(ee,-s.dot(s.normalize(ee,ee),$),te),m.intersectRay(te,o,a),!1))}const $=l.create(),ee=l.create(),te=m.create();function ne(e,a,o,r,c,i){let d=0;if(s.cross(De,e,a),s.subtract(ze,e,a),s.length(e)<=c||!r.aboveGround){s.cross(o,ze,r.eye);const u=s.dot(e,a)/(s.length(e)*s.length(a));if(u<.9999)d=n.acosClamped(u);else{const t=s.length(s.cross(l.create(),e,a))/(s.length(e)*s.length(a));d=n.asinClamped(t)}const m=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(i)),0,j));d=-d-Math.max(0,s.length(a)-c)/(m*c)}else s.subtract(ae,r.eye,r.center),s.cross(o,ze,ae),d=-s.length(ze)/c;return s.normalize(o,o),s.scale(o,o,s.length(De)),d}const ae=l.create();function oe(e,a,o,r){let c,i;const s=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(r)),0,j));return c=a>o?-(a-o)/(s*o):a<-o?Math.PI-(a+o)/(s*o):n.acosClamped(a/o),i=e>o?-(e-o)/(s*o):e<-o?Math.PI-(e+o)/(s*o):n.acosClamped(e/o),(i-c)*o}function re(e,t,n,a,o,r,i,l,d,u){const m=oe(e[2],t[2],r[3],l),h=d?oe(e[0],t[0],r[3],180):t[0]-e[0],p=Math.sin(i)*h-Math.cos(i)*m,g=Math.cos(i)*h+Math.sin(i)*m;s.normalize(xe,o);const f=d?p/Math.sqrt(Math.abs(r[3]**2-s.dot(n,xe)**2)):p/r[3],M=g/Math.sqrt(Math.abs(r[3]**2-s.dot(n,a)**2));c.set(u,f,M)}function ce(e,t,n,a,o,r,c,i,l,d){s.cross(De,e,t),u.coordinateSystemFromOneAxisAndNormalVector(r.up,r.eye,Pe,Ie,Ae),u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],r.eye,fe,Me,ye),s.copy(n,Me),s.copy(a,fe),s.normalize(n,n),s.scale(n,n,s.length(De)),u.vectorCoordinates(e,s.normalize(Ie,Ie),s.normalize(Ae,Ae),s.normalize(Pe,Pe),Se),u.vectorCoordinates(t,Ie,Ae,Pe,be),re(Se,be,e,fe,Me,c,i,l,d,o)}function ie(e,t,n,a,r,c,i){o.fromRotation(ve,r,a),o.fromRotation(Re,i,c),o.multiply(Oe,ve,Re),s.subtract(t,e,n),s.transformMat4(t,t,Oe),s.add(t,t,n)}function se(e,t,n,a,r,c){o.fromRotation(ve,a,n),o.fromRotation(Re,c,r),o.multiply(Oe,ve,Re),s.subtract(xe,e.eye,t),s.transformMat4(xe,xe,Oe),e.eye=s.add(xe,xe,t),s.subtract(xe,e.center,t),s.transformMat4(xe,xe,Oe),e.center=s.add(xe,xe,t),s.subtract(xe,e.up,t),s.transformMat4(xe,xe,Oe),e.up=s.add(xe,xe,t)}function le(e,t,n,a,o,r){return(Math.abs(a)>Math.PI-W.Angle||Math.abs(a)<W.Angle)&&(Math.abs(e[2])<n*W.Pole||Math.abs(t)>n)&&r.aboveGround&&o<W.Tilt}function de(e,t,n,a,o,r){if(r)d.fromPoints(n,a,Te),C(t,e,Te);else{const r=ne(n,a,ke,t,e[3],o);C(t,e,d.wrapAxisAngle(ke,r))}}function ue(e,t,n,a,o,r,c){const i=c?20:1,l=1e-12;let d,u;s.copy(_e,a),Ne.copyFrom(t);for(let m=0;m<i&&s.squaredDistance(n,_e)>l&&(d=s.squaredDistance(n,_e),ce(n,_e,Me,fe,Ee,Ne,e,o,r,c),se(Ne,e,fe,Ee[1],Me,Ee[0]),ie(_e,_e,e,fe,Ee[1],Me,Ee[0]),u=s.squaredDistance(n,_e),u<d||0===m);m++)t.copyFrom(Ne)}function me(e,a,o,r,c,i,l){le(o,s.dot(a.up,o),e[3],-t.cyclicalPI.normalize(n.deg2rad(c)),i,a)?ue(e,a,o,r,-t.cyclicalPI.normalize(n.deg2rad(c)),i,l):de(e,a,o,r,i,l)}function he(e,t,n,a,r,c){const{eye:i}=e;u.coordinateSystemFromOneAxisAndNormalVector([0,0,1],i,fe,Me,ye);const l=t.translation[0]*n.pan,d="zoom"===r.mode?0:t.translation[1]*n.pan,m=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,fe)**2/s.length(e.center)**2)),.5),h=(Math.sin(c)*d+Math.cos(c)*l)/m,p=-Math.cos(c)*d+Math.sin(c)*l;switch(o.rotate(a.pan.matrix,a.pan.matrix,h,fe),a.pan.enabled=!0,r.mode){case"pan":o.rotate(a.pan.matrix,a.pan.matrix,p,Me),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}function pe(e,t,n,a,r){const{eye:c,viewRight:i}=e,l=s.cross(g.sv3d.get(),i,c),d=t.translation[0]*n.pan;switch(0!==d&&(o.rotate(a.pan.matrix,a.pan.matrix,-d,l),a.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(o.rotate(a.pan.matrix,a.pan.matrix,e,i),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}function ge(e,a,o,r,c,i,l,d,u){le(e.center,s.dot(e.up,e.center),s.length(e.center),-t.cyclicalPI.normalize(n.deg2rad(i)),l,a)?he(a,o,r,d,u,-t.cyclicalPI.normalize(n.deg2rad(c))):pe(a,o,r,d,u)}const fe=l.create(),Me=l.create(),ye=l.create(),Pe=l.create(),Ie=l.create(),Ae=l.create(),Se=l.create(),be=l.create(),Ee=i.create(),Te=d.create(),ve=r.create(),Re=r.create(),Oe=r.create(),_e=l.create(),xe=l.create(),ze=l.create(),Ne=new y.Camera,De=l.create(),ke=l.create(),Ce={origin:l.create(),direction:l.create()},Fe={origin:l.create(),direction:l.create()};e.DISTANCE_CLAMP_VALUES=S,e.MIN_HEIGHT_LIMIT=O,e.PAN_DISTANCE_MODIFIER=R,e.PIVOT_DISTANCE_MODIFIER=A,e.PreservingHeadingThreshold=W,e.ROTATE_PIVOT_DISTANCE_MODIFIER=_,e.ROTATE_PIVOT_MIN_DISTANCE_MODIFIER=x,e.ROTATE_SCREEN_PIXEL_AREA=z,e.SCREEN_PIXEL_AREA=b,e.TiltThresholdPanningSpeed=j,e.VerticalPanTresholds=X,e.ZOOM_DISTANCE_MODIFIER=E,e.ZOOM_MAX_DISTANCE_MODIFIER=v,e.ZOOM_MIN_DISTANCE_MODIFIER=T,e.applyPanPlanar=J,e.applyPanSphericalDirectRotation=de,e.applyPanSphericalPreserveHeading=ue,e.applyRotation=C,e.applyRotationWithTwoAxes=se,e.applyZoomOnSphere=V,e.applyZoomToPoint=H,e.centroid=G,e.contentIntersectorOptions=N,e.decideNavigationMode=B,e.intersectPlaneFromScreenPoint=F,e.intersectPlaneFromScreenPointAtEye=w,e.lengthFromPoints=oe,e.normalizeCoordinate=D,e.normalizeRotationDelta=k,e.offSurfaceTiltToEyeTiltGlobal=L,e.onSurfaceTiltToEyeTiltGlobal=U,e.panMotionToRotationMatrix=ge,e.panToPosition=me,e.pickPointAndInitSphere=Y,e.preserveHeadingThreshold=le,e.rotatePointAroundTwoAxes=ie,e.rotationAngleAndAxisDirectRotation=ne,e.rotationAnglesAndAxesHeadingPreserving=ce,e.rotationAnglesHeadingPreserving=re,e.sphereOrPlanePointFromScreenPoint=Q,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
