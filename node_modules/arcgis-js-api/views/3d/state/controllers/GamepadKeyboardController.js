/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/ray","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/TiltMode","../Constraints","./InteractiveController","../utils/navigationUtils","../utils/viewUtils","../../support/cameraUtils","../../support/cameraUtilsInternal","../../webgl-engine/lib/Camera","../../../navigation/gamepadAndKeyboardUtils"],(function(t,e,a,i,n,r,o,s,c,l,d,p,m,h,u,f,y,v,_,C,g,T,b,w,O,S,M,x,A,E){"use strict";t.GamepadKeyboardController=function(t){function a(e){var a;return(a=t.call(this,e)||this)._filteredSurfaceElevation=0,a._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},a._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],a._tmpCamera=new A.Camera,a._headingStart=0,a._constraintOptions={selection:C.ConstraintTypes.ALL,interactionType:g.InteractionType.NONE,interactionStartCamera:new A.Camera,interactionFactor:0,interactionDirection:null,tiltMode:T.TiltMode.LOOK_AROUND},a}e._inherits(a,t);var r=a.prototype;return r.handleEventGamepad=function(t){const e=E.extractTransformation(t,this.view.navigation.gamepad,this._transformation);("end"===t.action||E.isZeroTransformation(e))&&this.finishController()},r.activateDirection=function(t){this._keysButtonState[t]=1,E.extractTransformationKeyboard(this._keysButtonState,this._transformation)},r.deactivateDirection=function(t){this._keysButtonState[t]=0;const e=E.extractTransformationKeyboard(this._keysButtonState,this._transformation);E.isZeroTransformation(e)&&this.finishController()},r.onControllerStart=function(t){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,e._get(e._getPrototypeOf(a.prototype),"onControllerStart",this).call(this,t)},r._updateFilteredSurfaceElevation=function(t){const e=this.view.pointsOfInterest.cameraOnSurface.location.z,a=1;this._filteredSurfaceElevation+=a*(e-this._filteredSurfaceElevation)*t},r.stepController=function(t,i){this._updateStartHeading(),this._updateFilteredSurfaceElevation(t),this.currentCamera.copyViewFrom(i),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(t,this.currentCamera,P),this._applyDisabledMovementTypes(P),this._applyPan(P.pan),this._applyRotate(P.rotate),this._applyZoom(P.zoom),this._applyAscend(P.ascend),this._constraintOptions.interactionType=g.InteractionType.NONE,this._constraintOptions.selection=C.ConstraintTypes.COLLISION,_.applyAll(this.view,this.currentCamera,this._constraintOptions),e._get(e._getPrototypeOf(a.prototype),"stepController",this).call(this,t,i)},r._updateStartHeading=function(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)},r._applyRotate=function(t){if(!t.enabled)return;const e=this.currentCamera;p.subtract(k,e.center,e.eye),p.transformMat4(k,k,t.matrix),e.center=p.add(k,k,e.eye),e.up=p.transformMat4(k,e.up,t.matrix),this._constraintOptions.interactionType=g.InteractionType.LOOK_AROUND,this._constraintOptions.selection=C.ConstraintTypes.ALL_EXCEPT_COLLISION,_.applyAll(this.view,e,this._constraintOptions)},r._applyPan=function(t,e=this.currentCamera){if(!t.enabled)return;e.eye=p.transformMat4(k,e.eye,t.matrix),e.center=p.transformMat4(k,e.center,t.matrix);this.view.state.isGlobal&&(e.up=p.transformMat4(k,e.up,t.matrix)),this._constraintOptions.interactionType=g.InteractionType.PAN,this._constraintOptions.selection=C.ConstraintTypes.ALL,_.applyAll(this.view,e,this._constraintOptions)},r._applyZoom=function(t){if(!t)return;const e=this.currentCamera.viewForward;this.currentCamera.eye=p.add(k,this.currentCamera.eye,p.scale(v.sv3d.get(),e,t)),p.copy(H,e),p.negate(H,H),this._constraintOptions.interactionDirection=H,this._constraintOptions.interactionType=g.InteractionType.ZOOM,this._constraintOptions.selection=C.ConstraintTypes.ALL_EXCEPT_COLLISION,_.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null},r._applyAscend=function(t){if(!t)return;const e=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,v.sv3d.get());this._constraintOptions.interactionDirection=p.copy(H,e);if(this.view.state.isGlobal){const e=p.length(this.currentCamera.eye),a=(e+t)/e;this.currentCamera.eye=p.scale(k,this.currentCamera.eye,a),this.currentCamera.center=p.scale(k,this.currentCamera.center,a)}else{const a=p.scale(v.sv3d.get(),e,t);this.currentCamera.eye=p.add(k,this.currentCamera.eye,a),this.currentCamera.center=p.add(k,this.currentCamera.center,a)}this._updateCameraCenter(),this._constraintOptions.interactionType=g.InteractionType.ASCEND,this._constraintOptions.selection=C.ConstraintTypes.COLLISION,_.applyAll(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=C.ConstraintTypes.ALL_EXCEPT_COLLISION,_.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null},r._calculateControlTransformation=function(t,e,a){F(a);const i=this._computeVelocities(t);this.view.state.isLocal?this._calculateControlTransformationLocal(i,e,a):this._calculateControlTransformationGlobal(i,e,a)},r._updateCameraCenter=function(){const t=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,e=this.view.renderCoordsHelper,a=this.currentCamera.ray;this.currentCamera.center=e.intersectManifoldClosestSilhouette(a,t,k)},r._calculateControlTransformationLocal=function(t,e,a){const{viewRight:r,viewForward:o}=e,s=this._transformation,c=this.view.navigation.gamepad,d=p.set(v.sv3d.get(),o[0],o[1],0);p.normalize(d,d);const m=s.translation[0]*t.pan;if(0!==m){const t=p.scale(v.sv3d.get(),r,m);l.translate(a.pan.matrix,a.pan.matrix,t),a.pan.enabled=!0}switch(c.mode){case"pan":{const e=-s.translation[1]*t.pan;if(0!==e){const t=p.scale(v.sv3d.get(),d,e);l.translate(a.pan.matrix,a.pan.matrix,t),a.pan.enabled=!0}a.zoom=s.zoom*t.zoom;break}case"zoom":a.zoom=(-s.translation[1]+s.zoom)*t.zoom;break;default:i.neverReached(c.mode)}const h=s.translation[2]*t.ascend;a.ascend=h;const u=-s.heading*t.rotate;0!==u&&(l.rotate(a.rotate.matrix,a.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,v.sv3d.get())),a.rotate.enabled=!0);const f=s.tilt*t.rotate,y=S.viewAngle(this.view.renderCoordsHelper,e.center,e.eye),_=n.clamp(y+f,b.TiltDefault.min,b.TiltDefault.max)-y;_&&(l.rotate(a.rotate.matrix,a.rotate.matrix,_,r),a.rotate.enabled=!0)},r._calculateControlTransformationGlobal=function(t,e,a){const{eye:i,viewRight:n}=e,r=this._transformation,o=this.view.navigation.gamepad,s=p.cross(v.sv3d.get(),n,i);p.normalize(s,s),p.negate(s,s),O.panMotionToRotationMatrix(this.startCamera,e,r,t,this.view.camera.heading,this._headingStart,this.view.camera.tilt,a,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(P.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,d=r.translation[2]*t.ascend;a.ascend=d;const m=-r.heading*t.rotate;0!==m&&(l.rotate(a.rotate.matrix,a.rotate.matrix,m,this._tmpCamera.eye),a.rotate.enabled=!0);const h=r.tilt*t.rotate,u=this._clampTiltDeltaGlobalToValidRange(h,e.ray,c);0!==u&&(l.rotate(a.rotate.matrix,a.rotate.matrix,u,this._tmpCamera.viewRight),a.rotate.enabled=!0),a.zoom+=r.zoom*t.zoom},r._clampTiltDeltaGlobalToValidRange=function(t,e,a){const i=h.getReferenceEllipsoid(this.view.spatialReference),r=O.onSurfaceTiltToEyeTiltGlobal(b.TiltDefault.min,e.origin,a,i);let o=0,s=0;const c=v.sv3d.get();if(this.view.renderCoordsHelper.intersectManifold(e,a,c)){const t=S.viewAngle(this.view.renderCoordsHelper,c,e.origin);o=O.onSurfaceTiltToEyeTiltGlobal(t,e.origin,a,i),s=O.onSurfaceTiltToEyeTiltGlobal(b.TiltDefault.max,e.origin,a,i)}else{f.closestPointOnSilhouette(f.fromRadius(f.tmpSphere,a+i.radius),e,c);const t=Math.PI+y.angle(e.direction,c);o=O.offSurfaceTiltToEyeTiltGlobal(t,e.origin,a,i),s=O.offSurfaceTiltToEyeTiltGlobal(b.TiltDefault.max,e.origin,a,i)}return n.clamp(o+t,r,s)-o},r._getPointAbsoluteSurfaceElevation=function(t,e,a){const{renderCoordsHelper:i}=this.view,n=i.getAltitude(t),r=e+Math.abs(n-e);return i.setAltitude(a,r,t),r},r._clampedDistanceToSurface=function(t,e){const{renderCoordsHelper:a}=this.view,{camera:i}=this.view.state,{direction:n}=M.headingTiltToDirectionUp(this.view,e,0,L,N),r=a.intersectManifoldClosestSilhouette(u.wrap(e,n),t,v.sv3d.get()),o=p.distance(e,r),s=a.intersectManifoldClosestSilhouette(u.wrap(e,p.direction(v.sv3d.get(),e,i.center)),t,v.sv3d.get()),c=p.distance(e,s);return Math.min(o,c)},r._computeHeadingRotateRadius=function(t){const{renderCoordsHelper:e,state:a}=this.view,{camera:i,isGlobal:r}=a,o=e.intersectManifoldClosestSilhouette(i.ray,this._filteredSurfaceElevation,v.sv3d.get());if(r){const e=p.subtract(v.sv3d.get(),t,o),a=p.length(e);p.scale(e,e,1/a);const i=p.normalize(v.sv3d.get(),t),r=n.acosClamped(p.dot(i,e));return a*Math.sin(Math.min(z,r))}{const a=p.copy(v.sv3d.get(),t);return e.setAltitude(a,this._filteredSurfaceElevation),p.distance(o,a)}},r._minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:G},r._computeVelocities=function(t){const e=this._filteredSurfaceElevation,a=e+h.getReferenceEllipsoid(this.view.spatialReference).radius,{camera:i,isGlobal:r}=this.view.state,o=v.sv3d.get(),s=this._getPointAbsoluteSurfaceElevation(i.eye,e,o),c=this._clampedDistanceToSurface(e,o),l=i.width/2,d=D*i.width,p=D*i.width,m=c*Math.tan(.5*i.fovX)/l,u=m/a,f=m/this._computeHeadingRotateRadius(o),y=s-e;return{pan:(r?u:m)*d*t,ascend:Math.max(this._minimumAscendVelocity()*t,2**(d*t/l)*y-y),zoom:2**(d*t/l)*c-c,rotate:n.clamp(f*p,R,U)*t}},r._applyDisabledMovementTypes=function(t){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&l.identity(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&l.identity(t.rotate.matrix))},a.activatesFor=function(t,e){const a=E.extractTransformation(e,t.navigation.gamepad,I);return!("end"===e.action||E.isZeroTransformation(a))},e._createClass(a)}(w.InteractiveController),a.__decorate([r.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"gamepadDevice",void 0),a.__decorate([r.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"disableMovements",void 0),t.GamepadKeyboardController=a.__decorate([c.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],t.GamepadKeyboardController);const I={translation:[0,0,0],heading:0,tilt:0,zoom:0},L=80,z=n.deg2rad(L),D=.75,G=5,R=n.deg2rad(30),U=n.deg2rad(80),P={zoom:0,ascend:0,pan:{enabled:!1,matrix:d.create()},rotate:{enabled:!1,matrix:d.create()}},k=m.create(),H=m.create(),N=x.createDirectionUp();function F(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,l.identity(t.pan.matrix),t.rotate.enabled=!1,l.identity(t.rotate.matrix)}Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
