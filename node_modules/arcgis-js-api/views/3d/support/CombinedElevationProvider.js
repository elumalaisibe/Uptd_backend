/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/spatialReferenceUtils","../layers/graphics/ElevationQuery"],(function(e,t,n,r,i,o,s,a,l,c,u,h,v,d){"use strict";function p(e,t,n,r,i,o,s){for(const a of t){const t=a.getElevation(n,r,i,o,s);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e.CombinedElevationProvider=function(e){function n(t){var n;return(n=e.call(this,t)||this)._im=new Array,n._ground=new Array,n._scene=new Array,n._handles=new Map,n.lastElevationQuery=null,n.elevationCacheEnabled=!1,n}t._inherits(n,e);var r=n.prototype;return r.destroy=function(){this._elevationQueryCached=o.destroyMaybe(this._elevationQueryCached)},r.enableElevationCache=function(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e},r.getElevation=function(e,t,n,r,i){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&n===o.z&&v.equals(r,o.spatialReference)&&i===o.queryContext)return o.result}let o=null;return o=p(o,this._im,e,t,n,r,i),null==o&&(o=p(o,this._ground,e,t,n,r,i)),"scene"===i&&(o=p(o,this._scene,e,t,n,r,i)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:n,spatialReference:r,queryContext:i,result:o}),o},r.getSphereElevationBounds=function(e,t){let n=1/0,r=-1/0;for(const i of[this._im,this._ground,this._scene])i.forEach((i=>{if(i.getSphereElevationBounds){const o=i.getSphereElevationBounds(e,t);null!=o&&(n=Math.min(n,o.min),r=Math.max(r,o.max))}}));return{min:n,max:r}},r.queryElevation=function(e,t,n,r,i,o=null,a=0){const l=s.createResolver();return this._elevationQuery.queryElevation(e,t,o,a).then((o=>{"scene"===i&&(o=p(o,this._scene,e,t,n,r,i)),l.resolve(o)})).catch((o=>{s.isAbortError(o)?l.reject(o):l.resolve(this.getElevation(e,t,n,r,i))})),l.promise},r.register=function(e,t){this._handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this._providersFromContext(e).push(t)},r.unregister=function(e){this._handles.has(e)&&(this._handles.get(e)?.remove(),this._handles.delete(e));for(const t of[this._im,this._ground,this._scene]){const n=t.indexOf(e);n>-1&&t.splice(n,1)}},r._providersFromContext=function(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}},t._createClass(n,[{key:"spatialReference",get:function(){return this.view?.basemapTerrain?.spatialReference}},{key:"_elevationQuery",get:function(){return null==this._elevationQueryCached&&(this._elevationQueryCached=new d.ElevationQuery(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQueryCached}}]),n}(i.EventedMixin(r)),n.__decorate([a.property({constructOnly:!0})],e.CombinedElevationProvider.prototype,"view",void 0),n.__decorate([a.property()],e.CombinedElevationProvider.prototype,"spatialReference",null),e.CombinedElevationProvider=n.__decorate([h.subclass("esri.views.3d.support.CombinedElevationProvider")],e.CombinedElevationProvider),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
