/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/MemCache","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./MemoryManagedView"],(function(e,t,i,r,a,o,s,n,u,y,c,l){"use strict";function _(e){return new g({view:e})}const h=1,d=1,m=.75,p=.6,M=1.3;let g=function(e){function i(t){var i;return(i=e.call(this,t)||this)._quality=1,i._usedMemory=0,i._updating=!1,i.minQuality=.1,i._stableQuality=0,i._downscaleMemoryUsed=0,i._canFastRecover=!1,i._memoryPredicted=0,i._cacheStorage=new o.MemCacheStorage,i._warnMemoryUsage=null,i._numQualityChanges=0,i._maxMemory=750,i._additionalCacheMemory=0,i}t._inherits(i,e);var r=i.prototype;return r.destroy=function(){this._cacheStorage.destroy()},r.newCache=function(e,t){return new o.MemCache(e,this._cacheStorage,t)},r.resetStableQuality=function(){this._stableQuality=0},r.disableMemCache=function(){this.additionalCacheMemory=-4096},r.update=function(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<p&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(h);else if(e)(this._memoryPredicted>1.1*d||this._usedMemory>d)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/M),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>d)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/M),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<m&&this._quality<h){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e},r._updateQuality=function(e){return(e=Math.min(Math.max(e,this.minQuality),h))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)},r._layersUpdating=function(){return this.view.allLayerViews.some((e=>!!e.updating))},r._updateMemory=function(){if(!this.view)return;let e=0;this.view.basemapTerrain&&(e+=this.view.basemapTerrain.usedMemory);const t=this.view?._stage&&this.view._stage.renderView&&this.view._stage.renderer?.edgeView;null!=t&&(e+=t.usedMemory);let i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((t=>{if(l.isMemoryManagedView(t)){const r=t.ignoresMemoryFactor?this._quality:1;e+=t.usedMemory*r,i+=t.unloadedMemory*r}}));const r=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),o=1048576*this.maxMemory;if(e>o&&r){this._warnMemoryUsage=e;const t=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);a.getLogger(this).warn(`Memory Limit exceeded! Limit: ${t(o)} Current: ${t(e)} Projected: ${t(e+i)} Quality: ${r}%`)}this._usedMemory=e/o,this._memoryPredicted=(e+i)/o;const s=o-e;this._cacheStorage.maxSize=Math.max(0,s+1048576*this.additionalCacheMemory)},t._createClass(i,[{key:"maxMemory",get:function(){return this._maxMemory},set:function(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(h),this._maxMemory=e)}},{key:"additionalCacheMemory",get:function(){return this._additionalCacheMemory},set:function(e){null!=e&&(this._additionalCacheMemory=e)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._usedMemory}},{key:"test",get:function(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}]),i}(r);i.__decorate([s.property({constructOnly:!0})],g.prototype,"view",void 0),i.__decorate([s.property()],g.prototype,"maxMemory",null),i.__decorate([s.property()],g.prototype,"additionalCacheMemory",null),i.__decorate([s.property()],g.prototype,"memoryFactor",null),i.__decorate([s.property()],g.prototype,"updating",null),i.__decorate([s.property()],g.prototype,"usedMemory",null),i.__decorate([s.property()],g.prototype,"_quality",void 0),i.__decorate([s.property()],g.prototype,"_usedMemory",void 0),i.__decorate([s.property()],g.prototype,"_updating",void 0),i.__decorate([s.property()],g.prototype,"_stableQuality",void 0),i.__decorate([s.property()],g.prototype,"_maxMemory",void 0),i.__decorate([s.property()],g.prototype,"_additionalCacheMemory",void 0),g=i.__decorate([c.subclass("esri.views.3d.support.MemoryController")],g),e.newMemoryController=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
