/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../support/Scheduler"],(function(e,t,r,s,o,u,n,i,a,c){"use strict";e.TextureCollection=function(e){function r(t,r){var s;return(s=e.call(this,{})||this)._stage=t,s._textureRequests=new Map,s._frameTask=r?.registerTask(c.TaskPriority.TEXTURE_UNLOAD)??c.ImmediateTask,s}t._inherits(r,e);var s=r.prototype;return s.normalizeCtorArgs=function(){return{}},s.destroy=function(){t._get(t._getPrototypeOf(r.prototype),"destroy",this).call(this),this._frameTask?.remove(),this._textureRequests?.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests?.clear()},s.fromData=function(e,t,r){const s=this.makeUid(e);let o=this._textureRequests.get(s);if(!o){const e=new l(r);e.texture=t(),this._stage?.add(e.texture),this._stage?.loadImmediate(e.texture),this._textureRequests.set(s,e),o=e}return o.referenceCount++,{uid:s,texture:o.texture,release:()=>this._release(s)}},s._release=function(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)},s._releaseNow=function(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this._releaseTextureRequest(t),this._textureRequests.delete(e))},s._releaseTextureRequest=function(e){e.onRemove&&e.onRemove(),e.texture?this._stage?.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)},s.makeUid=function(e,t=null){return null!=t?`${e}.${t}px`:e},t._createClass(r,[{key:"updating",get:function(){return this._frameTask.updating}},{key:"test",get:function(){return{textureRequests:this._textureRequests}}}]),r}(s),r.__decorate([o.property()],e.TextureCollection.prototype,"_frameTask",void 0),r.__decorate([o.property()],e.TextureCollection.prototype,"updating",null),e.TextureCollection=r.__decorate([a.subclass("esri.views.3d.support.TextureCollection")],e.TextureCollection);let l=t._createClass((function(e){this.onRemove=e,this.referenceCount=0}));e.TextureRequest=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
