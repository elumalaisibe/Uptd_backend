/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/compilerUtils","../../../core/mathUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","../../ViewingMode","./intersectionUtils"],(function(e,t,n,i,r,o,s,a,c,l,d,p,h,u,_,g,x,f){"use strict";const m=.5*Math.PI,R=m/Math.PI*180;let y=function(){function e(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:a.create(),direction:a.create()};for(let t=0;t<4;t++)this._extent[t]={origin:a.create(),direction:a.create(),cap:{next:null,direction:a.create()}},this._planes[t]=_.create();this._planes[h.PlaneIndex.NEAR]=_.create(),this._planes[h.PlaneIndex.FAR]=_.create(),this._planesWithoutFar=this._planes.slice(0,5)}var o=e.prototype;return o.update=function(e,t,n,i=!0){const r=this._extent;this._toRenderBoundingExtent(e,t,n),s.add(this._center.origin,r[0].origin,r[2].origin),s.scale(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),i||s.scale(this._center.direction,this._center.direction,-1);for(let o=0;o<4;o++){const e=r[o];this._renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const t=r[3===o?0:o+1];e.cap.next=t.origin,s.direction(e.cap.direction,e.origin,t.origin),_.fromVectorsAndPoint(e.direction,e.cap.direction,e.origin,this._planes[o]),i||s.scale(e.direction,e.direction,-1)}_.fromVectorsAndPoint(r[0].cap.direction,r[1].cap.direction,r[0].origin,this._planes[h.PlaneIndex.NEAR]),i?_.negate(this._planes[h.PlaneIndex.NEAR],this._planes[h.PlaneIndex.FAR]):(_.copy(this._planes[h.PlaneIndex.FAR],this._planes[h.PlaneIndex.NEAR]),_.negate(this._planes[h.PlaneIndex.NEAR],this._planes[h.PlaneIndex.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*c.getReferenceEllipsoid(this._maxSpanSpatialReference).radius},o.isVisibleInFrustum=function(e,t,n=!1){if(null==e)return!1;if(this._renderCoordsHelper.viewingMode===x.ViewingMode.Global){const n=this._maxSpanSpatialReference.isGeographic?R:m*t;if(this._maxSpan>n)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){const t=this._extent[0];return!(n||!e.intersectsRay(g.wrap(t.origin,t.direction)))}for(let r=0;r<this._extent.length;r++){const t=this._extent[r];if(!n&&e.intersectsRay(g.wrap(t.origin,t.direction)))return!0;if(e.intersectsLineSegment(u.fromPoints(t.origin,t.cap.next,S),t.cap.direction))return!0}const i=n?this._planes:this._planesWithoutFar;for(let r=0;r<e.lines.length;r++){const t=e.lines[r];if(f.frustumLineSegment(i,t.origin,t.endpoint,t.direction))return!0}return!1},o._toRenderBoundingExtentGlobal=function(e,t,n){const o=5;p.center(e,P),P[2]=n,l.computeTranslationToOriginAndRotation(t,P,b,this._renderCoordsHelper.spatialReference),r.invert(I,b),d.empty(E);for(const{x0:r,x1:a,y0:c,y1:p}of A)for(let h=0;h<o;h++){const u=h/(o-1);P[0]=i.lerp(e[r],e[a],u),P[1]=i.lerp(e[c],e[p],u),P[2]=n,l.projectVectorToVector(P,t,P,this._renderCoordsHelper.spatialReference),s.transformMat4(P,P,I),d.expandWithVec3(E,P)}s.set(this._extent[0].origin,E[0],E[1],E[2]),s.set(this._extent[1].origin,E[3],E[1],E[2]),s.set(this._extent[2].origin,E[3],E[4],E[2]),s.set(this._extent[3].origin,E[0],E[4],E[2]);for(let i=0;i<4;++i)s.transformMat4(this._extent[i].origin,this._extent[i].origin,b)},o._toRenderBoundingExtentLocal=function(e,t,n){l.projectBoundingRect(e,t,M,this._renderCoordsHelper.spatialReference),s.set(this._extent[0].origin,M[0],M[1],n),s.set(this._extent[1].origin,M[2],M[1],n),s.set(this._extent[2].origin,M[2],M[3],n),s.set(this._extent[3].origin,M[0],M[3],n)},o._toRenderBoundingExtent=function(e,t,i){switch(this._renderCoordsHelper.viewingMode){case x.ViewingMode.Global:this._toRenderBoundingExtentGlobal(e,t,i);break;case x.ViewingMode.Local:this._toRenderBoundingExtentLocal(e,t,i);break;default:n.neverReached(this._renderCoordsHelper.viewingMode)}},o._isVisibleInFrustumGlobal=function(e){if(_.signedDistance(e.planes[h.PlaneIndex.NEAR],this._center.origin)<0&&s.dot(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const n=this._extent[t];if(_.signedDistance(e.planes[h.PlaneIndex.NEAR],n.origin)<0&&s.dot(n.direction,e.direction)<0)return!0}return!1},t._createClass(e)}();const A=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],P=a.create(),b=o.create(),I=o.create(),E=d.create(),M=p.create(),S=u.create();e.FrustumExtentIntersection=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
