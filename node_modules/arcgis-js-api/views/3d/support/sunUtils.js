/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/mathUtils","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec2f64","../../../chunks/vec3","../../../chunks/vec3f64","../../ViewingMode","../../../chunks/SunCalc","./mathUtils"],(function(t,e,n,i,o,l,a,r,c,s,u,m){"use strict";const f={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};let d=e._createClass((function(t,e){this.direct=t,this.ambient=e}));function g(t,e,i,o,l,a){r.set(a.ambient.color,1,1,1),a.ambient.intensity=f.global.ambient,r.set(a.direct.color,1,1,1),a.direct.intensity=f.global.direct;const s=e[2],m=n.clamp((Math.abs(s)-f.local.altitude)/(f.global.altitude-f.local.altitude),0,1);let d;if(a.globalFactor=m,null!=t&&(d=u.SunCalc.getTimes(t,e[1],e[0])),m<1){let e;if(null!=t)e=j(t,d,o);else{const t=v(o);e={direct:{intensity:f.local.directAtNoon*t.direct,color:c.fromValues(1,1,1)},ambient:{intensity:f.local.ambientAtNoon*t.ambient,color:c.fromValues(1,1,1)},timeOfDay:"early afternoon"}}r.lerp(a.ambient.color,e.ambient.color,a.ambient.color,m),a.ambient.intensity=n.lerp(e.ambient.intensity,a.ambient.intensity,m),r.lerp(a.direct.color,e.direct.color,a.direct.color,m),a.direct.intensity=n.lerp(e.direct.intensity,a.direct.intensity,m),a.specularStrength="rainy"===o||"snowy"===o||"foggy"===o?0:1,a.environmentStrength="rainy"===o?.7:"snowy"===o||"foggy"===o?.75:1}a.noonFactor=null!=t?S(t,d):1,null!=t?p(t,e,i,a.direct.directionToLightSource):h(l,i,a.direct.directionToLightSource)}function h(t,e,n){e===s.ViewingMode.Global?r.normalize(Z,t.eye):r.set(Z,0,0,1),r.scale(q,t.viewForward,-1);const o=m.angle(q,Z),l=Math.max(o-2*K,0),a=.85*l/(l+1),c=Math.max(K,o-K-a);i.fromRotation(Y,-c,t.viewRight),r.transformMat4(n,q,Y),r.add(n,n,r.scale(J,t.viewRight,Q)),r.normalize(n,n)}function p(t,e,o,l){const a=M,c=i.identity(V);if(o===s.ViewingMode.Global)u.SunCalc.getPosition(t,0,0,a),r.set(l,0,0,-1),i.rotateX(c,c,-a.azimuth),i.rotateY(c,c,-a.altitude),r.transformMat4(l,l,c);else{const o=f.planarDirection,s=o.globalAngles,m=e[2];let d=(Math.abs(m)-o.localAltitude)/(o.globalAltitude-o.localAltitude);d=n.clamp(d,0,1),d<1?(u.SunCalc.getPosition(t,e[1],e[0],a),a.azimuth=(1-d)*a.azimuth+d*s.azimuth,a.altitude=(1-d)*a.altitude+d*s.altitude):(a.azimuth=s.azimuth,a.altitude=s.altitude),r.set(l,0,-1,0),i.rotateZ(c,c,-a.azimuth),i.rotateX(c,c,-a.altitude),r.transformMat4(l,l,c)}}function b(t,e){if(e===s.ViewingMode.Global)return!0;const n=f.planarDirection;return Math.abs(t)<n.localAltitude}function y(t,e,n,i,o){const l=t.getTime(),a=e.getTime()-l,r=Math.floor(a/n)+1,s=new Array(r);for(let u=0;u<r;++u)B.setTime(l+n*u),s[u]=c.create(),p(B,i,o,s[u]);return s}const A=c.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258);let w=e._createClass((function(){this.ambient={color:c.fromValues(1,1,1),intensity:.55},this.direct={color:c.fromValues(1,1,1),intensity:.55,directionToLightSource:c.clone(A)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}));const V=o.create(),M={azimuth:0,altitude:0};function S(t,e){const i=t.valueOf();let o,l;e.polarException===u.SunCalc.PolarException.MIDNIGHT_SUN?(o=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,l=o+432e6):e.polarException===u.SunCalc.PolarException.POLAR_NIGHT?(o=i-2,l=i-1):(o=e.sunrise.valueOf(),l=e.sunset.valueOf());const a=o+(l-o)/2;return 1-n.clamp(Math.abs(i-a)/432e5,0,1)}function v(t){switch(t){case"disabled":case"sunny":case"cloudy":return new d(1,1);case"rainy":return new d(.4,1.2);case"snowy":return new d(.5,1.3);case"foggy":return new d(.2,1.6)}}function T(t,e){const n=(t[0]+t[1]+t[2])/3;t[0]+=(n-t[0])*e,t[1]+=(n-t[1])*e,t[2]+=(n-t[2])*e}const N=c.fromValues(.01,.01,.01),C=c.fromValues(1,.6,.5),O=c.fromValues(1,.98,.98),P=c.fromValues(1,1,1),x=c.fromValues(.8,.8,1),z=c.fromValues(.8,.8,1),D=c.fromValues(.98,.98,1),I=c.fromValues(1,1,1),k=a.fromValues(.01,f.local.ambientAtNight),E=a.fromValues(f.local.directAtTwilight,f.local.ambientAtTwilight),G=a.fromValues(.9*f.local.directAtNoon,f.local.ambientAtNoon),H=a.fromValues(f.local.directAtNoon,f.local.ambientAtNoon),_=G,L=O,F=D,R=E,U=C,X=z;function j(t,e,n){const i=t.valueOf();let o,s;e.polarException===u.SunCalc.PolarException.MIDNIGHT_SUN?(o=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,s=o+432e6):e.polarException===u.SunCalc.PolarException.POLAR_NIGHT?(o=i-2,s=i-1):(o=e.sunrise.valueOf(),s=e.sunset.valueOf());const m=s-o,f=o+m/2,d=m/4,g=f-d,h=f+d,p=.06*m,b=o-p/2,y=o+p/2,A=s-p/2,w=s+p/2,V=a.create(),M=c.create(),S=c.create();let j="";if(i<b||i>w)l.copy(V,k),r.copy(M,N),r.copy(S,x),j="night";else if(i<y){const t=(i-b)/(y-b);l.lerp(V,k,E,t),r.lerp(M,N,C,t),r.lerp(S,x,z,t),j="sun rising"}else if(i<g){const t=(i-y)/(g-y);l.lerp(V,E,G,t),r.lerp(M,C,O,t),r.lerp(S,z,D,t),j="early morning"}else if(i<f){const t=(i-g)/(f-g);l.lerp(V,G,H,t),r.lerp(M,O,P,t),r.lerp(S,D,I,t),j="late morning"}else if(i<h){const t=(i-f)/(h-f);l.lerp(V,H,_,t),r.lerp(M,P,L,t),r.lerp(S,I,F,t),j="early afternoon"}else if(i<A){const t=(i-h)/(A-h);l.lerp(V,_,R,t),r.lerp(M,L,U,t),r.lerp(S,F,X,t),j="late afternoon"}else if(i<w){const t=(i-A)/(w-A);l.lerp(V,R,k,t),r.lerp(M,U,N,t),r.lerp(S,X,x,t),j="sun setting"}let B=0;switch(n){case"rainy":case"foggy":B=.8;break;case"snowy":B=.5}B>0&&(T(M,B),T(S,B));const Y=v(n);return{direct:{intensity:V[0]*Y.direct,color:M},ambient:{intensity:V[1]*Y.ambient,color:S},timeOfDay:j}}const B=new Date(0),Y=o.create(),Z=c.create(),q=c.create(),J=c.create(),K=.25,Q=.2;t.ColorAndIntensity=w,t.computeColorAndIntensity=g,t.computeDirectionsOverTime=y,t.computeShadowsEnabled=b,t.computeVirtualLightDirection=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
