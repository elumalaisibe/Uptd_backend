/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/handleUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/signal","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./index","./MemoryController","./StreamDataLoader","../../support/Scheduler"],(function(e,t,r,a,o,s,i,n,l,d,u,c,p,_,h,m,y,g,v){"use strict";let k=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).updating=!1,t}return t._inherits(r,e),t._createClass(r)}(a);function T(e){return new f({view:e})}r.__decorate([u.property({readOnly:!0})],k.prototype,"updating",void 0),k=r.__decorate([h.subclass("esri.views.3d.support.ResourceControllerMain")],k);let f=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._immediateTask=v.ImmediateTask,t._normalTask=v.ImmediateTask,t._updatingObjects=l.signal([]),t._frameTask=null,t}t._inherits(r,e);var a=r.prototype;return a.initialize=function(){this._scheduler=v.newScheduler(),this._memoryController=y.newMemoryController(this.view),this._streamDataLoader=new g.StreamDataLoader,this._streamDataLoader.setup(m.maxDownloadSlots,m.downloadSlotsPerClient,this._scheduler),this.addHandles([i.watch((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),i.sync),i.watch((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=n.addFrameTask({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(v.TaskPriority.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(v.TaskPriority.RESOURCE_CONTROLLER)},a.destroy=function(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=s.removeMaybe(this._frameTask),this._streamDataLoader=s.destroyMaybe(this._streamDataLoader),this._memoryController=s.destroyMaybe(this._memoryController),this._scheduler=s.destroyMaybe(this._scheduler),this.view=null},a.createStreamDataRequester=function(e){const t=this._streamDataLoader;return{request:(r,a,o)=>t.request(r,a,e,o),get busy(){return!t.hasDownloadSlots(e)}}},a.addUpdatingObject=function(e){const t=this._updatingObjects;return t.value=[...t.value,e],o.makeHandle((()=>{t.value=t.value.filter((t=>t!==e))}))},a._frame=function(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(d.secondsFromMilliseconds(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())},a._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()},t._createClass(r,[{key:"immediate",get:function(){return this._immediateTask}},{key:"normal",get:function(){return this._normalTask}},{key:"updating",get:function(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some((e=>e.updating))}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"test",get:function(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}}]),r}(k);r.__decorate([u.property()],f.prototype,"view",void 0),r.__decorate([u.property()],f.prototype,"_scheduler",void 0),r.__decorate([u.property()],f.prototype,"_memoryController",void 0),r.__decorate([u.property()],f.prototype,"_streamDataLoader",void 0),r.__decorate([u.property()],f.prototype,"_immediateTask",void 0),r.__decorate([u.property()],f.prototype,"_normalTask",void 0),r.__decorate([u.property()],f.prototype,"_updatingObjects",void 0),r.__decorate([u.property({readOnly:!0})],f.prototype,"updating",null),f=r.__decorate([h.subclass("esri.views.3d.support.ResourceControllerImpl")],f),e.newResourceController=T,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
