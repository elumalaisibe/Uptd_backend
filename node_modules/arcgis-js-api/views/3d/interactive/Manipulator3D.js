/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../geometry","../../../core/compilerUtils","../../../core/Evented","../../../core/mathUtils","../../../core/maybe","../../../core/screenUtils","../../../core/accessorSupport/utils","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec2","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/projection","../../../geometry/support/aaBoundingRect","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","../../../geometry/support/vectorStacks","../../../layers/graphics/hydratedFeatures","../support/ElevationProvider","../support/geometryUtils/ray","../webgl-engine/lib/Camera","../webgl-engine/lib/Object3D","../webgl-engine/lib/UpdatePolicy","../webgl-engine/lib/WebGLLayer","../../interactive/interfaces","../../../geometry/Point"],(function(e,t,i,n,o,s,r,a,c,l,h,u,d,_,f,g,y,m,p,b,v,S,L,R,j,O,A,w,T,E,P,k){"use strict";let M=function(){function e(e){this.metadata=void 0,this._camera=new A.Camera,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=d.create(),this._worldFrame=null,this._renderLocation=g.create(),this._renderLocationDirty=!0,this._location=new k({x:0,y:0,z:0}),this._elevationAlignedLocation=new k,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=P.ManipulatorStateCustomFlags.None,this._focused=!1,this.events=new o.EventEmitter,this._screenLocation={screenPointArray:a.createScreenPointArray(),renderScreenPointArray:a.createRenderScreenPointArray3(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference,Object.assign(this,e);const t=this.view.state?.camera;t&&this._camera.copyFrom(t)}var i=e.prototype;return i.destroy=function(){this._applyObjectTransform=J,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null},i.disableDisplay=function(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:c.once((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}},i._notifyLocationChanged=function(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})},i._updateElevationAlignedLocation=function(){const e=null!=this._elevation.override?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=R.hydratedSpatialReference(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1},i.grabbableForEvent=function(){return!0},i.updateStateEnabled=function(e,t){t?this.state|=e:this.state&=~e},i._setFocused=function(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))},i._ensureScreenLocation=function(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(F(this._modelTransform)){const t=this._calculateModelTransformOffset(Y);e=f.add(t,t,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)},i.intersectionDistance=function(e,t){if(!this.available)return null;const i=a.screenPointObjectToArray(e,C),o=this._getCollisionRadius(t),s=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(_.squaredDistance(this.screenLocation.screenPointArray,i)<o*o)return this.screenLocation.renderScreenPointArray[2]+s;break;case"line":{const e=this.collisionType.paths,t=this._getWorldToScreenObjectScale(),n=this._calculateObjectTransform(t,W),r=o*this.screenLocation.pixelSize,c=O.fromScreen(this._camera,i,I);if(null==c)return null;for(const i of e){if(0===i.length)continue;const e=f.transformMat4(N,i[0],n);for(let t=1;t<i.length;t++){const o=f.transformMat4(H,i[t],n),l=b.closestRayDistance2(b.fromPoints(e,o,z),c);if(null!=l&&l<r*r){const t=f.add(L.sv3d.get(),e,o);f.scale(t,t,.5);const i=a.castRenderScreenPointArray(L.sv3d.get());return this._camera.projectToRenderScreen(t,i),i[2]+s}f.copy(e,o)}}break}case"disc":{const e=this.collisionType.direction,t=this.collisionType.offset??g.ZEROS,n=this._getWorldToScreenObjectScale(),r=this._calculateObjectTransform(n,W),a=o*this.screenLocation.pixelSize,c=O.fromScreen(this._camera,i,I);if(null==c)return null;const h=l.fromMat4(x,r),u=f.transformMat3(G,e,h),d=f.transformMat4(V,t,r);v.fromPositionAndNormal(d,u,B);const _=q;if(v.intersectRay(B,c,_)&&f.squaredDistance(_,d)<a*a)return this.screenLocation.renderScreenPointArray[2]+s;break}case"ribbon":{const{paths:e,direction:t}=this.collisionType,n=this._getWorldToScreenObjectScale(),r=this._calculateObjectTransform(n,W),c=o*this._camera.computeScreenPixelSizeAt(this.renderLocation),h=O.fromScreen(this._camera,i,I);if(null==h)return null;const u=l.fromMat4(x,r),d=f.transformMat3(G,t,u),_=this._calculateModelTransformPosition(V);v.fromPositionAndNormal(_,d,B);const g=q;if(!v.intersectRay(B,h,g))break;for(const i of e){if(0===i.length)continue;const e=f.transformMat4(N,i[0],r);for(let t=1;t<i.length;t++){const n=f.transformMat4(H,i[t],r),o=b.distance2(b.fromPoints(e,n,z),g);if(null!=o&&o<c*c){const t=f.add(L.sv3d.get(),e,n);f.scale(t,t,.5);const i=a.castRenderScreenPointArray(L.sv3d.get());return this._camera.projectToRenderScreen(t,i),i[2]+s}f.copy(e,n)}}break}default:n.neverReached(this.collisionType)}return null},i.attach=function(e={manipulator3D:{}}){const t=this._stage;if(!t)return;const i=e.manipulator3D;null==i.engineLayerId?(this._engineLayer=new E.WebGLLayer(t,{pickable:!1,updatePolicy:T.UpdatePolicy.SYNC}),i.engineLayerId=this._engineLayer.id):t?.getObject&&(this._engineLayer=t.getObject(i.engineLayerId)),i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,null==this._materialIdReferences&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),m.canProjectWithoutEngine(this._location.spatialReference,this.view.spatialReference)||(this.location=new k({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))},i.detach=function(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=0===t.engineLayerReferences;this._removeResourcesFromStage(),i&&(t.engineLayerId=null,r.destroyMaybe(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1},i.onViewChange=function(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()},i.onElevationChange=function(e){m.projectPoint(this.location,Z,e.spatialReference)&&p.containsPointObject(e.extent,Z)&&this._notifyLocationChanged()},i._evaluateElevationAlignment=function(){if(null==this.elevationInfo)return;let e=null,t=0;const i=this.elevationInfo.offset??0;switch(this.elevationInfo.mode){case"on-the-ground":e=j.getElevationAtPoint(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":t=(j.getElevationAtPoint(this.view.elevationProvider,this.location,"ground")??0)+i;break;case"relative-to-scene":t=(j.getElevationAtPoint(this.view.elevationProvider,this.location,"scene")??0)+i;break;case"absolute-height":t=i}return t!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=t,void(this._elevation.override=e)):void 0},i._updateEngineObject=function(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=W;if(!0===this.autoScaleRenderObjects){const i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),n=(this.focused?P.ManipulatorStateFlags.Focused:P.ManipulatorStateFlags.Unfocused)|(this.selected?P.ManipulatorStateFlags.Selected:P.ManipulatorStateFlags.Unselected),o=this._noDisplayCount>0;for(const{stateMask:s,objects:r}of i){if(o){for(const e of r)e.visible=!1;continue}const e=(s&P.ManipulatorStateFlags.All)!==P.ManipulatorStateFlags.None,i=(s&P.ManipulatorStateCustomFlags.All)!==P.ManipulatorStateCustomFlags.None,a=!e||(n&s)==(s&P.ManipulatorStateFlags.All),c=!i||(this.state&s)==(s&P.ManipulatorStateCustomFlags.All);if(a&&c)for(const n of r)n.visible=!0,n.transformation=t;else for(const t of r)t.visible=!1}},i._ensureEngineResources=function(){if(null==this._engineResources){const e=this._engineLayer,t=[],i=new Set;this.renderObjects.forEach((({geometry:{material:e}})=>{i.has(e)||(t.push(e),i.add(e))}));const n=new Map;this._renderObjects.forEach((e=>{const t=new w.Object3D({castShadow:!1,geometries:[e.geometry]}),i=n.get(e.stateMask)||[];i.push(t),n.set(e.stateMask,i)}));const o=[];n.forEach(((e,t)=>o.push({stateMask:t,objects:e}))),this._engineResources={objectsByState:o,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources},i._addResourcesToStage=function(){const e=this._stage;if(this._engineResourcesAddedToStage||null==this._engineResources||!e)return;const{objectsByState:t,layer:i,materials:n}=this._engineResources;n.forEach((t=>{const i=this._materialIdReferences,n=i.get(t.id)||0;0===n&&e.add(t),i.set(t.id,n+1)})),t.forEach((({objects:t})=>{i.addMany(t),e.addMany(t)})),this._engineResourcesAddedToStage=!0},i._removeResourcesFromStage=function(){const e=this._stage;if(!this._engineResourcesAddedToStage||null==this._engineResources||!e)return;const{objectsByState:t,layer:i,materials:n}=this._engineResources;t.forEach((({objects:t})=>{i.removeMany(t),e.removeMany(t)})),n.forEach((t=>{const i=this._materialIdReferences,n=i.get(t.id);1===n?(e.remove(t),i.delete(t.id)):i.set(t.id,n-1)})),this._engineResourcesAddedToStage=!1},i._getCollisionRadius=function(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)},i._getFocusedSize=function(e,t){return e*(t?this.focusMultiplier:1)},i._getWorldToScreenObjectScale=function(){return this._worldSized?1:this.screenLocation.pixelSize},i._calculateModelTransformPosition=function(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,U);return f.set(e,i[12],i[13],i[14])},i._calculateModelTransformOffset=function(e){const t=this._calculateModelTransformPosition(e);return f.subtract(e,t,this.renderLocation)},i._calculateObjectTransform=function(e,t){return u.set(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&u.multiply(t,t,this._worldFrame),u.multiply(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,null!=this._applyObjectTransform&&this._applyObjectTransform(t),t},t._createClass(e,[{key:"_stage",get:function(){return this.view?._stage}},{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}},{key:"renderObjects",get:function(){return this._renderObjects},set:function(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}},{key:"available",get:function(){return this._available},set:function(e){e!==this._available&&(this._available=e,this._updateEngineObject())}},{key:"radius",get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}},{key:"worldSized",get:function(){return this._worldSized},set:function(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}},{key:"modelTransform",get:function(){return this._modelTransform},set:function(e){F(e)&&(this._screenLocationDirty=!0),u.copy(this._modelTransform,e),this._updateEngineObject()}},{key:"renderLocation",get:function(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=d.create()),D(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation},set:function(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}},{key:"location",get:function(){return this._location},set:function(e){R.clonePoint(e,this._location),this._notifyLocationChanged()}},{key:"elevationAlignedLocation",get:function(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation},set:function(e){R.clonePoint(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}},{key:"grabbing",get:function(){return this._grabbing},set:function(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},{key:"hovering",get:function(){return this._hovering},set:function(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},{key:"selected",get:function(){return this._selected},set:function(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}},{key:"state",get:function(){return this._state},set:function(e){e!==this._state&&(this._state=e,this._updateEngineObject())}},{key:"focused",get:function(){return this._focused}},{key:"screenLocation",get:function(){return this._ensureScreenLocation(),this._screenLocation}},{key:"applyObjectTransform",get:function(){return this._applyObjectTransform},set:function(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}},{key:"attached",get:function(){return this._attached}},{key:"test",get:function(){let e=!1;if(null!=this._engineResources)for(const t in this._engineResources.objectsByState){const i=this._engineResources.objectsByState[t];for(const t of i.objects)if(t.visible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}]),e}();function F(e){return 0!==e[12]||0!==e[13]||0!==e[14]}function D(e,t,i){switch(e.viewingMode){case"local":return u.identity(i),!0;case"global":{const n=y.getReferenceEllipsoid(e.renderCoordsHelper.spatialReference);return m.sphericalPCPFtoLonLatElevation(t,0,N,0,n.radius),m.computeENUToSphericalPCPFLocalRotation(s.deg2rad(N[0]),s.deg2rad(N[1]),i),!0}}}const C=a.createScreenPointArray(),z=b.create(),I=S.create(),x=h.create(),U=d.create(),W=d.create(),B=v.create(),N=g.create(),H=g.create(),q=g.create(),G=g.create(),V=g.create(),Y=g.create(),Z=new k({x:0,y:0,z:0,spatialReference:null}),J=()=>{};e.Manipulator3D=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
