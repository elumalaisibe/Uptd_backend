/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec2f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4","../../../../chunks/vec4f32","../../../../layers/graphics/dehydratedFeatures","./EngineVisualElement","../../terrain/OverlayRenderer","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Material","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,r,i,a,s,c,n,o,u,d,l,h,_,m,p,f,y){"use strict";let b=function(e){function s(t){var r;return(r=e.call(this,t)||this)._location=n.create(),r._direction=n.fromValues(1,0,0),r._width=1,r._offset=1,r._length=18,r._color=u.fromValues(1,0,1,1),r._renderOccluded=m.RenderOccludedFlag.OccludeAndTransparent,r.applyProps(t),r}t._inherits(s,e);var d=s.prototype;return d.createObject3DResourceFactory=function(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:e=>this._destroyObject3DResources(e),recreateGeometry:(e,t)=>this._recreateObject3DGeometry(e,t),cameraChanged:()=>this._updateGeometry()}},d.createDrapedResourceFactory=function(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:e=>this._destroyDrapedResources(e),recreateGeometry:e=>this._recreateDrapedGeometry(e)}},d.setDirectionFromPoints=function(e,t){c.normalize(this._direction,c.subtract(this._direction,t,e)),this._updateGeometry()},d._createObject3DResources=function(e){const t=new y.RibbonLineMaterial(this.materialParameters),r=new Array;return this._createObject3DGeometry(t,e,r),{material:t,geometries:r,forEach:e=>{e(t),r.forEach(e)}}},d._destroyObject3DResources=function(e){e.geometries.length=0,e.material.dispose()},d._recreateObject3DGeometry=function(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)},d._createObject3DGeometry=function(e,t,r){const[i,a]=this._createGeometries(e);t.addGeometry(i),t.addGeometry(a),r.push(i),r.push(a),this._updateVerticesObject3D(t)},d._createDrapedResources=function(){const e=new y.RibbonLineMaterial(this.materialParameters),t=r.watch((()=>this.view.state.contentPixelRatio),(()=>{this.drapedResources.recreateGeometry()}));return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}},d._destroyDrapedResources=function(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()},d._recreateDrapedGeometry=function(e){e.geometries=this._createDrapedGeometry(e.material)},d._createDrapedGeometry=function(e){const t=this._createGeometries(e);return this._updateVerticesDraped(t),t.map((e=>new p.RenderGeometry(e)))},d._createGeometries=function(e){return[_.createPolylineGeometry(e,[n.create(),n.create()]),_.createPolylineGeometry(e,[n.create(),n.create()])]},d._updateMaterial=function(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)},d._updateGeometry=function(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}},d._updateVerticesObject3D=function(e){const t=this.view.state.camera;t.projectToScreen(this.location,O),c.add(g,this.location,this.direction),t.projectToScreen(g,P),a.normalize(P,a.subtract(P,P,O)),this._updateVertexAttributesObject3D(t,e,0,O,P,1),this._updateVertexAttributesObject3D(t,e,1,O,P,-1)},d._updateVertexAttributesObject3D=function(e,t,r,a,s,c){const n=t.geometries[r],o=n.getMutableAttribute(f.VertexAttribute.POSITION)?.data;if(!o)return;const{start:u,end:d}=this._computeStartEnd(s,a,c,this.offset,this.width,this.length);e.unprojectFromScreen(i.castScreenPointArray(u),g),o[0]=g[0],o[1]=g[1],o[2]=g[2],e.unprojectFromScreen(i.castScreenPointArray(d),g),o[3]=g[0],o[4]=g[1],o[5]=g[2],t.geometryVertexAttrsUpdated(n)},d._updateVerticesDraped=function(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:r}}}=this,{location:i,width:a,length:s,offset:c}=this,n=j;n.spatialReference=t.renderer.spatialReference,n.x=i[0],n.y=i[1];const o=t.overlayPixelSizeInMapUnits(n)*r,u=a*o,d=s*o,l=c*o;this._updateVertexAttributesDraped(e[0],u,d,l,-1),this._updateVertexAttributesDraped(e[1],u,d,l,1)},d._updateVertexAttributesDraped=function(e,t,r,i,a){const s=e.getMutableAttribute(f.VertexAttribute.POSITION)?.data;if(!s)return;const{location:c,direction:n}=this,{start:o,end:u}=this._computeStartEnd(n,c,a,i,t,r);s[0]=o[0],s[1]=o[1],s[2]=h.DRAPED_Z,s[3]=u[0],s[4]=u[1],s[5]=h.DRAPED_Z,e.invalidateBoundingInfo()},d._computeStartEnd=function(e,t,r,i,s,c){const n=a.scale(D,a.set(D,e[1]*r,e[0]*-r),i+s/2),o=a.add(R,a.add(R,a.add(R,t,a.scale(R,e,c/2)),n),n);return{start:o,end:a.add(G,o,a.scale(G,e,-c))}},t._createClass(s,[{key:"location",get:function(){return this._location},set:function(e){c.exactEquals(this._location,e)||(c.copy(this._location,e),this._updateGeometry())}},{key:"direction",get:function(){return this._direction},set:function(e){c.exactEquals(this._direction,e)||(c.copy(this._direction,e),this._updateGeometry())}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._updateMaterial())}},{key:"offset",get:function(){return this._offset},set:function(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}},{key:"length",get:function(){return this._length},set:function(e){e!==this._length&&(this._length=e,this._updateGeometry())}},{key:"color",get:function(){return this._color},set:function(e){o.exactEquals(e,this._color)||(o.copy(this._color,e),this._updateMaterial())}},{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}},{key:"materialParameters",get:function(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}}]),s}(l.EngineVisualElement);const g=n.create(),D=s.create(),R=s.create(),G=s.create(),O=i.createScreenPointArray(),P=i.createScreenPointArray(),j=d.makeDehydratedPoint(0,0,void 0,null);e.ParallelLineVisualElement=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
