/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../support/elevationInfoUtils","../../../../../symbols/support/ElevationInfo","../../SegmentLabels3D","../../SnappingVisualizer3D","../meshFastUpdateUtils","../settings","../../visualElements/ExtendedLineVisualElement","../../visualElements/OutlineVisualElement","../../visualElements/VerticesVisualElement","../../../layers/graphics/elevationAlignmentUtils","../../../layers/graphics/ElevationContext","../../../layers/graphics/GraphicState","../../../webgl-engine/lib/Material","../../../../draw/DrawGraphicTool","../../../../draw/DrawOperation","../../../../draw/drawSurfaces","../../../../support/colorUtils"],(function(e,t,i,n,a,r,l,o,s,c,u,h,p,d,m,v,y,f,E,g,w,V,_,G,D,S,T,I,O,L){"use strict";e.DrawGraphicTool3D=function(e){function i(t){var i;return(i=e.call(this,t)||this)._activeVertexVisualElement=null,i._createGraphicState=null,i._outlineVisualElement=null,i._verticesVisualElement=null,i._verticalLineVisualElement=null,i.geometryType=null,i.type="draw-3d",i}t._inherits(i,e);var l=i.prototype;return l.initialize=function(){const{mode:e,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new m({mode:e,offset:t})},l.normalizeCtorArgs=function(e){if(!e.elevationInfo){const t=e.hasZ??!0;return{...e,elevationInfo:d.getEffectiveElevationInfo(t)}}return e},l.initializeGraphic=function(e){const{view:t}=this,i=this._createGraphicState=new D.GraphicState({graphic:e});return n.handlesGroup([t.maskOccludee(e),t.trackGraphicState(i),r.watch((()=>({element:this._outlineVisualElement,isDraped:i.isDraped})),(({element:e,isDraped:t})=>{e&&(e.isDraped=t)}),r.syncAndInitial),this._setupLoadingIndicator(i),...f.meshTransformFastUpdateHandles(i)])},l.makeDrawOperation=function(){const{geometryType:e}=this,t="circle"!==e&&"rectangle"!==e;return new I.DrawOperation({view:this.view,manipulators:this.manipulators,geometryType:T.geometryTypeToDrawOperationGeometryType(e),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new O.SceneDrawSurface(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new O.ElevationDrawSurface(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new y.SnappingVisualizer3D,segmentLabels:t?new v.SegmentLabels3D:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===d.getEffectiveElevationMode(this.hasZ,this.elevationInfo)})},l.onActiveVertexChanged=function(e){const{view:t}=this,i=E.getSettings(t);if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[e],this._updateVerticalLineVisualElement(e),null;const r=i.manipulators,l=r.vertex;this._activeVertexVisualElement=new V.VerticesVisualElement({view:t,spatialReference:t.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,color:L.unitRGBAFromColor(l.color),size:l.size,outlineColor:L.unitRGBAFromColor(l.outlineColor),outlineSize:l.outlineSize,renderOccluded:l.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=L.unitRGBAFromColor(r.selected.color),this._activeVertexVisualElement.attached=!0;const o=i.visualElements.zVerticalLine;return this._verticalLineVisualElement=new g.ExtendedLineVisualElement({view:t,extensionType:o.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:S.RenderOccludedFlag.OccludeAndTransparent}),o.apply(this._verticalLineVisualElement),n.makeHandle((()=>{this._activeVertexVisualElement=a.destroyMaybe(this._activeVertexVisualElement),this._verticalLineVisualElement=a.destroyMaybe(this._verticalLineVisualElement)}))},l._updateVerticalLineVisualElement=function(e){const t=this._verticalLineVisualElement;if(!t)return;const{renderCoordsHelper:i,elevationProvider:n}=this.view;h.set(C,e[0],e[1],e[2]),b.setFromElevationInfo(this.elevationInfo),C[2]=_.evaluateElevationAlignmentAtPoint(C,n,b,i);i.toRenderCoords(C,this.view.spatialReference,C)?(t.setStartEndFromWorldDownAtLocation(C),t.attached=!0):t.attached=!1},l.onOutlineChanged=function(e){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=e,null;const t=this.internalGraphicsLayer.elevationInfo,{view:i}=this,r=E.getSettings(i);return this._outlineVisualElement=new w.OutlineVisualElement({view:i,geometry:e,elevationInfo:t,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===d.getEffectiveElevationMode(this.hasZ,t),attached:!1}),r.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),r.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,n.makeHandle((()=>{this._outlineVisualElement=a.destroyMaybe(this._outlineVisualElement)}))},l.onRegularVerticesChanged=function(e){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=e,null;const{view:t}=this,i=E.getSettings(t).manipulators.vertex;return this._verticesVisualElement=new V.VerticesVisualElement({view:t,spatialReference:t.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,color:L.unitRGBAFromColor(i.color),size:i.size,outlineColor:L.unitRGBAFromColor(i.outlineColor),outlineSize:i.outlineSize,renderOccluded:i.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,n.makeHandle((()=>{this._verticesVisualElement=a.destroyMaybe(this._verticesVisualElement)}))},l._updateGraphicGeometry=function(e,n){if("mesh"===this.geometryType&&"point"===n?.type){const t=this.geometryToPlace;return t&&t.centerAt(n),void(t&&e.geometry===t?t.vertexSpace.isGeoreferenced?e.notifyGeometryChanged():e.notifyMeshTransformChanged():e.geometry=t)}t._get(t._getPrototypeOf(i.prototype),"_updateGraphicGeometry",this).call(this,e,n)},l._setupLoadingIndicator=function(e){const{drawOperation:t}=this;if(!this.geometryToPlace)return t.loading=!1,null;t.loading=!0;const i=n.makeHandle((()=>{t.loading=!1}));let a;const l=()=>a&&cancelAnimationFrame(a),o=()=>{l(),a=requestAnimationFrame((()=>i.remove()))};return n.handlesGroup([r.when((()=>e.displaying),o,{...r.syncAndInitial,once:!0}),n.makeHandle(l),i])},t._createClass(i)}(T.DrawGraphicTool),i.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool3D.prototype,"elevationInfo",void 0),i.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool3D.prototype,"geometryType",void 0),i.__decorate([l.property()],e.DrawGraphicTool3D.prototype,"type",void 0),i.__decorate([l.property({constructOnly:!0})],e.DrawGraphicTool3D.prototype,"view",void 0),e.DrawGraphicTool3D=i.__decorate([u.subclass("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],e.DrawGraphicTool3D);const b=new G.ElevationContext,C=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
