/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../Color","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/vectorStacks","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","../settings","./config","./Manipulation","./moveUtils","../../../webgl-engine/lib/basicInterfaces","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces"],(function(t,a,e,n,r,i,o,s,l,u,c,p,d,h,f,_,g,M,m,w,v,y,A,T,I,S,b){"use strict";let D=function(t){function w(a){var e;return(e=t.call(this)||this)._handles=new r,e._arrowManipulatorInfos=new Array,e._opaqueMaterial=e._createMaterial(),e._transparentMaterial=e._createMaterial(.5),e._angle=0,e._scale=1,e._radius=m.DISC_RADIUS,e._updateAfterDrag=!1,e.events=new n,e._tool=a.tool,e._view=a.view,null!=a.radius&&(e._radius=a.radius),e._createManipulators(),e.forEachManipulator((t=>e._tool.manipulators.add(t))),e}a._inherits(w,t);var D=w.prototype;return D.destroy=function(){this._handles=o.destroyMaybe(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0},D.forEachManipulator=function(t){for(const{manipulator:a}of this._arrowManipulatorInfos)t(a,g.ManipulatorType.TRANSLATE_XY)},D.createGraphicDragPipeline=function(t,a,e){const n=a.graphic,r=d.getGraphicEffectiveElevationInfo(n),i=n.geometry.spatialReference;return v.createGraphicMoveDragPipeline(a,e,(a=>this.createDragPipeline(((e,n,r,i,o)=>(({steps:n,cancel:r}=t(e,n,r,i,o)),a(e,n,r))),r,i,n)),this._view.state.viewingMode)},D.createDragPipeline=function(t,a,e,n){return i.handlesGroup(this._arrowManipulatorInfos.map((({manipulator:r},i)=>S.createManipulatorDragEventPipeline(r,((r,o,s,l,u)=>{const c=o.next((t=>({...t,manipulatorType:g.ManipulatorType.TRANSLATE_XY}))).next(S.dragAtLocation(this._view,r.elevationAlignedLocation)).next(_.screenToMapXYAtLocation(this._view,r.elevationAlignedLocation,a,e,n)).next(S.constrainToMapAxis(r.location,this.angle+(i+1)*Math.PI*.5)).next(S.addScreenDelta());t(r,c,s,l,u)})))))},D._updateManipulators=function(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()},D._updateArrowManipulator=function({manipulator:t,transform:a},e){const n=this._radius/m.DISC_RADIUS,r=m.DISC_TRANSLATE_ARROW_SIZE*n,i=r*Math.sqrt(3)/2,o=A.createExtrudedTriangle(this._opaqueMaterial,i,r/2,r/2,m.DISC_HEIGHT);A.transformInPlace(o,s.fromTranslation(p.sm4d.get(),u.set(p.sv3d.get(),0,-i/3,0))),t.renderObjects=[new f.RenderObject(o,b.ManipulatorStateFlags.Focused),new f.RenderObject(o.instantiate({material:this._transparentMaterial}),b.ManipulatorStateFlags.Unfocused)],t.radius=i/3*2*1.2;const l=s.fromZRotation(p.sm4d.get(),e*Math.PI/2),c=s.fromTranslation(p.sm4d.get(),u.set(p.sv3d.get(),0,m.DISC_TRANSLATE_ARROW_OFFSET*n,0));s.multiply(a,l,c)},D._createManipulators=function(){for(let t=0;t<4;t++){const a=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(a)}this._updateManipulatorTransform()},D._updateManipulatorTransform=function(){const t=this.angle,a=s.fromRotation(p.sm4d.get(),t,c.fromValues(0,0,1));if(null==a)return;const e=s.fromScaling(p.sm4d.get(),u.set(p.sv3d.get(),this.displayScale,this.displayScale,this.displayScale)),n=s.multiply(p.sm4d.get(),e,a);for(const r of this._arrowManipulatorInfos){const t=s.multiply(p.sm4d.get(),n,r.transform);r.manipulator.modelTransform=t}},D._createArrowManipulator=function(t){const a=new h.Manipulator3D({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:c.fromValues(0,0,1)}}),e={manipulator:a,transform:l.create()};return this._updateArrowManipulator(e,t),this._handles.add(a.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),e},D._createMaterial=function(t=1){const a=M.getSettings(this._view),n=e.toUnitRGBA(a.colors.accent);return n[3]*=t,new I.ColorMaterial({color:n,transparent:1!==t,cullFace:y.CullFaceOptions.Back,renderOccluded:T.RenderOccludedFlag.Transparent})},a._createClass(w,[{key:"orthogonalAvailable",set:function(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}},{key:"angle",get:function(){return this._angle},set:function(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}},{key:"displayScale",get:function(){return this._scale},set:function(t){this._scale=t,this._updateManipulatorTransform()}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}},{key:"test",get:function(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:t})=>t))}}}]),w}(w.Manipulation);t.MoveXYAxisManipulation=D,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
