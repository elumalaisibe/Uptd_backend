/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../Color","../../../../../core/Evented","../../../../../core/mathUtils","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","../settings","./config","./Manipulation","./moveUtils","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces","../../../../support/colorUtils"],(function(e,t,a,n,i,r,o,l,s,c,u,p,d,h,M,m,g,f,_,v,w,b,S){"use strict";let y=function(e){function g(t){var a;return(a=e.call(this)||this)._radius=m.DISC_RADIUS,a.events=new n,a._tool=t.tool,a._view=t.view,null!=t.radius&&(a._radius=t.radius),a._createManipulator(),a.forEachManipulator((e=>a._tool.manipulators.add(e))),a}t._inherits(g,e);var y=g.prototype;return y.destroy=function(){this._manipulator.applyObjectTransform=j,this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))},y.forEachManipulator=function(e){e(this._manipulator,h.ManipulatorType.TRANSLATE_Z)},y.createGraphicDragPipeline=function(e,t,a){const n=t.graphic.geometry.spatialReference;return f.createGraphicMoveDragPipeline(t,a,(t=>this.createDragPipeline(((a,n,i,r,o)=>(({steps:n,cancel:i}=e(a,n,i,r,o)),t(a,n,i))),n)),this._view.state.viewingMode)},y.createDragPipeline=function(e,t){const a=this._view;return w.createManipulatorDragEventPipeline(this._manipulator,((n,i,r,o,l)=>{const s=i.next((e=>({...e,manipulatorType:h.ManipulatorType.TRANSLATE_Z}))).next(d.screenToZConstrained(a,n.renderLocation,t)).next(w.addScreenDelta());e(n,s,r,o,l)}))},y._updateManipulator=function(){const e=this._radius/m.DISC_RADIUS,t=M.getSettings(this._view),n=t.zManipulator.height*e,i=t.zManipulator.coneHeight*e,l=t.zManipulator.coneWidth*e,c=t.zManipulator.width*e,d=[s.fromValues(0,0,0),s.fromValues(0,0,n)],h=[s.fromValues(0,0,0),s.fromValues(0,0,n+i)],g=e=>{const t=o.create();if(r.translate(t,t,[0,0,n]),r.rotateX(t,t,Math.PI/2),e){const a=1+2*e/l;r.scale(t,t,[a,a,a])}return t},f=g(0),w=(e,n)=>{const i=S.darken(t.zManipulator.color,n);return i.a*=e,a.toUnitRGBA(i)},y=u.createManipulatorMaterial(w(1,.25),v.RenderOccludedFlag.Occlude),O=u.createManipulatorMaterial(w(1,0),v.RenderOccludedFlag.Occlude),R=u.createManipulatorMaterial(w(.7,0),t.zManipulator.renderOccluded),D=u.createManipulatorMaterial(w(.85,0),t.zManipulator.renderOccluded),j=_.createTubeGeometry(y,d,c/2,16,!1),F=_.createConeGeometry(y,i,l/2,16,!1);F.transformation=f,this._manipulator.renderObjects=[new p.RenderObject(F,b.ManipulatorStateFlags.Unfocused),new p.RenderObject(j,b.ManipulatorStateFlags.Unfocused),new p.RenderObject(F.instantiate({material:O}),b.ManipulatorStateFlags.Focused),new p.RenderObject(j.instantiate({material:O}),b.ManipulatorStateFlags.Focused),new p.RenderObject(F.instantiate({material:R}),b.ManipulatorStateFlags.Unfocused),new p.RenderObject(j.instantiate({material:R}),b.ManipulatorStateFlags.Unfocused),new p.RenderObject(F.instantiate({material:D}),b.ManipulatorStateFlags.Focused),new p.RenderObject(j.instantiate({material:D}),b.ManipulatorStateFlags.Focused)],this._manipulator.radius=c/2+2,this._manipulator.collisionType={type:"line",paths:[h]}},y._createManipulator=function(){const e=this._view,t=M.getSettings(e),a=new c.Manipulator3D({view:e,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});a.applyObjectTransform=a=>{const n=e.state.camera,r=O;e.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,r);const o=l.dist(n.eye,r),s=n.computeRenderPixelSizeAtDist(o),c=l.subtract(R,r,n.eye);l.normalize(c,c);const u=D;e.renderCoordsHelper.worldUpAtPosition(O,u);const p=Math.abs(l.dot(c,u)),d=l.cross(R,c,u),h=l.cross(R,d,u),M=i.clamp(p,.01,1),g=1-Math.sqrt(1-M*M)/M/n.fullWidth,f=this._radius/m.DISC_RADIUS,_=t.zManipulator.width*f;l.scale(h,l.normalize(h,h),(1/g-1)*o+s*_),a[12]-=R[0],a[13]-=R[1],a[14]-=R[2]},this._manipulator=a,this._updateManipulator()},t._createClass(g,[{key:"radius",get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}},{key:"test",get:function(){return{manipulator:this._manipulator}}}]),g}(g.Manipulation);const O=s.create(),R=s.create(),D=s.create(),j=()=>{};e.MoveZManipulation=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
