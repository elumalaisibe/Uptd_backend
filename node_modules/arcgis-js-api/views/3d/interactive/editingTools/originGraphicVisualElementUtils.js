/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../support/elevationInfoUtils","./GrabbingState","./ManipulatorState","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/PointVisualElement","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../layers/graphics/GraphicState","../../webgl-engine/lib/Material"],(function(e,t,n,a,i,l,o,s,r,c,p,u,d,h,g,v,m,f,y,E){"use strict";function w(e){const{view:n,graphic:a}=e,i=new y.GraphicState({graphic:a}),l=[],o=S(e,i,l);return b(e,i,l,o),l.push(n.trackGraphicState(i)),{visualElement:o,remove(){t.handlesGroup(l).remove()}}}function b(e,l,r,v){const{view:y,graphic:w}=e,b=d.getSettings(y),S=new h.ExtendedLineVisualElement({view:y,extensionType:b.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent});b.visualElements.zVerticalLine.apply(S);const G=new g.LaserlineVisualElement({view:y,intersectsLineInfinite:!0,attached:!1});b.visualElements.pointGraphics.shadowStyle.apply(G);const P=n.deg2rad(b.visualElements.heightPlaneAngleCutoff),x=new g.LaserlineVisualElement({view:y,attached:!1,angleCutoff:P});b.visualElements.heightPlane.apply(x);const A=c.getGraphicEffectiveElevationInfo(e.graphic),H=f.ElevationContext.fromElevationInfo(A),T="on-the-ground"===A.mode||!A.offset&&"absolute-height"!==A.mode,C=new u.ManipulatorState;let R=1,I=1;const U=()=>{C.update(e);const t=V(w),n=T&&(l.isDraped||null==t||!t.hasZ);let a=!0;if(n||null==t)a=!1;else{const e=m.evaluateElevationAlignmentAtPoint(t,y.elevationProvider,H,y.renderCoordsHelper);i.set(L,t.x,t.y,e),o.projectVectorToVector(L,t.spatialReference,L,y.renderCoordsHelper.spatialReference),S.setStartEndFromWorldDownAtLocation(L),G.intersectsWorldUpAtLocation=L}const r=C.grabbingState&p.GrabbingState.Z?b.visualElements.laserlineAlphaMultiplier:1;r!==R&&(R=r,b.visualElements.heightPlane.apply(x,r));const c=s.empty(M);!n&&l.displaying&&v.calculateMapBounds(c)&&o.projectVectorToVector(s.getMin(c,L),y.spatialReference,L,y.renderCoordsHelper.spatialReference)?(x.heightManifoldTarget=L,x.attached=!0):x.attached=!1;const u=C.grabbingState&p.GrabbingState.XY?b.visualElements.laserlineAlphaMultiplier:1;u!==I&&(I=u,b.visualElements.pointGraphics.shadowStyle.apply(G,u));const d=a&&l.displaying&&!n;G.attached=d,S.attached=d};r.push(a.watch((()=>[l.displaying,l.isDraped]),U),l.on("changed",U)),e.forEachManipulator((e=>{r.push(e.events.on("grab-changed",U))})),r.push(t.destroyHandle(G)),r.push(t.destroyHandle(S)),r.push(t.destroyHandle(x)),U()}function S(e,n,a){const{view:i,graphic:l}=e,o=new v.PointVisualElement({view:i,geometry:V(l),elevationInfo:c.getGraphicEffectiveElevationInfo(l),attached:!1});return G(e,o,n,a),a.push(t.destroyHandle(o)),o}function V(e){const t=e.geometry;return null==t?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}function G(e,t,n,i){const l=()=>t.attached=n.displaying;P(e,t,n,i),d.getSettings(e.view).visualElements.pointGraphics.outline.apply(t),i.push(a.watch((()=>n.displaying),l,a.initial))}function P(e,n,a,i){const{view:l,graphic:o}=e;let s=null;const r=e=>{null!=s&&(s.remove(),s=null),a.isDraped&&null!=e&&(s=x(l,e,(()=>{n.geometry=e})))},c=()=>{const e=V(o);r(e),n.geometry=e};i.push(a.on("changed",c),t.refHandle((()=>s))),c()}function x(e,t,n){const a=e.elevationProvider.spatialReference;o.projectPointToVector(t,L,a);const i=L[0],l=L[1];return e.elevationProvider.on("elevation-change",(e=>{r.containsXY(e.extent,i,l)&&n()}))}const L=l.create(),M=s.create();e.createVisualElements=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
