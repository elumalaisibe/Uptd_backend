/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Cyclical","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/plane","../../../../../geometry/support/ray","../../../../../geometry/support/vectorStacks","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","../settings","../manipulations/config","../../../webgl-engine/lib/basicInterfaces","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TransformTooltipInfos","../../../../support/colorUtils"],(function(t,e,a,i,n,o,s,r,l,c,u,d,h,p,g,_,R,I,T,S,m,D,f,A,O,E,M,C,v,N,y,b,F,w,P){"use strict";var U;!function(t){t.ScaleIn=b.ManipulatorStateCustomFlags.Custom2,t.ScaleOut=b.ManipulatorStateCustomFlags.Custom3,t.RotateLeft=b.ManipulatorStateCustomFlags.Custom4,t.RotateRight=b.ManipulatorStateCustomFlags.Custom5,t.Unlocked=b.ManipulatorStateCustomFlags.Custom7,t.DelayedFocused=b.ManipulatorStateCustomFlags.Custom8,t.TouchInput=b.ManipulatorStateCustomFlags.Custom12}(U||(U={}));let k=function(){function t({adapter:t,tooltipOptions:e,mode:a,tool:o}){this._mode=null,this._handles=new n,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=E.RING_INDICATOR_DELAY_MS,this.events=new i,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this._adapter.scale:1,this.tool=o,this._mode=a,this._adapter=t,this._tooltipOptions=e,this._tooltip=new F.Tooltip({view:o.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(l.when((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),l.initial))}var u=t.prototype;return u.destroy=function(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this._handles=s.destroyMaybe(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=s.destroyMaybe(this._tooltip)},u.startAnimation=function(t){this.cancelActiveAnimation(),t.start();const e=c.addFrameTask({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}},u.cancelActiveAnimation=function(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=s.destroyMaybe(this._activeAnimation)},u.forEachManipulator=function(t){t(this._ringManipulator,A.ManipulatorType.SCALE_ROTATE)},u._createManipulator=function(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.graphicState.graphic,i=y.createManipulatorDragEventPipeline(t,((t,i,n)=>{this._scaleRotateDragData=null;const s=this._adapter.startInteraction(),r={mode:"none",origin:g.clone(t.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=r,this._updateDragState();const l=I.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,l),i.next(f.screenToRenderPlane(this.tool.view,_.fromPositionAndNormal(t.renderLocation,l,_.create()))).next((t=>{const i=_.normal(t.plane),n=m.calculateInputRotationTransform(t.renderStart,t.renderEnd,r.origin,i),l=a.cyclicalPI.shortestSignedDiff(r.angle,n);r.angleDir=o.clamp(r.angleDir+l,-E.ROTATE_INDICATOR_DIRECTION_BUFFER,E.ROTATE_INDICATOR_DIRECTION_BUFFER),r.angle=n;const c=G(r,t),u=c-this._adapter.scale;if(r.scaleDir=o.clamp(r.scaleDir+u,-E.SCALE_INDICATOR_DIRECTION_BUFFER,E.SCALE_INDICATOR_DIRECTION_BUFFER),this._onScaleChanged(),"none"===r.mode){const a=this._mode||L(t,t.plane,r.origin,this.tool.view.state.camera);if(null!=a){switch(a){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:e,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:e,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}r.mode=a}}switch(r.mode){case"rotate":s.state.angle=r.initialAngle+n;break;case"scale":s.state.scale=c,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:e,angle:o.rad2deg(r.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:e,xScale:c,yScale:c})}break;case"end":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:o.rad2deg(r.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:c,yScale:c})}}return"end"===t.action&&(this.startAnimation(x(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),s.done()),t})).next(this._updateTooltipPipelineStep(r)),n.next((()=>{if(s.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:1,yScale:1})}this.startAnimation(x(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this._handles.add([i,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(z(this,(()=>this._updateDelayedFocusedState()),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),l.watch((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),l.initial)])},u._updateTooltipPipelineStep=function(t){return e=>{const a=this._tooltipOptions;if(!a.enabled)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const i=this._tooltip,n=this._tooltipOptions.visualVariables;switch(t.mode){case"scale":{const{size:t,scale:e}=this._adapter,o=n?.size;i.info=new w.TransformScaleTooltipInfo({tooltipOptions:a,scale:{value:e},size:null!=t?r.createLength(t,"meters"):void 0,sizePrecision:K(o?.valueType),sizeUnit:o?.unit});break}case"rotate":{const{orientationClockwise:t,relativeAngleClockwise:e}=this._adapter,o=n?.rotation,s=K(o?.valueType);i.info=new w.TransformRotateTooltipInfo({tooltipOptions:a,rotation:null!=e?r.createAngle(e,"radians","geographic"):void 0,rotationPrecision:s,rotationType:o?.rotationType??"geographic",orientation:null!=t?r.createAngle(t,"radians","geographic"):void 0,orientationPrecision:s})}}return e}},u._updateFocusTooltip=function(){if(!this._tooltipOptions.enabled)return;if(this.getFocused()){const t=this._tooltipOptions.visualVariables,e=t?.rotation,a=t?.size,i=this._mode,{size:n,orientationClockwise:o}=this._adapter,s=null!=o&&(null==i||"rotate"===i),l=null!=n&&(null==i||"scale"===i);this._tooltip.info=new w.TransformAbsoluteTooltipInfo({tooltipOptions:this._tooltipOptions,orientation:s?r.createAngle(o,"radians","geographic"):void 0,orientationPrecision:K(e?.valueType),rotationType:e?.rotationType??"geographic",size:l?r.createLength(n,"meters"):void 0,sizeUnit:a?.unit,sizePrecision:K(a?.valueType)})}else this._tooltip.clear()},u._onScaleChanged=function(){this.events.emit("scale-changed"),this._updateManipulatorTransform()},u._updateDelayedFocusedState=function(){this._ringManipulator.updateStateEnabled(U.DelayedFocused,this.getFocused()),this._updateFocusTooltip()},u._updateDragState=function(){if(this._ringManipulator.updateStateEnabled(U.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(U.ScaleIn|U.ScaleOut,!1),this._ringManipulator.updateStateEnabled(U.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(U.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(U.RotateLeft|U.RotateRight,!1),this._ringManipulator.updateStateEnabled(U.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(U.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(U.ScaleIn|U.ScaleOut|U.RotateLeft|U.RotateRight,!1)},u._updateManipulatorTransform=function(){const t=d.fromRotation(I.sm4d.get(),this._adapter.angle,g.fromValues(0,0,1));if(null==t)return;const e=this.getScale(),a=d.fromScaling(I.sm4d.get(),p.set(I.sv3d.get(),e,e,e));this._ringManipulator.modelTransform=d.multiply(I.sm4d.get(),a,t)},u._createRingManipulator=function(){const t=(t,e,a)=>{const i=[],n=Math.ceil(E.GEOMETRY_SEGMENTS*(e-t)/(2*Math.PI));for(let o=0;o<n+1;o++){const s=t+o*(e-t)/n;i.push(g.fromValues(a*Math.cos(s),a*Math.sin(s),0))}return i},e=e=>t(0,2*Math.PI,e),a=t=>[[-t/2,0],[t/2,0],[t/2,E.RING_HEIGHT/2],[-t/2,E.RING_HEIGHT/2]],i=this._createMaterial(1),n=(t,e,n=i)=>C.createPathExtrusionGeometry(n,a(e),t,[],[],!1),o=e(E.RING_RADIUS),s=n(o,E.RING_THICKNESS),r={left:new Array,right:new Array},l=[];for(let g=0;g<2;g++){const e=g*Math.PI-Math.PI/4,a=Math.PI/2-E.ROTATE_INDICATOR_ARC_LENGTH,o=e+a,s=e+Math.PI/2-a,c=t(o,s,E.INNER_INDICATOR_RADIUS),u=n(c,E.INDICATOR_THICKNESS);l.push(c),l.push(t(o,s,E.OUTER_INDICATOR_RADIUS-E.RING_THICKNESS/2)),r.left.push(u),r.right.push(u.instantiate());for(let t=0;t<2;t++){const e=0===t,a=h.create();if(e){d.scale(a,a,[1,-1,1]),d.rotate(a,a,-o,[0,0,1]);const t=Math.round(E.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(c.length-1));a[12]=c[t][0],a[13]=c[t][1],a[14]=c[t][2]}else{d.rotate(a,a,s,[0,0,1]);const t=Math.round((1-E.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(c.length-1));a[12]=c[t][0],a[13]=c[t][1],a[14]=c[t][2]}const n=C.createExtrudedTriangle(i,E.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,E.ROTATE_INDICATOR_ARROW_TIP_RADIUS,E.RING_HEIGHT);C.transformInPlace(n,a),(e?r.left:r.right).push(n)}}const c=[];for(let d=0;d<2;d++){const e=d*Math.PI-Math.PI/4,a=Math.PI/2-E.SCALE_INDICATOR_ARC_LENGTH,i=e+a,o=e+Math.PI/2-a,s=t(i,o,E.OUTER_INDICATOR_RADIUS);c.push(n(s,E.INDICATOR_THICKNESS))}const u=this._createMaterial(.66),p=this._createMaterial(.5),_=this._createMaterial(.33),R=e(E.RING_RADIUS+E.SCALE_INDICATOR_OFFSET1),I=e(E.RING_RADIUS+E.SCALE_INDICATOR_OFFSET2),m=n(R,E.INDICATOR_THICKNESS,u),f=n(I,E.INDICATOR_THICKNESS,_),A=e(E.RING_RADIUS-E.SCALE_INDICATOR_OFFSET1),O=e(E.RING_RADIUS-E.SCALE_INDICATOR_OFFSET2),M=n(A,E.INDICATOR_THICKNESS,u),v=n(O,E.INDICATOR_THICKNESS,_);let N=[new D.RenderObject(s,U.DelayedFocused),new D.RenderObject(s.instantiate({material:p}),b.ManipulatorStateFlags.None)];this._mode&&"scale"!==this._mode||(N=N.concat([...c.map((t=>new D.RenderObject(t,U.DelayedFocused|U.Unlocked))),new D.RenderObject(m,U.DelayedFocused|U.ScaleIn),new D.RenderObject(f,U.DelayedFocused|U.ScaleIn),new D.RenderObject(M,U.DelayedFocused|U.ScaleOut),new D.RenderObject(v,U.DelayedFocused|U.ScaleOut)])),this._mode&&"rotate"!==this._mode||(N=N.concat([...r.right.map((t=>new D.RenderObject(t.instantiate(),U.DelayedFocused|U.Unlocked))),...r.left.map((t=>new D.RenderObject(t,U.DelayedFocused|U.RotateLeft))),...r.right.map((t=>new D.RenderObject(t,U.DelayedFocused|U.RotateRight)))]));const y=[o,...l];return new S.Manipulator3D({view:this.tool.view,renderObjects:N,autoScaleRenderObjects:!1,worldOriented:!0,radius:E.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:T.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:y,direction:g.fromValues(0,0,1)}})},u._createMaterial=function(t){const e=O.getSettings(this.tool.view).colors.accent.clone();return e.a=t,new N.ColorMaterial({color:P.unitRGBAFromColor(e),transparent:1!==t,cullFace:M.CullFaceOptions.Back,renderOccluded:v.RenderOccludedFlag.Transparent})},e._createClass(t,[{key:"angle",get:function(){return this._adapter.angle}},{key:"scale",get:function(){return this._adapter.scale}},{key:"location",set:function(t){this._ringManipulator.location=t}},{key:"elevationAlignedLocation",set:function(t){this._ringManipulator.elevationAlignedLocation=t}},{key:"grabbing",get:function(){return this._ringManipulator.grabbing}},{key:"interactive",set:function(t){this._ringManipulator.interactive=t}},{key:"test",get:function(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}}]),t}();function G(t,e){const a=p.subtract(I.sv3d.get(),e.renderStart,t.origin),i=p.subtract(I.sv3d.get(),e.renderEnd,t.origin),n=p.length(a),o=p.length(i);return 0===n?0:o/n}function L(t,e,a,i){const{renderStart:n,renderEnd:o}=t,s=H(n,i,I.sv3d.get()),r=H(o,i,I.sv3d.get());if(p.squaredDistance(s,r)<E.DRAG_THRESHOLD_PX*E.DRAG_THRESHOLD_PX)return null;const l=p.subtract(I.sv3d.get(),n,a),c=p.cross(I.sv3d.get(),l,_.normal(e)),u=n,d=p.add(I.sv3d.get(),u,c),h=H(a,i,I.sv3d.get()),g=s,T=H(d,i,I.sv3d.get()),S=p.subtract(I.sv3d.get(),T,g),m=p.subtract(I.sv3d.get(),s,h),D=R.wrap(g,S),f=R.wrap(h,m);return R.distance2(D,r)<R.distance2(f,r)?"rotate":"scale"}function H(t,e,a){return e.projectToScreen(t,B),p.set(a,B[0],B[1],0)}var j;function x(t,e){let a=null,i=1;const n=()=>i;return{start:()=>{i=t.getScale(),a=t.getScale,t.getScale=n,e()},update:t=>(i+=((i+1)/2-i)*Math.min(t*E.RING_RESET_ANIMATION_SPEED_FACTOR,1),e(),Math.abs(i-1)<.01?j.STOP:j.CONTINUE),destroy:()=>{a&&(t.getScale=a),e()}}}function z(t,e,a){let i=0,n=null;const o=()=>!1;return{start:()=>{n=t.getFocused,t.getFocused=o,i=0,e()},update:t=>(i+=t,!n?.()||i>=a.delayMs?j.STOP:j.CONTINUE),destroy:()=>{n&&(t.getFocused=n),e()}}}function K(t){switch(t){case"integer":case"long":return 0;default:return null}}!function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(j||(j={}));const B=u.createScreenPointArray();t.GraphicScaleRotateTransform=k,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
