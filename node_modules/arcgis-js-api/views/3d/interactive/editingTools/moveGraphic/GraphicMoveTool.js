/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Collection","../../../../../core/Evented","../../../../../core/HandleOwner","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../manipulatorUtils","../../SnappingVisualizer3D","../isSupportedGraphicUtils","../manipulatorUtils","../meshFastUpdateUtils","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","./isSupportedGraphic","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/sketch/SketchTooltipOptions","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep","../../../../interactive/tooltip/Tooltip","../../../../interactive/tooltip/TranslateTooltipInfos","../../../../support/automaticLengthMeasurementUtils","../../../../support/euclideanLengthMeasurementUtils"],(function(t,e,i,n,a,o,s,r,p,l,c,h,u,d,v,g,f,M,m,y,_,T,w,G,S,E,b,x,O,D,H,I,z,P,U,X,A,k,Y,C){"use strict";let R=e._createClass((function(t){this.allGraphics=t,this.type="graphic-move-start"})),V=e._createClass((function(t,e,i){this.dx=t,this.dy=e,this.allGraphics=i,this.type="graphic-move"})),B=e._createClass((function(t){this.allGraphics=t,this.type="graphic-move-stop"}));const F="manipulators";t.GraphicMoveTool=function(t){function i(e){var i;return(i=t.call(this,e)||this)._infos=new Map,i.graphics=new n,i.enableZ=!0,i.tooltipOptions=new P,i.type="move-3d",i._moveManipulation=null,i._tooltip=null,i}e._inherits(i,t);var a=i.prototype;return a.initialize=function(){const{view:t}=this;this.addHandles([this.graphics.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateGraphicInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),l.watch((()=>this.tooltipOptions.enabled),(e=>{this._tooltip=e?new A.Tooltip({view:t}):r.destroyMaybe(this._tooltip)}),l.syncAndInitial)]);const e=this.graphics.toArray();this._updateGraphicInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this.finishToolCreation()},a.destroy=function(){this._tooltip=r.destroyMaybe(this._tooltip),this._moveManipulation=r.destroyMaybe(this._moveManipulation),this.removeAllHandles(),this._set("view",null)},a.reset=function(){},a._updateGraphicInfos=function({added:t,removed:e}){for(const i of t){if(x.isSupportedGraphic(i)!==y.SupportedGraphicResult.SUPPORTED)continue;const t=new Z(i),e=this.view.trackGraphicState(t.state);this._infos.set(t.graphic,{info:t,handle:e})}for(const i of e)this._infos.get(i)?.handle.remove(),this._infos.delete(i)},a._setupFastTransformUpdates=function(t){for(const e of t){const{info:t}=this._infos.get(e);this.addHandles(T.meshTransformFastUpdateHandles(t.state),e)}},a._refreshManipulators=function(){if(this.removeHandles(F),this._moveManipulation=r.destroyMaybe(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values(),(({info:t})=>t));this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)},a._createManipulators=function(t){for(const e of t){const i=e.state;e.manipulationXY=new b.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:i}=this;null!=i&&("start"===t?i.info=new k.TranslateGraphicTooltipInfo({tooltipOptions:e}):i.clear())}))],F))),this.addHandles(e.manipulationXY.createDragPipeline(((e,i,n,a)=>this._buildDragEventPipeline(t,S.ManipulationType.XY,e,i,n,a))),F)}this._createMoveManipulation(t)},a._createMoveManipulation=function(t){const e=new S.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?S.MoveManipulation.radiusForSymbol(t[0].graphic.symbol):G.DISC_RADIUS});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(i=>{e.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.at(0)}),i.stopPropagation()})),F)}));const i=e=>i=>{this.addHandles(i.events.on("focus-changed",(({action:i})=>{const n=this._tooltip;null!=n&&("focus"===i?this._updateMoveTooltip(t,e):n.clear())})),F)};this._moveManipulation.xyManipulation.forEachManipulator(i(S.ManipulationType.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(S.ManipulationType.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(S.ManipulationType.Z));const n=()=>this._updateMoveManipulation(t);for(const o of t)this.addHandles([o.state.on("changed",n),l.watch((()=>o.state.displaying),n)],F);const a=t[t.length-1];this.addHandles(a.state.on("changed",(()=>this._updateMoveManipulationAngle(a))),F),this.addHandles(e.createDragPipeline(((e,i,n,a,o)=>this._buildDragEventPipeline(t,e,i,n,a,o)),f.getGraphicEffectiveElevationInfo(a.graphic),a.graphic.geometry.spatialReference,a.graphic),F),this._updateMoveManipulationAngle(a)},a._createVisualElements=function(t){for(const e of t){const i=e.graphic,n=w.createVisualElements({view:this.view,graphic:i,forEachManipulator:t=>{e.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>s.makeHandle()});null!=n&&(e.geometryRepresentation=n.visualElement,e.geometryRepresentation instanceof O.OutlineVisualElement&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",(()=>{e.state.isDraped||this._updateMoveManipulation(t)})),l.watch((()=>e.state.isDraped),(()=>this._updateMoveManipulation(t)))],F),this.addHandles(n,F))}},a._updateMoveManipulationAngle=function(t){this._moveManipulation&&(this._moveManipulation.angle=E.shapeOrientation(t.graphic.geometry))},a._updateMoveManipulation=function(t){const e=g.makeDehydratedPoint(0,0,0,this.view.spatialReference);let i=0,n=!1;const a=this._moveManipulation;if(a){for(const a of t){if(!a.state.displaying)continue;const t=a.state.graphic;this.enableZ&&_.canMoveZ(t)&&(n=!0);const o=a.geometryRepresentation instanceof O.OutlineVisualElement&&!a.state.isDraped?a.geometryRepresentation.attachmentOrigin:M.getGraphicAttachmentOrigin(this.view,t);if(null!=o){const{x:t,y:n,z:a}=o;e.x+=t,e.y+=n,a&&(e.z??(e.z=0),e.z+=a),i++}}i>0?(e.x/=i,e.y/=i,e.z??(e.z=0),e.z/=i,a.location=e,a.xyManipulation.available=!0,a.xyAxisManipulation.available=!0,a.zManipulation.available=n):a.available=!1}},a._buildDragEventPipeline=function(t,e,i,n,a,o){const s=[],r=[];let p=null,l=null;const c=()=>{for(const t of s)t.dragging=!1;s.length=0,r.length=0,p=null,l=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&e===S.ManipulationType.XY){const e=t[0].graphic;({steps:n,cancel:a}=this._buildSnappingPipelineSteps(e,f.getGraphicEffectiveElevationInfo(e),n,a,o))}return a=a.next((t=>l?.(t))).next((()=>(this.emit("graphic-move-stop",new B(r)),this.destroyed||c(),null))),{steps:n=n.next((e=>{if("start"===e.action){s.length=0,r.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(i)&&e.manipulationXY?.grabbing||(s.push(e),r.push(e.graphic),e.dragging=!0);if(0!==r.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),p=H.dragGraphicMany(r,this.view.state.viewingMode),l=H.resetGraphicMany(r),this.emit("graphic-move-start",new R(r)),this.destroyed))return null}return 0!==r.length?e:null})).next((t=>p?.(t))).next((i=>(this._updateMoveTooltip(t,e,i),i))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),n=i.x-e.x,a=i.y-e.y;if(this.emit("graphic-move",new V(n,a,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new B(r)),this.destroyed)return null;c()}return null})),cancel:a}},a._updateMoveTooltip=function(t,e,i){const{tooltipOptions:n,_tooltip:a}=this;if(null==a)return;a.clear();const o=0===t.length?"absolute-height":t[0].state.isDraped?"on-the-ground":"absolute-height";switch(e){case S.ManipulationType.XY:a.info=new k.TranslateGraphicTooltipInfo({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,((t,e)=>Y.autoHorizontalDistanceByElevationModeBetweenPoints(t,e,o)));break;case S.ManipulationType.XY_AXIS:a.info=new k.TranslateGraphicXYTooltipInfo({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,((t,e)=>{const n=Y.autoHorizontalDistanceByElevationModeBetweenPoints(t,e,o);return p.scale(n,E.axisConstrainedDragSign(i))}));break;case S.ManipulationType.Z:a.info=new k.TranslateGraphicZTooltipInfo({tooltipOptions:n}),this._updateMoveTooltipDistance(a.info,i,C.verticalSignedDistanceBetweenPoints)}},a._updateMoveTooltipDistance=function(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:n,mapEnd:a}=e,o=i(n,a);t.distance=null!=o?o:p.zeroMeters}},a._buildSnappingPipelineSteps=function(t,e,i,n,a){const o=t.geometry;if(null==o||"point"!==o.type&&"mesh"!==o.type)return{steps:i,cancel:n};const s=("point"===o.type?o:o.anchor).clone(),r=new U.SnappingContext({elevationInfo:e,pointer:a,editGeometryOperations:z.EditGeometryOperations.fromGeometry(s,this.view.state.viewingMode),visualizer:new m.SnappingVisualizer3D,excludeFeature:t}),p=this.snappingManager,{snappingStep:l,cancelSnapping:c}=X.createSnapDragEventPipelineStep({snappingContext:r,snappingManager:p,updatingHandles:this.updatingHandles});return n=n.next(c),{steps:i=i.next((e=>{s.z=f.getConvertedElevation(this.view,s,f.getGraphicEffectiveElevationInfo(t),{mode:"absolute-height",offset:0});return{...e,snapOrigin:r.coordinateHelper.pointToVector(s)}})).next(...l),cancel:n}},e._createClass(i,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"test",get:function(){return{tooltip:this._tooltip}}}]),i}(o.HandleOwnerMixin(a.EventedMixin(I.InteractiveToolBase))),i.__decorate([c.property({constructOnly:!0,nonNullable:!0})],t.GraphicMoveTool.prototype,"view",void 0),i.__decorate([c.property()],t.GraphicMoveTool.prototype,"graphics",void 0),i.__decorate([c.property({constructOnly:!0,nonNullable:!0})],t.GraphicMoveTool.prototype,"enableZ",void 0),i.__decorate([c.property({constructOnly:!0,type:P})],t.GraphicMoveTool.prototype,"tooltipOptions",void 0),i.__decorate([c.property({constructOnly:!0})],t.GraphicMoveTool.prototype,"snappingManager",void 0),i.__decorate([c.property()],t.GraphicMoveTool.prototype,"type",void 0),i.__decorate([c.property()],t.GraphicMoveTool.prototype,"updating",null),t.GraphicMoveTool=i.__decorate([v.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],t.GraphicMoveTool);let Z=function(){function t(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new D.GraphicState({graphic:t})}return e._createClass(t,[{key:"graphic",get:function(){return this.state.graphic}}]),t}();t.GraphicMoveEvent=V,t.GraphicMoveStartEvent=R,t.GraphicMoveStopEvent=B,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
