/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../support/elevationInfoUtils","../Manipulator3D","./GrabbingState","./ManipulatorState","./ManipulatorType","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/OutlineVisualElement","../../layers/graphics/GraphicState","../../webgl-engine/lib/Material"],(function(e,t,a,n,l,i,r,o,s,c,d,p,u,h,g,m,y){"use strict";function f(e){const{view:a,graphic:n}=e,l=new m.GraphicState({graphic:n}),i=v(e,l),r=[i,E(e,i.visualElement,l),a.maskOccludee(n),a.trackGraphicState(l)];return{visualElement:i.visualElement,remove:()=>t.handlesGroup(r).remove()}}function v(e,a){const{view:l,graphic:i}=e,o=new g.OutlineVisualElement({view:l,geometry:w(i)?i.geometry:null,elevationInfo:r.getGraphicEffectiveElevationInfo(i),attached:!1}),s=p.getSettings(l).visualElements.lineGraphics;s.shadowStyle.apply(o);const c=()=>{o.attached=a.displaying};s.outline.apply(o);const d=[n.watch((()=>a.displaying),c),n.watch((()=>a.isDraped),(e=>{o.isDraped=e})),a.on("changed",(()=>o.geometry=w(i)?i.geometry:null)),t.destroyHandle(o)];return c(),{visualElement:o,remove:()=>t.handlesGroup(d).remove()}}function E(e,l,i){const{graphic:o,view:d}=e,g=[],m=r.getGraphicEffectiveElevationInfo(o),f="on-the-ground"===m.mode||!m.offset&&"absolute-height"!==m.mode,v=new c.ManipulatorState,E=p.getSettings(d).visualElements,G=new u.ExtendedLineVisualElement({view:d,extensionType:E.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:y.RenderOccludedFlag.OccludeAndTransparent});E.pointGraphics.shadowStyle.apply(G);const M=a.deg2rad(E.heightPlaneAngleCutoff),L=new h.LaserlineVisualElement({view:d,attached:!1,angleCutoff:M});E.heightPlane.apply(L);let T=1,V=1;const O=()=>{if(v.update(e),!i.displaying||f&&(i.isDraped||!w(o)||!o.geometry.hasZ))return l.laserlineEnabled=!1,G.attached=!1,void(L.attached=!1);l.laserlineEnabled=!0;const t=v.grabbingState&s.GrabbingState.XY?E.laserlineAlphaMultiplier:1;t!==T&&(T=t,E.lineGraphics.shadowStyle.apply(l,t),E.pointGraphics.shadowStyle.apply(G,t));const a=v.grabbingState&s.GrabbingState.Z?E.laserlineAlphaMultiplier:1;a!==V&&(V=a,E.heightPlane.apply(L,a)),S(G,v),b(e,l,L,v)};E.zVerticalLine.apply(G),g.push(i.on("changed",O),n.watch((()=>i.displaying),O),l.events.on("attachment-origin-changed",O),t.destroyHandle(G),t.destroyHandle(L));const A=[],D=()=>{t.handlesGroup(A).remove(),A.length=0,e.forEachManipulator((e=>A.push(e.events.on("grab-changed",O)))),e.forEachManipulator((e=>A.push(e.events.on("select-changed",O)))),O()};return D(),g.push(e.onManipulatorsChanged(D),t.refHandle((()=>t.handlesGroup(A)))),t.handlesGroup(g)}function S(e,t){const a=1===t.numSelected?t.firstSelected:t.numSelected>1&&null!=t.firstGrabbedXY?t.firstGrabbedXY:null;null!=a?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}function b(e,t,a,n){if(n.numSelected>0){l.set(G,0,0,0);let t=0;e.forEachManipulator(((e,a)=>{a===d.ManipulatorType.TRANSLATE_XY&&e.selected&&e instanceof o.Manipulator3D&&(l.add(G,G,e.renderLocation),t++)})),t>0?(a.heightManifoldTarget=l.scale(G,G,1/t),a.attached=!0):a.attached=!1}else{const n=t.attachmentOrigin;null!=n&&e.view.renderCoordsHelper.toRenderCoords(n,G)?(a.heightManifoldTarget=G,a.attached=!0):a.attached=!1}}function w(e){return null!=e.geometry&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const G=i.create();e.createVisualElements=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
