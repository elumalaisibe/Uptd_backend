/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../chunks/vec2","../../../chunks/vec2f64","../../../layers/support/layerUtils","../support/StreamDataLoader","./BlendLayersTechnique","./interfaces","./ITile","./LayerClass","./terrainUtils","./TextureFader","./TextureReference","./TileCompositor","./TileRenderInfo","./TileTexture","./TileUpdate","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(e,t,r,s,a,i,o,n,u,l,c,d,p,h,T,y,_,f,g,x,b,m,I,k){"use strict";let L=t._createClass((function(e,t,r,s){this.start=e,this.end=t,this.blendMode=r,this.opacity=s})),w=function(){function e(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._passParameters=new n.BlendLayersPassParameters,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new T.TileCompositor(this._rctx,this._techniqueRepository),this._blackTex=new _(b.createColorTexture(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}var s=e.prototype;return s.dispose=function(){this._composition=r.disposeMaybe(this._composition),this._backgroundTexture=r.releaseMaybe(this._backgroundTexture),this._blackTex=r.releaseMaybe(this._blackTex)},s.updateTileTexture=function(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let a=0,o=0,n=this.tileSize,u=!1;const l=r.view.state.contentPixelRatio;let p=!1;C.clear(),S.length=0;const h=e.layerInfo[c.LayerClass.MAP];let T=h.length,y=0,_=null;for(;y<h.length;y++){const t=r.layerViewByIndex(y,c.LayerClass.MAP),g=t.layer.opacity;A[y]=g;const x=t.fullOpacity;if(E[y]=x,i.isBaseLayer(t.layer)&&T>=h.length&&(T=y),d.isBlendableLayerView(t)){N[y]=t.layer.blendMode;let e="normal"!==t.layer.blendMode;if(i.isGroupLayer(t.layer.parent)){const r=M(t.layer.parent);null!=r&&""!==r&&(e=P(t.layer.parent)||e)}e&&(p=e,u=!1)}if(0===g&&!p){h[y].pendingUpdates&=~(f.TileUpdate.TEXTURE_NOFADING&f.TileUpdate.TEXTURE_FADING);continue}++o;const b=R(e,y);if(b){if(h[y].pendingUpdates&=~(f.TileUpdate.TEXTURE_NOFADING&f.TileUpdate.TEXTURE_FADING),i.isGroupLayer(t.layer.parent)){const e=M(t.layer.parent);null!=e&&""!==e&&O(t.layer.parent,y)}d.isVectorTileLayerView(t)?n=Math.max(n,this.tileSize*l):1===s&&1===x&&(t.isOpaque||this._dataToTexture(b)&&b.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++a,null===_&&(_=y)}}const g=n/this.tileSize;this._ensureBackgroundTexture(this.tileSize),0!==a&&null!==_?1===a&&!p&&this._useLayerTexture(e,_,T,E[_])||this._composeMapLayers(e,t,y-1,T,A,N,n,g,!u||p,C,p):this._useBackgroundTexture(e,o)},s._ensureBackgroundTexture=function(e){null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=a.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,null!=this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,null!=this.backgroundColor),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)},s._useBackgroundTexture=function(e,t){let r=p.ActivationTime.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=p.ActivationTime.Delayed);const s=e.renderData;this._backgroundTexture&&null==s.textureReference&&(r=p.ActivationTime.Immediate),s.setTextureReference(null!=this._backgroundTexture?new h.TextureReference(this._backgroundTexture,u.TextureUpdate.FADING,D,e.surface.baseOpacity,0,1):null,r)},s._useLayerTexture=function(e,t,r,s){const a=t<r,i=a?1:e.surface.baseOpacity,o=a?e.surface.baseOpacity:1,n=R(e,t);return!!this._dataToTexture(n)&&(e.renderData.setTextureReference(new h.TextureReference(n.sourceLayerInfo.data,u.TextureUpdate.FADING,n,i,o,s)),!0)},s._composeMapLayers=function(e,t,r,s,i,o,n,u,l,c,p){this._composition.ensureBuffer(n);const T=e.surface.baseOpacity;let y=!1,_=m.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,f=!1,b=0;for(let h=r;h>=0;h--){const t=R(e,h);if(!t)continue;if(0===i[h]&&!p)continue;const r=h<s&&T<1&&!y;this._passParameters.baseOpacity=r?T:1;const I=this._passParameters.baseOpacity<1?x.BaseOpacityMode.Required:x.BaseOpacityMode.NotRequired;r&&(y=!0);let k=!1;c.forEach((e=>{e.start===h&&(S.push(e),this._composition.openGroup(n),k=!0)}));const L=0===b,w=k?x.BlendLayersOutput.GroupBackgroundComposite:l&&L?this.backgroundIsGrid?x.BlendLayersOutput.GridComposite:x.BlendLayersOutput.ColorComposite:x.BlendLayersOutput.Composite,M=g.blendModeFromString[o[h]];for(d.isVectorTileRenderInfo(t)?(this._passParameters.opacity=i[h],f=this._composition.drawVectorData(this._passParameters,w,n,M,I,t,u,this.tileSize,f)):d.isImageryTileRenderInfo(t)?(this._passParameters.opacity=i[h],this._composition.drawImageryTileData(this._passParameters,w,n,M,I,t),this._hasNearestInterpolation(t)&&(_=m.TextureSamplingMode.NEAREST)):this._dataToTexture(t)&&(this._passParameters.texture=t.sourceLayerInfo.data.texture,this._passParameters.offset=t.offset,this._passParameters.scale=t.scale,this._passParameters.opacity=i[h],this._composition.drawRasterData(this._passParameters,w,n,M,I));S.length>0&&S[S.length-1].end===h;){const e=S.pop();this._passParameters.opacity=e.opacity,this._passParameters.offset=a.ZEROS,this._passParameters.scale=1;const t=l&&L?this.backgroundIsGrid?x.BlendLayersOutput.GridComposite:x.BlendLayersOutput.ColorComposite:x.BlendLayersOutput.Composite;this._composition.drawGroup(this._passParameters,t,n,g.blendModeFromString[e.blendMode],I)}b++}const I=e.renderData,k=I.ensureTexture(n,(()=>this._buildTexture(n,_)));this._composition.copyFBOToTexture(k),this._composition.unbind(),I.setTextureReference(new h.TextureReference(k,t,D,y?1:T,0,1))},s._hasNearestInterpolation=function(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation},s._dataToTexture=function(e){if(d.isRasterTileRenderInfo(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return d.isTextureTileRenderInfo(e)},s.setBackground=function(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)},s._buildTexture=function(e,t=m.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(null==e)return null;const r=new k.TextureDescriptor;r.wrapMode=m.TextureWrapMode.CLAMP_TO_EDGE,r.samplingMode=t,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0;const s=this._rctx;let a;if("number"==typeof e)r.width=r.height=e,a=new _(new I.Texture(s,r));else if(e instanceof o.ImageWithType)r.isOpaque=e.isOpaque,a=new _(new I.Texture(s,r,e.image)),e.release();else try{r.width=e.width,r.height=e.height,a=new _(new I.Texture(s,r,e))}catch(n){a=new _(b.createEmptyTexture(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const i=s.bindTexture(a.texture,I.Texture.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),s.bindTexture(i,I.Texture.TEXTURE_UNIT_FOR_UPDATES),a},t._createClass(e,[{key:"backgroundIsGrid",get:function(){return null==this._backgroundColor}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),e}();function R(e,t){B.layerIndex=t,B.vtlNeighborInfos.clear();const r=e.layerInfo[c.LayerClass.MAP][t];if(r.data)return s.set(B.offset,0,0),B.tile=e,B.scale=1,B.sourceLod=e.lij,B.sourceLayerInfo=r,d.isVectorTileRenderInfo(B)&&e.forEachLoadedNeighbor(((s,a)=>{if(s.level!==e.level)return;const i=s.layerInfo[c.LayerClass.MAP][t];if(!d.isVectorTilePerLayerInfo(i)||r.data===i.data)return;const o=B.vtlNeighborInfos.pushNew();o.offset=U[a],o.sourceLod=s.lij,o.sourceLayerInfo=i})),B;const a=r.upsampleInfo;if(a){const e=a.tile.layerInfo[c.LayerClass.MAP][t];return B.tile=a.tile,s.copy(B.offset,a.offset),B.scale=a.scale,B.sourceLod=a.tile.lij,B.sourceLayerInfo=e,B}return null}function M(e){return e.get("uid")}function P(e){let t="normal"!==e.blendMode;return i.isGroupLayer(e.parent)&&(t=P(e.parent)||t),t}function O(e,t){i.isGroupLayer(e.parent)&&O(e.parent,t);const r=M(e);if(null!=r&&""!==r){const s=C.get(r);s?s.start=t:C.set(r,new L(t,t,e.blendMode,e.opacity))}}const A=new Array,E=new Array,N=new Array,C=new Map,S=new Array,B=new y.TileRenderInfo,D={offset:[0,0],scale:1},U=new Array;U[l.NeighborIndex.NORTH]=[0,-1],U[l.NeighborIndex.NORTH_EAST]=[-1,-1],U[l.NeighborIndex.EAST]=[-1,0],U[l.NeighborIndex.SOUTH_EAST]=[-1,1],U[l.NeighborIndex.SOUTH]=[0,1],U[l.NeighborIndex.SOUTH_WEST]=[1,1],U[l.NeighborIndex.WEST]=[1,0],U[l.NeighborIndex.NORTH_WEST]=[1,-1],e.GroupInfo=L,e.TileRenderer=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
