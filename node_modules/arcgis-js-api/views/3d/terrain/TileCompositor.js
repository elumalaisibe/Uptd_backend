/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Logger","../../../core/maybe","../../../chunks/vec2f64","../../2d/engine/imagery/enums","../../2d/engine/vectorTiles/VectorTileRendererHelper3D","./BlendLayersTechnique","./LayerClass","./RasterColorizerTechnique","./support/MultiSizeFramebuffer","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../../../chunks/BlendLayers.glsl","../webgl-engine/lib/BindParameters","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture","../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,u,h,c,d,_,f,p,y,b,T,g){"use strict";const B=r.getLogger("esri.views.3d.terrain");let C=function(){function e(e,t){this._rctx=e,this._techniqueRepository=t,this._fbos=[],this._vectorTileHelper=new o.VectorTileRendererHelper3D,this._bindParameters=new f.BindParameters(null,null,null),this._blendLayersTechniqueConfig=new a.BlendLayersTechniqueConfiguration,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=y.createQuadVAO(this._rctx,p.Pos2Tex)}var r=e.prototype;return r.dispose=function(){this._fbos.forEach(i.disposeMaybe),this._fbos=null,this._vtFBO=i.disposeMaybe(this._vtFBO),this._vaoQuad=i.disposeMaybe(this._vaoQuad),this._vectorTileHelper=i.disposeMaybe(this._vectorTileHelper),this._backgroundTechnique=i.releaseMaybe(this._backgroundTechnique),this._applyOpacityTechnique=i.releaseMaybe(this._applyOpacityTechnique),this._blendLayersTechnique=i.releaseMaybe(this._blendLayersTechnique)},r._getBlendLayersTechnique=function(e,t,r,i=d.PremultipliedAlphaSource.Off,s=_.BackgroundMode.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=r,this._blendLayersTechniqueConfig.premultipliedSource=i,this._blendLayersTechniqueConfig.background=s,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(a.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique},r.drawBackground=function(e,t){const r=this._getBlendLayersTechnique(c.LayerBlendMode.Normal,t?d.BlendLayersOutput.ColorComposite:d.BlendLayersOutput.GridComposite,d.BaseOpacityMode.NotRequired,d.PremultipliedAlphaSource.Off,_.BackgroundMode.Only),i=this._rctx.bindTechnique(r,e,this._bindParameters);this._render(i)},r._render=function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(b.PrimitiveType.TRIANGLE_STRIP,0,g.vertexCount(this._vaoQuad,"geometry"))},r.drawGroup=function(e,t,r,i,s,n=d.PremultipliedAlphaSource.On){t===d.BlendLayersOutput.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);const o=this._getBlendLayersTechnique(i,t,s,n),a=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(a)},r.drawRasterData=function(e,t,r,i,s,n=d.PremultipliedAlphaSource.Off){if(null==e.texture)return;e.fboTexture=t===d.BlendLayersOutput.GroupBackgroundComposite||i===c.LayerBlendMode.Normal&&s===d.BaseOpacityMode.NotRequired&&n===d.PremultipliedAlphaSource.Off?null:this.switch(r).colorTexture;const o=this._getBlendLayersTechnique(i,t,s,n),a=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(a)},r.drawImageryTileData=function(e,t,r,i,s,n){const o=n.sourceLayerInfo.data;if(!o.source)return;if(n.tile.surface.layerViewByIndex(n.layerIndex,l.LayerClass.MAP).ensureSymbolizerParameters(o),!o.bind(this._rctx))return;e.fboTexture=i===c.LayerBlendMode.Normal&&s===d.BaseOpacityMode.NotRequired?null:this.switch(r).colorTexture;const a=this._getRasterColorizerTechnique(o,t,i,s);o.opacity=e.opacity;const u=o.getUniforms();u.scale=n.scale,u.offset=n.offset,u.backgroundColor=e.backgroundColor,u.fboTexture=e.fboTexture,u.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(a,u,null);this._render(h)},r._getRasterColorizerTechnique=function(e,t,r,i){const s=e.symbolizerParameters,o=["stretch","lut","hillshade"].indexOf(s.type);return null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new u.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=r,this._rasterColorizerConfig.baseOpacityMode=i,this._rasterColorizerConfig.colorizerType=o,this._rasterColorizerConfig.applyColormap=!!s.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?n.RasterColorizerStretchType.Noop:n.RasterColorizerStretchType.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(u.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique},r.drawVectorData=function(e,t,r,i,n,o,a,u,_){const f=this._rctx,p=o.sourceLayerInfo.data,y=o.tile.surface.layerViewByIndex(o.layerIndex,l.LayerClass.MAP),T=n===d.BaseOpacityMode.Required||e.opacity<1||i!==c.LayerBlendMode.Normal||t!==d.BlendLayersOutput.Composite,g=T?d.PremultipliedAlphaSource.On:d.PremultipliedAlphaSource.Off;this._getBlendLayersTechnique(i,t,n,g).bindPipelineState(f);let C=null,x=null;T?(x=this.currentFBO(r),null==this._vtFBO&&(this._vtFBO=new h.MultiSizeFramebuffer(this._rctx)),C=this._vtFBO.get(r),f.bindFramebuffer(C),this._clearCurrentFBO()):_&&f.clearSafe(b.ClearBufferBit.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(f,o.sourceLod,p,y.painter,y.layer.styleRepository,y.schemaHelper,Math.round(1/o.scale),o.offset,u,a,y.contentZoom),o.vtlNeighborInfos.forAll((e=>this._vectorTileHelper.renderSymbols(f,e.sourceLod,e.sourceLayerInfo.data,y.painter,y.layer.styleRepository,y.schemaHelper,1,e.offset,u,a,y.contentZoom)))}catch(m){B.warnOnce("A render call containing vector tiles did not resolve correctly.",m)}return null==C||(f.bindFramebuffer(x),e.texture=C.colorTexture,e.offset=s.ZEROS,e.scale=1,this.drawRasterData(e,t,r,i,n,g),_)},r.copyFBOToTexture=function(e){const t=this._rctx,r=t.bindTexture(e.texture,T.Texture.TEXTURE_UNIT_FOR_UPDATES),i=e.descriptor;t.gl.copyTexImage2D(b.TextureType.TEXTURE_2D,0,i.pixelFormat,0,0,i.width,i.height,0),e.generateMipmap(),t.bindTexture(r,T.Texture.TEXTURE_UNIT_FOR_UPDATES)},r._clearCurrentFBO=function(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(b.ClearBufferBit.COLOR_BUFFER_BIT|b.ClearBufferBit.DEPTH_BUFFER_BIT)},r._initFBO=function(e,t,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())},r.ensureBuffer=function(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)},r.bind=function(e,t=0,r=!0){if(this._current=t,t>=this._fbos.length)for(let i=this._fbos.length;i<=t;i++)this._fbos.push(new h.MultiSizeFramebuffer(this._rctx));this._initFBO(this._fbos[t].get(e),e,r)},r._bindNextFreeBuffer=function(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))},r.openGroup=function(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)},r.switch=function(e){const t=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),t},r.getLastOnHoldId=function(){return this._onHoldIds[this._onHoldIds.length-1]},r.closeGroup=function(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())},r.unbind=function(){this._rctx.bindFramebuffer(null)},r.currentFBO=function(e){return this._fbos[this._current].get(e)},t._createClass(e)}();e.TileCompositor=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
