/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Color","../../../core/Accessor","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/mat4f64","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../core/support/WatchUpdatingTracking","../../../geometry/ellipsoidUtils","../../../geometry/projection","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/spatialReferenceUtils","../../../layers/mixins/RefreshableLayer","../../../layers/support/ElevationQueryTileCache","../../../layers/support/ElevationTileData","../../../layers/support/layerUtils","../../../layers/support/LercDecoder","../../2d/engine/vectorTiles/VectorTile","../support/cameraUtils","../support/debugFlags","../support/extentUtils","../support/index","../support/updatingProperties","./ElevationBounds","./ElevationData","./ExtentHelper","./interfaces","./LayerClass","./OverlayManager","./PlanarPatch","./RenderOrder","./ScaleRangeQueries","./SphericalPatch","./SplitLimits","./TerrainConst","./TerrainRenderer","./TerrainSurfacePerformanceInfo","./terrainUtils","./Tile","./TilePerLayerInfo","./TileUpdate","./tileUtils","./TilingSchemeLogic","./UpsampleInfo","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../webgl-engine/lib/basicInterfaces","../../support/RenderState","../../support/Scheduler"],(function(e,t,i,r,s,n,a,o,l,d,h,c,u,p,_,y,g,T,f,m,v,w,E,L,S,U,b,R,D,C,A,P,M,x,k,I,O,V,B,N,j,F,q,G,W,H,Q,X,z,Y,K,$,J,Z,ee,te,ie,re,se,ne,ae,oe,le,de,he,ce,ue,pe,_e){"use strict";let ye=function(i){function r(e){var r;return(r=i.call(this,e)||this)._scaleRangeQueries=new $.ScaleRangeQueries,r._iteratorPool=new u(oe.IteratorPreorder,(e=>e.remove=()=>r._iteratorPool.release(e))),r._postorderIterator=new oe.IteratorPostorder,r._hasPendingUpdates=!1,r._pendingUpdates=0,r._asyncWorkItems=0,r._allTilesDirty=!0,r._allTilesSorted=!0,r._visibleCached=!1,r._usedMemory=null,r._performanceInfo=new ie,r._viewChanged=!1,r._inFrameTask=!1,r._viewChangeUpdateDirty=!1,r._eyePosRenderSR=L.create(),r._eyePosSurfaceSR=L.create(),r._splitLimits=new Z.SplitLimits,r._frustum=A.create(),r._viewProjectionMatrix=w.create(),r._layerViews=[new Array,new Array],r._layerIndexByUid=[new Map,new Map],r._basemapLayerViewHandles=new Map,r._handles=new l,r._watchUpdatingTracking=new U.WatchUpdatingTracking,r._frameTask=_e.ImmediateTask,r._allTiles=new p,r._upsampleInfoPool=new u(de.UpsampleInfo),r._rootTilesExtent=C.create(),r.updatingProgress=.5,r._maxNumUpdating=1,r.maxTextureScale=1.2,r._spatialReference=D.WebMercator,r.visibleElevationBounds=new G.ElevationBounds(1/0,-1/0),r.rootTileElevationBounds=new G.ElevationBounds(1/0,-1/0),r._updatingRootTiles=!1,r._pendingTilesForElevationUpdateEvent=new Set,r._pendingTilesToUpdate=new Set,r.totalGeometryUpdates=0,r.totalTileUpdates=0,r.oneBatchPerFrameTask=!0,r._layerViewsDirty=!1,r.unloadedMemory=0,r.ignoresMemoryFactor=!1,r._isWebMercator=!1,r._isWebMercatorOnPlateeCarree=!1,r.overlayManager=new z.OverlayManager({...e,surface:t._assertThisInitialized(r)}),r._isGlobal=!e.view?.state?.isLocal,r}t._inherits(r,i);var s=r.prototype;return s.initialize=function(){this._lercDecoder=O.acquireDecoder(this.view.resourceController),this._tilePool=this.view.state.isLocal?new u(Y.PlanarPatch):new u(J.SphericalPatch);const t=this.view.resourceController.memoryController;this._upsampleMapCache=t.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new x.ElevationQueryTileCache(t.newCache("elevation-query")),this._handles.add([y.watch((()=>this.overlayManager.hasHighlights),(e=>this._renderer.setNeedsHighlight(e))),y.watch((()=>this.overlayManager.rendersOccluded),(e=>this._renderer.setRenderOccludedOverlay(e))),y.watch((()=>this.overlayManager.renderer.isEmpty),(()=>this._evaluateTransparency()))],"overlayManager"),this._renderer=new te.TerrainRenderer({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:b.getReferenceEllipsoid(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([y.watch((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?Q.TextureUpdate.UNFADED:Q.TextureUpdate.IMMEDIATE)}),y.syncAndInitial),y.watch((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?Q.TextureUpdate.UNFADED:Q.TextureUpdate.IMMEDIATE)),y.syncAndInitial),y.watch((()=>this.renderingDisabled),(()=>this.view?._stage?.renderer.setParameters({terrainRenderingEnabled:!this.renderingDisabled})),y.sync),y.watch((()=>this.backgroundColor),(e=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(e)}),y.syncAndInitial),y.watch((()=>this.snapLevel),(()=>this._viewChanged=!0),y.sync),y.watch((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),y.watch((()=>N.TERRAIN_TILE_TREE_SHOW_TILES),(t=>{t&&!this._treeDebugger?new Promise(((t,i)=>e(["../layers/support/TerrainTileTree3DDebugger"],t,i))).then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&N.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))})):t||(this._treeDebugger=c.destroyMaybe(this._treeDebugger))}),y.initial)]);const{spatialReference:i}=this.view;this._extentHelper=H.create(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:i});const r=new a({getCollections:()=>this.view?.defaultsFromMap?.mapCollections?.map((({layers:e})=>e)),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),s=new le.TilingSchemeLogic({layers:r,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:i});this._set("tilingSchemeLogic",s),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(F.ClientType.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(F.ClientType.BASEMAP);const n=this.view.resourceController.scheduler;this._frameTask=n.registerTask(_e.TaskPriority.TERRAIN_SURFACE,this),this._handles.add([y.watch((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),y.initial),y.watch((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),y.sync),y.watch((()=>this.extent),(()=>this._updateRootTiles()),y.initial),this.view.on("resize",(()=>this._viewChangeUpdate())),y.watch((()=>{const e=this.view,t=e.state;return[this._lodBias,this.lodSnapping,e.resourceController?.memoryController?.memoryFactor,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),y.syncAndInitial),y.watch((()=>this.view.qualitySettings?.tiledSurface?.textureFadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),y.initial),y.watch((()=>this.view.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._renderer.pbrMode=e?ce.PBRMode.Terrain:ce.PBRMode.Disabled),y.initial),y.watch((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),y.sync)]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges()},s.destroy=function(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=c.releaseMaybe(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=c.destroyMaybe(this._upsampleMapCache),this._elevationQueryCache=c.destroyMaybe(this._elevationQueryCache),this._set("tilingSchemeLogic",c.destroyMaybe(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",c.destroyMaybe(this.overlayManager)),this._tilePool=c.destroyMaybe(this._tilePool),se.Tile.prune(),this._treeDebugger=c.destroyMaybe(this._treeDebugger),this._renderer=c.destroyMaybe(this._renderer),this._iteratorPool=c.destroyMaybe(this._iteratorPool),this._set("view",null),this._extentHelper=c.destroyMaybe(this._extentHelper),this._upsampleInfoPool=c.destroyMaybe(this._upsampleInfoPool),V.printAllocations(),ne.printAllocations()},s.intersect=function(e,t,i,r){this._renderer.intersect(e,t,i,r)},s.getElevation=function(e,t,i,r){const s=this._rootTiles;if(null==s||!s.length)return null;if(0===s[0].layerInfo[X.LayerClass.ELEVATION].length)return null;const n=ve;if(n[0]=e,n[1]=t,n[2]=i,!R.projectVectorToVector(n,r,n,this._spatialReference))return d.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;return be(s,n[0],n[1])},s.getElevations=function(e,t,i){const r=this._rootTiles,s=r?r[0].layerInfo[X.LayerClass.ELEVATION].length:0;if(null!=r&&r.length&&0!==s)for(let n=0;n<t;++n){const t=3*n;i(n,be(r,e[t],e[t+1]))}else for(let n=0;n<t;++n)i(n,null)},s.getScale=function(e){if(!this.tilingScheme)return null;if(!R.projectPointToVector(e,ve,this.spatialReference))return d.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const i of t)if(i?.containsPoint(ve)){let e=i;for(;e.children[0]&&!e.rendered;){const t=e.children[0].extent;let i=0;ve[0]>t[2]&&(i+=1),ve[1]<t[1]&&(i+=2),e=e.children[i]}return this._getLodBiasCorrectedScale(e.level)}return 1/0},s.getSphereElevationBounds=function(e,t){if(ve[0]=e[0],ve[1]=e[1],ve[2]=e[2],ve[3]=e[3],!R.projectVectorToVector(ve,t,ve,this.tilingScheme?.spatialReference))return d.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let i=1/0,r=-1/0;const s=e=>{if(e&&C.intersectsSphere(e.extent,ve))if(e.isLeaf||e.rendered)i=Math.min(i,e.elevationBounds[0]),r=Math.max(r,e.elevationBounds[1]);else for(const t of e.children)s(t)},n=this._rootTiles;if(null!=n)for(const a of n)s(a);return{min:i,max:r}},s.getSphereScale=function(e,t){if(!this.tilingScheme)return null;if(!R.projectPointToVector(e,ve,this.spatialReference))return d.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;ve[3]=t;let i=null;const r=e=>{if(e&&C.intersectsSphere(e.extent,ve)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)r(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},s=this._rootTiles;if(null!=s)for(const n of s)r(n);return i},s.queryVisibleScaleRange=function(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+a,n+a,r)},s._evaluateTransparency=function(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?t?te.TransparencyMode.Empty:te.TransparencyMode.TransparentWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?te.TransparencyMode.Opaque:te.TransparencyMode.Semitransparent,s=i!==r;return s&&(this._renderer.transparency=r,this.view?._stage?.renderer.setParameters({terrainTransparency:this._renderer.transparency})),s},s._updateTilingScheme=function(){const e=this.tilingSchemeLogic.tilingScheme;if(!(e!==this.tilingScheme))return;re.weakAssert(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??D.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateeCarree=this._isWebMercator&&P.isPlateCarree(this.view?.renderSpatialReference),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles())},s._acquireTile=function(e,t,i,r){const s=this._tilePool.acquire();return Ee[0]=e,Ee[1]=t,Ee[2]=i,s.init(Ee,r,this),s},s._updateRootTiles=function(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=we;let r=t.rootTilesInExtent(e,i,5*ee.MAX_ROOT_TILES);if(null!=this._rootTiles){if(r.length>ee.MAX_ROOT_TILES)return void d.getLogger(this).warn(ee.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);const e=this._rootTiles.map((e=>e.lij)),t=n.difference(e,r,Te);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>Te(t,e.lij)))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,r.length>ee.MAX_ROOT_TILES&&(d.getLogger(this).warn(ee.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),r=t.rootTilesInExtent(e,i,ee.MAX_ROOT_TILES)),this._setRootTiles(r.map((e=>this._newRootTile(e))));C.equals(i,this._rootTilesExtent)||(this._rootTilesExtent=C.create(i)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()},s._updateAllTileGeometries=function(){const e=this._allTiles.filter((e=>e.isLoaded&&e.intersectsClippingArea));e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()},s._updateTilesGeometries=function(e){if(0===e.length)return;e.sort(oe.compareTilesByLij);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))},s._shouldSplit=function(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===ae.TileUpdate.SPLIT},s._newRootTile=function(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(ae.TileUpdate.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t},s._setRootTiles=function(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)},s._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())},s._viewChangeUpdate=function(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))},s._updateClippingStatus=function(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(ae.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(e)},s._updateTilesVisibility=function(e){if(null==e)return;const t=oe.hasLoadableSiblings(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,s=t?i.max:-1/0;const n=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(n)&&e.resetPendingUpdate(ae.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(e),e.setPendingUpdate(ae.TileUpdate.RENDERDATA),e.computeVisibility(),e.updateScreenDepth(a),e.renderData&&(r=Math.min(e.elevationBounds[0],r),s=Math.max(e.elevationBounds[1],s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new G.ElevationBounds(r,s))},s._updateRootTileElevationBounds=function(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach((({elevationBounds:i})=>{e=Math.min(e,i[0]),t=Math.max(t,i[1])}));const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new G.ElevationBounds(e,t))},s._updateViewDependentParameters=function(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(null==this._splitLimits.frustum&&(this._splitLimits.frustum=A.create()),A.copy(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,A.copy(this._frustum,e.frustum),v.multiply(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),E.copy(this._eyePosRenderSR,t.eye),R.projectVectorToVector(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)},s._updateRenderData=function(e){e.rendered&&!e.shouldLoad&&(fe(e)?this._loadChildren(e):me(e)&&this._loadParent(e))},s._updateTileGeometryState=function(e){e.updateVisibility();this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null},s._markAllTileNeighborsForGeometryUpdate=function(e){const t=this._pendingTilesToUpdate;e.forEachLoadedNeighbor((e=>{t.add(e)}))},s._updateTileTexture=function(e,t){const i=e.resetPendingUpdate(ae.TileUpdate.TEXTURE_FADING)?ae.TileUpdate.TEXTURE_FADING:!!e.resetPendingUpdate(ae.TileUpdate.TEXTURE_NOFADING)&&ae.TileUpdate.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())},s._emitElevationUpdateEventForTiles=function(){const e=Se.extent;C.empty(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>C.expand(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),Se.spatialReference=this.spatialReference,this.emit("elevation-change",Se)},s.runTask=function(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue")},s._updateAllTilesStatus=function(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();t.reset(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;for(;!t.done;){const e=t.next(),n=e.shouldSplit(r,s,i);if(n!==ae.TileUpdate.SPLIT){if(e.resetPendingUpdate(ae.TileUpdate.SPLIT)&&e.updateAgentSuspension(),n===ae.TileUpdate.ELEVATION&&e.updateAgents(X.LayerClass.ELEVATION),t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(ae.TileUpdate.MERGE),e.resetPendingUpdate(ae.TileUpdate.SPLIT);const t=this._iteratorPool.acquire();t.resetOne(e);const i=this._viewProjectionMatrix;for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(i);t.remove()}}else e.resetPendingUpdate(ae.TileUpdate.MERGE),e.isLeaf&&(e.setPendingUpdate(ae.TileUpdate.SPLIT),t.skipSubtree()),e.rendered&&e.setPendingUpdate(ae.TileUpdate.RENDERDATA)}t.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),e.madeProgress()},s._sortTiles=function(e){e.done||this._allTilesSorted||(oe.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())},s._markTileToUpdate=function(e){re.internalAssert(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForGeometryUpdate(e))},s._batchUpdatePendingTileGeometries=function(){const e=this._pendingTilesToUpdate;if(0===e.size)return;const t=Array.from(this._pendingTilesToUpdate.keys()).filter((e=>e.isLoaded&&e.intersectsClippingArea)),i=(i,r)=>{!r?.isLoaded||!r.intersectsClippingArea||r.level<i.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(oe.compareTilesByLij);const r=t.length;for(let s=0;s<r;++s){const r=t[s];re.internalAssert(r.isLoaded),re.internalAssert(r.intersectsClippingArea);const n=r.renderData;n.updateNeighborData();const a=n._dirtyEdgeResolutions,o=n.geometryState.neighborData.cornerPeerNeighbors,l=e=>{const t=re.neighborCornerIndices[e];i(r,o[e]?.findCorner(re.oppositeCorner(t),(e=>e.isLoaded)))};for(let t=0;t<4;++t)if(a&1<<t){const s=n.geometryState.neighborData.edgePeerNeighbors[t];s&&s?.level>=r.level&&s.forAllSubtreeOnSide(re.oppositeEdge(re.neighborEdgeIndices[t]),(t=>!(!t.isLoaded||!t.intersectsClippingArea)&&(re.internalAssert(e.has(t)||oe.compareTilesByLij(r,t)<0),i(r,t),!0))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),re.ENABLE_TERRAIN_INTERNAL_CHECKS&&re.ENABLE_WATERPROOFNESS_TESTS&&this.checkAllTilesWaterproofness()},s._mergeAndSplit=function(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let n=!1;const a=!this._allTiles.some((s=>{if(!i&&!r&&!s.visible)return e.done;let a=s;if(s.resetPendingUpdate(ae.TileUpdate.MERGE)){if(!t)return s.setPendingUpdate(ae.TileUpdate.MERGE),e.done;for(;a.parent?.resetPendingUpdate(ae.TileUpdate.MERGE);)a=a.parent;this._mergeTile(a),n=!0,e.madeProgress()}else s.resetPendingUpdate(ae.TileUpdate.SPLIT)&&(this._splitTile(s),n=!0,e.madeProgress());return!e.done&&a===s&&s.resetPendingUpdate(ae.TileUpdate.RENDERDATA)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0),a){if(!i){i=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(e)},s._updateElevation=function(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(ae.TileUpdate.GEOMETRY)&&(this._updateTileGeometryState(t),this._updateTileTexture(t,e),this.shortBatches&&this._batchUpdatePendingTileGeometries(),e.madeProgress()),e.done))),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())},s._updateTextures=function(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))},s._updateClippingExtent=function(){this.spatialReference&&(this.updateTileOverlayParams(ue.RenderRequestType.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())},s._getLodBiasCorrectedScale=function(e){const t=this.tilingScheme.levels,i=h.clamp(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r},s._removeAllTiles=function(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1},s._purgeDescendantTiles=function(e){if(!e.children[0])return!1;let t=!1;for(let i=0;i<4;++i)t=this._purgeTile(e.children[i])||t;return e.unsetChildren(),t},s._purgeTile=function(e){const t=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),this._tilePool.release(e),t},s._unloadTile=function(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)},s._splitTile=function(e){re.weakAssert(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(ae.TileUpdate.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit},s._emitTileScaleChange=function(e,t=e.level){Ue.spatialReference=this.spatialReference,Ue.extent=e.extent,Ue.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Ue)},s._createTile=function(e,t,i,r){re.weakAssert(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(ae.TileUpdate.SPLIT),s},s._mergeTile=function(e){re.weakAssert(!e.hasPendingUpdate(ae.TileUpdate.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(re.weakAssert(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged},s._loadChildren=function(e){re.weakAssert(e.rendered,"parent should be rendered"),this._unloadTile(e);const t=e.children;t.forEach((e=>this._loadTile(e))),t.forEach((e=>this._pendingTilesToUpdate.add(e))),this._markAllTileNeighborsForGeometryUpdate(e),this._emitTileScaleChange(e,e.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()},s._loadParent=function(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t),this._markTileToUpdate(t),this._emitTileScaleChange(t,t.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()},s._unloadChildren=function(e){const t=e.children;if(t[0])for(let i=0;i<4;++i){const e=t[i];this._unloadChildren(e),this._unloadTile(e)}},s._loadTile=function(e){e.load(),e.setPendingUpdate(ae.TileUpdate.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)},s._elevationDataArrived=function(e,t,i){const r=new W.ElevationData(e.lij,e.extent,i);e.dataArrived(t,X.LayerClass.ELEVATION,r);const s=[e],n=e.level,a=this._iteratorPool.acquire();for(a.reset(s);!a.done;){const e=a.next();e.findElevationBoundsForLayer(t,n),e.computeElevationBounds()}0===n&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(s)},s._handleLayerViewChanges=function(e=_e.noBudget){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),re.isSurfaceLayerView(s)||re.isGroupLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)&&!re.isGroupLayerView(s)){const e=this._layerClassFromLayerView(s),i=this._getLayerIdxByUID(e,s.uid);null!=i&&((i<r||null==r)&&(t=!0),r=i)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()},s._allSurfaceLayersTransparent=function(){let e=0===this.view.map?.ground?.opacity;for(const t of this.view.allLayerViews.items)if(re.isMapTileLayerView(t)&&!I.isBaseLayer(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e},s._hasCompositeBlendMode=function(){for(const e of this.view.allLayerViews.items)if((re.isBlendableLayerView(e)||re.isGroupLayerView(e))&&he.isCompositeBlendMode(he.blendModeFromString[e.layer.blendMode]))return!0;return!1},s._layerClassFromLayerView=function(e){return re.isElevationLayerView(e)?X.LayerClass.ELEVATION:X.LayerClass.MAP},s._registerTiledLayerView=function(e){const t=[];if((re.isBlendableLayerView(e)||re.isGroupLayerView(e))&&t.push(y.watch((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(Q.TextureUpdate.UNFADED)}))),!re.isGroupLayerView(e)){const i=this._layerClassFromLayerView(e);t.push(y.watch((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push(y.watch((()=>e.fullOpacity),(()=>this._updateTileTextures(Q.TextureUpdate.UNFADED)))),t.push(y.watch((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)},s._unregisterTiledLayerView=function(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}},s._updateTiledLayers=function(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!re.isSurfaceLayerView(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(r===X.LayerClass.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)}));for(const r of X.LayerClasses){const e=this._layerViews[r],i=t[r];i.reverse();const s=i.length;let n=e.length!==s;const a=new Array(s),o=new Array(e.length);this._layerIndexByUid[r].clear();for(let t=0;t<s;t++){const s=i[t].uid;this._layerIndexByUid[r].set(s,t);const l=e.indexOf(i[t]);a[t]=l,t!==l&&(n=!0),l>-1&&(o[l]=t)}if(n){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;)e.next().modifyLayers(o,a,r);this._layerViews[r]=i,this._restartAllAgents(r),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()},s._restartAllAgents=function(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===X.LayerClass.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()},s.layerViewByIndex=function(e,t){return this._layerViews[t][e]},s.numLayers=function(e){return this._layerViews[e].length},s._updateTileTextures=function(e){this._allTiles.forAll((t=>{t.updateAgents(X.LayerClass.MAP),e===Q.TextureUpdate.IMMEDIATE?this.renderer.updateTileTexture(t,ae.TileUpdate.TEXTURE_NOFADING):t.updateRenderData(X.LayerClass.MAP,e)})),this._evaluateTransparency()},s._invalidateLayerData=function(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))},s.setTileTreeDirty=function(){this._allTilesDirty=!0},s.requestRender=function(e=ue.RenderRequestType.UPDATE){this.renderer.setNeedsRender(e)},s.requestUpdate=function(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)},s.requestTileData=function(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||re.isVectorTileLayerView(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,_.throwIfAborted(r),_.isAbortError(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))},s._requestTileData=function(e,t,i,r){return t===X.LayerClass.ELEVATION?re.isElevationLayerView(i)?this._requestElevationTileData(e,i,r):Promise.reject():re.isMapTileLayerView(i)?this._requestMapTileData(e,i,r):Promise.reject()},s._requestElevationTileData=function(e,t,i){++this._asyncWorkItems;const r=r=>{if(_.isAborted(i))return;const s=this._layerIndexByUid[X.LayerClass.ELEVATION].get(t.uid);null!=s?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,s,r)):d.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",X.LayerClass.ELEVATION,e.lij.toString())},s=i=>{_.isAbortError(i)||(this._dataMissing(e,X.LayerClass.ELEVATION,t,i),this.requestUpdate())};if(re.useFetchTileForLayer(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:ee.ELEVATION_NODATA_VALUE,signal:i.signal}).then((e=>{if(!_.isAborted(i))return this._frameTask.schedule((()=>r(e)),i.signal,s);d.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")}),s).finally((()=>{--this._asyncWorkItems}));const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:ee.ELEVATION_NODATA_VALUE},i.signal))).then((e=>{e?r(new k.ElevationTileData(e)):s(new Error("LERC decoding failed"))}),s).finally((()=>{--this._asyncWorkItems}))},s._requestMapTileData=function(e,t,i){++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,re.releaseTileData(s),_.isAborted(i)||(this._dataMissing(e,X.LayerClass.MAP,t,r),this.requestUpdate())},s=e=>t=>r(t,e),n=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),_.isAborted(i)?re.releaseTileData(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),a=(e,t=null)=>this._frameTask.schedule((()=>r(e,t)));if(re.isVectorTileLayerView(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(n,a)}if(re.isImageryTileLayerView(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(n,a);if(re.isTileLayerView(t)&&re.useFetchTileForLayer(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(_.isAborted(i))return d.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(_.createAbortError());n(e)}),a);let o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);M.isRefreshableLayer(t.layer)&&t.layer.refreshTimestamp&&(o+=`${o.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,l,i).then(n,a)},s._mapTileDataArrived=function(e,t,i){const r=this._getLayerIdxByUID(X.LayerClass.MAP,t.uid);null!=r?e.dataArrived(r,X.LayerClass.MAP,i):(re.releaseTileData(i),d.getLogger(this).warn("TerrainSurface: received data from unknown layer"))},s._getLayerIdxByUID=function(e,t){return this._layerIndexByUid[e].get(t)},s._dataMissing=function(e,t,i,r){const s=this._getLayerIdxByUID(t,i.uid);null!=s?e.dataMissing(s,t,r):d.getLogger(this).warn("TerrainSurface: received data from unknown layer")},s.updateTileOverlayParams=function(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))},s._recalculateUsedMemory=function(){return this.tilingScheme?this._allTiles.reduce(((e,t)=>e+t.usedMemory),0):null},s.getUsedMemoryForLayerView=function(e){let t=this.overlayManager.gpuMemoryUsage;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return null!=r&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t},s.getTile=function(e){if(null==e||null==this._rootTiles)return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this._rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let n;if(this._rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(n=e,!0))),n){let e=1<<t[0]-1;for(;n.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!n.children[i])return null;n=n.children[i],e>>=1}return re.weakAssert(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null},s.checkAllTilesWaterproofness=function(){if(!re.ENABLE_WATERPROOFNESS_TESTS)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},r=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.isLeaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)r(t)},s=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const r=e.visible;if(i!==r&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",r),!e.isLeaf)for(const n of e.children)s(n)};for(const n of e)r(n),s(n)},s.isEastEndWrap=function(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1},s.isWestEndWrap=function(e){return this.isGlobal&&0===e[2]},s.lijEastEnd=function(e){return 2**(e+(null!=this.spatialReference&&this.spatialReference.isGeographic?1:0))},s.wrapEastWest=function(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this.isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]},s.enableInternalChecks=function(e){re.enableTerrainInternalChecks(e)},s.enableWaterproofnessChecks=function(e){re.enableTerrainWaterproofnessChecks(e)},t._createClass(r,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){if(this.lodSnapping===Q.LODSnapping.ON){const e=this.view,t=this.tilingScheme,i=e.pointsOfInterest?.cameraOnSurface?.scale;if(t&&i){const r=e.state.contentCamera;let s=B.directionToHeadingTilt(e,r.eye,r.viewForward,r.up).tilt;s>90&&(s=180-s);const n=2*(s/90)**2,a=t.levelAtScale(i)-n,o=Math.min(a,this._splitLimits.maxLod||1/0);return o<=0?null:o}}return null}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Q.LODSnapping.ON:Q.LODSnapping.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const i=C.create(),r=j.toBoundingRect(t,i,e)?i:null,s=this._get("extent");return C.equals(r,s)?s:r}},{key:"rootTilesExtent",get:function(){return this._rootTilesExtent}},{key:"extent",get:function(){const e=C.intersection(this.groundExtent,this._userClippingExtent,C.create()),t=this._get("extent");return C.equals(e,t)?t:e}},{key:"groundExtent",get:function(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){return this.tilingSchemeLogic?.extent}},{key:"updating",get:function(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating)}},{key:"running",get:function(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}},{key:"updatingProgressValue",get:function(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}},{key:"baseOpacity",get:function(){return this.view?.map?.ground?.opacity??1},set:function(e){this.view.map.ground.opacity=e}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return null!=this._rootTiles}},{key:"renderOrder",set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}},{key:"rootTiles",get:function(){return this._rootTiles}},{key:"spatialReference",get:function(){return this.tilingScheme?.spatialReference??null}},{key:"backgroundColor",get:function(){return this.view.map.ground.surfaceColor},set:function(e){this.view.map.ground.surfaceColor=e}},{key:"slicePlaneEnabled",set:function(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}},{key:"tilingSchemeLocked",get:function(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}},{key:"wireframe",get:function(){return this._renderer?.wireframe},set:function(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}},{key:"_visible",set:function(e){e!==this._visibleCached&&(this._visibleCached=e,this._renderer.setVisibility(e),this.suspended=!e)}},{key:"opaque",get:function(){return this._renderer.transparency===te.TransparencyMode.Opaque}},{key:"suspended",set:function(e){this._set("suspended",e),this._viewChangeUpdate()}},{key:"textureFadeDuration",get:function(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}},{key:"updatingRootTiles",get:function(){return this._updatingRootTiles}},{key:"_lodBias",get:function(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*ee.MAX_MEMORY_LOD_BIAS}},{key:"shortBatches",get:function(){return this.view.state.mode!==pe.RenderState.IDLE}},{key:"performanceInfo",get:function(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}},{key:"usedMemory",get:function(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),null!=this._usedMemory?this._usedMemory:0):0}},{key:"renderPatchBorders",get:function(){return this._renderer.renderPatchBorders},set:function(e){this._renderer.renderPatchBorders=e}},{key:"visualizeNormals",get:function(){return this._renderer.visualizeNormals},set:function(e){this._renderer.visualizeNormals=e}},{key:"renderingDisabled",get:function(){return this._renderer.renderingDisabled},set:function(e){this._renderer.renderingDisabled=e}},{key:"test",get:function(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{null!=e._rootTiles&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){Le.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&Le.push(e)}));const t=Le.toArray();return oe.sortTiles(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}},{key:"isGlobal",get:function(){return this._isGlobal}},{key:"isWebMercator",get:function(){return this._isWebMercator}},{key:"isWebMercatorOnPlateeCarree",get:function(){return this._isWebMercatorOnPlateeCarree}}]),r}(o.EventedMixin(s));i.__decorate([g.property()],ye.prototype,"_renderer",void 0),i.__decorate([g.property({constructOnly:!0})],ye.prototype,"_scaleRangeQueries",void 0),i.__decorate([g.property({constructOnly:!0})],ye.prototype,"view",void 0),i.__decorate([g.property({constructOnly:!0})],ye.prototype,"overlayManager",void 0),i.__decorate([g.property()],ye.prototype,"_hasPendingUpdates",void 0),i.__decorate([g.property()],ye.prototype,"_asyncWorkItems",void 0),i.__decorate([g.property()],ye.prototype,"_allTilesDirty",void 0),i.__decorate([g.property()],ye.prototype,"_allTilesSorted",void 0),i.__decorate([g.property()],ye.prototype,"_viewChanged",void 0),i.__decorate([g.property()],ye.prototype,"_splitLimits",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"_watchUpdatingTracking",void 0),i.__decorate([g.property()],ye.prototype,"_frameTask",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"snapLevel",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"lodSnapping",null),i.__decorate([g.property()],ye.prototype,"_userClippingExtent",null),i.__decorate([g.property()],ye.prototype,"_rootTilesExtent",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"extent",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"groundExtent",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"_tilingSchemeExtent",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"updating",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"running",null),i.__decorate([g.property(q.updatingProgress)],ye.prototype,"updatingProgress",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"updatingProgressValue",null),i.__decorate([g.property()],ye.prototype,"_maxNumUpdating",void 0),i.__decorate([g.property()],ye.prototype,"baseOpacity",null),i.__decorate([g.property()],ye.prototype,"hasCompositeBlendMode",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"viewingMode",null),i.__decorate([g.property()],ye.prototype,"maxTextureScale",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"ready",null),i.__decorate([g.property({value:K.RenderOrder.FRONT_TO_BACK})],ye.prototype,"renderOrder",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"rootTiles",null),i.__decorate([g.property()],ye.prototype,"_rootTiles",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"spatialReference",null),i.__decorate([g.property({type:r})],ye.prototype,"backgroundColor",null),i.__decorate([g.property({value:!1})],ye.prototype,"slicePlaneEnabled",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"tilingScheme",void 0),i.__decorate([g.property({readOnly:!0})],ye.prototype,"tilingSchemeLocked",null),i.__decorate([g.property({readOnly:!0})],ye.prototype,"tilingSchemeLogic",void 0),i.__decorate([g.property()],ye.prototype,"wireframe",null),i.__decorate([g.property({value:!1})],ye.prototype,"suspended",null),i.__decorate([g.property()],ye.prototype,"textureFadeDuration",null),i.__decorate([g.property()],ye.prototype,"visibleElevationBounds",void 0),i.__decorate([g.property()],ye.prototype,"rootTileElevationBounds",void 0),i.__decorate([g.property()],ye.prototype,"_layerViewsDirty",void 0),i.__decorate([g.property()],ye.prototype,"renderPatchBorders",null),i.__decorate([g.property()],ye.prototype,"visualizeNormals",null),i.__decorate([g.property()],ye.prototype,"renderingDisabled",null),ye=i.__decorate([m.subclass("esri.views.3d.terrain.TerrainSurface")],ye);const ge=ye;function Te(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function fe(e){const t=e.children;if(!t[0])return!1;for(const i of t)if(i.shouldLoad)return!0;for(const i of t)if(fe(i))return!0;return!1}function me(e){return e.isLeaf&&(e.parent?.shouldLoad??!1)}const ve=S.create(),we=C.create(),Ee=[0,0,0],Le=new p,Se={spatialReference:null,extent:C.create(),context:"ground"},Ue={spatialReference:null,extent:null,scale:0};function be(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let e=r;for(;e&&!e.renderData;){const r=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[r]}const s=e?.renderData?.geometryState.samplerData??null;return W.sampleElevation(t,i,s)}return null}return ge}));
