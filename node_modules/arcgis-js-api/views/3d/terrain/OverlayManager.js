/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Cyclical","../../../core/Handles","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec2","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4","../../../chunks/vec4f64","../../../geometry/ellipsoidUtils","../../../geometry/projection","../../../geometry/support/aaBoundingRect","../../../geometry/support/ray","../../../chunks/sphere","../../../geometry/support/vector","../../../geometry/support/webMercatorUtils","../state/utils/viewUtils","../support/debugFlags","../support/debugUtils","./interfaces","./Overlay","./OverlayRenderer","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/Intersector","../webgl-engine/lib/LocalOriginFactory","../webgl-engine/lib/Material","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/textureUtils","../webgl-engine/parts/requireUtils","../../support/Scheduler"],(function(e,t,r,i,s,n,a,o,l,c,d,h,u,p,y,_,g,v,f,R,O,m,T,w,x,D,S,M,E,P,I,C,U,b,N,A,k,q,G,V,B){"use strict";const L=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let H;function F(e,t){const r=1e-5,i=E.TESTS_DISABLE_OPTIMIZATIONS?0:r*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}e.OverlayManager=function(e){function r(t){var r;return(r=e.call(this,t)||this)._handles=new n,r._spatialReference=null,r._renderSR=null,r._overlaySREqualsRenderSR=!0,r._drapeSources=new Set,r._drapeTargets=new Set,r._placementDirty=!1,r._contentUpdated=!1,r._drawTexturesDirty=!1,r._drawTexturesAnimateDirty=!1,r._hasUnusedRenderTargets=!1,r._longitudeCyclical=null,r._latestOriginId=0,r._maxResolution=a("esri-mobile")?2048:4096,r._animationTimeLast=0,r._removeRenderOverlayCallback=()=>{},r}t._inherits(r,e);var i=r.prototype;return i.initialize=function(){const e=this.view;this.renderer=new U.OverlayRenderer({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference});const t=()=>this.setDrawTexturesDirty();this._groundIntersector=N.newIntersector(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(()=>{t(),this.notifyChange("hasHighlights")})),this.renderer.events.on("has-water",(t=>e._stage?.renderer.setParameters({hasOverlayWater:t}))),this.renderer.events.on("renders-occluded",(()=>{t(),this.notifyChange("rendersOccluded")})),this.renderer.events.on("content-changed",t),c.watch((()=>e.state.camera.pixelRatio),t),c.watch((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.updateOverlayResult())),c.watch((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),c.watch((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),c.sync),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(B.TaskPriority.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(B.noBudget,e.camera,b.RenderRequestType.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,b.RenderRequestType.BACKGROUND,e)}))]);let r=e=>this._renderOverlayCallback(e);this._removeRenderOverlayCallback=()=>{r=()=>{}},e._stage?.renderer.setParameters({renderOverlay:e=>r(e)})},i._renderOverlayCallback=function(e){this._contentUpdated=!1;const t=this.renderer;t.processSyncDrapeSources(),t.hasOverlays&&(this._dispatchAnimationUpdate(e),this._drawOverlayTextures(t.overlays,b.RenderRequestType.UPDATE,this.view.state)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()},i.destroy=function(){this._handles=l.destroyMaybe(this._handles),this._removeRenderOverlayCallback(),this.view?._stage?.renderer.setParameters({renderOverlay:()=>{}}),null!=H&&(H.hide(),H=null)},i.setSpatialReference=function(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new s.Cyclical(-20037508.342787,20037508.342787):new s.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()},i.registerDrapeSource=function(e,t,r){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const i=this.renderer.createDrapeSourceRenderer(e,t,r);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),i},i.registerGeometryDrapeSource=function(e){return this.registerDrapeSource(e,q.SortedRenderGeometryRenderer)},i._updateDrapeSourceExtent=function(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)},i.unregisterDrapeSource=function(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))},i.registerDrapeTarget=function(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)},i.updateOverlayResult=function(){this.view._stage?.renderer.setParameters({overlays:this.renderer.overlays})},i.unregisterDrapeTarget=function(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)},i._setContentDirty=function(){this.setPlacementDirty(),this.setDrawTexturesDirty()},i.setPlacementDirty=function(){this._placementDirty=!0},i.runTask=function(e){return this._updateOverlays(e,this.view.state.contentCamera,b.RenderRequestType.UPDATE)},i._updateOverlays=function(e,t,r){if(!this._spatialReference)return B.Task.YIELD;const i=this._computeOverlayResolution(t);this._computeOverlayExtents(t,i,W);const s=T.width(W.inner)/T.width(W.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const n=this._updateOverlay(I.OverlayIndex.INNER,W.inner,i,1*W.pixelRatioAdjustment,W.mapUnitsPerPixel),a=this._updateOverlay(I.OverlayIndex.OUTER,W.outer,i,s*W.pixelRatioAdjustment,W.mapUnitsPerPixel);n!==Z.EXTENT&&a!==Z.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(r)),n===Z.NONE&&a===Z.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()},i._computeOverlayResolution=function(e){const t=this.view.state.contentPixelRatio,r=e.fullWidth/e.pixelRatio*t,i=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(r,i));return Math.min(G.applyTextureResizeModulo(s),this._maxResolution)},i._updateOverlay=function(e,t,r,i,s){if(0===this.renderer.overlays.length)return Z.NONE;const n=this.renderer.overlays[e],a=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=i,F(t,n.extent)&&r===n.resolution)return a===s?Z.NONE:Z.RERENDER_ONLY;T.copy(n.extent,t),n.resolution=r;const o=T.center(n.extent);return n.renderLocalOrigin=A.fromValues(o[0],o[1],0,"OV_"+this._latestOriginId++),Z.EXTENT},i.setTileParameters=function(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const r=this.renderer.overlays[I.OverlayIndex.INNER],i=this.renderer.overlays[I.OverlayIndex.OUTER],s=e.extent;this._rectInsideRect(r.extent,s)||this._rectanglesOverlap(s,r.extent)||this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,I.OverlayIndex.INNER,t),this._setTileOverlayData(s,I.OverlayIndex.OUTER,t)):(this._clearTileOverlayData(I.OverlayIndex.INNER,t),this._clearTileOverlayData(I.OverlayIndex.OUTER,t))}else this._clearTileOverlayData(I.OverlayIndex.INNER,t),this._clearTileOverlayData(I.OverlayIndex.OUTER,t)},i.overlayPixelSizeInMapUnits=function(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[I.OverlayIndex.INNER],r=this.renderer.overlays[I.OverlayIndex.OUTER],i=this._pointIsInExtent(e,t.extent)?t:r;return(i.extent[2]-i.extent[0])/i.resolution},i._setTileOverlayData=function(e,t,r){if(0===this.renderer.overlays.length)return;const i=this.renderer.overlays[t].extent,s=T.width(i),n=T.height(i);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(i[0],a);const t=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}r.setScale(t,T.width(e)/s,T.height(e)/n),r.setOffset(t,(a-i[0])/s,(e[1]-i[1])/n)},i._clearTileOverlayData=function(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)},i.reloadShaders=async function(){V.removeLoadedShaderModules(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(B.noBudget)},i._dispatchAnimationUpdate=function(e){const t=d.Milliseconds(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||null!=this.view.state.forcedAnimationTime||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const r=d.Milliseconds(t/this.surface.view._stage.renderer.animationTimeDilation),i=new k.UpdateParameters(this.view.state.camera,r,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(i)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}},i.setDrawTexturesDirty=function(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()},i._intersectGroundFromView=function(e,t,r,i){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,K,t,r);if(null==s)return!1;const n=s.origin,a=g.add(z,s.origin,s.direction);return this._groundIntersector.reset(n,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,a),this._groundIntersector.results.min.getIntersectionPoint(i)},i._findHorizonBasedPointOfInterest=function(e,t){let r=.5;const i=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,l=1e-5,c=o.clamp(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+l,e.aboveGround?n-l:1/0),d=e.aboveGround;if("global"===this.view.viewingMode){const t=z;x.closestPointOnSilhouette(x.fromRadius(x.tmpSphere,O.getReferenceEllipsoid(this.view.spatialReference).radius+c),w.wrap(e.eye,e.viewForward),t),g.subtract(t,t,e.eye);const n=s.cyclicalPI.normalize(D.angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,a=n<=0||n>=1?.5:i;r=d?a*n:n+a*(1-n)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),n=R.fromValues(0,s,1,0),a=f.transformMat4(n,n,e.projectionMatrix)[1],l=o.clamp(.5+.5*a,0,1);r=1===l||0===l?.5:d?l*i:1-(1-l)*i}return!!this._intersectGroundFromView(e,.5,r,t)&&g.sqrDist(t,e.eye)<a.distance*a.distance},i._computeOverlayExtents=function(e,t,r){const i=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=v.create();this._findHorizonBasedPointOfInterest(e,s)||g.copy(s,i),E.OVERLAY_SHOW_CENTER?(null==H&&(H=new P.PointGraphics(this.view.graphics,"red")),H.show(s,this._renderSR)):null!=H&&H.hide();const n=Math.max(.1,g.distance(e.eye,s)),a=M.viewAngle(this.view.renderCoordsHelper,i,e.eye);this._overlaySREqualsRenderSR||m.projectVectorToVector(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&null!=this._spatialReference&&this._spatialReference.isGeographic,d=c&&null!=this._spatialReference?1/O.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,u=e.perScreenPixelRatio/h*n*d;r.mapUnitsPerPixel=u/this._worldToPCSRatio;let p=t*u/2*C.OverlayStretch,y=!1,R=c?90:1/0;this._isSpherical&&null!=l&&null!=this._spatialReference&&(this._spatialReference.isWebMercator?(p/=Math.cos(S.y2lat(s[1])),R=l[3]):(y=!0,p/=O.getReferenceEllipsoid(this._spatialReference).metersPerDegree,R=90),p>=R&&(p=R,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let w=1;y&&(w=1/Math.max(.2,Math.cos(Math.abs(o.deg2rad(s[1])))),p*w>180&&(w=180/p),r.mapUnitsPerPixel*=w);const x=Math.log(2)/12;p=Math.exp(Math.round(Math.log(p)/x)*x);const D=p*w,I=32,U=.5*t/(I*D),b=.5*t/(I*p);s[0]=Math.round(s[0]*U)/U,s[1]=Math.round(s[1]*b)/b;const N=r.inner;N[0]=s[0]-D,N[1]=s[1]-p,N[2]=s[0]+D,N[3]=s[1]+p,this._isSpherical&&this._shiftExtentToFitBounds(N,1/0,R);const A=r.outer;if(6*D>T.width(l))T.copy(A,l);else{if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)A[0]=N[0]-D,A[1]=N[1]-p,A[2]=N[2]+D,A[3]=N[3]+p;else{m.projectVectorToVector(e.eye,this._renderSR,z,this._spatialReference),_.subtract(j,s,z);let t=-Math.atan2(j[1],j[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));f.scale(j,L[r],2*p),j[0]*=w,j[2]*=w,f.add(A,N,j)}}if(this._isSpherical)A[0]=this._longitudeCyclical.clamp(A[0]),A[2]=this._longitudeCyclical.clamp(A[2]),A[1]=Math.max(A[1],-R),A[3]=Math.min(A[3],R);else{const e=T.intersection(N,l,Y),t=T.intersection(A,l,X);T.contains(e,t)&&(A[2]=A[0],A[3]=A[1])}const k=Math.abs(N[2]-N[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,k),r.pixelRatioAdjustment=r.mapUnitsPerPixel/k},i._drawOverlayTextures=function(e,t,r){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const i=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const s=this._drawOverlay(e[I.OverlayIndex.INNER],r),n=this._drawOverlay(e[I.OverlayIndex.OUTER],r);s!==b.ValidationState.CHANGED&&n!==b.ValidationState.CHANGED||this.surface.updateTileOverlayParams(b.RenderRequestType.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),i?(this.surface.requestRender(t),t===b.RenderRequestType.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(b.RenderRequestType.BACKGROUND)},i._drawOverlay=function(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t)},i._collectUnusedRenderTargetMemory=function(){this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays&&(this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory())},i._rectanglesOverlap=function(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):T.intersects(e,t))},i._rectInsideRect=function(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:T.contains(e,t))},i._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]},i._shiftExtentToFitBounds=function(e,t,r){let i=0,s=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?s=e[1]+r:e[3]>r&&(s=r-e[3]),T.offset(e,i,s)},t._createClass(r,[{key:"running",get:function(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||E.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this.view.state.isGlobal}},{key:"_worldToPCSRatio",get:function(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?O.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1}},{key:"suspended",get:function(){return this.surface.suspended}},{key:"updating",get:function(){return this.running||this.renderer.updating||this._contentUpdated}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"gpuMemoryUsage",get:function(){return this.renderer.gpuMemoryUsage}},{key:"test",get:function(){return{renderer:this.renderer,update:()=>this.runTask(B.noBudget)}}}]),r}(i),r.__decorate([h.property()],e.OverlayManager.prototype,"_spatialReference",void 0),r.__decorate([h.property({readOnly:!0})],e.OverlayManager.prototype,"running",null),r.__decorate([h.property()],e.OverlayManager.prototype,"_placementDirty",void 0),r.__decorate([h.property()],e.OverlayManager.prototype,"_contentUpdated",void 0),r.__decorate([h.property()],e.OverlayManager.prototype,"_isSpherical",null),r.__decorate([h.property()],e.OverlayManager.prototype,"_worldToPCSRatio",null),r.__decorate([h.property({autoDestroy:!0})],e.OverlayManager.prototype,"renderer",void 0),r.__decorate([h.property({constructOnly:!0})],e.OverlayManager.prototype,"view",void 0),r.__decorate([h.property({constructOnly:!0})],e.OverlayManager.prototype,"surface",void 0),r.__decorate([h.property()],e.OverlayManager.prototype,"suspended",null),r.__decorate([h.property()],e.OverlayManager.prototype,"updating",null),r.__decorate([h.property({type:Boolean})],e.OverlayManager.prototype,"hasHighlights",null),r.__decorate([h.property({type:Boolean})],e.OverlayManager.prototype,"rendersOccluded",null),e.OverlayManager=r.__decorate([y.subclass("esri.views.3d.terrain.OverlayManager")],e.OverlayManager);const j=R.create(),z=v.create(),W={inner:T.create(),outer:T.create(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},Y=T.create(),X=T.create(),K=w.create();var Z;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(Z||(Z={})),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
