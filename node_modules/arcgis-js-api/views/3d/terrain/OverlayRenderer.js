/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/Handles","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/reactiveUtils","../../../core/SetUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/vec3","../../../chunks/vec3f64","../../ViewingMode","../layers/interfaces","../support/debugFlags","./interfaces","./Overlay","./OverlayFramebufferObject","./OverlayRenderTarget","../webgl-engine/core/shaderLibrary/ShaderOutput","../../../chunks/TextureOnly.glsl","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/Camera","../webgl-engine/lib/GLMaterialRepository","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/Material","../webgl-engine/lib/RenderContext","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/ShadowMap","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/SSAOHelper","../webgl-engine/lib/TextureTechnique","../webgl-engine/lib/TextureTechniqueConfiguration","../webgl-engine/lib/TransparencyPassType","../webgl-engine/lib/UpdatePolicy","../webgl-engine/lighting/Lightsources","../../support/Scheduler","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor","../../webgl/Util"],(function(e,r,t,s,i,n,a,o,d,h,l,c,u,p,y,_,g,R,T,m,f,v,b,O,w,x,S,D,P,E,C,M,A,F,k,q,V,L,B,U,W,I,H,G,N,z,j,Y,X,Q){"use strict";e.OverlayRenderer=function(e){function t(r){var t;return(t=e.call(this,r)||this)._overlays=null,t._overlayRenderTarget=null,t._hasHighlights=!1,t._rendersOccluded=!1,t._hasWater=!1,t._handles=new n,t._renderers=new Map,t._sortedDrapeSourceRenderersDirty=!1,t._sortedRenderers=new d,t._passParameters=new P.TextureOnlyPassParameters,t._materialRepository=null,t._screenToWorldRatio=1,t._localOriginFactory=null,t._camera=new C.Camera,t.worldToPCSRatio=1,t.events=new i,t.longitudeCyclical=null,t}r._inherits(t,e);var s=t.prototype;return s.initialize=function(){const e=this.view._stage.renderView,{waterTextureRepository:r,stippleTextureRepository:t,markerTextureRepository:s}=e;this._shaderTechniqueRepository=new E.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:f.ViewingMode.Local,stippleTextureRepository:t,markerTextureRepository:s,waterTextureRepository:r}),this._renderContext=new q.OverlayRenderContext(this._rctx,new L.ShadowMap(this._rctx,this.view.state.viewingMode),new U.SSAOHelper(this.view,this._shaderTechniqueRepository,this._rctx,(()=>{}))),this._handles.add([h.watch((()=>r.updating),(()=>this.events.emit("content-changed")),h.syncAndInitial),h.watch((()=>this.spatialReference),(e=>this._localOriginFactory=new F.GridLocalOriginFactory(e)),h.syncAndInitial),h.on((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new M.GLMaterialRepository(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&$)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=V.RenderSlot.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=A.createEmptyDepthTexture(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=H.TransparencyPassType.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new N.AmbientLight(m.fromValues(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(z.TaskPriority.STAGE,this))},s.destroy=function(){this._handles.destroy(),this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=o.releaseMaybe(this._debugTextureTechnique),this._passParameters.texture=o.disposeMaybe(this._passParameters.texture),this._bindParameters.highlightDepthTexture=o.disposeMaybe(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=o.destroyMaybe(this._shaderTechniqueRepository),this._temporaryFBO=o.disposeMaybe(this._temporaryFBO),this._quadVAO=o.disposeMaybe(this._quadVAO),this.disposeOverlays()},s.createGeometryDrapeSourceRenderer=function(e){return this.createDrapeSourceRenderer(e,B.SortedRenderGeometryRenderer)},s.createDrapeSourceRenderer=function(e,r,t){const s=this._renderers.get(e);null!=s&&s.destroy();const i=new r({...t,rendererContext:this,drapeSource:e});return this._renderers.set(e,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(h.watch((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),i},s.removeDrapeSourceRenderer=function(e){if(null==e)return;const r=this._renderers.get(e);null!=r&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),r.destroy())},s.collectUnusedRenderTargetMemory=function(){let e=!1;const r=c.now();if(null!=this._overlayRenderTarget)for(const t of this._overlayRenderTarget.renderTargets){const s=this.overlays[O.OverlayIndex.INNER].validTargets[t.type];e=this._overlayRenderTarget.validateUsageForTarget(s,t,r)||e}return e},s.ensureDrapeTargets=function(e){null!=this._overlays&&this._overlays.forEach((r=>r.hasTargetWithoutRasterImage=l.someSet(e,(e=>e.drapeTargetType===v.DrapeTargetType.WithoutRasterImage))))},s.ensureDrapeSources=function(e){null!=this._overlays&&this._overlays.forEach((r=>{r.hasDrapedFeatureSource=l.someSet(e,(e=>e.drapeSourceType===v.DrapeSourceType.Features)),r.hasDrapedRasterSource=l.someSet(e,(e=>e.drapeSourceType===v.DrapeSourceType.RasterImage))}))},s.ensureOverlays=function(e,r){null==this._overlays&&(this._overlayRenderTarget=new S.OverlayRenderTarget(this._rctx),this._overlays=[new w.Overlay(O.OverlayIndex.INNER,this._overlayRenderTarget),new w.Overlay(O.OverlayIndex.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)},s.disposeOverlays=function(){this._overlays=null,this._overlayRenderTarget=o.disposeMaybe(this._overlayRenderTarget),this.events.emit("textures-disposed")},s.runTask=function(e){this._processDrapeSources(e,(()=>!0))},s._processDrapeSources=function(e,r){let t=!1;for(const[s,i]of this._renderers){if(e.done)break;(s.destroyed||r(s))&&(i.commitChanges()&&(t=!0,e.madeProgress()))}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,t=!0,this._updateSortedDrapeSourceRenderers()),t&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())},s.processSyncDrapeSources=function(){this._processDrapeSources(z.noBudget,(e=>e.updatePolicy===G.UpdatePolicy.SYNC))},s.updateAnimation=function(e){let r=!1;return this._renderers.forEach((t=>r=t.updateAnimation(e)||r)),r},s.updateDrapeSourceOrder=function(){this._sortedDrapeSourceRenderersDirty=!0},s.drawTarget=function(e,r,t){const s=e.canvasGeometries;if(0===s.numViews)return!1;const{alignPixelEnabled:i,contentPixelRatio:n}=t;this._screenToWorldRatio=n*e.mapUnitsPerPixel/w.OverlayStretch;const a=r.output;if(this.isEmpty||a===D.ShaderOutput.Highlight&&!this.hasHighlights||a===D.ShaderOutput.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;const o=r.fbo;if(!o.isValid())return!1;const d=2*e.resolution,h=e.resolution;o.resize(d,h);const l=this._rctx;if(this._camera.pixelRatio=e.pixelRatio*n,this._renderContext.output=a,this._bindParameters.alignPixelEnabled=i,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=a===D.ShaderOutput.Normal?V.RenderSlot.DRAPED_WATER:V.RenderSlot.DRAPED_MATERIAL,e.applyViewport(this._rctx),o.bind(l),e.index===O.OverlayIndex.INNER&&(l.setClearColor(0,0,0,0),l.clearSafe(j.ClearBufferBit.COLOR_BUFFER_BIT)),r.type===O.RenderTargetType.Occluded&&(this._renderContext.renderOccludedMask=$),b.OVERLAY_DRAW_DEBUG_TEXTURE&&r.type!==O.RenderTargetType.Occluded)for(let c=0;c<s.numViews;c++)this._setViewParameters(s.extents[c],e),this._drawDebugTexture(e.resolution,J[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll((({drapeSource:t,renderer:i})=>{if(r.type===O.RenderTargetType.ColorNoRasterImage&&t.drapeSourceType===v.DrapeSourceType.RasterImage)return;const{fullOpacity:n}=t,c=null!=n&&n<1&&a===D.ShaderOutput.Color;c&&(this.bindTemporaryFramebuffer(this._rctx,d,h),l.clearSafe(j.ClearBufferBit.COLOR_BUFFER_BIT));for(let r=0;r<s.numViews;r++)this._setViewParameters(s.extents[r],e),i.render(this._renderContext);c&&null!=this._temporaryFBO&&(o.bind(l),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),n,e.index))})),l.bindFramebuffer(null),o.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0},s.bindTemporaryFramebuffer=function(e,r,t){null==this._temporaryFBO&&(this._temporaryFBO=new x.OverlayFramebufferObject(e,!1)),this._temporaryFBO.resize(r,t),this._temporaryFBO.bind(e)},s.reloadShaders=async function(){await this._shaderTechniqueRepository.reloadAll()},s.notifyContentChanged=function(){this.events.emit("content-changed")},s.intersect=function(e,r,t,s){let i=0;for(const n of this._renderers.values())i=n.intersect?.(e,r,t,s,i)??i},s._updateSortedDrapeSourceRenderers=function(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers;this._renderers.forEach(((r,t)=>{const s=e.indexOf(t.layer),i=s>=0,n=this._renderers.size*(t.renderGroup??(i?v.DrapedRenderGroup.MapLayer:v.DrapedRenderGroup.ViewLayer))+(i?s:0);this._sortedRenderers.push(new Z(t,r,n))})),this._sortedRenderers.sort(((e,r)=>e.index-r.index))},s._setViewParameters=function(e,r){const t=this._camera;t.viewport=[0,0,r.resolution,r.resolution],R.ortho(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),R.fromTranslation(t.viewMatrix,[-e[0],-e[1],0])},s._updateHasWater=function(){const e=a.someMap(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))},s._updateHasHighlights=function(){const e=a.someMap(this._renderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))},s._updateRendersOccluded=function(){const e=a.someMap(this._renderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))},s._drawDebugTexture=function(e,r){this._ensureDebugPatternResources(e,r);const t=this._rctx;t.bindTechnique(this._debugTextureTechnique,this._passParameters,null),t.bindVAO(this._quadVAO),t.drawArrays(j.PrimitiveType.TRIANGLE_STRIP,0,Q.vertexCount(this._quadVAO,"geometry"))},s._ensureDebugPatternResources=function(e,r){if(T.set(this._passParameters.color,r[0],r[1],r[2]),this._passParameters.texture)return;const t=new Uint8Array(e*e*4);let s=0;for(let a=0;a<e;a++)for(let r=0;r<e;r++){const i=Math.floor(r/10),n=Math.floor(a/10);i<2||n<2||10*i>e-20||10*n>e-20?(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=255):(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=1&i&&1&n?1&r^1&a?0:255:1&i^1&n?0:128)}const i=new X.TextureDescriptor(e);i.samplingMode=j.TextureSamplingMode.NEAREST,this._passParameters.texture=new Y.Texture(this._rctx,i,t);const n=new I.TextureTechniqueConfiguration;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(W.TextureTechnique,n),this._quadVAO=A.createQuadVAO(this._rctx)},r._createClass(t,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"_rctx",get:function(){return this.view._stage.renderView.renderingContext}},{key:"rctx",get:function(){return this._rctx}},{key:"materialRepository",get:function(){return this._materialRepository}},{key:"screenToWorldRatio",get:function(){return this._screenToWorldRatio}},{key:"localOriginFactory",get:function(){return this._localOriginFactory}},{key:"updating",get:function(){return this._sortedDrapeSourceRenderersDirty||a.someMap(this._renderers,(e=>e.updating))}},{key:"hasOverlays",get:function(){return null!=this._overlays&&null!=this._overlayRenderTarget}},{key:"gpuMemoryUsage",get:function(){return null!=this._overlayRenderTarget?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return this._overlays??[]}},{key:"running",get:function(){return this.updating}},{key:"isEmpty",get:function(){return!b.OVERLAY_DRAW_DEBUG_TEXTURE&&!a.someMap(this._renderers,(e=>!e.isEmpty))}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}}]),t}(s),t.__decorate([u.property()],e.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0),t.__decorate([u.property({autoDestroy:!0})],e.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0),t.__decorate([u.property({constructOnly:!0})],e.OverlayRenderer.prototype,"view",void 0),t.__decorate([u.property()],e.OverlayRenderer.prototype,"worldToPCSRatio",void 0),t.__decorate([u.property()],e.OverlayRenderer.prototype,"spatialReference",void 0),t.__decorate([u.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),t.__decorate([u.property()],e.OverlayRenderer.prototype,"isEmpty",null),e.OverlayRenderer=t.__decorate([g.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer);let Z=r._createClass((function(e,r,t){this.drapeSource=e,this.renderer=r,this.index=t}));const J=[[1,.5,.5],[.5,.5,1]],K=-2,$=k.RenderOccludedFlag.OccludeAndTransparent;e.DRAPED_Z=K,e.overlayRenderOccludedFlag=$,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
