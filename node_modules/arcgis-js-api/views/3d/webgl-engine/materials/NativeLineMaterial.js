/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../../../geometry/support/buffer/BufferView","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./DefaultBufferWriter","./DefaultLayouts","./internal/bufferWriterUtils","../shaders/NativeLineTechnique","../shaders/NativeLineTechniqueConfiguration"],(function(e,t,r,i,n,s,a,o,c,u,l,f,p,d,h,g,A,m,P,S,_,b,y,x){"use strict";var O;!function(e){e[e.START=0]="START",e[e.END=1]="END"}(O||(O={}));let T=function(e){function n(t){var r;return(r=e.call(this,t,new V)||this)._configuration=new x.NativeLineTechniqueConfiguration,r}t._inherits(n,e);var o=n.prototype;return o.getConfiguration=function(e,t){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=t.slot===A.RenderSlot.DRAPED_MATERIAL;const r=null!=this.parameters.stipplePattern;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&null!=this.parameters.stippleOffColor,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration},o.intersect=function(e,t,i,n,o,c){if(!i.options.selectionMode||!e.visible)return;if(!m.isTranslationMatrix(t))return void r.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const p=e.vertexAttributes.get(P.VertexAttribute.POSITION).data,d=i.camera,h=j;s.copy(h,i.point);const g=2;a.set(q[0],h[0]-g,h[1]+g,0),a.set(q[1],h[0]+g,h[1]+g,0),a.set(q[2],h[0]+g,h[1]-g,0),a.set(q[3],h[0]-g,h[1]-g,0);for(let r=0;r<4;r++)if(!d.unprojectFromRenderScreen(q[r],k[r]))return;f.fromPoints(d.eye,k[0],k[1],W),f.fromPoints(d.eye,k[1],k[2],X),f.fromPoints(d.eye,k[2],k[3],F),f.fromPoints(d.eye,k[3],k[0],G);let A=Number.MAX_VALUE,S=0;for(let r=0;r<p.length-5;r+=3){if(N[0]=p[r]+t[12],N[1]=p[r+1]+t[13],N[2]=p[r+2]+t[14],I[0]=p[r+3]+t[12],I[1]=p[r+4]+t[13],I[2]=p[r+5]+t[14],f.signedDistance(W,N)<0&&f.signedDistance(W,I)<0||f.signedDistance(X,N)<0&&f.signedDistance(X,I)<0||f.signedDistance(F,N)<0&&f.signedDistance(F,I)<0||f.signedDistance(G,N)<0&&f.signedDistance(G,I)<0)continue;if(d.projectToRenderScreen(N,C),d.projectToRenderScreen(I,E),C[2]<0&&E[2]>0){a.subtract(L,N,I);const e=d.frustum,t=-f.signedDistance(e[u.PlaneIndex.NEAR],N)/a.dot(L,f.normal(e[u.PlaneIndex.NEAR]));a.scale(L,L,t),a.add(N,N,L),d.projectToRenderScreen(N,C)}else if(C[2]>0&&E[2]<0){a.subtract(L,I,N);const e=d.frustum,t=-f.signedDistance(e[u.PlaneIndex.NEAR],I)/a.dot(L,f.normal(e[u.PlaneIndex.NEAR]));a.scale(L,L,t),a.add(I,I,L),d.projectToRenderScreen(I,E)}else if(C[2]<0&&E[2]<0)continue;C[2]=0,E[2]=0;const e=l.distance2(l.fromPoints(C,E,B),h);e<A&&(A=e,a.copy(M,N),a.copy(w,I),S=r/3)}const _=i.rayBegin,b=i.rayEnd;if(A<g*g){let e=Number.MAX_VALUE;if(l.closestLineSegmentPoint(l.fromPoints(M,w,B),l.fromPoints(_,b,U),D)){a.subtract(D,D,_);const t=a.length(D);a.scale(D,D,1/t),e=t/a.distance(_,b)}c(e,D,S,!1)}},o.intersectDraped=function(e,t,r,n,s,a){if(!r.options.selectionMode)return;const o=e.vertexAttributes.get(P.VertexAttribute.POSITION).data,c=e.vertexAttributes.get(P.VertexAttribute.SIZE),u=c?c.data[0]:0,l=n[0],f=n[1],p=((u+1)/2+4)*e.screenToWorldRatio;let d=Number.MAX_VALUE,h=0;for(let g=0;g<o.length-5;g+=3){const e=o[g],t=o[g+1],r=l-e,n=f-t,s=o[g+3]-e,a=o[g+4]-t,c=s*r+a*n,u=s*s+a*a,p=i.clamp(c/u,0,1),A=s*p-r,m=a*p-n,P=A*A+m*m;P<d&&(d=P,h=g/3)}d<p*p&&s(a.dist,a.normal,h,!1)},o.requiresSlot=function(e,t){return!(t!==d.ShaderOutput.Color&&t!==d.ShaderOutput.Highlight&&t!==d.ShaderOutput.ObjectAndLayerIdColor||e!==A.RenderSlot.OPAQUE_MATERIAL&&e!==A.RenderSlot.DRAPED_MATERIAL)},o.createGLMaterial=function(e){return new v(e)},o.createBufferWriter=function(){const e=this.parameters.hasVertexColors?_.PositionColorLayout:_.PositionLayout;return null==this.parameters.stipplePattern?new S.DefaultBufferWriter(e):new R(e.clone().vec3f(P.VertexAttribute.AUXPOS1).vec2f(P.VertexAttribute.UV0))},t._createClass(n)}(g.Material),v=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._stipplePattern=null,t}t._inherits(r,e);var i=r.prototype;return i.dispose=function(){t._get(t._getPrototypeOf(r.prototype),"dispose",this).call(this),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null},i._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},i.beginSlot=function(e){this._output===d.ShaderOutput.Color&&this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(y.NativeLineTechnique,e)},t._createClass(r)}(h),R=function(){function e(e){this.vertexBufferLayout=e}var r=e.prototype;return r.elementCount=function(e){return e.indices.get(P.VertexAttribute.POSITION).length},r.write=function(e,t,r,i,n){b.writeDefaultAttributes(r,this.vertexBufferLayout,e,t,i,n),this._writeAuxpos1(e,r,i,n),this._writeUV0(e,r,i,n)},r._writeAuxpos1=function(e,t,r,i){const n=r.getField(P.VertexAttribute.AUXPOS1,p.BufferViewVec3f),s=t.indices.get(P.VertexAttribute.POSITION),a=t.vertexAttributes.get(P.VertexAttribute.POSITION).data,o=e,c=n.typedBufferStride,u=n.typedBuffer;i*=c;for(let l=0;l<s.length-1;l+=2)for(const e of[1,0]){const t=3*s[l+e],r=a[t],n=a[t+1],f=a[t+2],p=o[0]*r+o[4]*n+o[8]*f+o[12],d=o[1]*r+o[5]*n+o[9]*f+o[13],h=o[2]*r+o[6]*n+o[10]*f+o[14];u[i]=p,u[i+1]=d,u[i+2]=h,i+=c}},r._writeUV0=function(e,t,r,i){const n=r.getField(P.VertexAttribute.UV0,p.BufferViewVec2f),s=t.indices.get(P.VertexAttribute.POSITION),o=t.vertexAttributes.get(P.VertexAttribute.POSITION).data,c=t.vertexAttributes.get(P.VertexAttribute.DISTANCETOSTART)?.data,u=n.typedBufferStride,l=n.typedBuffer;let f=0;l[i*=u]=O.START,l[i+1]=f,i+=u;const d=3*s[0],h=a.set(N,o[d],o[d+1],o[d+2]);e&&a.transformMat4(h,h,e);const g=I,A=s.length-1;let m=1;const S=c?(e,t,r)=>f=c[r]:(e,t,r)=>f+=a.distance(e,t);for(let p=1;p<A;p+=2){const t=3*s[p];a.set(g,o[t],o[t+1],o[t+2]),e&&a.transformMat4(g,g,e),S(h,g,m++);for(let e=0;e<2;++e)l[i]=1-e,l[i+1]=f,i+=u;a.copy(h,g)}const _=3*s[A];a.set(g,o[_],o[_+1],o[_+2]),e&&a.transformMat4(g,g,e),S(h,g,m),l[i]=O.END,l[i+1]=f},t._createClass(e)}(),V=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).color=c.ONES,t.hasVertexColors=!1,t.hasSlicePlane=!1,t.width=1,t.stipplePreferContinuous=!0,t.hasOccludees=!1,t.stippleTexture=null,t}return t._inherits(r,e),t._createClass(r)}(g.MaterialParameters);const N=o.create(),I=o.create(),L=o.create(),D=o.create(),C=n.createRenderScreenPointArray3(),E=n.createRenderScreenPointArray3(),M=o.create(),w=o.create(),B=l.create(),U=l.create(),j=o.create(),q=[n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3()],k=[o.create(),o.create(),o.create(),o.create()],W=f.create(),X=f.create(),F=f.create(),G=f.create();e.NativeLineMaterial=T,e.Parameters=V,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
