/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/mat4","../../../../../geometry/support/buffer/BufferView","../../lib/Util","../../lib/VertexAttribute"],(function(e,t,r,f,o){"use strict";function i(e,t,r,f,o=1){const i=r.typedBuffer,s=r.typedBufferStride,n=e.length;if(f*=s,1===o)for(let u=0;u<n;++u)i[f]=t[e[u]],f+=s;else for(let u=0;u<n;++u){const r=t[e[u]];for(let e=0;e<o;e++)i[f]=r,f+=s}}function s(e,t,r,f){const o=r.typedBuffer,i=r.typedBufferStride,s=e.length;f*=i;for(let n=0;n<s;++n){const r=2*e[n];o[f]=t[r],o[f+1]=t[r+1],f+=i}}function n(e,t,r,f,o){const i=r.typedBuffer,s=r.typedBufferStride,n=e.length;if(f*=s,null==o||1===o)for(let u=0;u<n;++u){const r=3*e[u];i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],f+=s}else for(let u=0;u<n;++u){const r=3*e[u];for(let e=0;e<o;++e)i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],f+=s}}function u(e,t,r,f,o=1){const i=r.typedBuffer,s=r.typedBufferStride,n=e.length;if(f*=s,1===o)for(let u=0;u<n;++u){const r=4*e[u];i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],i[f+3]=t[r+3],f+=s}else for(let u=0;u<n;++u){const r=4*e[u];for(let e=0;e<o;++e)i[f]=t[r],i[f+1]=t[r+1],i[f+2]=t[r+2],i[f+3]=t[r+3],f+=s}}function c(e,t,r){const f=e.typedBuffer,o=e.typedBufferStride;t*=o;for(let i=0;i<r;++i)f[t]=0,f[t+1]=0,f[t+2]=0,f[t+3]=0,t+=o}function l(e,t,r,f){const o=r.typedBuffer,i=r.typedBufferStride,s=e.length;f*=i;for(let n=0;n<s;++n){const r=9*e[n];for(let e=0;e<9;++e)o[f+e]=t[r+e];f+=i}}function a(e,t,r,f){const o=r.typedBuffer,i=r.typedBufferStride,s=e.length;f*=i;for(let n=0;n<s;++n){const r=16*e[n];for(let e=0;e<16;++e)o[f+e]=t[r+e];f+=i}}function d(e,r,f,o,i,s=1){if(!f)return void n(e,r,o,i,s);const u=o.typedBuffer,c=o.typedBufferStride,l=e.length,a=f[0],d=f[1],B=f[2],b=f[4],V=f[5],y=f[6],w=f[8],A=f[9],p=f[10],g=f[12],O=f[13],h=f[14];i*=c;let N=0,S=0,R=0;const x=t.hasIdentityRotation(f)?e=>{N=r[e]+g,S=r[e+1]+O,R=r[e+2]+h}:e=>{const t=r[e],f=r[e+1],o=r[e+2];N=a*t+b*f+w*o+g,S=d*t+V*f+A*o+O,R=B*t+y*f+p*o+h};if(1===s)for(let t=0;t<l;++t)x(3*e[t]),u[i]=N,u[i+1]=S,u[i+2]=R,i+=c;else for(let t=0;t<l;++t){x(3*e[t]);for(let e=0;e<s;++e)u[i]=N,u[i+1]=S,u[i+2]=R,i+=c}}function B(e,r,f,o,i,s=1){if(!f)return void n(e,r,o,i,s);const u=f,c=o.typedBuffer,l=o.typedBufferStride,a=e.length,d=u[0],B=u[1],b=u[2],V=u[4],y=u[5],w=u[6],A=u[8],p=u[9],g=u[10],O=!t.isOrthoNormal(u),h=1e-6,N=1-h;i*=l;let S=0,R=0,x=0;const F=t.hasIdentityRotation(u)?e=>{S=r[e],R=r[e+1],x=r[e+2]}:e=>{const t=r[e],f=r[e+1],o=r[e+2];S=d*t+V*f+A*o,R=B*t+y*f+p*o,x=b*t+w*f+g*o};if(1===s)if(O)for(let t=0;t<a;++t){F(3*e[t]);const r=S*S+R*R+x*x;if(r<N&&r>h){const e=1/Math.sqrt(r);c[i]=S*e,c[i+1]=R*e,c[i+2]=x*e}else c[i]=S,c[i+1]=R,c[i+2]=x;i+=l}else for(let t=0;t<a;++t)F(3*e[t]),c[i]=S,c[i+1]=R,c[i+2]=x,i+=l;else for(let t=0;t<a;++t){if(F(3*e[t]),O){const e=S*S+R*R+x*x;if(e<N&&e>h){const t=1/Math.sqrt(e);S*=t,R*=t,x*=t}}for(let e=0;e<s;++e)c[i]=S,c[i+1]=R,c[i+2]=x,i+=l}}function b(e,r,f,o,i,s=1){if(!f)return void u(e,r,o,i,s);const n=f,c=o.typedBuffer,l=o.typedBufferStride,a=e.length,d=n[0],B=n[1],b=n[2],V=n[4],y=n[5],w=n[6],A=n[8],p=n[9],g=n[10],O=!t.isOrthoNormal(n),h=1e-6,N=1-h;if(i*=l,1===s)for(let t=0;t<a;++t){const f=4*e[t],o=r[f],s=r[f+1],n=r[f+2],u=r[f+3];let a=d*o+V*s+A*n,S=B*o+y*s+p*n,R=b*o+w*s+g*n;if(O){const e=a*a+S*S+R*R;if(e<N&&e>h){const t=1/Math.sqrt(e);a*=t,S*=t,R*=t}}c[i]=a,c[i+1]=S,c[i+2]=R,c[i+3]=u,i+=l}else for(let t=0;t<a;++t){const f=4*e[t],o=r[f],n=r[f+1],u=r[f+2],a=r[f+3];let S=d*o+V*n+A*u,R=B*o+y*n+p*u,x=b*o+w*n+g*u;if(O){const e=S*S+R*R+x*x;if(e<N&&e>h){const t=1/Math.sqrt(e);S*=t,R*=t,x*=t}}for(let e=0;e<s;++e)c[i]=S,c[i+1]=R,c[i+2]=x,c[i+3]=a,i+=l}}function V(e,t,r,f,o,i=1){const s=f.typedBuffer,n=f.typedBufferStride,u=e.length;if(o*=n,r!==t.length||4!==r)if(1!==i)if(4!==r)for(let c=0;c<u;++c){const r=3*e[c];for(let e=0;e<i;++e)s[o]=t[r],s[o+1]=t[r+1],s[o+2]=t[r+2],s[o+3]=255,o+=n}else for(let c=0;c<u;++c){const r=4*e[c];for(let e=0;e<i;++e)s[o]=t[r],s[o+1]=t[r+1],s[o+2]=t[r+2],s[o+3]=t[r+3],o+=n}else{if(4===r){for(let r=0;r<u;++r){const f=4*e[r];s[o]=t[f],s[o+1]=t[f+1],s[o+2]=t[f+2],s[o+3]=t[f+3],o+=n}return}for(let r=0;r<u;++r){const f=3*e[r];s[o]=t[f],s[o+1]=t[f+1],s[o+2]=t[f+2],s[o+3]=255,o+=n}}else{s[o]=t[0],s[o+1]=t[1],s[o+2]=t[2],s[o+3]=t[3];const e=new Uint32Array(f.typedBuffer.buffer,f.start),r=n/4,c=e[o/=4];o+=r;const l=u*i;for(let t=1;t<l;++t)e[o]=c,o+=r}}function y(e,t,r,f){const o=r.typedBuffer,i=r.typedBufferStride,s=e.length,n=t[0];f*=i;for(let u=0;u<s;++u)o[f]=n,f+=i}function w(e,t,r,f,o=1){const i=t.typedBuffer,s=t.typedBufferStride;if(f*=s,1===o)for(let n=0;n<r;++n)i[f]=e[0],i[f+1]=e[1],i[f+2]=e[2],i[f+3]=e[3],f+=s;else for(let n=0;n<r;++n)for(let t=0;t<o;++t)i[f]=e[0],i[f+1]=e[1],i[f+2]=e[2],i[f+3]=e[3],f+=s}function A(e,t,i,s,n,u){for(const c of t.fields.keys()){const t=e.vertexAttributes.get(c),l=e.indices.get(c);if(t&&l)p(c,t,l,i,s,n,u);else if(c===o.VertexAttribute.OBJECTANDLAYERIDCOLOR&&null!=e.objectAndLayerIdColor){const t=e.indices.get(o.VertexAttribute.POSITION);if(f.assert(!!t,`No buffer view for ${c}`),t){const f=t.length,o=n.getField(c,r.BufferViewVec4u8);w(e.objectAndLayerIdColor,o,f,u)}}}}function p(e,t,i,n,c,l,a){switch(e){case o.VertexAttribute.POSITION:{f.assert(3===t.size);const o=l.getField(e,r.BufferViewVec3f);f.assert(!!o,`No buffer view for ${e}`),o&&d(i,t.data,n,o,a);break}case o.VertexAttribute.NORMAL:{f.assert(3===t.size);const o=l.getField(e,r.BufferViewVec3f);f.assert(!!o,`No buffer view for ${e}`),o&&B(i,t.data,c,o,a);break}case o.VertexAttribute.NORMALCOMPRESSED:{f.assert(2===t.size);const o=l.getField(e,r.BufferViewVec2i16);f.assert(!!o,`No buffer view for ${e}`),o&&s(i,t.data,o,a);break}case o.VertexAttribute.UV0:{f.assert(2===t.size);const o=l.getField(e,r.BufferViewVec2f);f.assert(!!o,`No buffer view for ${e}`),o&&s(i,t.data,o,a);break}case o.VertexAttribute.COLOR:case o.VertexAttribute.SYMBOLCOLOR:{const o=l.getField(e,r.BufferViewVec4u8);f.assert(!!o,`No buffer view for ${e}`),f.assert(3===t.size||4===t.size),!o||3!==t.size&&4!==t.size||V(i,t.data,t.size,o,a);break}case o.VertexAttribute.COLORFEATUREATTRIBUTE:{const o=l.getField(e,r.BufferViewFloat);f.assert(!!o,`No buffer view for ${e}`),f.assert(1===t.size),o&&1===t.size&&y(i,t.data,o,a);break}case o.VertexAttribute.TANGENT:{f.assert(4===t.size);const o=l.getField(e,r.BufferViewVec4f);f.assert(!!o,`No buffer view for ${e}`),o&&b(i,t.data,c,o,a);break}case o.VertexAttribute.PROFILERIGHT:case o.VertexAttribute.PROFILEUP:case o.VertexAttribute.PROFILEVERTEXANDNORMAL:case o.VertexAttribute.FEATUREVALUE:{f.assert(4===t.size);const o=l.getField(e,r.BufferViewVec4f);f.assert(!!o,`No buffer view for ${e}`),o&&u(i,t.data,o,a)}}}e.writeBufferFloat=i,e.writeBufferMat3f=l,e.writeBufferMat4f=a,e.writeBufferVec2=s,e.writeBufferVec3=n,e.writeBufferVec4=u,e.writeBufferVec4Zeros=c,e.writeColor=V,e.writeColorFeatureAttribute=y,e.writeDefaultAttribute=p,e.writeDefaultAttributes=A,e.writeNormal=B,e.writeObjectAndLayerIdColor=w,e.writePosition=d,e.writeTangent=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
