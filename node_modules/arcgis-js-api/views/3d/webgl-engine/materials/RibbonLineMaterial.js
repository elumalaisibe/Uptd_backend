/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/vec2","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/vec4f64","../../../../geometry/support/frustum","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./VisualVariablePassParameters","../shaders/LineMarkerTechniqueConfiguration","../../../../chunks/RibbonLine.glsl","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechniqueConfiguration"],(function(e,t,r,i,a,n,s,o,c,u,l,h,p,d,f,A,T,_,m,S,b,R,E,g,v){"use strict";var O;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(O||(O={}));let I=function(e){function n(t){var r;return(r=e.call(this,t,new L)||this)._configuration=new v.RibbonLineTechniqueConfiguration,r._vertexAttributeLocations=g.vertexAttributeLocations,r}t._inherits(n,e);var c=n.prototype;return c.isClosed=function(e,t){return C(this.parameters,e,t)},c.getConfiguration=function(e,t){this._configuration.output=e,this._configuration.draped=t.slot===_.RenderSlot.DRAPED_MATERIAL;const r=null!=this.parameters.stipplePattern&&e!==f.ShaderOutput.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&null!=this.parameters.stippleOffColor,this._configuration.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&D(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===T.RenderOccludedFlag.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration},c.intersectDraped=function(e,t,r,i,n,s){if(!r.options.selectionMode)return;const o=e.vertexAttributes.get(S.VertexAttribute.POSITION).data,c=e.vertexAttributes.get(S.VertexAttribute.SIZE);let u=this.parameters.width;if(this.parameters.vvSize){const t=e.vertexAttributes.get(S.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];u*=a.clamp(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else c&&(u*=c.data[0]);const l=i[0],h=i[1],p=(u/2+4)*e.screenToWorldRatio;let d=Number.MAX_VALUE,f=0;for(let A=0;A<o.length-5;A+=3){const e=o[A],t=o[A+1],r=l-e,i=h-t,n=o[A+3]-e,s=o[A+4]-t,c=n*r+s*i,u=n*n+s*s,p=a.clamp(c/u,0,1),T=n*p-r,_=s*p-i,m=T*T+_*_;m<d&&(d=m,f=A/3)}d<p*p&&n(s.dist,s.normal,f,!1)},c.intersect=function(e,t,r,n,c,u){if(!r.options.selectionMode||!e.visible)return;if(!m.isTranslationMatrix(t))return void i.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const d=e.vertexAttributes,f=d.get(S.VertexAttribute.POSITION).data;let A=this.parameters.width;if(this.parameters.vvSize){const e=d.get(S.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];A*=a.clamp(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else d.has(S.VertexAttribute.SIZE)&&(A*=d.get(S.VertexAttribute.SIZE).data[0]);const T=r.camera,_=w;s.copy(_,r.point);const b=A*T.pixelRatio/2+4*T.pixelRatio;o.set(q[0],_[0]-b,_[1]+b,0),o.set(q[1],_[0]+b,_[1]+b,0),o.set(q[2],_[0]+b,_[1]-b,0),o.set(q[3],_[0]-b,_[1]-b,0);for(let i=0;i<4;i++)if(!T.unprojectFromRenderScreen(q[i],X[i]))return;p.fromPoints(T.eye,X[0],X[1],Y),p.fromPoints(T.eye,X[1],X[2],Q),p.fromPoints(T.eye,X[2],X[3],K),p.fromPoints(T.eye,X[3],X[0],$);let R=Number.MAX_VALUE,E=0;const g=N(this.parameters,d,e.indices)?f.length-2:f.length-5;for(let i=0;i<g;i+=3){V[0]=f[i]+t[12],V[1]=f[i+1]+t[13],V[2]=f[i+2]+t[14];const e=(i+3)%f.length;if(U[0]=f[e]+t[12],U[1]=f[e+1]+t[13],U[2]=f[e+2]+t[14],p.signedDistance(Y,V)<0&&p.signedDistance(Y,U)<0||p.signedDistance(Q,V)<0&&p.signedDistance(Q,U)<0||p.signedDistance(K,V)<0&&p.signedDistance(K,U)<0||p.signedDistance($,V)<0&&p.signedDistance($,U)<0)continue;if(T.projectToRenderScreen(V,B),T.projectToRenderScreen(U,J),B[2]<0&&J[2]>0){o.subtract(M,V,U);const e=T.frustum,t=-p.signedDistance(e[l.PlaneIndex.NEAR],V)/o.dot(M,p.normal(e[l.PlaneIndex.NEAR]));o.scale(M,M,t),o.add(V,V,M),T.projectToRenderScreen(V,B)}else if(B[2]>0&&J[2]<0){o.subtract(M,U,V);const e=T.frustum,t=-p.signedDistance(e[l.PlaneIndex.NEAR],U)/o.dot(M,p.normal(e[l.PlaneIndex.NEAR]));o.scale(M,M,t),o.add(U,U,M),T.projectToRenderScreen(U,J)}else if(B[2]<0&&J[2]<0)continue;B[2]=0,J[2]=0;const r=h.distance2(h.fromPoints(B,J,G),_);r<R&&(R=r,o.copy(z,V),o.copy(k,U),E=i/3)}const v=r.rayBegin,O=r.rayEnd;if(R<b*b){let e=Number.MAX_VALUE;if(h.closestLineSegmentPoint(h.fromPoints(z,k,G),h.fromPoints(v,O,H),F)){o.subtract(F,F,v);const t=o.length(F);o.scale(F,F,1/t),e=t/o.distance(v,O)}u(e,F,E,!1)}},c.createBufferWriter=function(){return new y(this._layout,this.parameters)},c.requiresSlot=function(e,t){if(t===f.ShaderOutput.Color||t===f.ShaderOutput.Alpha||t===f.ShaderOutput.Highlight||t===f.ShaderOutput.Depth||t===f.ShaderOutput.ObjectAndLayerIdColor){if(e===_.RenderSlot.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===T.RenderOccludedFlag.OccludeAndTransparentStencil)return e===_.RenderSlot.OPAQUE_MATERIAL||e===_.RenderSlot.OCCLUDER_MATERIAL||e===_.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;if(t===f.ShaderOutput.Color||t===f.ShaderOutput.Alpha){return e===(this.parameters.writeDepth?_.RenderSlot.TRANSPARENT_MATERIAL:_.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return e===_.RenderSlot.OPAQUE_MATERIAL}return!1},c.createGLMaterial=function(e){return new P(e)},c.validateParameters=function(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)},t._createClass(n,[{key:"_layout",get:function(){const e=d.newLayout().vec3f(S.VertexAttribute.POSITION).f32(S.VertexAttribute.SUBDIVISIONFACTOR).vec2f(S.VertexAttribute.UV0).vec3f(S.VertexAttribute.AUXPOS1).vec3f(S.VertexAttribute.AUXPOS2);return this.parameters.vvSize?e.f32(S.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f32(S.VertexAttribute.SIZE),this.parameters.vvColor?e.f32(S.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4f(S.VertexAttribute.COLOR),this.parameters.vvOpacity&&e.f32(S.VertexAttribute.OPACITYFEATUREATTRIBUTE),r("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(S.VertexAttribute.OBJECTANDLAYERIDCOLOR),e}}]),n}(T.Material),P=function(e){function r(){var t;return(t=e.apply(this,arguments)||this)._stipplePattern=null,t}t._inherits(r,e);var i=r.prototype;return i.dispose=function(){t._get(t._getPrototypeOf(r.prototype),"dispose",this).call(this),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null},i._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},i.beginSlot=function(e){this._output!==f.ShaderOutput.Color&&this._output!==f.ShaderOutput.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(g.RibbonLineTechnique,e)},t._createClass(r)}(A),L=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).width=0,t.color=u.ONES,t.join="miter",t.cap=v.CapType.BUTT,t.miterLimit=5,t.writeDepth=!0,t.hasPolygonOffset=!1,t.stippleTexture=null,t.stippleScaleWithLineWidth=!1,t.stipplePreferContinuous=!0,t.markerParameters=null,t.markerScale=1,t.hasSlicePlane=!1,t.vvFastUpdate=!1,t.isClosed=!1,t.falloff=0,t.innerWidth=0,t.hasOccludees=!1,t.wireframe=!1,t}return t._inherits(r,e),t._createClass(r)}(b.VisualVariablePassParameters),y=function(){function e(e,t){this._parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=E.RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS+r}}var i=e.prototype;return i._isClosed=function(e){return N(this._parameters,e.vertexAttributes,e.indices)},i.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},i.elementCount=function(e){const t=2,r=e.indices.get(S.VertexAttribute.POSITION).length/2+1,i=this._isClosed(e);let a=i?2:2*t;return a+=((i?r:r-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),a+=2,this._parameters.wireframe&&(a=2+4*(a-2)),a},i.write=function(e,t,i,a,n){const s=j,c=W,u=Z,l=i.vertexAttributes.get(S.VertexAttribute.POSITION).data,h=i.indices&&i.indices.get(S.VertexAttribute.POSITION),p=i.vertexAttributes.get(S.VertexAttribute.DISTANCETOSTART)?.data;h&&h.length!==2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let d=1,f=0;this._parameters.vvSize?f=i.vertexAttributes.get(S.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(S.VertexAttribute.SIZE)&&(d=i.vertexAttributes.get(S.VertexAttribute.SIZE).data[0]);let A=[1,1,1,1],T=0;this._parameters.vvColor?T=i.vertexAttributes.get(S.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(S.VertexAttribute.COLOR)&&(A=i.vertexAttributes.get(S.VertexAttribute.COLOR).data);const _=r("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null;let m=0;this._parameters.vvOpacity&&(m=i.vertexAttributes.get(S.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);const b=l.length/3,R=new Float32Array(a.buffer),E=r("enable-feature:objectAndLayerId-rendering")?new Uint8Array(a.buffer):null,g=this.vertexBufferLayout.stride/4;let v=n*g;const I=v;let P=0;const L=p?(e,t,r)=>P=p[r]:(e,t,r)=>P+=o.distance(e,t),y=r("enable-feature:objectAndLayerId-rendering"),N=(e,t,r,i,a,n,s)=>{if(R[v++]=t[0],R[v++]=t[1],R[v++]=t[2],R[v++]=i,R[v++]=s,R[v++]=a,R[v++]=e[0],R[v++]=e[1],R[v++]=e[2],R[v++]=r[0],R[v++]=r[1],R[v++]=r[2],R[v++]=this._parameters.vvSize?f:d,this._parameters.vvColor)R[v++]=T;else{const e=Math.min(4*n,A.length-4);R[v++]=A[e],R[v++]=A[e+1],R[v++]=A[e+2],R[v++]=A[e+3]}this._parameters.vvOpacity&&(R[v++]=m),y&&(null!=_&&(E[4*v]=_[0],E[4*v+1]=_[1],E[4*v+2]=_[2],E[4*v+3]=_[3]),v++)};v+=g,o.set(c,l[0],l[1],l[2]),e&&o.transformMat4(c,c,e);const C=this._isClosed(i);if(C){const t=l.length-3;o.set(s,l[t],l[t+1],l[t+2]),e&&o.transformMat4(s,s,e)}else o.set(u,l[3],l[4],l[5]),e&&o.transformMat4(u,u,e),N(c,c,u,1,O.LEFT_CAP_START,0,0),N(c,c,u,1,O.RIGHT_CAP_START,0,0),o.copy(s,c),o.copy(c,u);const D=C?0:1,V=C?b:b-1;for(let r=D;r<V;r++){const t=(r+1)%b*3;o.set(u,l[t],l[t+1],l[t+2]),e&&o.transformMat4(u,u,e),L(s,c,r),N(s,c,u,0,O.LEFT_JOIN_END,r,P),N(s,c,u,0,O.RIGHT_JOIN_END,r,P);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const t=(e+1)/(i+1);N(s,c,u,t,O.LEFT_JOIN_END,r,P),N(s,c,u,t,O.RIGHT_JOIN_END,r,P)}N(s,c,u,1,O.LEFT_JOIN_START,r,P),N(s,c,u,1,O.RIGHT_JOIN_START,r,P),o.copy(s,c),o.copy(c,u)}C?(o.set(u,l[3],l[4],l[5]),e&&o.transformMat4(u,u,e),P=L(s,c,V),N(s,c,u,0,O.LEFT_JOIN_END,D,P),N(s,c,u,0,O.RIGHT_JOIN_END,D,P)):(P=L(s,c,V),N(s,c,c,0,O.LEFT_CAP_END,V,P),N(s,c,c,0,O.RIGHT_CAP_END,V,P)),x(R,I+g,R,I,g);v=x(R,v-g,R,v,g),this._parameters.wireframe&&this._addWireframeVertices(a,I,v,g)},i._addWireframeVertices=function(e,t,r,i){const a=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let s=0;const o=e=>s=x(n,e,a,s,i);for(let c=0;c<n.length-1;c+=2*i)o(c),o(c+2*i),o(c+1*i),o(c+2*i),o(c+1*i),o(c+3*i)},t._createClass(e)}();function x(e,t,r,i,a){for(let n=0;n<a;n++)r[i++]=e[t++];return i}function N(e,t,r){return C(e,t.get(S.VertexAttribute.POSITION).data,r?r.get(S.VertexAttribute.POSITION):null)}function C(e,t,r){return!!e.isClosed&&(r?r.length>2:t.length>6)}function D(e){return e.anchor===R.LineMarkerAnchor.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}const V=c.create(),U=c.create(),M=c.create(),F=c.create(),w=c.create(),B=n.createRenderScreenPointArray3(),J=n.createRenderScreenPointArray3(),z=c.create(),k=c.create(),G=h.create(),H=h.create(),j=c.create(),W=c.create(),Z=c.create(),q=[n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3(),n.createRenderScreenPointArray3()],X=[c.create(),c.create(),c.create(),c.create()],Y=p.create(),Q=p.create(),K=p.create(),$=p.create();e.Parameters=L,e.RibbonLineMaterial=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
