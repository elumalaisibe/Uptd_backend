/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/PooledArray","./BufferRange","./DrawCommand"],(function(t,s,n,e,i){"use strict";let a=function(){function t(){this._numElements=0,this._instances=new Map,this.holes=new n({allocator:t=>t||new e.BufferRange,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=h(),this.drawCommandsHighlight=h(),this.drawCommandsOccludees=h(),this.drawCommandsShadowHighlightRest=h()}var i=t.prototype;return i.addInstance=function(t,s){this.deleteInstance(t),this._instances.set(t,s),this._numElements+=s.numElements},i.deleteInstance=function(t){const s=this._instances.get(t);s&&(this._numElements-=s.numElements,this._instances.delete(t))},i.updateInstance=function(t,s,n){const e=this._instances.get(t);e&&(this._numElements-=e.numElements,e.from=s,e.to=n,this._numElements+=e.numElements)},i.updateDrawState=function(t){t.isVisible?(t.hasHighlights&&(this.hasHighlights=!0),t.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0},i.updateDrawCommands=function(t){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const s=this.drawCommandsDefault.pushNew(),n=this.holes.front();return null!=this.vao&&1===this.holes.length&&n.to===Math.floor(this.vao.byteSize/t)?(s.first=0,void(s.count=n.from)):(s.first=1/0,s.count=0,this._instances.forEach((t=>{s.first=Math.min(s.first,t.from),s.count=Math.max(s.count,t.to)})),void(s.count-=s.first))}const s=Array.from(this._instances.values()).sort(((t,s)=>t.from===s.from?t.to-s.to:t.from-s.from));for(const n of s)n.isVisible&&(l(n.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,n),l(n.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,n))},i.needsMultipleCommands=function(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances},s._createClass(t,[{key:"numElements",get:function(){return this._numElements}},{key:"instances",get:function(){return this._instances}}]),t}(),o=function(t){function n(){return t.apply(this,arguments)||this}return s._inherits(n,t),s._createClass(n)}(a);function r(t){return null!=t.vao}function h(){return new n({allocator:t=>t||new i.DrawCommand,deallocator:t=>t})}function l(t,s){const n=t.back();if(null==n){const n=t.pushNew();return n.first=s.from,void(n.count=s.numElements)}if(u(n,s)){const t=s.from-n.first+s.numElements;n.count=t}else{const n=t.pushNew();n.first=s.from,n.count=s.numElements}}function u(t,s){return t.first+t.count>=s.from}t.PerBufferData=a,t.PerVaoData=o,t.hasVao=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
