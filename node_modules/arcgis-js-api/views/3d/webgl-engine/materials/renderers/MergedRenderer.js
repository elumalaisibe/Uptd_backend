/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/arrayUtils","../../../../../core/MapUtils","../../../../../core/NestedMap","../../../../../core/PooledArray","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../../lib/GLMaterials","../../lib/Material","../../lib/ModelDirtyTypes","../../lib/Util","../DrawParameters","../WaterMaterial","./BufferRange","./Instance","./PerBufferData","./PerOriginData","./VaoCache"],(function(e,t,r,n,a,i,s,o,l,u,h,c,f,d,m,g,y,p,_,v,w){"use strict";let b=function(){function e(e,t,r){this._rctx=e,this._materialRepository=t,this.material=r,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new h.GLMaterials(this.material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._vaoCache=new w.VaoCache(e,r.vertexAttributeLocations,l.glLayout(this._bufferWriter.vertexBufferLayout))}var i=e.prototype;return i.dispose=function(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache.dispose()},i.forEachGeometry=function(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))},i.modify=function(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()},i._updateGeometries=function(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const n of e){const e=n.renderGeometry,a=this._dataByOrigin.get(e.localOrigin.id),i=a?.findBuffer(e.id);if(null==i)return;const s=i.instances.get(e.id);if(n.updateType&(f.DirtyState.GEOMETRY|f.DirtyState.TRANSFORMATION)){const n=L(t.elementCount(s.geometry.geometry)*r),a=t.vertexBufferLayout.createView(n.buffer);this._writeGeometry(e,a,0),i.vao.vertexBuffers.geometry.setSubData(n,s.from*r,0,s.numElements*r),T()}n.updateType&(f.DirtyState.HIGHLIGHT|f.DirtyState.OCCLUDEE|f.DirtyState.VISIBILITY)&&(i.drawCommandsDirty=!0)}},i._computeDeltas=function(e,t){const r=new a.NestedMap;for(const n of e){const e=n.localOrigin;if(null==e)continue;let t=r.get(e.id,null);null==t&&(t=new O(e.vec3),r.set(e.id,null,t)),t.changes.push(n)}for(const n of t){const e=n.localOrigin;if(null==e)continue;const t=this._dataByOrigin.get(e.id),a=t?.findBuffer(n.id);if(null==a)continue;let i=r.get(e.id,a);null==i&&(i=new O(e.vec3),r.set(e.id,a,i)),i.changes.push(n)}return r},i._addAndRemoveGeometries=function(e,t){const{_bufferWriter:n,_dataByOrigin:a}=this,i=n.vertexBufferLayout.stride/4,s=this._computeDeltas(e,t);s.forEach(((e,t)=>{const o=e.get(null),l=null!=o?o.changes:[];s.delete(t,null);let u=a.get(t);if(e.forEach(((e,o)=>{if(s.delete(t,o),null==o)return void d.assert(!1,"No VAO for removed geometries");if(o.instances.size===e.changes.length)return this._vaoCache.deleteVao(o.vao),r.removeUnordered(u.buffers,o),void(0===u.buffers.length&&0===l.length&&a.delete(t));const h=o.numElements,c=o.vao.byteSize/4,f=l.reduce(((e,t)=>e+n.elementCount(t.geometry)),0),m=e.changes.reduce(((e,t)=>e+n.elementCount(t.geometry)),0),g=Math.min((h+f-m)*i,R),y=g>c;g>E&&g<c/2?(e.changes.forEach((({id:e})=>o.deleteInstance(e))),o.instances.forEach((({geometry:e})=>l.push(e))),this._vaoCache.deleteVao(o.vao),r.removeUnordered(u.buffers,o)):y?this._applyAndRebuild(o,l,e):this._applyRemoves(o,e)})),l.length>0)for(null==u&&(u=new v.PerOriginData(o.origin),a.set(t,u)),u.buffers.forEach((e=>this._applyAdds(e,l)));l.length>0;)u.buffers.push(this._applyAndRebuild(new _.PerBufferData,l,null))}))},i._updateDrawCommands=function(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,n.someMap(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))},i._applyAndRebuild=function(e,t,r){if(null!=r)for(const d of r.changes)e.deleteInstance(d.id);const n=this._bufferWriter,a=n.vertexBufferLayout.stride,i=a/4,s=Math.floor(R/i);let o=e.numElements;for(;t.length>0;){const r=t.pop(),a=n.elementCount(r.geometry);if(o+a>s&&o>0){t.push(r);break}o+=a;const i=new p.Instance(r,0,0);d.assert(null==e.instances.get(r.id)),e.addInstance(r.id,i)}const l=o*i,u=L(l),h=n.vertexBufferLayout.createView(u.buffer);let c=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,h,c);const a=c;c+=n.elementCount(t.geometry.geometry),e.updateInstance(r,a,c),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(G(l)),e.vao.vertexBuffers.geometry.setSubData(u,0,0,c*i),T(),e.holes.clear();const f=e.holes.pushNew();return f.from=c,f.to=Math.floor(e.vao.byteSize/a),e.updateDrawCommands(a),e},i._applyRemoves=function(e,t){if(0===t.changes.length)return;for(const s of t.changes){const t=s.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const n=A.back();if(n){if(n.to===r.from){n.to=r.to;continue}if(n.from===r.to){n.from=r.from;continue}}const a=A.pushNew();a.from=r.from,a.to=r.to}y.mergeAdjacentRanges(A);const r=this._bufferWriter.vertexBufferLayout.stride/4,n=A.reduce(((e,t)=>Math.max(e,t.numElements)),0)*r,a=L(n);a.fill(0,0,n);const i=e.vao.vertexBuffers.geometry;A.forAll((e=>i.setSubData(a,e.from*r,0,e.numElements*r))),T(),e.holes.pushArray(A.data,A.length),A.forAll(((e,t)=>A.data[t]=null)),A.clear(),e.drawCommandsDirty=!0},i._applyAdds=function(e,t){if(0===t.length)return;if(!_.hasVao(e))return void this._applyAndRebuild(e,t,null);const n=this._bufferWriter,a=n.vertexBufferLayout.stride/4,i=e.numElements,s=t.reduce(((e,t)=>e+n.elementCount(t.geometry)),0),o=Math.min((i+s)*a,R),l=4*o;if(e.vao.byteSize<G(R-E)&&l>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);y.mergeAdjacentRanges(e.holes);const u=new Array;for(const r of t){const t=n.elementCount(r.geometry),a=S(e.holes,t);u.push(a)}const h=e.vao.vertexBuffers.geometry;let c=0,f=0,m=0;const g=L(o),v=n.vertexBufferLayout.createView(g.buffer);t.forEach(((t,r)=>{const i=u[r];if(null==i)return;if(!(m===i)){const e=m-f;e>0&&h.setSubData(g,f*a,0,e*a),f=i,c=0}const s=n.elementCount(t.geometry);this._writeGeometry(t,v,c),c+=s,m=i+s;const o=new p.Instance(t,i,i+s);d.assert(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const w=m-f;w>0&&h.setSubData(g,f*a,0,w*a),r.filterInPlace(t,((e,t)=>null==u[t])),T()},i._writeGeometry=function(e,t,r){const n=e.localOrigin.vec3;d.setMatrixTranslation3(C,-n[0],-n[1],-n[2]);const a=s.multiply(B,C,e.transformation);s.invert(D,a),s.transpose(D,D),this._bufferWriter.write(a,D,e.geometry,t,r)},i.updateAnimation=function(e){return this.material.update(e)},i.requiresSlot=function(e,t){return this.material.requiresSlot(e,t)},i.prepareTechnique=function(e){const{output:t,bindParameters:r}=e;if(!this.requiresSlot(r.slot,t))return null;const n=t===u.ShaderOutput.Highlight||t===u.ShaderOutput.ShadowHighlight;if(n&&!this._hasHighlights)return null;const a=t===u.ShaderOutput.ShadowExcludeHighlight,i=!(n||a);for(const s of this._dataByOrigin.values())for(const o of s.buffers){if(n&&!o.hasHighlights)continue;const s=(n?o.drawCommandsHighlight:a&&o.needsMultipleCommands()?o.drawCommandsShadowHighlightRest:o.drawCommandsDefault)||null,l=i&&o.drawCommandsOccludees||null;if(s?.length||l?.length){const n=this._glMaterials.load(e.rctx,r.slot,t),a=null!=n?n.beginSlot(r):null;if(null!=a)return a}}return null},i.render=function(e,t){const{output:r,bindParameters:n}=e,a=r===u.ShaderOutput.Highlight||r===u.ShaderOutput.ShadowHighlight,i=r===u.ShaderOutput.ShadowExcludeHighlight,s=!(a||i),o=this._rctx;o.appleAmdDriverHelper?.resetIndicesType(),o.bindTechnique(t,this.material.parameters,n);for(const l of this._dataByOrigin.values())for(const e of l.buffers){if(a&&!e.hasHighlights)continue;const r=(a?e.drawCommandsHighlight:i&&e.needsMultipleCommands()?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,u=s&&e.drawCommandsOccludees||null;if(r?.length||u?.length){t.program.bindDraw(new m.DrawParameters(l.origin),n,this.material.parameters),t.ensureAttributeLocations(e.vao),o.bindVAO(e.vao),r?.length&&(t.bindPipelineState(o,n.slot,!1),r.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),u?.length&&(t.bindPipelineState(o,n.slot,!0),u.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count))))}}},t._createClass(e,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this.material instanceof g.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this.material.renderOccluded!==c.RenderOccludedFlag.Occlude}},{key:"numGeometries",get:function(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}},{key:"test",get:function(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]),e}(),O=t._createClass((function(e){this.origin=e,this.changes=new Array}));function S(e,t){let r;if(!e.some((e=>!(e.numElements<t)&&(r=e,!0))))return null;const n=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),n}const C=o.create(),B=o.create(),D=o.create(),A=new i({allocator:e=>e||new y.BufferRange,deallocator:null}),E=65536,H=4*E,M=1024,x=16777216,R=x/4;let I=new Float32Array(E);function L(e){return I.length<e&&(I=new Float32Array(e)),I}function G(e){const t=4*e;return t<=M?M:t<H?H:Math.max(Math.min(Math.ceil(1.5*t/H)*H,x),t)}function T(){I=new Float32Array(2)}e.MergedRenderer=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
