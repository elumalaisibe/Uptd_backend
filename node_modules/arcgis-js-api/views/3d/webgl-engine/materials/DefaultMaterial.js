/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../ViewingMode","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../lib/basicInterfaces","../lib/GLTextureMaterial","../lib/Material","../lib/OrderIndependentTransparency","../lib/RenderSlot","../lib/VertexAttribute","../lib/verticalOffsetUtils","./DefaultBufferWriter","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/DefaultMaterialTechniqueConfiguration","../shaders/RealisticTreeTechnique"],(function(e,t,r,a,i,s,n,o,u,l,h,c,d,p,f,m,g,T,S,_,b,x,O){"use strict";let v=function(e){function r(t){var r;return(r=e.call(this,t,A)||this).supportsEdges=!0,r._configuration=new x.DefaultMaterialTechniqueConfiguration,r._vertexBufferLayout=w(r.parameters),r}t._inherits(r,e);var i=r.prototype;return i.isVisibleForOutput=function(e){return e!==o.ShaderOutput.Shadow&&e!==o.ShaderOutput.ShadowExcludeHighlight&&e!==o.ShaderOutput.ShadowHighlight||this.parameters.castShadows},i.isVisible=function(){const e=this.parameters;if(!t._get(t._getPrototypeOf(r.prototype),"isVisible",this).call(this)||0===e.layerOpacity)return!1;const{hasInstancedColor:a,hasVertexColors:i,hasSymbolColors:s,vvColor:n}=e,o="replace"===e.colorMixMode,u=e.opacity>0,l=e.externalColor&&e.externalColor[3]>0,h=a||n||s;return i&&h?o||u:i?o?l:u:h?o||u:o?l:u},i.getConfiguration=function(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=this.parameters.isInstanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,null!=this.parameters.customDepthTest&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?c.CullFaceOptions.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=null!=this.parameters.modelTransformation,e!==o.ShaderOutput.Color&&e!==o.ShaderOutput.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=l.NormalsDoubleSidedMode.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?l.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?l.NormalsDoubleSidedMode.WindingOrder:l.NormalsDoubleSidedMode.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.active&&this.parameters.receiveSSAO,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?h.PBRMode.Schematic:h.PBRMode.Normal:h.PBRMode.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<f.OITPolygonOffsetLimit,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration},i.hasSnowCover=function(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover},i.intersect=function(e,t,r,i,n,o){if(null!=this.parameters.verticalOffset){const e=r.camera;a.set(V,t[12],t[13],t[14]);let o=null;switch(r.viewingMode){case s.ViewingMode.Global:o=a.normalize(D,V);break;case s.ViewingMode.Local:o=a.copy(D,P)}let u=0;const l=a.subtract(L,V,e.eye),h=a.length(l),c=a.scale(l,l,1/h);let d=null;this.parameters.screenSizePerspective&&(d=a.dot(o,c)),u+=_.verticalOffsetAtDistance(e,h,this.parameters.verticalOffset,d??0,this.parameters.screenSizePerspective),a.scale(o,o,u),a.transformMat3(I,o,r.transform.inverseRotation),i=a.subtract(C,i,I),n=a.subtract(R,n,I)}_.intersectTriangleGeometry(e,r,i,n,T.getVerticalOffsetObject3D(r.verticalOffset),o)},i.requiresSlot=function(e,t){if(t===o.ShaderOutput.Color||t===o.ShaderOutput.Alpha||t===o.ShaderOutput.Depth||t===o.ShaderOutput.Normal||t===o.ShaderOutput.Shadow||t===o.ShaderOutput.ShadowHighlight||t===o.ShaderOutput.ShadowExcludeHighlight||t===o.ShaderOutput.Highlight||t===o.ShaderOutput.ObjectAndLayerIdColor){return e===(this.parameters.transparent?this.parameters.writeDepth?m.RenderSlot.TRANSPARENT_MATERIAL:m.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:m.RenderSlot.OPAQUE_MATERIAL)||e===m.RenderSlot.DRAPED_MATERIAL}return!1},i.createGLMaterial=function(e){return new M(e)},i.createBufferWriter=function(){return new S.DefaultBufferWriter(this._vertexBufferLayout)},t._createClass(r)}(p.Material),M=function(e){function r(t){return e.call(this,{...t,...t.material.parameters})||this}t._inherits(r,e);var i=r.prototype;return i._updateShadowState=function(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})},i._updateOccludeeState=function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})},i.beginSlot=function(e){this._output!==o.ShaderOutput.Color&&this._output!==o.ShaderOutput.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));const t=this._material.parameters;this.updateTexture(t.textureId);const r=e.camera.viewInverseTransposeMatrix;return a.set(t.origin,r[3],r[7],r[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?O.RealisticTreeTechnique:b.DefaultMaterialTechnique,e)},t._createClass(r)}(d.GLTextureMaterial),y=function(e){function r(){var t;return(t=e.apply(this,arguments)||this).initTextureTransparent=!1,t.treeRendering=!1,t.hasVertexTangents=!1,t}return t._inherits(r,e),t._createClass(r)}(b.DefaultMaterialPassParameters);const A=new y;function w(e){const t=n.newLayout().vec3f(g.VertexAttribute.POSITION);e.normalType===u.NormalType.Compressed?t.vec2i16(g.VertexAttribute.NORMALCOMPRESSED,{glNormalized:!0}):t.vec3f(g.VertexAttribute.NORMAL),e.hasVertexTangents&&t.vec4f(g.VertexAttribute.TANGENT);return(e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId)&&t.vec2f(g.VertexAttribute.UV0),e.hasVertexColors&&t.vec4u8(g.VertexAttribute.COLOR),e.hasSymbolColors&&t.vec4u8(g.VertexAttribute.SYMBOLCOLOR),r("enable-feature:objectAndLayerId-rendering")&&t.vec4u8(g.VertexAttribute.OBJECTANDLAYERIDCOLOR),t}const C=i.create(),R=i.create(),P=i.fromValues(0,0,1),D=i.create(),I=i.create(),V=i.create(),L=i.create();e.DefaultGLMaterial=M,e.DefaultMaterial=v,e.DefaultMaterialParameters=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
