/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/FloatArray","../../../../../geometry/support/Indices","./ComponentIntersectionData","../../lib/Attribute","../../lib/ComponentUtils","../../materials/internal/MaterialUtil"],(function(t,n,e,i,o,s,r,c,a,p){"use strict";let u=function(){function e(t,n){this._components=n,this._indices=null!=t.indices?s.compactIndices(t.indices):s.getContinuousIndexArray(t.positions.length/3),this._positions=t.positions,this._componentIntersectionData=new Array(n.count)}var i=e.prototype;return i.getComponentAabb=function(t,n){this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs());for(let e=0;e<6;e++)n[e]=this._perComponentAabbs[6*t+e];return n},i.getComponentPositions=function(t,n){n.indices=this._indices,n.data=this._positions,n.stride=3,n.startIndex=this._components.offsets[t],n.endIndex=this._components.offsets[t+1]},i.intersect=function(t,e,i,o,s,u,h){const _=new c.Attribute(this._positions,3,!1,3),f=this._indices,b=this._components.offsets,d=p.computeInvDir(t,e,m),y=t[2],A=e[2];this._components.visibility.forEachComponent((c=>{if(!a.getVisibility(this._components.pickability,c))return!0;const m=this.getComponentAabb(c,l);if(null!=u){const n=u[c];null!=s?s.componentOffset=n:(t[2]=y-n,e[2]=A-n)}if(null!=s&&s.applyToAabb(m),!p.intersectAabbInvDir(m,t,d,i))return!0;const g=b[c]/3,C=b[c+1]/3,I=(t,e,i)=>h(c,t,n.transformMat3(e,e,o),i);return null==s&&C-g>r.componentMinimalSizeForIntersectionData?(null==this._componentIntersectionData[c]&&(this._componentIntersectionData[c]=new r.ComponentIntersectionData(this._indices,g,C,_)),this._componentIntersectionData[c].intersectRay({r0:t,r1:e},I)):p.intersectTriangles(t,e,g,C,f,_,void 0,s,I),!0}))},i._computePerComponentAabbs=function(){const t=this._components.count,n=o.newFloatArray(6*t),e=this._indices,i=this._positions,s=this._components.offsets;let r=0;for(let o=0;o<t;o++){const t=s[o],c=s[o+1];let a=1/0,p=1/0,u=1/0,m=-1/0,l=-1/0,h=-1/0;for(let n=t;n<c;n++){const t=3*e[n],o=i[t],s=i[t+1],r=i[t+2];a=Math.min(a,o),p=Math.min(p,s),u=Math.min(u,r),m=Math.max(m,o),l=Math.max(l,s),h=Math.max(h,r)}n[r++]=a,n[r++]=p,n[r++]=u,n[r++]=m,n[r++]=l,n[r++]=h}return n},t._createClass(e,[{key:"positions",get:function(){return this._positions}},{key:"indices",get:function(){return this._indices}}]),e}();const m=e.create(),l=i.create();return u}));
