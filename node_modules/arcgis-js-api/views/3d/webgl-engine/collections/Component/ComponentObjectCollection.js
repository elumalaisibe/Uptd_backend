/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../core/typedArrayUtil","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/Indices","../../../../../chunks/vec32","../../../../../chunks/vec33","../../../../ViewingMode","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./ComponentData","./ComponentObject","./IntersectionGeometry","./Renderable","./RenderGeometry","./RenderSubmitSystem","./SourceGeometry","./UniformComponentParameters","./Material/ComponentMaterial","./Material/ComponentTechnique","./Material/shader/ComponentData.glsl","../../lib/ComponentUtils","../../lib/Util","../../lib/VertexAttribute","../../lib/verticalOffsetUtils","../../lib/edgeRendering/bufferLayouts","../../lib/edgeRendering/edgeProcessing","../../lib/TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(e,t,n,o,r,i,s,a,c,l,u,f,m,p,b,h,g,d,y,C,v,O,M,_,w,S,x,A,j,D,P,I,L,B,U,V,E,R,T,k){"use strict";const G=o.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let N=function(){function e(e,t){this._renderManager=e,this._viewingMode=t,this._objects=[new i,new i],this._renderSubmit=new w.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=n("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new E.BufferManager(e.rctx,2+(this._hasObjectAndLayerId?1:0))}var o=e.prototype;return o.destroy=function(){I.assert(0===this._objects[v.State.Hidden].length&&0===this._objects[v.State.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy();const e=this._objects.flatMap((e=>e.toArray()));for(const t of e)t?.destroy()},o.createObject=function(e){const t=new v.ComponentObject;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=g.clone(e.obb),t.components=new C(this._componentBufferManager,f.compactIndices(e.geometry.componentOffsets)),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new O(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t},o.destroyObject=function(e){const t=e;this._objects[t.visible].removeUnordered(t),t.destroy(),this._notifyDirty()},o.setObjectVisibility=function(e,t){const n=e;t!==n.visible&&(this._objects[n.visible].removeUnordered(n),this._objects[t].push(n),n.visible=t,this._notifyDirty())},o.preSubmit=function(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=l.squaredDistance(t,e.obb.center)))},o.getMaterial=function(e){return e.renderable.material},o.updateMaterial=function(e,t){const n=e.renderable.material;t(n),n.dirty&&this._notifyDirty()},o.setAllComponentVisibilities=function(e,t){const n=e;n.components.visibility.reset(t),n.components.visibilityDirty(),this._notifyDirty()},o.forEachVisibleComponent=function(e,t){return e.components.visibility.forEachComponent(t)},o.getComponentCount=function(e){const t=e,n=t.components.visibility.componentCount();return{visible:n,invisible:t.components.count-n}},o.setComponentData=function(e,t){const n=e,o=n.renderable.material,r=n.components,i=r.materialDataBuffer,s=r.materialDataIndices,a=new x.UniformComponentParameters,c=i.textureBuffer,l=new Uint8Array(4),u=new Uint32Array(l.buffer);let f=0,m=0,p=0,b=r.verticalOffsets,d=1/0,y=-1/0,C=!1,v=!1,O=0;for(let g=0;g<r.count;g++){t(g,a),f+=+(a.externalColor[3]<1),m+=+(a.externalColorMixMode===h.ColorMixModeEnum.Replace&&1===a.externalColor[3]),p+=+a.castShadows,h.encodeSymbolColor(a.externalColor,a.externalColorMixMode,l),l[2]=254&l[2]|+a.castShadows,c.setData(s[g],0,l[0],l[1],l[2],l[3]),C||(C=g>0&&O!==u[0]),O=u[0],v||(v=0!==a.elevationOffset),v&&null==b&&(b=new Array(g).fill(0)),null!=b&&(b[g]=a.elevationOffset),d=Math.min(d,a.elevationOffset),y=Math.max(y,a.elevationOffset),D.encodeElevationOffset(a.elevationOffset,l),c.setData(s[g],1,l[0],l[1],l[2],l[3]);const e=a.objectAndLayerIdColor;null!=e&&c.setData(s[g],2,e[0],e[1],e[2],e[3]),a.pickable!==P.getVisibility(r.pickability,g)&&(r.pickability=P.updateVisibilityWithCount(r.pickability,r.count,g,a.pickable))}r.verticalOffsets=v?b:null,n.offsetObb=v?g.computeOffsetObb(n.obb,d,y,this._viewingMode,null!=n.offsetObb?n.offsetObb:g.clone(n.obb)):null,C||v||this._hasObjectAndLayerId?(o.componentParameters=new A.ComponentParametersVarying,o.componentParameters.castShadows=H(p,r.count),o.componentParameters.transparent=H(f,r.count),o.componentParameters.opaqueOverride=H(m,r.count),o.componentParameters.texture=c,c.updateTexture()):(o.componentParameters=new A.ComponentParametersUniform,o.componentParameters.castShadows=a.castShadows?A.ComponentParameterSummary.All:A.ComponentParameterSummary.None,o.componentParameters.externalColor=a.externalColor,o.componentParameters.externalColorMixMode=a.externalColorMixMode),this._notifyDirty()},o.getComponentAabb=function(e,t,n,o=!1){e.intersectionGeometry.getComponentAabb(t,n);const r=e,i=r.components.verticalOffsets;if(o||null==i)return n;const s=i[t];if(this._viewingMode===b.ViewingMode.Local||0===s)return n[2]+=s,n[5]+=s,n;const a=B.getVerticalOffsetI3S(s);return a.localOrigin=r.transform.position,a.applyToAabb(n)},o.getComponentObb=function(e){return e.obb},o.getObjectTransform=function(e){return e.transform},o.getComponentPositions=function(e,t,n){return e.intersectionGeometry.getComponentPositions(t,n)},o.intersect=function(e,t,n,o,r,i){const s=e;null!=r&&(r.localOrigin=s.transform.position);const c=a.invert(W,s.transform.rotationScale);l.sub(X,t,s.transform.position),l.sub(Y,n,s.transform.position),l.transformMat3(X,X,c),l.transformMat3(Y,Y,c);const u=a.transpose(W,c);return s.intersectionGeometry.intersect(X,Y,o,u,r,s.components.verticalOffsets,i)},o.addEdges=function(e,t,n,o){const r=e,{indices:i,positions:s}=r.intersectionGeometry,a=r.components.offsets;return t.addComponentObject(e,r.transform,{center:r.obb.center,radius:g.radius(r.obb)},s,i,a,n,o)},o.extractEdgeInformation=async function(e,t,n){const o=e,r=o.components.visibility;if(r.allInvisible())return{buffer:V.extractComponentsEdgeLocationsLayout.createBuffer(0),origin:[0,0,0]};const{indices:i,positions:s}=o.intersectionGeometry,a=o.components.offsets,c=U.EdgeInputBufferLayout.createBuffer(s.length/3);p.copy(c.position.typedBuffer,s,c.position.typedBufferStride,3),m.transformMat3View(c.position,c.position,o.transform.rotationScale),this._setComponentIndices(c.componentIndex,i,a);const l=c.count,f=this._computeVisibilityIndices(i,r,a,l);return{origin:u.clone(o.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:f,indicesLength:f.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},n)}},o._setComponentIndices=function(e,t,n){let o=0;for(let r=0;r<n.length-1;r++){const i=n[r],s=n[r+1];for(let n=i;n<s;n++){const r=t?t[n]:n;e.set(r,o)}o++}},o._computeVisibilityIndices=function(e,t,n,o){if(e&&t.allVisible())return e;let r=0;t.forEachComponentRange(((e,t)=>(r+=n[t]-n[e],!0)));const i=s.isArray(e)?new Array(r):2===e?.BYTES_PER_ELEMENT||o<=65536?new Uint16Array(r):new Uint32Array(r);let a=0;return t.forEachComponentRange(((t,o)=>{const r=n[t],s=n[o];for(let n=r;n<s;n++)i[a++]=e?e[n]:n;return!0})),i},o.addComponentHighlight=function(e,t){const n=e.components;null==n.highlightCounts&&(n.highlightCounts=new Uint32Array(n.count+1));0===n.highlightCounts[t]++&&(n.highlightsDirty(),this._notifyDirty()),n.highlightCounts[n.count]++},o.removeComponentHighlight=function(e,t){const n=e.components;if(null==n.highlightCounts)return void G.warn("Removing non-existing highlight.");const o=n.highlightCounts[t],r=n.highlightCounts[n.count];if(0!==o){if(o>1)return n.highlightCounts[t]=o-1,void(n.highlightCounts[n.count]=r-1);n.highlightCounts[t]=0,n.highlightsDirty(),this._notifyDirty(),1===r?n.highlightCounts=null:n.highlightCounts[n.count]=r-1}else G.warn("Removing non-existing highlight.")},o.clearHighlights=function(e){const t=e.components;null!=t.highlightCounts&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())},o.getObjectGPUMemoryUsage=function(e){return e.renderable.meta.gpuMemoryEstimate},o._createRenderable=function(e,t){const n=this._renderManager.rctx,o=e.geometry,i=o.vertices.layoutParameters,s=R.BufferObject.createVertex(n,T.Usage.STATIC_DRAW,o.vertices.data),a=r.applySome(o.indices,(e=>R.BufferObject.createIndex(n,T.Usage.STATIC_DRAW,e))),c=d.glLayout(S.createVertexBufferLayout(i)),l=new Uint16Array(o.vertices.count);for(let r=0;r<t.count;r++){const e=t.offsets[r],n=t.offsets[r+1],i=t.materialDataIndices[r];if(null!=o.indices)for(let t=e;t<n;t++){l[o.indices[t]]=i}else for(let t=e;t<n;t++)l[t]=i}const u=R.BufferObject.createVertex(n,T.Usage.STATIC_DRAW,l.buffer),f=new A.ComponentMaterial(e.transform,e.toMapSpace),m=new k.VertexArrayObject(n,j.attributeLocations,{data:c,componentIndices:q},{data:s,componentIndices:u},a),p=new _.RenderGeometry(m,T.PrimitiveType.TRIANGLES,i,null!=a),b={cameraDepthSquared:.5,gpuMemoryEstimate:s.byteLength+u.byteLength+(null!=a?a.byteLength:0)};return new M.Renderable(f,p,b)},o._notifyDirty=function(){this._renderManager.notifyDirty()},t._createClass(e,[{key:"visibleObjects",get:function(){return this._objects[v.State.Visible]}}]),e}();const q=d.glLayout(y.newLayout().u16(L.VertexAttribute.COMPONENTINDEX));function H(e,t){return e===t?A.ComponentParameterSummary.All:0===e?A.ComponentParameterSummary.None:A.ComponentParameterSummary.Some}const W=c.create(),X=u.create(),Y=u.create();e.ComponentObjectCollection=N,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
