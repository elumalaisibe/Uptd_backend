/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../chunks/vec4f64","../lib/basicInterfaces","../../../support/RenderState","../../../support/screenshotUtils","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/RenderbufferDescriptor","../../../webgl/TextureDescriptor","../../../../core/imageUtils"],(function(e,t,r,n,i,s,a,o,c,h,l,d,f){"use strict";let u=t._createClass((function(e,t){this.parameters=e,this.frameHasDecorations=t})),m=function(){function e(e,t,r,n){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=r,this._disposeOffscreenBuffers=n,this.supersample=!0,this._screenshotQueue=new Array}var u=e.prototype;return u.destroy=function(){this._rctx=null},u.takeScreenshot=async function(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(s.RenderRequestType.BACKGROUND);const t=n.createResolver();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise},u.update=function(e,t){for(const r of this._screenshotQueue){if(null==this._rctx){r.resolver.reject();continue}const n={...r.settings,pixelRatio:r.settings.pixelRatio*e.parameters.camera.pixelRatio},i=this._renderScreenshot(e,n,t);r.resolver(i)}this._screenshotQueue.length=0},u._renderScreenshotOverlay=function(e,t,r){e.width=t.width,e.height=t.height;const n=e.getContext("2d"),i=r.pixelRatio;return n.save(),n.translate(0,t.height),n.scale(1,-1),r.region&&n.translate(-r.region.x,-r.region.y),n.scale(i,i),t=this._renderFunctions.renderOverlay(e,t),n.restore(),t},u._readbackScreenshot=function(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)},u._readbackScreenshotResampled=function(e,t){const{framebufferWidth:r,framebufferHeight:n,region:i,resample:s}=e,a=this._ensureScreenshotEncodeCanvas();let h=f.createEmptyImageData(r,n,a);this._rctx.gl.readPixels(0,0,r,n,c.PixelFormat.RGBA,c.DataType.UNSIGNED_BYTE,new Uint8Array(h.data.buffer)),t(),h=this._renderScreenshotOverlay(a,h,{...e,region:void 0});const l=f.createEmptyImageData(i.width,i.height,a);return o.resampleHermite(h,l,!0,s.region.x,n-(s.region.y+s.region.height),s.region.width,s.region.height)},u._readbackScreenshotImmediate=function(e,t){const{framebufferHeight:r,region:n}=e,i=this._ensureScreenshotEncodeCanvas(),s=f.createEmptyImageData(n.width,n.height,i);return this._rctx.gl.readPixels(n.x,r-(n.y+n.height),n.width,n.height,c.PixelFormat.RGBA,c.DataType.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),t(),this._renderScreenshotOverlay(i,s,e)},u._renderScreenshot=function(e,t,n){let o=null;const f=e.parameters.camera,u={width:t.framebufferWidth,height:t.framebufferHeight};h.ensureAttachmentMaxSize(u,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let m=!1;const p=t.disableDecorations&&e.frameHasDecorations,g=u.width!==f.fullWidth||u.height!==f.fullHeight,b=t.ignorePadding&&f.pixelRatio!==t.pixelRatio,_=g||p||b||t.objectAndLayerIdColor,x=t.objectAndLayerIdColor?new h.FramebufferObject(this._rctx,new d.TextureDescriptor(u.width,u.height),new l.RenderbufferDescriptor(c.RenderbufferFormat.DEPTH_STENCIL,u.width,u.height)):null;if(_){const e=f.clone();if(t.ignorePadding){const r=i.clone(e.padding);for(let n=0;n<4;n++)r[n]=Math.round(r[n]/e.pixelRatio*t.pixelRatio);e.padding=r}e.fullWidth=u.width,e.fullHeight=u.height,e.pixelRatio=t.pixelRatio;const r=f.fovX-e.fovX,p=f.fovY-e.fovY;r<0&&r<p?e.fovX=f.fovX:p<0&&p<r&&(e.fovY=f.fovY);const g={camera:e,contentCamera:e,mode:a.RenderState.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(g),m=!0,o=new h.FramebufferObject(this._rctx,new d.TextureDescriptor(u.width,u.height),new l.RenderbufferDescriptor(c.RenderbufferFormat.DEPTH_STENCIL,u.width,u.height));const b=t.disableDecorations?s.Decorations.OFF:s.Decorations.ON;this._renderFunctions.renderScene(o,x,g,b,n),this._disposeOffscreenBuffers()}const S=()=>{this._rctx.bindFramebuffer(null),r.disposeMaybe(o)},v=this._readbackScreenshot(t,S);S();let R=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),r.disposeMaybe(x)};this._rctx.bindFramebuffer(x),R=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null),e()}if(_&&!this._rctx.contextAttributes.alpha)for(let r=3;r<v.data.length;r+=4)v.data[r]=255;if(R&&!this._rctx.contextAttributes.alpha)for(let r=3;r<R.data.length;r+=4)R.data[r]=255;return m&&this._forceCameraHook(e.parameters),[v,R]},u._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},t._createClass(e)}();e.ScreenshotContext=u,e.ScreenshotManager=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
