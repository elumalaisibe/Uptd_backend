/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/arrayUtils","../../../../../core/Evented","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/mat3","../../../../../chunks/mat3f64","../../../../../chunks/mat4","../../../../../chunks/mat4f64","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/buffer/BufferView","../../../support/mathUtils","../../../support/buffer/InterleavedLayout","../Util","../VertexAttribute","./RenderInstanceData"],(function(t,e,i,a,r,s,n,o,c,l,u,f,h,g,d,A,_,T,m,L,V,F){"use strict";var b;function E(t){let e=m.newLayout().mat4f64(V.VertexAttribute.LOCALTRANSFORM).mat4f64(V.VertexAttribute.GLOBALTRANSFORM).vec4f64(V.VertexAttribute.BOUNDINGSPHERE).vec3f64(V.VertexAttribute.MODELORIGIN).mat3f(V.VertexAttribute.MODEL).mat3f(V.VertexAttribute.MODELNORMAL).vec2f(V.VertexAttribute.MODELSCALEFACTORS);return t.includes(V.VertexAttribute.FEATUREATTRIBUTE)&&(e=e.vec4f(V.VertexAttribute.FEATUREATTRIBUTE)),t.includes(V.VertexAttribute.COLOR)&&(e=e.vec4u8(V.VertexAttribute.COLOR)),t.includes(V.VertexAttribute.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(V.VertexAttribute.OBJECTANDLAYERIDCOLOR)),e=e.u8(V.VertexAttribute.STATE).u8(V.VertexAttribute.LODLEVEL),e}t.StateFlags=void 0,(b=t.StateFlags||(t.StateFlags={}))[b.ALLOCATED=1]="ALLOCATED",b[b.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",b[b.VISIBLE=4]="VISIBLE",b[b.HIGHLIGHT=8]="HIGHLIGHT",b[b.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",b[b.REMOVE=32]="REMOVE",b[b.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",b[b.ACTIVE=18]="ACTIVE";let I=e._createClass((function(t){this.localTransform=t.getField(V.VertexAttribute.LOCALTRANSFORM,_.BufferViewMat4f64),this.globalTransform=t.getField(V.VertexAttribute.GLOBALTRANSFORM,_.BufferViewMat4f64),this.modelOrigin=t.getField(V.VertexAttribute.MODELORIGIN,_.BufferViewVec3f64),this.model=t.getField(V.VertexAttribute.MODEL,_.BufferViewMat3f),this.modelNormal=t.getField(V.VertexAttribute.MODELNORMAL,_.BufferViewMat3f),this.modelScaleFactors=t.getField(V.VertexAttribute.MODELSCALEFACTORS,_.BufferViewVec2f),this.boundingSphere=t.getField(V.VertexAttribute.BOUNDINGSPHERE,_.BufferViewVec4f64),this.featureAttribute=t.getField(V.VertexAttribute.FEATUREATTRIBUTE,_.BufferViewVec4f),this.color=t.getField(V.VertexAttribute.COLOR,_.BufferViewVec4u8),this.objectAndLayerIdColor=t.getField(V.VertexAttribute.OBJECTANDLAYERIDCOLOR,_.BufferViewVec4u8),this.state=t.getField(V.VertexAttribute.STATE,_.BufferViewUint8),this.lodLevel=t.getField(V.VertexAttribute.LODLEVEL,_.BufferViewUint8)}));function S(t,e,i){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),i))}t.InstanceData=function(i){function a(t,e){var a;return(a=i.call(this,t)||this).events=new s,a._capacity=0,a._size=0,a._next=0,a._layout=E(e),a._capacity=F.INITIAL_CAPACITY,a._buffer=a._layout.createBuffer(a._capacity),a._view=new I(a._buffer),a}e._inherits(a,i);var n=a.prototype;return n.addInstance=function(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,t.StateFlags.ALLOCATED),this._size++,this.events.emit("instances-changed"),e},n.removeInstance=function(e){const i=this._view.state;L.assert(e>=0&&e<this._capacity&&0!=(i.get(e)&t.StateFlags.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,t.StateFlags.ACTIVE)?this._setStateFlags(e,t.StateFlags.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")},n.freeInstance=function(e){const i=this._view.state;L.assert(e>=0&&e<this._capacity&&0!=(i.get(e)&t.StateFlags.ALLOCATED),"invalid instance handle"),i.set(e,0),this._size--},n.setLocalTransform=function(t,e,i=!0){this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)},n.getLocalTransform=function(t,e){this._view.localTransform.getMat(t,e)},n.setGlobalTransform=function(t,e,i=!0){this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)},n.getGlobalTransform=function(t,e){this._view.globalTransform.getMat(t,e)},n.updateModelTransform=function(e){const i=this._view,a=p,r=O;i.localTransform.getMat(e,v),i.globalTransform.getMat(e,M);const s=h.multiply(M,M,v);d.set(a,s[12],s[13],s[14]),i.modelOrigin.setVec(e,a),u.fromMat4(r,s),i.model.setMat(e,r);const n=T.scaleFromMatrix(p,s);n.sort(),i.modelScaleFactors.set(e,0,n[1]),i.modelScaleFactors.set(e,1,n[2]),u.invert(r,r),u.transpose(r,r),i.modelNormal.setMat(e,r),this._setStateFlags(e,t.StateFlags.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})},n.getModelTransform=function(t,e){const i=this._view;i.model.getMat(t,O),i.modelOrigin.getVec(t,p),e[0]=O[0],e[1]=O[1],e[2]=O[2],e[3]=0,e[4]=O[3],e[5]=O[4],e[6]=O[5],e[7]=0,e[8]=O[6],e[9]=O[7],e[10]=O[8],e[11]=0,e[12]=p[0],e[13]=p[1],e[14]=p[2],e[15]=1},n.applyShaderTransformation=function(t,e){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)},n.getCombinedModelTransform=function(t,e){return this.getModelTransform(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e),e},n.getCombinedLocalTransform=function(t,e){this._view.localTransform.getMat(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)},n.getCombinedMaxScaleFactor=function(t){let e=this._view.modelScaleFactors.get(t,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(p,this,t),e*=Math.max(p[0],p[1],p[2])),e},n.getCombinedMedianScaleFactor=function(t){let e=this._view.modelScaleFactors.get(t,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(p,this,t),e*=S(p[0],p[1],p[2])),e},n.getModel=function(t,e){this._view.model.getMat(t,e)},n.setFeatureAttribute=function(t,e){this._view.featureAttribute.setVec(t,e)},n.getFeatureAttribute=function(t,e){this._view.featureAttribute.getVec(t,e)},n.setColor=function(t,e){this._view.color.setVec(t,e)},n.setObjectAndLayerIdColor=function(t,e){this._view.objectAndLayerIdColor.setVec(t,e)},n.setVisible=function(e,i){i!==this.getVisible(e)&&(this._setStateFlag(e,t.StateFlags.VISIBLE,i),this.events.emit("instance-visibility-changed",{index:e}))},n.getVisible=function(e){return this._getStateFlag(e,t.StateFlags.VISIBLE)},n.setHighlight=function(e,i){i!==this.getHighlight(e)&&(this._setStateFlag(e,t.StateFlags.HIGHLIGHT,i),this.events.emit("instance-highlight-changed"))},n.getHighlight=function(e){return this._getStateFlag(e,t.StateFlags.HIGHLIGHT)},n.getState=function(t){return this._view.state.get(t)},n.getLodLevel=function(t){return this._view.lodLevel.get(t)},n.countFlags=function(t){let e=0;for(let i=0;i<this._capacity;++i){this.getState(i)&t&&++e}return e},n._setStateFlags=function(t,e){const i=this._view.state;e=i.get(t)|e,i.set(t,e)},n._clearStateFlags=function(t,e){const i=this._view.state;e=i.get(t)&~e,i.set(t,e)},n._setStateFlag=function(t,e,i){i?this._setStateFlags(t,e):this._clearStateFlags(t,e)},n._getStateFlag=function(t,e){return!!(this._view.state.get(t)&e)},n._grow=function(){this._capacity=Math.max(F.INITIAL_CAPACITY,Math.floor(this._capacity*r.ReallocGrowthFactor)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new I(this._buffer)},n._findSlot=function(){const e=this._view.state;let i=this._next;for(;e.get(i)&t.StateFlags.ALLOCATED;)i=i+1===this._capacity?0:i+1;return this._next=i+1===this._capacity?0:i+1,i},e._createClass(a,[{key:"capacity",get:function(){return this._capacity}},{key:"size",get:function(){return this._size}},{key:"view",get:function(){return this._view}}]),a}(a),i.__decorate([n.property({constructOnly:!0})],t.InstanceData.prototype,"shaderTransformation",void 0),i.__decorate([n.property()],t.InstanceData.prototype,"_size",void 0),i.__decorate([n.property({readOnly:!0})],t.InstanceData.prototype,"size",null),t.InstanceData=i.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],t.InstanceData);const p=A.create(),O=f.create(),v=g.create(),M=g.create();t.InstanceDataView=I,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
