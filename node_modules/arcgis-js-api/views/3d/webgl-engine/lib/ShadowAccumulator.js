/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec3","../../../../chunks/vec3f64","./BindParameters","./depthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","../../../../chunks/ShadowCastAccumulate.glsl","../shaders/ShadowCastAccumulateTechnique","../../../support/Scheduler","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/TextureDescriptor","../../../webgl/Util"],(function(e,t,i,r,s,a,o,n,c,h,u,_,l,d,p,m,g,f,w,b,y,v,A,S,C,R,T){"use strict";e.ShadowAccumulator=function(e){function i(i,r,s,o,n,h){var u;(u=e.call(this,{})||this)._rctx=i,u._stage=s,u._prepareForShadowMapPass=o,u._renderToShadowMap=n,u._requestRender=h,u._progress=0,u._sampleCount=0,u._passParameters=new y.ShadowCastAccumulatePassParameters,u._cachedLightDirections=[],u._depthRange=g.ZERO,u._previewing=!1,u._handles=new a,u._cameraForcedForScreenshot=!1,u._bindParameters=new m.BindParameters(new b.ShadowMap(i,s.viewingMode),null,null),u._bindParameters.shadowMap.enabled=!0,u._vao=f.createQuadVAO(i),u._accumulationRenderer=new w.ShadowCastRenderer(r,i,t._assertThisInitialized(u),h);const _=u._stage.view.resourceController.scheduler;return u._handles.add([_.registerTask(A.TaskPriority.SHADOW_ACCUMULATOR,t._assertThisInitialized(u)),c.watch((()=>s.renderView),(e=>{u._handles.remove(P),null!=e&&u._handles.add(e.events.on("force-camera-for-screenshot",(()=>u._cameraForcedForScreenshot=!0)),P)}),c.syncAndInitial),c.watch((()=>u._previewing),(()=>u._requestRenderIfEnabled()),c.sync)]),u}t._inherits(i,e);var r=i.prototype;return r.normalizeCtorArgs=function(){return{}},r.dispose=function(){this._disable(),this._handles.destroy(),this._accumulationRenderer=n.disposeMaybe(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=n.disposeMaybe(this._fbo),this._vao=n.disposeMaybe(this._vao),this._accumulationTechniqueCached=n.releaseMaybe(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0},r.runTask=function(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()},r.renderAccumulation=function(e,t,i,r){if(this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(D,this._sampleCount-this._progress);for(let a=0;a<s;++a)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()},r.render=function(e){this._accumulationRenderer.render(e)},r.setOptions=function(e){if(void 0!==e.enabled){const t=null!=this._fbo;e.enabled!==t&&(e.enabled?this._enable():this._disable())}void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)},r.readAccumulatedShadow=function(e,t){return!this._isActive||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,S.PixelFormat.RGBA,S.PixelType.UNSIGNED_BYTE,M),M[0]/this._progress)},r._enable=function(){this._progress=0;const e=new R.TextureDescriptor;e.wrapMode=S.TextureWrapMode.CLAMP_TO_EDGE,this._fbo=new C.FramebufferObject(this._rctx,e)},r._disable=function(){this._fbo=n.disposeMaybe(this._fbo)},r._invalidate=function(){this._progress=0,this._requestRenderIfEnabled()},r._clear=function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(S.ClearBufferBit.COLOR_BUFFER_BIT),this._progress=0},r._accumulateShadow=function(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,T.vertexCount(this._vao,"geometry"))},r._sampleLightDirection=function(){return this._progress++,this._lightDirections[this._progress*F%this._lightDirections.length]},r._updateCamera=function(e){!e.equals(this._bindParameters.camera)&&this._fbo&&(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-o.smoothstep(w.shadowCastDisableElevationMin,w.shadowCastDisableElevationMax,e.relativeElevation))},r._requestRenderIfEnabled=function(){this._fbo&&this._requestRender()},t._createClass(i,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo?.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){if(null==this._accumulationTechniqueCached){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new v.ShadowCastAccumulateTechnique(e)}return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return null!=this._fbo&&this._sampleCount>0}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==g.ZERO&&this._opacityFromElevation>w.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(e){const t=this._cachedLightDirections;if(s.equals(t,e,d.equals))return;const i=Math.min(y.ShadowCastMaxSamples,e.length);t.length=i,this._sampleCount=i;for(let r=0;r<i;++r)t[r]=d.copy(t[r]??p.create(),e[r]);this._invalidate()}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&this._progress>0}},{key:"test",get:function(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}}]),i}(r),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_progress",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_sampleCount",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_fbo",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_depthRange",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_previewing",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_accumulationRenderer",void 0),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isRefining",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isActive",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"canAccumulate",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_isDoneAccumulating",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"_opacityFromElevation",null),i.__decorate([h.property()],e.ShadowAccumulator.prototype,"running",null),e.ShadowAccumulator=i.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],e.ShadowAccumulator);const D=6,P="renderView",F=104729,M=new Uint8Array(4);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
