/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../ViewingMode","./glUtil3D","./SortedRenderGeometryRenderer","../shaders/HeatmapTechnique","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/TextureDescriptor","../../../webgl/Util"],(function(e,t,r,a,i,o,s,n,p,c,d,h,l,m,u,y,_,f,R){"use strict";e.DrapedHeatmapRenderer=function(e){function r(t){var r;(r=e.call(this,t)||this).pixelRatio=1,r._colorRampData=new Uint8ClampedArray(4),r.type="draped-heatmap",r._heatmapParameters=new m.HeatmapPassParameters;const a=new f.TextureDescriptor;a.pixelFormat=t.pixelFormat,a.internalFormat=t.internalFormat,a.dataType=t.dataType,a.samplingMode=t.samplingMode,a.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE;const i=t.rendererContext.rctx;r._densityMap=new y.FramebufferObject(i,a),r._quad=h.createQuadVAO(i);const o=new m.HeatmapTechniqueConfiguration;return o.usesHalfFloat=t.dataType!==u.PixelType.FLOAT,r._technique=new m.HeatmapTechnique({rctx:i,viewingMode:d.ViewingMode.Local},o),r}t._inherits(r,e);var o=r.prototype;return o.initialize=function(){const e=this._colorRampData,t=new f.TextureDescriptor(e.length/4,1);t.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE,this._colorRamp=new _.Texture(this.rctx,t,e),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles(i.watch((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))},o.destroy=function(){this._technique=a.releaseMaybe(this._technique),this._densityMap=a.disposeMaybe(this._densityMap),this._quad=a.disposeMaybe(this._quad),this._colorRamp=a.disposeMaybe(this._colorRamp)},o.render=function(e){const t=this._sortedMaterialRenderers;if(0===t.length)return;const r=this.rctx.getBoundFramebufferObject(),a=this.rctx.getViewport(),{pixelRatio:i}=this,o=Math.ceil(a.width*i),s=Math.ceil(a.height*i);this._densityMap.resize(o,s),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,o,s),this.rctx.clear(u.ClearBufferBit.COLOR_BUFFER_BIT);let n=!1;t.forAll((t=>{if(t.material.shouldRender(e)){const r=t.prepareTechnique(e);null!=r&&(t.render(e,r),n=!0)}})),this.rctx.bindFramebuffer(r),this.rctx.setViewport(a.x,a.y,a.width,a.height),n&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,this._heatmapParameters,e.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,R.vertexCount(this._quad,"geometry")))},t._createClass(r,[{key:"searchRadius",get:function(){return this._heatmapParameters.searchRadius},set:function(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}},{key:"minDensity",get:function(){return this._heatmapParameters.minDensity},set:function(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}},{key:"maxDensity",get:function(){return this._heatmapParameters.maxDensity},set:function(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}},{key:"fieldTotal",get:function(){return this._heatmapParameters.fieldTotal},set:function(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}},{key:"colorRampData",get:function(){return this._colorRampData},set:function(e){const{colorRamp:t}=this._heatmapParameters;if(null!=t&&e!==this._colorRampData){const r=t.descriptor.width,a=e.length/4;a!==r&&t.resize(a,1),t.setData(e)}this._colorRampData=e}},{key:"_colorRamp",get:function(){return this._heatmapParameters.colorRamp},set:function(e){this._heatmapParameters.colorRamp=e}},{key:"hasHighlights",get:function(){return!1}},{key:"hasWater",get:function(){return!1}},{key:"rendersOccluded",get:function(){return!1}}]),r}(l.SortedRenderGeometryRenderer),r.__decorate([o.property()],e.DrapedHeatmapRenderer.prototype,"searchRadius",null),r.__decorate([o.property()],e.DrapedHeatmapRenderer.prototype,"minDensity",null),r.__decorate([o.property()],e.DrapedHeatmapRenderer.prototype,"maxDensity",null),r.__decorate([o.property()],e.DrapedHeatmapRenderer.prototype,"fieldTotal",null),r.__decorate([o.property()],e.DrapedHeatmapRenderer.prototype,"pixelRatio",void 0),r.__decorate([o.property()],e.DrapedHeatmapRenderer.prototype,"colorRampData",null),r.__decorate([o.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"dataType",void 0),r.__decorate([o.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"samplingMode",void 0),r.__decorate([o.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"pixelFormat",void 0),r.__decorate([o.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"internalFormat",void 0),r.__decorate([o.property()],e.DrapedHeatmapRenderer.prototype,"_colorRampData",void 0),e.DrapedHeatmapRenderer=r.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],e.DrapedHeatmapRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
