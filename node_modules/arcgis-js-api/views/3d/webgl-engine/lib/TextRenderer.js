/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../support/debugFlags"],(function(t,e,i,n){"use strict";let s=function(){function s(t,e,i,n=2048){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=n,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${t}`,this._lines=t.split(/\r?\n/)}var r=s.prototype;return r._getLineXOffset=function(e){switch(this._alignment){case t.TextRenderAlignment.Left:return this._backgroundHorizontalPadding;case t.TextRenderAlignment.Center:return(this.displayWidth-this._lineWidths[e])/2;case t.TextRenderAlignment.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[e]}},r.render=function(t,e=0,i=0){t.save();const s=e/=this.renderPixelRatio,o=i/=this.renderPixelRatio,r=this._haloSize,a=this._firstLineYOffset;e+=r,i+=a+this._baselinePosition;const h=this._haloSize>0;h&&this._renderHalo(t,s,o,r,a),this._setFontProperties(t,this._renderedFontSize);for(let n=0;n<this._lines.length;++n){const s=this._lines[n],o=this._getLineXOffset(n);h&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,s,e+o,i),this._renderLineDecoration(t,e+o,i,this._textWidths[n])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,s,e+this._getLineXOffset(n),i),this._renderLineDecoration(t,e+o,i,this._textWidths[n]),i+=this._lineSpacing}if(n.TEXT_SHOW_BASELINE){t.strokeStyle=_,t.setLineDash([2,2]),t.lineWidth=1;let e=o+a;for(let i=0;i<this._lines.length;++i){const i=e+this._baselinePosition;this._drawLine(t,[s,i],[s+this.displayWidth,i]),e+=this._lineSpacing}}if(n.TEXT_SHOW_BORDER&&(t.strokeStyle=_,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,o],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,o,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()},r._renderLineDecoration=function(t,e,i,n,s=!1){if("none"===this._parameters.definition.font.decoration||0===n)return;const o=1,r=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":i+=2*r;break;case"line-through":i-=.33*this._baselinePosition}const a=s?this._haloSize:0;t.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(r+2*a),t.beginPath(),t.moveTo(this._toRenderUnit(e-a),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+n+a),this._toRenderUnit(i)),t.stroke()},r._roundedRect=function(t,e,n,s){e=this._toRenderUnit(e),n=this._toRenderUnit(n);const o=this.renderedWidth,r=this.renderedHeight;0!==s?(s=i.clamp(s,0,Math.floor(r/2)),t.beginPath(),t.moveTo(e,n+s),t.arcTo(e,n,e+s,n,s),t.lineTo(e+o-s,n),t.arcTo(e+o,n,e+o,n+s,s),t.lineTo(e+o,n+r-s),t.arcTo(e+o,n+r,e+o-s,n+r,s),t.lineTo(e+s,n+r),t.arcTo(e,n+r,e,n+r-s,s),t.closePath()):t.rect(e,n,o,r)},r._renderHalo=function(t,e,i,n,s){const o=this.renderedWidth,r=this.renderedHeight,l=a(h,Math.max(o,d),Math.max(r,d)),_=l.getContext("2d");_.clearRect(0,0,o,r),this._setFontProperties(_,this._renderedFontSize),_.fillStyle=this._parameters.haloStyle,_.strokeStyle=this._parameters.haloStyle;const c=this._renderedHaloSize<3;_.lineJoin=c?"miter":"round",c?this._renderHaloEmulated(_,n,s):this._renderHaloNative(_,n,s);let u=s+this._baselinePosition;for(let a=0;a<this._lines.length;++a){const t=this._getLineXOffset(a);this._renderLineDecoration(_,n+t,u,this._textWidths[a],!0),u+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(l,0,0,o,r,this._toRenderUnit(e),this._toRenderUnit(i),o,r),t.globalAlpha=1},r._renderHaloEmulated=function(t,e,i){i+=this._baselinePosition;for(let n=0;n<this._lines.length;++n){const s=this._lines[n],r=this._getLineXOffset(n);for(const[n,a]of o)this._fillText(t,s,e+r+this._haloSize*n,i+this._haloSize*a);i+=this._lineSpacing}},r._renderHaloNative=function(t,e,i){const n=2*this._haloSize;i+=this._baselinePosition;for(let s=0;s<this._lines.length;++s){const o=this._lines[s],r=this._getLineXOffset(s),a=5,h=.1;for(let s=0;s<a;s++){const l=1-(a-1)*h+s*h;t.lineWidth=this._toRenderUnit(l*n),this._strokeText(t,o,e+r,i)}i+=this._lineSpacing}},r._setFontProperties=function(t,e){t.font=this._parameters.fontString(e),t.textAlign="left",t.textBaseline="alphabetic"},r._toRenderUnit=function(t){return t*this.renderPixelRatio},r._toRoundedRenderUnit=function(t){return Math.round(t*this.renderPixelRatio)},r._fillText=function(t,e,i,n){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(n))},r._strokeText=function(t,e,i,n){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(n))},r._drawLine=function(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()},r._drawBox=function(t,e,i){const n=this._toRenderUnit(e[0]),s=this._toRenderUnit(e[1]),o=this._toRenderUnit(i[0]),r=this._toRenderUnit(i[1]),a=Math.floor(n)+.5,h=Math.ceil(n+o)-.5,l=Math.floor(s)+.5,d=Math.ceil(s+r)-.5;t.beginPath(),t.moveTo(a,l),t.lineTo(h,l),t.lineTo(h,d),t.lineTo(a,d),t.lineTo(a,l),t.stroke()},e._createClass(s,[{key:"displayWidth",get:function(){return Math.ceil(this._displayWidth+2*this._backgroundHorizontalPadding)}},{key:"displayHeight",get:function(){const t=this._lineSpacing*(this._lines.length-1),e=this._lineHeight;return Math.ceil(t+e+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}},{key:"renderedWidth",get:function(){return Math.ceil(this._toRenderUnit(this.displayWidth))}},{key:"renderedHeight",get:function(){return Math.ceil(this._toRenderUnit(this.displayHeight))}},{key:"firstRenderedBaselinePosition",get:function(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}},{key:"_firstLineYOffset",get:function(){return this._backgroundTopPadding+this._haloSize}},{key:"_metrics",get:function(){if(null==this._metricsCached){const t=a(h,d,d).getContext("2d");this._setFontProperties(t,this._fontSize);let e=2*this._haloSize;const i=this._parameters.definition.font;"italic"!==i.style&&"oblique"!==i.style&&"bold"!==i.weight&&"bolder"!==i.weight||(e+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let n,s,o=0,r=0,l=0;this._lines.forEach(((i,a)=>{const h=t.measureText(i),d=h.width,_=d+e;this._textWidths.push(d),this._lineWidths.push(_),o=Math.max(o,_),r=Math.max(r,h.actualBoundingBoxAscent),l=Math.max(l,h.actualBoundingBoxDescent),0===a&&(n=h),a===this._lines.length-1&&(s=h)}));const _=t.font;let p=f.get(_);if(!p){const e=t.measureText(c);p=new g(e.actualBoundingBoxAscent,e.actualBoundingBoxDescent),f.set(_,p)}r=Math.max(r,p.actualBoundingBoxAscent),l=Math.max(l,p.actualBoundingBoxDescent);const m=r+l,x=this._hasBackground?n.actualBoundingBoxAscent:r,R=this._hasBackground?s.actualBoundingBoxDescent:l;this._metricsCached=new u(r-x,l-R,m,o,r)}return this._metricsCached}},{key:"_lineSpacing",get:function(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}},{key:"_lineHeight",get:function(){return this._metrics.lineHeight}},{key:"_linePadding",get:function(){return this._lineHeight*l}},{key:"_baselinePosition",get:function(){return this._metrics.baselinePosition}},{key:"_renderedFontSize",get:function(){return this._toRenderUnit(this._fontSize)}},{key:"_fontSize",get:function(){return this._parameters.definition.size}},{key:"_renderedHaloSize",get:function(){return this._toRenderUnit(this._haloSize)}},{key:"_haloSize",get:function(){return this._parameters.haloSize}},{key:"_backgroundHorizontalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}},{key:"_backgroundVerticalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}},{key:"_backgroundTopPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingTop)}},{key:"_backgroundBottomPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingBottom)}},{key:"_hasBackground",get:function(){return!!this._parameters.backgroundStyle}},{key:"renderPixelRatio",get:function(){if(null==this._renderPixelRatio){const t=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(t,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=t}return this._renderPixelRatio}},{key:"_displayWidth",get:function(){return this._metrics.displayWidth}}]),s}();const o=[];{const t=16;for(let e=0;e<360;e+=360/t)o.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var r;function a(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}t.TextRenderAlignment=void 0,(r=t.TextRenderAlignment||(t.TextRenderAlignment={}))[r.Left=0]="Left",r[r.Center=1]="Center",r[r.Right=2]="Right";const h={canvas:null},l=.2,d=512,_="rgb(255, 0, 255, 0.5)",c=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})();let u=e._createClass((function(t,e,i,n,s){this.paddingTop=t,this.paddingBottom=e,this.lineHeight=i,this.displayWidth=n,this.baselinePosition=s})),g=e._createClass((function(t,e){this.actualBoundingBoxAscent=t,this.actualBoundingBoxDescent=e}));const f=new Map;t.TextRenderer=s,t.getTextHelperCanvas=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
