/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/Error","../../../../core/Evented","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/urlUtils","../../../../support/requestImageUtils","../../../../support/requestUtils","./basicInterfaces","./BasisUtil","./ContentObject","./ContentObjectType","./DDSUtil","./Util","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,a,i,o,n,s,l,m,d,u,c,h,p,_,g,T,A,E){"use strict";let f=function(e){function r(t,r){var a;return(a=e.call(this)||this)._data=t,a.type=p.ContentObjectType.Texture,a._glTexture=null,a._loadingPromise=null,a._loadingController=null,a.events=new i,a.parameters=r||{},a.parameters.mipmap=!1!==a.parameters.mipmap,a.parameters.noUnpackFlip=a.parameters.noUnpackFlip||!1,a.parameters.preMultiplyAlpha=a.parameters.preMultiplyAlpha||!1,a.parameters.wrap=a.parameters.wrap||{s:T.TextureWrapMode.REPEAT,t:T.TextureWrapMode.REPEAT},a._startPreload(t),a}t._inherits(r,e);var h=r.prototype;return h._startPreload=function(e){null!=e&&(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))},h._startPreloadVideoElement=function(e){if(!(l.isBlobProtocol(e.src)||"auto"===e.preload&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const t=!e.paused;if(e.src=e.src,t&&e.autoplay){const t=()=>{e.removeEventListener("canplay",t),e.play()};e.addEventListener("canplay",t)}}},h._startPreloadImageElement=function(e){l.isDataProtocol(e.src)||l.isBlobProtocol(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)},h.dispose=function(){this._data=void 0},h._createDescriptor=function(e){const t=new E.TextureDescriptor;return t.wrapMode=this.parameters.wrap??T.TextureWrapMode.REPEAT,t.flipped=!this.parameters.noUnpackFlip,t.samplingMode=this.parameters.mipmap?T.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:T.TextureSamplingMode.LINEAR,t.hasMipmap=!!this.parameters.mipmap,t.preMultiplyAlpha=!!this.parameters.preMultiplyAlpha,t.maxAnisotropy=this.parameters.maxAnisotropy??(this.parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t},h.load=function(e){if(null!=this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const t=this._data;return null==t?(this._glTexture=new A.Texture(e,this._createDescriptor(e),null),this._glTexture):"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):(s.isArrayBuffer(t)||s.isUint8Array(t))&&this.parameters.encoding===u.TextureEncodingMimeType.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,t)):(s.isArrayBuffer(t)||s.isUint8Array(t))&&this.parameters.encoding===u.TextureEncodingMimeType.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,t)):(s.isArrayBuffer(t)||s.isUint8Array(t))&&this.parameters.encoding===u.TextureEncodingMimeType.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,t)):s.isUint8Array(t)?this._loadFromPixelData(e,t):s.isArrayBuffer(t)?this._loadFromPixelData(e,new Uint8Array(t)):null},h.frameUpdate=function(e){return this._data instanceof HTMLVideoElement&&null!=this._glTexture?this._data.readyState<D.HAVE_CURRENT_DATA||e===this._data.currentTime?e:(this._glTexture.setData(this._data),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.parameters.updateCallback&&this.parameters.updateCallback(),this._data.currentTime):e},h._loadFromDDSData=function(e,t){return this._glTexture=_.createDDSTexture(e,this._createDescriptor(e),t),this._glTexture},h._loadFromKTX2=function(e,t){return this._loadAsync((()=>c.createTextureKTX2(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))},h._loadFromBasis=function(e,t){return this._loadAsync((()=>c.createTextureBasis(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))},h._loadFromPixelData=function(e,t){g.assert(this.parameters.width>0&&this.parameters.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this.parameters.components?T.PixelFormat.LUMINANCE:3===this.parameters.components?T.PixelFormat.RGB:T.PixelFormat.RGBA,r.width=this.parameters.width??0,r.height=this.parameters.height??0,this._glTexture=new A.Texture(e,r,t),this._glTexture},h._loadFromURL=function(e,t){return this._loadAsync((async r=>{const a=await m.requestImage(t,{signal:r});return n.throwIfAborted(r),this._loadFromImage(e,a)}))},h._loadFromImageElement=function(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync((async r=>{const a=await d.loadImageAsync(t,t.src,!1,r);return n.throwIfAborted(r),this._loadFromImage(e,a)}))},h._loadFromVideoElement=function(e,t){return t.readyState>=D.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)},h._loadFromVideoElementAsync=function(e,t){return this._loadAsync((r=>new Promise(((i,s)=>{const l=()=>{t.removeEventListener("loadeddata",m),t.removeEventListener("error",d),o.removeMaybe(u)},m=()=>{t.readyState>=D.HAVE_CURRENT_DATA&&(l(),i(this._loadFromImage(e,t)))},d=e=>{l(),s(e||new a("Failed to load video"))};t.addEventListener("loadeddata",m),t.addEventListener("error",d);const u=n.onAbort(r,(()=>d(n.createAbortError())))}))))},h._loadFromImage=function(e,t){const r=x(t);this.parameters.width=r.width,this.parameters.height=r.height;const a=this._createDescriptor(e);return a.pixelFormat=3===this.parameters.components?T.PixelFormat.RGB:T.PixelFormat.RGBA,a.width=r.width,a.height=r.height,this._glTexture=new A.Texture(e,a,t),this._glTexture},h._loadAsync=function(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const a=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(a,a),r},h.unload=function(){if(this._glTexture=o.disposeMaybe(this._glTexture),null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")},t._createClass(r,[{key:"glTexture",get:function(){return this._glTexture}},{key:"memoryEstimate",get:function(){return this._glTexture?.gpuMemoryUsage||y(this._data,this.parameters)}},{key:"requiresFrameUpdates",get:function(){return this._data instanceof HTMLVideoElement}}]),r}(h.ContentObject);function y(e,t){if(null==e)return 0;if(s.isArrayBuffer(e)||s.isUint8Array(e))return t.encoding===u.TextureEncodingMimeType.KTX2_ENCODING?c.estimateMemoryKTX2(e,!!t.mipmap):t.encoding===u.TextureEncodingMimeType.BASIS_ENCODING?c.estimateMemoryBasis(e,!!t.mipmap):e.byteLength;const{width:r,height:a}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?x(e):t;return(t.mipmap?4/3:1)*r*a*(t.components||4)||0}function x(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}var D;!function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(D||(D={})),e.Texture=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
