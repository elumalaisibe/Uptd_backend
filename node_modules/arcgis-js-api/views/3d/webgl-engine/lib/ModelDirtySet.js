/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","./ModelDirtyTypes","./Util"],(function(e,t,r,o,i,s,n,d,c,a,y,h){"use strict";let l=e._createClass((function(e,t,r){this.operation=e,this.geometry=t,this.states=r})),u=function(t){function r(e){var r;return(r=t.call(this,e)||this)._residentGeomRecords=new Map,r._dirtyGeomRecords=new Map,r.dirty=!1,r}e._inherits(r,t);var s=r.prototype;return s.commitLayer=function(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach(((r,o)=>{const i=this._ensureGeomRecord(e,o);r.forEach((({geometry:e,operation:r,states:s},n)=>{let d=!1;if(r===y.DirtyOperation.UPDATE){const r=i.get(n);if(r){if(s&y.DirtyState.TRANSFORMATION){const t=this.model.getObject(o);this.model.updateRenderGeometryTransformation(t,e,r)&&(d=!0)}d||t.updates.push({renderGeometry:r,updateType:s})}else h.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(r===y.DirtyOperation.REMOVE||d){const e=i.get(n);e?(t.removes.push(e),i.delete(n)):r===y.DirtyOperation.REMOVE&&h.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(r===y.DirtyOperation.ADD||d){const r=this.model.getObject(o);if(null!=r){const o=this.model.getRenderGeometry(r,e);t.adds.push(o),i.set(n,o)}}})),0===i.size&&this._residentGeomRecords.get(e).delete(o)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)},s.getResidentRenderGeometries=function(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach((e=>e.forEach((e=>t.push(e)))))},s._objectStateChanged=function(e,t){for(const r of t.geometries)this._updateOrCreateDirtyRecord(t,r,null,y.DirtyOperation.UPDATE,e)},s.visibilityChanged=function(e){this._objectStateChanged(y.DirtyState.VISIBILITY,e)},s.highlightChanged=function(e){this._objectStateChanged(y.DirtyState.HIGHLIGHT,e)},s.occlusionChanged=function(e){this._objectStateChanged(y.DirtyState.OCCLUDEE,e)},s.objectGeometryUpdated=function(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,y.DirtyOperation.UPDATE,y.DirtyState.GEOMETRY)},s.layerAdded=function(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))},s.layerRemoved=function(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))},s.layerObjectAdded=function(e){this._layerObjectAdded(e.layer,e.object)},s._layerObjectAdded=function(e,t){const r=e.id;for(const o of t.geometries)this._objectGeometryAdded(t,o,r)},s.layerObjectRemoved=function(e){this._layerObjectRemoved(e.layer,e.object)},s.layerObjectsAdded=function(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)},s.layerObjectsRemoved=function(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)},s._layerObjectRemoved=function(e,t){const r=e.id;for(const o of t.geometries)this._objectGeometryRemoved(t,o,r)},s.shaderTransformationChanged=function(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const r=this.model.getObject(t);r&&r.hasVolativeTransformation()&&e.forEach((e=>e.shaderTransformationChanged()))}))},s.objectTransformation=function(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((r=>{this._updateOrCreateDirtyRecord(e,r.geometry,t,y.DirtyOperation.UPDATE,y.DirtyState.TRANSFORMATION)}))},s.objectShaderTransformation=function(){},s.objectGeometryAdded=function(e){this._objectGeometryAdded(e.object,e.geometry)},s._objectGeometryAdded=function(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,y.DirtyOperation.ADD)},s.objectGeometryRemoved=function(e){this._objectGeometryRemoved(e.object,e.geometry)},s._objectGeometryRemoved=function(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,y.DirtyOperation.REMOVE)},s._updateOrCreateDirtyRecord=function(e,t,r,o,i=y.DirtyState.NONE){r=r??this._getParentLayerId(e);const s=e.id,n=t.id,d=this._ensureDirtyRecord(r,s),c=d.get(n);if(c){const e=c.operation;e===y.DirtyOperation.REMOVE&&o===y.DirtyOperation.ADD&&c.states!==y.DirtyState.NONE?c.operation=y.DirtyOperation.UPDATE:e===y.DirtyOperation.REMOVE&&o===y.DirtyOperation.ADD||e===y.DirtyOperation.ADD&&o===y.DirtyOperation.REMOVE?d.delete(n):e!==y.DirtyOperation.UPDATE||o!==y.DirtyOperation.REMOVE&&o!==y.DirtyOperation.UPDATE?(h.assert((e===y.DirtyOperation.REMOVE||e===y.DirtyOperation.ADD)&&o===y.DirtyOperation.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=i):(c.operation=o,c.states|=i)}else d.set(n,new l(o,t,i));this.dirty=this._hasDirtyGeometryRecords},s._ensureGeomRecord=function(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o},s._ensureDirtyRecord=function(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o},s._getParentLayerId=function(e){return e.parentLayer?e.parentLayer.id:i.NullUID},s.formatDebugInfo=function(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((r,o)=>{r.forEach(((r,i)=>{t.length>0&&(t+="\n"),t+=o+"."+i;const s=[];r.forEach((e=>{const t=e.operation;s[t]||(s[t]=[]),s[t].push(e.geometry.id)}));for(let o=0;o<s.length;o++)if(s[o]){t+=" "+e[o-1]+": ";for(let e=0;e<s[o].length;e++)t+=s[o][e]+", "}}))})),t},e._createClass(r,[{key:"_hasDirtyGeometryRecords",get:function(){return o.someMap(this._dirtyGeomRecords,(e=>o.someMap(e,(e=>e&&e.size>0))))}},{key:"test",get:function(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)},commit:t=>e._dirtyGeomRecords.forEach(((r,o)=>e.commitLayer(o,t)))}}}]),r}(r);t.__decorate([s.property({constructOnly:!0})],u.prototype,"model",void 0),t.__decorate([s.property()],u.prototype,"dirty",void 0),u=t.__decorate([a.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],u);return u}));
