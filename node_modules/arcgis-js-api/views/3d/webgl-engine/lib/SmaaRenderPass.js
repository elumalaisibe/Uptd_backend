/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../support/requestImageUtils","../core/shaderTechnique/ShaderTechniqueConfiguration","./BlendWeightsTechnique","./BlurTechnique","./EdgeDetectTechnique","./glUtil3D","../shaders/SMAAPassParameters","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,r,t,s,a,i,n,o,u,l,h,c,d,_,p,b,T,m,f,g,P,x,q){"use strict";r.SmaaRenderPass=function(r){function s(e,t){var s;return(s=r.call(this,{})||this)._rctx=e,s._techniqueRep=t,s._passParameters=new f.SMAAPassParameters,s._isEnabled=!1,s}t._inherits(s,r);var a=s.prototype;return a.normalizeCtorArgs=function(){return{}},a.dispose=function(){this._abortController=i.abortMaybe(this._abortController),this.disable()},a._loadResources=function(r){if(null!=this._abortController)return!1;if(null!=this._passParameters.searchTexture)return!0;this._abortController=new AbortController;const t=this._abortController.signal;return new Promise(((r,t)=>e(["./SmaaRenderPassData"],r,t))).then((e=>this._loadTextures(e,t))).then((()=>r())).finally((()=>this._abortController=null)),!1},a._loadTextures=function(e,r){return n.throwIfAborted(r),Promise.all([this._loadTextureFromBase64(e.areaTexture,g.TextureSamplingMode.LINEAR,g.PixelFormat.RGB),this._loadTextureFromBase64(e.searchTexure,g.TextureSamplingMode.NEAREST,g.PixelFormat.LUMINANCE)]).then((([e,t])=>{n.isAborted(r)?(e.dispose(),t.dispose(),n.throwIfAborted(r)):(this._passParameters.areaTexture=e,this._passParameters.searchTexture=t)}))},a.enable=function(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const e=new _.ShaderTechniqueConfiguration;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(T.EdgeDetectTechnique,e,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(p.BlendWeightsTechnique,e,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(b.BlurTechnique,e,this._blurTechnique)}if(!this._loadResources(e))return!1;this._vao=m.createScreenSizeTriangleVAO(this._rctx);const r=new q.TextureDescriptor(4,4);r.pixelFormat=g.PixelFormat.RG,r.internalFormat=g.SizedPixelFormat.RG8,r.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,this._passParameters.edges=new P.FramebufferObject(this._rctx,r);const t=new q.TextureDescriptor(4,4);return t.pixelFormat=g.PixelFormat.RGBA,t.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,this._passParameters.blend=new P.FramebufferObject(this._rctx,t),this._isEnabled=!0,!0},a.disable=function(){this._isEnabled&&(this._vao=i.disposeMaybe(this._vao),this._passParameters.areaTexture=i.disposeMaybe(this._passParameters.areaTexture),this._passParameters.searchTexture=i.disposeMaybe(this._passParameters.searchTexture),this._passParameters.blend=i.disposeMaybe(this._passParameters.blend),this._passParameters.edges=i.disposeMaybe(this._passParameters.edges),this._isEnabled=!1)},a.render=function(e){const r=this._validPassParameters;if(null==r)return;r.colorTexture=e;const t=this._rctx,s=t.getBoundFramebufferObject(),a=e.descriptor.width,i=e.descriptor.height;t.bindVAO(this._vao),t.setViewport(0,0,a,i),r.edges.resize(a,i),t.bindFramebuffer(r.edges),t.setClearColor(0,0,0,1),t.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),t.bindTechnique(this._edgeDetectTechnique,r,null),t.drawArrays(g.PrimitiveType.TRIANGLES,0,3),r.blend.resize(a,i),t.bindFramebuffer(r.blend),t.setClearColor(0,0,1,1),t.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),t.bindTechnique(this._blendWeightsTechnique,r,null),t.drawArrays(g.PrimitiveType.TRIANGLES,0,3),t.bindFramebuffer(s),t.setClearColor(0,1,0,1),t.clear(g.ClearBufferBit.COLOR_BUFFER_BIT),t.bindTechnique(this._blurTechnique,r,null),t.drawArrays(g.PrimitiveType.TRIANGLES,0,3)},a._loadTextureFromBase64=function(e,r,t){return d.requestImage(e).then((e=>{const s=new q.TextureDescriptor;return s.pixelFormat=t,s.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,s.width=e.width,s.height=e.height,s.samplingMode=r,new x.Texture(this._rctx,s,e)}))},t._createClass(s,[{key:"updating",get:function(){return null!=this._abortController}},{key:"_validPassParameters",get:function(){return this._isEnabled?this._passParameters:null}}]),s}(a),s.__decorate([o.property()],r.SmaaRenderPass.prototype,"_abortController",void 0),s.__decorate([o.property({readOnly:!0})],r.SmaaRenderPass.prototype,"updating",null),r.SmaaRenderPass=s.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],r.SmaaRenderPass),Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
