/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/MapUtils","../../../../core/maybe","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec4","../../../../chunks/vec4f64","./ContentObjectType","./testUtils","./textureUtils","./VertexAttribute","../../../support/Scheduler","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,s,r,i,n,a,o,h,l,c,d,u,_,m,g,p,x,f,T,y,A,v){"use strict";const b=4096;let R=t._createClass((function(){this.offset={x:0,y:0},this.uvMinMax=m.create()})),z=t._createClass((function(e,t){this.textId=e,this.textRenderer=t,this.placement=new R,this.rendered=!1})),O=function(){function e(e,t,s){this.size=e,this.cursor=t,this.lineHeight=s}var s=e.prototype;return s.resize=function(e){this.size.height=e},s.resetCursor=function(){this.cursor.x=M,this.cursor.y=M+k,this.lineHeight=0},s.getUsage=function(){return(this.cursor.x+this.cursor.y*this.size.width)/(this.size.width*this.size.height)},t._createClass(e)}();e.TextTextureAtlas=function(e){function s(t){var s;return(s=e.call(this,t)||this).type=g.ContentObjectType.Texture,s.id=o.generateUID(),s.events=new i,s._glTexture=null,s._needsClear=!1,s._elementsToAddOrUpdate=new Map,s._elementsToRemove=new Map,s._elementsToRender=new Map,s._elements=new Map,s._stageObjects=new Map,s.updating=!1,s}t._inherits(s,e);var r=s.prototype;return r.initialize=function(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._atlas=new O({width:b,height:256},{x:0,y:0},0),this._updateCanvasElementSize(this._atlas),this._resetAtlasCursor()},r.unload=function(){this._glTexture=a.disposeMaybe(this._glTexture),this.updating=!1,this.events.emit("unloaded")},r._createDescriptor=function(e){const t=new v.TextureDescriptor;return t.wrapMode=y.TextureWrapMode.CLAMP_TO_EDGE,t.flipped=!0,t.samplingMode=y.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,t},r.load=function(e){return null!=this._glTexture||(this._glTexture=new A.Texture(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(T.TaskPriority.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture},r.dispose=function(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=a.removeMaybe(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=a.disposeMaybe(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null},r._updateCanvasElementSize=function(e){this._canvas.setAttribute("width",e.size.width.toString()),this._canvas.setAttribute("height",e.size.height.toString())},r._resizeAtlas=function(e){this._atlas.resize(e),null!=this._glTexture&&this._glTexture.resize(this._atlas.size.width,e),this._updateCanvasElementSize(this._atlas)},r._resetAtlasCursor=function(){this._atlas.resetCursor(),this._needsClear=!0},r._addAtlasElement=function(e,t,s,r){const i=this._atlas,{renderedWidth:n,renderedHeight:a}=e.textRenderer;e.placement.offset.x=i.cursor.x,e.placement.offset.y=i.cursor.y,_.set(e.placement.uvMinMax,e.placement.offset.x/i.size.width,1-(e.placement.offset.y+a)/i.size.height,(e.placement.offset.x+n)/i.size.width,1-e.placement.offset.y/i.size.height),i.cursor.x+=s,i.lineHeight=Math.max(i.lineHeight,r),this._elements.set(t,e)},r._removeAtlasElement=function(e){if(e&&this._elements.has(e.textId)){const t=e.placement.offset;this._ctx.clearRect(t.x,t.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),this._elements.delete(e.textId)}},r._ensureStageObjects=function(e){const t=this._stageObjects.get(e);if(t)return t;const s=new Set;return this._stageObjects.set(e,s),s},r._addStageObject=function(e,t){this._ensureStageObjects(e).add(t)},r._removeStageObject=function(e,t){const s=this._stageObjects.get(e);s&&s.delete(t)&&(t.geometries[0].setAttributeData(f.VertexAttribute.SIZE,[0,0]),t.geometryVertexAttrsUpdated(t.geometries[0]))},r._processAddition=function(e,t){const s=this._atlas,r=e.textId,i=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,a=i+M,o=n+M+k;if(s.cursor.x+a<s.size.width&&s.cursor.y+o<s.size.height)this._addAtlasElement(e,r,a,o),this._elementsToRender.set(r,e),this._elementsToAddOrUpdate.delete(r);else{if(!(s.cursor.y+o+s.lineHeight<s.size.height)){const e=s.cursor.y+o+s.lineHeight-s.size.height,r=s.size.height+e<b;if(r){const t=Math.ceil(s.size.height*Math.max(1.3,(e+s.size.height)/s.size.height));this._resizeAtlas(Math.min(x.applyTextureResizeModulo(t),b))}return!t||!r&&s.size.height===b?(this._processRemovals(),w.OK):(this._repack(),w.REPACK)}s.cursor.x=M,s.cursor.y+=s.lineHeight,s.lineHeight=0,this._addAtlasElement(e,r,a,o),this._elementsToRender.set(r,e),this._elementsToAddOrUpdate.delete(r)}return w.OK},r._processRemovals=function(){this._elementsToRemove.forEach(((e,t)=>{const s=this._stageObjects.get(t);s&&0!==s.size||this._removeAtlasElement(e),s&&0===s.size&&this._stageObjects.delete(t)})),this._elementsToRemove.clear()},r._repack=function(){this._processRemovals(),this._elements.forEach(((e,t)=>{e.rendered=!1,this._elementsToAddOrUpdate.set(t,e)})),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()},r._processRenderingRequest=function(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);const t=this._stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].setAttributeData(f.VertexAttribute.UV0,e.placement.uvMinMax),t.geometries[0].setAttributeData(f.VertexAttribute.SIZE,[e.textRenderer.displayWidth,e.textRenderer.displayHeight]),t.geometryVertexAttrsUpdated(t.geometries[0])})),e.rendered=!0},r.runTask=function(e,t=!0){if(null==this._glTexture)return T.Task.YIELD;let s=!1;if(n.someMap(this._elementsToAddOrUpdate,((r,i)=>{const n=this._elements.get(i);if(n?.rendered){const t=this._stageObjects.get(i);return t&&t.forEach((e=>{const t=e.geometries[0],s=this._elements.get(i);t.setAttributeData(f.VertexAttribute.UV0,s.placement.uvMinMax),t.setAttributeData(f.VertexAttribute.SIZE,[s.textRenderer.displayWidth,s.textRenderer.displayHeight]),e.geometryVertexAttrsUpdated(e.geometries[0])})),this._elementsToAddOrUpdate.delete(i),e.madeProgress(),!1}return this._processAddition(this._elementsToAddOrUpdate.get(i),t)===w.REPACK&&(s=!0,!0)})),s)return this.runTask(T.noBudget,!1),void e.madeProgress();let r=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),n.someMap(this._elementsToRender,((t,s)=>(this._processRenderingRequest(t),this._elementsToRender.delete(s),r=!0,e.madeProgress(),e.done))),r&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&p.textTextureAtlas.orderedRepackingEnabled&&(this.repackOrdered(),e.madeProgress())},r.addTextTexture=function(e,t){const s=e.key;this._elementsToAddOrUpdate.has(s)||this._elementsToAddOrUpdate.set(s,new z(s,e)),this._addStageObject(s,t),this._elementsToRemove.delete(s),this.setDirty()},r.removeTextTexture=function(e,t){const s=e.key;this._elementsToRemove.set(s,this._elements.get(s)),this._removeStageObject(s,t)},r.setDirty=function(){this._glTexture&&(this.updating=!0)},r.repackOrdered=function(){if(0===this._elements.size)return;const e=[];this._elements.forEach(((t,s)=>e.push({element:t,key:s})));let t=!0;for(let s=0;s<e.length-1;s++)if(e[s].key.localeCompare(e[s+1].key)>0){t=!1;break}if(!t||this._elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this._elements.clear();for(const{element:t,key:s}of e)this._elements.set(s,t);this._repack(),this.setDirty()}},t._createClass(s,[{key:"requiresFrameUpdates",get:function(){return!1}},{key:"glTexture",get:function(){return this._glTexture}},{key:"running",get:function(){return this.updating}},{key:"test",get:function(){const{_elements:e,_stageObjects:t,_elementsToRemove:s,_atlas:r}=this,i=this;return{elements:e,stageObjects:t,elementsToRemove:s,atlas:r,resizeAtlas:e=>i._resizeAtlas(e),run:(e,t)=>i.runTask(e,t)}}}]),s}(r),s.__decorate([h.property({constructOnly:!0})],e.TextTextureAtlas.prototype,"view",void 0),s.__decorate([h.property({type:Boolean})],e.TextTextureAtlas.prototype,"updating",void 0),e.TextTextureAtlas=s.__decorate([u.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],e.TextTextureAtlas);const M=2,k=2;var w;!function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"}(w||(w={})),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
