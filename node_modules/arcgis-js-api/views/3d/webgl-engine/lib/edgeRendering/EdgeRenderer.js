/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/PooledArray","../../../../../chunks/mat3","../../../../../chunks/mat3f32","../../../../../chunks/vec3","../../../support/debugFlags","../../core/util/TwoVectorPosition","./EdgeShaderParameters","./EdgeShaderTechnique","./EdgeShaderTechniqueConfiguration","./interfaces","../../shaders/sources/edgeRenderer/EdgeUtil.glsl","../../../../webgl/enums"],(function(e,r,n,t,i,s,a,o,c,d,l,h,u,T,g){"use strict";const _=8,f=128,p={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},b={solid:T.EdgeUtilMode.SOLID,sketch:T.EdgeUtilMode.SKETCH,uber:T.EdgeUtilMode.MIXED};let y=function(){function e(r,n,i){this._rctx=r,this._shaderTechniqueRepository=n,this._configuration=new h.EdgeShaderTechniqueConfiguration,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[u.Transparency.TRANSPARENT]:{[u.Transparency.TRANSPARENT]:new t,[u.Transparency.OPAQUE]:new t},[u.Transparency.OPAQUE]:{[u.Transparency.TRANSPARENT]:new t,[u.Transparency.OPAQUE]:new t}},this._renderablesDirty=!1,this._drawParameters=new d.EdgeDrawParameters,this._settings={...p,...i},this.key=e.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:o.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=b[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=r.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}var s=e.prototype;return s.dispose=function(){this._technique=n.releaseMaybe(this._technique)},s.addRenderable=function(e){this._renderables.add(e),this._renderablesDirty=!0},s.removeRenderable=function(e){this._renderables.delete(e),this._renderablesDirty=!0},s.setRenderablesDirty=function(){this._renderablesDirty=!0},s.forEachRenderable=function(e,r){if(this._renderablesDirty&&this._sortRenderables(),r!==u.Transparency.INVISIBLE){const n=this._sortedRenderables[r];n[u.Transparency.TRANSPARENT].forAll(e),n[u.Transparency.OPAQUE].forAll(e)}},s.updateTechnique=function(e,r){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=r,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(l.EdgeShaderTechnique,this._configuration,this._technique),this._technique},s.bindRegularEdges=function(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!1),e,r)},s.bindSilhouetteEdges=function(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!0),e,r)},s.renderRegularEdges=function(e,r,n,t,i){this._render(e,r,r.regular.vao,n,t,i)},s.renderSilhouetteEdges=function(e,r,n,t,i){this._render(e,r,r.silhouette.vao,n,t,i)},s._render=function(e,r,n,t,i,s){s>0&&(this._bindDraw(e,r,t,i),this._rctx.bindVAO(n),this._rctx.capabilities.instancing.drawArraysInstanced(g.PrimitiveType.TRIANGLE_FAN,0,4,s))},s._bindDraw=function(e,r,n,t){if(this._drawParameters.componentDataTexture=r.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in r.transform)this._lastOriginId!==r.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",r.transform.origin.viewMatrix),this._lastOriginId=r.transform.origin.origin.id),e.setUniformMatrix4fv("model",r.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=r.transform.origin.origin.vec3;else{const e=new c.TwoVectorPosition(r.transform.position),n=i.transpose(E,i.invert(E,r.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=r.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=n;const s=t.camera.viewInverseTransposeMatrix;a.set(this._drawParameters.slicePlaneLocalOrigin,s[3],s[7],s[11])}e.bindDraw(this._drawParameters,t,n)},s._sortRenderables=function(){this._renderablesDirty=!1,this._sortedRenderables[u.Transparency.TRANSPARENT][u.Transparency.TRANSPARENT].clear(),this._sortedRenderables[u.Transparency.TRANSPARENT][u.Transparency.OPAQUE].clear(),this._sortedRenderables[u.Transparency.OPAQUE][u.Transparency.TRANSPARENT].clear(),this._sortedRenderables[u.Transparency.OPAQUE][u.Transparency.OPAQUE].clear(),this._renderables.forEach((e=>{e.objectTransparency!==u.Transparency.INVISIBLE&&e.edgeTransparency!==u.Transparency.INVISIBLE&&this._sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,r)=>"origin"in e.transform?"origin"in r.transform?e.transform.origin.origin.id<r.transform.origin.origin.id?-1:e.transform.origin.origin.id>r.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[u.Transparency.TRANSPARENT][u.Transparency.TRANSPARENT].sort(e),this._sortedRenderables[u.Transparency.TRANSPARENT][u.Transparency.OPAQUE].sort(e),this._sortedRenderables[u.Transparency.OPAQUE][u.Transparency.TRANSPARENT].sort(e),this._sortedRenderables[u.Transparency.OPAQUE][u.Transparency.OPAQUE].sort(e)},e.getKey=function(e,r,n){return`edges-t:${e}:${r}:${n}`},r._createClass(e)}();const E=s.create();e.EXTENSION_LENGTH_OFFSET=f,e.EdgeRenderer=y,e.LINE_WIDTH_FRACTION_FACTOR=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
