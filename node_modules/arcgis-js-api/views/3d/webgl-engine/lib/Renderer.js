/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Handles","../../../../core/has","../../../../core/maybe","../../../../core/PooledArray","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/boundedPlane","../../support/debugFlags","../../terrain/TerrainRenderer","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUDUniforms","./AnimationTimeStep","./basicInterfaces","./BoundingInfo","./depthRange","./depthRangeUtils","./glUtil3D","./Highlight","./Material","./OffscreenRendering","./RenderContext","./rendererUtils","./RenderFeature","./RenderPluginManager","./RenderSlot","./ShadowAccumulator","./ShadowHighlight","./ShadowMap","./SliceHelper","./SmaaRenderPass","./SSAOHelper","./TransparencyPassType","./edgeRendering/EdgeView","./edgeRendering/interfaces","../materials/renderers/MergedRenderer","../shaders/CompositingTechniqueConfiguration","../statistics/RendererPerformanceInfo","../../../support/RenderState","../../../webgl/enums"],(function(e,r,t,n,s,a,i,o,d,h,l,_,c,u,p,f,m,T,g,R,S,y,A,E,P,b,O,I,C,D,w,x,H,M,N,L,v,F,U,q,G,B,V,k,Q,W,j,Y,X){"use strict";var z,J;e.Renderer=function(t){r._inherits(l,t);var n=l.prototype;function l(e,r,n,s,i,o,l,_){var c;return(c=t.call(this,{})||this)._stage=e,c._materialRepository=r,c._techniqueRepository=s,c._rctx=i,c._compositingHelper=o,c._magnifierHelper=l,c._requestRender=_,c._materialRenderers=new d,c._needsTransparentPass=!1,c._hasHUDElements=!1,c._hasHighlights=!1,c._hasWater=!1,c._hasOverlayWater=!1,c._renderOverlay=e=>{},c._isRendering=!1,c._fallbackDepthStencilTexture=null,c._sliceHelper=new U,c._state=Y.RenderState.IDLE,c._renderStateFeatures=null,c._antialiasingEnabled=!0,c._highQualityTransparencyEnabled=!0,c._terrainRenderingEnabled=!0,c._terrainTransparency=T.TransparencyMode.Opaque,c._ssrEnabled=!1,c._ssaoEnabled=!1,c._hasAnimations=!1,c._animationTimestep=new y.AnimationTimeStep,c._handles=new a,c._renderHiddenTransparentEdges=()=>{},c._oitUsed=!1,c.updateRenderFeature(e.view.qualityProfile),c._smaaPass=new q.SmaaRenderPass(c._rctx,s),_(),c._offscreen=new D.OffscreenRendering(c._rctx,c._compositingHelper),c.performanceInfo=new j.RendererPerformanceInfo(c._rctx),c._shadowMap=new F.ShadowMap(c._rctx,e.viewingMode),c._ssaoHelper=new G.SSAOHelper(e.view,s,c._rctx,_),c._highlight=new I.Highlight(s,c._rctx),c._shadowHighlight=new v.ShadowHighlight(c._rctx,e.viewingMode),c._shadowAccumulator=new L.ShadowAccumulator(c._rctx,s,e,(e=>{const r=c.shadowsEnabled;c._shadowMap.enabled=!0,c._prepare(e.camera,e.contentCamera),c._renderPlugins.prepareRender(),c._shadowMap.enabled=r}),((e,r,t)=>{e.shadowMap.start(e.camera,r,t,!0,c._stage.view.qualitySettings.maximumPixelRatio),c._renderShadowCascades(R.ShaderOutput.Shadow,e.shadowMap),e.camera.setGLViewport(c._rctx),c._prepare(e.camera,e.contentCamera)}),_),c._renderContext=new w.RenderContext(c._rctx,c._offscreen,c._shadowMap,c._ssaoHelper,c._sliceHelper),c._renderPlugins=new M.RenderPluginManager({renderContext:c._renderContext,techniqueRepository:s,textureRepository:n,materialRepository:c._materialRepository,requestRender:_,controller:e}),c.renderPassManager=new g.RenderPassManager(c._rctx,c._techniqueRepository),c._renderPlugins.add(c.renderPassManager.slots(),c.renderPassManager),c._handles.add([h.watch((()=>c._stage.view.state.camera),(()=>_()),h.syncAndInitial),h.watch((()=>m.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{c._renderHiddenTransparentEdges=e?()=>c._renderEdges(k.Transparency.TRANSPARENT):()=>{},_()}),h.initial),h.watch((()=>c._ssaoEnabled||c.isFeatureEnabled(H.RenderFeature.SSAO)),(e=>c._ssaoHelper.enabled=e),h.syncAndInitial)]),c}return n.updateRenderFeature=function(e=null,r=!i("disable-feature:high-quality-idle")){this._renderStateFeatures=H.setupFeatureDefaults(r,e),this.notifyChange("_renderStateFeatures"),this._requestRender()},n.isFeatureEnabled=function(e,r=this._state){return this._renderStateFeatures?.get(r,e)??!1},n.setFeatureEnabled=function(e,r,t){this._renderStateFeatures?.set(r,e,t),this.notifyChange("_renderStateFeatures"),this._requestRender()},n.normalizeCtorArgs=function(){return{}},n.destroy=function(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=o.removeMaybe(this._gpuTimerHandle),this._materialRenderers.forAll((e=>e.dispose())),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=o.disposeMaybe(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.destroy(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=o.destroyMaybe(this._edgeView),this.renderPassManager.destroy(),E.BoundingInfo.prune()},n.disposeOffscreenBuffers=function(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()},n.ensureEdgeView=function(){if(null==this._edgeView){const e=this._stage.view.resourceController;this._edgeView=new V.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:re(e)}),this._handles.add(h.watch((()=>o.applySome(this._edgeView,(e=>e.updating))),(()=>this._requestRender()),h.sync)),this._requestRender()}return this._edgeView},n.setParameters=function(e){const{_shadowMap:r,_bindParameters:t}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.qualitySettings?.ambientOcclusion&&this._ssaoEnabled!==e.qualitySettings.ambientOcclusion&&(this._ssaoEnabled=e.qualitySettings.ambientOcclusion,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const r="virtual"!==e.environment.lighting.type;t.enableFillLights!==r&&(t.enableFillLights=r,this._requestRender())}e.background&&this._offscreen.background!==e.background&&(this._offscreen.background=e.background,this._requestRender()),void 0!==e.antialiasingEnabled&&this._antialiasingEnabled!==e.antialiasingEnabled&&(this._antialiasingEnabled=e.antialiasingEnabled,this._requestRender()),void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.renderOverlay&&this._renderOverlay!==e.renderOverlay&&(this._renderOverlay=e.renderOverlay,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainRenderingEnabled&&this._terrainRenderingEnabled!==e.terrainRenderingEnabled&&(this._terrainRenderingEnabled=e.terrainRenderingEnabled,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)},n.modify=function(e,r){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:n,updates:s}=e;if(0===t.length&&0===n.length&&0===s.length)return;const a=x.splitRenderGeometryChangeSetByMaterial(e);let i=!1;a.forEach(((t,n)=>{if(r.done)return;let s=this._materialRenderers.find((e=>e.material===n));null==s&&t.adds.length>0&&(s=new Q.MergedRenderer(this._rctx,this._materialRepository,n),this._materialRenderers.push(s)),s&&(s.modify(t),s.isEmpty&&(i=!0)),t.removes.forEach((r=>e.removes.removeUnordered(r))),t.adds.forEach((r=>e.adds.removeUnordered(r))),t.updates.forEach((r=>e.updates.removeUnordered(r))),r.madeProgress()})),i&&this._materialRenderers.filterInPlace((e=>!e.isEmpty||(e.dispose(),!1))),this._hasHighlights=this._materialRenderers.some((e=>e.hasHighlights)),this._bindParameters.hasOccludees=this._materialRenderers.some((e=>e.hasOccludees)),this._hasWater=this._materialRenderers.some((e=>e.hasWater)),this._hasHUDElements=this._materialRenderers.some((e=>e.requiresSlot(N.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,R.ShaderOutput.Color)||e.requiresSlot(N.RenderSlot.HUD_MATERIAL,R.ShaderOutput.Color)||e.requiresSlot(N.RenderSlot.LABEL_MATERIAL,R.ShaderOutput.Color))),this._requestRender()},n.updateAnimation=function(e){const r=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll((r=>this._hasAnimations=r.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?o.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations},n.resetAnimation=function(){this._animationTimestep.clear()},n.render=function(e,r,t,n,s){this._isRendering=!0,this._oitUsed=!1,this.performanceInfo.startFrame();const{camera:a,contentCamera:i,mode:o,alignPixelEnabled:d}=t;this._state=o,this._renderOverlay(s),this.performanceInfo.advance(j.PerformanceCategory.OVERLAY),this._renderContext.time=s,this._bindParameters.transparencyPassType=B.TransparencyPassType.NONE,this._bindParameters.alignPixelEnabled=d;const h=this._offscreen;h.setupRenderTarget(this.hasReflections);const l=f.create(this._sliceHelper.plane);n===A.Decorations.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),a.setGLViewport(this._rctx),this._prepare(a,i),this._renderPlugins.prepareRender(),this.performanceInfo.advance(j.PerformanceCategory.PREPARE);const _=this._computeDepthRange(a);this._renderShadowMap(e,a,this._bindParameters.lighting.mainLight.direction,_),this.performanceInfo.advance(j.PerformanceCategory.SHADOW_MAP),h.initializeFrame(a),this._ensureBindParameters(a,i);const c=this._terrainRenderingEnabled&&(this._terrainTransparency===T.TransparencyMode.Semitransparent||this._terrainTransparency===T.TransparencyMode.TransparentWithDraped),u=this._highQualityTransparency&&c,p=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;this._prepareShaders(u,p),this._renderLinearDepth(),this.performanceInfo.advance(j.PerformanceCategory.LINEAR_DEPTH),this._accumulateShadows(_,a,i),this.performanceInfo.advance(j.PerformanceCategory.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(j.PerformanceCategory.NORMALS),this._ensureBindParametersSSR(s),this._renderSSAO(s),this.performanceInfo.advance(j.PerformanceCategory.SSAO),this._renderContext.output=R.ShaderOutput.Color,h.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(j.PerformanceCategory.OPAQUE),this._renderTerrainLinearDepth(u),this._setMultipassTerrain(u),this._renderEdges(k.Transparency.OPAQUE),this.performanceInfo.advance(j.PerformanceCategory.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(N.RenderSlot.VOXEL),this.performanceInfo.advance(j.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges(),p&&(this._oitEnabled?this._renderOITPass(z.Geometry):this._renderTransparentGeometry()),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT),this._renderGeometryLinearDepth(u);const m=this._renderHUDVisibility(u);u||this._renderInternalSlot(N.RenderSlot.LINE_CALLOUTS),this.performanceInfo.advance(j.PerformanceCategory.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(r),this.performanceInfo.advance(j.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(k.Transparency.TRANSPARENT,u),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT_EDGES),this._renderTransparentTerrain(),c&&m&&(u?this._renderLineCallouts(S.HUDTransparencyRenderStyle.Occluded):h.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(S.HUDTransparencyRenderStyle.Occluded,h.framebuffer),this.performanceInfo.advance(j.PerformanceCategory.HUD_OCCLUDED)),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),c&&(h.compositeTransparentTerrainOntoMain(this._bindParameters),u&&(this._renderEdges(k.Transparency.OPAQUE),this.performanceInfo.advance(j.PerformanceCategory.OPAQUE_EDGES),p&&(this._oitEnabled?this._renderOITPass(z.Geometry):this._renderTransparentGeometry()),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT),this._renderEdges(k.Transparency.TRANSPARENT),this.performanceInfo.advance(j.PerformanceCategory.TRANSPARENT_EDGES))),u&&this._renderLineCallouts(S.HUDTransparencyRenderStyle.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),h.renderToTargets((()=>{this._renderInternalSlot(N.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(N.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(N.RenderSlot.LASERLINES)}),h.currentColorTarget,h.mainDepth),this.performanceInfo.advance(j.PerformanceCategory.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&h.renderTmpAndCompositeToMain((()=>this._renderSlot(N.RenderSlot.LASERLINES_CONTRAST_CONTROL)),this._bindParameters,W.AlphaMode.PremultipliedAlpha),this.performanceInfo.advance(j.PerformanceCategory.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(j.PerformanceCategory.OCCLUDED);const g=n===A.Decorations.ON&&this._magnifierHelper.enabled,y=g&&null==e?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):e;this._rctx.bindFramebuffer(y);const E=this._offscreen.colorTexture;this._renderAntiAliasing(E)||null==E||this._compositingHelper.composite(this._bindParameters,E,W.AlphaMode.None),this.performanceInfo.advance(j.PerformanceCategory.ANTIALIASING),this._renderHUD(S.HUDTransparencyRenderStyle.NotOccluded,y),this.performanceInfo.advance(j.PerformanceCategory.HUD),this._renderHighlights(y,this._bindParameters),this.performanceInfo.advance(j.PerformanceCategory.HIGHLIGHTS),g&&this._magnifierHelper.render(this._rctx,this._bindParameters),y!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,W.AlphaMode.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=l,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()},n._prepareShaders=function(e,r){this._renderContext.output=R.ShaderOutput.Color,this._prepareOpaqueGeometrySlots(),this._setMultipassTerrain(e),this._prepareSlots(N.RenderSlot.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._prepareInternalSlots(this._materialRenderers,N.RenderSlot.LINE_CALLOUTS),r&&this._prepareTransparencySlots(),this._prepareInternalSlots(this._materialRenderers,N.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._prepareSlots(N.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT,N.RenderSlot.LASERLINES),this._rctx.gl.flush()},n._renderObjectAndLayerIdColor=function(e){if(null!=e&&i("enable-feature:objectAndLayerId-rendering")){const r=this._renderContext.output;this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((()=>this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.ObjectAndLayerIdColor)),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((()=>{this._bindParameters.renderTransparentlyOccludedHUD=S.HUDTransparencyRenderStyle.NotOccluded,this._renderInternalSlot(N.RenderSlot.HUD_MATERIAL)}),void 0,!0,!0),this._renderContext.output=r}},n.finish=function(e){this._hasAnimations||this._animationTimestep.clear();const r=this.performanceInfo.gpuSamplingEnabled,t=e===A.RenderRequestType.BACKGROUND;if(t||r){const e=t?this.performanceInfo.elapsedTime:0,n=r?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),s=Math.max(e,n);this._animationTimestep.frame(s,t)}},n.readDepthPixels=function(e,r,t){const n=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=X.ClearBufferBit.COLOR_BUFFER_BIT|X.ClearBufferBit.DEPTH_BUFFER_BIT|X.ClearBufferBit.STENCIL_BUFFER_BIT;this._rctx.clearSafe(r),this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Depth)}n.readPixels(r[0],r[1],r[2],r[3],X.PixelFormat.RGBA,X.PixelType.UNSIGNED_BYTE,t)},n.readHUDVisibility=function(e,r,t,n,s){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(e,r,t,n,X.PixelFormat.RGBA,X.PixelType.UNSIGNED_BYTE,s)},n.readAccumulatedShadow=function(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])},n._setMultipassTerrain=function(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)},n._setMultipassEnabled=function(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e},n._setTerrainCulling=function(e){this._bindParameters.multipassTerrain.cullAboveGround=e},n._prepareSlots=function(...e){this._renderPlugins.prepareSlots(e)},n._renderSlot=function(e){this._bindParameters.slot=e,this._renderPlugins.render()},n._renderEdges=function(e,r=!1){const t=this._edgeView;null!=t&&t.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),this._bindParameters,W.AlphaMode.Alpha,r)},n._renderShadowMap=function(e,r,t,n){const s=this._shadowMap;s.enabled&&(s.start(r,t,n,this.isFeatureEnabled(H.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(r,t),this._needsShadowHighlight?(this._renderShadowCascades(R.ShaderOutput.ShadowHighlight,this._shadowMap,(e=>s.takeCascadeSnapshotTo(e,F.SnapshotSlot.Highlight))),s.clear(),this._renderShadowCascades(R.ShaderOutput.ShadowExcludeHighlight,this._shadowMap,(e=>{s.takeCascadeSnapshotTo(e,F.SnapshotSlot.Default),this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.ShadowHighlight)}))):this._renderShadowCascades(R.ShaderOutput.Shadow),s.finish(e),r.setGLViewport(this._rctx))},n._renderShadowCascades=function(e,r=this._shadowMap,t=(e=>{})){for(const n of r.cascades)n.camera.setGLViewport(this._rctx),this._prepare(n.camera,n.camera),this._renderGeometryAndTransparentTerrainPass(e),t(n)},n._renderLinearDepth=function(){this._needsLinearDepth?this._offscreen.renderToTargets((()=>this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Depth)),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture},n._renderTerrainLinearDepth=function(e){if(e){const e=this._renderContext.output;this._renderContext.output=R.ShaderOutput.Depth,this._offscreen.renderToTargets((()=>this._renderTransparentTerrain()),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture},n._renderGeometryLinearDepth=function(e){if(e){const e=this._renderContext.output;this._offscreen.renderToTargets((()=>this._renderGeometryPass(R.ShaderOutput.Depth)),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture},n._renderNormal=function(){this._needsNormal?this._offscreen.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Normal)}),this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)},n._computeDepthRange=function(e){if(!this._needsDepthRange)return P.ZERO;const r=b.depthRangeFromScene(e,this._materialRenderers,this._stage.layers);return P.union(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r},n._renderGeometryAndTransparentTerrainPass=function(e){this._renderContext.output=e,this._prepareSlots(N.RenderSlot.TRANSPARENT_TERRAIN),this._renderGeometryPass(e),this._renderTransparentTerrain()},n._renderGeometryPass=function(e){this._renderContext.output=e,this._prepareSlots(N.RenderSlot.TRANSPARENT_MATERIAL),this._renderOpaqueGeometry(),this._renderTransparentGeometry()},n._renderSSAO=function(e){this._ssaoHelper.render(this._bindParameters,e,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)},n._prepareOpaqueGeometrySlots=function(){this._prepareSlots(N.RenderSlot.INTEGRATED_MESH,N.RenderSlot.OPAQUE_TERRAIN,N.RenderSlot.OPAQUE_MATERIAL,N.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE),this._prepareInternalSlots(this._materialRenderers,N.RenderSlot.OPAQUE_MATERIAL)},n._renderOpaqueGeometry=function(){this._renderSlot(N.RenderSlot.INTEGRATED_MESH),this._renderSlot(N.RenderSlot.OPAQUE_TERRAIN),this._renderInternalSlot(N.RenderSlot.OPAQUE_MATERIAL),this._renderSlot(N.RenderSlot.OPAQUE_MATERIAL),this._renderSlot(N.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)},n._renderTransparentGeometry=function(){this._renderInternalSlot(N.RenderSlot.TRANSPARENT_MATERIAL),this._renderSlot(N.RenderSlot.TRANSPARENT_MATERIAL)},n._renderTransparentTerrain=function(){this._renderSlot(N.RenderSlot.TRANSPARENT_TERRAIN)},n._renderHUDVisibility=function(e){let r=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,r=this._renderInternalSlot(N.RenderSlot.OCCLUSION_PIXELS)}),e),r},n._renderLineCallouts=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===S.HUDTransparencyRenderStyle.Occluded?this._offscreen.renderToTargets((()=>this._renderInternalSlot(N.RenderSlot.LINE_CALLOUTS)),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(N.RenderSlot.LINE_CALLOUTS)},n._renderHUD=function(e,r){this._hasHUDElements&&(this._oitEnabled?(this._renderOITPass(z.HUD,e),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,W.AlphaMode.PremultipliedAlpha)):e===S.HUDTransparencyRenderStyle.Occluded?this._offscreen.renderToTargets((()=>this._renderHUDElements(S.HUDTransparencyRenderStyle.Occluded)),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))},n._renderHUDElements=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._prepareInternalSlots(this._materialRenderers,N.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,N.RenderSlot.HUD_MATERIAL,N.RenderSlot.LABEL_MATERIAL),this._renderInternalSlot(N.RenderSlot.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(N.RenderSlot.HUD_MATERIAL),this._renderInternalSlot(N.RenderSlot.LABEL_MATERIAL)},n._renderHighlights=function(e,r){if(!this._needsHighlight)return void this._offscreen.disposeTarget(this._offscreen.highlight);const t=this._highlight,n=this._offscreen.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(R.ShaderOutput.Highlight),this._rctx.clearSafe(X.ClearBufferBit.DEPTH_BUFFER_BIT),this._renderHUDElements(S.HUDTransparencyRenderStyle.Both)}),this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=n.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(r,e),t.render(this._bindParameters,n,e)},n._accumulateShadows=function(e,r,t){this._needsShadowCast&&null!=this._offscreen.linearDepthTexture&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,e,r,t)},n._prepareTransparencySlots=function(){this._renderContext.output=R.ShaderOutput.Alpha,this._bindParameters.transparencyPassType=B.TransparencyPassType.Alpha,this._prepareInternalSlots(this._materialRenderers,N.RenderSlot.TRANSPARENT_MATERIAL),this._prepareSlots(N.RenderSlot.TRANSPARENT_MATERIAL),this._renderContext.output=R.ShaderOutput.Color,this._bindParameters.transparencyPassType=B.TransparencyPassType.Color,this._prepareInternalSlots(this._materialRenderers,N.RenderSlot.TRANSPARENT_MATERIAL),this._prepareSlots(N.RenderSlot.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=B.TransparencyPassType.FrontFace,this._prepareInternalSlots(this._materialRenderers,N.RenderSlot.TRANSPARENT_MATERIAL),this._prepareSlots(N.RenderSlot.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=B.TransparencyPassType.NONE},n._renderOITPass=function(e,r=S.HUDTransparencyRenderStyle.Both){const t=e===z.HUD,n=t?()=>this._renderHUDElements(r):()=>this._renderTransparentGeometry(),s=e=>{this._bindParameters.transparencyPassType=e,this._offscreen.renderOITPass(n,e,t)},a=this._renderContext.output;this._renderContext.output=R.ShaderOutput.Alpha,s(B.TransparencyPassType.Alpha),this._renderContext.output=R.ShaderOutput.Color,s(B.TransparencyPassType.Color),s(B.TransparencyPassType.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,t),this._bindParameters.transparencyPassType=B.TransparencyPassType.NONE,this._renderContext.output=a,this._oitUsed=!0},n._disposeOITBuffers=function(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget))},n._renderOccluded=function(){let e=0;K.clear(),this._materialRenderers.forAll((r=>{r.material&&r.material.isVisible()&&r.material.renderOccluded===C.RenderOccludedFlag.OccludeAndTransparentStencil&&(e|=r.material.renderOccluded,K.push(r))}));const r=this._offscreen,t=(t,n,s,a,i)=>{0!=(e&n)&&(r.renderToTargets(s,r.tmpColor,r.mainDepth,[0,0,0,0],a,i),r.compositeOccludedOntoMain(this._bindParameters,t))};0!==K.length&&(this._prepareInternalSlots(K,N.RenderSlot.OCCLUDER_MATERIAL,N.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL),this._renderInternalSlot(N.RenderSlot.OCCLUDER_MATERIAL,K),t(.5,C.RenderOccludedFlag.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(N.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,K)),!1,!1)),K.clear(),this._materialRenderers.forAll((r=>{r.material&&r.material.isVisible()&&(r.material.renderOccluded===C.RenderOccludedFlag.OccludeAndTransparent||r.material.renderOccluded===C.RenderOccludedFlag.Transparent||r.material.renderOccluded===C.RenderOccludedFlag.Opaque)&&(e|=r.material.renderOccluded,K.push(r))}));const n=this._renderPlugins.renderOccludedFlags;if(e|=n,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,this._prepareInternalSlots(K,N.RenderSlot.OPAQUE_MATERIAL,N.RenderSlot.TRANSPARENT_MATERIAL,N.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),n>C.RenderOccludedFlag.Occlude&&this._renderSlot(N.RenderSlot.OCCLUDED_TERRAIN),this._renderInternalSlot(N.RenderSlot.OPAQUE_MATERIAL,K),this._renderInternalSlot(N.RenderSlot.TRANSPARENT_MATERIAL,K),this._renderInternalSlot(N.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,K),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=R.ShaderOutput.Color,t(.5,C.RenderOccludedFlag.OccludeAndTransparent,(()=>s(C.RenderOccludedFlag.OccludeAndTransparent)),!0,A.StencilBits.OutlineVisualElementMask),t(.5,C.RenderOccludedFlag.Transparent,(()=>s(C.RenderOccludedFlag.Transparent)),!0,A.StencilBits.OutlineVisualElementMask),t(1,C.RenderOccludedFlag.Opaque,(()=>s(C.RenderOccludedFlag.Opaque)),!0,A.StencilBits.OutlineVisualElementMask),K.clear()},n._renderAntiAliasing=function(e){if(this._antialiasing){if(this._smaaPass.enable((()=>this._requestRender()))&&null!=e)return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1},n._prepare=function(e,r){this._needsTransparentPass=this._materialRenderers.some((e=>e.requiresSlot(N.RenderSlot.TRANSPARENT_MATERIAL,R.ShaderOutput.Color))),this._bindParameters.camera=e,this._bindParameters.contentCamera=r},n._ensureBindParameters=function(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r;const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.mainColorTexture=t.mainColorTexture,this._bindParameters.highlightDepthTexture=t.depthTexture??this._getFallbackDepthTexture()},n._ensureBindParametersSSR=function(e){if(this._bindParameters.ssr.enabled=this.hasReflections,this._bindParameters.ssr.enabled){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=p.IDENTITY:(u.invert($,this._bindParameters.camera.viewMatrix),u.invert(Z,this._bindParameters.camera.projectionMatrix),u.multiply(ee,$,Z),u.multiply(ee,this._renderContext.lastFrameCamera.viewMatrix,ee),u.multiply(ee,this._renderContext.lastFrameCamera.projectionMatrix,ee),this._reprojectionMatrix=ee),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const r=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=r>0?Math.min(r,e-this._ssrEnableTime)/r:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=p.IDENTITY,this._bindParameters.ssr.lastFrameColorTexture=null,this._ssrEnableTime=null},n._prepareInternalSlots=function(e,...r){for(const t of r)this._bindParameters.slot=t,e.forAll((e=>{e.material.shouldRender(this._renderContext)&&e.prepareTechnique(this._renderContext)}))},n._renderInternalSlot=function(e,r=this._materialRenderers){let t=!1;return this._bindParameters.slot=e,r.forAll((e=>{if(e.material.shouldRender(this._renderContext)){const r=e.prepareTechnique(this._renderContext);null!=r&&(e.render(this._renderContext,r),t=!0)}})),t},n._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=O.createEmptyDepthTexture(this._rctx)),this._fallbackDepthStencilTexture},r._createClass(l,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"_antialiasing",get:function(){return this._antialiasingEnabled||this.isFeatureEnabled(H.RenderFeature.Antialiasing)}},{key:"_highQualityTransparency",get:function(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(H.RenderFeature.HighQualityTransparency)}},{key:"hasReflections",get:function(){return this.hasWater&&(this._ssrEnabled||this.isFeatureEnabled(H.RenderFeature.WaterReflection))}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"updating",get:function(){return this._antialiasing&&this._smaaPass.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._renderPlugins.updating||!this.isCameraFinal}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return u.equals(this._bindParameters.ssr.reprojectionMatrix,p.IDENTITY)}},{key:"_reprojectionMatrix",set:function(e){s.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",get:function(){return!!this._shadowMap?.enabled}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlend.result}},{key:"_oitEnabled",get:function(){return this._highQualityTransparency&&this._hasOITSupport}},{key:"animationTimestep",get:function(){return this._animationTimestep.value}},{key:"animationTimeDilation",get:function(){return this._animationTimestep.timeDilation}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast}},{key:"_needsNormal",get:function(){return this._ssaoHelper.active}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||this._needsShadowCast}},{key:"_needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){return{offscreen:this._offscreen?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}},{key:"test",get:function(){const r=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{r._renderStateFeatures=H.setupFeatureDefaults()},getFramebufferTexture:t=>{switch(t){case e.FramebufferId.Color:return r._offscreen.colorTexture;case e.FramebufferId.LinearDepth:return r._offscreen.linearDepthTexture;case e.FramebufferId.Normals:return r._offscreen.normalTexture;case e.FramebufferId.ShadowMap:return r._shadowMap.depthTexture;case e.FramebufferId.HudVisibility:return r._offscreen.hudVisibilityTexture;case e.FramebufferId.Highlight:return r._offscreen.highlightTexture}}}}}]),l}(n),t.__decorate([l.property()],e.Renderer.prototype,"_renderPlugins",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_shadowAccumulator",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_state",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_renderStateFeatures",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_antialiasingEnabled",void 0),t.__decorate([l.property({readOnly:!0})],e.Renderer.prototype,"_antialiasing",null),t.__decorate([l.property()],e.Renderer.prototype,"_ssaoEnabled",void 0),t.__decorate([l.property()],e.Renderer.prototype,"_smaaPass",void 0),t.__decorate([l.property({autoDestroy:!0})],e.Renderer.prototype,"_edgeView",void 0),t.__decorate([l.property()],e.Renderer.prototype,"updating",null),t.__decorate([l.property()],e.Renderer.prototype,"isCameraFinal",null),e.Renderer=t.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.Renderer")],e.Renderer),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(z||(z={})),e.FramebufferId=void 0,(J=e.FramebufferId||(e.FramebufferId={}))[J.Color=0]="Color",J[J.LinearDepth=1]="LinearDepth",J[J.Normals=2]="Normals",J[J.ShadowMap=3]="ShadowMap",J[J.HudVisibility=4]="HudVisibility",J[J.Highlight=5]="Highlight";const K=new d,Z=p.create(),$=p.create(),ee=p.create();function re(e){return r=>e.immediate.schedule(r)}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
