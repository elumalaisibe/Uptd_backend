/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/time","../../../../chunks/vec2","./glUtil3D","./SSAOBlurTechnique","./SSAONoiseData","./SSAOTechnique","../../../../chunks/SSAO.glsl","../shaders/SSAOParameters","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/TextureDescriptor","../../../webgl/Util"],(function(e,s,t,r,i,a,n,u,h,o,l,_,c,b,d,m){"use strict";const p=2;let T=function(){function e(e,s,t,r){this._view=e,this._techniqueRepository=s,this._rctx=t,this._requestRender=r,this._quadVAO=null,this._passParameters=new l.SSAOPassParameters,this._drawParameters=new l.BlurDrawParameters}var T=e.prototype;return T.dispose=function(){this.enabled=!1,this._quadVAO=t.disposeMaybe(this._quadVAO)},T.destroy=function(){this.dispose()},T.disposeOffscreenBuffers=function(){this._ssaoFBO?.resize(0,0),this._blurFBO?.resize(0,0)},T.render=function(e,s,t,r){if(null==this._enableTime||null==t||null==r||null==this._ssaoFBO||null==this._blurFBO)return;if(!this.active)return this._enableTime=s,void this._requestRender();0===this._enableTime&&(this._enableTime=s);const n=this._rctx,u=e.camera,h=this._view.qualitySettings.fadeDuration,l=h>0?Math.min(h,s-this._enableTime)/h:1;this._passParameters.normalTexture=r,this._passParameters.depthTexture=t,this._passParameters.projScale=1/u.computeRenderPixelSizeAtDist(1),this._passParameters.intensity=4*O/o.getRadius(u)**6*l;const c=u.fullViewport,b=c[2],d=c[3],T=b/p,f=d/p;this._ssaoFBO.resize(b,d),this._blurFBO.resize(T,f),null==this._quadVAO&&(this._quadVAO=a.createQuadVAO(this._rctx)),n.bindFramebuffer(this._ssaoFBO),n.setViewport(0,0,b,d);n.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),n.bindVAO(this._quadVAO);const w=m.vertexCount(this._quadVAO,"geometry");n.drawArrays(_.PrimitiveType.TRIANGLE_STRIP,0,w);const P=n.bindTechnique(this._blurTechnique,this._passParameters,e);n.setViewport(0,0,T,f),n.bindFramebuffer(this._blurFBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,i.set(this._drawParameters.blurSize,0,p/d),P.bindDraw(this._drawParameters,e,this._passParameters),n.setViewport(0,0,T,f),n.drawArrays(_.PrimitiveType.TRIANGLE_STRIP,0,w),n.bindFramebuffer(this._ssaoFBO),n.setViewport(0,0,b,d),n.setClearColor(1,1,1,0),n.clear(_.ClearBufferBit.COLOR_BUFFER_BIT),n.setViewport(0,0,T,f),this._drawParameters.colorTexture=this._blurFBO.colorTexture,i.set(this._drawParameters.blurSize,p/b,0),P.bindDraw(this._drawParameters,e,this._passParameters),n.drawArrays(_.PrimitiveType.TRIANGLE_STRIP,0,w),n.setViewport(c[0],c[1],c[2],c[3]),l<1&&this._requestRender()},T._enable=function(){if(null!=this._enableTime)return;const e=new d.TextureDescriptor;e.wrapMode=_.TextureWrapMode.CLAMP_TO_EDGE,this._ssaoFBO=new c.FramebufferObject(this._rctx,e),this._blurFBO=new c.FramebufferObject(this._rctx,e);const s=Uint8Array.from(atob(u.noiseData),(e=>e.charCodeAt(0)));e.pixelFormat=_.PixelFormat.RGB,e.wrapMode=_.TextureWrapMode.REPEAT,e.hasMipmap=!0,e.width=32,e.height=32,this._passParameters.noiseTexture=new b.Texture(this._rctx,e,s),null==this._ssaoTechnique&&(this._ssaoTechnique=this._techniqueRepository.acquire(h.SSAOTechnique)),null==this._blurTechnique&&(this._blurTechnique=this._techniqueRepository.acquire(n.SSAOBlurTechnique)),this._enableTime=r.Milliseconds(0),this._requestRender()},T._disable=function(){this._enableTime=null,this._passParameters.noiseTexture=t.disposeMaybe(this._passParameters.noiseTexture),this._blurFBO=t.disposeMaybe(this._blurFBO),this._ssaoFBO=t.disposeMaybe(this._ssaoFBO)},s._createClass(e,[{key:"enabled",get:function(){return null!=this._enableTime},set:function(e){e?this._enable():this._disable()}},{key:"active",get:function(){return this.enabled&&this._ssaoTechnique.compiled&&this._blurTechnique.compiled}},{key:"colorTexture",get:function(){return this._ssaoFBO?.colorTexture}},{key:"gpuMemoryUsage",get:function(){return(this._blurFBO?.gpuMemoryUsage??0)+(this._ssaoFBO?.gpuMemoryUsage??0)}}]),e}();const O=.5;e.SSAOHelper=T,e.blurSizePixels=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
