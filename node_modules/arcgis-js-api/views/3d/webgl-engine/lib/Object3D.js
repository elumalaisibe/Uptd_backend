/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../chunks/sphere","../../support/mathUtils","./basicInterfaces","./ContentObject","./ContentObjectType","./Object3DStateID","./Util","../materials/renderers/utils"],(function(t,e,i,n,o,a,s,r,c,h,m,l,u,d){"use strict";let f=function(t){e._inherits(s,t);var a=s.prototype;function s(e={}){var i;return(i=t.call(this)||this).type=m.ContentObjectType.Object,i._hasVolatileTransformation=!1,i._parentLayer=null,i._visible=!0,i.castShadow=e.castShadow??!0,i.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,i.graphicUid=e.graphicUid,i.layerUid=e.layerUid,e.isElevationSource&&(i.lastValidElevationBB=new b),i._geometries=e.geometries?Array.from(e.geometries):new Array,i}return a.clearShaderTransformation=function(){this._shaderTransformation=void 0,this._invalidateBoundingVolume(),this._emit("objectShaderTransformation",this)},a.dispose=function(){this._geometries.length=0},a.addGeometry=function(t){t.visible=this._visible,this._geometries.push(t),this._hasVolatileTransformation=this._hasVolatileTransformation||t.hasVolatileTransformation,this._emit("objectGeometryAdded",{object:this,geometry:t}),this._invalidateBoundingVolume()},a.removeGeometry=function(t){const e=this._geometries.splice(t,1)[0];e&&(this._emit("objectGeometryRemoved",{object:this,geometry:e}),this._invalidateBoundingVolume())},a.removeAllGeometries=function(){for(;this._geometries.length>0;)this.removeGeometry(0)},a.geometryVertexAttrsUpdated=function(t){this._emit("objectGeometryUpdated",{object:this,geometry:t}),this._invalidateBoundingVolume()},a.maskOccludee=function(){const t=new l.Object3DStateID(c.Object3DState.MaskOccludee);for(const e of this._geometries)e.occludees=d.addObject3DStateID(e.occludees,t);return this._emit("occlusionChanged",this),t},a.removeOcclude=function(t){for(const e of this._geometries)e.occludees=d.removeObject3DStateID(e.occludees,t);this._emit("occlusionChanged",this)},a.highlight=function(){const t=new l.Object3DStateID(c.Object3DState.Highlight);for(const e of this._geometries)e.highlights=d.addObject3DStateID(e.highlights,t);return this._emit("highlightChanged",this),t},a.removeHighlight=function(t){for(const e of this._geometries)e.highlights=d.removeObject3DStateID(e.highlights,t);this._emit("highlightChanged",this)},a.getCombinedStaticTransformation=function(t,e){return i.multiply(e,this.transformation,t.transformation)},a.getCombinedShaderTransformation=function(t,e=n.create()){return i.multiply(e,this.shaderTransformation,t.shaderTransformation)},a.hasVolativeTransformation=function(){return this._hasVolatileTransformation},a._validateBoundingVolume=function(t,e){const i=e===j.ObjectSpace;for(const n of this._geometries){const e=n.boundingInfo;e&&g(e,t,i?n.shaderTransformation:this.getCombinedShaderTransformation(n))}o.lerp(t.bounds,t.min,t.max,.5);for(const n of this._geometries){const e=n.boundingInfo;if(null==e)continue;const a=i?n.shaderTransformation:this.getCombinedShaderTransformation(n),s=r.maxScale(a);o.transformMat4(S,e.center,a);const c=o.distance(S,t.bounds),h=e.radius*s;t.bounds[3]=Math.max(t.bounds[3],c+h)}},a._invalidateBoundingVolume=function(){const t=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&t&&this._parentLayer.notifyObjectBBChanged(this,t)},a._emit=function(t,e){this._parentLayer&&this._parentLayer.events.emit(t,e)},e._createClass(s,[{key:"geometries",get:function(){return this._geometries}},{key:"transformation",get:function(){return this._transformation??n.IDENTITY},set:function(t){this._transformation=i.copy(this._transformation??n.create(),t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}},{key:"shaderTransformation",get:function(){return this._shaderTransformation??this.transformation},set:function(t){this._shaderTransformation=i.copy(this._shaderTransformation??n.create(),t),this._invalidateBoundingVolume(),this._emit("objectShaderTransformation",this)}},{key:"parentLayer",get:function(){return this._parentLayer},set:function(t){u.assert(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t}},{key:"visible",get:function(){return this._visible},set:function(t){if(this._visible!==t){this._visible=t;for(const t of this._geometries)t.visible=this._visible;this._emit("visibilityChanged",this)}}},{key:"boundingVolumeWorldSpace",get:function(){return this._bvWorldSpace&&!this._hasVolatileTransformation||(this._bvWorldSpace=this._bvWorldSpace||new _,this._validateBoundingVolume(this._bvWorldSpace,j.WorldSpace)),this._bvWorldSpace}},{key:"boundingVolumeObjectSpace",get:function(){return this._bvObjectSpace&&!this._hasVolatileTransformation||(this._bvObjectSpace=this._bvObjectSpace||new _,this._validateBoundingVolume(this._bvObjectSpace,j.ObjectSpace)),this._bvObjectSpace}},{key:"test",get:function(){const t=this;return{hasGeometry:e=>t._geometries.includes(e),getGeometryIndex:e=>t._geometries.indexOf(e)}}}]),s}(h.ContentObject),b=function(){function t(){this.min=a.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=a.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return t.prototype.isEmpty=function(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]},e._createClass(t)}(),_=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).bounds=s.create(),e}return e._inherits(i,t),e._createClass(i)}(b);function g(t,e,n){const a=t.bbMin,s=t.bbMax;if(i.hasIdentityRotation(n)){const t=o.set(p,n[12],n[13],n[14]);o.add(v,a,t),o.add(y,s,t);for(let i=0;i<3;++i)e.min[i]=Math.min(e.min[i],v[i]),e.max[i]=Math.max(e.max[i],y[i])}else if(o.transformMat4(v,a,n),o.exactEquals(a,s))for(let i=0;i<3;++i)e.min[i]=Math.min(e.min[i],v[i]),e.max[i]=Math.max(e.max[i],v[i]);else{o.transformMat4(y,s,n);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],v[t],y[t]),e.max[t]=Math.max(e.max[t],v[t],y[t]);for(let t=0;t<3;++t){o.copy(v,a),o.copy(y,s),v[t]=s[t],y[t]=a[t],o.transformMat4(v,v,n),o.transformMat4(y,y,n);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],v[t],y[t]),e.max[t]=Math.max(e.max[t],v[t],y[t])}}}const p=a.create(),v=a.create(),y=a.create(),S=a.create();var j;!function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ObjectSpace=1]="ObjectSpace"}(j||(j={})),t.Object3D=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
