/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/mat3","../../../../../chunks/mat3f64","../../../../../chunks/mat4","../../../../../chunks/vec3","../../../../../chunks/vec3f64","./AllRenderPasses","./RenderPass","../shaderLibrary/ShaderOutput","../util/TwoVectorPosition","../../lib/depthRange","../../lib/RenderSlot"],(function(e,t,s,a,r,i,n,h,o,u,d,l,c){"use strict";let p=function(){function e(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParameters=new h.MaterialPassParameters,this._shadowPassParameters=new h.ShadowMapPassParameters,this._highlightPassParameters=new h.HighlightPassParameters,this._systems=new Set,this._passes={materialOpaque:new o.RenderPass(e,t),materialTransparent:new o.RenderPass(e,t,o.RenderPassSorting.BackToFront),materialIntegratedMesh:new o.RenderPass(e,t),shadowMap:new o.RenderPass(e,t),highlight:new o.RenderPass(e,t),highlightIntegratedMesh:new o.RenderPass(e,t),highlightShadowMap:new o.RenderPass(e,t),defaultShadowMap:new o.RenderPass(e,t)}}var a=e.prototype;return a.destroy=function(){this._context=null,this._systems.clear()},a.register=function(e){this._systems.add(e)},a.prepareRender=function(e){if(0!==this._systems.size){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,e.bindParameters)));for(const e of Object.values(this._passes))e.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}},a.prepareTechniques=function(e){return 0===this._systems.size?null:(this._configure(e),this._materialPassParameters.output=e.output,this._invoke(e,((t,s)=>t.prepare(s,e.bindParameters))))},a.render=function(e,t){this._invoke(e,((s,a)=>s.dispatch(a,e.bindParameters,t)))},a._invoke=function(e,t){switch(e.bindParameters.slot){case c.RenderSlot.OPAQUE_MATERIAL:switch(e.output){case u.ShaderOutput.Color:case u.ShaderOutput.Depth:case u.ShaderOutput.Normal:case u.ShaderOutput.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case u.ShaderOutput.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case u.ShaderOutput.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case u.ShaderOutput.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case u.ShaderOutput.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters)}break;case c.RenderSlot.TRANSPARENT_MATERIAL:switch(e.output){case u.ShaderOutput.Color:case u.ShaderOutput.Alpha:case u.ShaderOutput.Depth:case u.ShaderOutput.Normal:case u.ShaderOutput.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case c.RenderSlot.INTEGRATED_MESH:switch(e.output){case u.ShaderOutput.Color:case u.ShaderOutput.Depth:case u.ShaderOutput.Normal:case u.ShaderOutput.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case u.ShaderOutput.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null},a.notifyDirty=function(){this._context.requestRender()},a.slots=function(){return[c.RenderSlot.OPAQUE_MATERIAL,c.RenderSlot.TRANSPARENT_MATERIAL,c.RenderSlot.INTEGRATED_MESH]},a.initializeRenderContext=function(e){this._context=e},a.uninitializeRenderContext=function(){},a.queryDepthRange=function(e){const t={near:1/0,far:-1/0};return this._systems.forEach((s=>{const a=s.queryShadowCasterDepthRange(e);null!=a&&l.union(t,a,t)})),t},a._configure=function(e){const t=e.output===u.ShaderOutput.Shadow||e.output===u.ShaderOutput.ShadowHighlight||e.output===u.ShaderOutput.ShadowExcludeHighlight?this._shadowPassParameters:e.output===u.ShaderOutput.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,t)},a._updateParameters=function(e,t){const a=e.bindParameters.camera,n=a.viewInverseTransposeMatrix;i.set(m,n[3],n[7],n[11]),g.set(m),i.copy(t.transformWorldFromViewTH,g.high),i.copy(t.transformWorldFromViewTL,g.low),i.copy(t.slicePlaneLocalOrigin,m),s.fromMat4(t.transformViewFromCameraRelativeRS,a.viewMatrix),r.copy(t.transformProjFromView,a.projectionMatrix),t.identifier===h.RenderPassIdentifier.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===c.RenderSlot.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===c.RenderSlot.INTEGRATED_MESH,s.transpose(P,t.transformViewFromCameraRelativeRS),s.invert(t.transformNormalViewFromGlobal,P))},t._createClass(e,[{key:"needsHighlight",get:function(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}},{key:"needsTransparentPass",get:function(){return this._passes.materialTransparent.count>0}}]),e}();const m=n.create(),P=a.create(),g=new d.TwoVectorPosition;e.RenderPassManager=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
