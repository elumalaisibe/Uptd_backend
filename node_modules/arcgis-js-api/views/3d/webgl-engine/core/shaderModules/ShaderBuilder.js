/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../lib/Util"],(function(e,n,t,r,i){"use strict";const o=r.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let s=function(){function e(){this._includedModules=new Map}return e.prototype.include=function(e,n){if(this._includedModules.has(e)){const t=this._includedModules.get(e);if(t!==n){o.error("Trying to include shader module multiple times with different sets of options.");const n=new Set;for(const r of Object.keys(t))t[r]!==e[r]&&n.add(r);for(const r of Object.keys(e))t[r]!==e[r]&&n.add(r);n.forEach((n=>console.error(`  ${n}: current ${t[n]} new ${e[n]}`)))}}else this._includedModules.set(e,n),e(this.builder,n)},n._createClass(e)}(),a=function(e){function t(){var n;return(n=e.apply(this,arguments)||this).vertex=new f,n.fragment=new f,n.attributes=new l,n.varyings=new _,n.extensions=new d,n.constants=new h,n}n._inherits(t,e);var r=t.prototype;return r.generate=function(e){const n=this.extensions.generateSource(e),t=this.attributes.generateSource(e),r=this.varyings.generateSource(e),i="vertex"===e?this.vertex:this.fragment,o=i.uniforms.generateSource(),s=i.code.generateSource(),a="vertex"===e?p:m,u=this.constants.generateSource().concat(i.constants.generateSource());return`#version 300 es\n${n.join("\n")}\n\n${a}\n\n${u.join("\n")}\n\n${o.join("\n")}\n\n${t.join("\n")}\n\n${r.join("\n")}\n\n${s.join("\n")}`},r.generateBind=function(e,n){const t=new Map;this.vertex.uniforms.entries.forEach((n=>{const r=n.bind[e];null!=r&&t.set(n.name,r)})),this.fragment.uniforms.entries.forEach((n=>{const r=n.bind[e];null!=r&&t.set(n.name,r)}));const r=Array.from(t.values()),i=r.length;return(e,t,o)=>{for(let s=0;s<i;++s)r[s](n,e,t,o)}},n._createClass(t,[{key:"fragmentUniforms",get:function(){return this.fragment.uniforms.entries}},{key:"builder",get:function(){return this}}]),t}(s),u=function(){function e(){this._entries=new Map}var r=e.prototype;return r.add=function(...e){for(const n of e)this._add(n)},r.get=function(e){return this._entries.get(e)},r._add=function(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new t(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else o.error(`Trying to add null Uniform from ${(new Error).stack}.`)},r.generateSource=function(){return Array.from(this._entries.values()).map((e=>null!=e.arraySize?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`))},n._createClass(e,[{key:"entries",get:function(){return Array.from(this._entries.values())}}]),e}(),c=function(){function e(){this._entries=new Array}var t=e.prototype;return t.add=function(e){this._entries.push(e)},t.generateSource=function(){return this._entries},n._createClass(e)}(),f=function(e){function t(){var n;return(n=e.apply(this,arguments)||this).uniforms=new u,n.code=new c,n.constants=new h,n}return n._inherits(t,e),n._createClass(t,[{key:"builder",get:function(){return this}}]),t}(s),l=function(){function e(){this._entries=new Array}var t=e.prototype;return t.add=function(e,n){this._entries.push([e,n])},t.generateSource=function(e){return"fragment"===e?[]:this._entries.map((e=>`in ${e[1]} ${e[0]};`))},n._createClass(e)}(),_=function(){function e(){this._entries=new Map}var t=e.prototype;return t.add=function(e,n){this._entries.has(e)&&i.assert(this._entries.get(e)===n),this._entries.set(e,n)},t.generateSource=function(e){const n=new Array;return this._entries.forEach(((t,r)=>n.push("vertex"===e?`out ${t} ${r};`:`in ${t} ${r};`))),n},n._createClass(e)}(),d=function(){function e(){this._entries=new Set}var t=e.prototype;return t.add=function(e){this._entries.add(e)},t.generateSource=function(n){const t="vertex"===n?e.ALLOWLIST_VERTEX:e.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>`#extension ${e} : enable`))},n._createClass(e)}();d.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],d.ALLOWLIST_VERTEX=[];let h=function(){function e(){this._entries=new Set}var t=e.prototype;return t.add=function(n,t,r){let i="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":i=e._numberToFloatStr(r);break;case"int":i=e._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i=`vec2(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])})`;break;case"vec3":i=`vec3(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])},                            ${e._numberToFloatStr(r[2])})`;break;case"vec4":i=`vec4(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])},                            ${e._numberToFloatStr(r[2])},                            ${e._numberToFloatStr(r[3])})`;break;case"ivec2":i=`ivec2(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])})`;break;case"ivec3":i=`ivec3(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])})`;break;case"ivec4":i=`ivec4(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])},                             ${e._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":i=`${t}(${Array.prototype.map.call(r,(n=>e._numberToFloatStr(n))).join(", ")})`}return this._entries.add(`const ${t} ${n} = ${i};`),this},e._numberToIntStr=function(e){return e.toFixed(0)},e._numberToFloatStr=function(e){return Number.isInteger(e)?e.toFixed(1):e.toString()},t.generateSource=function(){return Array.from(this._entries)},n._createClass(e)}();const m="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n\nout vec4 fragColor;",p="precision highp float;\nprecision highp sampler2D;";e.Code=c,e.Includes=s,e.ShaderBuilder=a,e.Stage=f,e.Uniforms=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
