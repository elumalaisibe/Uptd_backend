/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/maybe","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../core/support/WatchUpdatingTracking","../../../geometry/ellipsoidUtils","./PrecipitationTechnique","./PrecipitationTechniqueConfiguration","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/AnimationTimer","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Util"],(function(e,t,i,r,n,a,s,c,o,u,p,h,d,l,_,f,y,b,T,g,m,P,w,q){"use strict";e.Precipitation=function(e){function i(t){var i;return(i=e.call(this,t)||this)._numParticles=25e4,i._rainSpeed=.1,i._snowSpeed=.01,i._passParameters=new _.PrecipitationPassParameters,i._animation=new T.AnimationTimer,i._updatingTracking=new d.WatchUpdatingTracking,i._passParameters.time=0,i._passParameters.radius=l.getReferenceEllipsoid(t.view.spatialReference).radius,i._techniqueRepository=t.context.techniqueRepository,i}t._inherits(i,e);var r=i.prototype;return r.destroy=function(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=a.releaseMaybe(this._snowTechniqueCached),this._rainTechniqueCached=a.releaseMaybe(this._rainTechniqueCached),this._vao=a.disposeMaybe(this._vao),this._instanceIdBuffer=a.disposeMaybe(this._instanceIdBuffer)},r.update=function(e){return this._animation.advance(e)},r.render=function(e,t,i){const r="rainy"===i?this._rainTechnique:this._snowTechnique;if(!r.compiled)return void this.context.requestRender();const a=e.rctx;if(this._ensureResources(a),null==r||null==this._vao||null==this._instanceIdBuffer)return;if(null!=e.bindParameters.cloudsFade.data&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),this._passParameters.opacity<=0)return;const c=.35;t=t<.5?n.lerp(0,c,2*t):n.lerp(c,1,2*(t-.5)),this._passParameters.time=("rainy"===i?this._rainSpeed:this._snowSpeed)*s.secondsFromMilliseconds(this._animation.time)%1e5;const o=a.bindTechnique(r,this._passParameters,e.bindParameters);a.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),q.bindVertexBufferLayout(a,_.attributeLocations,this._instanceIdBuffer,v,0),a.capabilities.instancing?.drawArraysInstanced(w.PrimitiveType.TRIANGLES,0,3,this._numParticles*t),q.unbindVertexBufferLayout(a,_.attributeLocations,this._instanceIdBuffer,v)},r._ensureResources=function(e){null==this._vao&&(this._vao=this._createVertexArrayObject(e)),null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(e))},r._createInstanceIndices=function(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return P.BufferObject.createVertex(e,w.Usage.STATIC_DRAW,new Float32Array(t))},r._createVertexArrayObject=function(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new g.VertexArrayObject(e,_.attributeLocations,{geometry:y.glLayout(A)},{geometry:P.BufferObject.createVertex(e,w.Usage.STATIC_DRAW,t)})},t._createClass(i,[{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"_rainTechnique",get:function(){if(null==this._rainTechniqueCached){const e=new f.PrecipitationTechniqueConfiguration;e.type=f.PrecipitationType.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(_.PrecipitationTechnique,e)}return this._rainTechniqueCached}},{key:"_snowTechnique",get:function(){if(null==this._snowTechniqueCached){const e=new f.PrecipitationTechniqueConfiguration;e.type=f.PrecipitationType.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(_.PrecipitationTechnique,e)}return this._snowTechniqueCached}}]),i}(r),i.__decorate([c.property({constructOnly:!0})],e.Precipitation.prototype,"context",void 0),i.__decorate([c.property({constructOnly:!0})],e.Precipitation.prototype,"view",void 0),i.__decorate([c.property({readOnly:!0})],e.Precipitation.prototype,"updating",null),i.__decorate([c.property()],e.Precipitation.prototype,"_updatingTracking",void 0),e.Precipitation=i.__decorate([h.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const A=b.newLayout().vec3f(m.VertexAttribute.POSITION),v=y.glLayout(b.newLayout().f32(m.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
