/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../assets","../../../core/Accessor","../../../core/asyncUtils","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../chunks/mat4","../../../chunks/mat4f64","../../../core/support/WatchUpdatingTracking","./StarsTechnique","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums"],(function(t,e,r,a,s,i,n,o,c,u,f,l,d,h,p,_,g,b,y,v,m,T,w,k,S,A,D){"use strict";t.Stars=function(t){function r(e){var r;return(r=t.call(this,e)||this)._loadDataTask=null,r._numPoints=0,r._renderParameter=new v.StarPassParameters,r._updatingTracking=new y.WatchUpdatingTracking,r}e._inherits(r,t);var s=r.prototype;return s.initialize=function(){this._loadDataTask=this._createLoadDataTask()},s.destroy=function(){this._loadDataTask=c.abortMaybe(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=c.releaseMaybe(this._technique),this._vao=c.disposeMaybe(this._vao),V=null},s.render=function(t){const{rctx:e}=t;if(this._ensureResources(e),null==this._technique||null==this._vao)return;if(!this._technique.compiled)return void this.requestRender();const r=e.bindTechnique(this._technique,this._renderParameter,t.bindParameters);e.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(D.PrimitiveType.POINTS,0,this._numPoints)},s._ensureResources=function(t){if(null!=this._technique||null==V)return;this._technique=new v.StarsTechnique({rctx:t,viewingMode:this.view.state.viewingMode}),this._numPoints=V.byteLength/M;const e=new Float32Array(V,0,2*this._numPoints),r=new Uint8Array(V,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t,e,r,this._numPoints),this._updatingTracking.add((()=>"virtual"!==this.view.environment.lighting.type?this.view.environment.lighting.date:null),(t=>this._update(t)),f.initial)},s._computeDayDuration=function(t){const e=t,r=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+r)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+r)},s._update=function(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(t),a=g.copy(this._renderParameter.modelMatrix,O);g.rotateZ(a,a,-r*Math.PI),g.multiply(a,x,a),g.rotateZ(a,a,-e*Math.PI),this.requestRender()},s._hexToRGB=function(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]},s._unpackUint8Attributes=function(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]},s._createVertexArrayObject=function(t,e,r,a){const s=q.createBuffer(a),i=s.position,n=s.color,o=s.size;for(let c=0;c<a;c++){const t=e[2*c],a=e[2*c+1];i.set(c,0,-Math.cos(t)*Math.sin(a)),i.set(c,1,-Math.sin(t)*Math.sin(a)),i.set(c,2,-Math.cos(a));const s=this._unpackUint8Attributes(r[c]),u=this._hexToRGB(P[s[1]]);n.set(c,0,255*u[0]),n.set(c,1,255*u[1]),n.set(c,2,255*u[2]),n.set(c,3,255),o.set(c,s[0])}return new k.VertexArrayObject(t,w.Default3D,{geometry:m.glLayout(q)},{geometry:A.BufferObject.createVertex(t,D.Usage.STATIC_DRAW,s.buffer)})},s._createLoadDataTask=function(){if(null!=V)return null;const t=i.createTask((async t=>{const{data:e}=await a.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(e),V=e}));return t.promise.catch((t=>{u.isAbortError(t)||o.getLogger(this).error(t)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),t},s._verifyStarData=function(t){if(!t)throw new n("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/M;if(e%1!=0||e>5e4||e<5e3)throw new n("stars:invalid-data","Failed to create stars because star catalogue data is invalid")},e._createClass(r,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return null!=this._loadDataTask&&!this._loadDataTask.finished}}]),r}(s),r.__decorate([l.property({constructOnly:!0})],t.Stars.prototype,"view",void 0),r.__decorate([l.property({constructOnly:!0})],t.Stars.prototype,"requestRender",void 0),r.__decorate([l.property({readOnly:!0})],t.Stars.prototype,"updating",null),r.__decorate([l.property()],t.Stars.prototype,"_loadDataTask",void 0),r.__decorate([l.property()],t.Stars.prototype,"_updatingTracking",void 0),t.Stars=r.__decorate([_.subclass("esri.views.3d.environment.Stars")],t.Stars);const P=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],x=b.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),O=b.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),M=9,q=T.newLayout().vec3f(S.VertexAttribute.POSITION).vec4u8(S.VertexAttribute.COLOR).f32(S.VertexAttribute.SIZE);let V=null;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
