/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/spatialReferenceUtils","../../ViewingMode","./AtmosphereType","./ChapmanAtmosphere","./CloudsComposition","./CloudsCompositionParameters","./CloudsData","./CloudsGenerator","./CloudsPresets","./Fog","./LocalAtmosphere","./MarsAtmosphere","./Precipitation","./Stars","./weather","./weatherUtils","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/lib/RenderFeature","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/Update"],(function(e,t,r,n,s,i,a,o,h,d,l,p,u,c,_,m,g,y,f,w,v,R,b,P,A,E,C,x,F,M,N,S,W,T,O){"use strict";var k;const I=[T.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE,T.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];e.EnvironmentRenderer=k=function(e){function r(t){var r;return(r=e.call(this,t)||this)._context=null,r._atmosphere=null,r._oldWeatherParameters=new z,r._newWeatherParameters=new z,r._fadedWeatherParameters=new z,r._weatherParameters=r._newWeatherParameters,r}t._inherits(r,e);var n=r.prototype;return n.initialize=function(){this.view._stage.addRenderPlugin(I,this)},n.destroy=function(){this.removeHandles(),this.uninitializeRenderContext(),null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this),this._set("view",null)},n.updateAnimation=function(e){return null!=this._precipitation&&this._precipitation.update(e)},n.initializeRenderContext=function(e=null){this._context=e;const t=()=>this._setNeedsRender();this.addHandles([o.watch((()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled})),(e=>this._updateAtmosphere(e)),o.syncAndInitial),o.watch((()=>this._stars),t),o.watch((()=>this._precipitation),t),o.watch((()=>this._clouds),(()=>this._updateWeather()),o.initial),o.watch((()=>this._fog),(()=>this._updateFogHaze()),o.initial),o.watch((()=>this.view.state.mode),(()=>{this._setNeedsRender()}),o.sync),o.watch((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),o.syncAndInitial)])},n.uninitializeRenderContext=function(){this._context=null,this._atmosphere=a.destroyMaybe(this._atmosphere),this._set("_stars",a.destroyMaybe(this._stars)),this._set("_precipitation",a.destroyMaybe(this._precipitation)),this._set("_clouds",a.destroyMaybe(this._clouds)),this._set("_cloudsComposition",a.destroyMaybe(this._cloudsComposition)),this._set("_fog",a.destroyMaybe(this._fog))},n.prepareRender=function(e){e.bindParameters.cloudsFade.data=R.isReadyCloudsData(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&null!=e.bindParameters.cloudsFade.data?.cubeMap&&(N.updateWeatherFading(e.bindParameters.cloudsFade,e.bindParameters.camera,this.view.state.mode,e.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(e.bindParameters),e.bindParameters.cloudsFade.renderingStage===R.CloudsRenderingStages.FINISHED&&null!=this._clouds&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))},n.render=function(e){if(e.output===S.ShaderOutput.Color)switch(e.bindParameters.slot){case T.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE:null!=this._stars&&this._stars.render(e),null!=this.atmosphere&&(this.atmosphere.render(e,this.view?.qualitySettings.highResolutionAtmosphere||this.view?._stage?.renderer?.isFeatureEnabled(W.RenderFeature.HighResolutionAtmosphere)),null!=this._cloudsComposition&&null!=e.bindParameters.cloudsFade.data&&(this.weatherVisible&&null!=this._clouds&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),N.weatherFadingNeedsRender(e.bindParameters.cloudsFade)&&null!=this._context&&null!=e.bindParameters.cloudsFade.data?.cubeMap&&this._context.requestRender());break;case T.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(null!=this.atmosphere&&(this.atmosphere.renderHaze(e,this._weatherParameters.hazeAmount,this.view?.qualitySettings.highResolutionAtmosphere||this.view?._stage?.renderer?.isFeatureEnabled(W.RenderFeature.HighResolutionAtmosphere)),this._weatherParameters.fog.amount>0&&null!=this._fog&&this._fog.render(e,this._weatherParameters.fog),null!=this._precipitation)){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}},n.updateLightSources=function(e,t,r,n){if(null!=this._context){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=t,s.bindParameters.newLighting.globalFactor=r,s.bindParameters.newLighting.set(e);n===O.Update.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}},n._updateWeatherFading=function(e){if(!e.weatherFading)return;const t=e.cloudsFade;return t.fadeIn.stage===v.FadeInStages.FADE_IN?(e.fadeLighting(t.fadeIn.factor),void this._fadeWeather(t.fadeIn.factor)):t.fadeInOut.stage===v.FadeInOutStages.FADE_IN?(e.fadeLighting(t.fadeInOut.factor),void this._fadeWeather(t.fadeInOut.factor)):t.crossFade.enabled?(e.fadeLighting(t.crossFade.factor),void this._fadeWeather(t.crossFade.factor)):(e.fadeLighting(0),void this._fadeWeather(0))},n._fadeWeather=function(e){const{_newWeatherParameters:t,_oldWeatherParameters:r}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(r,t,e),this._weatherParameters=this._fadedWeatherParameters)},n._updateWeather=function(){const e=this._weatherUpdateParameters;null!=e&&null!=this._clouds&&(this._clouds.applyPreset(P.cloudPresets[e.type],e.weatherAdjustment),this._setNeedsRender())},n._setNeedsRender=function(){null!=this._context&&this._context.requestRender()},n._updateFogHaze=function(){const e=this._weatherUpdateParameters;if(null==this._fog||null==e||null==this._context)return;const t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=i.lerp(3e-5,.005,e.weatherAdjustment**3),u.copy(this._newWeatherParameters.fog.color,U),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=i.lerp(4e-6,2e-4,(e.effect??0)**3),u.copy(this._newWeatherParameters.fog.color,L),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=i.lerp(4e-6,2e-4,(e.effect??0)**3),u.copy(this._newWeatherParameters.fog.color,U),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)},n._updateAtmosphere=function(e){const t=this._selectAtmosphereType(e);if(t!==y.AtmosphereType.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==t){this._atmosphere=a.destroyMaybe(this._atmosphere);const e=this._getAtmosphereClass(t);e&&(this._atmosphere=new e(this.view,this._context))}}else this._atmosphere=a.destroyMaybe(this._atmosphere);this._setNeedsRender()},n._getAtmosphereClass=function(e){switch(e){case y.AtmosphereType.Realistic:return f.ChapmanAtmosphere;case y.AtmosphereType.Local:return E.LocalAtmosphere;case y.AtmosphereType.Mars:return C;default:case y.AtmosphereType.None:return null}},n._selectAtmosphereType=function(e){const{enabled:t,viewingMode:r}=e;return!t||m.isMoon(this.view.spatialReference)?y.AtmosphereType.None:r===g.ViewingMode.Local?y.AtmosphereType.Local:null!=this._context&&f.ChapmanAtmosphere.isSupported(this._context)&&m.isEarth(this.view.spatialReference)?y.AtmosphereType.Realistic:m.isMars(this.view.spatialReference)?y.AtmosphereType.Mars:y.AtmosphereType.None},t._createClass(r,[{key:"atmosphere",get:function(){return this._atmosphere}},{key:"_atmosphereType",get:function(){return null!=this.atmosphere?this.atmosphere.type:y.AtmosphereType.None}},{key:"canRender",get:function(){return!(null===this._atmosphere&&null===this._stars)}},{key:"needsLinearDepth",get:function(){return this._atmosphereType===y.AtmosphereType.Realistic}},{key:"updating",get:function(){return null!=this._stars&&this._stars.updating||null!=this._clouds&&this._clouds.running}},{key:"weatherVisible",get:function(){return u.length(this.view.state.camera.eye)-_.getReferenceEllipsoid(this.view.spatialReference).radius<=M.weatherHeightLimit}},{key:"_stars",get:function(){const e=this.view,t=e.environment?.starsEnabled??!1,r=this._get("_stars");return t&&null!=this._context?null!=r?r:new F.Stars({view:e,requestRender:()=>this._setNeedsRender()}):(a.destroyMaybe(r),null)}},{key:"_precipitation",get:function(){const e=this._get("_precipitation");if(!this._precipitationEnabled||null==this._context)return a.destroyMaybe(e),null;const t=this.view,r=this._context;return null!=e&&e.context===r?e:(a.destroyMaybe(e),new x.Precipitation({context:r,view:t}))}},{key:"_clouds",get:function(){const e=this._get("_clouds");if(!this.weatherEnabled||null==this._context)return a.destroyMaybe(e),null;if(null!=e)return e;const t=this.view,r=this._context;return a.destroyMaybe(e),new b.CloudsGenerator({context:r,view:t,requestRender:()=>this._setNeedsRender()})}},{key:"_cloudsComposition",get:function(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||null==this._context)return a.destroyMaybe(e),null;const t=this.view.state.viewingMode,r=this._context.renderContext.rctx,n=_.getReferenceEllipsoid(this.view.spatialReference).radius;return null!=e&&e.viewingMode===t&&e.planetRadius===n?e:(a.destroyMaybe(e),new w.CloudsComposition({rctx:r,viewingMode:t,planetRadius:n,requestRender:()=>this._setNeedsRender()}))}},{key:"_fog",get:function(){const e=this._get("_fog");if(!this.weatherEnabled||null==this._context)return a.destroyMaybe(e),null;if(null!=e)return e;const t=this.view,r=this._context,n=this._context.renderContext.rctx,s=this.view.state.viewingMode;return new A.Fog({context:r,view:t,rctx:n,viewingMode:s})}},{key:"weatherEnabled",get:function(){return!!this.view?.environmentManager?.weatherEnabled}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"_weatherUpdateParameters",get:function(){const e=this.weatherEnabled?this.view.environment.weather:null;return null==e?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),stubGetAtmosphereClass:e=>{H=k.prototype._getAtmosphereClass,k.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{k.prototype._getAtmosphereClass=H}}}}]),r}(n),r.__decorate([h.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"atmosphere",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_atmosphereType",null),r.__decorate([h.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherVisible",null),r.__decorate([h.property()],e.EnvironmentRenderer.prototype,"_context",void 0),r.__decorate([h.property()],e.EnvironmentRenderer.prototype,"_atmosphere",void 0),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_stars",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitation",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_clouds",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_cloudsComposition",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_fog",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"weatherEnabled",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_precipitationEnabled",null),r.__decorate([h.property({readOnly:!0})],e.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null),e.EnvironmentRenderer=k=r.__decorate([p.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer);let z=function(){function e(){this.fog=new A.FogParameters,this.hazeAmount=1}var r=e.prototype;return r.copyFrom=function(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,u.copy(this.fog.color,e.fog.color)},r.lerp=function(e,t,r){this.fog.amount=i.lerp(e.fog.amount,t.fog.amount,r),this.hazeAmount=i.lerp(e.hazeAmount,t.hazeAmount,r),this.fog.strength=i.lerp(e.fog.strength,t.fog.strength,r),u.lerp(this.fog.color,e.fog.color,t.fog.color,r)},t._createClass(e)}();const L=c.fromValues(.5,.5,.5),U=c.fromValues(1.5,1.5,1.5);let H;e.WeatherParameters=z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
