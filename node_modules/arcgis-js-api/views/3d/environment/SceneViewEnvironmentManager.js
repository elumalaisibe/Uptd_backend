/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Color","../../../core/Evented","../../../core/Handles","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/vec4f64","../../../geometry/projection","../../../geometry/support/spatialReferenceUtils","../../ViewingMode","./EnvironmentRenderer","../support/earthUtils","../support/sunUtils","../webgl-engine/lib/Update","../webgl-engine/lighting/Lightsources","../../../webscene/background/ColorBackground"],(function(e,t,n,r,i,s,o,a,c,h,l,d,p,u,_,f,g,m,v,P,y,w,b,C,S,U){"use strict";e.SceneViewEnvironmentManager=function(e){function n(){var t;return(t=e.call(this)||this)._referencePointUpdateDelay=200,t._referencePointUpdateInterval=3e3,t._referencePointUpdateDistThreshold=1e6,t._referencePosUpdateQuery=null,t._referencePosMapCoordsRequested=null,t._viewHandles=new s,t._preserveAbsoluteDateTime=!1,t._trackingEnabled=!1,t._referencePosResetPreserveAbsoluteTime=!1,t._referencePosUpdateTimer=null,t._referencePosMapCoords=null,t._mainLight=new S.MainLight,t._ambientLight=new S.AmbientLight,t._moonLight=new S.FillLight,t.disableQueries=!1,t._disableWeather=!1,t._renderer=null,t._referencePosWGS84Comparable=null,t._resetReferencePosition(),t}t._inherits(n,e);var i=n.prototype;return i.destroy=function(){this.disconnectView(),this._viewHandles.destroy()},i.connectView=function(e){if(this._renderer)return;this._renderer=new y.EnvironmentRenderer({view:e});const t=()=>this._updateRenderParameters(),n=()=>this._cameraHandler();this._viewHandles.add([c.watch((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),c.sync),c.watch((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),c.sync),c.watch((()=>e.stationary),(()=>this._interactingStationaryHandler())),c.watch((()=>e.environment.lighting.directShadowsEnabled),t,c.sync),c.watch((()=>e.qualitySettings.ambientOcclusion),t,c.sync),c.watch((()=>e.qualitySettings.reflections),t,c.sync),c.watch((()=>e.environment.background?.color),t,c.sync),c.watch((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),c.sync),c.watch((()=>e.environment.weather.type),(()=>this._updateLighting(null,C.Update.Faded)),c.sync),c.watch((()=>this.weatherEnabled),(()=>this._updateLighting(null,C.Update.Faded)),c.sync),c.watch((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),c.syncAndInitial),c.watch((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),c.syncAndInitial),c.watch((()=>e.state.camera),n,c.syncAndInitial),c.watch((()=>this.disableQueries),n)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")},i.disconnectView=function(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=o.destroyMaybe(this._renderer)},i._updateLightingHandler=function(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()},i._updateCameraTracking=function(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}},i._lightingDateHandler=function(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const n=this._view.spatialReference;if(!m.canProjectToWGS84ComparableLonLat(n)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),null!=this._referencePosWGS84Comparable){const e=w.positionToTimezoneInfo(this._referencePosWGS84Comparable,E);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()},i._preupdateTracking=function(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)},i._cameraHandler=function(e=null){const t=this._view;if(!t.ready)return;const n=t.stateManager.camera;n&&(this._cameraHandlerClientSide(n,e)||this._cameraHandlerServerSide(n))},i._cameraHandlerClientSide=function(e,t){const n=v.isEarth(this._view.spatialReference);if(n&&!m.canProjectToWGS84ComparableLonLat(this._view.spatialReference))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;const r=e.position;return null==this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable=f.create()),n?m.projectPointToWGS84ComparableLonLat(r,this._referencePosWGS84Comparable):_.set(this._referencePosWGS84Comparable,r.longitude??0,r.latitude??0,r.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0},i._cameraHandlerServerSide=function(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(t.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())},i._interactingStationaryHandler=function(){this._view.stationary&&this._executePendingReferencePositionUpdate()},i._updateLighting=function(e,t=C.Update.Immediate){const n=this._view;e=e||("virtual"===n.environment.lighting.type?null:n.environment.lighting.date);const r=this._referencePosWGS84Comparable,i=null!=r?T:M,s=this.weatherVisible?n.environment.weather.type:"disabled";null!=r?b.computeColorAndIntensity(e,r,n.state.viewingMode,s,n.state.camera,i):"virtual"===n.environment.lighting.type&&b.computeVirtualLightDirection(n.state.camera,n.state.viewingMode,i.direct.directionToLightSource);const o=this._mainLight,a=i.direct;_.scale(o.intensity,a.color,a.intensity*Math.PI),_.copy(o.direction,a.directionToLightSource),o.specularStrength=i.specularStrength,o.environmentStrength=i.environmentStrength;const c=this._ambientLight;_.scale(c.intensity,i.ambient.color,i.ambient.intensity);const h=this._moonLight;_.lerp(h.intensity,W,L,i.globalFactor);const l=(1-.5*i.globalFactor)*(1-.4*i.noonFactor*(1-i.globalFactor));_.scale(h.intensity,h.intensity,l),_.copy(h.direction,a.directionToLightSource),this._renderer.updateLightSources([o,c,h],i.noonFactor,i.globalFactor,t),this._updateRenderParameters()},i._autoUpdateTimezone=function(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const n=R;n.setTime((t||this._view.environment.lighting.date).getTime());const r=w.positionToTimezoneInfo(e,E);if(null==r)return!1;let i=this._view.environment.lighting.positionTimezoneInfo;if(i.autoUpdated){if(i.hours===r.hours&&i.minutes===r.minutes&&i.seconds===r.seconds)return!1}else i=r;const s=n.getUTCHours()-(r.hours-i.hours),o=n.getUTCMinutes()-(r.minutes-i.minutes),a=n.getUTCSeconds()-(r.seconds-i.seconds);return n.setUTCHours(s),n.setUTCMinutes(o),n.setUTCSeconds(a),!t&&this._view.environment.lighting.autoUpdate(n,r)},i._updateRenderParameters=function(){const e=this._view._stage;if(!e)return;const t=null==this._referencePosWGS84Comparable||b.computeShadowsEnabled(this._referencePosWGS84Comparable[2],this._view.state.viewingMode),n=this._view.environment.background,i=n instanceof U?{type:"color",color:g.fromArray(r.toUnitRGBA(n.color))}:{type:"color",color:g.fromValues(0,0,0,1)};e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,background:i,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})},i._resetReferencePosition=function(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()},i._requestReferencePositionUpdate=function(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=a.after(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=a.after(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}},i._doReferencePositionUpdateQuery=async function(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}},i._executePendingReferencePositionUpdate=function(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)},i._referencePosChanged=function(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")},i._exceedsReferencePosDistThreshold=function(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0},i._cancelReferencePosUpdates=function(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e},t._createClass(n,[{key:"_view",get:function(){return this._renderer?.view}},{key:"updating",get:function(){return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!this._renderer?.updating)}},{key:"weatherEnabled",get:function(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===P.ViewingMode.Global&&v.isEarth(this._view.spatialReference)}},{key:"weatherVisible",get:function(){return this.weatherEnabled&&this._renderer?.weatherVisible}},{key:"referencePositionWGS84Comparable",get:function(){return this._referencePosWGS84Comparable}},{key:"test",get:function(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}}]),n}(i.EventedAccessor),n.__decorate([h.property({type:Boolean,readOnly:!0})],e.SceneViewEnvironmentManager.prototype,"updating",null),n.__decorate([h.property()],e.SceneViewEnvironmentManager.prototype,"disableQueries",void 0),n.__decorate([h.property()],e.SceneViewEnvironmentManager.prototype,"_disableWeather",void 0),n.__decorate([h.property()],e.SceneViewEnvironmentManager.prototype,"weatherEnabled",null),n.__decorate([h.property()],e.SceneViewEnvironmentManager.prototype,"weatherVisible",null),n.__decorate([h.property()],e.SceneViewEnvironmentManager.prototype,"referencePositionWGS84Comparable",null),n.__decorate([h.property()],e.SceneViewEnvironmentManager.prototype,"_renderer",void 0),n.__decorate([h.property()],e.SceneViewEnvironmentManager.prototype,"_referencePosWGS84Comparable",void 0),e.SceneViewEnvironmentManager=n.__decorate([u.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],e.SceneViewEnvironmentManager);const T=new b.ColorAndIntensity,M=new b.ColorAndIntensity,R=new Date,E={hours:0,minutes:0,seconds:0},W=f.fromValues(.22,.22,.33),L=f.fromValues(.22,.22,.22);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
