/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Collection","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","./AnalysisView3D","./Dimension/DimensionController","./Dimension/DimensionTool","./Dimension/DimensionVisualization","./Dimension/LengthDimensionComputation","./support/projectionUtils","../../analysis/analysisViewUtils","../../analysis/DimensionAnalysisView"],(function(e,i,n,o,t,s,a,r,l,p,c,d,u,m,y,_,h,D,v,g){"use strict";let f=function(i){function n(e){var n;return(n=i.call(this,e)||this).type="dimension-view-3d",n.tool=null,n.computations=new o,n.selectedDimension=null,n._dimensionsToComputations=new Map,n._placementTask=null,n._projectAndAlignPoint=null,n}e._inherits(n,i);var r=n.prototype;return r.initialize=function(){this._projectAndAlignPoint=e=>{if(null==e)return null;const{spatialReference:i,elevationProvider:n}=this.view,o=D.applyProjectionAndElevationAlignment(e,i,n);return null==o&&D.logFailedGeometryProjectionError(this.analysis,e.spatialReference,t.getLogger(this)),o},this.addHandles([v.connectAnalysisViewToTool(this,y.DimensionTool),a.on((()=>this.analysis.dimensions),"after-add",(e=>this._onDimensionAdd(e.item)),{onListenerAdd:e=>{for(const i of e)this._onDimensionAdd(i)},onListenerRemove:()=>{this._onDimensionsClear()}}),a.on((()=>this.analysis.dimensions),"after-remove",(e=>this._onDimensionRemove(e.item)))]),this._analysisVisualization=new _.DimensionVisualization({analysisViewData:this,view:this.view}),this._analysisController=new m.DimensionController({analysisViewData:this,view:this.view})},r.destroy=function(){this._placementTask=s.abortMaybe(this._placementTask),this._analysisVisualization=s.destroyMaybe(this._analysisVisualization),v.removeAnalysisViewTool(this)},r.createLengthDimensions=async function(e){return this.selectedDimension=null,this._placementTask=s.abortMaybe(this._placementTask),this._placementTask=v.activateAnalysisViewTool(this,e),this._placementTask.promise},r._onDimensionAdd=function(e){const{computations:i,_dimensionsToComputations:n}=this;if(n.has(e))return;const o=new h.LengthDimensionComputation({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});i.add(o),n.set(e,o)},r._onDimensionRemove=function(e){const{computations:i,_dimensionsToComputations:n}=this,o=i.findIndex((i=>i.dimension===e)),t=i.at(o);t.dimension===this.selectedDimension&&(this.selectedDimension=null),i.removeAt(o),n.delete(e),s.destroyMaybe(t)},r._onDimensionsClear=function(){this.computations.drain((e=>e.destroy())),this._dimensionsToComputations.clear()},e._createClass(n,[{key:"updating",get:function(){return this._analysisVisualization?.loadingMessages??!1}},{key:"results",get:function(){return this.analysis.dimensions.map((e=>this._dimensionsToComputations.get(e).result))}},{key:"selectedComputation",get:function(){const{selectedDimension:e}=this;return null==e?null:this._dimensionsToComputations.get(e)}},{key:"testInfo",get:function(){return{visualization:this._analysisVisualization,controller:this._analysisController}}}]),n}(g(u.AnalysisView3D(n)));i.__decorate([r.property({readOnly:!0})],f.prototype,"type",void 0),i.__decorate([r.property()],f.prototype,"tool",void 0),i.__decorate([r.property()],f.prototype,"updating",null),i.__decorate([r.property({readOnly:!0})],f.prototype,"results",null),i.__decorate([r.property({readOnly:!0})],f.prototype,"computations",void 0),i.__decorate([r.property()],f.prototype,"selectedDimension",void 0),i.__decorate([r.property()],f.prototype,"selectedComputation",null),i.__decorate([r.property()],f.prototype,"_analysisVisualization",void 0),i.__decorate([r.property()],f.prototype,"_analysisController",void 0),i.__decorate([r.property()],f.prototype,"_dimensionsToComputations",void 0),i.__decorate([r.property()],f.prototype,"_placementTask",void 0),f=i.__decorate([d.subclass("esri.views.3d.analysis.DimensionAnalysisView3D")],f);return f}));
