/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../geometry/Point","../../../../../geometry/projection","../../../../../geometry/support/aaBoundingRect","../../support/projectionUtils","../../../../interactive/coordinateHelper","../../../../interactive/editGeometry/EditGeometry","../../../../interactive/editGeometry/EditGeometryOperations"],(function(e,t,r,n,o,i,s,a,c,l,u,h,m,d,p,y,_,g,f,G){"use strict";const v="esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurement3DPathHelper",P=i.getLogger(v);e.AreaMeasurement3DPathHelper=function(e){function r(t={}){var r;return(r=e.call(this,t)||this)._handles=new o,r._version=0,r._internalGeometryChange=!1,r._extent=y.empty(),r}t._inherits(r,e);var n=r.prototype;return n.destroy=function(){this._handles=s.destroyMaybe(this._handles)},n._initialize=function(e,t){this._handles.removeAll(),this._handles.add(a.watch((()=>e.geometry),(()=>{this._updateEditGeometryFromModelGeometry(e,t)}),a.syncAndInitial)),this._makeDirty(!0)},n._makeDirty=function(e=!1){this.notifyChange("isValidPolygon"),this.notifyChange("initialized"),this.notifyChange("extent"),e&&this.notifyChange("numVertices")},n._updateEditGeometryFromModelGeometry=function(e,t){if(this._version++,this._internalGeometryChange)return;this._handles.remove("EditGeometry");let r=e.geometry;if(null!=r){const n=p.tryProjectWithZConversion(r,t.spatialReference);null==n&&_.logFailedGeometryProjectionError(e,r.spatialReference,P),r=n}this._editGeometryOperations=null!=r?G.EditGeometryOperations.fromGeometry(r,t.state.viewingMode):new G.EditGeometryOperations(new f.EditGeometry("polygon",g.createCoordinateHelper(!0,!1,t.spatialReference))),this._makeDirty(!0),this.emit("change"),this._handles.add(this._editGeometry.on("change",(t=>{this._makeDirty(null!=t.addedVertices||null!=t.removedVertices),this._internalGeometryChange=!0,e.geometry=this.numVertices>0?this._editGeometry.geometry:null,this._internalGeometryChange=!1})),"EditGeometry")},n.getVertex=function(e){if(!this.constructed||0===this._editGeometry.components.length||0===this._editGeometry.components[0].vertices.length)return null;const t=this._editGeometry.components[0].vertices[0];let r=t;do{if(r.index===e)return r;r=r.rightEdge.rightVertex}while(r!==t&&null!=r);return null},n.getVertexPositionAsPoint=function(e){return this._editGeometry.coordinateHelper.vectorToPoint(e.pos)},n.getVertexPositionAsPointFromIndex=function(e){return this._editGeometry.coordinateHelper.vectorToPoint(this.getVertex(e).pos)},n.forEachVertex=function(e){this.constructed&&this._editGeometry.components.length>0&&this._editGeometry.components[0].iterateVertices(e)},n.forEachVertexPosition=function(e){const t=this._editGeometry.coordinateHelper;this.forEachVertex(((r,n)=>{t.vectorToPoint(r.pos,V),e(V,n)}))},n.clear=function(){null!=this.areaMeasurement&&(this.areaMeasurement.geometry=null)},n.add=function(e){if(!this.constructed)return null;if(0===this._editGeometry.components.length){const e=this.view;this._editGeometry.components.push(new f.Component(e.spatialReference,e.state.viewingMode))}const t=this._editGeometryOperations.appendVertex(this._editGeometry.coordinateHelper.pointToVector(e));return this.emit("change"),t},n.close=function(){if(!this.constructed||0===this._editGeometry.components.length)return null;const e=this._editGeometryOperations.closeComponent(this._editGeometry.components[0]);return this.emit("change"),e},n.ensureContains=function(e,t=""){let r=!1;if(this._editGeometry.components.forEach((t=>{t.iterateVertices((t=>{t===e&&(r=!0)}))})),!r)throw new Error(`vertex doesnt exist ${t}`);return r},n.setVertexPosition=function(e,t){if(!this.constructed)return null;const r=this._editGeometryOperations.setVertexPosition(e,this._editGeometry.coordinateHelper.pointToVector(t));return this.emit("change"),r},n.equals=function(e){if(this.numVertices!==e.numVertices)return!1;let t=!0;return this.forEachVertexPosition(((r,n)=>{const o=e.getVertexPositionAsPointFromIndex(n);r.equals(o)||(t=!1)})),!!t},t._createClass(r,[{key:"areaMeasurement",set:function(e){this._set("areaMeasurement",e),null!=e&&null!=this.view&&this._initialize(e,this.view)}},{key:"view",set:function(e){this._set("view",e),null!=e&&null!=this.areaMeasurement&&this._initialize(this.areaMeasurement,e)}},{key:"constructed",get:function(){return null!=this.areaMeasurement&&null!=this.view}},{key:"version",get:function(){return this._version}},{key:"isValidPolygon",get:function(){return this.constructed&&this._editGeometry.components.length>0&&this._editGeometry.components[0].isClosed()}},{key:"extent",get:function(){if(this.constructed&&this._editGeometry.components.length>0&&this._editGeometry.components[0].vertices.length>0){const e=y.empty(this._extent);return this.forEachVertex((t=>{y.expandPointInPlace(e,t.pos)})),e}return null}},{key:"spatialReference",get:function(){return this.constructed?this._editGeometry.coordinateHelper.spatialReference:null}},{key:"_editGeometry",get:function(){return this._editGeometryOperations.data}},{key:"vertices",get:function(){const e=[];return this.forEachVertex((t=>{e.push(t)})),e}},{key:"numVertices",get:function(){return this.constructed&&this._editGeometry.components.length>0?this._editGeometry.components[0].vertices.length:0}},{key:"lastPoint",get:function(){if(this.constructed&&this._editGeometry.components.length>0){const e=this._editGeometry.components[0].getLastVertex();if(null!=e)return this._editGeometry.coordinateHelper.vectorToPoint(e.pos)}return null}}]),r}(n.EventedAccessor),r.__decorate([c.property({value:null})],e.AreaMeasurement3DPathHelper.prototype,"areaMeasurement",null),r.__decorate([c.property({value:null})],e.AreaMeasurement3DPathHelper.prototype,"view",null),r.__decorate([c.property()],e.AreaMeasurement3DPathHelper.prototype,"isValidPolygon",null),r.__decorate([c.property()],e.AreaMeasurement3DPathHelper.prototype,"extent",null),r.__decorate([c.property()],e.AreaMeasurement3DPathHelper.prototype,"spatialReference",null),r.__decorate([c.property()],e.AreaMeasurement3DPathHelper.prototype,"numVertices",null),e.AreaMeasurement3DPathHelper=r.__decorate([m.subclass(v)],e.AreaMeasurement3DPathHelper);const V=new d;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
