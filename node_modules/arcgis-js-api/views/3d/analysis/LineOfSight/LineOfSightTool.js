/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../Color","../../../../analysis/LineOfSightAnalysisObserver","../../../../analysis/LineOfSightAnalysisTarget","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/WatchUpdatingTracking","../../../../geometry/support/lineSegment","../../../../support/elevationInfoUtils","../../../../symbols/support/ElevationInfo","./LineOfSightRayIntersector","./LineOfSightToolConfiguration","./lineOfSightToolUtils","../../interactive/visualElements/LaserlineVisualElement","../../webgl-engine/lib/IntersectorInterfaces","../../../input/ViewEvents","../../../interactive/AnalysisToolBase","../../../interactive/dragEventPipeline","../../../interactive/interfaces","../../../support/screenUtils","../../../input/IViewEvents"],(function(e,t,n,i,a,r,o,s,l,u,c,h,p,d,g,_,v,f,y,b,m,T,M,L,S,C,w,O,k,V){"use strict";var E;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(E||(E={})),e.LineOfSightTool=function(e){function n(t){var n;return(n=e.call(this,t)||this).removeIncompleteOnCancel=!1,n.configuration=new m.LineOfSightToolConfiguration,n.analysisViewData=null,n._latestPointerMovePointerType=null,n._laserlineVisualElement=null,n._grabbedManipulator=null,n._analysisHandles=new o,n._handles=new o,n._updatingHandles=new _.WatchUpdatingTracking,n._manipulatorHandles=new o,n._targetTrackerManipulator=null,n}t._inherits(n,e);var c=n.prototype;return c.initialize=function(){this._intersector=new b.LineOfSightRayIntersector({view:this.view}),this._handles.add(u.watch((()=>this.state),(e=>{e===E.Created&&this.finishToolCreation()}),u.syncAndInitial)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([this._updatingHandles.add((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle())),this._updatingHandles.add((()=>this.analysisViewData?.elevationAlignedObserver),(e=>this._onObserverLocationChange(e)),u.initial),this._updatingHandles.add((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements()),u.initial),this._updatingHandles.add((()=>this._laserLineRendererDependencies()),(e=>this._updateLaserLineRenderer(e))),this._connectComputations(),this._updatingHandles.addWhen((()=>!this._shouldRenderTracker),(()=>this._clearCursorTracker()),u.initial)])},c.destroy=function(){this._updatingHandles=l.destroyMaybe(this._updatingHandles),this._handles=l.destroyMaybe(this._handles),this._manipulatorHandles=l.destroyMaybe(this._manipulatorHandles),this._analysisHandles=l.destroyMaybe(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)},c.continue=function(){this.view.activeTool=this},c.stop=function(){this.view.activeTool=null},c.onEditableChange=function(){this.analysisViewData.editable=this.internallyEditable},c.onInputEvent=function(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}},c.onInputEventAfter=function(e){if("immediate-click"===e.type)this._clickHandler(e)},c.onShow=function(){},c.onHide=function(){},c.onDeactivate=function(){this._clearCursorTracker()},c._connectComputations=function(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})},c._onComputationsCollectionChange=function({added:e,removed:t}){for(const n of t)this._disconnectComputation(n);for(const n of e)this._connectComputation(n)},c._connectComputation=function(e){if(this.destroyed)return void s.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const n=this._createTargetManipulator(e.target);null==this._targetTrackerManipulator&&n.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=n,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([this._updatingHandles.add((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(n,e)),u.initial),this._updatingHandles.add((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,n)),u.initial)],e)},c._disconnectComputation=function(e){if(this.destroyed)return void s.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);null!=t&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),null!=this._targetTrackerManipulator&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))},c._clearCursorTracker=function(){this.analysisViewData.cursorTarget=l.destroyMaybe(this.analysisViewData.cursorTarget)},c._createManipulator=function(e,t,n){const i=T.createSphereManipulator(this.view,e);return i.metadata=n,this._manipulatorHandles.add([t(i),i.events.on("grab-changed",(e=>this._manipulatorGrabChanged(i,e))),i.events.on("immediate-click",(e=>this._manipulatorClick(i,e)))],i),this.manipulators.add(i),i},c._createTargetManipulator=function(e){const t=this.configuration,n={size:t.target.size,customColor1:t.target.visibleColor,customColor2:t.target.occludedColor,customColor3:t.target.undefinedColor,visible:!0},i={target:e,type:"target"},a=this._createManipulator(n,(e=>this._createTargetManipulatorDragPipeline(e)),i);return null!=e.position?a.elevationAlignedLocation=e.position:a.available=!1,a},c._getTargetManipulator=function(e){let t=null;return this.manipulators.forEach((n=>{const i=n.manipulator;null==t&&"target"===i.metadata.type&&i.metadata.target===e&&(t=i)})),t},c._createObserverManipulator=function(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),{type:"observer",intersection:null})},c._updateObserverManipulatorStyle=function(){const e=this._observerManipulator,t=this.configuration.observer,n={size:t.size,color:t.color,visible:e.available};e.renderObjects=T.createSphereManipulatorRenderObjects(n)},c._screenToIntersection=function(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return null==t?null:{...e,intersection:t}}},c._createTargetManipulatorDragPipeline=function(e){return w.createManipulatorDragEventPipeline(e,((t,n,i)=>{n.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelTargetDragStep(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))},c._createObserverManipulatorDragPipeline=function(e){return w.createManipulatorDragEventPipeline(e,((e,t,n)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),n.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))},c._updateObserverDragStep=function(){return e=>(null!=e.intersection.mapPoint?(null==this.analysis.observer&&(this.analysis.observer=new a),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)},c._cancelObserverDragStep=function(){const e=null!=this.analysis.observer&&null!=this.analysis.observer.position?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)},c._updateTargetDragStep=function(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const n=t.intersection.mapPoint;return null!=n&&(e.elevationAlignedLocation=n),t}},c._cancelTargetDragStep=function(e){const t=l.applySome(e.position,(e=>e.clone()));return n=>(e.position=t,n)},c._manipulatorGrabChanged=function(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}},c._updateManipulatorState=function(e,t){const{isValid:n,isTargetVisible:i}=t.computationResult;e.state=n?i?O.ManipulatorStateCustomFlags.Custom1:O.ManipulatorStateCustomFlags.Custom2:O.ManipulatorStateCustomFlags.Custom3},c._getLineOfSightManipulatorStateDependencies=function(e){const{isValid:t,isTargetVisible:n}=e.computationResult;return{isValid:t,isTargetVisible:n}},c._laserLineRendererDependencies=function(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:null!=this.analysis.observer?this.analysis.observer.position:null,visible:this.visible}},c._updateLaserLineRenderer=function(e=this._laserLineRendererDependencies()){const{laserlineVisualElement:t,grabbedManipulator:n,shouldRenderTracker:i,observerPosition:a,visible:r}=e;if(null==t)return;const o=null!=n?n:i&&null!=a?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&null!=o&&r?(t.visible=!0,t.heightManifoldTarget=o.renderLocation,o!==this._observerManipulator?t.lineVerticalPlaneSegment=v.fromPoints(this._observerManipulator.renderLocation,o.renderLocation,P):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)},c._createVisualElements=function(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new M.LaserlineVisualElement({view:this.view,attached:!0,visible:this.visible,style:{glowColor:i.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:i.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})},c._removeVisualElements=function(){null!=this._laserlineVisualElement&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)},c._onObserverLocationChange=function(e){null!=e?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e):this._observerManipulator.available=!1},c._onTargetLocationChange=function(e,t){null!=e?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1},c._addPointFromClickEvent=function(e){const t=this._intersector.getScreenPointIntersection(e);if(null!=t&&null!=t.mapPoint)if(null!=this.analysis.observer&&null!=this.analysis.observer.position){this._clearCursorTracker();const e=new r;this._updateFromIntersection(e,t),this.analysis.targets.add(e)}else{const e=new a;this._updateFromIntersection(e,t),this.analysis.observer=e}},c._clickHandler=function(e){this.active&&e.button!==V.MouseButton.Right&&(this._addPointFromClickEvent(k.createScreenPointFromEvent(e)),e.stopPropagation())},c._doubleClickHandler=function(e){this.active&&e.button!==V.MouseButton.Right&&(this.stop(),e.stopPropagation())},c._keyDownHandler=function(e){this.active&&"Escape"===e.key&&(this.stop(),e.stopPropagation())},c._pointerMoveHandler=function(e){if(this.hasGrabbedManipulators)return;if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||null==this.analysis.observer||null==this.analysis.observer.position)return;const t=k.createScreenPointFromEvent(e),n=this._intersector.getScreenPointIntersection(t);null!=n&&null!=n.mapPoint&&(null==this.analysisViewData.cursorTarget&&(this.analysisViewData.cursorTarget=new r),this._updateFromIntersection(this.analysisViewData.cursorTarget,n),this._updateLaserLineRenderer())},c._updateFromIntersection=function(e,t){if(null==t.mapPoint)return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case L.IntersectorType.OBJECT:if(null!=t.graphic){const n=t.graphic,i=f.getGraphicEffectiveElevationInfo(n);"on-the-ground"===i.mode&&(i.mode="relative-to-ground",i.offset=0),e.elevationInfo=new y(i),e.feature=n}else e.elevationInfo=null,e.feature=null;break;case L.IntersectorType.TERRAIN:case L.IntersectorType.I3S:e.elevationInfo=new y({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const n=t.mapPoint.clone();n.z=f.getConvertedElevation(this.view,n,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=n},c._manipulatorClick=function(e,t){if("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==V.MouseButton.Right||this.analysis.targets.length<=1)return;const{target:n}=e.metadata;this.analysis.targets.remove(n),t.stopPropagation()},t._createClass(n,[{key:"state",get:function(){return this.active?this.hasGrabbedManipulators?E.Created:E.Creating:null!=this.analysis.observer&&null!=this.analysis.observer.position?E.Created:E.Ready}},{key:"cursor",get:function(){return this.active&&this._showTracker?"crosshair":null}},{key:"updating",get:function(){return null!=this.analysisViewData&&this.analysisViewData.updating||this._updatingHandles.updating}},{key:"_showTracker",get:function(){return this.active&&"mouse"===this._latestPointerMovePointerType}},{key:"_shouldRenderTracker",get:function(){return this._showTracker&&null!=this.analysis.observer&&null!=this.analysis.observer.position&&!this.hasGrabbedManipulators}},{key:"testInfo",get:function(){return{laserLineVisualElement:this._laserlineVisualElement,getTargetManipulator:e=>this._getTargetManipulator(e)}}}]),n}(C.AnalysisToolBase),n.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"view",void 0),n.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"analysis",void 0),n.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"state",null),n.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"cursor",null),n.__decorate([c.property()],e.LineOfSightTool.prototype,"removeIncompleteOnCancel",void 0),n.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"updating",null),n.__decorate([c.property({type:m.LineOfSightToolConfiguration})],e.LineOfSightTool.prototype,"configuration",void 0),n.__decorate([c.property({constructOnly:!0})],e.LineOfSightTool.prototype,"analysisViewData",void 0),n.__decorate([c.property({readOnly:!0})],e.LineOfSightTool.prototype,"_showTracker",null),n.__decorate([c.property()],e.LineOfSightTool.prototype,"_latestPointerMovePointerType",void 0),n.__decorate([c.property()],e.LineOfSightTool.prototype,"_shouldRenderTracker",null),n.__decorate([c.property()],e.LineOfSightTool.prototype,"_laserlineVisualElement",void 0),n.__decorate([c.property()],e.LineOfSightTool.prototype,"_grabbedManipulator",void 0),e.LineOfSightTool=n.__decorate([g.subclass("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],e.LineOfSightTool);const P=v.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
