/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Handles","../../../../core/lang","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../chunks/vec3f64","./lengthDimensionUtils","./settings","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MarkerVisualElement","../../interactive/visualElements/support/Segment"],(function(e,t,n,s,i,l,a,o,m,r,f,u,c,d,h){"use strict";let S=function(){function e(e){this.destroyed=!1,this._handles=new n,this._messages=null,this._labelSegment=new h.EuclideanSegment;const{analysis:t,computation:i,view:l,messages:m}=e;this.analysis=t,this.computation=i,this.view=l,this._messages=m;const r=e.visible,f={view:l,attached:r},{fontSize:S,textColor:g,textBackgroundColor:p}=t.style;this._visualElements=new y({marker:new d.MarkerVisualElement(f,e.markerMaterial),dimension:new c.LineVisualElement(f,e.dimensionLineMaterial),startOffset:new c.LineVisualElement(f,e.offsetLineMaterial),endOffset:new c.LineVisualElement(f,e.offsetLineMaterial),dimensionSmall:new c.LineVisualElement(f,e.smallDimensionLineMaterial),startOffsetSmall:new c.LineVisualElement(f,e.smallOffsetLineMaterial),endOffsetSmall:new c.LineVisualElement(f,e.smallOffsetLineMaterial),label:new u.LabelVisualElement({view:l,attached:r,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:o.pt2px(S),textColor:g.clone(),backgroundColor:p.clone()})}),this._handles.add([a.watch((()=>i.geometry),(e=>{this.updateCameraDependentElements(l.state.camera,e,t.style),null!=i.geometry&&this._updateLines(i.geometry)}),{...a.initial,equals:s.equals}),a.watch((()=>i.length),(e=>this._updateLabelContent(e)),a.initial)])}var m=e.prototype;return m.destroy=function(){this.destroyed=!0,this._handles=i.destroyMaybe(this._handles);for(const e of this._visualElements.values())e.destroy()},m._updateLines=function(e){const t=r.computeSpanningSegment(p,r.OffsetSegmentLocation.Start,e.directSegment,e.dimensionSegment),n=r.computeSpanningSegment(v,r.OffsetSegmentLocation.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(t),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(t),s.endOffsetSmall.setGeometryFromSegment(n)},m.updateCameraDependentElements=function(e,t,n){const s=this._visualElements;if(null==t){for(const e of s.values())e.visible=!1;return}const i=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,b)),l=r.maxScreenLengthSquaredFromGeometry(t,i),a=l<(o.pt2px(n.lineSize)*f.settings.smallScreenLengthLineSizeFactor)**2,m=!a;s.marker.visible=m,s.dimension.visible=m,s.startOffset.visible=m,s.endOffset.visible=m,s.dimensionSmall.visible=a,s.startOffsetSmall.visible=a,s.endOffsetSmall.visible=a;const u=o.pt2px(n.fontSize)*f.settings.labels.minScreenLengthFontSizeFactor,{label:c}=s;if(c.visible=l>=u**2,!c.visible)return;const{dimensionSegment:d,primaryOffsetAxis:h}=t,{offset:S}=this.computation.dimension,p=(Math.sign(S)>=0?1:-1)*g(n)*i;r.offsetSegment(this._labelSegment,d,h,p),c.updateLabelPosition()},m.updateLabelStyle=function(e){const{label:t}=this._visualElements;t.fontSize=o.pt2px(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor},m.updateUnitsMessages=function(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)},m._updateLabelContent=function(e){const{label:t}=this._visualElements;null!=e&&null!=this._messages?t.text=l.formatDecimal(this._messages,e,e.unit):t.text=""},t._createClass(e,[{key:"visible",set:function(e){for(const t of this._visualElements.values())t.attached=e}},{key:"testInfo",get:function(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}}]),e}();function g(e){return 1.5*o.pt2px(e.fontSize)+f.settings.labels.marginPx+o.pt2px(e.lineSize/2)}const p=new h.EuclideanSegment,v=new h.EuclideanSegment,b=m.create();let y=function(){function e(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}return e.prototype.values=function(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]},t._createClass(e)}();e.LengthDimensionVisualElements=y,e.LengthDimensionVisualization=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
