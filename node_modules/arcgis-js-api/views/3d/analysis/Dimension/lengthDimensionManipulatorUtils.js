/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../Color","../../../../geometry","../../../../analysis/dimensionUtils","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/support/plane","../../../../geometry/support/vectorStacks","../../../../layers/graphics/hydratedFeatures","./lengthDimensionUtils","./settings","../../interactive/Manipulator3D","../../interactive/manipulatorUtils","../../interactive/RenderObject","../../interactive/editingTools/dragEventPipeline3D","../../interactive/visualElements/support/Segment","../../support/engineContent/marker","../../webgl-engine/lib/GeometryUtil","../../../interactive/dragEventPipeline","../../../interactive/interfaces","../../../../geometry/Point"],(function(e,t,n,r,a,i,o,s,c,l,u,d,p,m,f,g,h,M,y,S,v,T,P,D,x,R,H){"use strict";let O=function(){function e(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}var n=e.prototype;return n.manipulatorName=function(e){return Object.keys(this).find((t=>this.hasOwnProperty(t)&&e===this[t]))},n.values=function(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]},n.forEachMeasureTypeManipulator=function(e){for(const t of a.lengthDimensionMeasureType)e(this.manipulatorForMeasureType(t),t)},n.manipulatorForMeasureType=function(e){switch(e){case a.LengthDimensionMeasureType.Direct:return this.direct;case a.LengthDimensionMeasureType.Horizontal:return this.horizontal;case a.LengthDimensionMeasureType.Vertical:return this.vertical}},t._createClass(e)}();function F(e,t){const r=y.createSphereManipulator(e,n.toUnitRGBA(h.settings.pointManipulators.color),ae);return r.available=!1,r.grabCursor="crosshair",r.radius=h.settings.pointManipulators.radius,r.metadata=t.metadata,r.collisionPriority=1,r}function w(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],{lengthFraction:r}=h.settings.offsetManipulator,a=D.createPolylineGeometry(t.unfocusedMaterial,n.map((e=>u.scale(d.create(),e,r)))),i=a.instantiate({material:t.focusedMaterial});return new M.Manipulator3D({view:e,renderObjects:[new S.RenderObject(a,R.ManipulatorStateFlags.Unfocused|R.ManipulatorStateFlags.Selected|ae),new S.RenderObject(i,R.ManipulatorStateFlags.Focused|ae)],collisionType:{type:"line",paths:[n]},radius:re(t.lineSizePt)/2,metadata:t.metadata,available:!1,...y.worldScaledManipulatorSettings})}function E(e,{lineSizePt:t,material:r}){const{calloutOffsetPx:a,calloutWidth:i,discScale:o,focusMultiplier:c,color:l}=h.settings.orientationManipulator;return{calloutLength:.25*P.MARKER_SIZE_PER_LINE_WIDTH*h.settings.markers.lineSizeFraction*s.pt2px(t)+a,calloutColor:n.toUnitRGBA(l),calloutWidth:i,customStateMask:ae,discScale:o,focusMultiplier:c,material:r,metadata:e}}function C(e,t){return y.createRotateManipulator(e,E(t.metadata,t))}function b(e,t){y.updateRotateManipulator(e,E(e.metadata,t))}function U(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],{lengthFraction:r}=h.settings.offsetManipulator,a=D.createPolylineGeometry(t.thinOffsetManipulatorMaterial,n),i=D.createPolylineGeometry(t.unfocusedMaterial,n.map((e=>u.scale(d.create(),e,r)))),o=i.instantiate({material:t.focusedMaterial});return new M.Manipulator3D({view:e,renderObjects:[new S.RenderObject(i,R.ManipulatorStateFlags.Unfocused|ae),new S.RenderObject(o,R.ManipulatorStateFlags.Focused|ae),new S.RenderObject(a,ae)],collisionType:{type:"line",paths:[n]},radius:re(t.lineSizePt)/2,available:!1,metadata:t.metadata,...y.worldScaledManipulatorSettings})}function A(e,{isStart:t,createSnappingPipelineStep:n,dimension:r,onUpdate:a,view:i}){const o=t?"startPoint":"endPoint",s=x.createManipulatorDragEventPipeline(e,((e,t,s,c)=>{const l=v.hideManipulatorWhileDragging(e),{snappingStep:u,cancelSnapping:d}=n(c);s=s.next(l).next(x.resetProperties(r,[o,"measureType","orientation"])).next(d),t.next(l).next(v.screenToMap3D(i)).next(...u).next((e=>{const t=f.clonePoint(e.mapEnd,new H);a("startPoint"===o?{startPoint:t}:{endPoint:t})}))}));return[s]}function G(e,{computation:t,view:n}){return[x.createManipulatorDragEventPipeline(e,((e,r,a)=>{if(!g.isValidComputation(t)||!e.selected)return;const{geometry:i,dimension:o}=t,s=v.hideManipulatorWhileDragging(e);r.next(s).next(B(n,o,i.dimensionSegment,i.primaryOffsetAxis)),a.next(s).next(x.resetProperties(o,["offset"]))}))]}function L(e,{computation:t,view:n}){return[x.createManipulatorDragEventPipeline(e,((e,r,a)=>{z({cancel:a,computation:t,settingHeading:!0,steps:r,view:n})}))]}function k(e,{computation:t,view:n}){return[x.createManipulatorDragEventPipeline(e,((e,r,a)=>{z({cancel:a,computation:t,settingHeading:!1,steps:r,view:n})})),e.events.on("immediate-click",(e=>{j(e,t,n)}))]}function j(e,t,n){const{dimension:r,geometry:a}=t;if(90===r.orientation||270===r.orientation)return r.orientation=0,void e.stopPropagation();if(null==a)return;const{renderCoordsHelper:o}=n,s=g.computeGeometryFromDimension({...g.computationToGeometryDependencies(t),orientation:90},o),c=g.computeGeometryFromDimension({...g.computationToGeometryDependencies(t),orientation:270},o);if(null==s||null==c)return;const l=g.headingFromGeometry(s,o),u=g.headingFromGeometry(c,o),d=I(a,n),p=i.cyclicalDegrees.shortestSignedDiff(d,l),m=i.cyclicalDegrees.shortestSignedDiff(d,u);r.orientation=Math.abs(p)<Math.abs(m)?90:270,e.stopPropagation()}function z(e){const{cancel:t,computation:n,settingHeading:r,steps:a,view:i}=e;if(!g.isValidComputation(n))return;const{renderCoordsHelper:s}=i,{dimension:c,geometry:l}=n,f=d.create(),h=X(d.create(),l,l.directSegment,s),M=Y(m.sv3d.get(),{forHeading:r,geometry:l,renderCoordsHelper:s}),S=p.fromPositionAndNormal(h,M,p.create()),T=r?c.orientation??g.headingFromGeometry(l,i.renderCoordsHelper):c.orientation??0;a.next(v.screenToRenderPlane(i,S)).next((e=>{"start"===e.action&&u.copy(f,e.renderStart);const t=p.normal(S),n=y.calculateInputRotationTransform(f,e.renderEnd,h,t);let a=T-o.rad2deg(n);r||(a=V(a)),c.orientation=a})),t.next(x.resetProperties(c,["orientation"]))}function V(e){const t=i.cyclicalDegrees.normalize(e)%90;return t<h.settings.orientationSnapThresholdDegrees?e-t:90-t<h.settings.orientationSnapThresholdDegrees?e+(90-t):e}function W(e,{computation:t,manipulatorMeasureType:n,view:r}){let i=a.LengthDimensionMeasureType.Direct,o=0,s=0;return[e.events.on("grab-changed",(a=>{if("start"!==a.action||!g.isValidComputation(t))return;const{dimension:c,geometry:l}=t;i=c.measureType,o=c.offset,s=c.orientation;const d=u.copy(m.sv3d.get(),e.renderLocation);c.measureType=n,c.offset=g.computeOffsetForPoint(d,n,l,r.renderCoordsHelper),c.orientation=0})),x.createManipulatorDragEventPipeline(e,((e,a,c)=>{if(!g.isValidComputation(t))return;const{geometry:l,dimension:u}=t,{renderCoordsHelper:d}=r,p=g.computeSegmentForMeasureType(ce,n,t,d),f=g.computeOffsetAxis(m.sv3d.get(),{measureType:n,directSegment:l.directSegment,renderCoordsHelper:d}),h=v.hideManipulatorWhileDragging(e);a.next(h).next(B(r,u,p,f)),c.next(h).next((e=>(u.measureType=i,u.offset=o,u.orientation=s,e)))}))]}function B(e,t,n,r){const a=u.subtract(m.sv3d.get(),n.endRenderSpace,n.startRenderSpace);u.cross(a,a,r);const i=p.fromPositionAndNormal(n.startRenderSpace,a,p.create()),o=p.fromPositionAndNormal(n.startRenderSpace,r,p.create()),s=t.offset;let c,l=0;const d=new x.EventPipeline;return d.next(v.screenToRenderPlane(e,i)).next((n=>{"start"===n.action&&(l=p.signedDistance(o,n.renderStart));const r=(p.signedDistance(o,n.renderEnd)-l)*e.renderCoordsHelper.unitInMeters;t.offset=s+r,c=n})),e=>(d.execute(e),c)}function I(e,t){const{directSegment:n}=e,{renderCoordsHelper:r}=t,a=g.directUp(m.sv3d.get(),e,r),i=g.directStartToEnd(m.sv3d.get(),e),o=u.cross(m.sv3d.get(),i,a),{viewForward:s}=t.state.camera;u.dot(o,s)>0&&u.scale(o,o,-1);const c=n.eval(.5,m.sv3d.get());return r.headingAtPosition(c,o)}function N(e,t,n){const{dimensionSegment:r,primaryOffsetAxis:a}=t,i=g.dimensionStartToEnd(ie,t),o=u.exactEquals(i,d.ZEROS)?c.identity(se):y.calculateTranslateRotateFromBases(i,a,d.ZEROS,se),s=Math.max(u.length(i),h.settings.offsetManipulator.minLengthMeters/n.unitInMeters);c.scale(o,o,u.set(ie,s,s,s)),e.modelTransform=o,e.renderLocation=r.eval(.5,ie)}function _(e,t,n){q(e,t,n,{forHeading:!0})}function Z(e,t,n){q(e,t,n,{forHeading:!1})}function q(e,t,n,{forHeading:r}){const{dimension:a,geometry:i}=t,{primaryOffsetAxis:o}=i,s=u.scale(K,o,a.offset>=0?1:-1),c=Y(J,{forHeading:r,geometry:i,renderCoordsHelper:n});u.cross(c,c,s);const l=y.calculateTranslateRotateFromBases(s,c,d.ZEROS,se);e.modelTransform=l,e.renderLocation=X(ie,i,i.dimensionSegment,n)}const K=d.create(),J=d.create();function Q(e,t,n,r){const{geometry:a}=t,i=g.computeSegmentForMeasureType(ce,n,t,r),o=g.computeOffsetAxis(ie,{measureType:n,directSegment:a.directSegment,renderCoordsHelper:r}),s=u.sub(oe,i.endRenderSpace,i.startRenderSpace),l=y.calculateTranslateRotateFromBases(s,o,d.ZEROS,se),p=u.length(s);c.scale(l,l,u.set(oe,p,p,p)),e.modelTransform=l,e.renderLocation=i.eval(.5,oe)}function X(e,t,n,r){const{startRenderSpace:a,endRenderSpace:i}=n,o=$(t,r)?a:i;return u.copy(e,o)}function Y(e,{forHeading:t,geometry:n,renderCoordsHelper:r}){return t?g.directUp(e,n,r):g.dimensionStartToEnd(e,n,{invert:!0})}function $(e,t){const n=g.directStartToEnd(ee,e),r=g.directUp(te,e,t);return u.dot(n,r)>0}const ee=d.create(),te=d.create();function ne(e){return s.pt2px(e)+h.settings.offsetManipulator.linePaddingPx}function re(e){return s.pt2px(e)+h.settings.offsetManipulator.focusedLinePaddingPx}const ae=R.ManipulatorStateCustomFlags.Custom1,ie=d.create(),oe=d.create(),se=l.create(),ce=new T.EuclideanSegment;e.DidPointerMoveRecentlyFlag=ae,e.LengthDimensionManipulators=O,e.automaticHeadingFromCamera=I,e.createMeasureTypeManipulator=U,e.createOffsetManipulator=w,e.createOrientationManipulator=C,e.createPointManipulator=F,e.focusedOffsetWidth=re,e.headingManipulatorHandles=L,e.measureTypeManipulatorHandles=W,e.offsetManipulatorHandles=G,e.pointManipulatorHandles=A,e.rotationManipulatorHandles=k,e.snapOrientationToNearestRightAngle=V,e.unfocusedOffsetWidth=ne,e.updateHeadingManipulatorTransform=_,e.updateMeasureTypeManipulatorTransform=Q,e.updateOffsetManipulatorTransform=N,e.updateOrientationManipulator=b,e.updateRotationManipulatorTransform=Z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
