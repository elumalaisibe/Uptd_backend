/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/clock","../../../../core/handleUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/vectorStacks","./lengthDimensionManipulatorUtils","./LengthDimensionSubTool","./settings","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../../interactive/AnalysisToolBase","../../../interactive/keybindings","../../../support/screenUtils"],(function(e,t,o,i,n,s,r,a,l,c,u,p,h,d,m,v,_,y,T,S,D){"use strict";var g;!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(g||(g={})),e.DimensionTool=function(e){function o(t){var o;return(o=e.call(this,t)||this).automaticManipulatorSelection=!1,o.removeIncompleteOnCancel=!1,o._pointerMoveTimerMs=v.settings.pointerMoveTimeoutMs,o._prevPointerMoveTimeout=null,o}t._inherits(o,e);var a=o.prototype;return a.initialize=function(){this._intersector=_.newIntersector(this.view.state.viewingMode),this._intersector.options.store=y.StoreResults.MIN,this._lengthDimensionSubTool=new m.LengthDimensionSubTool({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([n.destroyHandle(this._lengthDimensionSubTool),n.makeHandle((()=>this._clearPointerMoveTimeout())),r.watch((()=>this.state),(e=>{e===g.Created&&this.finishToolCreation()}),r.syncAndInitial),r.when((()=>this.firstGrabbedManipulator),(e=>{this.selectedDimension=e.metadata}),r.syncAndInitial),r.watch((()=>this.selectedDimension),(()=>this._resetPointerMoveTimeout()),r.syncAndInitial)])},a.onInputEvent=function(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":if(S.SKETCH_KEYS.cancel===e.key){if(null!=this._activeSubTool&&this._activeSubTool.removeStaged())return void e.stopPropagation();this.active||(this.selectedDimension=null)}else S.SKETCH_KEYS.delete.includes(e.key)&&this._deleteKeyHandler()}},a.onActivate=function(){this._activeSubTool=this._lengthDimensionSubTool},a.onDeactivate=function(){null!=this._activeSubTool&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)},a.onShow=function(){this._resetPointerMoveTimeout()},a.onManipulatorSelectionChanged=function(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()},a.onHide=function(){this.selectedDimension=null},a._clickHandler=function(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(null==this._activeSubTool)return;const t=this._intersectScreen(e);null!=t&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),e.stopPropagation())},a._doubleClickHandler=function(e){this.active&&(this.view.activeTool=null,e.stopPropagation())},a._pointerMoveHandler=function(e){if(this._resetPointerMoveTimeout(),null==this._activeSubTool)return;if(this.hasFocusedManipulators)return;const t=this._intersectScreen(e);null!=t&&this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})},a._deleteKeyHandler=function(){null!=this._activeSubTool&&this._activeSubTool.removeStaged(),this._removeSelected()},a._intersectScreen=function(e){const t=D.createScreenPointArrayFromEvent(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const o=this._intersector.results.min,i=h.sv3d.get();return o.getIntersectionPoint(i)?this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference):null},a._removeSelected=function(){null!=this.selectedDimension&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)},a._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout=s.removeMaybe(this._prevPointerMoveTimeout)},a._resetPointerMoveTimeout=function(){this._clearPointerMoveTimeout(),this.manipulators.forEach((e=>{e.manipulator.state|=d.DidPointerMoveRecentlyFlag})),this._prevPointerMoveTimeout=i.clock.setTimeout((()=>{this.manipulators.forEach((e=>{e.manipulator.state&=~d.DidPointerMoveRecentlyFlag}))}),this._pointerMoveTimerMs)},t._createClass(o,[{key:"state",get:function(){return this.analysis.dimensions.some((e=>"length"===e.type))?null!=this._activeSubTool?g.Creating:g.Created:g.Ready}},{key:"updating",get:function(){return this._lengthDimensionSubTool.updating}},{key:"cursor",get:function(){return this.active?"crosshair":null}},{key:"selectedDimension",get:function(){return this.analysisViewData.selectedDimension},set:function(e){this.analysisViewData.selectedDimension=e}},{key:"testInfo",get:function(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:e=>{this._pointerMoveTimerMs=e,this._resetPointerMoveTimeout()}}}}]),o}(T.AnalysisToolBase),o.__decorate([a.property({constructOnly:!0})],e.DimensionTool.prototype,"view",void 0),o.__decorate([a.property({constructOnly:!0})],e.DimensionTool.prototype,"analysis",void 0),o.__decorate([a.property({readOnly:!0})],e.DimensionTool.prototype,"state",null),o.__decorate([a.property({readOnly:!0})],e.DimensionTool.prototype,"updating",null),o.__decorate([a.property({readOnly:!0})],e.DimensionTool.prototype,"cursor",null),o.__decorate([a.property({constructOnly:!0})],e.DimensionTool.prototype,"analysisViewData",void 0),o.__decorate([a.property()],e.DimensionTool.prototype,"selectedDimension",null),o.__decorate([a.property()],e.DimensionTool.prototype,"automaticManipulatorSelection",void 0),o.__decorate([a.property()],e.DimensionTool.prototype,"_activeSubTool",void 0),o.__decorate([a.property()],e.DimensionTool.prototype,"_lengthDimensionSubTool",void 0),e.DimensionTool=o.__decorate([p.subclass("esri.views.3d.analysis.Dimension.DimensionTool")],e.DimensionTool),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
