/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../Color","../../../../geometry","../../../../analysis/SlicePlane","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../chunks/mat4","../../../../chunks/mat4f64","../../../../chunks/quat","../../../../chunks/vec3","../../../../chunks/vec3f64","../../../../geometry/projection","../../../../geometry/support/Axis","../../../../chunks/boundedPlane","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","./settings","./sliceToolConfig","../support/projectionUtils","../../interactive/Manipulator3D","../../interactive/manipulatorUtils","../../interactive/RenderObject","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/SlicePlaneVisualElement","../../support/RenderCoordsHelper","../../support/geometryUtils/ray","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Material","../../webgl-engine/materials/ColorMaterial","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/RibbonLineMaterial","../../../interactive/interfaces","../../../../geometry/Extent"],(function(e,t,n,o,i,a,r,s,l,c,d,u,g,R,T,p,E,S,m,A,_,b,f,I,O,h,v,L,P,C,F,N,M,H,y,w,U,D){"use strict";function V(e,t,n,o,i,a,r,s){return G(t,r.worldUpAtPosition(e,A.sv3d.get()),i,a,s.basis1,s.basis2),u.scale(s.basis1,s.basis1,n),u.scale(s.basis2,s.basis2,o),u.copy(s.origin,e),E.fromVectorsAndPoint(s.basis2,s.basis1,s.origin,s.plane),s}function G(t,n,o,i,a,r){const s=u.dot(t,n),l=A.sv3d.get(),c=A.sv3d.get();switch(i===e.SliceOrientation.HORIZONTAL_OR_VERTICAL?Math.abs(s)>b.VERTICAL_DOT_THRESHOLD?e.SliceOrientation.HORIZONTAL:e.SliceOrientation.VERTICAL:i){case e.SliceOrientation.VERTICAL:{const e=Math.abs(s)<=b.SMALL_ANGLE_DOT_THRESHOLD?t:o.viewUp;u.cross(l,e,n),u.copy(c,n);break}case e.SliceOrientation.HORIZONTAL:u.cross(l,o.viewUp,n),u.cross(c,n,l);break;case e.SliceOrientation.TILTED:{const e=Math.abs(s)<=b.SMALL_ANGLE_DOT_THRESHOLD?n:o.viewUp;u.cross(l,e,t),u.cross(c,t,l);break}}const d=u.cross(A.sv3d.get(),l,c);u.dot(d,o.viewForward)>0&&u.scale(c,c,-1),u.normalize(a,l),u.normalize(r,c)}function j(e,t,n){const o=t.worldUpAtPosition(e.origin,A.sv3d.get()),i=e.basis1,a=Re(e,o),r=Math.round(a/Ie)*Ie;return p.rotate(e,r-a,i,n)}function x(e,t,n,o,i,a){const r=u.copy(A.sv3d.get(),i.origin);u.add(r,r,u.scale(A.sv3d.get(),i.basis1,e.direction[0]<0?1:-1)),u.add(r,r,u.scale(A.sv3d.get(),i.basis2,e.direction[1]<0?1:-1));const s=u.length(i.basis1),l=u.length(i.basis2),c=u.subtract(A.sv3d.get(),n,r),d=u.subtract(A.sv3d.get(),t,r);let g=0,R=0;if(ne(e)){const t=te(i),n=te(a);g=s-.5*e.direction[0]*u.dot(i.basis1,d)/s,R=l-.5*e.direction[1]*u.dot(i.basis2,d)/l;const o=n/t;g*=o,R*=o}const T=g+.5*e.direction[0]*u.dot(i.basis1,c)/s,E=R+.5*e.direction[1]*u.dot(i.basis2,c)/l,S=u.scale(A.sv3d.get(),i.basis1,T/s),m=u.scale(A.sv3d.get(),i.basis2,E/l);(T<=0||K(a.origin,S,o)<=b.PLANE_MIN_BASIS_SCREEN_LEN2)&&u.copy(S,a.basis1),(E<=0||K(a.origin,m,o)<=b.PLANE_MIN_BASIS_SCREEN_LEN2)&&u.copy(m,a.basis2);const _=u.copy(A.sv3d.get(),r);return u.add(_,_,u.scale(A.sv3d.get(),S,e.direction[0]<0?-1:1)),u.add(_,_,u.scale(A.sv3d.get(),m,e.direction[1]<0?-1:1)),p.fromValues(_,S,m,a)}function B(e,t){return b.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function z(e,t,n,o){const i=u.cross(A.sv3d.get(),t,n);return u.cross(i,i,t),E.fromPositionAndNormal(e,i,o)}function Z(e,t){return O.calculateTranslateRotateFromBases(e.basis1,e.basis2,e.origin,t)}function k(t,n,o,i){const a=n.worldUpAtPosition(t.origin,A.sv3d.get()),r=A.sv3d.get();switch(o){case e.RotationAxis.HEADING:u.copy(r,a);break;case e.RotationAxis.TILT:u.copy(r,t.basis1)}return E.fromPositionAndNormal(t.origin,r,i)}function W(e,t,n,o){const i=J(n,$.NEGATIVE_X),a=A.sm4d.get();l.rotateZ(a,t,i.edge*Math.PI/2);const r=u.normalize(A.sv3d.get(),i.basis);let c=u.scale(A.sv3d.get(),r,i.direction*o.computeScreenPixelSizeAt(i.position)*b.SHIFT_RESTART_OFFSET_DISTANCE);u.add(c,c,i.position);const d=o.projectToRenderScreen(c,s.castRenderScreenPointArray3(A.sv3d.get())),R=X(o,d);C.fromRender(o,d,fe),u.normalize(fe.direction,fe.direction);const T=A.sv3d.get();!R&&p.intersectRay(n,fe,T)&&(c=T),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=g.clone(c),R?e.state|=be:e.state&=~be}function X(e,t){const[n,o,i,a]=e.viewport,r=Math.min(i,a)/16;let s=!0;return t[0]<n+r?(t[0]=n+r,s=!1):t[0]>n+i-r&&(t[0]=n+i-r,s=!1),t[1]<o+r?(t[1]=o+r,s=!1):t[1]>o+a-r&&(t[1]=o+a-r,s=!1),s}function Y(e,t,n,o){const i=u.length(o.basis1),a=u.length(o.basis2),r=ee(o),s=te(o),c=u.set(A.sv3d.get(),0,0,0);u.add(c,u.scale(A.sv3d.get(),o.basis1,t.direction[0]),u.scale(A.sv3d.get(),o.basis2,t.direction[1])),u.add(c,o.origin,c);let d=0,g=1;if(ne(t))1===t.direction[0]&&-1===t.direction[1]?d=Ie:1===t.direction[0]&&1===t.direction[1]?d=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(d=3*Math.PI/2),g=s;else{const e=0!==t.direction[0]?1:2;d=1===e?Ie:0,g=(1===e?a:i)-r}const R=l.fromZRotation(A.sm4d.get(),d);l.scale(R,R,u.set(A.sv3d.get(),g,g,g)),l.multiply(R,n,R),R[12]=0,R[13]=0,R[14]=0,e.modelTransform=R,e.renderLocation=c}function q(e,t,n,o){const i=o.worldUpAtPosition(n.origin,A.sv3d.get()),a=J(n,$.POSITIVE_X),r=l.fromZRotation(A.sm4d.get(),a.edge*Math.PI/2);l.rotateX(r,r,-Re(n,i)),l.multiply(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=a.position}function Q(e,t,n){const o=J(n,$.POSITIVE_Y),i=l.fromZRotation(A.sm4d.get(),o.edge*Math.PI/2);l.rotateX(i,i,Ie),l.multiply(i,t,i),i[12]=0,i[13]=0,i[14]=0,e.modelTransform=i,e.renderLocation=o.position}var $;function J(e,t){switch(t){case $.POSITIVE_X:return{basis:e.basis1,direction:1,position:u.add(A.sv3d.get(),e.origin,e.basis1),edge:t};case $.POSITIVE_Y:return{basis:e.basis2,direction:1,position:u.add(A.sv3d.get(),e.origin,e.basis2),edge:t};case $.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:u.subtract(A.sv3d.get(),e.origin,e.basis1),edge:t};case $.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:u.subtract(A.sv3d.get(),e.origin,e.basis2),edge:t}}}function K(e,t,n){const o=n.projectToRenderScreen(u.add(A.sv3d.get(),e,t),s.castRenderScreenPointArray3(A.sv3d.get())),i=n.projectToRenderScreen(u.subtract(A.sv3d.get(),e,t),s.castRenderScreenPointArray3(A.sv3d.get()));return u.squaredLength(u.subtract(o,o,i))}function ee(e){const t=u.length(e.basis1),n=u.length(e.basis2);return b.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(t,n)}function te(e){return ee(e)}function ne(e){return 0!==e.direction[0]&&0!==e.direction[1]}function oe(n,o){const i=o.offsetMode===e.OffsetMode.CENTER_ON_CALLOUT?b.SHIFT_RESTART_OFFSET_DISTANCE:0,a=[g.fromValues(i,0,-b.SHIFT_RESTART_ARROW_LENGTH/2),g.fromValues(i,0,b.SHIFT_RESTART_ARROW_LENGTH/2)],r=de(a,!0),s=(e,t)=>le(a,e,t,o),l=s(0,!1),c=s(b.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0),d=new y.NativeLineMaterial({color:t.toUnitRGBA(o.calloutColor),renderOccluded:M.RenderOccludedFlag.OccludeAndTransparent}),u=N.createPolylineGeometry(d,[[i,0,0],[i-b.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),R=N.createPolylineGeometry(d,[[i,0,0],[i-b.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]);return new I.Manipulator3D({view:n,renderObjects:[...l.normal.map((e=>new h.RenderObject(e,U.ManipulatorStateFlags.Unfocused|me))),...c.normal.map((e=>new h.RenderObject(e,U.ManipulatorStateFlags.Unfocused|me))),new h.RenderObject(u,U.ManipulatorStateFlags.Unfocused|me|be),...l.focused.map((e=>new h.RenderObject(e,U.ManipulatorStateFlags.Focused|me))),...c.focused.map((e=>new h.RenderObject(e,U.ManipulatorStateFlags.Focused|me))),new h.RenderObject(R,U.ManipulatorStateFlags.Focused|me|be)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[r]},collisionPriority:1,radius:b.SHIFT_RESTART_TIP_RADIUS,state:me})}function ie(e,n){const o=O.createRotateManipulator(e,{calloutColor:t.toUnitRGBA(_.settings.callouts.color),customStateMask:me,texture:n});return o.state=me,o}function ae(e){const n=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new v.LineVisualElement({view:e,attached:!1,color:t.toUnitRGBA(_.settings.plane.outlineColor),width:b.PLANE_OUTLINE_WIDTH,renderOccluded:M.RenderOccludedFlag.OccludeAndTransparent,geometry:[n]})}function re(e){return new L.SlicePlaneVisualElement({view:e,attached:!1,backgroundColor:t.toUnitRGBA(_.settings.plane.color),gridColor:t.toUnitRGBA(_.settings.plane.gridColor),gridWidth:4,renderOccluded:M.RenderOccludedFlag.OccludeAndTransparent})}function se(e,n,o){const i=ne(n),a=i?[g.fromValues(1,0,0),g.fromValues(0,0,0),g.fromValues(0,1,0)]:[g.fromValues(1,0,0),g.fromValues(-1,0,0)],r=t.toUnitRGBA(o.color),s=e=>new w.RibbonLineMaterial({color:r,width:e,renderOccluded:M.RenderOccludedFlag.OccludeAndTransparent}),l=()=>new y.NativeLineMaterial({color:r,renderOccluded:M.RenderOccludedFlag.OccludeAndTransparent}),c=i?b.RESIZE_HANDLE_CORNER_WIDTH:b.RESIZE_HANDLE_EDGE_WIDTH,d=c*b.DISPLAY_FOCUS_MULTIPLIER,u=b.RESIZE_HANDLE_EDGE_WIDTH,R=e=>e>1?s(e):l(),T=[new h.RenderObject(N.createPolylineGeometry(R(c),a),U.ManipulatorStateFlags.Unfocused|Oe),new h.RenderObject(N.createPolylineGeometry(R(d),a),U.ManipulatorStateFlags.Focused|Oe),new h.RenderObject(N.createPolylineGeometry(R(u),a),he)],p=new I.Manipulator3D({view:e,renderObjects:T,collisionType:{type:"line",paths:[a]},radius:i?b.RESIZE_HANDLE_CORNER_INPUT_RADIUS:b.RESIZE_HANDLE_EDGE_INPUT_RADIUS,...O.worldScaledManipulatorSettings});return p.state=Oe,p}function le(e,n,o,i){const a=t.blendColors(i.color,i.outlineColor,.4),r=t.blendColors(i.color,i.outlineColor,.14),s=new H.ColorMaterial({color:t.toUnitRGBA(i.color),cullFace:F.CullFaceOptions.Back,renderOccluded:M.RenderOccludedFlag.Opaque}),R=new H.ColorMaterial({color:t.toUnitRGBA(a),cullFace:F.CullFaceOptions.Back,renderOccluded:M.RenderOccludedFlag.Opaque}),T=new H.ColorMaterial({color:t.toUnitRGBA(r),cullFace:F.CullFaceOptions.Back,renderOccluded:M.RenderOccludedFlag.Opaque}),p=new H.ColorMaterial({color:t.toUnitRGBA(i.outlineColor),transparent:!0,writeDepth:!1,cullFace:F.CullFaceOptions.Front,renderOccluded:M.RenderOccludedFlag.Transparent}),E=t=>{const i=e.slice(0),a=u.subtract(A.sv3d.get(),i[0],i[1]);u.normalize(a,a);const r=u.subtract(A.sv3d.get(),i[i.length-1],i[i.length-2]);if(u.normalize(r,r),n>0){const e=u.scale(g.create(),r,-n);i[i.length-1]=u.add(e,e,i[i.length-1]);const t=u.scale(g.create(),a,-n);i[0]=u.add(t,t,i[0])}const E=t?b.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER:1,S=b.SHIFT_RESTART_TIP_LENGTH*E,m=b.SHIFT_RESTART_TIP_RADIUS*E,_=l.identity(A.sm4d.get());if(n>0){const e=S/4,t=u.set(A.sv3d.get(),0,e,0),o=1+n/e;l.translate(_,_,t),l.scale(_,_,u.set(A.sv3d.get(),o,o,o)),l.translate(_,_,u.scale(t,t,-1/o))}const f=l.identity(c.create()),I=g.fromValues(0,1,0),O=l.fromQuat(c.create(),d.rotationTo(A.sq4d.get(),I,r));O[12]=i[i.length-1][0],O[13]=i[i.length-1][1],O[14]=i[i.length-1][2],l.multiply(O,O,_);const h=o?p:T,v=ce(b.SHIFT_RESTART_TUBE_RADIUS*(t?b.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER:1)+n,i,h);v.transformation=f;const L=[v],P=o?p:s,C=N.createConeGeometry(P,S,m,24,!1,!1,!0);C.transformation=O,L.push(C);const F=o?p:R,M=N.createConeGeometry(F,S,m,24,!1,!0,!1);M.transformation=O,L.push(M);const H=l.fromQuat(c.create(),d.rotationTo(A.sq4d.get(),I,a));return H[12]=i[0][0],H[13]=i[0][1],H[14]=i[0][2],l.multiply(H,H,_),L.push(C.instantiate({transformation:H})),L.push(M.instantiate({transformation:H})),L};return{normal:E(!1),focused:E(!0)}}function ce(e,t,n){const o=[],i=12;for(let a=0;a<i;a++){const t=a/i*2*Math.PI;o.push([Math.cos(t)*e,Math.sin(t)*e])}return N.createPathExtrusionGeometry(n,o,t,[],[],!1)}function de(e,t){const n=u.subtract(g.create(),e[e.length-1],e[e.length-2]);if(u.normalize(n,n),u.scale(n,n,b.SHIFT_RESTART_TIP_LENGTH),u.add(n,n,e[e.length-1]),t){const t=u.subtract(g.create(),e[0],e[1]);return u.normalize(t,t),u.scale(t,t,b.SHIFT_RESTART_TIP_LENGTH),u.add(t,t,e[0]),[t,...e,n]}return[...e,n]}function ue(e,t,n,i=new o){if(null==e)return null;const{renderCoordsHelper:a}=t,s=a.fromRenderCoords(e.origin,t.spatialReference);if(null==s)return null;const l=R.tryProjectWithZConversion(s,n);if(null==l)return null;i.position=l;const c=2*u.length(e.basis1),d=2*u.length(e.basis2),g=P.RenderCoordsHelper.renderUnitScaleFactor(t.spatialReference,n);i.width=c*g,i.height=d*g;const T=a.worldUpAtPosition(e.origin,A.sv3d.get());return i.tilt=r.rad2deg(Re(e,T)),i.heading=a.headingAtPosition(e.origin,e.basis1)-90,i}function ge(e,t,n){if(null==e)return null;const o=e.origin,i=A.sv3d.get(),a=A.sv3d.get(),r=A.sv3d.get(),s=A.sv3d.get();let l,c,d,g,R,T;u.add(i,o,e.basis1),u.add(i,i,e.basis2),u.add(a,o,e.basis1),u.sub(a,a,e.basis2),u.sub(r,o,e.basis1),u.sub(r,r,e.basis2),u.sub(s,o,e.basis1),u.add(s,s,e.basis2);for(const u of[i,a,r,s]){const e=t.fromRenderCoords(u,u,n);if(null==e)return null;l=null==l?e[0]:Math.min(l,e[0]),c=null==c?e[0]:Math.max(c,e[0]),d=null==d?e[1]:Math.min(d,e[1]),g=null==g?e[1]:Math.max(g,e[1]),R=null==R?e[2]:Math.min(R,e[2]),T=null==T?e[2]:Math.max(T,e[2])}return new D({xmin:l,xmax:c,ymin:d,ymax:g,zmin:R,zmax:T,spatialReference:n})}function Re(e,t){return m.angleAroundAxis(t,e.basis2,e.basis1)+Ie}function Te(e,t,n,o,i,s,l=p.create()){return s.toRenderCoords(e,l.origin)?(s.worldBasisAtPosition(l.origin,T.Axis.X,l.basis1),s.worldBasisAtPosition(l.origin,T.Axis.Y,l.basis2),E.fromVectorsAndPoint(l.basis2,l.basis1,l.origin,l.plane),p.rotate(l,-r.deg2rad(t),p.normal(l),l),p.rotate(l,r.deg2rad(n),l.basis1,l),u.scale(l.basis1,l.basis1,o/2),u.scale(l.basis2,l.basis2,i/2),p.updateUnboundedPlane(l),l):(a.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function pe(e,t){if(null==e||null==e.position)return null;const n=f.applyProjectionAndElevationAlignment(e.position,t.spatialReference,t.elevationProvider);if(null==n)return null;const o=P.RenderCoordsHelper.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),i=e.width*o,a=e.height*o;return{position:n,heading:e.heading,tilt:e.tilt,renderWidth:i,renderHeight:a}}function Ee(e,t,n,o=p.create()){const i=pe(e,t);return null==i?null:Se(i,t,n,o)}function Se(e,t,n,o=p.create()){if(null==e)return null;const i=Te(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,o);return n.tiltEnabled||null==i||j(i,t.renderCoordsHelper,i),i}!function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"}($||($={}));const me=U.ManipulatorStateCustomFlags.Custom1;var Ae,_e;e.RotationAxis=void 0,(Ae=e.RotationAxis||(e.RotationAxis={}))[Ae.HEADING=1]="HEADING",Ae[Ae.TILT=2]="TILT",e.SliceOrientation=void 0,(_e=e.SliceOrientation||(e.SliceOrientation={}))[_e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",_e[_e.HORIZONTAL=1]="HORIZONTAL",_e[_e.VERTICAL=2]="VERTICAL",_e[_e.TILTED=3]="TILTED";const be=U.ManipulatorStateCustomFlags.Custom2,fe=S.create(),Ie=Math.PI/2,Oe=U.ManipulatorStateCustomFlags.Custom1,he=U.ManipulatorStateCustomFlags.Custom2;var ve;function Le(e){return null!=("building-scene-3d"===e.type?e:null)}e.OffsetMode=void 0,(ve=e.OffsetMode||(e.OffsetMode={}))[ve.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",ve[ve.CENTER_ON_ARROW=1]="CENTER_ON_ARROW",e.DidPointerMoveRecentlyFlag=me,e.IsShiftEdgeOnScreenFlag=be,e.addArrowTips=de,e.calculateBoundedPlaneTranslateRotate=Z,e.calculateDiagonalResizeHandleScale=te,e.calculatePlaneHalfSize=B,e.calculateResizeHandlePadding=ee,e.calculateScreenSpaceBasisLength2=K,e.createGridVisualElement=re,e.createOutlineVisualElement=ae,e.createPlane=V,e.createResizeManipulator=se,e.createRotateManipulator=ie,e.createRotatePlane=k,e.createShiftManipulator=oe,e.createShiftPlane=z,e.forceHorizontalOrVertical=j,e.isDiagonalResizeHandle=ne,e.isIBuildingSceneLayerView3D=Le,e.normalToBases=G,e.planeToExtent=ge,e.planeToShape=ue,e.projectAndElevationAlignShape=pe,e.projectedShapeToPlane=Se,e.resizeNormal=Oe,e.resizeOutlineOnly=he,e.resizePlane=x,e.shapeToPlane=Ee,e.updateResizeHandle=Y,e.updateRotateHeadingHandle=q,e.updateRotateTiltHandle=Q,e.updateShiftRestartHandle=W,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
