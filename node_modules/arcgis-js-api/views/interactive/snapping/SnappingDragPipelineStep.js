/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../layers/graphics/dehydratedFeatureComparison","../../../layers/graphics/hydratedFeatures","../../../support/elevationInfoUtils","../dragEventPipeline","./SnappingContext","../../support/Scheduler"],(function(e,n,t,o,i,a,l,r,s,u){"use strict";function c({predicate:e=(()=>!0),snappingManager:i,snappingContext:a,updatingHandles:s,useZ:u=!0}){const c=new r.EventPipeline;if(null==i)return{snappingStep:[m,c],cancelSnapping:m};let y,h=null,b=null,E=null;const T=()=>{h=n.abortMaybe(h),i.doneSnapping(),null!=b&&b.frameTask.remove(),b=null,y=n.removeMaybe(y),E=null},Z=p(i,u,c);let k=null,I=null,w=null;return{snappingStep:[n=>{if(!e(n))return n;const{action:r}=n;if("start"===r){const{info:e}=n,t=d(i.view);if(b=f(a,n,t),b.context.selfSnappingZ=null,!u&&null!=e){const n=S(a.coordinateHelper,e.handle.component);null!=n&&(b.context.selfSnappingZ={value:n,elevationInfo:a.elevationInfo??l.absoluteHeightElevationInfo})}}if(null!=b){const{context:e,originalScenePos:a,originalPos:l}=b,{mapEnd:c,mapStart:p,scenePoints:d}=n,f=g(l,v(c,p)),S=v(p,l),m={...n,action:"update"},T=b.context,z=P(a,d),C=i.update({point:f,scenePoint:z,context:e});if(w=C,x(c,C,S,u),k=f,I=z,"end"!==r){const{frameTask:e}=b;null==h&&(h=new AbortController),E=n=>{s.addPromise(t.ignoreAbortErrors(Z({frameTask:e,event:m,context:T,point:f,scenePoint:z,delta:S,getLastState:()=>({point:k,scenePoint:I,updatePoint:n.forceUpdate?null:w})},h.signal)))},E({forceUpdate:!1}),null==y&&(y=o.watch((()=>i.options.effectiveEnabled),(()=>E?.({forceUpdate:!0}))))}}return"end"===r&&T(),n},c],cancelSnapping:e=>(T(),e)}}function p(e,n,o){return t.debounce((async({frameTask:t,point:a,scenePoint:l,context:r,event:s,delta:u,getLastState:c},p)=>{const d=await t.schedule((()=>e.snap({point:a,scenePoint:l,context:r,signal:p})),p);if(d.valid){let l=await t.schedule((()=>d.apply()),p);const f=c();null!=f.point&&a!==f.point&&(l=e.update({point:f.point,scenePoint:f.scenePoint,context:r})),null!=f.updatePoint&&i.pointEquals(l,f.updatePoint)||(x(s.mapEnd,l,u,n),o.execute(s))}}))}function d(e){return"3d"===e.type?e.resourceController.scheduler.registerTask(u.TaskPriority.SNAPPING):u.ImmediateTask}function f(e,n,t){return{context:new s.SnappingContext({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:null!=n.info?n.info.handle:null,excludeFeature:e.excludeFeature,visualizer:e.visualizer}),originalPos:null!=n.snapOrigin?e.coordinateHelper.vectorToDehydratedPoint(n.snapOrigin):n.mapStart,originalScenePos:null!=n.scenePoints?n.scenePoints.sceneStart:null,frameTask:t}}function g(e,[n,t,o]){const i=a.clonePoint(e);return i.x+=n,i.y+=t,i.hasZ&&(i.z+=o),i}function P(e,n){return null==e||null==n?null:g(e,v(n.sceneEnd,n.sceneStart))}function v(e,n){const t=e.hasZ&&n.hasZ?e.z-n.z:0;return[e.x-n.x,e.y-n.y,t]}function x(e,n,[t,o,i],a){e.x=n.x+t,e.y=n.y+o,a&&e.hasZ&&n.hasZ&&(e.z=n.z+i)}function S(e,n){if(!e.hasZ())return null;const t=n.vertices;let o=null;for(const i of t){const n=e.getZ(i.pos);if(null!=o&&null!=n&&Math.abs(n-o)>1e-6)return null;null==o&&(o=n)}return o}function m(e){return e}e.createSnapDragEventPipelineStep=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
