/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Evented","../../../core/HandleOwner","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../geometry/projection","../../../support/elevationInfoUtils","./Settings","./SnappingDomain","./snappingFactory","./SnappingOptions","./SnappingPoint","./snappingUtils","./candidates/IntersectionSnappingCandidate","../support/viewUtils"],(function(n,e,t,i,a,s,r,o,p,c,d,u,l,h,f,g,_,S,y,v,C,P){"use strict";var T;n.SnappingManager=function(n){function t(e){var t;return(t=n.call(this,e)||this).options=new S,t.snappingEnginesFactory=_.defaultSnappingEnginesFactory,t._engines=[],t._currentMainCandidate=null,t._currentOtherActiveCandidates=[],t._currentSnappedType=T.MAIN,t}e._inherits(t,n);var i=t.prototype;return i.initialize=function(){this.handles.add([r.watch((()=>{const{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i}=this.options;return{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i}}),(()=>{this.doneSnapping(),this.emit("changed")}),r.sync),r.watch((()=>this.options),(n=>{for(const e of this._engines)e.options=n}),r.sync),r.watch((()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory})),(({viewReady:n,snappingEnginesFactory:e})=>this._recreateEngines(n,e)),r.syncAndInitial)])},i.destroy=function(){this._destroyEngines()},i._recreateEngines=function(n,e){if(this._destroyEngines(),!n)return;const{view:t,options:i}=this;this._engines=e(t,i)},i._destroyEngines=function(){for(const n of this._engines)n.destroy();this._engines=[]},i.snap=async function(n){return M(n)?this._snapMultiPoint(n):this._snapSinglePoint(n)},i.update=function(n){const{point:e,context:t}=n;this._removeVisualization();const i=this._currentMainCandidate;if(null==i)return e;const a=this._selectUpdateInput(n);if(null==a)return e;const{spatialReference:s}=t,r=l.project(a,s);if(null==r)return e;const{view:o}=this,{elevationInfo:p,visualizer:c}=t,d=[],u=y.pointToSnappingPoint(r,o,t),h=i.constraint.closestTo(u);if(!this._arePointsWithinScreenThreshold(u,h,t))return this._resetSnappingState(),e;i.targetPoint=h,d.push(...i.hints);for(const l of this._currentOtherActiveCandidates)l.targetPoint=h,d.push(...l.hints);return null!=c&&this.handles.add(c.draw(d,{spatialReference:s,elevationInfo:m(t),view:o,selfSnappingZ:t.selfSnappingZ}),I),y.snappingPointToSnappingOutput(h,o,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:p})},i.doneSnapping=function(){this._removeVisualization(),this._resetSnappingState()},i._selectUpdateInput=function({point:n,scenePoint:e}){switch(this._currentSnappedType){case T.MAIN:return n;case T.SCENE:return e}},i._resetSnappingState=function(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=T.MAIN},i._removeVisualization=function(){this.handles.remove(I)},i._snapSinglePoint=async function({point:n,context:e,signal:t}){const{view:i}=this,a=y.pointToSnappingPoint(n,i,e),s=await this._fetchCandidates(a,g.SnappingDomain.ALL,e,t);return this._createSnapResult(a,T.MAIN,s,i,e,{z:n.z,m:n.m,spatialReference:n.spatialReference,elevationInfo:e.elevationInfo},t)},i._snapMultiPoint=async function({point:n,scenePoint:e,context:t,signal:i}){const{view:a}=this,{coordinateHelper:s,spatialReference:r}=t;await l.initializeProjection(e.spatialReference,r);const o=l.project(e,r),p=y.pointToSnappingPoint(o,a,t),c=await this._fetchCandidates(p,g.SnappingDomain.FEATURE,t,i);if(c.length>0){const n=await this._fetchCandidates(p,g.SnappingDomain.SELF,t,i);return this._createSnapResult(p,T.SCENE,[...c,...n],a,t,{z:o.z,m:o.m,spatialReference:o.spatialReference,elevationInfo:t.elevationInfo},i)}const d=y.pointToSnappingPoint(n,a,t),u=await this._fetchCandidates(d,g.SnappingDomain.SELF,t,i);return this._createSnapResult(d,T.MAIN,u,a,t,{z:s.hasZ()&&n.hasZ?n.z??0:void 0,m:s.hasM()&&n.hasM?n.m??0:void 0,spatialReference:n.spatialReference,elevationInfo:t.elevationInfo},i)},i._fetchCandidates=async function(n,e,t,i){return(await Promise.all(this._engines.map((a=>a.fetchCandidates(n,e,t,i))))).flat()},i._createSnapResult=function(n,e,t,i,a,r,o){return{get valid(){return!s.isAborted(o)},apply:()=>{const{spatialReference:s}=a,{snappedPoint:o,hints:p}=this._processCandidates(n,e,t,a);return this._removeVisualization(),null!=a.visualizer&&this.handles.add(a.visualizer.draw(p,{spatialReference:s,elevationInfo:h.absoluteHeightElevationInfo,view:i,selfSnappingZ:a.selfSnappingZ}),I),y.snappingPointToSnappingOutput(o,i,r)}}},i._processCandidates=function(n,e,t,i){if(t.length<1)return this.doneSnapping(),{snappedPoint:n,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),v.sortCandidatesInPlace(n,t);const a=this._currentMainCandidate;if(null!=a){const s=this._findOldConstraintInNewCandidates(a,t);if(s>=0){if(!(t[s]instanceof C.IntersectionSnappingCandidate))return this._intersectWithOtherCandidates(s,t,n,e,i);if(this._arePointsWithinScreenThreshold(n,a.targetPoint,i))return this._updateSnappingCandidate(a,e,t,i)}}return this._intersectWithOtherCandidates(0,t,n,e,i)},i._findOldConstraintInNewCandidates=function(n,e){return n instanceof C.IntersectionSnappingCandidate?this._findOldCandidateIndex(e,n.first)>=0&&this._findOldCandidateIndex(e,n.second)>=0?0:-1:this._findOldCandidateIndex(e,n)},i._intersectWithOtherCandidates=function(n,e,t,i,a){const{coordinateHelper:s}=a,r=e[n],o=[];for(let p=0;p<e.length;++p){if(p===n)continue;const i=e[p];for(const n of r.constraint.intersect(i.constraint)){const e=n.closestTo(r.targetPoint);o.push([new C.IntersectionSnappingCandidate(e,r,i,i.isDraped),this._squaredScreenDistance(t,e,s)])}}return o.length>0&&(o.sort(((n,e)=>n[1]-e[1])),o[0][1]<this._squaredPointProximityThreshold(a.pointer))?this._updateSnappingCandidate(o[0][0],i,e,a):this._updateSnappingCandidate(r,i,e,a)},i._updateSnappingCandidate=function(n,e,t,i){this.doneSnapping(),this._currentMainCandidate=n,this._currentSnappedType=e;const a=this._currentMainCandidate.targetPoint,s=[];s.push(...n.hints);for(const r of t){if(n instanceof C.IntersectionSnappingCandidate){if(r.constraint.equals(n.first.constraint)||r.constraint.equals(n.second.constraint))continue}else if(r.constraint.equals(n.constraint))continue;const e=r.constraint.closestTo(a);this._squaredScreenDistance(e,a,i.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(r.targetPoint=a,this._currentOtherActiveCandidates.push(r),s.push(...r.hints))}return{snappedPoint:a,hints:s}},i._squaredPointProximityThreshold=function(n){return"touch"===n?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold},i._arePointsWithinScreenThreshold=function(n,e,t){return this._squaredScreenDistance(n,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)},i._squaredScreenDistance=function(n,e,t){return v.squaredScreenDistance(this._toScreen(n,t),this._toScreen(e,t))},i._toScreen=function(n,e){return P.vectorToScreenPoint(n,e.spatialReference,h.absoluteHeightElevationInfo,this.view)},i._findOldCandidateIndex=function(n,e){let t=-1;for(let i=0;i<n.length;++i)if(e.constraint.equals(n[i].constraint)){t=i;break}return t},e._createClass(t,[{key:"updating",get:function(){return this._engines.some((n=>n.updating))}},{key:"_squaredMouseProximityTreshold",get:function(){return this.options.distance*this.options.distance}},{key:"_squaredTouchProximityThreshold",get:function(){const{distance:n,touchSensitivityMultiplier:e}=this.options,t=n*e;return t*t}},{key:"_squaredSatisfiesConstraintThreshold",get:function(){return f.defaults.satisfiesConstraintScreenThreshold*f.defaults.satisfiesConstraintScreenThreshold}},{key:"test",get:function(){return{visualizationsActive:this.handles.has(I),engines:this._engines}}}]),t}(i.EventedMixin(a.HandleOwner)),t.__decorate([o.property({constructOnly:!0})],n.SnappingManager.prototype,"view",void 0),t.__decorate([o.property()],n.SnappingManager.prototype,"options",void 0),t.__decorate([o.property({readOnly:!0})],n.SnappingManager.prototype,"updating",null),t.__decorate([o.property()],n.SnappingManager.prototype,"snappingEnginesFactory",void 0),t.__decorate([o.property()],n.SnappingManager.prototype,"_engines",void 0),t.__decorate([o.property()],n.SnappingManager.prototype,"_squaredMouseProximityTreshold",null),t.__decorate([o.property()],n.SnappingManager.prototype,"_squaredTouchProximityThreshold",null),t.__decorate([o.property()],n.SnappingManager.prototype,"_squaredSatisfiesConstraintThreshold",null),n.SnappingManager=t.__decorate([u.subclass("esri.views.interactive.snapping.SnappingManager")],n.SnappingManager),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(T||(T={}));const I="visualization-handle";function M(n){return null!=n.scenePoint}function m({coordinateHelper:n,elevationInfo:e}){return n.hasZ()?h.absoluteHeightElevationInfo:e}Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})}));
