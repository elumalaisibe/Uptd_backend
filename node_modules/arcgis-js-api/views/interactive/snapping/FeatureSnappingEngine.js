/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/HandleOwner","../../../core/Handles","../../../core/MapUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec2","../../../chunks/vec3","../../../chunks/vec3f64","../../../chunks/common","../../../support/elevationInfoUtils","./SnappingConstraint","./SnappingDomain","./SnappingPoint","./snappingUtils","./candidates/DrapedEdgeSnappingCandidate","./candidates/EdgeSnappingCandidate","./candidates/FeatureSnappingCandidate","./candidates/RightAngleSnappingCandidate","../support/viewUtils"],(function(e,n,t,r,a,i,o,s,u,c,l,p,d,g,h,S,y,f,m,w,_,v,C,F,P,b,E,x){"use strict";n.FeatureSnappingEngine=function(n){function r(e){var t;return(t=n.call(this,e)||this).options=null,t._domain=_.SnappingDomain.FEATURE,t._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}},t}t._inherits(r,n);var a=r.prototype;return a.initialize=function(){this.updatingHandles.add((()=>this.snappingSources),(()=>this.notifyChange("updating")),u.sync),null!=this.view&&this.handles.add([this.view.on("layerview-create",(e=>this._updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this._updateLayerView(e.layer,null)))])},a._updateLayerView=function(e,n){for(const[,t]of this.snappingSources)t.snappingSource.layerSource.layer===e&&(t.layerView=n)},a.destroy=function(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()},a.fetchCandidates=async function(e,n,t,r){if(!(n&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const a=[],i=this._computeScreenSizeDistanceParameters(e,t),o={distance:i,mode:this.view?.type??"2d",point:e,coordinateHelper:t.coordinateHelper,...this._types};for(const[,{snappingSource:s,layerView:c}]of this.snappingSources)!s.layerSource.enabled||null!=c&&c.suspended||a.push(s.fetchCandidates(o,r).then((e=>e.filter((e=>!this._candidateIsExcluded(s,e,t.excludeFeature))))));const u=(await s.eachAlwaysValues(a)).flat();return this._addRightAngleCandidates(u,e,i,t),s.throwIfAborted(r),C.sortCandidatesInPlace(e,u),u},a._addRightAngleCandidates=function(e,n,t,r){const a=null!=r.vertexHandle?r.vertexHandle.rightEdge?.rightVertex?.pos:null!=r.editGeometryOperations&&"polygon"===r.editGeometryOperations.data.type?r.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,i=null!=r.vertexHandle?r.vertexHandle.leftEdge?.leftVertex?.pos:null!=r.editGeometryOperations?r.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:o}=this,s=v.anyMapPointToSnappingPoint(a,o,r),u=v.anyMapPointToSnappingPoint(i,o,r),c=e.length;for(let l=0;l<c;l++)this._addRightAngleCandidate(e[l],u,n,t,e),this._addRightAngleCandidate(e[l],s,n,t,e)},a._addRightAngleCandidate=function(e,n,t,r,a){if(null==n||!H(e))return;const i=e.constraint.closestTo(n),o=(i[0]-t[0])/r.x,s=(i[1]-t[1])/r.y,{start:u,end:c}=e.constraint;if(o*o+s*s<=1){const t=new E.RightAngleSnappingCandidate({targetPoint:i,otherVertex:n,otherVertexType:E.OtherVertexType.NEXT,previousVertex:h.squaredDistance(i,u)>h.squaredDistance(i,c)?u:c,constraint:new w.VerticalHalfPlaneConstraint(n,i),objectId:e.objectId,isDraped:e.isDraped});a.push(t)}},a._computeScreenSizeDistanceParameters=function(e,n){let t=null!=this.options?this.options.distance*("touch"===n.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:t,y:t,z:t,distance:t}:"2d"===this.view.type?(t*=this.view.resolution,{x:t,y:t,z:t,distance:t}):this._computeScreenSizeDistanceParameters3D(e,t,this.view,n)},a._computeScreenSizeDistanceParameters3D=function(e,n,t,r){const{spatialReference:a}=r;t.renderCoordsHelper.toRenderCoords(e,a,L);const i=t.state.camera.computeScreenPixelSizeAt(L),o=i*t.renderCoordsHelper.unitInMeters/t.mapCoordsHelper.unitInMeters,s=n*o,u=x.vectorToScreenPoint(e,a,m.absoluteHeightElevationInfo,t),c=u?V(u,e,o,0,0,t,r):0,l=u?V(u,e,0,o,0,t,r):0,p=u?V(u,e,0,0,o,t,r):0;return{x:0===c?0:s/c,y:0===l?0:s/l,z:0===p?0:s/p,distance:i*n}},a._candidateIsExcluded=function(e,n,t){if(null==t)return!1;const r=this._getCandidateObjectId(n);if(null==r)return!1;const a=e.layerSource.layer;return"graphics"===a.type?t.uid===r:t.sourceLayer===a&&(!(!t.attributes||!("objectIdField"in a))&&t.attributes[a.objectIdField]===r)},a._getCandidateObjectId=function(e){return e instanceof b.FeatureSnappingCandidate?e.objectId:null},a._createSourceInfo=function(e){const n=this._createFeatureSnappingSourceType(e);if(null==n)return null;if("loading"in n)return this.updatingHandles.addPromise(n.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const t=null!=this.view?this.view.allLayerViews.find((n=>n.layer===e.layer)):null;return new M(n.source,t)},a._createFeatureSnappingSourceType=function(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null},a._createFeatureSnappingSourceSceneLayer=function(e){const{view:n}=this;if(null==n||"3d"!==n.type)return null;const t=this._getSourceModule("scene");return null!=t.module?{source:new t.module.SceneLayerSnappingSource({layerSource:e,view:n})}:{loading:t.loader}},a._createFeatureSnappingSourceFeatureLayer=function(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":{const n=this._getSourceModule("featureService");return null!=n.module?{source:new n.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:n.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===e.layer.geometryType)return null;const n=this._getSourceModule("featureCollection");return null!=n.module?{source:new n.module.FeatureCollectionSnappingSource({layerSource:e,view:this.view})}:{loading:n.loader}}}return null},a._createFeatureSnappingSourceGraphicsLayer=function(e){const n=this._getSourceModule("graphics");return null!=n.module?{source:new n.module.GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:n.loader}},a._createFeatureSnappingSourceMapNotesLayer=function(e){const n=this._getSourceModule("notes");return null!=n.module?{source:new n.module.GraphicsSnappingSource({getGraphicsLayers:()=>null!=e.layer.sublayers?e.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:n.loader}},a._getSourceModule=function(e){const n=this._sourceModules[e];if(null==n.loader){const t=this._loadSourceModule(e).then((e=>{n.module=e}));return n.loader=t,{module:n.module,loader:t}}return{module:n.module,loader:n.loader}},a._loadSourceModule=function(n){const t=this.updatingHandles;switch(n){case"featureService":return t.addPromise(new Promise(((n,t)=>e(["./featureSources/FeatureServiceSnappingSource"],n,t))));case"featureCollection":return t.addPromise(new Promise(((n,t)=>e(["./featureSources/FeatureCollectionSnappingSource"],n,t))));case"graphics":case"notes":return t.addPromise(new Promise(((n,t)=>e(["./featureSources/GraphicsSnappingSource"],n,t))));case"scene":return t.addPromise(new Promise(((n,t)=>e(["./featureSources/SceneLayerSnappingSource"],n,t))))}},t._createClass(r,[{key:"updating",get:function(){return o.someMap(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}},{key:"snappingSources",get:function(){const e=this._get("snappingSources")||new Map,n=new Map;if(null!=this.options&&null!=this.options.featureSources)for(const t of this.options.featureSources.items){const r=t.layer.uid,a=e.get(r);if(a){e.delete(r),n.set(r,a);continue}if(!t.layer.loaded){this.updatingHandles.addPromise(t.layer.load());continue}const i=this._createSourceInfo(t);null!=i&&n.set(r,i)}for(const[,t]of e)t.destroy();return n}},{key:"_types",get:function(){return{returnEdge:!0,returnVertex:!0}}}]),r}(a.HandleOwner),r.__decorate([c.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"spatialReference",void 0),r.__decorate([c.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"view",void 0),r.__decorate([c.property()],n.FeatureSnappingEngine.prototype,"options",void 0),r.__decorate([c.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"updating",null),r.__decorate([c.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"snappingSources",null),n.FeatureSnappingEngine=r.__decorate([g.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],n.FeatureSnappingEngine);let M=function(){function e(e,n){this.snappingSource=e,this.layerView=n,this.handles=new i;const t=this.snappingSource.layerSource.layer;if("refresh"in t){const n=t;this.handles.add(n.on("refresh",(()=>e.refresh())))}this.handles.add([u.watch((()=>e.updating),(n=>e.layerSource.updating=n),u.syncAndInitial),u.watch((()=>e.availability),(n=>e.layerSource.availability=n),u.syncAndInitial)])}return e.prototype.destroy=function(){this.snappingSource.destroy(),this.handles.destroy()},t._createClass(e)}();function H(e){return(e instanceof P.EdgeSnappingCandidate||e instanceof F.DrapedEdgeSnappingCandidate)&&!I(e)}function I({constraint:{start:e,end:n}}){const t=S.squaredDistance(e,n),r=h.squaredDistance(e,n);return t<f.getEpsilon()||r/t<D}function V(e,n,t,r,a,i,{spatialReference:o}){const s=S.copy(R,n);s[0]+=t,s[1]+=r,s[2]+=a;const u=x.vectorToScreenPoint(s,o,m.absoluteHeightElevationInfo,i);return u?C.screenDistance(u,e):1/0}const L=y.create(),R=y.create(),D=1e-4;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})}));
