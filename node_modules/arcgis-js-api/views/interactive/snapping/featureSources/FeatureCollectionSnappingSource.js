/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../support/elevationInfoUtils","../snappingUtils","./queryEngineUtils","./snappingCandidateElevationAlignment","./snappingCandidateElevationFilter","./symbologySnappingCandidates"],(function(e,t,n,i,o,r,a,p,l,s,c,u,y,g,d,S,h){"use strict";e.FeatureCollectionSnappingSource=function(e){t._inherits(i,e);var n=i.prototype;function i(t){var n;return(n=e.call(this,t)||this).view=null,n._layerView3D=null,n}return n.initialize=function(){const{view:e}=this,{layer:t}=this.layerSource;null!=e&&"3d"===e.type&&"subtype-group"!==t.type&&(e.whenLayerView(t).then((e=>this._layerView3D=e)),this.addHandles([e.elevationProvider.on("elevation-change",(({context:e})=>{const{elevationInfo:n}=t;u.elevationContextAffectsAlignment(e,n)&&this._snappingElevationAligner.notifyElevationSourceChange()})),r.watch((()=>t.elevationInfo),(()=>this._snappingElevationAligner.notifyElevationSourceChange()),r.initial),r.watch((()=>null!=this._layerView3D?this._layerView3D.processor?.renderer:null),(()=>this._symbologySnappingFetcher.notifySymbologyChange()),r.initial),r.on((()=>this._layerView3D?.layer),["edits","apply-edits","graphic-update"],(()=>this._symbologySnappingFetcher.notifySymbologyChange()))]))},n.refresh=function(){},n.fetchCandidates=async function(e,t){const{layer:n}=this.layerSource,i=n.source;if(!i?.querySnapping)return[];const r=y.makeFilter(n),a=y.makeSnappingQuery(e,this.view?.type??"2d",r),p=await i.querySnapping(a,{signal:t});o.throwIfAborted(t);const l=await this._snappingElevationAligner.alignCandidates(p.candidates,t);o.throwIfAborted(t);const s=await this._symbologySnappingFetcher.fetch(l,t);o.throwIfAborted(t);const c=0===s.length?l:[...l,...s],u=this._snappingElevationFilter.filter(a,c),d=this._getGroundElevation;return u.map((e=>g.convertSnappingCandidate(e,d)))},t._createClass(i,[{key:"availability",get:function(){return 1}},{key:"updating",get:function(){return this.layerSource.updating}},{key:"_snappingElevationAligner",get:function(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type;if(!n||"subtype-group"===t.type)return d.getSnappingCandidateElevationAligner();const i=async(n,i)=>(await o.whenOrAbort(e.whenLayerView(t),i)).elevationAlignPointsInFeatures(n,i);return d.getSnappingCandidateElevationAligner(n,{elevationInfo:t.elevationInfo,alignPointsInFeatures:i,spatialReference:e.spatialReference})}},{key:"_snappingElevationFilter",get:function(){const{view:e}=this,t=null!=e&&"3d"===e.type&&"subtype-group"!==this.layerSource.layer.type;return S.getSnappingCandidateElevationFilter(t)}},{key:"_symbologySnappingFetcher",get:function(){const{view:e}=this,{layer:t}=this.layerSource;return null!=e&&"3d"===e.type&&"subtype-group"!==t.type?h.getSymbologySnappingCandidatesFetcher(this._symbologySnappingSupported,(async(n,i)=>{const r=await e.whenLayerView(t);return o.throwIfAborted(i),r.queryForSymbologySnapping({candidates:n,spatialReference:e.spatialReference},i)})):h.getSymbologySnappingCandidatesFetcher()}},{key:"_symbologySnappingSupported",get:function(){return null!=this._layerView3D&&this._layerView3D.symbologySnappingSupported}},{key:"_getGroundElevation",get:function(){return g.makeGetGroundElevation(this.view)}}]),i}(i),n.__decorate([a.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"layerSource",void 0),n.__decorate([a.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"view",void 0),n.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationAligner",null),n.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationFilter",null),n.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingFetcher",null),n.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_layerView3D",void 0),n.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingSupported",null),n.__decorate([a.property()],e.FeatureCollectionSnappingSource.prototype,"_getGroundElevation",null),e.FeatureCollectionSnappingSource=n.__decorate([c.subclass("esri.views.interactive.snapping.featureSources.FeatureCollectionSnappingSource")],e.FeatureCollectionSnappingSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
