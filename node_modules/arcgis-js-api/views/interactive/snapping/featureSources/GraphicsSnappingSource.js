/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/HandleOwner","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Polygon","../../../../geometry/projection","../../../../geometry/support/normalizeUtilsSync","../../../../geometry/support/typeUtils","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/data/FeatureStore","../../../../layers/graphics/data/QueryEngine","../../../../support/elevationInfoUtils","../../../../symbols/support/utils","../snappingUtils","./queryEngineUtils","./snappingCandidateElevationAlignment","./snappingCandidateElevationFilter","./symbologySnappingCandidates"],(function(e,t,n,i,r,o,a,s,p,c,l,u,d,h,y,g,_,f,S,m,v,w,b,E,k,C,G,A){"use strict";const F="graphics-collections";e.GraphicsSnappingSource=function(e){function n(t){var n;return(n=e.call(this,t)||this).availability=1,n._sources={multipoint:null,point:null,polygon:null,polyline:null},n._loadedWkids=new Set,n._loadedWkts=new Set,n._pendingAdds=[],n._extrudedPolygonSymbolsCount=0,n}t._inherits(n,e);var i=n.prototype;return i.destroy=function(){for(const e of this._pendingAdds)e.task.abort();this._pendingAdds.length=0,this._mapSources((e=>this._destroySource(e)))},i.initialize=function(){this.updatingHandles.add((()=>this.getGraphicsLayers()),(e=>{this.updatingHandles.removeHandles(F);for(const t of e)this._addMany(t.graphics.toArray()),this.handles.add([t.on("graphic-update",(e=>this._onGraphicUpdate(e))),this.updatingHandles.addOnCollectionChange((()=>t.graphics),(e=>this._onGraphicsChanged(e)))],F)}),p.initial);const{view:e}=this,{layer:t}=this.layerSource;null!=e&&"3d"===e.type&&"map-notes"!==t.type&&this.addHandles([e.elevationProvider.on("elevation-change",(({context:e})=>{w.elevationContextAffectsAlignment(e,t.elevationInfo)&&this._snappingElevationAligner.notifyElevationSourceChange()})),p.watch((()=>t.elevationInfo),(()=>this._snappingElevationAligner.notifyElevationSourceChange()),p.initial),p.on((()=>t),["edits","apply-edits","graphic-update"],(()=>this._symbologySnappingFetcher.notifySymbologyChange()))])},i.fetchCandidates=async function(e,t){const{point:n}=e,i=await s.eachAlwaysValues(this._mapSources((n=>this._fetchCandidatesForSource(n,e,t))));s.throwIfAborted(t);const r=this._getGroundElevation,o=i.flat().map((e=>k.convertSnappingCandidate(e,r)));return E.sortCandidatesInPlace(n,o),o},i._fetchCandidatesForSource=async function(e,t,n){const i=E.makeSnappingQuery(t,this.view?.type??"2d"),r=await e.queryEngine.executeQueryForSnapping(i,n);s.throwIfAborted(n);const o=await this._snappingElevationAligner.alignCandidates(r.candidates,n);s.throwIfAborted(n);const a=await this._symbologySnappingFetcher.fetch(o,n);s.throwIfAborted(n);const p=0===a.length?o:[...o,...a];return this._snappingElevationFilter.filter(i,p)},i.refresh=function(){},i._onGraphicUpdate=function(e){if(this.getGraphicsLayers().some((t=>t.graphics.includes(e.graphic))))switch(e.property){case"geometry":case"visible":this._remove(e.graphic),this._addMany([e.graphic])}},i._onGraphicsChanged=function(e){for(const t of e.removed)this._remove(t);this._addMany(e.added)},i._addMany=function(e){const t=[],n=new Map;for(const i of e)null!=i.geometry&&(this._needsInitializeProjection(i.geometry.spatialReference)?(t.push(i.geometry.spatialReference),n.set(i.uid,i)):this._add(i));this._createPendingAdd(t,n)},i._createPendingAdd=function(e,t){if(!e.length)return;const n=o.createTask((async n=>{await y.initializeProjection(e.map((e=>({source:e,dest:this.spatialReference}))),{signal:n}),this._markLoadedSpatialReferences(e);for(const[,e]of t)this._add(e)}));this.updatingHandles.addPromise(n.promise);const i={task:n,graphics:t},a=()=>r.removeUnordered(this._pendingAdds,i);n.promise.then(a,a),this._pendingAdds.push(i)},i._markLoadedSpatialReferences=function(e){for(const t of e)null!=t.wkid&&this._loadedWkids.add(t.wkid),null!=t.wkt&&this._loadedWkts.add(t.wkt)},i._add=function(e){if(null==e.geometry||!e.visible)return;let t=e.geometry;if("mesh"===t.type)return;"extent"===t.type&&(t=h.fromExtent(t));const n=this._ensureSource(t.type);if(null==n)return;const i=this._createOptimizedFeature(e.uid,t);null!=i&&(n.featureStore.add(i),b.symbolHasExtrudeSymbolLayer(e.symbol)&&this._extrudedPolygonSymbolsCount++)},i._needsInitializeProjection=function(e){return(null==e.wkid||!this._loadedWkids.has(e.wkid))&&((null==e.wkt||!this._loadedWkts.has(e.wkt))&&!y.canProjectWithoutEngine(e,this.spatialReference))},i._createOptimizedFeature=function(e,t){const n=y.project(g.normalizeCentralMeridianForDisplay(t),this.spatialReference);if(!n)return null;const i=this._ensureGeometryHasZ(n),r=f.convertFromGeometry(i,this._hasZ,!1),o={[I]:e};return new S.OptimizedFeature(r,o,null,e)},i._ensureGeometryHasZ=function(e){if(!this._hasZ)return e;const t=e=>{for(;e.length<3;)e.push(0)},n=e.clone();switch(n.hasZ=!0,n.type){case"point":n.z=n.z??0;break;case"multipoint":n.points.forEach(t);break;case"polyline":n.paths.forEach((e=>e.forEach(t)));break;case"polygon":n.rings.forEach((e=>e.forEach(t)))}return n},i._ensureSource=function(e){const t=this._sources[e];if(null!=t)return t;const n=this._createSource(e);return this._sources[e]=n,n},i._createSource=function(e){const t=_.featureGeometryTypeKebabDictionary.toJSON(e),n=this._hasZ,i=new m({geometryType:t,hasZ:n,hasM:!1});return{featureStore:i,queryEngine:new v.QueryEngine({featureStore:i,fields:[{name:I,type:"esriFieldTypeOID",alias:I}],geometryType:t,hasM:!1,hasZ:n,objectIdField:I,spatialReference:this.spatialReference,scheduler:null!=this.view&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),type:e}},i._remove=function(e){this._mapSources((t=>this._removeFromSource(t,e)));for(const t of this._pendingAdds)t.graphics.delete(e.uid),0===t.graphics.size&&t.task.abort()},i._removeFromSource=function(e,t){const n=t.uid;e.featureStore.has(n)&&(e.featureStore.removeById(t.uid),b.symbolHasExtrudeSymbolLayer(t.symbol)&&this._extrudedPolygonSymbolsCount--)},i._destroySource=function(e){e.queryEngine.destroy(),this._sources[e.type]=null},i._mapSources=function(e){const{point:t,polygon:n,polyline:i,multipoint:r}=this._sources,o=[];return null!=t&&o.push(e(t)),null!=n&&o.push(e(n)),null!=i&&o.push(e(i)),null!=r&&o.push(e(r)),o},t._createClass(n,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"_hasZ",get:function(){const e=this.view;return null!=e&&"3d"===e.type&&"map-notes"!==this.layerSource.layer.type}},{key:"_snappingElevationAligner",get:function(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type;if(!n||"map-notes"===t.type)return C.getSnappingCandidateElevationAligner();const i=async(n,i)=>(await s.whenOrAbort(e.whenLayerView(t),i)).elevationAlignPointsInFeatures(n,i);return C.getSnappingCandidateElevationAligner(n,{elevationInfo:t.elevationInfo,alignPointsInFeatures:i,spatialReference:e.spatialReference})}},{key:"_snappingElevationFilter",get:function(){const{view:e}=this,t=null!=e&&"3d"===e.type&&"map-notes"!==this.layerSource.layer.type;return G.getSnappingCandidateElevationFilter(t)}},{key:"_symbologySnappingFetcher",get:function(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type,i=this._extrudedPolygonSymbolsCount>0;return n&&"map-notes"!==t.type&&i?A.getSymbologySnappingCandidatesFetcher(i,(async(n,i)=>{const r=await e.whenLayerView(t);return s.throwIfAborted(i),r.queryForSymbologySnapping({candidates:n,spatialReference:e.spatialReference},i)})):A.getSymbologySnappingCandidatesFetcher()}},{key:"_getGroundElevation",get:function(){return k.makeGetGroundElevation(this.view)}}]),n}(a.HandleOwnerMixin(i)),n.__decorate([c.property()],e.GraphicsSnappingSource.prototype,"getGraphicsLayers",void 0),n.__decorate([c.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"layerSource",void 0),n.__decorate([c.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"spatialReference",void 0),n.__decorate([c.property({constructOnly:!0})],e.GraphicsSnappingSource.prototype,"view",void 0),n.__decorate([c.property({readOnly:!0})],e.GraphicsSnappingSource.prototype,"updating",null),n.__decorate([c.property({readOnly:!0})],e.GraphicsSnappingSource.prototype,"availability",void 0),n.__decorate([c.property()],e.GraphicsSnappingSource.prototype,"_hasZ",null),n.__decorate([c.property()],e.GraphicsSnappingSource.prototype,"_snappingElevationAligner",null),n.__decorate([c.property()],e.GraphicsSnappingSource.prototype,"_snappingElevationFilter",null),n.__decorate([c.property()],e.GraphicsSnappingSource.prototype,"_symbologySnappingFetcher",null),n.__decorate([c.property()],e.GraphicsSnappingSource.prototype,"_extrudedPolygonSymbolsCount",void 0),n.__decorate([c.property()],e.GraphicsSnappingSource.prototype,"_getGroundElevation",null),e.GraphicsSnappingSource=n.__decorate([d.subclass("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],e.GraphicsSnappingSource);const I="OBJECTID";Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
