/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/LRUCache","../../../../core/MapUtils","../../../../core/promiseUtils","../../../../core/unitUtils","../../../../symbols/support/unitConversionUtils"],(function(e,t,n,s,o,i,a,r){"use strict";function c(e=!1,t){if(e){const{elevationInfo:e,alignPointsInFeatures:n,spatialReference:s}=t;return new h(e,n,s)}return new u}let u=function(){function e(){}var n=e.prototype;return n.alignCandidates=async function(e,t){return e},n.notifyElevationSourceChange=function(){},t._createClass(e)}();const l=1024;let h=function(){function e(e,t,n){this._elevationInfo=e,this._alignPointsInFeatures=t,this.spatialReference=n,this._alignmentsCache=new s.LRUCache(l),this._cacheVersion=0,this._metersPerVerticalUnit=a.getMetersPerVerticalUnitForSR(n)}var n=e.prototype;return n.alignCandidates=async function(e,t){const n=this._elevationInfo;return null==n||"absolute-height"!==n.mode||n.featureExpressionInfo?this._alignComputedElevationCandidates(e,t):(this._alignAbsoluteElevationCandidates(e,n),e)},n.notifyElevationSourceChange=function(){this._alignmentsCache.clear(),this._cacheVersion++},n._alignAbsoluteElevationCandidates=function(e,t){const{offset:n,unit:s}=t;if(null==n)return;const o=s??"meters",i=n*(r.getMetersPerUnit(o)/this._metersPerVerticalUnit);for(const a of e)switch(a.type){case"edge":a.start.z+=i,a.end.z+=i;continue;case"vertex":a.target.z+=i;continue}},n._alignComputedElevationCandidates=async function(e,t){const n=new Map;for(const i of e)o.getOrCreateMapValue(n,i.objectId,p).push(i);const[s,a,r]=this._prepareQuery(n),c=await this._alignPointsInFeatures(s,t);i.throwIfAborted(t);if(r!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t);this._applyCacheAndResponse(s,c,a);const{drapedObjectIds:u,failedObjectIds:l}=c,h=[];for(const o of e){const{objectId:e}=o;u.has(e)&&"edge"===o.type&&(o.draped=!0),l.has(e)||h.push(o)}return h},n._prepareQuery=function(e){const t=[],n=[];for(const[s,o]of e){const e=[];for(const t of o)this._addToQueriesOrCachedResult(s,t.target,e,n),"edge"===t.type&&(this._addToQueriesOrCachedResult(s,t.start,e,n),this._addToQueriesOrCachedResult(s,t.end,e,n));0!==e.length&&t.push({objectId:s,points:e})}return[t,n,this._cacheVersion]},n._addToQueriesOrCachedResult=function(e,t,n,s){const o=f(e,t),i=this._alignmentsCache.get(o);null==i?n.push(t):s.push(new d(t,i))},n._applyCacheAndResponse=function(e,{elevations:t,drapedObjectIds:n,failedObjectIds:s},o){for(const r of o)r.apply();let i=0;const a=this._alignmentsCache;for(const{objectId:r,points:c}of e){if(s.has(r)){i+=c.length;continue}const e=!n.has(r);for(const n of c){const s=f(r,n),o=t[i++];n.z=o,e&&a.put(s,o,1)}}},t._createClass(e)}(),d=function(){function e(e,t){this.point=e,this.z=t}return e.prototype.apply=function(){this.point.z=this.z},t._createClass(e)}();function f(e,{x:t,y:n,z:s}){return`${e}-${t}-${n}-${s??0}}`}function p(){return[]}e.getSnappingCandidateElevationAligner=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
