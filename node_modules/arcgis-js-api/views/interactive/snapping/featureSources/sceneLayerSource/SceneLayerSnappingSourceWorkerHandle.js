/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/HandleOwner","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3f64","../../../../../core/workers/WorkerHandle","../../../../../chunks/sphere","../../SnappingPoint","../../candidates/EdgeSnappingCandidate","../../candidates/VertexSnappingCandidate"],(function(e,r,t,n,o,a,i,s,c,d,p,l,u,h,y){"use strict";e.SceneLayerSnappingSourceWorkerHandle=function(e){function t(r){var t;return(t=e.call(this,r)||this).availability=0,t._ids=new Set,t}r._inherits(t,e);var n=t.prototype;return n.destroy=function(){this._workerHandle.destroy(),this._workerHandle=null},n.initialize=function(){this._workerHandle=new S(this.schedule,{fetchAllEdgeLocations:(e,r)=>this._fetchAllEdgeLocations(e,r)})},n.fetchCandidates=async function(e,r){const t=e.coordinateHelper,{point:n}=e,o=g;this.renderCoordsHelper.toRenderCoords(n,t.spatialReference,o);const a=e.distance,i="number"==typeof a?a:a.distance,s=await this._workerHandle.invoke({bounds:l.fromValues(o[0],o[1],o[2],i),returnEdge:e.returnEdge,returnVertex:e.returnVertex},r);return s.candidates.sort(((e,r)=>e.distance-r.distance)),s.candidates.map((e=>this._convertCandidate(t,e)))},n.add=async function(e,r){this._ids.add(e.id),await this._workerHandle.invokeMethod("add",e,r)},n.remove=async function(e,r){this._ids.delete(e.id),await this._workerHandle.invokeMethod("remove",e,r)},n._convertCandidate=function(e,r){switch(r.type){case"edge":return new h.EdgeSnappingCandidate({objectId:r.objectId,targetPoint:this._convertRenderCoordinate(e,r.target),edgeStart:this._convertRenderCoordinate(e,r.start),edgeEnd:this._convertRenderCoordinate(e,r.end),isDraped:!1});case"vertex":return new y.VertexSnappingCandidate({objectId:r.objectId,targetPoint:this._convertRenderCoordinate(e,r.target),isDraped:!1})}},n._convertRenderCoordinate=function({spatialReference:e},r){const t=d.create();return this.renderCoordsHelper.fromRenderCoords(r,t,e),u.asSnappingPoint(t)},n._fetchAllEdgeLocations=async function(e,r){const t=[],n=[];for(const{id:o,uid:a}of e.components)this._ids.has(o)&&t.push((async()=>{const e=await this.fetchEdgeLocations(o,r.signal),t=e.locations.buffer;return n.push(t),{id:o,uid:a,objectIds:e.objectIds,locations:t,origin:e.origin,type:e.type}})());return{result:{components:(await Promise.all(t)).filter((({id:e})=>this._ids.has(e)))},transferList:n}},r._createClass(t)}(n.HandleOwner),t.__decorate([o.property({constructOnly:!0})],e.SceneLayerSnappingSourceWorkerHandle.prototype,"renderCoordsHelper",void 0),t.__decorate([o.property({constructOnly:!0})],e.SceneLayerSnappingSourceWorkerHandle.prototype,"fetchEdgeLocations",void 0),t.__decorate([o.property({constructOnly:!0})],e.SceneLayerSnappingSourceWorkerHandle.prototype,"schedule",void 0),t.__decorate([o.property({readOnly:!0})],e.SceneLayerSnappingSourceWorkerHandle.prototype,"availability",void 0),e.SceneLayerSnappingSourceWorkerHandle=t.__decorate([c.subclass("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],e.SceneLayerSnappingSourceWorkerHandle);let S=function(e){function t(r,t){return e.call(this,"SceneLayerSnappingSourceWorker","fetchCandidates",{},r,{strategy:"dedicated",client:t})||this}return r._inherits(t,e),r._createClass(t)}(p.WorkerHandle);const g=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
