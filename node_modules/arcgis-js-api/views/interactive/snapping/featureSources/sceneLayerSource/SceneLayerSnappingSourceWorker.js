/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/promiseUtils","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec3","../../../../../chunks/vec3f64","../../../../../geometry/support/lineSegment","../../../../../chunks/sphere","../../../../3d/webgl-engine/lib/Octree","../../../../3d/webgl-engine/lib/edgeRendering/edgeProcessing","./sceneLayerSnappingUtils"],(function(e,t,n,o,s,i,c,r,d,a,u,h,p,g,l,_){"use strict";let m=function(){function t(){this._idToComponent=new Map,this._components=new g((e=>e.bounds)),this._edges=new g((e=>e.bounds)),this._tmpLineSegment=h.create(),this._tmpP1=u.create(),this._tmpP2=u.create(),this._tmpP3=u.create(),this.remoteClient=null}var o=t.prototype;return o.fetchCandidates=async function(e,t){await Promise.resolve(),n.throwIfAborted(t),await this._ensureEdgeLocations(e,t);const o=[];return this._edges.forEachNeighbor((t=>(this._addCandidates(e,t,o),o.length<_.MAX_CANDIDATE_COUNT)),e.bounds),{result:{candidates:o}}},o._ensureEdgeLocations=async function(e,t){const n=[];if(this._components.forEachNeighbor((e=>{if(null==e.info){const{id:t,uid:o}=e;n.push({id:t,uid:o})}return!0}),e.bounds),!n.length)return;const o={components:n},s=await this.remoteClient.invoke("fetchAllEdgeLocations",o,t??{});for(const i of s.components)this._setFetchEdgeLocations(i)},o.add=async function(e){const t=new b(e.id,e.bounds);return this._idToComponent.set(t.id,t),this._components.add([t]),{result:{}}},o.remove=async function(e){const t=this._idToComponent.get(e.id);if(t){const e=[];this._edges.forEachNeighbor((n=>(n.component===t&&e.push(n),!0)),t.bounds),this._edges.remove(e),this._components.remove([t]),this._idToComponent.delete(t.id)}return{result:{}}},o._setFetchEdgeLocations=function(e){const t=this._idToComponent.get(e.id);if(null==t||e.uid!==t.uid)return;const n=l.extractComponentsEdgeLocationsLayout.createView(e.locations),o=new Array(n.count),s=u.create(),i=u.create();for(let d=0;d<n.count;d++){n.position0.getVec(d,s),n.position1.getVec(d,i);const c=_.boundsFromEdge(s,i,e.origin),r=new C(t,d,c);o[d]=r}this._edges.add(o);const{objectIds:c,origin:r}=e;t.info={locations:n,objectIds:c,origin:r}},o._addCandidates=function(e,t,n){const{info:o}=t.component,{origin:s,objectIds:i}=o,c=o.locations,r=c.position0.getVec(t.index,this._tmpP1),d=c.position1.getVec(t.index,this._tmpP2);a.add(r,r,s),a.add(d,d,s);const u=i[c.componentIndex.get(t.index)];this._addEdgeCandidate(e,u,r,d,n),this._addVertexCandidate(e,u,r,n),this._addVertexCandidate(e,u,d,n)},o._addEdgeCandidate=function(e,t,n,o,s){if(!e.returnEdge)return;const i=p.getCenter(e.bounds),c=h.fromPoints(n,o,this._tmpLineSegment),r=h.projectPoint(c,i,this._tmpP3);p.containsPoint(e.bounds,r)&&s.push({type:"edge",objectId:t,target:u.clone(r),distance:a.distance(i,r),start:u.clone(n),end:u.clone(o)})},o._addVertexCandidate=function(e,t,n,o){if(!e.returnVertex)return;const s=p.getCenter(e.bounds);p.containsPoint(e.bounds,n)&&o.push({type:"vertex",objectId:t,target:u.clone(n),distance:a.distance(s,n)})},e._createClass(t)}();m=t.__decorate([d.subclass("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],m);const f=m;let b=e._createClass((function e(t,n){this.id=t,this.bounds=n,this.info=null,this.uid=++e.uid}));b.uid=0;let C=e._createClass((function(e,t,n){this.component=e,this.index=t,this.bounds=n}));return f}));
