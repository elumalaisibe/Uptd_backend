/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/HandleOwner","../../../../core/handleUtils","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../support/elevationInfoUtils","../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D","../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D","./queryEngineUtils","./WorkerTileTreeDebugger","./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle","./featureServiceSource/FeatureServiceTilesSimple","../../../support/debugFlags"],(function(e,r,t,i,n,a,o,s,l,u,c,p,d,S,g,y,h,v,_,f,w,b){"use strict";e.FeatureServiceSnappingSource=function(e){function t(r){var t;return(t=e.call(this,r)||this)._workerHandle=null,t._debug=null,t}r._inherits(t,e);var i=t.prototype;return i.initialize=function(){let e;const r=this.view;if(null!=r)switch(r.type){case"2d":this._tilesOfInterest=new y.FeatureServiceTiles2D({view:r,layer:this._layer}),e=this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle;break;case"3d":{const{resourceController:t}=r,i=this._layer,n=r.whenLayerView(i);this._tilesOfInterest=new h.FeatureServiceTiles3D({view:r}),e=this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle({schedule:e=>t.immediate.schedule(e),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:async(e,r)=>{const t=await n;return o.throwIfAborted(r),t.elevationAlignPointsInFeatures(e,r)},queryForSymbologySnapping:async(e,r)=>{const t=await n;return o.throwIfAborted(r),t.queryForSymbologySnapping(e,r)}});const a=l.signal(null);n.then((e=>a.value=e)),this.addHandles([r.elevationProvider.on("elevation-change",(({context:r})=>{const{elevationInfo:t}=i;g.elevationContextAffectsAlignment(r,t)&&o.ignoreAbortErrors(e.notifyElevationSourceChange())})),s.watch((()=>i.elevationInfo),(()=>o.ignoreAbortErrors(e.notifyElevationSourceChange())),s.initial),s.watch((()=>a.value?.processor?.renderer),(()=>o.ignoreAbortErrors(e.notifySymbologyChange())),s.initial),s.watch((()=>a.value?.symbologySnappingSupported??!1),(r=>o.ignoreAbortErrors(e.setSymbologySnappingSupported(r))),s.initial),s.on((()=>a.value?.layer),["edits","apply-edits","graphic-update"],(()=>e.notifySymbologyChange()))]);break}}else this._tilesOfInterest=new w.FeatureServiceTilesSimple({layer:this._layer}),e=this._workerHandle=new f.FeatureServiceSnappingSourceWorkerHandle;this.handles.add([a.destroyHandle(e)]),o.ignoreAbortErrors(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this.updatingHandles.add((()=>this._updateTilesParameters),(()=>o.ignoreAbortErrors(e.updateTiles(this._updateTilesParameters,null))),s.initial),this.handles.add([s.watch((()=>this.configuration),(r=>o.ignoreAbortErrors(e.configure(r,null))),s.sync)]),null!=r&&this.handles.add(s.watch((()=>b.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES),(t=>{t&&!this._debug?(this._debug=new _.WorkerTileTreeDebugger({view:r,handle:e}),this.handles.add(a.destroyHandle(this._debug),"debug")):!t&&this._debug&&this.handles.remove("debug")}),s.initial)),this.handles.add(this.layerSource.layer.on("apply-edits",(r=>{o.ignoreAbortErrors(e.applyEdits(r,null))})))},i.refresh=function(){this._workerHandle?.refresh(null)},i.fetchCandidates=async function(e,r){const{coordinateHelper:t,point:i}=e;this._tilesOfInterest.pointOfInterest=t.arrayToPoint(i);const n=this._getGroundElevation;return(await this._workerHandle.fetchCandidates({...e},r)).candidates.map((e=>v.convertSnappingCandidate(e,n)))},i.getDebugInfo=function(e){return this._workerHandle.getDebugInfo(e)},r._createClass(t,[{key:"_updateTilesParameters",get:function(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}},{key:"updating",get:function(){return this._workerHandle?.updating||this.updatingHandles.updating}},{key:"configuration",get:function(){const{view:e}=this,r=null!=e?e.type:"2d";return{filter:this._layer.createQuery(),customParameters:this._layer.customParameters,viewType:r}}},{key:"availability",get:function(){return this._workerHandle?.availability??0}},{key:"_layer",get:function(){return this.layerSource.layer}},{key:"_getGroundElevation",get:function(){return v.makeGetGroundElevation(this.view)}}]),t}(n.HandleOwnerMixin(i)),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"spatialReference",void 0),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"layerSource",void 0),t.__decorate([u.property({constructOnly:!0})],e.FeatureServiceSnappingSource.prototype,"view",void 0),t.__decorate([u.property()],e.FeatureServiceSnappingSource.prototype,"_tilesOfInterest",void 0),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"_updateTilesParameters",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"updating",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"configuration",null),t.__decorate([u.property({readOnly:!0})],e.FeatureServiceSnappingSource.prototype,"availability",null),t.__decorate([u.property()],e.FeatureServiceSnappingSource.prototype,"_getGroundElevation",null),e.FeatureServiceSnappingSource=t.__decorate([S.subclass("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],e.FeatureServiceSnappingSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
