/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/analysisThemeUtils","../../core/asyncUtils","../../core/handleUtils","../../core/promiseUtils","../../core/quantityFormatUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../chunks/vec2","../../chunks/vec2f64","../../chunks/vec3","../../geometry/support/coordsUtils","../../intl/messages","../../support/elevationInfoUtils","../../support/getDefaultUnitForView","../overlay/TextOverlayItem","../support/automaticLengthMeasurementUtils"],(function(e,t,s,o,n,r,a,i,l,c,d,h,p,u,g,b,_,y,f,m,x,v,L,U,I){"use strict";const S=3025,D={default:15,far:25};e.SegmentLabels=function(e){function s(t){var s;return(s=e.call(this,t)||this).context=null,s.stagedVertex=null,s.visible=!0,s.edgeDistance="default",s._messagesUnits=null,s._labelInfos=[],s._nextLabelIndex=0,s}t._inherits(s,e);var o=s.prototype;return o.initialize=function(){const e=r.createTask((async e=>{const t=await x.fetchMessageBundle("esri/core/t9n/Units");i.throwIfAborted(e),this._messagesUnits=t}));this.addHandles([c.watch((()=>[null!=this.context&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((e=>c.on((()=>this.context?.editGeometryOperations),e,(()=>this._update())))),a.makeHandle((()=>e.abort()))])},o.destroy=function(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())},o._update=function(){this._nextLabelIndex=0;const e=this.context;if(null==e)return void this._destroyUnusedLabels();const{components:t,geometry:s,coordinateHelper:o}=e.editGeometryOperations.data;if(!s)return void this._destroyUnusedLabels();const n=t.length;for(let r=0;r<n;++r){const a=[];if(t[r].iterateVertices((e=>{a.push(o.toXYZ(e.pos))})),0===r&&null!=this.stagedVertex&&a.push(o.toXYZ(this.stagedVertex)),a.length<2)continue;const i=a[0],l=a[a.length-1];"polygon"===s.type&&a.length>2&&!f.equals(i,l)&&a.push(i);const c=1===n&&!m.isClockwise(a,!1,!1);let d=C,h=P;this.toScreenPointArray(e,i,d);for(let t=1;t<a.length;++t){const s=a[t-1],o=a[t];this.toScreenPointArray(e,o,h),this._addLabel(e,s,d,o,h,c),[d,h]=[h,d]}}this._destroyUnusedLabels()},o._addLabel=function(e,t,s,o,n,r){const{label:a}=this._getOrCreateLabel(e);if(!this.visible||_.squaredDistance(s,n)<S)return void(a.visible=!1);const i=null!=e.graphicState?e.graphicState.isDraped?"on-the-ground":"absolute-height":v.getGeometryEffectiveElevationMode(e.editGeometryOperations.data.geometry,e.elevationInfo),{spatialReference:c}=e.editGeometryOperations.data,d=I.autoDirectDistanceByElevationMode(t,o,c,i),h=this._messagesUnits,p=L.getDefaultUnitForView(e.view);a.text=null!=h&&null!=d?l.formatLength(h,d,p):"",a.visible=!0;const u=n[0]-s[0],g=n[1]-s[1];r?_.set(k,-g,u):_.set(k,g,-u),_.normalize(k,k),_.scale(k,k,this._edgeDistancePixels),_.lerp(w,s,n,.5),_.add(w,w,k),a.position=[w[0],w[1]],Math.abs(k[0])>Math.abs(k[1])?a.anchor=k[0]>0?"left":"right":a.anchor=-k[1]<0?"top":"bottom"},o._getOrCreateLabel=function(e){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const t=new U({anchor:"center",fontSize:10,textColor:n.getTextColor(),backgroundColor:n.getTextHaloColor(.6)});e.view.overlay?.items.add(t);const s={label:t};return this._labelInfos.push(s),this._nextLabelIndex=this._labelInfos.length,s},o._destroyUnusedLabels=function(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())},o._destroyLabel=function({label:e}){this.context?.view.overlay?.items.remove(e),e.destroy()},t._createClass(s,[{key:"updating",get:function(){return null==this._messagesUnits}},{key:"test",get:function(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((e=>e.label.text))}}},{key:"_edgeDistancePixels",get:function(){return D[this.edgeDistance]}}]),s}(o),s.__decorate([h.property()],e.SegmentLabels.prototype,"context",void 0),s.__decorate([h.property()],e.SegmentLabels.prototype,"stagedVertex",void 0),s.__decorate([h.property()],e.SegmentLabels.prototype,"visible",void 0),s.__decorate([h.property()],e.SegmentLabels.prototype,"edgeDistance",void 0),s.__decorate([h.property()],e.SegmentLabels.prototype,"updating",null),s.__decorate([h.property()],e.SegmentLabels.prototype,"_messagesUnits",void 0),s.__decorate([h.property()],e.SegmentLabels.prototype,"_edgeDistancePixels",null),e.SegmentLabels=s.__decorate([b.subclass("esri.views.interactive")],e.SegmentLabels);const k=y.create(),w=y.create(),C=d.createScreenPointArray(),P=d.createScreenPointArray();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
