/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Accessor","../core/clock","../core/Collection","../core/HandleOwner","../core/handleUtils","../core/has","../core/Logger","../core/maybe","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/accessorSupport/decorators/subclass","./3d/support/TextureCollection","./input/InputManager","./input/ViewEvents","./interactive/interactiveToolUtils","./interactive/interfaces","./interactive/ToolViewManagerManipulatorState"],(function(t,e,o,i,a,r,n,s,l,c,u,h,p,d,_,v,T,g,m,f,y,E){"use strict";const w="attached",M="tools",S=1e3;t.ToolViewManager=function(t){function o(e){var o;return(o=t.call(this,e)||this)._clock=a.clock,o._manipulatorState=new E.ToolViewManagerManipulatorState,o.tools=new r,o.cursor=null,o._interacting=!1,o._interactingTimeout=null,o._forEachTool=t=>{for(const e of o.tools.items)if(t(e))return},o}e._inherits(o,t);var n=o.prototype;return n.initialize=function(){this.handles.add([this.view.on(m.eventTypes,(t=>{this._handleInputEvent(t)}),g.ViewEventPriorities.TOOL),...f.getToolCollectionHandles(this.tools),this.tools.on("before-add",(({item:t})=>{this._updateToolEditableFlag(t)})),this.tools.on("before-remove",(({item:t})=>{this._manipulatorState.clearPointers(t,this._manipulatorStateEventArgs),this._updateCursor()})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])},n.destroy=function(){this.detach(),this.handles.removeAll()},n._clearInteractingTimeout=function(){this._interactingTimeout=u.removeMaybe(this._interactingTimeout)},n._startInteractingTimeout=function(){this._clearInteractingTimeout(),this._interactingTimeout=this._clock.setTimeout((()=>this._interacting=!1),S)},n.attach=function(){"3d"===this.view.type?(this._set("textures",new T.TextureCollection(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([h.watch((()=>{const{state:t}=this.view;return"camera"in t&&t.camera}),(()=>this._forEachManipulator((t=>t.onViewChange())))),this.view.elevationProvider?.on("elevation-change",(t=>this._forEachManipulator((e=>e.onElevationChange(t))))),s.makeHandle((()=>this._set("textures",u.destroyMaybe(this.textures))))],w)):this.handles.add(h.watch((()=>this.view.extent),(()=>this._forEachManipulator((t=>t.onViewChange())))))},n.detach=function(){this.activeTool=null,this.tools.removeAll(),this.handles.remove(w),this._clearInteractingTimeout(),this._interacting=!1},n._forEachManipulator=function(t){this._forEachTool((e=>{e.manipulators&&e.manipulators.forEach((({manipulator:o})=>t(o,e)))}))},n._handleInputEvent=function(t){let e=!1;const o={...t,stopPropagation:()=>{e=!0,t.stopPropagation()}};null!=this.activeTool?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(o):this._forEachTool((t=>{!e&&t.visible&&t.handleInputEvent(o)})),!e&&"key-down"===t.type&&"Escape"===t.key&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(o,this._manipulatorStateEventArgs),e||null==this.activeTool||this.activeTool.handleInputEventAfter(o),this._manipulatorState.handleHoverEvent(o,this._forEachTool),this._updateCursor(),"pointer-move"===t.type&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())},n._refreshToolWatchers=function(){this.handles.remove(M),this._forEachTool((t=>{if(t instanceof i){const e=h.watch((()=>[t.cursor,t.visible,t.editable]),(()=>{f.areToolManipulatorsEditable(t)||this._manipulatorState.clearPointers(t,this._manipulatorStateEventArgs),this._updateCursor()}));this.handles.add(e,M)}t.manipulators&&this.handles.add([t.manipulators.on("after-remove",(e=>{this._manipulatorState.clearPointers(t,this._manipulatorStateEventArgs,!0,e.item.manipulator)})),t.manipulators.on("change",(()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}))],M)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()},n._updateToolEditableFlag=function(t){t.setEditableFlag?.(y.EditableFlag.MANAGER,null==this.activeTool||t===this.activeTool)},n._updateCursor=function(){let t=this._manipulatorState.cursor;null==t&&this._forEachTool((e=>!(null==e.cursor||!e.visible)&&(t=e.cursor,!0))),this._get("cursor")!==t&&this._set("cursor",t)},n._removeIncompleteTools=function(t){this.tools.filter((e=>(null==t||e!==t)&&!e.created&&e.removeIncompleteOnCancel)).forEach((t=>{this.tools.remove(t)}))},e._createClass(o,[{key:"_manipulatorStateEventArgs",get:function(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:t=>{this.activeTool=t},view:this.view}}},{key:"activeTool",set:function(t){if(null!=t&&!this.view.ready)return void c.getLogger(this).error("Cannot set active tool while view is not ready.");if(t===this.activeTool)return;const e=this.activeTool;this._set("activeTool",t),null!=e&&e.deactivate(),null!=t&&t.activate(),this._removeIncompleteTools(t);for(const o of this.tools){this._updateToolEditableFlag(o);const t=f.areToolManipulatorsEditable(o);null!=this.activeTool&&t||this._manipulatorState.clearPointers(o,this._manipulatorStateEventArgs,!t)}this._updateCursor()}},{key:"updating",get:function(){return this.updatingHandles.updating||this.tools.some((t=>t.updating))||(this.textures?.updating??!1)}},{key:"interacting",get:function(){return this._interacting}},{key:"test",get:function(){return{setClock:t=>this._clock=t}}}]),o}(n.HandleOwner),o.__decorate([p.property({constructOnly:!0,nonNullable:!0})],t.ToolViewManager.prototype,"view",void 0),o.__decorate([p.property({readOnly:!0,nonNullable:!0})],t.ToolViewManager.prototype,"textures",void 0),o.__decorate([p.property({value:null})],t.ToolViewManager.prototype,"activeTool",null),o.__decorate([p.property({readOnly:!0,type:r})],t.ToolViewManager.prototype,"tools",void 0),o.__decorate([p.property({readOnly:!0})],t.ToolViewManager.prototype,"cursor",void 0),o.__decorate([p.property({readOnly:!0})],t.ToolViewManager.prototype,"updating",null),o.__decorate([p.property()],t.ToolViewManager.prototype,"_interacting",void 0),o.__decorate([p.property({readOnly:!0})],t.ToolViewManager.prototype,"interacting",null),t.ToolViewManager=o.__decorate([v.subclass("esri.views.ToolViewManager")],t.ToolViewManager),t.INTERACTING_TIMEOUT=S,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
