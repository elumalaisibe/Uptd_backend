/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../core/Evented","../../core/HandleOwner","../../core/handleUtils","../../core/maybe","../../core/quantityUtils","../../core/reactiveUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../support/elevationInfoUtils","./support/createUtils","./support/helpMessageUtils","./support/surfaceCoordinateSystems","../interactive/InteractiveToolBase","../interactive/sketch/SketchLabelOptions","../interactive/sketch/SketchTooltipOptions","../interactive/tooltip/DrawTooltipInfos","../interactive/tooltip/Tooltip","../support/automaticAreaMeasurementUtils","../support/automaticLengthMeasurementUtils"],(function(e,t,o,r,i,n,a,l,p,s,c,u,h,d,y,_,g,f,w,v,m,T,G,O,D,M,k,V){"use strict";let x=t._createClass((function(){this.regularVertices=null,this.activeVertex=null,this.full=null,this.outline=null,this.circle=null,this.rectangle=null}));e.DrawGraphicTool=function(e){function o(t){var o;return(o=e.call(this,t)||this)._graphic=null,o._createOperationGeometry=null,o.defaultZ=0,o.geometryType=null,o.hasZ=!0,o.labelOptions=new G,o.geometryToPlace=null,o.mode=null,o.snappingManager=null,o.snapToScene=!1,o.tooltip=null,o.tooltipOptions=new O,o}t._inherits(o,e);var i=o.prototype;return i.initialize=function(){this.internalGraphicsLayer=new g({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e))),s.watch((()=>this.tooltipOptions.enabled),(e=>{this.tooltip=e?new M.Tooltip({view:this.view,info:this._tooltipInfo}):l.destroyMaybe(this.tooltip)}),s.syncAndInitial),s.watch((()=>this._tooltipInfo),(e=>{null!=this.tooltip&&(this.tooltip.info=e)}),s.syncAndInitial)]),this.finishToolCreation()},i.destroy=function(){this.drawOperation=l.destroyMaybe(this.drawOperation),this.tooltip=l.destroyMaybe(this.tooltip),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=l.destroyMaybe(this.internalGraphicsLayer),this._set("view",null)},i.completeCreateOperation=function(){this.drawOperation.complete()},i.onInputEvent=function(e){this.drawOperation.onInputEvent(e)},i.redo=function(){this.drawOperation.redo()},i.reset=function(){},i.undo=function(){this.drawOperation.undo()},i._destroyAllVisualisations=function(){this.handles.remove(b.outline),this.handles.remove(b.regularVertices),this.handles.remove(b.activeVertex),this.handles.remove(S)},i._createOrUpdateGraphic=function(e){if(null!=this._graphic)return this._updateGraphicGeometry(this._graphic,e),this._graphic;const t=this._graphic=new r({...this.graphicProperties,symbol:this.graphicSymbol});return this._updateGraphicGeometry(t,e),this.internalGraphicsLayer.add(t),this.handles.add(this.initializeGraphic(t)),this.notifyChange("graphic"),this.handles.add(a.makeHandle((()=>{this.internalGraphicsLayer.remove(t),l.destroyMaybe(t),this._graphic===t&&(this._graphic=null)})),S),t},i._updateGraphicGeometry=function(e,t){e.geometry=t},i._getCreateOperationGeometry=function(e={operationComplete:!1}){const{drawOperation:t}=this;if(null==t||0===t.numVertices)return null;const{coordinateHelper:o,view:r}=t,i=t.stagedVertex,n=t.committedVertices,a=n.slice(),l=null!=i;l&&a.push(o.pointToArray(i));const p=l?o.pointToArray(i):n.splice(-1)[0],s=a.length,c=r.spatialReference,u="3d"===r.type&&"global"===r.viewingMode,h=new x;switch(this.geometryType){case"point":case"mesh":h.regularVertices=n,h.activeVertex=p,h.full=o.arrayToPoint(a[0]);break;case"multipoint":h.regularVertices=n,h.activeVertex=p,s>0&&(h.full=w.createMultipoint(a,c));break;case"polyline":h.regularVertices=n,h.activeVertex=p,s>0&&(h.full=w.createPolyline([a],c,u));break;case"polygon":h.regularVertices=n,h.activeVertex=p,s>0&&(h.full=w.createPolygon([a],c,u,!0));break;case"circle":if(s>0){const t=m.createViewAlignedCoordinateSystem(r,a[0]);if(1===s&&e.operationComplete){const e=a[0],o=t.makeMapPoint(e[0]+z*r.resolution,e[1]);h.circle=w.createCircle([e,o],t,!0),h.full=null!=h.circle?h.circle.geometry:null}else 2===s&&(this.forceUniformSize?(h.circle=w.createCircle(a,t,this.centered),h.full=null!=h.circle?h.circle.geometry:null):(h.rectangle=w.createEllipse(a,t,this.centered),h.full=h.rectangle.geometry))}break;case"rectangle":if(s>0){const t=m.createViewAlignedCoordinateSystem(r,a[0]);if(1===s&&e.operationComplete){const e=a[0],o=t.makeMapPoint(e[0]+z*r.resolution,e[1]);h.rectangle=w.createSquare([e,o],t,!0),h.full=h.rectangle.geometry}else 2===s&&(h.rectangle=this.forceUniformSize?w.createSquare(a,t,this.centered):w.createRectangle(a,t,this.centered),h.full=h.rectangle.geometry)}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":h.outline=s>1?w.createPolyline([a],c,u):null;break;case"polygon":h.outline=s>1?w.createPolygon([a],c,u):null;break;case"circle":case"rectangle":h.outline="polygon"===h.full?.type?w.createPolygon(h.full.rings,c,u):null}return h},i.initializeGraphic=function(e){return null},i.onComplete=function(e){this._updateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateOperationGeometry({operationComplete:!0});null!=e&&(t=this._createOrUpdateGraphic(e.full).clone())}this._createOperationGeometry=null,this.emit("complete",{graphic:t,...e})},i.onCursorUpdate=function(e){this._updateGraphic(),this.emit("cursor-update",e)},i.onDeactivate=function(){this.drawOperation.isCompleted||this.drawOperation.cancel()},i.onVertexAdd=function(e){this._updateGraphic(),this.emit("vertex-add",e)},i.onVertexRemove=function(e){this._updateGraphic(),this.emit("vertex-remove",e)},i.onVertexUpdate=function(e){this._updateGraphic(),this.emit("vertex-update",e)},i._updateGraphic=function(){const e=this._getCreateOperationGeometry();this._createOperationGeometry=e,null!=e?(null!=e.outline?this.handles.add(this.onOutlineChanged(e.outline),b.outline):this.handles.remove(b.outline),null!=e.regularVertices?this.handles.add(this.onRegularVerticesChanged(e.regularVertices),b.regularVertices):this.handles.remove(b.regularVertices),null!=e.activeVertex?this.handles.add(this.onActiveVertexChanged(e.activeVertex),b.activeVertex):this.handles.remove(b.activeVertex),null!=e.full?this._createOrUpdateGraphic(e.full):this.handles.remove(S)):this._destroyAllVisualisations()},t._createClass(o,[{key:"_defaultElevation",get:function(){return p.createLength(this.defaultZ,"meters")}},{key:"canRedo",get:function(){return this.drawOperation.canRedo}},{key:"canUndo",get:function(){return this.drawOperation.canUndo}},{key:"centered",set:function(e){this._set("centered",e),this._updateGraphic()}},{key:"enabled",set:function(e){this.drawOperation.interactive=e,this._set("enabled",e)}},{key:"forceUniformSize",set:function(e){this._set("forceUniformSize",e),this._updateGraphic()}},{key:"graphic",get:function(){return this._graphic}},{key:"graphicSymbol",set:function(e){this._set("graphicSymbol",e),null!=this._graphic&&(this._graphic.symbol=e)}},{key:"updating",get:function(){return this.drawOperation?.updating??!1}},{key:"_tooltipInfo",get:function(){const{drawOperation:e}=this;if(!e)return null;switch(this.geometryType){case"point":return this._drawPointTooltipInfo;case"polyline":return this._drawPolylineTooltipInfo;case"polygon":return this._drawPolygonTooltipInfo;case"rectangle":return this._drawRectangleTooltipInfo;case"circle":return this._drawCircleTooltipInfo;case"mesh":return this._drawMeshTooltipInfo;default:return null}}},{key:"_drawPointTooltipInfo",get:function(){const{view:e,graphic:t}=this,o=t?.geometry;return"point"!==o?.type||"2d"===e.type&&0===this.defaultZ?null:new D.DrawPointTooltipInfo({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:e.type,helpMessage:v.getDrawHelpMessage("point",o,e)})}},{key:"_drawPolylineTooltipInfo",get:function(){const e=this._createOperationGeometry,t=null!=e?e.full:null;if("polyline"!==t?.type)return null;const o=V.autoLengthByElevationMode(t,this._elevationMode),{view:r}=this;return new D.DrawPolylineTooltipInfo({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,totalLength:o??p.zeroMeters,viewType:r.type,helpMessage:v.getDrawHelpMessage("polyline",t,r)})}},{key:"_drawPolygonTooltipInfo",get:function(){const e=this._createOperationGeometry,t=null!=e?e.full:null;if("polygon"!==t?.type)return null;const o=k.autoAreaByElevationMode(t,this._elevationMode),{view:r}=this;return new D.DrawPolygonTooltipInfo({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,area:o??p.zeroSquareMeters,viewType:r.type,helpMessage:v.getDrawHelpMessage("polygon",t,r)})}},{key:"_drawMeshTooltipInfo",get:function(){const{view:e,graphic:t}=this,o=t?.geometry;return"mesh"!==o?.type||"2d"===e.type&&0===this.defaultZ?null:new D.DrawMeshTooltipInfo({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:e.type,helpMessage:v.getDrawHelpMessage("mesh",o,e)})}},{key:"_drawRectangleTooltipInfo",get:function(){return null==this.drawOperation?null:new D.DrawRectangleTooltipInfo({tooltipOptions:this.tooltipOptions,xSize:this._xSize??p.zeroMeters,ySize:this._ySize??p.zeroMeters,area:this._fullGeometryArea??p.zeroSquareMeters})}},{key:"_drawCircleTooltipInfo",get:function(){if(null==this.drawOperation)return null;const e=this.forceUniformSize;return new D.DrawCircleTooltipInfo({tooltipOptions:this.tooltipOptions,radius:e?this._circleRadius??p.zeroMeters:null,xSize:e?null:this._xSize??p.zeroMeters,ySize:e?null:this._ySize??p.zeroMeters,area:this._fullGeometryArea??p.zeroSquareMeters})}},{key:"_circleRadius",get:function(){const e=this._createOperationGeometry;return null!=e&&null!=e.circle&&null!=e.circle.center&&null!=e.circle.edge?V.autoHorizontalDistanceByElevationModeBetweenPoints(e.circle.center,e.circle.edge,this._elevationMode):null}},{key:"_xSize",get:function(){const e=this._createOperationGeometry;if(null==e?.rectangle)return null;const{midpoints:t}=e.rectangle;return null!=t?V.autoHorizontalDistanceByElevationModeBetweenPoints(t.left,t.right,this._elevationMode):null}},{key:"_ySize",get:function(){const e=this._createOperationGeometry;if(null==e?.rectangle)return null;const{midpoints:t}=e.rectangle;return null!=t?V.autoHorizontalDistanceByElevationModeBetweenPoints(t.top,t.bottom,this._elevationMode):null}},{key:"_fullGeometryArea",get:function(){const e=this._createOperationGeometry,t=null!=e?e.full:null;return"polygon"!==t?.type?null:k.autoAreaByElevationMode(t,this._elevationMode)}},{key:"_elevationTooltipDetail",get:function(){return{mode:this.drawOperation.elevationInfo.mode,...this._vertexTooltipElevation}}},{key:"_vertexTooltipElevation",get:function(){const{tooltipOptions:e,view:t,drawOperation:o}=this;if(null==o)return this._defaultElevation;const r=o.stagedVertex??o.lastVertex;if(null==r||"2d"===t.type)return this._defaultElevation;const i={mode:e.elevation.mode,offset:0},n=(f.getConvertedElevation(t,r,o.elevationInfo,i)??0)*c.getMetersPerVerticalUnitForSR(r.spatialReference);return p.createLength(n,"meters")}},{key:"_elevationMode",get:function(){return this.drawOperation.isDraped?"on-the-ground":"absolute-height"}}]),o}(n.HandleOwnerMixin(i.EventedMixin(T.InteractiveToolBase))),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_createOperationGeometry",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_defaultElevation",null),o.__decorate([u.property({value:!0})],e.DrawGraphicTool.prototype,"centered",null),o.__decorate([u.property({nonNullable:!0})],e.DrawGraphicTool.prototype,"defaultZ",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"drawOperation",void 0),o.__decorate([u.property({value:!0})],e.DrawGraphicTool.prototype,"enabled",null),o.__decorate([u.property({value:!0})],e.DrawGraphicTool.prototype,"forceUniformSize",null),o.__decorate([u.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryType",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"graphic",null),o.__decorate([u.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"graphicProperties",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"graphicSymbol",null),o.__decorate([u.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"hasZ",void 0),o.__decorate([u.property({constructOnly:!0,type:G})],e.DrawGraphicTool.prototype,"labelOptions",void 0),o.__decorate([u.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryToPlace",void 0),o.__decorate([u.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"mode",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"snappingManager",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"snapToScene",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"tooltip",void 0),o.__decorate([u.property({constructOnly:!0,type:O})],e.DrawGraphicTool.prototype,"tooltipOptions",void 0),o.__decorate([u.property({readOnly:!0})],e.DrawGraphicTool.prototype,"type",void 0),o.__decorate([u.property({readOnly:!0})],e.DrawGraphicTool.prototype,"updating",null),o.__decorate([u.property({constructOnly:!0,nonNullable:!0})],e.DrawGraphicTool.prototype,"view",void 0),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_tooltipInfo",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_drawPointTooltipInfo",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_drawPolylineTooltipInfo",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_drawPolygonTooltipInfo",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_drawMeshTooltipInfo",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_drawRectangleTooltipInfo",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_drawCircleTooltipInfo",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_circleRadius",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_xSize",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_ySize",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_fullGeometryArea",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_elevationTooltipDetail",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_vertexTooltipElevation",null),o.__decorate([u.property()],e.DrawGraphicTool.prototype,"_elevationMode",null),e.DrawGraphicTool=o.__decorate([_.subclass("esri.views.draw.DrawGraphicTool")],e.DrawGraphicTool);const S="create-operation-graphic",b={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function I(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const z=48;e.CreateOperationGeometry=x,e.geometryTypeToDrawOperationGeometryType=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
