/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../geometry","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../ViewingMode","./DrawAction","./DrawTool","./input/DrawEvents","./support/surfaceCoordinateSystems","../input/InputManager","../interactive/keybindings","../interactive/editGeometry/EditGeometry","../interactive/editGeometry/EditGeometryOperations","../support/screenUtils","../../geometry/Point"],(function(e,t,i,r,n,o,s,a,d,h,l,c,p,_,v,u,w,g,m,y,P){"use strict";const S=["freehand","click"];e.SegmentDrawAction=function(e){function i(t){var i;return(i=e.call(this,t)||this)._isDragging=!1,i._panEnabled=!1,i._addVertexOnPointerUp=!1,i.viewAlignedCoordinateSystem=null,i.mode="freehand",i}t._inherits(i,e);var r=i.prototype;return r.initialize=function(){"2d"===this.view.type?this._addViewHandles():this._addDrawTool()},r.destroy=function(){"2d"===this.view.type?this._removeViewHandles():this._removeDrawTool(),this.emit("destroy")},r.complete=function(){"2d"===this.view.type?this._completeDrawing():this._drawTool.completeCreateOperation()},r._getGeometryZValue=function(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ},r._addViewHandles=function(){this._removeViewHandles(),"click"===this.mode?this._handles.add(this._getClickModeViewHandles(),this._viewHandlesKey):this._handles.add(this._getDragModeViewHandles(),this._viewHandlesKey)},r._getDragModeViewHandles=function(){return[this.view.on("immediate-click",(e=>{if(e.stopPropagation(),e.mapPoint&&!this._panEnabled){null!=this.getCoordsFromScreenPoint(y.createScreenPointFromEvent(e))&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))}}),u.ViewEventPriorities.TOOL),this.view.on("pointer-down",(e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=y.createScreenPointFromEvent(e),this._activePointerId=e.pointerId,this._vertexAddHandler(e),this._isDragging=!1,"touch"===e.pointerType&&this._updateCursor(e.native)))}),u.ViewEventPriorities.TOOL),this.view.on("pointer-move",(e=>{this._abortSnapping(),null==this._activePointerId&&"touch"!==e.pointerType&&(this._cursorScreenPoint=y.createScreenPointFromEvent(e),this._updateCursor(e.native))}),u.ViewEventPriorities.TOOL),this.view.on("pointer-drag",(e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=y.createScreenPointFromEvent(e),this._updateCursor(e.native))}),u.ViewEventPriorities.TOOL),this.view.on("pointer-up",(e=>{this._shouldHandlePointerEvent(e)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(e),2===this._committedVertices.length&&this._drawCompleteHandler(e),this._isDragging=!1)}),u.ViewEventPriorities.TOOL),this.view.on("key-down",(e=>{e.key===w.SKETCH_KEYS.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key===w.SKETCH_KEYS.pan&&(this._panEnabled=!0)}),u.ViewEventPriorities.TOOL),this.view.on("key-up",(e=>{e.key===w.SKETCH_KEYS.pan&&(this._panEnabled=!1)}),u.ViewEventPriorities.TOOL),this.view.on("drag",(e=>{null!=this._activePointerId&&e.stopPropagation()}),u.ViewEventPriorities.TOOL),this.view.on("drag",["Shift"],(e=>{e.stopPropagation()}),u.ViewEventPriorities.TOOL)]},r._getClickModeViewHandles=function(){return[this.view.on("pointer-down",(e=>{this._abortSnapping(),this._cursorScreenPoint=y.createScreenPointFromEvent(e),this._activePointerId=e.pointerId,this._isDragging=!1,"touch"===e.pointerType&&this._updateCursor(e.native)}),u.ViewEventPriorities.TOOL),this.view.on("pointer-move",(e=>{this._abortSnapping(),this._cursorScreenPoint=y.createScreenPointFromEvent(e),null==this._activePointerId&&"touch"!==e.pointerType&&this._updateCursor(e.native)}),u.ViewEventPriorities.TOOL),this.view.on("pointer-drag",(e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0)}),u.ViewEventPriorities.TOOL),this.view.on("pointer-up",(e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=null,e.stopPropagation(),this._isDragging||this._vertexAddHandler(e),2!==this.vertices.length||this._isDragging||this._drawCompleteHandler(e),this._isDragging=!1)}),u.ViewEventPriorities.TOOL),this.view.on("key-down",(e=>{e.key===w.SKETCH_KEYS.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(e),2===this.vertices.length&&this._drawCompleteHandler(e)),e.key===w.SKETCH_KEYS.complete&&this._cursorScreenPoint&&2===this.vertices.length&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))}),u.ViewEventPriorities.TOOL)]},r._removeViewHandles=function(){this._handles.remove(this._viewHandlesKey)},r._addDrawTool=function(){this._drawTool=new p.DrawTool({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode}),this.view.addAndActivateTool(this._drawTool),this._handles.add([this._drawTool.on("vertex-add",(e=>{1===e.vertices.length&&this.emit("vertex-add",new _.VertexAddEvent(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))})),this._drawTool.on("cursor-update",(e=>{1===e.vertices.length&&this.emit("cursor-update",new _.CursorUpdateEvent(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))})),this._drawTool.on("complete",(e=>{this.emit("draw-complete",new _.DrawCompleteEvent(null,this._drawTool.getVertexCoords())),this._removeDrawTool()}))],this._drawToolHandlesKey)},r._removeDrawTool=function(){this._handles.remove(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=n.destroyMaybe(this._drawTool)},r._addVertex=function(e,t){const i=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i),1===this._committedVertices.length&&(this.viewAlignedCoordinateSystem=v.createViewAlignedCoordinateSystem(this.view,this._committedVertices[0]));const r=this._committedVertices.length-1,n=new _.VertexAddEvent(this.view,t,r,this.vertices);this.emit("vertex-add",n)},r._updateCursor=function(e){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);null!=t&&this._pushCursorVertex(t.vertex,(()=>this.emit("cursor-update",new _.CursorUpdateEvent(this.view,e,this._activeComponent.vertices.length,this.vertices,null!=this._stagedVertex?new P(this._stagedVertex):null))))},r._completeDrawing=function(e){if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),null!=this._snappingManager&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new _.DrawCompleteEvent(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()},r._resetGeometry=function(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new m.EditGeometryOperations(new g.EditGeometry("polygon",this._coordinateHelper)),this._activeComponent=new g.Component(this._coordinateHelper.spatialReference,l.ViewingMode.Local),this._editGeometryOperations.data.components.push(this._activeComponent)},t._createClass(i)}(c),i.__decorate([o.property({type:S})],e.SegmentDrawAction.prototype,"mode",void 0),e.SegmentDrawAction=i.__decorate([h.subclass("esri/views/2d/engine/markup/SegmentDrawAction")],e.SegmentDrawAction),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
