/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/arrayUtils","../../core/Logger","../../core/maybe","../../core/maybeUpdating","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/projection","./LayerView"],(function(e,t,r,o,n,i,l,a,s,c,p,u,y,d,g){"use strict";const m="esri.views.layers.SceneLayerView",h=n.getLogger(m);let f=function(r){function n(){var e;return(e=r.apply(this,arguments)||this).layer=null,e.filter=null,e._geometryEngine=null,e._projectionEngineLoaded=!1,e._abortController=new AbortController,e}t._inherits(n,r);var c=n.prototype;return c.initialize=function(){const{signal:t}=this._abortController;s.whenOnce((()=>this.destroyed||!this._geometryEngine&&this.layer?.filter?.geometries?.length),t).then((async()=>{a.throwIfAbortError(t),this._geometryEngine=await new Promise(((t,r)=>e(["../../geometry/geometryEngine"],t,r)))})).catch(a.throwIfNotAbortError),this._projectionEngineLoaded=d.isLoaded(),s.whenOnce((()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine),t).then((async()=>{a.throwIfAbortError(t),await d.load(),this._projectionEngineLoaded=!0})).catch(a.throwIfNotAbortError)},c.destroy=function(){this._abortController=i.abortMaybe(this._abortController)},c.highlight=function(e){throw new Error("Not implemented")},c.queryFeatures=function(e,t){throw new Error("Not implemented")},c.queryObjectIds=function(e,t){throw new Error("Not implemented")},c.queryFeatureCount=function(e,t){throw new Error("Not implemented")},c.createQuery=function(){throw new Error("Not implemented")},c.queryExtent=function(e,t){throw new Error("Not implemented")},t._createClass(n,[{key:"availableFields",get:function(){return[]}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){throw new Error("Not implemented")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"layerFilter",get:function(){return l.unwrapUpdating(this._layerFilter)}},{key:"_layerFilter",get:function(){const e=this.layer.filter;if(null==e||e.geometries.length<1)return null;const t=this._geometryEngine;if(null==t||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return l.updating;const r=e.geometries.at(0).spatialReference,n=e.geometries.toArray().map((e=>{try{e=t.simplify(e)}catch(o){return h.warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(null==e)return null;if(e.spatialReference.equals(r))return e;try{return d.project(e,r)}catch(o){return h.warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}})).filter(o.isSome).sort(((e,t)=>e.extent.xmin-t.extent.xmin)),i=new Set,a=new Array,s=new Array;for(let o of n){const e=o.extent.xmin;if(a.length=0,i.forEach((r=>{if(e>=r.extent.xmax)return s.push(r),void i.delete(r);o.extent.ymin<=r.extent.ymax&&o.extent.ymax>=r.extent.ymin&&t.intersects(o,r)&&a.push(r)})),a.length>0){a.push(o);try{o=t.union(a)}catch(c){h.warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}a.pop(),a.forEach((e=>i.delete(e)))}i.add(o)}return i.forEach((e=>s.push(e))),s.length>0?{spatialRelationship:e.spatialRelationship,geometries:s}:null}},{key:"_filterNeedsProjectionEngine",get:function(){const e=this.layer.filter;if(null==e||e.geometries.length<=1)return!1;const t=e.geometries.at(0).spatialReference;return e.geometries.some((({spatialReference:e})=>!e.equals(t)&&!d.canProjectWithoutEngine(e,t)))}},{key:"layerFilterUpdating",get:function(){return l.isUpdating(this._layerFilter)}}]),n}(g);r.__decorate([c.property()],f.prototype,"layer",void 0),r.__decorate([c.property()],f.prototype,"availableFields",null),r.__decorate([c.property()],f.prototype,"maximumNumberOfFeatures",null),r.__decorate([c.property({readOnly:!0})],f.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([c.property()],f.prototype,"filter",void 0),r.__decorate([c.property({readOnly:!0})],f.prototype,"layerFilter",null),r.__decorate([c.property({readOnly:!0})],f.prototype,"_layerFilter",null),r.__decorate([c.property()],f.prototype,"_geometryEngine",void 0),r.__decorate([c.property()],f.prototype,"_projectionEngineLoaded",void 0),r.__decorate([c.property()],f.prototype,"_filterNeedsProjectionEngine",null),r.__decorate([c.property()],f.prototype,"layerFilterUpdating",null),f=r.__decorate([y.subclass(m)],f);return f}));
