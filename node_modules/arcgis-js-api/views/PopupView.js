/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/asyncUtils","../core/deprecate","../core/Error","../core/Logger","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./input/InputManager"],(function(e,p,t,i,o,s,r,n,a,u,c,l,h,d,y,w){"use strict";const P=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function f(e){return null!=e&&"open"in e&&"declaredClass"in e}function g(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}const _=p=>{let l=function(p){function i(){var e;return(e=p.apply(this,arguments)||this)._popupSetupTask=null,e.popup={},e.popupEnabled=!0,e}t._inherits(i,p);var s=i.prototype;return s.initialize=function(){this.addHandles([u.watch((()=>[this.ui,this.popup]),(([e,p],t)=>{const i="popup",o="manual";if(t){const[e,p]=t;e&&f(p)&&(p.view=null,g(p)&&e.remove(p,i))}e&&f(p)&&(p.view=this,g(p)&&e.add(p,{key:i,position:o,internal:!0}))}),u.initial),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(!f(this.popup)&&"autoOpenEnabled"in this.popup&&!1===this.popup.autoOpenEnabled||(f(this.popup)?this.popup.viewModel.handleViewClick(e):e.async((async()=>{await this.setupPopup(),f(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)}))))}),w.ViewEventPriorities.WIDGET)]),u.whenOnce((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{new Promise(((p,t)=>e(["../widgets/Popup"],(e=>p(P(e))),t)))}))},s.destroy=function(){this.destroyed||this.closePopup()},s.openPopup=async function(e){f(this.popup)&&this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void n.getLogger(this).error(new r("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}},s.closePopup=function(){this._popupSetupTask?.abort(),f(this.popup)&&this.popup.close()},s.fetchPopupFeatures=async function(e,p){await this.when();const{location:t,queryArea:i,layerViewsAndGraphics:o,clientOnlyGraphics:s}=await this._prepareFetchPopupFeatures(e,p),r=Promise.resolve(s),n=this._queryLayerPopupFeatures(i,o,p),u=n.map((e=>e.promise));return{location:t,clientOnlyGraphics:s,allGraphicsPromise:a.eachAlwaysValues([r,...u]).then((e=>Array.from(new Set(e.flat())))),promisesPerLayerView:n}},s.setupPopup=async function(){if(this._popupSetupTask?.abort(),this.popup&&!f(this.popup))return this._popupSetupTask=o.createTask((async p=>{const{default:t}=await new Promise(((p,t)=>e(["../widgets/Popup"],(e=>p(P(e))),t)));if(a.throwIfAborted(p),!this.popup||f(this.popup))return;const i=this.popup;delete i.open,delete i.close,this.popup=new t(i)})),this._popupSetupTask.promise},s._queryLayerPopupFeatures=function(e,p,t){return p.map((({layerView:p,graphics:i})=>{const o={clientGraphics:i,event:null!=t?t.event:void 0,signal:null!=t?t.signal:void 0,defaultPopupTemplateEnabled:null!=t&&!!t.defaultPopupTemplateEnabled},s=p.fetchPopupFeatures(e,o);return{layerView:p,promise:s}}))},s._isValidPopupGraphic=function(e,p){return e&&!!e.getEffectivePopupTemplate(null!=p&&p.defaultPopupTemplateEnabled)},s._prepareFetchPopupFeatures=async function(e,p){const{clientGraphics:t,queryArea:i,location:o}=await this._popupHitTestGraphics(e,p),s=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:r,clientOnlyGraphics:n}=this._graphicsPerFetchPopupLayerView(t,s);return{clientOnlyGraphics:n,layerViewsAndGraphics:r,queryArea:i,location:o}},s._popupHitTestGraphics=async function(e,p){const t=await this.popupHitTest(e),i=t.results,o=t.mapPoint,s=i.filter((e=>"graphic"===e.type&&this._isValidPopupGraphic(e.graphic,p))),r=s.length?s[0].mapPoint:null;return{clientGraphics:s.map((e=>e.graphic)),queryArea:o,location:o||r}},s._getFetchPopupLayerViews=function(){const e=[];return this.allLayerViews.forEach((p=>{this._isValidPopupLayerView(p)&&e.push(p)})),null!=this.graphicsView&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()},s._isValidPopupLayerView=function(e){return null!=e&&(!("layer"in e)||!e.suspended)&&"fetchPopupFeatures"in e},s._graphicsPerFetchPopupLayerView=function(e,p){const t=[],i=new Map,o=p.map((e=>{const p=[];return"layer"in e?i.set(e.layer,p):i.set(e.graphics,p),{layerView:e,graphics:p}}));for(const s of e){const e=i.get(s.layer)||i.get(s.sourceLayer)||null;e?e.push(s):t.push(s)}return{layerViewsAndGraphics:o,clientOnlyGraphics:t}},t._createClass(i)}(p);return i.__decorate([c.property({cast(e){return!e||f(e)||"object"==typeof e&&(e.open=e=>(s.deprecated(n.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"}),this.openPopup(e)),e.close=()=>(s.deprecated(n.getLogger(this),"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"}),this.closePopup())),e}})],l.prototype,"popup",void 0),i.__decorate([c.property()],l.prototype,"popupEnabled",void 0),l=i.__decorate([y.subclass("esri.views.PopupView")],l),l};p.PopupView=_,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})}));
