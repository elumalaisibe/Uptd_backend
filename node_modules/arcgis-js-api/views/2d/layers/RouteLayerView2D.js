/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/arrayUtils","../../../core/Collection","../../../core/CollectionFlattener","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../rest/support/DirectionLine","../../../rest/support/DirectionPoint","../../../rest/support/PointBarrier","../../../rest/support/PolygonBarrier","../../../rest/support/PolylineBarrier","../../../rest/support/RouteInfo","../../../rest/support/Stop","./LayerView2D","./graphics/GraphicContainer","./graphics/GraphicsView2D","../../layers/LayerView"],(function(e,t,i,r,s,n,a,o,h,c,p,l,u,g,d,_,f,w,y,m,k){"use strict";const v=Object.freeze({remove(){},pause(){},resume(){}}),M=["route-info","direction-line","direction-point","polygon-barrier","polyline-barrier","point-barrier","stop"],V={graphic:null,property:null,oldValue:null,newValue:null};function G(e){return e instanceof p||e instanceof l||e instanceof u||e instanceof g||e instanceof d||e instanceof _||e instanceof f}function I(e){return r.isCollection(e)&&e.length&&G(e.at(0))}function F(e){return Array.isArray(e)&&e.length>0&&G(e[0])}let C=function(t){function a(){var e;return(e=t.apply(this,arguments)||this)._graphics=new r,e._highlightIds=new Map,e._networkFeatureMap=new Map,e._networkGraphicMap=new Map,e}e._inherits(a,t);var o=a.prototype;return o.initialize=function(){this.updatingHandles.addOnCollectionChange((()=>this._routeItems),(e=>this._routeItemsChanged(e)),n.initial)},o.destroy=function(){this._networkFeatureMap.clear(),this._networkGraphicMap.clear(),this._graphics.removeAll(),this._get("_routeItems")?.destroy()},o.attach=function(){this._createGraphicsView()},o.detach=function(){this._destroyGraphicsView()},o.fetchPopupFeatures=async function(e){return this._graphicsView.hitTest(e).filter((e=>!!e.popupTemplate))},o.highlight=function(e){let t;t=G(e)?[this._getNetworkFeatureUid(e)]:F(e)?e.map((e=>this._getNetworkFeatureUid(e))):I(e)?e.map((e=>this._getNetworkFeatureUid(e))).toArray():[e.uid];const r=t.filter(i.isSome);return r.length?(this._addHighlight(r),{remove:()=>this._removeHighlight(r)}):v},o.hitTest=async function(e,t){if(this.suspended)return null;const r=this._graphicsView.hitTest(e).filter(i.isSome).map((e=>this._networkGraphicMap.get(e)));if(!r.length)return null;const{layer:s}=this;return r.reverse().map((t=>({type:"route",layer:s,mapPoint:e,networkFeature:t})))},o.isUpdating=function(){return this._graphicsView.updating},o.moveStart=function(){},o.moveEnd=function(){},o.update=function(e){this._graphicsView.processUpdate(e)},o.viewChange=function(){this._graphicsView.viewChange()},o._addHighlight=function(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t);this._highlightIds.set(t,e+1)}else this._highlightIds.set(t,1);this._updateHighlight()},o._createGraphic=function(e){const t=e.toGraphic();return t.layer=this.layer,t.sourceLayer=this.layer,t},o._createGraphicsView=function(){const e=this.view,t=()=>this.requestUpdate(),i=new y(e.featuresTilingScheme);this._graphicsView=new m({container:i,graphics:this._graphics,requestUpdateCallback:t,view:e}),this.container.addChild(i),this._updateHighlight()},o._destroyGraphicsView=function(){this.container.removeChild(this._graphicsView.container),this._graphicsView.destroy()},o._getDrawOrder=function(e){const t=this._networkGraphicMap.get(e);return M.indexOf(t.type)},o._getNetworkFeatureUid=function(e){return this._networkFeatureMap.has(e)?this._networkFeatureMap.get(e).uid:null},o._removeHighlight=function(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t)-1;0===e?this._highlightIds.delete(t):this._highlightIds.set(t,e)}this._updateHighlight()},o._routeItemsChanged=function(e){if(e.removed.length){this._graphics.removeMany(e.removed.map((e=>{const t=this._networkFeatureMap.get(e);return this._networkFeatureMap.delete(e),this._networkGraphicMap.delete(t),t})));for(const t of e.removed)this.removeHandles(t)}if(e.added.length){this._graphics.addMany(e.added.map((e=>{const t=this._createGraphic(e);return null==t.symbol?null:(this._networkFeatureMap.set(e,t),this._networkGraphicMap.set(t,e),t)})).filter(i.isSome));for(const t of e.added)this.addHandles([n.watch((()=>t.geometry),((e,i)=>{this._updateGraphic(t,"geometry",e,i)})),n.watch((()=>t.symbol),((e,i)=>{this._updateGraphic(t,"symbol",e,i)}))],t);this._graphics.sort(((e,t)=>this._getDrawOrder(e)-this._getDrawOrder(t)))}},o._updateGraphic=function(e,t,i,r){if(!this._networkFeatureMap.has(e)){const t=this._createGraphic(e);return this._networkFeatureMap.set(e,t),this._networkGraphicMap.set(t,e),void this._graphics.add(t)}const s=this._networkFeatureMap.get(e);s[t]=i,V.graphic=s,V.property=t,V.oldValue=r,V.newValue=i,this._graphicsView.graphicUpdateHandler(V)},o._updateHighlight=function(){const e=Array.from(this._highlightIds.keys());this._graphicsView.setHighlight(e)},e._createClass(a,[{key:"_routeItems",get:function(){return new s({getCollections:()=>null==this.layer||this.destroyed?[]:[null!=this.layer.routeInfo?new r([this.layer.routeInfo]):null,this.layer.directionLines,this.layer.directionPoints,this.layer.polygonBarriers,this.layer.polylineBarriers,this.layer.pointBarriers,this.layer.stops]})}}]),a}(w.LayerView2DMixin(k));t.__decorate([a.property()],C.prototype,"_graphics",void 0),t.__decorate([a.property()],C.prototype,"_routeItems",null),C=t.__decorate([c.subclass("esri.views.2d.layers.RouteLayerView2D")],C);return C}));
