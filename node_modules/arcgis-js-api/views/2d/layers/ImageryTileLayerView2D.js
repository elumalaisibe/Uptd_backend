/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Logger","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../layers/support/rasterDatasets/multidimensionalUtils","../engine/flow/FlowView2D","./LayerView2D","./imagery/ImageryTileView2D","./imagery/VectorFieldTileView2D","./support/util","../../layers/ImageryTileLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,i,r,s,n,a,o,u,c,h,l,d,p,y,b,w,v,g,f){"use strict";let m=function(t){function a(){var e;return(e=t.apply(this,arguments)||this)._useWebGLForProcessing=!0,e._useProgressiveUpdate=!0,e.subview=null,e}e._inherits(a,t);var o=a.prototype;return o.update=function(e){this.subview?.update(e),this.notifyChange("updating")},o.isUpdating=function(){return!this.subview||this.subview.updating},o.attach=function(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([n.watch((()=>this.displayParameters),((e,t)=>{const i=e.interpolation!==t?.interpolation&&("majority"===e.interpolation||"majority"===t?.interpolation)&&w.canUseMajorityInterpolationOnDataSource(this.layer),n=e.renderer!==t?.renderer&&t?.renderer?.type!==e.renderer?.type;n&&this._updateSubview();const a=e.multidimensionalDefinition!==t?.multidimensionalDefinition,o=e.rasterFunction!==t?.rasterFunction,u=o&&!this._useWebGLForProcessing,c=a||i||n||u;this.subview.redrawOrRefetch({refetch:c,reprocess:o}).catch((e=>{s.isAbortError(e)||r.getLogger(this).error(e)})),this.notifyChange("updating")})),n.watch((()=>this.layer.blendMode??"normal"),(e=>{this.subview.container.blendMode=e}),n.syncAndInitial),n.watch((()=>this.layer.effect??null),(e=>{this.subview.container.effect=e}),n.syncAndInitial),n.watch((()=>this.layer.multidimensionalSubset??null),((e,t)=>{const{multidimensionalDefinition:i}=this.layer;null!=i&&l.hasExcludedVariableOrDimension(i,e)!==l.hasExcludedVariableOrDimension(i,t)&&(this.subview.redrawOrRefetch({refetch:!0}).catch((e=>{s.isAbortError(e)||r.getLogger(this).error(e)})),this.notifyChange("updating"))}),n.sync),n.watch((()=>this.timeExtent),(()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch((e=>{s.isAbortError(e)||r.getLogger(this).error(e)}))}),n.initial)])},o.detach=function(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null},o.moveStart=function(){this.requestUpdate()},o.viewChange=function(){this.requestUpdate()},o.moveEnd=function(){this.subview.moveEnd()},o.hitTest=async function(e,t){return[{type:"graphic",layer:this.layer,mapPoint:e,graphic:new i({attributes:{},geometry:e.clone()})}]},o.doRefresh=function(){return this.subview?this.subview.doRefresh():Promise.resolve()},o._updateSubview=function(){const e=this.layer.renderer?.type;if(!e)return;const t="vector-field"===e?"rasterVF":"flow"===e?"flow":"raster";if(this.subview){if(this.subview.type===t)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}const{layer:i}=this;let r;if(r="rasterVF"===t?new b({layer:i,layerView:this}):"flow"===t?new d({layer:i,layerView:this}):new y({layer:i,layerView:this}),"useWebGLForProcessing"in r&&(r.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in r&&(r.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in r){const{subview:e}=this;r.previousLOD=e&&"previousLOD"in e?e.previousLOD:null}this._attachSubview(r),this.subview=r,this.requestUpdate()},o._attachSubview=function(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0),e.container.blendMode=this.layer.blendMode,e.container.effect=this.layer.effect)},o._detachSubview=function(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)},e._createClass(a,[{key:"useWebGLForProcessing",get:function(){return this._useWebGLForProcessing},set:function(e){this._useWebGLForProcessing=e,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=e)}},{key:"useProgressiveUpdate",get:function(){return this._useWebGLForProcessing},set:function(e){this._useProgressiveUpdate=e,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=e)}},{key:"displayParameters",get:function(){const{layer:e}=this,t=this._get("displayParameters");return e.renderer?{bandIds:e.bandIds,renderer:e.renderer,interpolation:e.interpolation,multidimensionalDefinition:e.multidimensionalDefinition,rasterFunction:"imagery-tile"===e.type?e.rasterFunction:null}:t}}]),a}(v(f(p.LayerView2DMixin(g))));t.__decorate([a.property()],m.prototype,"subview",void 0),t.__decorate([a.property()],m.prototype,"useWebGLForProcessing",null),t.__decorate([a.property()],m.prototype,"useProgressiveUpdate",null),t.__decorate([a.property({readOnly:!0})],m.prototype,"displayParameters",null),m=t.__decorate([h.subclass("esri.views.2d.layers.ImageryTileLayerView2D")],m);return m}));
