/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../geometry","../../../../../core/Evented","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/accessorSupport/diffUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/Ellipsoid","../../../../../geometry/support/spatialReferenceUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/projectionSupport","../../../engine/webgl/DisplayId","../FeatureStore2D","../Store2D","./FeatureSetReaderJSON","../../../../../geometry/SpatialReference","../../../../../geometry/Polygon","../../../../../geometry/Extent"],(function(e,t,s,r,i,o,a,n,h,d,u,l,c,f,g,p,_,y,m,I,b,S,v,B){"use strict";const F=o.getLogger("esri.view.2d.layers.features.support.BinStore"),G=12,x=64,R=u.create(),O=5;function T(e){return 57.29577951308232*e}let D=function(e){function s(t,s,i,o){var a;return(a=e.call(this,t,i)||this).type="bin",a.events=new r,a.objectIdField="aggregateId",a.featureAdapter=m.featureAdapter,a._geohashLevel=O,a._geohashBuf=[],a._serviceInfo=o,a.geometryInfo=t.geometryInfo,a._spatialReference=s,a._projectionSupportCheck=_.checkProjectionSupport(s,S.WGS84),a._bitsets.geohash=i.getBitset(i.createBitset()),a._bitsets.inserted=i.getBitset(i.createBitset()),a}t._inherits(s,e);var o=s.prototype;return o.destroy=function(){this._tree&&this._tree.destroy()},o.updateSchema=async function(e,r){const o=this._schema;try{await t._get(t._getPrototypeOf(s.prototype),"updateSchema",this).call(this,e,r),await this._projectionSupportCheck}catch(d){}this._fields=this._schema.params.fields;const a=n.diff(o,r);r&&(null!=a||e.source||e.storage.filters)?((n.hasDiff(a,"params.fields")||n.hasDiff(a,"params")||!this._tree||e.source)&&(this._tree&&this._tree.destroy(),this._tree=new h.GeohashTree(this._statisticFields,this._serviceInfo),this._tree.onRelease=e=>e.displayId&&this._storage.releaseDisplayId(e.displayId),this._geohashLevel=this._schema.params.fixedBinLevel,this._rebuildTree(),i("esri-2d-update-debug")&&F.info("Aggregate mesh needs update due to tree changing")),i("esri-2d-update-debug")&&F.info("Aggregate mesh needs update due to tree changing"),e.targets[r.name]=!0,e.mesh=!1):o&&(e.mesh=!0)},o.clear=function(){this._rebuildTree()},o.sweepFeatures=function(e,t){this._bitsets.inserted.forEachSet((s=>{if(!e.has(s)){const e=t.lookupByDisplayIdUnsafe(s);this._remove(e)}}))},o.sweepAggregates=function(e,t,s){},o.onTileData=function(e,t,s,r,i=!0){if(!this._schema||null==t.addOrUpdate)return t;this.events.emit("changed");const o=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,r)}if(t.status.mesh||!i)return t;const a=new Array;this._getBinsForTile(a,e,o,s),t.addOrUpdate=b.FeatureSetReaderJSON.fromOptimizedFeatures(a,{fields:this.fields,geometryType:"esriGeometryPolygon",objectIdField:this.objectIdField}),t.addOrUpdate.attachStorage(s),t.end=!0,t.isRepush||(t.clear=!0);{const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(s,r,t,e.scale)}}return t},o.forEachBin=function(e){this._tree.forEach(e)},o.forEach=function(e){this._tree.forEach((t=>{if(t.depth!==this._geohashLevel)return;const s=this._toFeatureJSON(t),r=b.FeatureSetReaderJSON.fromFeatures([s],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();r.next(),e(r)}))},o.forEachInBounds=function(e,t){},o.forEachBounds=function(e,t){const{hasM:s,hasZ:r}=this.geometryInfo;for(const i of e){const e=f.getBoundsOptimizedGeometry(R,i.readGeometry(),r,s);null!=e&&t(e)}},o.onTileUpdate=function(e){},o.getAggregate=function(e){const t=y.createDisplayId(e,!0),s=this._tree.findIf((e=>e.displayId===t));return a.applySome(s,(e=>this._toFeatureJSON(e)))},o.getAggregates=function(){return this._tree.findAllIf((e=>e.depth===this._geohashLevel)).map(this._toFeatureJSON.bind(this))},o.getDisplayId=function(e){const t=this._tree.findIf((t=>t.id===e));return a.applySome(t,(e=>e.displayId))},o.getFeatureDisplayIdsForAggregate=function(e){const t=this._tree.findIf((t=>t.id===e));return null!=t?Array.from(t.displayIds):[]},o.getDisplayIdForReferenceId=function(e){const t=this._tree.findIf((t=>1===t.displayIds.size&&t.displayIds.has(e)));return a.applySome(t,(e=>e.displayId))},o._toFeatureJSON=function(e){const t=this._spatialReference;return{displayId:e.displayId,attributes:e.getAttributes(),geometry:f.convertToGeometry(e.getGeometry(t),"esriGeometryPolygon",!1,!1),centroid:null}},o._rebuildTree=function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()},o._remove=function(e){const t=e.getDisplayId(),s=e.getXHydrated(),r=e.getYHydrated(),i=this._geohashBuf[2*t],o=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,i,o,this._geohashLevel))},o._update=function(e,t){const s=e.getDisplayId(),r=this._bitsets.inserted,i=t.isVisible(s);if(i===r.has(s))return;if(!i)return void this._remove(e);const o=e.getXHydrated(),a=e.getYHydrated();if(!this._setGeohash(s,o,a))return;const n=this._geohashBuf[2*s],h=this._geohashBuf[2*s+1];this._tree.insertCursor(e,s,o,a,n,h,this._geohashLevel),r.set(s)},o._setGeohash=function(e,t,s){if(this._bitsets.geohash.has(e))return!0;const r=this._geohashBuf;if(this._spatialReference.isWebMercator){const i=T(t/l.earth.radius),o=i-360*Math.floor((i+180)/360),a=T(Math.PI/2-2*Math.atan(Math.exp(-s/l.earth.radius)));d.setGeohashBuf(r,e,a,o,G)}else{const i={x:t,y:s},o=_.project(i,this._spatialReference,S.WGS84);if(!o)return!1;d.setGeohashBuf(r,e,o.y,o.x,G)}return this._bitsets.geohash.set(e),!0},o._getBinsForTile=function(e,t,s,r){try{const i=this._getGeohashBounds(t),o=this._tree.getBins(i);for(const t of o){t.displayId||(t.displayId=r.createDisplayId(!0));let i=null;const o=t.getGeometry(this._spatialReference,s.tile);o||(i=t.getGeometryCentroid(this._spatialReference,s.tile));const a=new g.OptimizedFeature(o,t.getAttributes(),i);a.objectId=t.id,a.displayId=t.displayId,e.push(a)}}catch(i){return void F.error("Unable to get bins for tile",t.key.id)}},o._getGeohash=function(e,t,s){const r={geohashX:0,geohashY:0};return d.setGeohashXY(r,t,e,s),r},o._getGeohashBounds=function(e){const t=this._getGeohashLevel(e.key.level),s=[e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax],r=v.fromExtent(B.fromBounds(s,this._spatialReference)),i=_.project(r,this._spatialReference,S.WGS84,{densificationStep:e.resolution*x}),o=f.convertFromPolygon(new p,i,!1,!1),a=o.coords.filter(((e,t)=>!(t%2))),n=o.coords.filter(((e,t)=>t%2)),h=Math.min(...a),d=Math.min(...n),u=Math.max(...a),l=Math.max(...n),c=this._getGeohash(h,d,t),g=this._getGeohash(u,l,t);return{bounds:s,geohashBounds:{xLL:c.geohashX,yLL:c.geohashY,xTR:g.geohashX,yTR:g.geohashY},level:t}},o._getGeohashLevel=function(e){return this._schema.params.fixedBinLevel},o._getTransforms=function(e,t){const s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=c.getInfo(t);if(!r)return{tile:s,left:null,right:null};const[i,o]=r.valid;return{tile:s,left:{...s,translate:[o,e.bounds[3]]},right:{...s,translate:[i-o+e.bounds[0],e.bounds[3]]}}},t._createClass(s,[{key:"featureSpatialReference",get:function(){return this._spatialReference}},{key:"fields",get:function(){return this._fields}}]),s}(I.Store2D);e.BinStore=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
