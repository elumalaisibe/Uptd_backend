/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/support/FieldsIndex","./FeatureSetReader"],(function(t,e,r,n,s,i){"use strict";function o({coords:t,lengths:e}){let r=0;for(const n of e){for(let e=1;e<n;e++)t[2*(r+e)]+=t[2*(r+e)-2],t[2*(r+e)+1]+=t[2*(r+e)-1];r+=n}}let u=function(t){function u(e,r,n){var s;return(s=t.call(this,e,n)||this)._exceededTransferLimit=!1,s._featureIndex=-1,s._fieldsIndex=null,s._geometryType=n?.geometryType,s._features=r,s}e._inherits(u,t),u.fromFeatures=function(t,e){const{objectIdField:n,geometryType:s}=e,i=r.convertFromFeatures([],t,s,!1,!1,n);for(let r=0;r<i.length;r++)i[r].displayId=t[r].displayId;return u.fromOptimizedFeatures(i,e)},u.fromFeatureSet=function(t,e){const n=r.convertFromFeatureSet(t,e.objectIdField);return u.fromOptimizedFeatureSet(n,e)},u.fromOptimizedFeatureSet=function(t,e){const{features:r}=t,n=u.fromOptimizedFeatures(r,e);return n._exceededTransferLimit=t.exceededTransferLimit,n._transform=t.transform,n._fieldsIndex=new s(e.fields),n},u.fromOptimizedFeatures=function(t,e,r){const n=new u(i.FeatureSetReader.createInstance(),t,e);return n._fieldsIndex=new s(e.fields),n._transform=r,n};var c=u.prototype;return c.removeIds=function(t){const e=new Set(t);this._features=this._features.filter((t=>!(null!=t.objectId&&e.has(t.objectId))))},c.append=function(t){for(const e of t)this._features.push(e)},c.getSize=function(){return this._features.length},c.getCursor=function(){return this.copy()},c.getQuantizationTransform=function(){return this._transform},c.getAttributeHash=function(){let t="";for(const e in this._current.attributes)t+=this._current.attributes[e];return t},c.getIndex=function(){return this._featureIndex},c.setIndex=function(t){this._featureIndex=t},c.getObjectId=function(){return this._current?.objectId},c.getDisplayId=function(){return this._current.displayId},c.setDisplayId=function(t){this._current.displayId=t},c.getGroupId=function(){return this._current.groupId},c.setGroupId=function(t){this._current.groupId=t},c.copy=function(){const t=new u(this.instance,this._features,this.fullSchema());return this.copyInto(t),t},c.next=function(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length},c.readLegacyFeature=function(){return r.convertToFeature(this._current,this.geometryType,this.hasZ,this.hasM)},c.readOptimizedFeature=function(){return this._current},c.readLegacyPointGeometry=function(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null},c.readLegacyGeometry=function(){const t=this.readUnquantizedGeometry();return r.convertToGeometry(t,this.geometryType,this.hasZ,this.hasM)},c.readLegacyCentroid=function(){const t=this.readCentroid();return null==t?null:{x:t.coords[0]*this._sx+this._tx,y:t.coords[1]*this._sy+this._ty}},c.readGeometryArea=function(){return n.hasGeometry(this._current)?r.getQuantizedArea(this._current.geometry,2):0},c.readUnquantizedGeometry=function(){const t=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!t)return t;const e=t.clone();return o(e),e},c.readHydratedGeometry=function(){const t=this._current.geometry;if(null==t)return null;const e=t.clone();return null!=this._transform&&r.unquantizeOptimizedGeometry(e,e,this.hasZ,this.hasM,this._transform),e},c.getXHydrated=function(){if(!n.hasGeometry(this._current))return 0;const t=this._current.geometry.coords[0],e=this.getQuantizationTransform();return null==e?t:t*e.scale[0]+e.translate[0]},c.getYHydrated=function(){if(!n.hasGeometry(this._current))return 0;const t=this._current.geometry.coords[1],e=this.getQuantizationTransform();return null==e?t:e.translate[1]-t*e.scale[1]},c.getX=function(){return n.hasGeometry(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0},c.getY=function(){return n.hasGeometry(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0},c.readGeometry=function(){if(!n.hasGeometry(this._current)){if(null!=this._current.centroid){const[t,e]=this._current.centroid.coords;return this.createQuantizedExtrudedQuad(t,e)}return null}const t=this._current.geometry.clone();if(t.isPoint)return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sy+this._ty,t;let e=0;for(const r of t.lengths)t.coords[2*e]=t.coords[2*e]*this._sx+this._tx,t.coords[2*e+1]=t.coords[2*e+1]*this._sy+this._ty,e+=r;return t},c.readCentroid=function(){return n.hasGeometry(this._current)?this._computeCentroid():this._current.centroid},c._readAttribute=function(t,e){const r=this._fieldsIndex.get(t);if(!r)return;let n=this._current.attributes[r.name];return null==n?n:("esriFieldTypeTimestampOffset"===this.fields.get(t)?.type&&(n=this.parseTimestampOffset(n)),e&&this.fields.isDateField(t)?new Date(n):n)},c.copyInto=function(t){e._get(e._getPrototypeOf(u.prototype),"copyInto",this).call(this,t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._fieldsIndex=this._fieldsIndex},c._readAttributes=function(){return this._current.attributes},e._createClass(u,[{key:"fields",get:function(){return this._fieldsIndex}},{key:"_current",get:function(){return this._features[this._featureIndex]}},{key:"geometryType",get:function(){return this._geometryType}},{key:"hasFeatures",get:function(){return!!this._features.length}},{key:"hasNext",get:function(){return this._featureIndex+1<this._features.length}},{key:"exceededTransferLimit",get:function(){return this._exceededTransferLimit}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}}]),u}(i.FeatureSetReader);t.FeatureSetReaderJSON=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
