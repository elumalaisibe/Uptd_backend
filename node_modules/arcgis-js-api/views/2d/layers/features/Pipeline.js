/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/HandleOwner","../../../../core/has","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","./processors","./controllers/FeatureController2D","./support/TileStore","./support/UpdateToken","../../tiling/TileInfoView"],(function(e,t,r,s,o,i,n,l,c,a,p,h,d,u,y,f){"use strict";let _=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).controller=null,e.processor=null,e.remoteClient=null,e.tileStore=null,e.service=null,e.viewState=null,e._paused=!1,e._pendingTileUpdates=[],e}e._inherits(r,t);var s=r.prototype;return s.initialize=function(){this.handles.add(o.watch((()=>this.updating),(e=>{this.remoteClient.invoke("setUpdating",e).catch((e=>{}))})))},s.destroy=function(){this.stop(),this.controller?.destroy(),this.processor?.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null},s.stop=function(){this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach((e=>e.close())),this.service.source.length=0),this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map((e=>e.id))}),this.tileStore?.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0},s.startup=async function({service:e,config:t,tileInfo:r,tiles:s}){if(this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach((e=>e.close())),this.service.source.length=0),this.service=e,!this.tileStore||!a.equals(this.tileStore.tileScheme.spatialReference,r.spatialReference)){const e=new f(p.fromJSON(r));s.added.length=s.removed.length=0,this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map((e=>e.id))}),this.tileStore?.destroy(),this.tileStore=new u(e),this._pendingTileUpdates.length=0}for(await this._createProcessorAndController(t),await this.update({config:t}),this.controller.resume(),this.tileStore.clear(),this.tileStore.updateTiles(s),this._paused=!1;this._pendingTileUpdates.length;)this.tileStore.updateTiles(this._pendingTileUpdates.pop())},s.updateTiles=async function(e){this._paused?this._pendingTileUpdates.push(e):this.tileStore?.updateTiles(e)},s.update=async function({config:e}){const t=y.UpdateToken.empty();return await Promise.all([this.processor.update(t,e),this.controller.update(t,e)]),t.toJSON()},s.applyUpdate=async function(e){return this.controller.applyUpdate(y.UpdateToken.create(e))},s._createProcessorAndController=async function(e){await Promise.all([this._handleControllerConfig(e),this._handleProcessorConfig(e)]),this.controller.processor=this.processor},s._handleControllerConfig=async function(e){return this._createController(this.service,e)},s._handleProcessorConfig=async function(e){return this._createProcessor(this.service,e)},s._createController=async function(e,t){this.controller&&this.controller.destroy();const{tileStore:r,remoteClient:s}=this,o=new d({service:e,tileStore:r,remoteClient:s});return this.controller=o,o},s._createProcessor=async function(e,t){const r=t.schema.processors[0].type,s=(await h.loadProcessorModule(r)).default,{remoteClient:o,tileStore:i}=this,n=new s({service:e,config:t,tileStore:i,remoteClient:o});return this.processor&&this.processor.destroy(),this.processor=n,n},e._createClass(r,[{key:"updating",get:function(){return!this.controller||this.controller.updating}}]),r}(r.HandleOwner);t.__decorate([i.property()],_.prototype,"controller",void 0),t.__decorate([i.property()],_.prototype,"processor",void 0),t.__decorate([i.property()],_.prototype,"updating",null),t.__decorate([i.property()],_.prototype,"viewState",void 0),_=t.__decorate([c.subclass("esri.views.2d.layers.features.Pipeline")],_);return _}));
