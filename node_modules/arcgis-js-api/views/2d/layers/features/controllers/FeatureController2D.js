/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/HandleOwner","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/accessorSupport/decorators/subclass","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/support/FieldsIndex","../FeatureStore2D","../sources/createSource","../support/AttributeStore","../support/BinStore","../support/ClusterStore","../support/ComputedAttributeStorage","../support/FeatureSetReaderJSON","../support/UpdateToken","../../../../support/QueueProcessor"],(function(e,t,r,s,i,a,n,o,u,g,c,l,d,h,p,f,y,m,_,S,b,v,I){"use strict";const Q=5e3,w="tileRenderer.featuresView.attributeView.initialize",E="tileRenderer.featuresView.attributeView.requestUpdate",C="tileRenderer.featuresView.requestRender";function F(e){return"worker:port-closed"===e.name}function A(e){if(!n.isAbortError(e)&&!F(e))throw e}function T(e){return"feature"===e.type&&"snapshot"===e.mode}let k=function(t){function s(){var e;return(e=t.apply(this,arguments)||this)._storage=new S.ComputedAttributeStorage,e._markedIdsBufId=e._storage.createBitset(),e._lastCleanup=performance.now(),e._cleanupNeeded=!1,e._invalidated=!1,e._tileToResolver=new Map,e._didEdit=!1,e._updateVersion=1,e.tileStore=null,e.config=null,e.processor=null,e.remoteClient=null,e.service=null,e}e._inherits(s,t);var u=s.prototype;return u.initialize=function(){this._initStores(),this._initSource(),this._updateQueue=new I.QueueProcessor({concurrency:"stream"===this._source.type?1:4,process:(e,t)=>this._onTileMessage(e,{signal:t})}),this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this)),o.when((()=>!this.updating),(()=>this.onIdle()))])},u._initSource=function(){const e=this.tileStore.tileScheme,t=()=>this._updateQueue&&this._updateQueue.length<50,r=(e,t)=>(this._invalidated=!0,this._patchTile(e,t));this._source=f.createSource(this.service,this.spatialReference,e,r,t,this.featureStore),this._proxyEvents()},u._setStreamClientProperty=function(e,t){this.remoteClient.invoke("setProperty",{propertyName:e,value:t}).catch(A)},u._proxyEvents=function(){if("stream"===this._source.type){const e=this._source.events,t=this._source;this.addHandles([o.watch((()=>t.connectionStatus),(e=>this._setStreamClientProperty("pipelineConnectionStatus",e)),{initial:!0}),o.watch((()=>t.errorString),(e=>this._setStreamClientProperty("pipelineErrorString",e)),{initial:!0}),e.on("data-received",(e=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}}).catch(A))),e.on("message-received",(e=>this.remoteClient.invoke("emitEvent",{name:"message-received",event:e}).catch(A))),e.on("updateRate",(e=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...e}}).catch(A)))])}},u._initAttributeStore=function(e){this.attributeStore||(this.attributeStore=new y({type:"remote",initialize:(e,t)=>n.ignoreAbortErrors(this.remoteClient.invoke(w,e,{signal:t}).catch(A)),update:(e,t)=>n.ignoreAbortErrors(this.remoteClient.invoke(E,e,{signal:t}).catch(A)),render:e=>n.ignoreAbortErrors(this.remoteClient.invoke(C,void 0,{signal:e}).catch(A))},e))},u._initStores=function(){const e="snapshot"===this.service.type?"snapshot":"on-demand",t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new p.FeatureStore2D(t,this._storage,e)},u._initQueryEngine=function(e){const t=this;this.featureQueryEngine?.destroy(),this.featureQueryEngine=new d.QueryEngine({definitionExpression:e.schema.source.definitionExpression??void 0,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds(e){if(null==t.aggregateStore)return[];return t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((e=>t.getObjectId(e)))}},timeInfo:this.service.timeInfo})},u._initAggregateQueryEngine=function(e,t){if(this.aggregateQueryEngine?.destroy(),null==e)return;const r=t.targets.aggregate.params.fields.slice();this.aggregateQueryEngine=new d.QueryEngine({definitionExpression:void 0,fields:r,geometryType:e.geometryInfo.geometryType,objectIdField:e.objectIdField,hasM:e.geometryInfo.hasM,hasZ:e.geometryInfo.hasZ,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!1,featureStore:e,aggregateAdapter:{getFeatureObjectIds:e=>[]}})},u.destroy=function(){this._updateQueue.destroy(),this._source.destroy(),this.featureQueryEngine?.destroy(),this.aggregateQueryEngine?.destroy(),this.attributeStore?.destroy();for(const e of this.tileStore.tiles)this._source.unsubscribe(e);clearInterval(this._checkUpdating)},u.isUpdating=function(){const e=this._source.updatingHandles.updating,t=!this.attributeStore||this.attributeStore.updatingHandles.updating,r=e||t||this.updatingHandles.updating;if(i("esri-2d-log-updating")){let s=`Updating FeatureController2D: ${r}\n`;s+=`  -> updatingSource ${e}\n`;for(const e of this._source.subscriptions)s+=`     ${e.tile.id} ${e.isDone}\n`;s+=`  -> updatingAttributeStore ${t}\n`,s+=`  -> updatingHandles ${this.updatingHandles.updating} (queue: ${this._updateQueue.length})\n`,console.log(s)}return r},u.updateCustomParameters=function(e){"stream"===this._source.type&&this._source.updateCustomParameters(e)},u.enableEvent=function(e){this._source.enableEvent(e.name,e.value)},u.pause=function(){this._updateQueue.pause(),this._updateQueue.clear()},u.resume=function(){this._updateQueue.resume()},u.pauseStream=function(){"stream"===this._source.type&&this._source.pauseStream()},u.resumeStream=function(){"stream"===this._source.type&&this._source.resumeStream()},u.sendMessageToSocket=function(e){"stream"===this._source.type&&this._source.sendMessageToSocket(e)},u.sendMessageToClient=function(e){"stream"===this._source.type&&this._source.sendMessageToClient(e)},u._initAggregateStore=function(e){const t=e.schema.targets?.aggregate?.type,r=a.applySome(this.config,(e=>e.schema.targets?.aggregate?.type));if(r!==t&&(null!=this.aggregateStore&&(this.removeHandles("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),t)){switch(t){case"cluster":{const e={geometryInfo:{geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.aggregateStore=new _.ClusterStore(e,this.spatialReference,this._storage,this.service),this.addHandles(this.aggregateStore.events.on("valueRangesChanged",(e=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:e.valueRanges}}).catch(A)})),"valueRangesChanged");break}case"bin":{const e={geometryInfo:{geometryType:"esriGeometryPolygon",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.aggregateStore=new m.BinStore(e,this.spatialReference,this._storage,this.service);break}}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}},u.update=async function(e,t){this._updateVersion++,i("esri-2d-update-debug")&&console.debug(`FeatureController2D::update: Token version ${this._updateVersion}`),this._initQueryEngine(t),this._initAttributeStore(t),this.pause(),await Promise.all([this._source.update(e,t.schema.source),this.featureStore.updateSchema(e,t.schema.targets.feature),this.attributeStore.update(e,t),this.attributeStore.updateFilters(e,t,this)]),this._initAggregateStore(t),null!=this.aggregateStore&&await this.aggregateStore.updateSchema(e,t.schema.targets.aggregate),this._initAggregateQueryEngine(this.aggregateStore,t.schema),i("esri-2d-update-debug")&&e.describe(),this._set("config",t)},u.applyUpdate=async function(e){e.version=this._updateVersion,i("esri-2d-update-debug")&&console.debug(`FeatureController2D::applyUpdate: Token version ${e.version}`),e.mesh&&this.clearTiles(),this._updateQueue.resume(),await this._source.applyUpdate(e),i("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Waiting for source update to finish"),this.notifyChange("updating"),await o.whenOnce((()=>!this.updating)),i("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Source update finsihed"),null!=this.aggregateStore&&(await n.after(10),i("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Waiting for aggregate idle call"),await o.whenOnce((()=>!this.updating)),i("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Aggregate idle called")),i("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Update finished")},u.onEdits=async function({edits:e}){i("esri-2d-update-debug")&&console.debug("Applying Edit:",e),this._didEdit=!0;try{const t=e.removed.map((e=>e.objectId&&-1!==e.objectId?e.objectId:this._lookupObjectIdByGlobalId(e.globalId))),r=e.addOrModified.map((({objectId:e})=>e));this.featureStore.invalidate(),await this._source.edit(r,t),this.clearTiles(),this.notifyChange("updating"),null!=this.aggregateStore&&this.aggregateStore.clear(),await this._source.resend(),await o.whenOnce((()=>!this.updating))}catch(t){}},u.refresh=async function(e){if(!e.dataChanged){const e=v.UpdateToken.empty();return e.storage.filters=!0,this.applyUpdate(e)}this.featureStore.invalidate(),this.clearTiles(),this._source.refresh(this._updateVersion,e),this._cleanupNeeded=!0,this.notifyChange("updating"),await o.whenOnce((()=>!this.updating))},u.clearTiles=function(){for(const e of this.tileStore.tiles)this.processor.onTileClear(e,!1)},u.onTileUpdate=function(e){null!=this.aggregateStore&&this.aggregateStore.onTileUpdate(e);for(const t of e.added)this._source.subscribe(t,this._updateVersion),this._level=t.level;for(const t of e.removed)this._source.unsubscribe(t),this._cleanupNeeded=!0,this._tileToResolver.has(t.id)&&(this._tileToResolver.get(t.id).resolve(),this._tileToResolver.delete(t.id));this.notifyChange("updating")},u.onIdle=async function(){this._invalidated&&(this._invalidated=!1,null==this.aggregateStore&&"heatmap"!==this.processor.type||await this._repushCurrentLevelTiles()),this._markAndSweep()},u.querySummaryStatistics=async function({query:e,params:t}){return this.featureQueryEngine.executeQueryForSummaryStatistics(e,t)},u.queryAggregateSummaryStatistics=async function({query:e,params:t}){return this.aggregateQueryEngine.executeQueryForSummaryStatistics(this._normalizeAggregateQuery(e),t)},u.queryUniqueValues=async function({query:e,params:t}){return this.featureQueryEngine.executeQueryForUniqueValues(e,t)},u.queryAggregateUniqueValues=async function({query:e,params:t}){return this.aggregateQueryEngine.executeQueryForUniqueValues(this._normalizeAggregateQuery(e),t)},u.queryClassBreaks=async function({query:e,params:t}){return this.featureQueryEngine.executeQueryForClassBreaks(e,t)},u.queryAggregateClassBreaks=async function({query:e,params:t}){return this.aggregateQueryEngine.executeQueryForClassBreaks(this._normalizeAggregateQuery(e),t)},u.queryHistogram=async function({query:e,params:t}){return this.featureQueryEngine.executeQueryForHistogram(e,t)},u.queryAggregateHistogram=async function({query:e,params:t}){return this.aggregateQueryEngine.executeQueryForHistogram(this._normalizeAggregateQuery(e),t)},u.queryExtent=function(e){return this.featureQueryEngine.executeQueryForExtent(e)},u.queryAggregates=function(e){return this.aggregateQueryEngine.executeQuery(this._normalizeAggregateQuery(e))},u.queryAggregateCount=function(e){return this.aggregateQueryEngine.executeQueryForCount(this._normalizeAggregateQuery(e))},u.queryAggregateIds=function(e){return this.aggregateQueryEngine.executeQueryForIds(this._normalizeAggregateQuery(e))},u.queryFeatures=function(e){return this.featureQueryEngine.executeQuery(e)},u.queryVisibleFeatures=async function(e){const t=await this.featureQueryEngine.executeQuery(e),r=t.objectIdFieldName;return t.features=t.features.filter((e=>{const t=e.attributes[r],s=this.getDisplayId(t);return a.applySome(s,(e=>this.attributeStore.isVisible(e)))})),t},u.queryFeatureCount=function(e){return this.featureQueryEngine.executeQueryForCount(e)},u.queryLatestObservations=function(e){return this.featureQueryEngine.executeQueryForLatestObservations(e)},u.queryObjectIds=function(e){return this.featureQueryEngine.executeQueryForIds(e)},u.queryStatistics=async function(){return this.featureStore.storeStatistics},u.getObjectId=function(e){return this.featureStore.lookupObjectId(e,this._storage)},u.getDisplayId=function(e){if(null!=this.aggregateStore){const t=this.aggregateStore.getDisplayId(e);if(null==t){const t=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(t)}return t}return this.featureStore.lookupDisplayId(e)},u.getFeatures=function(e){const t=[],r=[];for(const s of e){const e=null!=this.aggregateStore?this.getAggregate(s):null;if(null!=e)if(null!=e.attributes.referenceId){const r=this.getFeature(e.attributes.referenceId);null!=r&&t.push(r)}else r.push(e);else{const e=this.getFeature(s);null!=e&&t.push(e)}}return{features:t,aggregates:r}},u.getFeature=function(e){const t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if(null==t)return null;const r=t.readHydratedGeometry(),s=l.convertToGeometry(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:s}},u.getAggregate=function(e){return null==this.aggregateStore?null:this.aggregateStore.getAggregate(e)},u.getAggregates=function(){return null==this.aggregateStore?[]:this.aggregateStore.getAggregates()},u.setHighlight=async function(e){const t=e.map((e=>this.getDisplayId(e))).filter(r.isSome);return this.attributeStore.setHighlight(e,t)},u._normalizeAggregateQuery=function(e){const t=e.objectIds??[];for(const r of e.aggregateIds??[])t.push(r);return e.objectIds=t,e.aggregateIds=[],e},u._lookupObjectIdByGlobalId=function(e){const t=this.service.globalIdField;if(null==t)throw new Error("Expected globalIdField to be defined");let r=null;if(this.featureStore.forEach((s=>{e===s.readAttribute(t)&&(r=s.getObjectId())})),null==r)throw new Error(`Expected to find a feature with globalId ${e}`);return r},u._repushCurrentLevelTiles=async function(){const e=this.tileStore.tiles.filter((e=>e.level===this._level));e.map((async e=>this._patchTile({type:"append",id:e.key.id,clear:!0,addOrUpdate:null,end:!1})));const t=e.map((async e=>this._patchTile({type:"append",id:e.key.id,addOrUpdate:b.FeatureSetReaderJSON.fromOptimizedFeatures([],this.service),remove:[],end:!0,isRepush:!0,status:v.UpdateToken.empty()})));await Promise.all(t)},u._maybeForceCleanup=function(){performance.now()-this._lastCleanup>Q&&this._markAndSweep()},u._patchTile=function(e,t){const r=this._updateQueue.push(e,t).catch((e=>{}));return this.updatingHandles.addPromise(r)},u._onTileMessage=async function(e,t){if(n.throwIfAborted(t),i("esri-2d-update-debug")){const t=a.applySome(e.addOrUpdate,(e=>e.hasFeatures));console.debug(e.id,`FeatureController:onTileMessage: [clear:${e.clear}, end:${e.end}, features: ${t}]`)}const r=this.tileStore.get(e.id);if(!r)return;if(e.clear)return this.processor.onTileClear(r,e.end);const s=e.status;this._cleanupNeeded=!0;const o=[];for(const i of e.remove??[]){const e=this.featureStore.lookupDisplayId(i);e&&o.push(e)}e.remove=o;try{if(null==e.addOrUpdate)return void this.processor.onTileMessage(r,{...e,addOrUpdate:null},null!=this.aggregateStore,t).catch(n.throwIfNotAbortError);if(e.addOrUpdate.setArcadeSpatialReference(this.spatialReference),this.featureStore.hasInstance(e.addOrUpdate.instance)&&s.targets.feature||(s.targets.feature=!0,this.featureStore.onTileData(r,e)),!s.storage.data||!s.storage.filters){s.storage.data=!0,s.storage.filters=!0,this.attributeStore.onTileData(r,e);"stream"===this._source.type||this._didEdit?(await this.attributeStore.sendUpdates(),n.throwIfAborted(t)):this.attributeStore.sendUpdates()}if(null!=this.aggregateStore&&!s.targets.aggregate){s.targets.aggregate=!0;const t=T(this._source)&&this._source.loading,i=!T(this._source)||t||e.end;if(this.aggregateStore.onTileData(r,e,this._storage,this.attributeStore,i),!i)return;s.mesh||(this.attributeStore.onTileData(r,e),await this.attributeStore.sendUpdates())}if(!s.mesh){s.mesh=!0;const i=null!=this.aggregateStore&&"cluster"===this.aggregateStore.type;await this.processor.onTileMessage(r,e,i,t),n.throwIfAborted(t)}this._maybeForceCleanup()}catch(u){n.throwIfNotAbortError(u)}},u._mark=function(e,t,r){const s=(4294901760&this._storage.getInstanceId(e))>>>16;e&&(t.add(s),r.set(e))},u._markAndSweep=function(){this._lastCleanup=performance.now();if(!(!("feature"===this._source.type&&"snapshot"===this._source.mode)&&("stream"===this._source.type||this._cleanupNeeded)))return;this._cleanupNeeded=!1;const e=this._storage.getBitset(this._markedIdsBufId),t=new Set;e.clear();for(const r of this.tileStore.tiles)for(const s of this._source.readers(r.id)){const r=s.getCursor();for(;r.next();){let s=r.getDisplayId();if(!s){const e=r.getObjectId();s=this.featureStore.lookupDisplayId(e)}this._mark(s,t,e)}}"symbol"===this.processor.type&&this.processor.forEachBufferId((r=>{this._mark(r,t,e)})),this._updateQueue.forEach((r=>{for(const s of r.remove??[]){const r=this.featureStore.lookupDisplayId(s);this._mark(r,t,e)}})),null!=this.aggregateStore&&(this.aggregateStore.sweepFeatures(e,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(e,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(t)},e._createClass(s,[{key:"fieldsIndex",get:function(){return new h(this.service.fields)}},{key:"spatialReference",get:function(){return this.tileStore.tileScheme.spatialReference}},{key:"updating",get:function(){return this.isUpdating()}}]),s}(s.HandleOwner);t.__decorate([u.property({constructOnly:!0})],k.prototype,"tileStore",void 0),t.__decorate([u.property()],k.prototype,"config",void 0),t.__decorate([u.property({readOnly:!0})],k.prototype,"fieldsIndex",null),t.__decorate([u.property()],k.prototype,"processor",void 0),t.__decorate([u.property({constructOnly:!0})],k.prototype,"remoteClient",void 0),t.__decorate([u.property({constructOnly:!0})],k.prototype,"service",void 0),t.__decorate([u.property()],k.prototype,"spatialReference",null),t.__decorate([u.property()],k.prototype,"updating",null),k=t.__decorate([c.subclass("esri.views.2d.layers.features.controllers.FeatureController2D")],k);return k}));
