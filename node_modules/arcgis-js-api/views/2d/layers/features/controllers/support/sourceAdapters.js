/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/workers/Connection","../../../../../../geometry/support/quantizationUtils","../../../../../../layers/graphics/featureConversionUtils","../../../../../../layers/ogc/ogcFeatureUtils","../../../../../../rest/query/operations/query","../../support/FeatureSetReaderJSON","../../support/FeatureSetReaderPBF"],(function(e,t,r,i,n,a,u,s,o,c){"use strict";let p=function(){function e(e){this.service=e}return e.prototype.destroy=function(){},t._createClass(e)}();function l(e){return Array.isArray(e.source)}function f(e){return"ogc-source"===e?.type}function y(e){const{capabilities:t}=e;return f(e.source)?new d(e):l(e)?new m(e):t.query.supportsFormatPBF&&r("featurelayer-pbf")?new F(e):new S(e)}async function h(e){const t=new i;return await t.open(e,{}),t}let m=function(e){function r(t){var r;return(r=e.call(this,t)||this)._portsOpen=h(t.source).then((e=>r.client=e)),r}t._inherits(r,e);var i=r.prototype;return i.destroy=function(){this.client.close(),this.client=null},i.executeQuery=async function(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return o.FeatureSetReaderJSON.fromFeatureSet(r,this.service)},t._createClass(r)}(p),F=function(e){function r(){return e.apply(this,arguments)||this}return t._inherits(r,e),r.prototype.executeQuery=async function(e,t){const{data:r}=await s.executeQueryPBFBuffer(this.service.source,e,t),i=!e.quantizationParameters;return c.FeatureSetReaderPBF.fromBuffer(r,this.service,i)},t._createClass(r)}(p),S=function(e){function r(){return e.apply(this,arguments)||this}return t._inherits(r,e),r.prototype.executeQuery=async function(e,t){const{source:r,capabilities:i,spatialReference:u,objectIdField:c,geometryType:p}=this.service;if(null!=e.quantizationParameters&&!i.query.supportsQuantization){const i=e.clone(),p=n.toQuantizationTransform(i.quantizationParameters);i.quantizationParameters=null;const{data:l}=await s.executeQuery(r,i,u,t),f=a.convertFromFeatureSet(l,c);return a.quantizeOptimizedFeatureSet(p,f),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(f,this.service)}const{data:l}=await s.executeQuery(r,e,this.service.spatialReference,t);return"esriGeometryPoint"===p&&(l.features=l.features?.filter((e=>{if(null!=e.geometry){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),o.FeatureSetReaderJSON.fromFeatureSet(l,this.service)},t._createClass(r)}(p),d=function(e){function r(){return e.apply(this,arguments)||this}return t._inherits(r,e),r.prototype.executeQuery=async function(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){const r=e.clone(),i=n.toQuantizationTransform(r.quantizationParameters);r.quantizationParameters=null;const s=await u.queryOptimizedFeatureSet(this.service.source,e,t);return a.quantizeOptimizedFeatureSet(i,s),o.FeatureSetReaderJSON.fromOptimizedFeatureSet(s,this.service)}const i=await u.queryOptimizedFeatureSet(this.service.source,e,t);return o.FeatureSetReaderJSON.fromOptimizedFeatureSet(i,this.service)},t._createClass(r)}(p);e.SourceAdapter=p,e.createSourceAdapter=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
