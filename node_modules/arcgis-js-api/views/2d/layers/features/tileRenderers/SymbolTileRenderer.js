/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/Logger","../../../../../core/accessorSupport/ensureType","../../../../../core/arrayUtils","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../geometry/support/aaBoundingRect","../../../engine/webgl/FeatureTile","../support/rendererUtils","./BaseTileRenderer","./support/visualVariablesUtils","./support/WGLFeatureView"],(function(e,t,i,r,s,a,n,l,o,u,c,h,f,p,d,w,V){"use strict";e.SymbolTileRenderer=function(e){function i(){var t;return(t=e.apply(this,arguments)||this).type="symbol",t}t._inherits(i,e);var n=i.prototype;return n.install=function(e){const t=()=>this.notifyChange("updating"),i=new V.WGLFeatureView(this.tileInfoView,this.layerView,this.layer,t);this.featuresView=i,e.addChild(i)},n.uninstall=function(e){e.removeChild(this.featuresView),this.featuresView=s.destroyMaybe(this.featuresView)},n.fetchResource=function(e,t){const{url:i}=e,r=this.featuresView.stage;try{return r.resourceManager.fetchResource(i,{signal:t.signal})}catch(s){return a.isAbortError(s)?Promise.resolve({width:0,height:0}):Promise.reject(s)}},n.isUpdating=function(){const e=t._get(t._getPrototypeOf(i.prototype),"isUpdating",this).call(this),s=!this.featuresView||this.featuresView.isUpdating(),a=this.featuresView?.hasEmptyAttributeView(),n=e||s||e&&a;return r("esri-2d-log-updating")&&console.log(`Updating SymbolTileRenderer ${n}\n  -> updatingTiles ${e}\n  -> hasFeaturesView ${!!this.featuresView}\n  -> updatingFeaturesView ${s}`),n},n.hitTest=function(e){return this.featuresView.hitTest(e)},n.supportsRenderer=function(e){return null!=e&&["simple","class-breaks","unique-value","dot-density","dictionary","heatmap","pie-chart"].includes(e.type)},n.onConfigUpdate=function(e){let t=null;if(e&&"visualVariables"in e){const i=(p.simplifyVVRenderer(e).visualVariables||[]).map((e=>{const t=e.clone();return"normalizationField"in e&&(t.normalizationField=null),e.valueExpression&&"$view.scale"!==e.valueExpression&&(t.valueExpression=null,t.field="nop"),t}));t=w.convertVisualVariables(i)}this.featuresView.setRendererInfo(e,t,this.layerView.featureEffect)},n.onTileData=function(e){const t=this.tiles.get(e.tileKey);t&&e.data&&this.featuresView.onTileData(t,e.data),this.layerView.view.labelManager.requestUpdate()},n.onTileError=function(e){const t=this.tiles.get(e.tileKey);t&&this.featuresView.onTileError(t)},n.forceAttributeTextureUpload=function(){this.featuresView.attributeView.forceTextureUpload()},n.lockGPUUploads=function(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach((e=>e.lock()))},n.unlockGPUUploads=function(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach((e=>e.unlock()))},n.getMaterialItems=async function(e){return this.featuresView.getMaterialItems(e)},n.invalidateLabels=function(){this.featuresView.hasLabels&&this.layerView.view.labelManager.requestUpdate()},n.createTile=function(e){const t=this.tileInfoView.getTileBounds(h.create(),e),i=()=>this.layerView.view.labelManager.requestUpdate(),r=this.tileInfoView.getTileResolution(e.level),s=this.featuresView.attributeView;return new f.FeatureTile(e,r,t[0],t[3],s,i)},n.disposeTile=function(e){this.featuresView.removeChild(e),e.destroy(),this.layerView.view.labelManager.requestUpdate()},t._createClass(i)}(d),e.SymbolTileRenderer=i.__decorate([c.subclass("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],e.SymbolTileRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
