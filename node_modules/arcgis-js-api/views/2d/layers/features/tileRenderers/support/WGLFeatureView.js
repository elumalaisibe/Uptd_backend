/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/promiseUtils","../../../../engine/brushes","../../../../engine/FeatureContainer","../../../../engine/webgl/enums"],(function(e,t,s,r,i,a,n){"use strict";const l=s("featurelayer-order-by-server-enabled");let h=function(e){function a(t,s,r,i){var a;return(a=e.call(this,t)||this)._hitTestsRequests=[],a._layer=r,a._layerView=s,a._onUpdate=i,a}t._inherits(a,e);var h=a.prototype;return h.renderChildren=function(e){if(this.attributeView.update(),this.hasAnimation){e.painter.effects.integrate.draw(e,e.attributeView)}t._get(t._getPrototypeOf(a.prototype),"renderChildren",this).call(this,e)},h.hasEmptyAttributeView=function(){return this.attributeView.isEmpty()},h.isUpdating=function(){return this.attributeView.isUpdating()},h.hitTest=function(e){let t=this._hitTestsRequests.find((({x:t,y:s})=>t===e.x&&s===e.y));const s=r.createResolver();return t?t.resolvers.push(s):(t={x:e.x,y:e.y,resolvers:[s]},this._hitTestsRequests.push(t)),this.requestRender(),s.promise},h.onTileData=function(e,t){const s=l&&"orderBy"in this._layer&&this._layer.orderBy,r=s&&s?.length&&!s[0].valueExpression&&s[0].field,i=!!s&&this._layerView.orderByFields===r;e.patch(t,i),this.contains(e)||this.addChild(e),this.requestRender()},h.onTileError=function(e){this.contains(e)||this.addChild(e)},h.updateTransitionProperties=function(e,s){t._get(t._getPrototypeOf(a.prototype),"updateTransitionProperties",this).call(this,e,s),this._layerView.featureEffectView.transitionStep(e,s),this._layerView.featureEffectView.transitioning&&this.requestRender()},h.doRender=function(e){const{minScale:s,maxScale:r}=this._layer.effectiveScaleRange,i=e.state.scale;i<=(s||1/0)&&i>=r&&t._get(t._getPrototypeOf(a.prototype),"doRender",this).call(this,e)},h.afterRender=function(e){t._get(t._getPrototypeOf(a.prototype),"afterRender",this).call(this,e),this._hitTestsRequests.length&&this.requestRender()},h.onAttributeStoreUpdate=function(){this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._onUpdate()},h.setStencilReference=function(e){const{rendererSchema:s}=e.rendererInfo;if("dot-density"===s?.type&&s?.dotSize>1||"heatmap"===s?.type){const e=1;for(const t of this.children)t.stencilRef=t.key.level+e}else t._get(t._getPrototypeOf(a.prototype),"setStencilReference",this).call(this,e)},h.prepareRenderPasses=function(e){const r=t._get(t._getPrototypeOf(a.prototype),"prepareRenderPasses",this).call(this,e),l=e.registerRenderPass({name:"label",brushes:[i.brushes.label],target:()=>this.hasLabels?this.children:null,drawPhase:n.WGLDrawPhase.LABEL|n.WGLDrawPhase.LABEL_ALPHA});if(s("featurelayer-force-marker-text-draw-order")){const t=e.registerRenderPass({name:"geometry",brushes:[i.brushes.fill,i.brushes.dotDensity,i.brushes.line,i.brushes.heatmap,i.brushes.pieChart],target:()=>this.children,forceDrawByDisplayOrder:!0,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(t)}else{const t=e.registerRenderPass({name:"geometry",brushes:[i.brushes.fill,i.brushes.dotDensity,i.brushes.line,i.brushes.marker,i.brushes.heatmap,i.brushes.pieChart,i.brushes.text],target:()=>this.children,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(t)}const h=e.registerRenderPass({name:"highlight",brushes:[i.brushes.fill,i.brushes.dotDensity,i.brushes.line,i.brushes.marker,i.brushes.pieChart,i.brushes.text],target:()=>this.children,drawPhase:n.WGLDrawPhase.HIGHLIGHT,enableDefaultDraw:()=>!1,effects:[{apply:e.effects.highlight,enable:()=>!!this._layerView.hasHighlight()}]});return r.push(h),r.push(l),r},t._createClass(a,[{key:"hasAnimation",get:function(){return this.hasLabels}},{key:"hasLabels",get:function(){if("sublayers"in this._layer)return this._layer.sublayers.some((e=>!!e.labelingInfo?.length&&e.labelsVisible));const e=this._layer.featureReduction,t=e&&"labelingInfo"in e&&e.labelsVisible&&e.labelingInfo&&e.labelingInfo.length;return this._layer.labelingInfo&&this._layer.labelingInfo.length&&this._layer.labelsVisible||!!t}}]),a}(a.FeatureContainer);e.WGLFeatureView=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
