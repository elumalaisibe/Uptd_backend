/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/has","../../../../../core/promiseUtils","./BaseFeatureSource"],(function(e,t,r,i,a){"use strict";const o=r("esri-mobile"),s={maxDrillLevel:o?1:4,maxRecordCountFactor:o?1:3};let n=function(e){function r(t){return e.call(this,t)||this}return t._inherits(r,e),r.prototype._fetchDataTile=async function(e){const t=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,r=this._subscriptions.get(e.key.id),a=r.signal,o=e.getQuantizationParameters();let n=0;const c=async(u,d)=>{const l=this._queryInfo,p=this.createTileQuery(u,{maxRecordCountFactor:t?s.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:o});n++;try{const t=await this.enqueueQuery({tile:e,query:p,signal:a,depth:d});if(n--,i.throwIfAborted(a),!t)return;if(l!==this._queryInfo)return void c(u,d);if(t.exceededTransferLimit&&d<s.maxDrillLevel){for(const e of u.createChildTiles())c(e,d+1);return}const o={id:e.id,addOrUpdate:t,end:0===n,type:"append"};r.add({query:p,message:o}),this._onMessage(o)}catch(f){if(!i.isAbortError(f)){const t={id:e.id,addOrUpdate:null,end:!0,type:"append"};r.add({query:p,message:t}),this._onMessage(t)}}};c(e,0)},t._createClass(r)}(a.BaseFeatureSource);e.DrillDownFeatureSource=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
