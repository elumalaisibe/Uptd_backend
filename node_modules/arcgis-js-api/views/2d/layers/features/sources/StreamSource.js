/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/handleUtils","../../../../../core/has","../../../../../chunks/rbush","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/StreamFeatureManager","../../../../../layers/graphics/sources/connections/createConnection","./DataTileSource","./StreamConnectionState","../support/FeatureSetReaderJSON","../support/UpdateToken"],(function(e,t,n,s,i,o,r,a,c,d,u,l,h){"use strict";const p=2500;function _(e,t){const n=e.weakClone();if(null!=e.geometry){const s=o.quantizeX(t,e.geometry.coords[0]),i=o.quantizeY(t,e.geometry.coords[1]);n.geometry=new r([],[s,i])}return n}function m(e){return"esriGeometryPoint"===e?_:(t,n)=>{const s=t.weakClone(),i=new r,a=!1,c=!1,d=o.quantizeOptimizedGeometry(i,t.geometry,a,c,e,n,!1,!1);return s.geometry=d,s}}function f(e){return"esriGeometryPoint"===e?e=>null!=e.geometry?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:e=>{let t=1/0,n=1/0,s=-1/0,i=-1/0;return null!=e.geometry&&e.geometry.forEachVertex(((e,o)=>{t=Math.min(t,e),n=Math.min(n,o),s=Math.max(s,e),i=Math.max(i,o)})),{minX:t,minY:n,maxX:s,maxY:i}}}function y(e,t){const n=i.rbush(9,f(t));return n.load(e),n}function g(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}let v=function(){function e(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map,this._index=null}var n=e.prototype;return n.add=function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null},n.get=function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null},n.forEach=function(e){this._objectIdToFeature.forEach(e)},n.search=function(e){return this._index||(this._index=y(this._features,this._geometryType)),g(this._index,e)},n.clear=function(){this._index=null,this._objectIdToFeature.clear()},n.removeById=function(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null},n.update=function(e,t){this.onUpdate(e,t)},t._createClass(e,[{key:"_features",get:function(){const e=[];return this._objectIdToFeature.forEach((t=>e.push(t))),e}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),b=function(e){function s(s){var i;(i=e.call(this,s)||this).type="stream",i._updateIntervalId=0,i._level=0,i._isPaused=!1,i._updateInfo={websocket:0,client:0},i._inUpdate=!1;const{outSR:o}=s,{geometryType:r,objectIdField:d,timeInfo:l,purgeOptions:h,source:_,spatialReference:f,serviceFilter:y,maxReconnectionAttempts:g,maxReconnectionInterval:b,updateInterval:I,customParameters:T,enabledEventTypes:S}=s.serviceInfo,F=new v(i._onUpdate.bind(t._assertThisInitialized(i)),r),k=new a.StreamFeatureManager(F,d,l,h),U=c.createConnection(_,f,o,r,y,g,b,T??{});return i._connectionState=new u.StreamConnectionState({connection:U}),i._store=F,i._manager=k,i._connection=U,i._quantize=m(r),i._enabledEventTypes=new Set(S),i._handlesGroup=n.handlesGroup([i._connection.on("data-received",(e=>i._onFeature(e))),i._connection.on("message-received",(e=>i._onWebSocketMessage(e)))]),i._initUpdateInterval=()=>{let e=performance.now();i._updateIntervalId=setInterval((()=>{const t=performance.now(),n=t-e;if(n>p){e=t;const s=Math.round(i._updateInfo.client/(n/1e3)),o=Math.round(i._updateInfo.websocket/(n/1e3));i._updateInfo.client=0,i._updateInfo.websocket=0,i.events.emit("updateRate",{client:s,websocket:o})}s.canAcceptRequest()&&!i._inUpdate&&i._manager.checkForUpdates()}),I)},i._isPaused=s.serviceInfo.isPaused,i._isPaused||i._initUpdateInterval(),i}t._inherits(s,e);var i=s.prototype;return i.destroy=function(){t._get(t._getPrototypeOf(s.prototype),"destroy",this).call(this),this._clearUpdateInterval(),this._connection.destroy(),this._handlesGroup?.remove()},i._fetchDataTile=function(){},i.updateCustomParameters=function(e){this._connection.updateCustomParameters(e)},i.pauseStream=function(){this._isPaused||(this._isPaused=!0,this._clearUpdateInterval())},i.resumeStream=function(){this._isPaused&&(this._isPaused=!1,this._initUpdateInterval())},i.sendMessageToSocket=function(e){this._connection.sendMessageToSocket(e)},i.sendMessageToClient=function(e){this._isPaused&&"type"in e&&"clear"===e.type?(this._store.clear(),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!0})}))):this._connection.sendMessageToClient(e)},i.enableEvent=function(e,t){t?this._enabledEventTypes.add(e):this._enabledEventTypes.delete(e)},i.subscribe=function(e,n){t._get(t._getPrototypeOf(s.prototype),"subscribe",this).call(this,e,n);const i=this._subscriptions.get(e.id);i.resolve(),this._level=e.level;const o=this._getTileFeatures(e);this._onMessage({type:"append",id:e.key.id,addOrUpdate:o,end:!0}),i.didSend=!0},i.unsubscribe=function(e){t._get(t._getPrototypeOf(s.prototype),"unsubscribe",this).call(this,e)},i.readers=function*(e){const t=this._subscriptions.get(e),{tile:n}=t;yield this._getTileFeatures(n)},i.createTileQuery=function(e){throw new Error("Service does not support tile  queries")},i.resend=async function(){this._subscriptions.forEach((e=>{const{tile:t}=e,n={type:"append",id:t.id,addOrUpdate:this._getTileFeatures(t),end:!0};this._onMessage(n)}))},i._getTileFeatures=function(e){const t=this._store.search(e).map((t=>this._quantize(t,e.transform)));return l.FeatureSetReaderJSON.fromOptimizedFeatures(t,this._serviceInfo,e.transform)},i._onWebSocketMessage=function(e){if(this._enabledEventTypes.has("message-received")&&this.events.emit("message-received",e),"type"in e)switch(e.type){case"delete":if(e.objectIds)for(const t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(const t of e.trackIds)this._manager.removeByTrackId(t);break;case"clear":this._store.forEach((e=>this._manager.removeById(e.objectId)))}},i._onFeature=function(e){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",e);const t=o.convertFromFeature(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(t){}},i._clearUpdateInterval=function(){clearInterval(this._updateIntervalId),this._updateIntervalId=0},i._onUpdate=async function(e,t){this._inUpdate=!0;try{null!=e&&(this._updateInfo.client+=e.length),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!1})}));const t=[];this._subscriptions.forEach(((e,n)=>{if(!e.didSend||e.tile.level!==this._level)return;const s=e.tile,i={type:"append",id:n,addOrUpdate:this._getTileFeatures(s),remove:[],end:!1,status:h.UpdateToken.empty()};e.requests.stream.enqueue(i),t.push(this._onMessage(i))})),await Promise.all(t),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:t,addOrUpdate:null,end:!0})}))}catch{}this._inUpdate=!1},t._createClass(s,[{key:"connectionStatus",get:function(){return this._connectionState.connectionStatus}},{key:"errorString",get:function(){return this._connectionState.errorString}}]),s}(d.DataTileSource);e.StreamSource=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
