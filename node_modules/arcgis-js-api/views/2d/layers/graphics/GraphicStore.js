/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/screenUtils","../../../../chunks/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../symbols/cim/CIMSymbolDrawHelper","../../../../symbols/cim/CIMSymbolHelper","./GraphicStoreItem","./graphicsUtils"],(function(e,t,i,r,s,o,n,u,l,a,c){"use strict";const h={minX:0,minY:0,maxX:0,maxY:0},d=r.create(),p=1e-5;function m(e,t,i,r,s){return h.minX=t,h.minY=i,h.maxX=r,h.maxY=s,e.search(h)}function f(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}let g=function(){function h(e,t,r,s,o,n,u){this._graphics=s,this._onAdd=o,this._onRemove=n,this._hashToCIM=u,this._index=i.rbush(9,f),this._itemByGraphic=new Map,this._inflatedSizeHelper=new l.CIMSymbolInflatedSizeHelper,this._tileInfoView=e,this._uidFieldName=r;const a=e.getClosestInfoForScale(t);a&&(this._resolution=this._tileInfoView.getTileResolution(a.level))}var g=h.prototype;return g.setResourceManager=function(e){this._cimResourceManager=e,this._hittestDrawHelper=new u.HittestDrawHelper(e)},g.hitTest=function(e,t,i,s,n){e=o.normalizeMapX(e,this._tileInfoView.spatialReference);const u=.5*s*window.devicePixelRatio*i;d[0]=e-u,d[1]=t-u,d[2]=e+u,d[3]=t+u;const l=.5*s*(i+c.PIXEL_BUFFER),a=m(this._index,e-l,t-l,e+l,t+l);if(!a||0===a.length)return[];const h=[],p=r.create(),f=r.create();for(const o of a){const{geometry:e,symbolResource:t}=o;this._getSymbolBounds(p,t,e,f,n),f[3]=f[2]=f[1]=f[0]=0,r.intersects(p,d)&&o.graphic?.visible&&h.push(o)}if(0===h.length)return[];const g=this._hittestDrawHelper,b=[];for(const r of h){const{geometry:e,symbolResource:t}=r,{hash:i,textInfo:o}=t,u=this._hashToCIM.get(i);u&&(g.hitTest(d,u.symbol,e,o,n,s)&&b.push(r))}return b.sort(_),b.map((e=>e.graphic))},g.getGraphicsData=function(e,t,i){const r=this._searchForItems(t);if(0===r.length||0===i.length)return[];r.sort(((e,t)=>e.zorder-t.zorder)),r[0].insertAfter=-1;for(let a=1;a<r.length;a++)r[a].insertAfter=r[a-1].graphic.uid;r.sort(((e,t)=>e.graphic.uid-t.graphic.uid)),i.sort(((e,t)=>e.uid-t.uid));let s,o=0,n=0;const u=t.resolution,l=[],c={originPosition:"upperLeft",scale:[u,u],translate:[t.bounds[0],t.bounds[3]]};for(const h of i){for(n=-2;o<r.length;)if(s=r[o],o++,h.uid===s.graphic.uid){n=s.insertAfter;break}if(!s?.geometry||-2===n)continue;const i=s.getGeometryQuantized(c,t.bounds,this._tileInfoView.spatialReference,u),d={...s.graphic.attributes};d[this._uidFieldName]=h.uid,null==s.groupId&&(s.groupId=e.createTemplateGroup(s.symbol,null)),l.push({centroid:a.getCentroidQuantized(s,c),geometry:i,attributes:d,symbol:s.symbol,groupId:s.groupId,insertAfter:n,zorder:s.zorder})}return l.sort(((e,t)=>e.zorder-t.zorder)),l},g.queryTileData=function(e,t){if(0===this._graphics.length)return[];const{bounds:i,resolution:r}=t,s=this._searchForItems(t),o=[];return 0===s.length||this._createTileGraphics(o,e,s,{originPosition:"upperLeft",scale:[r,r],translate:[i[0],i[3]]},t),o},g.has=function(e){return this._itemByGraphic.has(e)},g.getBounds=function(e){const t=this._itemByGraphic.get(e);return t?t.bounds:null},g.getAllBounds=function(){return Array.from(this._itemByGraphic.values()).filter((e=>e.graphic.visible)).map((e=>e.bounds))},g.addOrModify=function(e,t,i){if(!e||null==t)return;this.has(e)&&this.remove(e),this._onAdd(e);const r=[0,0,0,0],s=this._getSymbolBounds(null,t,i,r,0),o=a.acquire(e,t,i,null!=s?s:null,r);return this._itemByGraphic.set(e,o),i&&this._index.insert(o),o.bounds},g.remove=function(e){if(!this._itemByGraphic.has(e))return;this._onRemove(e);const t=this._itemByGraphic.get(e);t?.bounds&&this._index.remove(t),this._itemByGraphic.delete(e)},g.updateZ=function(){const e=this._graphics.items;let t,i;for(let r=0;r<e.length;r++)i=e[r],t=this._itemByGraphic.get(i),t&&(t.zorder=r)},g.update=function(e,t,i){const s=this._itemByGraphic.get(e);s.groupId=null;const o=r.clone(s.bounds);this._index.remove(s);const n=this._getSymbolBounds(s.bounds,t,i,s.size,0);return null!=n&&s.set(e,t,i,n,s.size),i&&this._index.insert(s),{oldBounds:o,newBounds:s.bounds}},g.updateLevel=function(e){if(this._resolution===e)return;this._resolution=e,this._index.clear();const t=this._itemByGraphic,i=[];for(const[r,s]of t){const e=this._getSymbolBounds(s.bounds,s.symbolResource,s.geometry,s.size,0);s.geometry&&null!=e&&(s.bounds=e,i.push(s))}this._index.load(i)},g.clear=function(){this._itemByGraphic.clear(),this._index.clear()},g._createTileGraphics=function(e,t,i,r,s){const o=this._uidFieldName,n=this._tileInfoView.spatialReference,{bounds:u,resolution:l}=s;let c,h,d,p;i.sort(((e,t)=>e.zorder-t.zorder));for(let m=0;m<i.length;m++){d=i[m],c=d.graphic,h=d.getGeometryQuantized(r,u,n,l),p=0===m?-1:i[m-1].graphic.uid;const s={...d.graphic.attributes};s[o]=c.uid,null==d.groupId&&(d.groupId=t.createTemplateGroup(d.symbol,null)),e.push({centroid:a.getCentroidQuantized(d,r),geometry:h,attributes:s,symbol:d.symbol,groupId:d.groupId,insertAfter:p,zorder:d.zorder})}},g._searchForItems=function(e){const t=this._tileInfoView.spatialReference,i=e.bounds,s=n.getInfo(t);if(s&&t.isWrappable){const[t,o]=s.valid,n=Math.abs(i[2]-o)<p,u=Math.abs(i[0]-t)<p;if((!n||!u)&&(n||u)){const s=e.resolution;let u;u=n?r.create([t,i[1],t+s*c.PIXEL_BUFFER,i[3]]):r.create([o-s*c.PIXEL_BUFFER,i[1],o,i[3]]);const l=m(this._index,i[0],i[1],i[2],i[3]),a=m(this._index,u[0],u[1],u[2],u[3]);return[...new Set([...l,...a])]}}return m(this._index,i[0],i[1],i[2],i[3])},g._getSymbolBounds=function(e,i,o,n,u){if(!i||!i.symbol||!o)return null;if(e||(e=r.create()),s.getBoundsXY(e,o),!n||0===n[0]&&0===n[1]&&0===n[2]&&0===n[3]){const{hash:e,textInfo:r}=i,s=this._hashToCIM.get(e);if(!s)return null;n||(n=[0,0,0,0]);const o=this._inflatedSizeHelper.getSymbolInflateSize(n,s.symbol,this._cimResourceManager,u,r);n[0]=t.pt2px(o[0]),n[1]=t.pt2px(o[1]),n[2]=t.pt2px(o[2]),n[3]=t.pt2px(o[3])}const a=this._resolution,c=l.CIMSymbolInflatedSizeHelper.safeSize(n);return e[0]-=c*a,e[1]-=c*a,e[2]+=c*a,e[3]+=c*a,e},e._createClass(h)}();const _=(e,t)=>{const i=c.graphicGeometryToNumber(e.graphic),r=c.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r};return g}));
