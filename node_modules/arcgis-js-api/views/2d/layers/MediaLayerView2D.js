/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../Graphic","../../../renderers/ClassBreaksRenderer","../../../renderers/DictionaryRenderer","../../../renderers/DotDensityRenderer","../../../renderers/HeatmapRenderer","../../../renderers/PieChartRenderer","../../../renderers/Renderer","../../../renderers/SimpleRenderer","../../../renderers/UniqueValueRenderer","../../../renderers/support/jsonUtils","../../../symbols","../../../core/Collection","../../../core/has","../../../core/Logger","../../../core/MapUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/aaBoundingRect","../../../geometry/support/contains","../../../geometry/support/intersectsBase","../../../layers/support/MediaElementView","../../../core/Error","../../../core/scheduling","../../../request","../../../config","../../../chunks/index3","../../../core/urlUtils","../../../chunks/index4","../../../layers/effects/EffectView","../engine/DisplayObject","../engine/webgl/effects/highlight/HighlightGradient","../engine/webgl/BufferPool","../engine/webgl/enums","../engine/webgl/brushes/BrushBitmap","../../../chunks/vec4f32","../engine/webgl/Utils","../engine/webgl/shaders/BackgroundPrograms","../../webgl/enums","../../webgl/checkWebGLError","../../webgl/contextUtils","../../../chunks/builtins","../engine/webgl/definitions","../../../core/RandomLCG","../engine/webgl/materialKey/MaterialKey","../engine/webgl/techniques/Technique","../engine/webgl/techniques/dotDensity/TechniqueDotDensity","../engine/webgl/techniques/heatmap/TechniqueHeatmap","../engine/webgl/techniques/pieChart/TechniquePieChart","../../webgl/BufferObject","../../webgl/FramebufferObject","../../webgl/GLObjectType","../../webgl/Texture","../../webgl/VertexArrayObject","../engine/webgl/brushes/WGLBrushHeatmap","../engine/webgl/DefaultVertexAttributeLayouts","../engine/webgl/shaders/TileInfoPrograms","../engine/webgl/brushes/WGLGeometryBrushMarker","../../../core/mathUtils","../engine/webgl/number","../engine/vectorTiles/style/StyleDefinition","../../../chunks/vec2f32","../engine/vectorTiles/enums","../engine/vectorTiles/shaders/sources/resolver","../engine/webgl/shaders/BitBlitPrograms","../engine/webgl/shaders/sources/resolver","../engine/webgl/TextureManager","../engine/webgl/shaders/StencilPrograms","../engine/webgl/effects/BlendEffect","../engine/webgl/shaders/HighlightPrograms","../engine/webgl/Profiler","../../webgl/renderState","../../3d/webgl-engine/core/shaderModules/interfaces","../../../core/floatRGBA","../../3d/webgl-engine/lib/OrderIndependentTransparency","../../webgl/testSVGPremultipliedAlpha","../LabelManager","./graphics/GraphicsView2D","../../../core/accessorSupport/tracking/Flags","../engine/webgl/AttributeStoreView","../../../chunks/earcut","../../../layers/graphics/featureConversionUtils","../../../core/unitUtils","../../../renderers/support/lengthUtils","../../../chunks/vec3f32","../../../geometry/support/normalizeUtils","../navigation/MapViewNavigation","../../../core/asyncUtils","../engine/webgl/shaders/MagnifierPrograms","../tiling/PagedTileQueue","../tiling/TileInfoView","../tiling/TileKey","../tiling/TileQueue","../tiling/TileStrategy","../engine/webgl/Overlay","../engine/webgl/OverlayContainer","./LayerView2D","../../layers/LayerView","../../../geometry/Extent"],(function(e,t,r,n,i,s,l,o,a,c,u,h,g,d,f,p,m,y,w,b,_,v,T,E,R,C,S,U,V,q,x,G,k,P,B,M,D,L,j,A,H,O,Q,z,I,K,W,F,N,J,X,Y,Z,$,ee,te,re,ne,ie,se,le,oe,ae,ce,ue,he,ge,de,fe,pe,me,ye,we,be,_e,ve,Te,Ee,Re,Ce,Se,Ue,Ve,qe,xe,Ge,ke,Pe,Be,Me,De,Le,je,Ae,He,Oe,Qe,ze,Ie,Ke,We,Fe,Ne,Je,Xe){"use strict";let Ye=function(t){function r(){var e;return(e=t.apply(this,arguments)||this)._overlayContainer=null,e._fetchQueue=null,e._tileStrategy=null,e._elementReferences=new Map,e._debugGraphicsView=null,e.layer=null,e.elements=new f,e}e._inherits(r,t);var n=r.prototype;return n.attach=function(){this.addAttachHandles([b.on((()=>this.layer.effectiveSource),"refresh",(()=>{this._tileStrategy.refresh((e=>this._updateTile(e))),this.requestUpdate()})),b.on((()=>this.layer.effectiveSource),"change",(({element:e})=>this._elementUpdateHandler(e)))]),this._overlayContainer=new Fe,this.container.addChild(this._overlayContainer),this._fetchQueue=new Ie({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new Ke({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()},n.detach=function(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()},n.supportsSpatialReference=function(e){return!0},n.moveStart=function(){this.requestUpdate()},n.viewChange=function(){this.requestUpdate()},n.moveEnd=function(){this.requestUpdate()},n.update=function(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)},n.hitTest=async function(e,t){const r=[],n=e.normalize(),i=[n.x,n.y];for(const{projectedElement:{normalizedCoords:s,element:l}}of this._elementReferences.values())null!=s&&C.ringsContainsCoords(s.rings,i)&&r.push({type:"media",element:l,layer:this.layer,mapPoint:e});return r.reverse()},n.canResume=function(){return null!=this.layer.source&&e._get(e._getPrototypeOf(r.prototype),"canResume",this).call(this)},n.doRefresh=async function(){this._fetchQueue.reset(),this._tileStrategy.refresh((e=>this._updateTile(e)))},n._acquireTile=function(e){const t=new tt(e.clone());return this._updateTile(t),t},n._updateTile=function(e){this.updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[r,n]=e.setElements(t);this._referenceElements(e,r),this._dereferenceElements(e,n),this.requestUpdate()}),(e=>{w.isAbortError(e)||m.getLogger(this).error(e)})))},n._releaseTile=function(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()},n._queryElements=async function(e,t){const r=this.layer.effectiveSource;if(null==r)return[];this.view.featuresTilingScheme.getTileBounds(Ze,e,!0);const n=new Xe({xmin:Ze[0],ymin:Ze[1],xmax:Ze[2],ymax:Ze[3],spatialReference:this.view.spatialReference});return r.queryElements(n,t)},n._referenceElements=function(e,t){if(null!=this.layer.source)for(const r of t)this._referenceElement(e,r)},n._referenceElement=function(e,t){y.getOrCreateMapValue(this._elementReferences,t.uid,(()=>{const e=new U.MediaElementView({element:t,spatialReference:this.view.spatialReference}),r=new We(e);this._overlayContainer.addChild(r),this.elements.add(t);let n=null;return{tiles:new Set,projectedElement:e,overlay:r,debugGraphic:n}})).tiles.add(e)},n._dereferenceElements=function(e,t){for(const r of t)this._dereferenceElement(e,r)},n._dereferenceElement=function(e,t){const r=this._elementReferences.get(t.uid);r.tiles.delete(e),r.tiles.size||(this._overlayContainer.removeChild(r.overlay),r.overlay.destroy(),r.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(r.debugGraphic))},n._elementUpdateHandler=function(e){let t=this._elementReferences.get(e.uid);if(t){const r=t.projectedElement.normalizedCoords;if(null==r)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);const n=[],i=[];for(const e of this._tileStrategy.tiles){const s=et(this.view.featuresTilingScheme,e,r);t.tiles.has(e)?s||i.push(e):s&&n.push(e)}for(const t of n)this._referenceElement(t,e);for(const t of i)this._dereferenceElement(t,e);return t=this._elementReferences.get(e.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const r=new U.MediaElementView({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=r)for(const n of this._tileStrategy.tiles){et(this.view.featuresTilingScheme,n,r)&&this._referenceElement(n,e)}},e._createClass(r)}(Ne.LayerView2DMixin(Je));t.__decorate([_.property()],Ye.prototype,"_fetchQueue",void 0),t.__decorate([_.property()],Ye.prototype,"layer",void 0),t.__decorate([_.property({readOnly:!0})],Ye.prototype,"elements",void 0),Ye=t.__decorate([E.subclass("esri.views.2d.layers.MediaLayerView2D")],Ye);const Ze=R.create(),$e={xmin:0,ymin:0,xmax:0,ymax:0};function et(e,t,r){return e.getTileBounds(Ze,t.key,!0),$e.xmin=Ze[0],$e.ymin=Ze[1],$e.xmax=Ze[2],$e.ymax=Ze[3],S.extentIntersectsPolygon($e,r)}let tt=function(){function t(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}var r=t.prototype;return r.setElements=function(e){const t=[],r=new Set(this.elements);this.elements=e;for(const n of e)r.has(n)?r.delete(n):t.push(n);return this.isReady=!0,[t,Array.from(r)]},r.destroy=function(){},e._createClass(t)}();return Ye}));
