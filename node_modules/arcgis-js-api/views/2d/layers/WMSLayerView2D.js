/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../engine/BitmapContainer","./LayerView2D","./support/ExportStrategy","../../layers/LayerView","../../layers/RefreshableLayerView","../../layers/WMSLayerView"],(function(e,t,r,i,a,n,s,o,c,p,h,u,d,y,l,m,g,f){"use strict";let x=function(t){function s(){var e;return(e=t.apply(this,arguments)||this).bitmapContainer=new d.BitmapContainer,e}e._inherits(s,t);var o=s.prototype;return o.supportsSpatialReference=function(e){return this.layer.serviceSupportsSpatialReference(e)},o.update=function(e){this.strategy.update(e).catch((e=>{a.isAbortError(e)||r.getLogger(this).error(e)}))},o.attach=function(){const{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:r}=e;this.bitmapContainer=new d.BitmapContainer,this.container.addChild(this.bitmapContainer),this.strategy=new l({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:r,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.addAttachHandles(n.watch((()=>this.exportImageVersion),(()=>this.requestUpdate())))},o.detach=function(){this.strategy=i.destroyMaybe(this.strategy),this.container.removeAllChildren()},o.moveStart=function(){},o.viewChange=function(){},o.moveEnd=function(){this.requestUpdate()},o.createFetchPopupFeaturesQuery=function(e){const{view:t,bitmapContainer:r}=this,{x:i,y:a}=e,{spatialReference:n}=t;let s,o=0,c=0;if(r.children.some((e=>{const{width:t,height:r,resolution:p,x:h,y:d}=e,y=h+p*t,l=d-p*r;return i>=h&&i<=y&&a<=d&&a>=l&&(s=new u({xmin:h,ymin:l,xmax:y,ymax:d,spatialReference:n}),o=t,c=r,!0)})),!s)return null;const p=s.width/o,h=Math.round((i-s.xmin)/p),d=Math.round((s.ymax-a)/p);return{extent:s,width:o,height:c,x:h,y:d}},o.doRefresh=async function(){this.requestUpdate()},o.isUpdating=function(){return this.strategy.updating||this.updateRequested},o.fetchImage=function(e,t,r,i){return this.layer.fetchImageBitmap(e,t,r,{timeExtent:this.timeExtent,...i})},e._createClass(s)}(f(g(y.LayerView2DMixin(m))));t.__decorate([s.property()],x.prototype,"strategy",void 0),t.__decorate([s.property()],x.prototype,"updating",void 0),x=t.__decorate([h.subclass("esri.views.2d.layers.WMSLayerView2D")],x);return x}));
