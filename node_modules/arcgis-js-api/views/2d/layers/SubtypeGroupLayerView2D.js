/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/has","../../../core/reactiveUtils","../../../core/Logger","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../layers/support/FeatureFilter","./FeatureLayerView2D"],(function(e,t,r,i,s,n,l,a,o,u,y){"use strict";function p(e,t){return!e.visible||0!==e.minScale&&t>e.minScale||0!==e.maxScale&&t<e.maxScale}let c=function(t){function s(){return t.apply(this,arguments)||this}e._inherits(s,t);var n=s.prototype;return n.initialize=function(){this.addHandles([i.watch((()=>this.view.scale),(()=>this._update()),i.initial)],"constructor")},n.isUpdating=function(){const e=this.layer.sublayers.some((e=>null!=e.renderer)),t=this._commandsQueue.updating,i=null!=this._updatingRequiredFieldsPromise,s=!this._proxy||!this._proxy.isReady,n=this._pipelineIsUpdating,l=null==this.tileRenderer||this.tileRenderer?.updating,a=e&&(t||i||s||n||l);return r("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${a}\n  -> hasRenderer ${e}\n  -> hasPendingCommand ${t}\n  -> updatingRequiredFields ${i}\n  -> updatingProxy ${s}\n  -> updatingPipeline ${n}\n  -> updatingTileRenderer ${l}\n`),a},n._injectOverrides=function(t){let r=e._get(e._getPrototypeOf(s.prototype),"_injectOverrides",this).call(this,t);const i=this.view.scale,n=this.layer.sublayers.filter((e=>p(e,i))).map((e=>e.subtypeCode));if(!n.length)return r;r=null!=r?r:(new u).toJSON();const l=`NOT ${this.layer.subtypeField} IN (${n.join(",")})`;return r.where=r.where?`(${r.where}) AND (${l})`:l,r},n._setLayersForFeature=function(e){const t=this.layer.fieldsIndex.get(this.layer.subtypeField),r=e.attributes[t.name],i=this.layer.sublayers.find((e=>e.subtypeCode===r));e.layer=e.sourceLayer=i},n._createSchemaConfig=function(){const t={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers).map((e=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null})))},r=this.layer.sublayers.map((e=>e.subtypeCode)).join(","),i=this.layer.sublayers.length?`${this.layer.subtypeField} IN (${r})`:"1=2";let n=this.layer.definitionExpression?this.layer.definitionExpression+" AND ":"";return n+=i,{...e._get(e._getPrototypeOf(s.prototype),"_createSchemaConfig",this).call(this),...t,definitionExpression:n}},e._createClass(s)}(y);c=t.__decorate([o.subclass("esri.views.2d.layers.SubtypeGroupLayerView2D")],c);return c}));
