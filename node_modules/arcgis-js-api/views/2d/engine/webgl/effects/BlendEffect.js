/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../enums","../VertexStream","../shaders/BlendPrograms","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,n,i,s,a,o,d,u,c){"use strict";const l=n.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");let f=function(){function e(){this._size=[0,0]}var n=e.prototype;return n.dispose=function(e){this._backBufferTexture=i.disposeMaybe(this._backBufferTexture),this._quad=i.disposeMaybe(this._quad)},n.draw=function(e,t,n,i,a){const{context:u,drawPhase:c}=e;if(this._setupShader(u),i&&"normal"!==i&&c!==s.WGLDrawPhase.LABEL)return void this._drawBlended(e,t,n,i,a);const f=o.createProgramTemplate("normal"),h=u.programCache.acquire(f.shaders.vertexShader,f.shaders.fragmentShader,f.attributes);if(!h)return void l.error(new r("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));u.useProgram(h),t.setSamplingMode(n),u.bindTexture(t,0),h.setUniform1i("u_layerTexture",0),h.setUniform1f("u_opacity",a),u.setBlendingEnabled(!0),u.setBlendFunction(d.BlendFactor.ONE,d.BlendFactor.ONE_MINUS_SRC_ALPHA);const _=this._quad;_.draw(),_.unbind(),h.dispose()},n._drawBlended=function(e,t,n,i,s){const{context:a,state:u,pixelRatio:c,inFadeTransition:f}=e,{size:h}=u,_=a.getBoundFramebufferObject();let m,b;null!=_?(m=_.width,b=_.height):(m=Math.round(c*h[0]),b=Math.round(c*h[1])),this._createOrResizeTexture(e,m,b);const p=this._backBufferTexture;_.copyToTexture(0,0,m,b,0,0,p),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);const g=o.createProgramTemplate(i),x=a.programCache.acquire(g.shaders.vertexShader,g.shaders.fragmentShader,g.attributes);if(!x)return void l.error(new r("mapview-BlendEffect",`Error creating shader program for blend mode ${i}`));a.useProgram(x),p.setSamplingMode(n),a.bindTexture(p,0),x.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(n),a.bindTexture(t,1),x.setUniform1i("u_layerTexture",1),x.setUniform1f("u_opacity",s),x.setUniform1f("u_inFadeOpacity",f?1:0),a.setBlendFunction(d.BlendFactor.ONE,d.BlendFactor.ZERO);const B=this._quad;B.draw(),B.unbind(),x.dispose(),a.setBlendFunction(d.BlendFactor.ONE,d.BlendFactor.ONE_MINUS_SRC_ALPHA)},n._setupShader=function(e){this._quad||(this._quad=new a(e,[-1,-1,1,-1,-1,1,1,1]))},n._createOrResizeTexture=function(e,t,r){const{context:n}=e;if(null===this._backBufferTexture||t!==this._size[0]||r!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(t,r);else{const e=new c.TextureDescriptor;e.internalFormat=d.PixelFormat.RGBA,e.wrapMode=d.TextureWrapMode.CLAMP_TO_EDGE,e.width=t,e.height=r,this._backBufferTexture=new u.Texture(n,e)}this._size[0]=t,this._size[1]=r}},t._createClass(e)}();e.BlendEffect=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
