/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../definitions","./Effect","../../../../webgl/enums"],(function(t,e,i,n,s){"use strict";let o=function(t){function n(){var e;return(e=t.apply(this,arguments)||this).name=e.constructor.name,e.defines=["hittest"],e}e._inherits(n,t);var o=n.prototype;return o.dispose=function(){null!=this._fbo&&this._fbo.dispose()},o.createOptions=function({pixelRatio:t},e,n=i.HITTEST_RADIUS){if(!e.length)return null;const s=e.shift(),o=s.x,r=s.y;return this._outstanding=s,{type:"hittest",distance:n*t,position:[o,r]}},o.bind=function(t){const{context:e,attributeView:n}=t;if(!n.size)return;const s=n.getBlock(i.ATTRIBUTE_DATA_GPGPU);if(null==s)return;const o=s.getFBO(e);e.setViewport(0,0,n.size,n.size),e.bindFramebuffer(o),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT)},o.unbind=function(t){},o.draw=function(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)},o._resolve=async function(t,e){const{context:n,attributeView:o}=t,r=o.getBlock(i.ATTRIBUTE_DATA_GPGPU);if(null==r)return void e.forEach((t=>t.resolve([])));const c=r.getFBO(n),l=new Uint8Array(c.width*c.height*4);try{await c.readPixelsAsync(0,0,c.width,c.height,s.PixelFormat.RGBA,s.PixelType.UNSIGNED_BYTE,l)}catch(f){return void e.forEach((t=>t.resolve([])))}const u=[];for(let i=0;i<l.length;i+=4){const t=l[i],e=l[i+3];t&&u.push({id:i/4,directHits:e})}u.sort(((t,e)=>e.directHits===t.directHits?e.id-t.id:e.directHits-t.directHits));const a=u.map((t=>t.id));e.forEach((t=>t.resolve(a)))},e._createClass(n)}(n.Effect);t.HittestEffect=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
