/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../VertexStream","../../../../../webgl/enums","../../../../../webgl/FramebufferObject","../../../../../webgl/TextureDescriptor"],(function(e,t,s,i,r,o,n){"use strict";const a=5,u=[1,0],l=[0,1],c=[1,.8,.6,.4,.2],m=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];let p=function(){function e(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(a),this._nMips=a,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}var p=e.prototype;return p.dispose=function(){if(this._quad=s.disposeMaybe(this._quad),this._intensityFBO=s.disposeMaybe(this._intensityFBO),this._compositeFBO=s.disposeMaybe(this._compositeFBO),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}},p.draw=function(e,t,s){const{width:o,height:n}=t,{context:p,painter:_}=e,{materialManager:h}=_,d=p.gl,f=this._programDesc,{strength:b,radius:F,threshold:B}=s;this._quad||(this._quad=new i(p,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,o,n),p.setStencilTestEnabled(!1),p.setBlendingEnabled(!0),p.setBlendFunction(r.BlendFactor.ONE,r.BlendFactor.ONE_MINUS_SRC_ALPHA),p.setStencilWriteMask(0);const O=this._quad;O.bind(),p.bindFramebuffer(this._intensityFBO);const g=h.getProgram(f.luminosityHighPass);p.useProgram(g),p.bindTexture(t.colorTexture,0),g.setUniform1i("u_texture",0),g.setUniform3fv("u_defaultColor",[0,0,0]),g.setUniform1f("u_defaultOpacity",0),g.setUniform1f("u_luminosityThreshold",B),g.setUniform1f("u_smoothWidth",.01);const x=[Math.round(o/2),Math.round(n/2)];p.setViewport(0,0,x[0],x[1]),p.setClearColor(0,0,0,0),p.clear(d.COLOR_BUFFER_BIT),O.draw(),p.setBlendingEnabled(!1);let T=this._intensityFBO.colorTexture;for(let i=0;i<this._nMips;i++){const e=h.getProgram(f.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[i]}]);p.useProgram(e),p.bindTexture(T,i+1),e.setUniform1i("u_colorTexture",i+1),e.setUniform2fv("u_texSize",x),e.setUniform2fv("u_direction",u),p.setViewport(0,0,x[0],x[1]);const t=this._mipsFBOs[i];p.bindFramebuffer(t.horizontal),O.draw(),T=t.horizontal.colorTexture,p.bindFramebuffer(t.vertical),p.bindTexture(T,i+1),e.setUniform2fv("u_direction",l),O.draw(),T=t.vertical.colorTexture,x[0]=Math.round(x[0]/2),x[1]=Math.round(x[1]/2)}p.setViewport(0,0,o,n);const M=h.getProgram(f.composite,[{name:"nummips",value:a}]);p.bindFramebuffer(this._compositeFBO),p.useProgram(M),M.setUniform1f("u_bloomStrength",b),M.setUniform1f("u_bloomRadius",F),M.setUniform1fv("u_bloomFactors",c),M.setUniform3fv("u_bloomTintColors",m),p.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),M.setUniform1i("u_blurTexture1",1),p.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),M.setUniform1i("u_blurTexture2",2),p.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),M.setUniform1i("u_blurTexture3",3),p.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),M.setUniform1i("u_blurTexture4",4),p.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),M.setUniform1i("u_blurTexture5",5),O.draw(),p.bindFramebuffer(t),p.setBlendingEnabled(!0);const w=h.getProgram(f.blit);p.useProgram(w),p.bindTexture(this._compositeFBO.colorTexture,6),w.setUniform1i("u_texture",6),p.setBlendFunction(r.BlendFactor.ONE,r.BlendFactor.ONE),O.draw(),O.unbind(),p.setBlendFunction(r.BlendFactor.ONE,r.BlendFactor.ONE_MINUS_SRC_ALPHA),p.setStencilTestEnabled(!0)},p._createOrResizeResources=function(e,t,s){const{context:i}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===s)return;this._size[0]=t,this._size[1]=s;const a=[Math.round(t/2),Math.round(s/2)];if(this._compositeFBO)this._compositeFBO.resize(t,s);else{const e=new n.TextureDescriptor(t,s);e.internalFormat=r.PixelFormat.RGBA,e.wrapMode=r.TextureWrapMode.CLAMP_TO_EDGE,this._compositeFBO=new o.FramebufferObject(i,e)}if(this._intensityFBO)this._intensityFBO.resize(a[0],a[1]);else{const e=new n.TextureDescriptor(a[0],a[1]);e.internalFormat=r.PixelFormat.RGBA,e.wrapMode=r.TextureWrapMode.CLAMP_TO_EDGE,this._intensityFBO=new o.FramebufferObject(i,e)}for(let u=0;u<this._nMips;u++){if(this._mipsFBOs[u])this._mipsFBOs[u].horizontal.resize(a[0],a[1]),this._mipsFBOs[u].vertical.resize(a[0],a[1]);else{const e=new n.TextureDescriptor(a[0],a[1]);e.internalFormat=r.PixelFormat.RGBA,e.wrapMode=r.TextureWrapMode.CLAMP_TO_EDGE,this._mipsFBOs[u]={horizontal:new o.FramebufferObject(i,e),vertical:new o.FramebufferObject(i,e)}}a[0]=Math.round(a[0]/2),a[1]=Math.round(a[1]/2)}},t._createClass(e)}();e.Bloom=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
