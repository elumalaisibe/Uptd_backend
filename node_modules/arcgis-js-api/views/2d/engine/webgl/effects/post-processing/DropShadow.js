/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/maybe","../../../../../../core/screenUtils","../../VertexStream","../../../../../webgl/enums","../../../../../webgl/FramebufferObject","../../../../../webgl/Texture","../../../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,o,a,n,l){"use strict";const u=[1,0],c=[0,1];let h=function(){function e(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}var h=e.prototype;return h.dispose=function(){this._layerFBOTexture=r.disposeMaybe(this._layerFBOTexture),this._horizontalBlurFBO=r.disposeMaybe(this._horizontalBlurFBO),this._verticalBlurFBO=r.disposeMaybe(this._verticalBlurFBO)},h.draw=function(e,t,r){const{context:a,state:n,painter:l}=e,{materialManager:h}=l,p=this._programDesc,_=t.width,d=t.height,f=[Math.round(_),Math.round(d)],{blurRadius:B,offsetX:b,offsetY:m,color:x}=r,F=[i.pt2px(b),i.pt2px(m)];this._createOrResizeResources(e,_,d,f);const T=this._horizontalBlurFBO,O=this._verticalBlurFBO;a.setStencilWriteMask(0),a.setStencilTestEnabled(!1),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1);const w=this._layerFBOTexture;t.copyToTexture(0,0,_,d,0,0,w),this._quad||(this._quad=new s(a,[-1,-1,1,-1,-1,1,1,1])),a.setViewport(0,0,f[0],f[1]);const g=this._quad;g.bind(),a.setBlendingEnabled(!1);const M=h.getProgram(p.blur,[{name:"radius",value:Math.ceil(B)}]);a.useProgram(M),a.bindFramebuffer(T),a.bindTexture(t.colorTexture,4),M.setUniform1i("u_colorTexture",4),M.setUniform2fv("u_texSize",f),M.setUniform2fv("u_direction",u),M.setUniform1f("u_sigma",B),g.draw(),a.bindFramebuffer(O),a.bindTexture(T?.colorTexture,5),M.setUniform1i("u_colorTexture",5),M.setUniform2fv("u_direction",c),g.draw(),a.bindFramebuffer(t),a.setViewport(0,0,_,d);const v=h.getProgram(p.composite);a.useProgram(v),a.bindTexture(O?.colorTexture,2),v.setUniform1i("u_blurTexture",2),a.bindTexture(w,3),v.setUniform1i("u_layerFBOTexture",3),v.setUniform4fv("u_shadowColor",[x[3]*(x[0]/255),x[3]*(x[1]/255),x[3]*(x[2]/255),x[3]]),v.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),v.setUniform2fv("u_shadowOffset",F),g.draw(),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!0),a.setBlendFunction(o.BlendFactor.ONE,o.BlendFactor.ONE_MINUS_SRC_ALPHA),g.unbind()},h._createOrResizeResources=function(e,t,r,i){const{context:s}=e;if(!this._horizontalBlurFBO||this._size[0]!==t||this._size[1]!==r){if(this._size[0]=t,this._size[1]=r,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(i[0],i[1]);else{const e=new l.TextureDescriptor(i[0],i[1]);e.internalFormat=o.PixelFormat.RGBA,e.wrapMode=o.TextureWrapMode.CLAMP_TO_EDGE,this._horizontalBlurFBO=new a.FramebufferObject(s,e)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(i[0],i[1]);else{const e=new l.TextureDescriptor(i[0],i[1]);e.internalFormat=o.PixelFormat.RGBA,e.wrapMode=o.TextureWrapMode.CLAMP_TO_EDGE,this._verticalBlurFBO=new a.FramebufferObject(s,e)}if(this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{const e=new l.TextureDescriptor;e.internalFormat=o.PixelFormat.RGBA,e.wrapMode=o.TextureWrapMode.CLAMP_TO_EDGE,e.width=t,e.height=r,this._layerFBOTexture=new n.Texture(s,e)}}},t._createClass(e)}();e.DropShadow=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
