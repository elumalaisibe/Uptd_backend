/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../definitions","./Effect","../../../../webgl/enums"],(function(t,e,n,i,o){"use strict";let s=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).name=e.constructor.name,e.defines=["id"],e._lastSize=0,e._boundFBO=null,e}e._inherits(i,t);var s=i.prototype;return s.dispose=function(){null!=this._fbo&&this._fbo.dispose()},s.bind=function({context:t,painter:e}){const{width:n,height:i}=t.getViewport();this._boundFBO=t.getBoundFramebufferObject();const o=e.getFbos(n,i).effect0;t.bindFramebuffer(o),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)},s.unbind=function({context:t}){t.bindFramebuffer(this._boundFBO),this._boundFBO=null},s.draw=function(t,e,i=2*n.HITTEST_RADIUS){this._resolve(t,e,i)},s._resolve=async function({context:t,state:e,pixelRatio:n},i,s){const r=t.getBoundFramebufferObject(),f=e.size[1]*n,u=Math.round(s*n),a=u/2,l=u/2;this._ensureBuffer(u),i.forEach((async(t,e)=>{const s=new Map,c=Math.floor(e.x*n-u/2),h=Math.floor(f-e.y*n-u/2);await r.readPixelsAsync(c,h,u,u,o.PixelFormat.RGBA,o.PixelType.UNSIGNED_BYTE,this._buf);for(let n=0;n<this._buf32.length;n++){const t=this._buf32[n];if(4294967295!==t&&0!==t){const e=n%u,i=u-Math.floor(n/u),o=(a-e)*(a-e)+(l-i)*(l-i),r=s.has(t)?s.get(t):4294967295;s.set(t,Math.min(o,r))}}const b=Array.from(s).sort(((t,e)=>t[1]-e[1])).map((t=>t[0]));t.resolve(b),i.delete(e)}))},s._ensureBuffer=function(t){this._lastSize!==t&&(this._lastSize=t,this._buf=new Uint8Array(4*t*t),this._buf32=new Uint32Array(this._buf.buffer))},e._createClass(i)}(i.Effect);t.HittestEffectVTL=s,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
