/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../FeatureDisplayList","./Buffer","./DisplayRecordReader","../../../../webgl/VertexArrayObject"],(function(e,t,r,i,s,n,f){"use strict";const o=0,d=1;let u=function(){function e(e,t){this._vaos=new Map,this._indicesInvalid=!1,this.geometryType=e,this._stage=t}var u=e.prototype;return u.destroy=function(){for(const[e,t]of this._vaos)t?.disposeVAOOnly();this._indexBuffer=r.destroyMaybe(this._indexBuffer),this._vertexBuffer=r.destroyMaybe(this._vertexBuffer)},u.insert=function(e,t,i){if(!e.records.byteLength)return;const f=e.stride;if(this._vertexBuffer&&this._indexBuffer){const i=e.indices.byteLength/4,s=e.vertices.byteLength/f;this._indexBuffer.ensure(i),this._vertexBuffer.ensure(s);const{vertices:o,indices:d}=e,u=n.DisplayRecordReader.from(e.records),h=this._vertexBuffer.insert(o,0,o.byteLength/f,0),c=this._indexBuffer.insert(d,0,d.byteLength/4,h);if(u.forEach((e=>{e.indexFrom+=c,e.vertexFrom+=h})),r.unwrapOrThrow(this._records,"Expected records to be defined").link(u),t)this._indicesInvalid=!0;else if(this._displayList){const e=u.getCursor();for(;e.next();)this._displayList.addRecord(e)}}else{const r=e.indices.byteLength/4,i=e.vertices.byteLength/f,o=f/Uint32Array.BYTES_PER_ELEMENT,d=this._stage.bufferPool;this._records=n.DisplayRecordReader.from(e.records),this._indexBuffer=new s.Buffer("index",r,1,d),this._vertexBuffer=new s.Buffer("vertex",i,o,d),this._indexBuffer.insert(e.indices,0,e.indices.byteLength/4,0),this._vertexBuffer.insert(e.vertices,0,e.vertices.byteLength/f,0),t&&(this._indicesInvalid=!0)}},u.remove=function(e){if(null!=this._records)for(const t of e){const e=this._records.getCursor();if(!e.lookup(t))continue;const r=e.indexFrom,i=e.vertexFrom;let s=e.indexCount,n=e.vertexCount;for(;e.next()&&e.id===t;)s+=e.indexCount,n+=e.vertexCount;this._indexBuffer.free(r,s),this._vertexBuffer.free(i,n,!0),this._records.delete(t)}},u.getVAO=function(e,t,r,i){if(!this._vertexBuffer||!this._indexBuffer||null==this._records||!this._vertexBuffer.bufferSize)return null;const s=i?d:o;let n=this._vaos.get(s);(this._vertexBuffer.invalidated||this._indexBuffer.invalidated||i&&this._indexBuffer.invalidatedComputeBuffer)&&(n?.disposeVAOOnly(),n=null),this._vertexBuffer.upload(),this._indexBuffer.upload();const u=this._indexBuffer.getGPUBuffer(e,1===s),h=this._vertexBuffer.getGPUBuffer(e);return n||(n=new f.VertexArrayObject(e,r,t,{geometry:h},u),this._vaos.set(s,n)),n},u.forEachCommand=function(e){if(null!=this._records){if(this._sortIndices(this._records),!this._displayList){const e=this._cursorIndexOrder;this._displayList=i.FeatureDisplayList.from(this,this.geometryType,this._records.getCursor(),e)}this._displayList.forEach(e)}},u._sortIndices=function(e){const t=!!this._indexBuffer.bufferSize;if(!this._indicesInvalid)return;this._indicesInvalid=!1;let r=0;const i=e.getCursor(),s=[],n=[],f=[];for(;i.next();)n.push(i.index),f.push(i.sortKey),s.push(i.id);n.sort(((e,t)=>{const r=f[t],i=f[e];return i===r?s[t]-s[e]:r-i}));const o=e.getCursor(),d=t?this._indexBuffer.getCPUBuffer():this._vertexBuffer.getCPUBuffer();for(const u of n){if(!o.seekIndex(u))throw new Error("Expected to find index");if(t){const{indexFrom:e,indexCount:t}=o;o.indexFrom=r;for(let i=0;i<t;i++)this._indexBuffer.set(r++,d.array[e+i])}else{const{vertexFrom:e,vertexCount:t}=o,i=this._vertexBuffer.strideInt,s=e*i,n=s+t*i;o.vertexFrom=r/i;for(let f=s;f<n;f++)this._vertexBuffer.set(r++,d.array[f])}}this._cursorIndexOrder=n,this._displayList=null},t._createClass(e,[{key:"records",get:function(){return this._records}}]),e}();e.Geometry=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
