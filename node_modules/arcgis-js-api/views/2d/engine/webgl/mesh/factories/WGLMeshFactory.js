/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/has","../../../../../../core/promiseUtils","../../../../../../geometry/libtess","../../DisplayId","../templates/WGLLabelTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore"],(function(e,t,i,s,l,r,a,n,o){"use strict";let u=function(){function e(e,t,i){this._loadPromise=l.loadLibtess(),this._geometryType=e,this._idField=t,this._templateStore=i}var i=e.prototype;return i.update=function(e,t){null!=e.mesh.labels&&(this._labelTemplates=this._createLabelTemplates(e.mesh.labels,t)),this._schema=e},i._createLabelTemplates=function(e,t){const i=new Map;if("simple"===e.type){for(const s of e.classes){const e=a.fromLabelClass(s,t);i.set(s.index,e)}return i}for(const s in e.classes){const l=e.classes[s];for(const e of l){const s=a.fromLabelClass(e,t);i.set(e.index,s)}}return i},i.analyze=async function(e,t,i,l,a,n,u){if(s.isAborted(u))return;let c;"dictionary"===i?.type&&(c=await i.analyze(this._idField,e.copy(),t,a,n,u));let f=0;for(;e.next();){let t=null;if(t=c?c[f++]:null!=l&&r.isAggregateId(e.getDisplayId())&&1!==e.readAttribute("cluster_count")?l.match(this._idField,e,this._geometryType,a,n):i.match(this._idField,e,this._geometryType,a,n),e.setGroupId(t),o.isDynamicId(t)){const i=this._templateStore.getDynamicTemplateGroup(t).templates;for(const t of i)t&&t.analyze&&t.analyze(this._templateStore,e,a,n)}}return await this._loadPromise,this._templateStore.finalize(u)},i.analyzeGraphics=async function(e,t,i,l,r,a){if(s.isAborted(a))return;const n=e.getCursor();for(i&&await i.analyze(this._idField,n.copy(),t,l,r,a);n.next();){let e=n.getGroupId();if(null!=e&&-1!==e||(e=i?.match(this._idField,n,n.geometryType,l,r),n.setGroupId(e)),o.isDynamicId(e)){const t=this._templateStore.getDynamicTemplateGroup(e).templates;for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,n,l,r)}n.setGroupId(e)}return await this._loadPromise,this._templateStore.finalize(a)},i.writeGraphic=function(e,t,i,s){const l=t.getGroupId(),r=t.getDisplayId(),a=this._templateStore.getTemplateGroup(l);if(e.featureStart(t.insertAfter,0),null!=r){if(o.isDynamicId(l))for(const e of a.templates)e&&e.bindFeature(t,null,null);if(a){for(const l of a.templates)l&&l.write(e,t,i,s);e.featureEnd()}}},i.writeCursor=function(e,t,i,s,l,r,a){const n=t.getGroupId(),u=t.getDisplayId(),c=this._templateStore.getTemplateGroup(n),f=c.templates,p=this._getSortKeyValue(t,c);if(e.featureStart(0,p),null!=u&&f){if(o.isDynamicId(n))for(const e of f)e.bindFeature(t,i,s);for(const i of f)i.write(e,t,l,a);if(null!=r&&e.hasRecords){const i=r&&this._findLabelRef(f);this._writeLabels(e,t,r,i,l,a)}e.featureEnd()}},i._getSortKeyValue=function(e,t){const i=this._schema.mesh.sortKey;if(null==i)return 0;let s=0;return s=!0===i.byRenderer&&null!=t.sortKey?t.sortKey:null!=i.fieldIndex?e.getComputedNumericAtIndex(i.fieldIndex):null!=i.field?e.readAttribute(i.field):e.readAttribute(this._idField),s*="asc"===i.order?1:-1,null==s||isNaN(s)?0:s},i._findLabelRef=function(e){for(const t of e)if(t instanceof n)return t;return null},i._writeLabels=function(e,t,i,s,l,r){for(const a of i)if(null!=a&&a){const{glyphs:i,rtl:n,index:o}=a,u=this._labelTemplates.get(o);if(!u)continue;u.setZoomLevel(l),u.bindReferenceTemplate(s),u.bindTextInfo(i,n),u.write(e,t,null,r)}},t._createClass(e,[{key:"templates",get:function(){return this._templateStore}}]),e}();e.WGLMeshFactory=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
