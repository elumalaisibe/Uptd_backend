/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/screenUtils","../../../../../../geometry/GeometryCursor","../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper","../../definitions","../../enums","../../number","../../materialKey/MaterialKey","./shapingUtils"],(function(e,t,i,r,o,n,s,h,a){"use strict";const d=8,x=s.i1616to32(4,4),c=s.i1616to32(16,4),u=s.i1616to32(4,2),_=s.i1616to32(4,6),l=[u,u,_,_],g=[u,_,u,_],f=[_,_,x,x],y=[x,x,_,_],m=[_,x,_,x],p=[x,_,x,_];return x=>function(x){function u(...e){var t;return(t=x.call(this,...e)||this)._isCIM=!1,t._vertexBoundsScale=1,t.geometryType=n.WGLGeometryType.TEXT,t._aux=s.i8888to32(0,0,t._referenceSize,t._bitset),t}e._inherits(u,x);var _=u.prototype;return _.bindTextInfo=function(e,t){e&&e.length?this._shapingInfo=a.shapeGlyphs(e,t,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:o.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize}):this._shapingInfo=null},_._write=function(e,t,i,r){const o=t.getDisplayId();this._writeGeometry(e,t,o,i,r)},_._writeGeometry=function(e,t,i,r,o){const n=this._shapingInfo;if(null==n)return;if(this._textPlacement)return this._writePlacedText(e,i,n,r,t,o);const s=o?o.asOptimized():"esriGeometryPolygon"===t.geometryType?t.readCentroid():t.readGeometryForDisplay();if(null!=s){if(s.isPoint){const[t,r]=s.coords;if(!e.hasAggregates&&e.hasPixelBufferEnabled&&(t<0||t>=512||r<0||r>=512))return;return this._writeGlyphs(e,i,{x:t,y:r},n)}s.forEachVertex(((t,r)=>this._writeGlyphs(e,i,{x:t,y:r},n)))}},_._writePlacedText=function(e,o,n,s,h,a){const d=this._textPlacement,x=a||i.GeometryCursor.fromFeatureSetReaderCIM(h);if(!x)return;const c=-1,u=r.CIMMarkerPlacementHelper.getPlacement(x,c,d,t.pt2px(1),e.tileKey,s.geometryEngine);if(!u)return;const _=n.bounds,l=Math.sqrt(_.height*_.height+_.width*_.width);let g,f,y;for(;g=u.next();)if(f=g.tx,y=-g.ty,f+l>=0&&f-l<512&&y+l>=0&&y-l<512){const t=-g.getAngle();n.setRotation(t),this._writeGlyphs(e,o,{x:f,y},n),n.setRotation(-t)}},_._writeGlyphs=function(e,t,i,r){const o=h.MaterialKeyBase.load(this._materialKey),n=s.i1616to32(Math.round(d*i.x),Math.round(d*i.y)),a=this._vertexBoundsScale,{bounds:x,background:c,glyphs:u}=r;u.length>0&&(this._borderLineColor||this._backgroundColor)&&(o.textureBinding=u[0].textureBinding,e.recordStart(t,o.data,this.geometryType,!0),this._writeBackgroundGeometry(e,t,i,x,c),e.recordEnd());const _=2*Math.max(x.width,x.height);for(const s of r.glyphs)o.textureBinding=s.textureBinding,e.recordStart(t,o.data,this.geometryType,!0),e.vertexBounds(i.x+x.x+this._xOffset,i.y+x.y-this._yOffset,_*a,_*a),this._writeVertices(e,t,n,s),e.recordEnd()},_._writeGlyph=function(e,t,i,r,o){const n=h.MaterialKeyBase.load(this._materialKey),a=s.i1616to32(Math.round(d*i),Math.round(d*r));n.textureBinding=o.textureBinding,e.recordStart(t,n.data,this.geometryType,!0);const x=o.bounds,c=this._vertexBoundsScale;e.vertexBounds(i+x.x*c,r+x.y*c,x.width*c,x.height*c),this._writeVertices(e,t,a,o),e.recordEnd()},_._writeVertices=function(e,t,i,r){const o=e.vertexCount();this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperLeft),e.vertexWrite(r.texcoords.upperLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperRight),e.vertexWrite(r.texcoords.upperRight),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerLeft),e.vertexWrite(r.texcoords.lowerLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerRight),e.vertexWrite(r.texcoords.lowerRight),e.vertexEnd(),e.indexWrite(o+0),e.indexWrite(o+1),e.indexWrite(o+2),e.indexWrite(o+1),e.indexWrite(o+3),e.indexWrite(o+2)},_._writeVertexCommon=function(e,t,i,r){const o=this._color,n=this._haloColor,h=s.i8888to32(0,0,this._referenceSize,this._bitset),a=s.i8888to32(0,0,this._size,this._haloSize);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(o),e.vertexWrite(n),e.vertexWrite(a),e.vertexWrite(h),e.vertexWrite(this._minMaxZoom)},_._writeBackgroundVertex=function(e,t,i,r,o,n){const h=s.i8888to32(0,1,this._referenceSize,this._bitset),a=s.i8888to32(0,0,this._size,this._haloSize),d=s.i8888to32(0,0,0,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(r),e.vertexWrite(d),e.vertexWrite(a),e.vertexWrite(h),e.vertexWrite(this._minMaxZoom),e.vertexWrite(o),e.vertexWrite(n),e.vertexEnd()},_._writeBackgroundQuad=function(e,t,i,r,o,n){const s=e.vertexCount();this._writeBackgroundVertex(e,t,i,r,o.upperLeft,n[0]),this._writeBackgroundVertex(e,t,i,r,o.upperRight,n[1]),this._writeBackgroundVertex(e,t,i,r,o.lowerLeft,n[2]),this._writeBackgroundVertex(e,t,i,r,o.lowerRight,n[3]),e.indexWrite(s+0),e.indexWrite(s+1),e.indexWrite(s+2),e.indexWrite(s+1),e.indexWrite(s+3),e.indexWrite(s+2)},_._writeBackgroundGeometry=function(e,t,i,r,o){const n=s.i1616to32(Math.round(d*i.x),Math.round(d*i.y)),{x:h,y:a,width:x,height:u}=r,_=2*Math.max(x,u);if(e.vertexBounds(i.x+h+this._xOffset,i.y+a-this._yOffset,_*this._vertexBoundsScale,_*this._vertexBoundsScale),this._backgroundColor){const i=[c,c,c,c];this._writeBackgroundQuad(e,t,n,this._backgroundColor,o.main,i)}if(this._borderLineColor||this._backgroundColor){const i=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[r,s,h,a,d]=i?[l,l,g,g,this._borderLineColor]:[f,y,m,p,this._backgroundColor];this._writeBackgroundQuad(e,t,n,d,o.top,r),this._writeBackgroundQuad(e,t,n,d,o.bot,s),this._writeBackgroundQuad(e,t,n,d,o.left,h),this._writeBackgroundQuad(e,t,n,d,o.right,a)}},e._createClass(u)}(x)}));
