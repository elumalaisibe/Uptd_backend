/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../chunks/mat2df32","../../../../../../chunks/vec2f32","../../../../../../symbols/cim/enums","../../../../../../symbols/cim/utils","../../color","../../definitions","../../number","../../materialKey/MaterialKey","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(e,t,i,a,r,s,n,o,c,l,_,h,p,m,u,f){"use strict";const M=s.create(),y=r.create();return function(r){function s(e,t,i){var s;(s=r.call(this,e)||this)._cimMarkerLayer=e,s._minMaxZoom=_.i1616to32(Math.round(t*l.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(i*l.MIN_MAX_ZOOM_PRECISION_FACTOR));const h=e.color;if(o.isFeatureValueFn(h)){const e=(e,t,i)=>c.premultiplyAlphaRGBA(h(e,t,i));s._dynamicPropertyMap.set("_fillColor",e)}else s._fillColor=c.premultiplyAlphaRGBA(h);const p=e.outlineColor;if(o.isFeatureValueFn(p)){const e=(e,t,i)=>c.premultiplyAlphaRGBA(p(e,t,i));s._dynamicPropertyMap.set("_outlineColor",e)}else s._outlineColor=c.premultiplyAlphaRGBA(p);const m=e.size;if(o.isFeatureValueFn(m)){const e=(e,t,i)=>a.pt2px(m(e,t,i));s._dynamicPropertyMap.set("_size",e)}else s._size=a.pt2px(m)||0;const u=e.scaleX;o.isFeatureValueFn(u)?s._dynamicPropertyMap.set("_scaleX",u):s._scaleX=u;const f=e.offsetX;if(o.isFeatureValueFn(f)){const e=(e,t,i)=>a.pt2px(f(e,t,i));s._dynamicPropertyMap.set("xOffset",e)}else s.xOffset=a.pt2px(f)||0;const M=e.offsetY;if(o.isFeatureValueFn(M)){const e=(e,t,i)=>a.pt2px(M(e,t,i));s._dynamicPropertyMap.set("yOffset",e)}else s.yOffset=a.pt2px(M)||0;const y=e.outlineWidth;if(o.isFeatureValueFn(y)){const e=(e,t,i)=>a.pt2px(y(e,t,i));s._dynamicPropertyMap.set("_outlineWidth",e)}else s._outlineWidth=a.pt2px(y)||0;const d=e.rotation;if(o.isFeatureValueFn(d)?s._dynamicPropertyMap.set("_angle",d):s._angle=d||0,null!=e.effects){const t=e.effects;o.isFeatureValueFn(t)?s._dynamicPropertyMap.set("_effects",t):s._effects=t}if(null!=e.markerPlacement){const t=e.markerPlacement;o.isFeatureValueFn(t)?s._dynamicPropertyMap.set("_markerPlacement",t):s._markerPlacement=t}return s._scaleFactor=e.scaleFactor??1,s._bitSet=(e.alignment===n.Alignment.MAP?l.BITSET_MARKER_ALIGNMENT_MAP:l.BITSET_MARKER_ALIGNMENT_SCREEN)|(e.colorLocked?l.BITSET_GENERIC_LOCK_COLOR:0)|(e.scaleSymbolsProportionally?l.BITSET_MARKER_SCALE_SYMBOLS_PROPORTIONALLY:0),s._materialKey=e.materialKey,s}return e._inherits(s,r),s.fromCIMMarker=function(e,t){const[i,a]=p.getMinMaxZoom(e.scaleInfo,t);return new s(e,i,a)},s.prototype.bindFeature=function(e,r,s){const n=e.readLegacyFeature(),o=e.getObjectId();this._dynamicPropertyMap.forEach(((e,t)=>{this[t]=e(n,r,s)}));const c=this._cimMarkerLayer.materialHash,l="function"==typeof c?c(n,r,s,o):c,p=this._materialCache.get(l);if(!p||!f.ok(p.spriteMosaicItem)||!p.spriteMosaicItem)return void i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new t("mapview-cim","Encountered an error when binding feature"));const m=p.spriteMosaicItem,u=this._cimMarkerLayer.sizeRatio,d=m.width/m.height*this._scaleX,F=h.MarkerMaterialKey.load(this._materialKey);F.sdf=m.sdf,F.pattern=!0,F.textureBinding=m.textureBinding,this._materialKey=F.data;const O=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,P=this._size,g=P*d,A=this.xOffset,L=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const k=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/a.pt2px(this._cimMarkerLayer.frameHeight):1,x=this._outlineWidth*k,R=a.pt2px(this._cimMarkerLayer.referenceSize);let I=0,E=0;const C=this._cimMarkerLayer.anchorPoint;C&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(I=a.pt2px(C.x)/(this._size*d),E=a.pt2px(C.y)/this._size):(I=C.x,E=C.y)),this._anchorX=I,this._anchorY=E,this._sizeOutlineWidth=_.i8888to32(Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*P),255)),Math.round(Math.min(Math.sqrt(128*x),255)),Math.round(Math.min(Math.sqrt(128*R),255))),this.angle=O;const S=Math.round(64*u);this._bitestAndDistRatio=_.i1616to32(this._bitSet,S),this._computeSize(g,P,u,x,this._scaleFactor,m,F.hasSizeVV(),!0),this._applyTransformation(y,M),this.xOffset=A,this.yOffset=L},e._createClass(s)}(m(u))}));
