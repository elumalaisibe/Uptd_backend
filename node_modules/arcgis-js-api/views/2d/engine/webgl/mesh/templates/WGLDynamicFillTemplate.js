/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/screenUtils","../../../../../../symbols/cim/utils","../../color","../../definitions","../../GeometryUtils","../../number","../../materialKey/MaterialKey","./util","./WGLBaseFillTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(e,t,i,s,a,l,_,o,n,r,c,h){"use strict";return function(r){function c(e,o,n){var c;if((c=r.call(this,e)||this)._minMaxZoom=_.i1616to32(Math.round(o*a.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(n*a.MIN_MAX_ZOOM_PRECISION_FACTOR)),i.isFeatureValueFn(e.color)){const t=(t,i,a)=>{const l=e.color(t,i,a);return l&&s.premultiplyAlphaRGBA(l)||0};c._dynamicPropertyMap.set("fillColor",t)}else{const t=e.color;c.fillColor=t&&s.premultiplyAlphaRGBA(t)||0}const h="CIMMarkerPlacementInsidePolygon"===e.cim.placement?.type&&e.cim.placement.shiftOddRows?2:1,p=e.height;if(i.isFeatureValueFn(p)){const e=(e,t,i)=>p(e,t,i)*h;c._dynamicPropertyMap.set("_height",e)}else c._height=(p||0)*h;const u=e.offsetX;if(i.isFeatureValueFn(u)){const e=(e,i,s)=>t.pt2px(u(e,i,s));c._dynamicPropertyMap.set("_offsetX",e)}else c._offsetX=t.pt2px(u||0);const f=e.offsetY;if(i.isFeatureValueFn(f)){const e=(e,i,s)=>t.pt2px(-f(e,i,s));c._dynamicPropertyMap.set("_offsetY",e)}else c._offsetY=t.pt2px(-f||0);const O=e.scaleX;i.isFeatureValueFn(O)?c._dynamicPropertyMap.set("_scaleX",O):c._scaleX=O||1;const I=e.angle;if(i.isFeatureValueFn(I)){const e=(e,t,i)=>l.degToByte(I(e,t,i));c._dynamicPropertyMap.set("_angle",e)}else c._angle=l.degToByte(I)||0;if(null!=e.effects){const t=e.effects;i.isFeatureValueFn(t)?c._dynamicPropertyMap.set("_effects",t):c._effects=t}return c._cimFillLayer=e,c._bitset=(e.colorLocked?a.BITSET_GENERIC_LOCK_COLOR:0)|(e.applyRandomOffset?a.BITSET_FILL_RANDOM_PATTERN_OFFSET:0)|(e.sampleAlphaOnly?a.BITSET_GENERIC_CONSIDER_ALPHA_ONLY:0)|(e.hasUnresolvedReplacementColor?a.BITSET_FILL_HAS_UNRESOLVED_REPLACEMENT_COLOR:0),c._fillMaterialKey=e.materialKey,c}return e._inherits(c,r),c.fromCIMFill=function(e,t){const[i,s]=n.getMinMaxZoom(e.scaleInfo,t);return new c(e,i,s)},c.prototype.bindFeature=function(e,i,s){const l=e.readLegacyFeature();this._dynamicPropertyMap.forEach(((e,t)=>{this[t]=e(l,i,s)}));const n=o.FillMaterialKey.load(this._fillMaterialKey),r=this._materialCache,c=(0,this._cimFillLayer.materialHash)(l,i,s),p=r.get(c);let u=null;if(p&&h.ok(p.spriteMosaicItem)&&(u=p.spriteMosaicItem),u){const{rect:e,width:i,height:s}=u,l=e.x+a.SPRITE_PADDING,o=e.y+a.SPRITE_PADDING,r=l+i,c=o+s;let h=t.pt2px(this._height);h<=0&&(h=c-o),h<a.MAX_SIZE_FOR_U16_COMPRESSION&&(h*=a.COMPRESSION_FACTOR_FOR_U16,this._bitset|=a.BITSET_FILL_HAS_PATTERN_HEIGHT_PRECISION_FACTOR),h=Math.round(h);let p=t.pt2px(this._height/s*i);p<=0&&(p=r-l),p<a.MAX_SIZE_FOR_U16_COMPRESSION&&(p*=a.COMPRESSION_FACTOR_FOR_U16,this._bitset|=a.BITSET_FILL_HAS_PATTERN_WIDTH_PRECISION_FACTOR),p=Math.round(p);const f=this._scaleX,O=1;this.tl=_.i1616to32(l,o),this.br=_.i1616to32(r,c),this.aux21=_.i1616to32(p,h),this.aux22=_.i1616to32(this._offsetX,this._offsetY),this.aux3=_.i8888to32(f*a.COMPRESSION_FACTOR_FOR_U16,O*a.COMPRESSION_FACTOR_FOR_U16,this._angle,0),n.sdf=u.sdf,n.pattern=!0,n.textureBinding=u.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data},e._createClass(c)}(r(c))}));
