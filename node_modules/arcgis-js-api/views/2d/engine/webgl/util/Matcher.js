/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/arrayUtils","../../../../../core/Error","../../../../../core/Logger","../../../../../core/LRUCache","../../../../../support/arcadeOnDemand","../../../arcade/callExpressionWithFeature","../../../layers/support/cimSymbolUtils"],(function(e,t,n,r,i,a,s,l,o,u){"use strict";const c=a.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function f(e,t,n,r){switch(e.type){case"simple":case"heatmap":return p.fromBasicRenderer(e,t,n,r);case"map":return y.fromUVRenderer(e,t,n,r);case"interval":return h.fromCBRenderer(e,t,n,r);case"dictionary":return g.fromDictionaryRenderer(e,t,n,r);case"pie-chart":return m.fromPieChartRenderer(e,t,n,r);case"subtype":return m.fromSubtypes(e,t,n,r)}}let d,p=function(){function e(){this.type="feature",this._defaultResult=null}e.fromBasicRenderer=async function(t,n,r,i){const a=new e;if(t.symbol){const e=await u.expandSymbol(t.symbol,r,i),s=n.createTemplateGroup(e,null);a.setDefault(s)}return a},e.fromPieChartRenderer=async function(t,n,r,i){const a=new e;if(t.markerSymbol){const e=await u.expandSymbol(t.markerSymbol,r,i);let s;t.fillSymbol&&(s=await u.expandSymbol(t.fillSymbol,r,i));const l=n.createTemplateGroup(e,s);a.setDefault(l)}return a};var t=e.prototype;return t.size=function(){return 1},t.getDefault=function(){return this._defaultResult},t.setDefault=function(e){this._defaultResult=e},t.match=function(e,t,n,r,i){return this.getDefault()},t.analyze=async function(e,t,n,r,i,a){return null},n._createClass(e)}(),m=function(e){function t(t,n){var r;return(r=e.call(this)||this)._subMatchers=t,r._subtypeField=n,r}return n._inherits(t,e),t.fromSubtypes=async function(e,n,r,i){const a=new Map,s=[];for(const t in e.renderers){const l=parseInt(t,10),o=f(e.renderers[t],n,r,i).then((e=>a.set(l,e)));s.push(o)}return await Promise.all(s),new t(a,e.subtypeField)},t.prototype.match=function(e,t,n,r,i){const a=t.readAttribute(this._subtypeField),s=this._subMatchers.get(a);return s?s.match(e,t,n,r,i):null},n._createClass(t)}(p),h=function(e){function t(t,n,r,i){var a;return(a=e.call(this)||this).type="interval",a._intervals=[],a._isMaxInclusive=n,a._fieldIndex=i,a._field=t,a._normalizationInfo=r,a}n._inherits(t,e),t.fromCBRenderer=async function(e,n,r,i){const{isMaxInclusive:a,normalizationField:s,normalizationTotal:l,normalizationType:o}=e,c=new t(e.field,a,{normalizationField:s,normalizationTotal:l,normalizationType:o},e.fieldIndex),f=await u.expandSymbol(e.backgroundFillSymbol,r,i);await Promise.all(e.intervals.map((async e=>{const t=await u.expandSymbol(e.symbol,r,i),a=await n.createTemplateGroup(t,f),s={min:e.min,max:e.max};c.add(s,a)})));const d=await u.expandSymbol(e.defaultSymbol,r,i);if(d){const e=await n.createTemplateGroup(d,f);c.setDefault(e)}return c};var r=t.prototype;return r.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))},r.size=function(){return n._get(n._getPrototypeOf(t.prototype),"size",this).call(this)+this._intervals.length},r.match=function(e,t,n,r,i){if(null==this._fieldIndex&&!this._field)return this.getDefault();const a=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(null==a||isNaN(a)||a===1/0||a===-1/0)return this.getDefault();for(let s=0;s<this._intervals.length;s++){const{interval:e,result:t}=this._intervals[s],n=a>=e.min,r=this._isMaxInclusive?a<=e.max:a<e.max;if(n&&r)return t}return this.getDefault()},r._needsNormalization=function(){const e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},r._getValueFromField=function(e){const t=e.readAttribute(this._field);if(!this._needsNormalization()||null==t)return t;const{normalizationField:n,normalizationTotal:r,normalizationType:i}=this._normalizationInfo,a=e.readAttribute(n)??1;if(i)switch(i){case"esriNormalizeByField":return a?t/a:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/r*100;default:return void c.error(`Found unknown normalization type: ${i}`)}else c.error("Normalization is required, but no type was set!")},n._createClass(t)}(p),y=function(e){function t(t,n,r){var i;return(i=e.call(this)||this).type="map",i._nullResult=null,i._resultsMap=new Map,i._fields=[],i._fieldsIndex=r,i._fields=t,i._seperator=n||"",i}n._inherits(t,e),t.fromUVRenderer=async function(e,n,r,i){const a=e.fieldDelimiter,s=[e.field];e.field2&&s.push(e.field2),e.field3&&s.push(e.field3);const l=await u.expandSymbol(e.backgroundFillSymbol,r,i),o=new t(s,a,e.fieldIndex);await Promise.all(e.map.map((async(e,t)=>{const a=await u.expandSymbol(e.symbol,r,i),s=t+1,c=await n.createTemplateGroup(a,l,s);"<Null>"===e.value?o.setNullResult(c):o.add(e.value,c)})));const c=await u.expandSymbol(e.defaultSymbol,r,i);if(c){const e=Number.MAX_SAFE_INTEGER,t=await n.createTemplateGroup(c,l,e);o.setDefault(t)}return o};var r=t.prototype;return r.setNullResult=function(e){this._nullResult=e},r.add=function(e,t){this._resultsMap.set(e.toString(),t)},r.size=function(){return n._get(n._getPrototypeOf(t.prototype),"size",this).call(this)+this._resultsMap.size},r.match=function(e,t,n,r,i){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const a=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==a||""===a||"<Null>"===a))return this._nullResult;if(null==a)return this.getDefault();const s=a.toString();return this._resultsMap.has(s)?this._resultsMap.get(s):this.getDefault()},r._getValueFromFields=function(e){const t=[];for(const n of this._fields){const r=e.readAttribute(n);null==r||""===r?t.push("<Null>"):t.push(r)}return t.join(this._seperator)},n._createClass(t)}(p);async function _(e,t){const n=e||1;if("number"==typeof n)return(e,t,r)=>n;const r=await l.createRendererExpression(n,t.spatialReference,t.fields);return(e,n,i)=>o(r,e,{$view:i},t.geometryType,n)||1}async function b(){return d||(d=new Promise(((t,n)=>e(["../../../layers/features/createSymbolSchema"],t,n)))),d}let g=function(t){function a(e,n,r,i,a,l){var o;return(o=t.call(this)||this).type="dictionary",o._groupIdCache=new s.LRUCache(100),o._loader=e,o._fieldMap=e.fieldMap,o._symbolFields=e.getSymbolFields(),o._templates=n,o._info=r,o._scaleFn=i,o._schemaUtilsModule=a,o._symbolOptions=l,o}n._inherits(a,t),a.fromDictionaryRenderer=async function(t,n,r,i){const[{DictionaryLoader:s},l]=await Promise.all([new Promise(((t,n)=>e(["../../../../../renderers/support/DictionaryLoader"],t,n))),b()]),o=new s(t.url,t.config,t.fieldMap);await o.fetchResources({spatialReference:r.spatialReference,fields:r.fields});return new a(o,n,r,await _(t.scaleExpression,r),l,t.symbolOptions)};var l=a.prototype;return l._analyzeFeature=async function(e,t,n,r,a){const s=e.readLegacyFeature(),l=this._scaleFn(s,n,r),o=this._attributeHash(s)+"-"+l,f=this._groupIdCache.get(o);if(f)return f;const d={...r,spatialReference:this._info.spatialReference,abortOptions:a,fields:this._info.fields},p=await this._loader.getSymbolAsync(s,d),m=this._schemaUtilsModule.createSymbolSchema(p,this._symbolOptions),h=u.expandSymbol(m,this._info,t,a).then((e=>{if("expanded-cim"!==e?.type)return c.error(new i("mapview-bad-type",`Found unexpected type ${e?.type} in dictionary response`)),null;e.hash+="-"+l;for(const t of e.layers)t.scaleFactor=l,t.templateHash+="-"+l;return this._templates.createTemplateGroup(e,null)}));return this._groupIdCache.put(o,h,1),h},l.analyze=async function(e,t,n,i,a,s){const l=t.getCursor(),o=[];for(;l.next();)o.push(this._analyzeFeature(l,n,i,a,s));return Promise.all(o).then((e=>e.filter(r.isSome)))},l.match=function(e,t,n,r,i){return null},l._attributeHash=function(e){let t="";for(const n of this._symbolFields){const r=this._fieldMap?.[n];r&&(t+=e.attributes[r]+"-")}return t},n._createClass(a)}(p);t.DictionaryMatcher=g,t.FeatureMatcher=p,t.IntervalMatcher=h,t.MapMatcher=y,t.SubtypeMatcher=m,t.createMatcher=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
