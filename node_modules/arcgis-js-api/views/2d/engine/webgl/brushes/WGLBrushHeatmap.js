/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Logger","../../../../../core/maybe","../enums","../VertexStream","./WGLGeometryBrushMarker","../effects/Effect","../techniques/utils","../../../../webgl/contextUtils","../../../../webgl/enums","../../../../webgl/FramebufferObject","../../../../webgl/heatmapTextureUtils","../../../../webgl/Renderbuffer","../../../../webgl/RenderbufferDescriptor","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,i,a,n,s,u,o,c,l,f,h,d,p,m){"use strict";const _=t.getLogger("esri.views.2d.engine.webgl.brushes.WGLBrushHeatmap");function b(e){return"heatmap"===e.type}function F(e,t){const{referenceScale:r,radius:i}=e;return i*(0!==r?r/t.scale:1)}let g=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).brushEffect=new S,e}e._inherits(r,t);var a=r.prototype;return a.supportsSymbology=function(e){return e===i.WGLSymbologyType.HEATMAP},a.dispose=function(){e._get(e._getPrototypeOf(r.prototype),"dispose",this).call(this),this.brushEffect.dispose(),this.brushEffect=null},a.prepareState=function(){},a.drawGeometry=function(t,i,a,n){const{defines:s}=this.brushEffect.loadQualityProfile(t.context);e._get(e._getPrototypeOf(r.prototype),"drawGeometry",this).call(this,t,i,a,n?[...n,...s]:s)},a._drawMarkers=function(e,t,r,i,a,n,s){const{context:o,rendererInfo:l,state:f}=e,{rendererSchema:h}=l;u.assertRendererSchema(h,"heatmap");const{isFieldActive:d}=h;r.setUniform1f("u_radius",F(h,f)),s||(r.setUniform1f("u_isFieldActive",d),o.setStencilFunction(c.CompareFunction.GEQUAL,t.stencilRef,255)),o.drawElements(i,a,c.DataType.UNSIGNED_INT,n)},e._createClass(r)}(n);const w={vsPath:"heatmap/heatmapResolve",fsPath:"heatmap/heatmapResolve",attributes:new Map([["a_position",0]])},y=.25,T=1/(2*y);function B(e){return e<T?1:y}let S=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).name=e.constructor.name,e}e._inherits(i,t);var n=i.prototype;return n.createOptions=function({passOptions:e}){return e},n.dispose=function(){this._prevFBO=null,null!=this._accumulateFramebuffer&&this._accumulateFramebuffer.detachDepthStencilBuffer(),this._accumulateOutputStencilBuffer=r.disposeMaybe(this._accumulateOutputStencilBuffer),this._accumulateFramebuffer=r.disposeMaybe(this._accumulateFramebuffer),this._resolveGradientTexture=r.disposeMaybe(this._resolveGradientTexture),this._tileQuad=r.disposeMaybe(this._tileQuad)},n.bind=function(e){const{context:t,rendererInfo:r,passOptions:i,state:a}=e,{rendererSchema:n}=r;!(null!=i&&"hittest"===i.type)&&b(n)&&(this._prevFBO=t.getBoundFramebufferObject(),this._prevViewport=t.getViewport(),u.assertRendererSchema(n,"heatmap"),this._loadResources(e),this._updateResources(t,n,a),t.bindFramebuffer(this._accumulateFramebuffer),t.setViewport(0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0),t.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE),t.setClearColor(0,0,0,0),t.clear(c.ClearBufferBit.COLOR_BUFFER_BIT))},n.unbind=function(){this._prevFBO=null,this._prevViewport=null},n.draw=function(e){const{context:t,painter:r,rendererInfo:i,passOptions:a}=e,{rendererSchema:n}=i;if(null!=a&&"hittest"===a.type||!b(n))return;const{defines:s}=this.loadQualityProfile(t),u=r.materialManager.getProgram(w,s);t.useProgram(u),t.bindFramebuffer(this._prevFBO),t.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),t.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setStencilTestEnabled(!1);const{radius:o,minDensity:l,densityRange:f}=n;t.bindTexture(this._accumulateFramebuffer.colorTexture,8),t.bindTexture(this._resolveGradientTexture,9),u.setUniform1i("u_texture",8),u.setUniform1i("u_gradient",9),u.setUniform2f("u_densityMinAndInvRange",l,1/f),u.setUniform1f("u_densityNormalization",3/(o*o*Math.PI)),this._tileQuad.draw()},n._loadResources=function({context:e,painter:t}){const{dataType:r,samplingMode:i,pixelFormat:n,internalFormat:s,requiresSharedStencilBuffer:u}=this.loadQualityProfile(e),{width:o,height:f}=this._prevViewport,_=o*y,b=f*y;let F=new m.TextureDescriptor(_,b);F.pixelFormat=n,F.internalFormat=s,F.dataType=r,F.samplingMode=i,F.wrapMode=c.TextureWrapMode.CLAMP_TO_EDGE,u||(this._accumulateOutputStencilBuffer??(this._accumulateOutputStencilBuffer=new h.Renderbuffer(e,new d.RenderbufferDescriptor(c.RenderbufferFormat.DEPTH_STENCIL,_,b)))),this._accumulateFramebuffer??(this._accumulateFramebuffer=new l.FramebufferObject(e,F,u?t.getSharedStencilBuffer():this._accumulateOutputStencilBuffer)),F=new m.TextureDescriptor,F.wrapMode=c.TextureWrapMode.CLAMP_TO_EDGE,this._resolveGradientTexture??(this._resolveGradientTexture=new p.Texture(e,F)),this._tileQuad??(this._tileQuad=new a(e,[0,0,1,0,0,1,1,1]))},n._updateResources=function(e,t,r){const{gradientHash:i,gradient:a}=t;this._prevGradientHash!==i&&(this._resolveGradientTexture.resize(a.length/4,1),this._resolveGradientTexture.setData(a),this._prevGradientHash=i);const{requiresSharedStencilBuffer:n}=this.loadQualityProfile(e),s=n?1:B(F(t,r)),{width:u,height:o}=this._prevViewport,l=u*s,f=o*s,{width:h,height:d}=this._accumulateFramebuffer;if(h!==l||d!==f){const e=this._accumulateFramebuffer.depthStencilAttachment;if(n&&null!=e){const{width:t,height:r}=e.descriptor;t===l&&r===f||(_.errorOnce("Attempted to resize shared stencil buffer! Detaching instead."),this._accumulateFramebuffer.detachDepthStencilBuffer())}this._accumulateFramebuffer.resize(l,f)}n||e.blitFramebuffer(this._prevFBO,this._accumulateFramebuffer,0,0,this._prevFBO.width,this._prevFBO.height,0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height,c.ClearBufferBit.STENCIL_BUFFER_BIT,c.TextureSamplingMode.NEAREST)},n.loadQualityProfile=function(e){if(null==this._qualityProfile){const t=f.loadHeatmapTextureConfiguration(e,_),r=e.type===o.ContextType.WEBGL1;this._qualityProfile={...t,requiresSharedStencilBuffer:r,defines:t.dataType!==c.PixelType.FLOAT?["heatmapPrecisionHalfFloat"]:[]}}return this._qualityProfile},e._createClass(i)}(s.Effect);return g}));
