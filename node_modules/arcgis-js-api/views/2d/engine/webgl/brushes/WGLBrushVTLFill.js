/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a,r,l,o){"use strict";const s=1/65536;let u=function(e){function l(){var t;return(t=e.apply(this,arguments)||this)._fillProgramOptions={id:!1,pattern:!1},t._outlineProgramOptions={id:!1},t}t._inherits(l,e);var u=l.prototype;return u.dispose=function(){},u.drawMany=function(e,t){const{displayLevel:i,drawPhase:n,renderPass:l,spriteMosaic:o,styleLayerUID:s}=e;let u=!1;for(const a of t)if(a.layerData.has(s)){const e=a.layerData.get(s);if(e.fillIndexCount>0||e.outlineIndexCount>0){u=!0;break}}if(!u)return;const f=e.styleLayer,c=f.getPaintProperty("fill-pattern"),d=void 0!==c,T=d&&c.isDataDriven;let p;if(d&&!T){const e=c.getValue(i);p=o.getMosaicItemPosition(e,!0)}const _=!d&&f.getPaintValue("fill-antialias",i);let m=!0,y=1;if(!d){const e=f.getPaintProperty("fill-color"),t=f.getPaintProperty("fill-opacity");if(!e?.isDataDriven&&!t?.isDataDriven){const e=f.getPaintValue("fill-color",i);y=f.getPaintValue("fill-opacity",i)*e[3],y>=1&&(m=!1)}}if(m&&"opaque"===l)return;let E;n===a.WGLDrawPhase.HITTEST&&(E=r.u32to4Xu8(s+1));const I=f.getPaintValue("fill-translate",i),P=f.getPaintValue("fill-translate-anchor",i);(m||"translucent"!==l)&&this._drawFill(e,s,f,t,I,P,d,p,T,E);const g=!f.hasDataDrivenOutlineColor&&f.outlineUsesFillColor&&y<1;_&&"opaque"!==l&&!g&&this._drawOutline(e,s,f,t,I,P,E)},u._drawFill=function(e,t,r,l,u,f,c,d,T,p){if(c&&!T&&null==d)return;const{context:_,displayLevel:m,state:y,drawPhase:E,painter:I,pixelRatio:P,spriteMosaic:g,requestRender:v,allowDelayedRender:U}=e,M=r.fillMaterial,S=I.vectorTilesMaterialManager,D=P>n.VTL_HIGH_RES_CUTOFF?2:1,h=E===a.WGLDrawPhase.HITTEST,N=this._fillProgramOptions;N.id=h,N.pattern=c;const R=S.getMaterialProgram(_,M,N);if(U&&null!=v&&!R.compiled)return void v();if(_.useProgram(R),null!=d){const{page:e}=d,t=g.getPageSize(e);null!=t&&(g.bind(_,o.TextureSamplingMode.LINEAR,e,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),R.setUniform2fv("u_mosaicSize",t),R.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES))}R.setUniformMatrix3fv("u_displayMat3",f===i.TranslateAnchor.VIEWPORT?y.displayMat3:y.displayViewMat3),R.setUniform2fv("u_fillTranslation",u),R.setUniform1f("u_depth",r.z+s),h&&R.setUniform4fv("u_id",p);let L=-1;for(const i of l){if(!i.layerData.has(t))continue;i.key.level!==L&&(L=i.key.level,M.setDataUniforms(R,m,r,L,g));const e=i.layerData.get(t);if(!e.fillIndexCount)continue;e.prepareForRendering(_);const a=e.fillVAO;if(null!=a){if(_.bindVAO(a),R.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),_.setStencilFunction(o.CompareFunction.EQUAL,i.stencilRef,255),c){const e=Math.max(2**(Math.round(m)-i.key.level),1),t=i.rangeX/(D*i.width*e);R.setUniform1f("u_patternFactor",t)}if(T){const t=e.patternMap;if(!t)continue;for(const[e,i]of t){const t=g.getPageSize(e);null!=t&&(g.bind(_,o.TextureSamplingMode.LINEAR,e,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),R.setUniform2fv("u_mosaicSize",t),R.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES),_.drawElements(o.PrimitiveType.TRIANGLES,i[1],o.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]))}}else _.drawElements(o.PrimitiveType.TRIANGLES,e.fillIndexCount,o.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.fillIndexStart);i.triangleCount+=e.fillIndexCount/3}}},u._drawOutline=function(e,t,n,r,l,u,f){const{context:c,displayLevel:d,state:T,drawPhase:p,painter:_,pixelRatio:m,spriteMosaic:y,requestRender:E,allowDelayedRender:I}=e,P=n.outlineMaterial,g=_.vectorTilesMaterialManager,v=.75/m,U=p===a.WGLDrawPhase.HITTEST,M=this._outlineProgramOptions;M.id=U;const S=g.getMaterialProgram(c,P,M);if(I&&null!=E&&!S.compiled)return void E();c.useProgram(S),S.setUniformMatrix3fv("u_displayMat3",u===i.TranslateAnchor.VIEWPORT?T.displayMat3:T.displayViewMat3),S.setUniform2fv("u_fillTranslation",l),S.setUniform1f("u_depth",n.z+s),S.setUniform1f("u_outline_width",v),U&&S.setUniform4fv("u_id",f);let D=-1;for(const i of r){if(!i.layerData.has(t))continue;i.key.level!==D&&(D=i.key.level,P.setDataUniforms(S,d,n,D,y));const e=i.layerData.get(t);if(e.prepareForRendering(c),!e.outlineIndexCount)continue;const a=e.outlineVAO;null!=a&&(c.bindVAO(a),S.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),c.setStencilFunction(o.CompareFunction.EQUAL,i.stencilRef,255),c.drawElements(o.PrimitiveType.TRIANGLES,e.outlineIndexCount,o.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),i.triangleCount+=e.outlineIndexCount/3)}},t._createClass(l)}(l);e.WGLBrushVTLFill=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
