/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../chunks/vec4f32","../DefaultVertexAttributeLayouts","./WGLBrush","../shaders/BackgroundPrograms","../shaders/TileInfoPrograms","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/ProgramTemplate","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexArrayObject","../../../../webgl/capabilities/isWebGL2Context"],(function(e,t,r,i,n,o,s,a,l,u,c,_,f){"use strict";const g=300,d=32;let h=function(i){function h(){var e;return(e=i.apply(this,arguments)||this)._color=t.fromValues(1,0,0,1),e}e._inherits(h,i);var m=h.prototype;return m.dispose=function(){this._outlineProgram?.dispose(),this._outlineProgram=null,this._tileInfoProgram?.dispose(),this._tileInfoProgram=null,this._outlineVertexArrayObject?.dispose(),this._outlineVertexArrayObject=null,this._tileInfoVertexArrayObject?.dispose(),this._tileInfoVertexArrayObject=null,this._canvas=null},m.prepareState=function({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA,a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!1)},m.draw=function(e,t){const{context:r,requestRender:i,allowDelayedRender:n}=e;if(!t.isReady)return;if(this._loadWGLResources(r),n&&null!=i&&(!this._outlineProgram.compiled||!this._tileInfoProgram.compiled))return void i();r.bindVAO(this._outlineVertexArrayObject),r.useProgram(this._outlineProgram),this._outlineProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),this._outlineProgram.setUniform2f("u_coord_range",t.rangeX,t.rangeY),this._outlineProgram.setUniform1f("u_depth",0),this._outlineProgram.setUniform4fv("u_color",this._color),r.drawArrays(a.PrimitiveType.LINE_STRIP,0,4);const o=this._getTexture(r,t);o?(r.bindVAO(this._tileInfoVertexArrayObject),r.useProgram(this._tileInfoProgram),r.bindTexture(o,0),this._tileInfoProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),this._tileInfoProgram.setUniform1f("u_depth",0),this._tileInfoProgram.setUniform2f("u_coord_ratio",t.rangeX/t.width,t.rangeY/t.height),this._tileInfoProgram.setUniform2f("u_delta",8,8),this._tileInfoProgram.setUniform2f("u_dimensions",o.descriptor.width,o.descriptor.height),r.drawArrays(a.PrimitiveType.TRIANGLE_STRIP,0,4),r.bindVAO()):r.bindVAO()},m._loadWGLResources=function(e){if(this._outlineProgram&&this._tileInfoProgram)return;const t=l.createProgram(e,n.background),i=l.createProgram(e,o.tileInfo),u=new Int8Array([0,0,1,0,1,1,0,1]),c=s.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,u),f=new _.VertexArrayObject(e,n.background.attributes,r.Pos2b,{geometry:c}),g=new Int8Array([0,0,1,0,0,1,1,1]),d=s.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,g),h=new _.VertexArrayObject(e,o.tileInfo.attributes,r.Pos2b,{geometry:d});this._outlineProgram=t,this._tileInfoProgram=i,this._outlineVertexArrayObject=f,this._tileInfoVertexArrayObject=h},m._getTexture=function(e,t){if(t.texture&&t.triangleCountReportedInDebug===t.triangleCount)return t.texture;t.triangleCountReportedInDebug=t.triangleCount,this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","tileCanvas2d"),this._canvas.setAttribute("width",`${g}`),this._canvas.setAttribute("height",`${d}`),this._canvas.setAttribute("style","display:none"));const r=t.triangleCount;let i=t.key.id;t.triangleCount>0&&(i+=`, ${r}`);const n=this._canvas,o=n.getContext("2d");o.font="24px sans-serif",o.textAlign="left",o.textBaseline="top",o.clearRect(0,0,g,d),r>1e5?(o.fillStyle="red",o.fillRect(0,0,g,d),o.fillStyle="black"):(o.clearRect(0,0,g,d),o.fillStyle="blue"),o.fillText(i,0,0);const s=new c.TextureDescriptor;return s.wrapMode=a.TextureWrapMode.CLAMP_TO_EDGE,s.samplingMode=a.TextureSamplingMode.NEAREST,s.isImmutable=f(e.gl),t.texture=new u.Texture(e,s,n),t.texture},e._createClass(h)}(i);return h}));
