/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/mathUtils","../../../../../chunks/mat3f32","../../../../../chunks/vec4f32","../definitions","../enums","../number","./WGLBrush","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(t,e,r,o,i,a,n,s,c,l,u,_){"use strict";let f=function(t){function c(){var e;return(e=t.apply(this,arguments)||this)._color=i.fromValues(1,0,0,1),e._patternMatrix=o.create(),e._programOptions={id:!1,pattern:!1},e}e._inherits(c,t);var f=c.prototype;return f.dispose=function(){this._vao&&(this._vao.dispose(),this._vao=null)},f.drawMany=function(t,e){const{context:o,painter:i,styleLayerUID:c,requestRender:l,allowDelayedRender:_}=t;this._loadWGLResources(t);const f=t.displayLevel,d=t.styleLayer,p=d.backgroundMaterial,g=i.vectorTilesMaterialManager,h=d.getPaintValue("background-color",f),m=d.getPaintValue("background-opacity",f),T=d.getPaintValue("background-pattern",f),v=void 0!==T,y=h[3]*m,b=1|window.devicePixelRatio,x=t.spriteMosaic;let M,U;const I=b>a.VTL_HIGH_RES_CUTOFF?2:1,L=t.drawPhase===n.WGLDrawPhase.HITTEST,P=this._programOptions;P.id=L,P.pattern=v;const w=g.getMaterialProgram(o,p,P);if(!_||null==l||w.compiled){if(o.bindVAO(this._vao),o.useProgram(w),v){const t=x.getMosaicItemPosition(T,!0);if(null!=t){const{tl:e,br:r,page:i}=t;M=r[0]-e[0],U=r[1]-e[1];const n=x.getPageSize(i);null!=n&&(x.bind(o,u.TextureSamplingMode.LINEAR,i,a.VTL_TEXTURE_BINDING_UNIT_SPRITES),w.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),w.setUniform2fv("u_mosaicSize",n),w.setUniform1i("u_texture",a.VTL_TEXTURE_BINDING_UNIT_SPRITES))}w.setUniform1f("u_opacity",m)}else this._color[0]=y*h[0],this._color[1]=y*h[1],this._color[2]=y*h[2],this._color[3]=y,w.setUniform4fv("u_color",this._color);if(w.setUniform1f("u_depth",d.z||0),L){const t=s.u32to4Xu8(c+1);w.setUniform4fv("u_id",t)}for(const t of e){if(w.setUniform1f("u_coord_range",t.rangeX),w.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),v){const e=Math.max(2**(Math.round(f)-t.key.level),1),o=I*t.width*e,i=o/r.nextPowerOfTwo(M),a=o/r.nextPowerOfTwo(U);this._patternMatrix[0]=i,this._patternMatrix[4]=a,w.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}o.setStencilFunction(u.CompareFunction.EQUAL,0,255),o.drawArrays(u.PrimitiveType.TRIANGLE_STRIP,0,4)}}else l()},f._loadWGLResources=function(t){if(this._vao)return;const{context:e,styleLayer:r}=t,o=r.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),a=l.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,i),n=new _.VertexArrayObject(e,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:a});this._vao=n},e._createClass(c)}(c);t.WGLBrushVTLBackground=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
