/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","../../../../../core/RandomLCG","../definitions","../enums","./WGLGeometryBrushFill","../techniques/utils","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/FramebufferObject","../../../../webgl/Renderbuffer","../../../../webgl/RenderbufferDescriptor","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexArrayObject"],(function(e,t,r,o,s,i,n,d,a,u,l,c,_,f,h){"use strict";let T=function(i){function T(){var e;return(e=i.apply(this,arguments)||this)._dotTextureSize=0,e._dotTextures=null,e._dotSamplers=new Int32Array([o.TEXTURE_BINDING_RENDERER_0,o.TEXTURE_BINDING_RENDERER_1]),e._dotVAO=null,e._dotDesc={vsPath:"dot/dot",fsPath:"dot/dot",attributes:new Map([["a_pos",0]])},e}e._inherits(T,i);var p=T.prototype;return p.dispose=function(){e._get(e._getPrototypeOf(T.prototype),"dispose",this).call(this),this._disposeTextures(),this._dotFBO=t.disposeMaybe(this._dotFBO),this._dotVAO=t.disposeMaybe(this._dotVAO)},p.getGeometryType=function(){return s.WGLGeometryType.FILL},p.supportsSymbology=function(e){return e===s.WGLSymbologyType.DOT_DENSITY},p._drawFills=function(t,r,o,s,i,n){const{passOptions:d}=t;if(null!=d&&"hittest"===d.type)e._get(e._getPrototypeOf(T.prototype),"_drawFills",this).call(this,t,r,o,s,i,n);else{const e=this._drawDotLocations(t,r,o,i,n);this._drawDotDensity(t,r,e)}},p._drawDotDensity=function(e,t,r){const{context:o,painter:s,rendererInfo:i,requestRender:d,allowDelayedRender:u}=e,l=s.materialManager.getProgram(this._dotDesc);if(u&&null!=d&&!l.compiled)return void d();const{rendererSchema:c}=i;n.assertRendererSchema(c,"dot-density");const _=this._createDotDensityMesh(o,this._dotDesc.attributes,{geometry:[{name:"a_pos",count:2,type:a.DataType.SHORT,divisor:0,normalized:!1,offset:0,stride:4}]});o.setStencilTestEnabled(!0),o.useProgram(l),l.setUniform1f("u_tileZoomFactor",1),l.setUniform1i("u_texture",this._dotSamplers[0]),l.setUniform1f("u_dotSize",Math.max(c.dotSize,1)),l.setUniform1f("u_pixelRatio",window.devicePixelRatio),this._setSharedUniforms(l,e,t),o.bindTexture(r,this._dotSamplers[0]),o.bindVAO(_),o.drawArrays(a.PrimitiveType.POINTS,0,262144)},p._drawDotLocations=function(e,t,r,s,i){const{context:d,rendererInfo:u,requiredLevel:l}=e,c=d.getViewport(),{rendererSchema:_}=u;n.assertRendererSchema(_,"dot-density");const{dotScale:f,colors:h,activeDots:T,backgroundColor:p,dotValue:m}=_;d.setViewport(0,0,512,512);const y=d.getBoundFramebufferObject(),x=this._createFBO(d);d.bindFramebuffer(x),d.setClearColor(0,0,0,0),d.clear(d.gl.COLOR_BUFFER_BIT|d.gl.STENCIL_BUFFER_BIT),d.setStencilTestEnabled(!1);const D=1/2**(l-t.key.level),w=o.TILE_SIZE,b=w*window.devicePixelRatio*w*window.devicePixelRatio,g=1/D*(1/D),S=f?e.state.scale/f:1;return r.setUniform1f("u_tileZoomFactor",D),r.setUniform1f("u_tileDotsOverArea",b/(o.TILE_SIZE*window.devicePixelRatio*o.TILE_SIZE*window.devicePixelRatio)),r.setUniformMatrix4fv("u_dotColors",h),r.setUniform4fv("u_isActive",T),r.setUniform4fv("u_dotBackgroundColor",p),r.setUniform1f("u_dotValue",Math.max(1,m*S*g)),this._bindDotDensityTextures(d,r,u,w),d.drawElements(a.PrimitiveType.TRIANGLES,s,a.DataType.UNSIGNED_INT,i),d.setViewport(c.x,c.y,c.width,c.height),d.bindFramebuffer(y),x.colorTexture},p._createFBO=function(e){if(null==this._dotFBO){const t=512,r=512,o=new f.TextureDescriptor(t,r);o.samplingMode=a.TextureSamplingMode.NEAREST,o.wrapMode=a.TextureWrapMode.CLAMP_TO_EDGE;const s=new l.Renderbuffer(e,new c.RenderbufferDescriptor(a.RenderbufferFormat.DEPTH_STENCIL,t,r));this._dotFBO=new u.FramebufferObject(e,o,s)}return this._dotFBO},p._disposeTextures=function(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}},p._bindDotDensityTextures=function(e,t,r,o){const{rendererSchema:s}=r;n.assertRendererSchema(s,"dot-density");const i=this._createDotDensityTextures(e,o,s.seed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let n=0;n<i.length;n++)e.bindTexture(i[n],this._dotSamplers[n])},p._createDotDensityMesh=function(e,t,r){if(null==this._dotVAO){const o=2,s=new Int16Array(262144*o);for(let e=0;e<512;e++)for(let t=0;t<512;t++)s[o*(t+512*e)]=t,s[o*(t+512*e)+1]=e;const i=d.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,s);this._dotVAO=new h.VertexArrayObject(e,t,r,{geometry:i},null)}return this._dotVAO},p._createDotDensityTextures=function(e,t,o){if(this._dotTextureSize===t&&this._seed===o||(this._disposeTextures(),this._dotTextureSize=t,this._seed=o),null===this._dotTextures){const s=new r(o);this._dotTextures=[this._allocDotDensityTexture(e,t,s),this._allocDotDensityTexture(e,t,s)]}return this._dotTextures},p._allocDotDensityTexture=function(e,t,r){const o=new Float32Array(t*t*4);for(let i=0;i<o.length;i++)o[i]=r.getFloat();const s=new f.TextureDescriptor;return s.dataType=a.PixelType.FLOAT,s.samplingMode=a.TextureSamplingMode.NEAREST,s.width=t,s.height=t,new _.Texture(e,s,o)},e._createClass(T)}(i);return T}));
