/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../definitions","./WGLBrush","../materialKey/MaterialKey","../../../../webgl/enums"],(function(t,e,i,o,s){"use strict";let a=function(i){function a(){var t;return(t=i.apply(this,arguments)||this)._computeDesc=new Map,t}t._inherits(a,i);var n=a.prototype;return n.prepareState=function({context:t},e){e&&e.includes("hittest")?t.setBlendFunctionSeparate(s.BlendFactor.ONE,s.BlendFactor.ONE,s.BlendFactor.ONE,s.BlendFactor.ONE):t.setBlendFunctionSeparate(s.BlendFactor.ONE,s.BlendFactor.ONE_MINUS_SRC_ALPHA,s.BlendFactor.ONE,s.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!0)},n.draw=function(t,e,i){const a=this.getGeometryType();e.commit(t);const n=e.getGeometry(a);null!=n&&(t.timeline.begin(this.name),t.attributeView.bindTextures(t.context),t.context.setStencilFunction(s.CompareFunction.EQUAL,e.stencilRef,255),n.forEachCommand((s=>{const a=o.MaterialKeyBase.load(s.materialKey).symbologyType;this.supportsSymbology(a)&&this.drawGeometry(t,e,s,i)})))},n._setSharedUniforms=function(t,i,o){const{displayLevel:s,pixelRatio:a,state:n,passOptions:r}=i;null!=r&&"hittest"===r.type&&(t.setUniform2fv("u_hittestPos",r.position),t.setUniform1f("u_hittestDist",r.distance)),t.setUniform1f("u_pixelRatio",a),t.setUniformMatrix3fv("u_tileMat3",o.transforms.tileMat3),t.setUniformMatrix3fv("u_viewMat3",n.viewMat3),t.setUniformMatrix3fv("u_dvsMat3",o.transforms.dvs),t.setUniformMatrix3fv("u_displayViewMat3",n.displayViewMat3),t.setUniform1f("u_currentZoom",Math.round(s*e.MIN_MAX_ZOOM_PRECISION_FACTOR)),t.setUniform1i("u_attributeTextureSize",i.attributeView.size),t.setUniform1i("u_attributeData0",e.TEXTURE_BINDING_ATTRIBUTE_DATA_0),t.setUniform1i("u_attributeData1",e.TEXTURE_BINDING_ATTRIBUTE_DATA_1),t.setUniform1i("u_attributeData2",e.TEXTURE_BINDING_ATTRIBUTE_DATA_2),t.setUniform1i("u_attributeData3",e.TEXTURE_BINDING_ATTRIBUTE_DATA_3),t.setUniform1i("u_attributeData4",e.TEXTURE_BINDING_ATTRIBUTE_DATA_4),t.setUniform1i("u_attributeData5",e.TEXTURE_BINDING_ATTRIBUTE_DATA_5)},n._setSizeVVUniforms=function(t,e,i,o){if(t.vvSizeMinMaxValue&&e.setUniform4fv("u_vvSizeMinMaxValue",i.vvSizeMinMaxValue),t.vvSizeScaleStops&&e.setUniform1f("u_vvSizeScaleStopsValue",i.vvSizeScaleStopsValue),t.vvSizeFieldStops){const t=i.getSizeVVFieldStops(o.key.level);null!=t&&(e.setUniform1fv("u_vvSizeFieldStopsValues",t.values),e.setUniform1fv("u_vvSizeFieldStopsSizes",t.sizes))}t.vvSizeUnitValue&&e.setUniform1f("u_vvSizeUnitValueWorldToPixelsRatio",i.vvSizeUnitValueToPixelsRatio)},n._setColorAndOpacityVVUniforms=function(t,e,i){t.vvColor&&(e.setUniform1fv("u_vvColorValues",i.vvColorValues),e.setUniform4fv("u_vvColors",i.vvColors)),t.vvOpacity&&(e.setUniform1fv("u_vvOpacityValues",i.vvOpacityValues),e.setUniform1fv("u_vvOpacities",i.vvOpacities))},n._setRotationVVUniforms=function(t,e,i){t.vvRotation&&e.setUniform1f("u_vvRotationType","geographic"===i.vvMaterialParameters.vvRotationType?0:1)},n._getTriangleDesc=function(t,e,i=["a_pos"]){const o=e.bufferLayouts.geometry,s=i.map((t=>o.findIndex((e=>e.name===t)))),a=`${t}-${s.join("-")}`;let n=this._computeDesc.get(a);if(!n){const t=e.strides,i=e.strides.geometry,r=new Map(e.attributes),u=o.map((t=>({...t}))),l=Math.max(...e.attributes.values()),f={geometry:u};let v=0;for(const e of s){const t=o[e];f.geometry.push({count:t.count,name:t.name+"1",divisor:t.divisor,normalized:t.normalized,offset:i+t.offset,stride:i,type:t.type}),f.geometry.push({count:t.count,name:t.name+"2",divisor:t.divisor,normalized:t.normalized,offset:2*i+t.offset,stride:i,type:t.type}),r.set(t.name+"1",l+ ++v),r.set(t.name+"2",l+ ++v)}n={bufferLayouts:f,attributes:r,strides:t},this._computeDesc.set(a,n)}return n},t._createClass(a)}(i);return a}));
