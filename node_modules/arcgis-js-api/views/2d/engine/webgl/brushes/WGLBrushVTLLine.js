/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../vectorTiles/style/StyleDefinition","../definitions","../enums","../number","./WGLBrush","../../../../webgl/enums"],(function(e,t,i,n,a,r,o,s){"use strict";let l=function(e){function o(){var t;return(t=e.apply(this,arguments)||this)._programOptions={id:!1,pattern:!1,sdf:!1},t}t._inherits(o,e);var l=o.prototype;return l.dispose=function(){},l.drawMany=function(e,t){const{context:o,displayLevel:l,state:u,drawPhase:f,painter:c,pixelRatio:T,spriteMosaic:d,styleLayerUID:p,requestRender:_,allowDelayedRender:m}=e;if(!t.some((e=>e.layerData.get(p)?.lineIndexCount??!1)))return;const y=e.styleLayer,I=y.lineMaterial,E=c.vectorTilesMaterialManager,g=y.getPaintValue("line-translate",l),U=y.getPaintValue("line-translate-anchor",l),S=y.getPaintProperty("line-pattern"),v=void 0!==S,P=v&&S.isDataDriven;let N,M;if(v&&!P){const e=S.getValue(l);N=d.getMosaicItemPosition(e)}let D=!1;if(!v){const e=y.getPaintProperty("line-dasharray");if(M=void 0!==e,D=M&&e.isDataDriven,M&&!D){const t=e.getValue(l),i=y.getDashKey(t,y.getLayoutValue("line-cap",l));N=d.getMosaicItemPosition(i)}}const L=1/T,R=f===a.WGLDrawPhase.HITTEST,h=this._programOptions;h.id=R,h.pattern=v,h.sdf=M;const x=E.getMaterialProgram(o,I,h);if(m&&null!=_&&!x.compiled)return void _();if(o.useProgram(x),x.setUniformMatrix3fv("u_displayViewMat3",u.displayViewMat3),x.setUniformMatrix3fv("u_displayMat3",U===i.TranslateAnchor.VIEWPORT?u.displayMat3:u.displayViewMat3),x.setUniform2fv("u_lineTranslation",g),x.setUniform1f("u_depth",y.z),x.setUniform1f("u_antialiasing",L),R){const e=r.u32to4Xu8(p+1);x.setUniform4fv("u_id",e)}if(N&&null!=N){const{page:e}=N,t=d.getPageSize(e);null!=t&&(d.bind(o,s.TextureSamplingMode.LINEAR,e,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),x.setUniform2fv("u_mosaicSize",t),x.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES))}let V=-1;for(const i of t){if(!i.layerData.has(p))continue;i.key.level!==V&&(V=i.key.level,I.setDataUniforms(x,l,y,V,d));const e=2**(l-V)/T;x.setUniform1f("u_zoomFactor",e);const t=i.layerData.get(p);if(!t.lineIndexCount)continue;t.prepareForRendering(o);const a=t.vao;if(null!=a){if(o.bindVAO(a),x.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),o.setStencilFunction(s.CompareFunction.EQUAL,i.stencilRef,255),P||D){const e=t.patternMap;if(!e)continue;for(const[t,i]of e){const e=d.getPageSize(t);null!=e&&(d.bind(o,s.TextureSamplingMode.LINEAR,t,n.VTL_TEXTURE_BINDING_UNIT_SPRITES),x.setUniform2fv("u_mosaicSize",e),x.setUniform1i("u_texture",n.VTL_TEXTURE_BINDING_UNIT_SPRITES),o.drawElements(s.PrimitiveType.TRIANGLES,i[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]))}}else o.drawElements(s.PrimitiveType.TRIANGLES,t.lineIndexCount,s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t.lineIndexStart);i.triangleCount+=t.lineIndexCount/3}}},t._createClass(o)}(o);e.WGLBrushVTLLine=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
