/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../definitions","./CollisionGrid"],(function(e,i,t,o){"use strict";const n=254,s=255,l=0;function r(e,i){const t=[];e.forEachTile((e=>t.push(e))),t.sort(((e,i)=>e.instanceId-i.instanceId)),t.forEach((e=>{null!=e.labelMetrics&&e.isReady&&i(e,e.labelMetrics.getCursor())}))}let a=function(){function e(){}var a=e.prototype;return a.run=function(e,i,t){const o=[];for(let n=e.length-1;n>=0;n--){const i=e[n];i.labelingCollisionInfos&&o.push(...i.labelingCollisionInfos)}this._transformMetrics(o),this._runCollision(o,i,t)},a._runCollision=function(e,i,t){const[n,a]=i.state.size,d=new o.CollisionBitsetGrid(n,a,i.pixelRatio);for(const{tileRenderer:o,deconflictionEnabled:c,visible:u}of e){const e=o.featuresView.attributeView;c?u?(this._prepare(o),this._collideVisible(d,o,t),this._collideInvisible(d,o)):r(o,((i,t)=>{for(;t.nextId();)e.setLabelMinZoom(t.id,s)})):r(o,((i,t)=>{for(;t.nextId();)e.setLabelMinZoom(t.id,l),u&&d.insertMetrics(t)}))}},a._isFiltered=function(e,i,o){const n=i.getFilterFlags(e),s=!o.hasFilter||!!(n&t.FILTER_FLAG_0),l=null==o.featureEffect||o.featureEffect.excludedLabelsVisible||!!(n&t.EFFECT_FLAG_0);return!(s&&l)},a._prepare=function(e){const i=e.featuresView.attributeView,t=new Set;r(e,((o,r)=>{for(;r.nextId();){if(t.has(r.id))continue;if(t.add(r.id),this._isFiltered(r.id,i,e.layerView)){i.setLabelMinZoom(r.id,n);continue}i.getLabelMinZoom(r.id)!==l?i.setLabelMinZoom(r.id,s):i.setLabelMinZoom(r.id,l)}}))},a._collideVisible=function(e,i,t){const s=i.featuresView.attributeView,a=new Set;r(i,((i,r)=>{for(;r.nextId();)if(!a.has(r.id))if(i.key.level===t){if(0===s.getLabelMinZoom(r.id)){switch(e.insertMetrics(r)){case o.OUTSIDE_EXTENT:break;case o.HAS_COLLISION:s.setLabelMinZoom(r.id,n),a.add(r.id);break;case o.NONE:s.setLabelMinZoom(r.id,l),a.add(r.id)}}}else s.setLabelMinZoom(r.id,n)}))},a._collideInvisible=function(e,i){const t=i.featuresView.attributeView,n=new Set;r(i,((i,r)=>{for(;r.nextId();)if(!n.has(r.id)&&t.getLabelMinZoom(r.id)===s){switch(e.insertMetrics(r)){case o.OUTSIDE_EXTENT:break;case o.HAS_COLLISION:t.setLabelMinZoom(r.id,s),n.add(r.id);break;case o.NONE:t.setLabelMinZoom(r.id,l),n.add(r.id)}}}))},a._transformMetrics=function(e){for(const{tileRenderer:i,geometryType:t,vvEvaluators:o}of e)r(i,((e,n)=>{const s=i.featuresView.attributeView,l=e.transforms.labelMat2d;l[4]=Math.round(l[4]),l[5]=Math.round(l[5]);const r="polyline"===t;for(;n.next();){const e=n.boundsCount,i=n.anchorX,t=n.anchorY;let a=n.size;const d=o[0];if(null!=d){const e=d(s.getVVSize(n.id));a=isNaN(e)||null==e||e===1/0?a:e}const c=n.directionX*(a/2),u=n.directionY*(a/2);for(let o=0;o<e;o++){let e=i,s=n.anchorY;if(r){let i=e+n.boundsX(o)+c,t=s+n.boundsY(o)+u;i=l[0]*i+l[2]*t+l[4],t=l[1]*i+l[3]*t+l[5],n.setBoundsComputedAnchorX(o,Math.floor(i)),n.setBoundsComputedAnchorY(o,Math.floor(t))}else{e=l[0]*i+l[2]*t+l[4],s=l[1]*i+l[3]*t+l[5];const r=e+n.boundsX(o)+c,a=s+n.boundsY(o)+u;n.setBoundsComputedAnchorX(o,r),n.setBoundsComputedAnchorY(o,a)}}}}))},i._createClass(e)}();e.CollisionEngine=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
