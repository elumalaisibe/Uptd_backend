/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/events","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/perspectiveUtils","../../../../core/reactiveUtils","../../../../chunks/mat3f64","../../../../chunks/vec2","../../../../chunks/vec2f64","../DisplayObject","../../../webgl/BufferObject","../../../webgl/contextUtils","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor","../../../webgl/VertexArrayObject"],(function(e,t,r,n,i,s,o,a,c,l,u,h,p,d,f,w,m,g){"use strict";const y=c.create();return function(c){function h(e){var i;return(i=c.call(this)||this).elementView=e,i.isWrapAround=!1,i.perspectiveTransform=u.create(),i._vertices=new Float32Array(20),i._handles=[],i._handles.push(a.watch((()=>i.elementView.element.opacity),(e=>i.opacity=e),a.initial),a.watch((()=>[i.elementView.coords]),(()=>{i.requestRender()}),a.initial),a.when((()=>i.elementView.element.loaded),(()=>{const e=i.elementView.element;i.ready(),"video"===e.type&&null!=e.content&&i._handles.push(r.on(e.content,"play",(()=>i.requestRender())))}),a.initial)),e.element.load().catch((r=>{n.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new t("element-load-error","Element cannot be displayed",{element:e,error:r}))})),i}e._inherits(h,c);var v=h.prototype;return v.destroy=function(){this._handles.forEach((e=>e.remove())),this.texture=s.disposeMaybe(this.texture)},v.beforeRender=function(t){const{context:r}=t,n=this.elementView.element.content;if(null!=n){const e=n instanceof HTMLImageElement,t=n instanceof HTMLVideoElement,s=e?n.naturalWidth:t?n.videoWidth:n.width,o=e?n.naturalHeight:t?n.videoHeight:n.height;if(this._updatePerspectiveTransform(s,o),this.texture)t&&!n.paused&&(this.texture.setData(n),this.requestRender(),(r.type===d.ContextType.WEBGL2||i.isPowerOfTwo(s)&&i.isPowerOfTwo(o))&&this.texture.generateMipmap());else{const e=new m.TextureDescriptor;e.wrapMode=f.TextureWrapMode.CLAMP_TO_EDGE,e.preMultiplyAlpha=!0,e.width=s,e.height=o,this.texture=new w.Texture(r,e,n),(r.type===d.ContextType.WEBGL2||i.isPowerOfTwo(s)&&i.isPowerOfTwo(o))&&this.texture.generateMipmap(),t&&!n.paused&&this.requestRender()}}e._get(e._getPrototypeOf(h.prototype),"beforeRender",this).call(this,t)},v._createTransforms=function(){return null},v.updateDrawCoords=function(e,t){const r=this.elementView.coords;if(null==r)return;const[n,i,s,o]=r.rings[0],a=this._vertices,{x:c,y:l}=e,u=0!==t;u?a.set([i[0]-c,i[1]-l,n[0]-c,n[1]-l,s[0]-c,s[1]-l,o[0]-c,o[1]-l,o[0]-c,o[1]-l,i[0]+t-c,i[1]-l,i[0]+t-c,i[1]-l,n[0]+t-c,n[1]-l,s[0]+t-c,s[1]-l,o[0]+t-c,o[1]-l]):a.set([i[0]-c,i[1]-l,n[0]-c,n[1]-l,s[0]-c,s[1]-l,o[0]-c,o[1]-l]),this.isWrapAround=u},v.getVAO=function(e,t,r){if(null==this.elementView.coords)return null;const n=this._vertices;if(this._vao)this._geometryVbo.setData(n);else{this._geometryVbo=p.BufferObject.createVertex(e,f.Usage.DYNAMIC_DRAW,n);const i=p.BufferObject.createVertex(e,f.Usage.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new g.VertexArrayObject(e,r,t,{geometry:this._geometryVbo,tex:i})}return this._vao},v._updatePerspectiveTransform=function(e,t){const r=this._vertices;o.getProjectiveTransform(y,[0,0,e,0,0,t,e,t],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),l.set(this.perspectiveTransform,y[6]/y[8]*e,y[7]/y[8]*t)},e._createClass(h,[{key:"dvsMat3",get:function(){return this.parent.dvsMat3}}]),h}(h.DisplayObject)}));
