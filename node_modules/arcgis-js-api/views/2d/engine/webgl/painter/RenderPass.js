/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/arrayUtils","../enums","../../../../webgl/enums"],(function(e,t,r,s){"use strict";return function(){function n(e,t){this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||r.WGLDrawPhase.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=t.enableDefaultDraw??(()=>!0),this.forceDrawByDisplayOrder=!!t.forceDrawByDisplayOrder}var o=n.prototype;return o.render=function(e){const{context:t,profiler:r}=e,s=this._targetFn(),n=this.drawPhase&e.drawPhase;if(r.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,s),r.recordPassEnd();for(const r of this.effects){if(!r.enable())continue;const n=r.apply,o=r.args&&r.args(),i=t.getViewport(),a=t.getBoundFramebufferObject(),f=e.passOptions;this._bindEffect(e,n,o),this._doRender(e,s,n.defines),this._drawAndUnbindEffect(e,n,i,a,f,o)}}},o._doRender=function(e,t,n){if(null==t)return;const{profiler:o,context:i}=e;if(this.forceDrawByDisplayOrder){for(const r of this.brushes){if(o.recordBrushStart(r.name),null!=r.brushEffect){const s=i.getViewport(),o=i.getBoundFramebufferObject(),a=e.passOptions;this._bindEffect(e,r.brushEffect),this._drawWithBrush(r,e,t,n),this._drawAndUnbindEffect(e,r.brushEffect,s,o,a)}else this._drawWithBrush(r,e,t,n);o.recordBrushEnd()}const a=t,f=e;f.attributeView.bindTextures(e.context);for(const e of a){if(!e.visible)continue;e.commit(f),f.context.setStencilFunction(s.CompareFunction.EQUAL,e.stencilRef,255);const t=e.getGeometry(r.WGLGeometryType.MARKER),o=e.getGeometry(r.WGLGeometryType.TEXT);if(null!=t&&t.records&&null!=o&&o.records){const s=new Map,i=t.records.getCursor();for(;i.next();)s.set(i.id,[i.getDrawInfo(t,r.WGLGeometryType.MARKER)]);const a=o.records.getCursor();for(;a.next();){const e=s.get(a.id),t=a.getDrawInfo(o,r.WGLGeometryType.TEXT);e?e.push(t):s.set(a.id,[t])}const c=Array.from(s.entries()).sort((([e,t],[r,s])=>r-e));for(const[t,o]of c)for(const s of o){const t=f.painter.getBrush(s.geometryType,r.WGLSymbologyType.DEFAULT);t.prepareState(f,n),t.drawGeometry(f,e,s,n)}}else if(t){const s=f.painter.getBrush(r.WGLGeometryType.MARKER,r.WGLSymbologyType.DEFAULT);s.prepareState(f,n),t.forEachCommand((t=>{s.drawGeometry(f,e,t,n)}))}else if(o){const t=f.painter.getBrush(r.WGLGeometryType.TEXT,r.WGLSymbologyType.DEFAULT);t.prepareState(f,n),o.forEachCommand((r=>{t.drawGeometry(f,e,r,n)}))}}}else for(const r of this.brushes){if(o.recordBrushStart(r.name),null!=r.brushEffect){const s=i.getViewport(),o=i.getBoundFramebufferObject(),a=e.passOptions;this._bindEffect(e,r.brushEffect),this._drawWithBrush(r,e,t,n),this._drawAndUnbindEffect(e,r.brushEffect,s,o,a)}else this._drawWithBrush(r,e,t,n);o.recordBrushEnd()}},o._drawWithBrush=function(e,r,s,n){t.isArrayLike(s)?(e.prepareState(r,n),e.drawMany(r,s,n)):s.visible&&(e.prepareState(r,n),e.draw(r,s,n))},o._bindEffect=function(e,t,r){const{profiler:s}=e;s.recordPassStart(this.name+"."+t.name),t.bind(e,r);const n=t.createOptions(e,r);e.passOptions=n},o._drawAndUnbindEffect=function(e,t,r,s,n,o){const{profiler:i,context:a}=e;e.passOptions=n,i.recordBrushStart(t.name),t.draw(e,o),t.unbind(e,o),a.bindFramebuffer(s);const{x:f,y:c,width:d,height:h}=r;a.setViewport(f,c,d,h),i.recordBrushEnd(),i.recordPassEnd()},e._createClass(n)}()}));
