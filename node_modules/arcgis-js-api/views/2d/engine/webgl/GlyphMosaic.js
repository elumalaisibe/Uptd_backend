/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../core/promiseUtils","./Rect","./RectangleBinPack","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(t,e,i,h,s,n,r,a){"use strict";const c=256,o=t=>Math.floor(t/256);function l(t){const e=new Set;for(const i of t)e.add(o(i));return e}function u(t,e,h){return t.has(e)||t.set(e,h().then((()=>{t.delete(e)})).catch((h=>{t.delete(e),i.throwIfNotAbortError(h)}))),t.get(e)}const g=t=>({rect:new h(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:t,sdf:!0});return function(){function i(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=t,this.height=e,this._glyphSource=i,this._binPack=new s(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}var o=i.prototype;return o.dispose=function(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0},o._initDecorationGlyphs=function(){const t=[117,149,181,207,207,181,149,117],e=[],i=[];for(let n=0;n<t.length;n++){const h=t[n];for(let t=0;t<11;t++){const s=n>=3&&n<5&&t>=3&&t<8?255:0;e.push(h),i.push(s)}}const h={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)},s={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)};this._recordGlyph(h),this._recordGlyph(s)},o.getGlyphItems=async function(t,e,i){const h=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map((e=>this._getMosaicItem(h,t,e)))},o.bind=function(t,e,i,h){const s=this._getTexture(t,i);s.setSamplingMode(e),this._dirties[i]&&(s.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(s,h)},o.preloadASCIIGlyphCache=function(t){const e=this._preloadCache[t];if(null!=e)return e;const i=this._glyphSource.preloadASCIIRange(t).then((()=>{const e=this._getGlyphCache(t);for(let i=0;i<256;i++)this._getMosaicItem(e,t,i)}));return this._preloadCache[t]=i,i},o._getGlyphCache=function(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]},o._getTexture=function(t,e){if(!this._textures[e]){const i=new a.TextureDescriptor;i.pixelFormat=n.PixelFormat.ALPHA,i.wrapMode=n.TextureWrapMode.CLAMP_TO_EDGE,i.width=this.width,i.height=this.height,this._textures[e]=new r.Texture(t,i,new Uint8Array(this.width*this.height))}return this._textures[e]},o._invalidate=function(){this._dirties[this._currentPage]=!0},o._fetchRanges=async function(t,e,i){const h=l(e),s=[];h.forEach((e=>{s.push(this._fetchRange(t,e,i))})),await Promise.all(s)},o._fetchRange=async function(t,e,i){if(e>c)return;const h=t+e;return u(this._rangePromises,h,(()=>this._glyphSource.getRange(t,e,i)))},o._getMosaicItem=function(t,e,i){if(!t[i]){const h=this._glyphSource.getGlyph(e,i);if(!h||!h.metrics)return g(i);const s=this._recordGlyph(h),n=this._currentPage,r=h.metrics;t[i]={rect:s,page:n,metrics:r,code:i,sdf:!0},this._invalidate()}return t[i]},o._recordGlyph=function(t){const i=t.metrics;let n;if(0===i.width)n=new h(0,0,0,0);else{const h=3,r=i.width+2*h,a=i.height+2*h;n=this._binPack.allocate(r,a),n.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new s(this.width-4,this.height-4),n=this._binPack.allocate(r,a));const c=this._glyphData[this._currentPage],o=t.bitmap;let l,u;if(o)for(let t=0;t<a;t++){l=r*t,u=this.width*(n.y+t)+n.x;for(let t=0;t<r;t++)c[u+t]=o[l+t]}e("esri-glyph-debug")&&this._showDebugPage(c)}return n},o._showDebugPage=function(t){const e=document.createElement("canvas"),i=e.getContext("2d"),h=new ImageData(this.width,this.height),s=h.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let n=0;n<t.length;++n)s[4*n]=t[n],s[4*n+1]=0,s[4*n+2]=0,s[4*n+3]=255;i.putImageData(h,0,0),document.body.appendChild(e)},t._createClass(i)}()}));
