/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/Error","../../../../core/has","./definitions","./GeometryUtils","./Rect","./RectangleBinPack","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(t,e,i,s,a,o,r,n,h,c){"use strict";function g(t){return t&&"static"===t.type}let u=function(){function n(t,e,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new r(this._pageWidth,this._pageHeight);const s=Math.floor(this._pageWidth),a=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*a)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}var h=n.prototype;return h.getWidth=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]},h.getHeight=function(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]},h.getPageTexture=function(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null},h.has=function(t){return this._mosaicRects.has(t)},h.getSpriteItem=function(t){return this._mosaicRects.get(t)},h.addSpriteItem=function(t,e,a,r,n,h,c=1){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let u,p,d;if(g(a))[u,p,d]=this._allocateImage(e[0],e[1]);else{u=new o(0,0,e[0],e[1]),p=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:a,size:[e[0]+2*s.SPRITE_PADDING,e[1]+2*s.SPRITE_PADDING],dirty:!0,texture:t})}if(u.width<=0||u.height<=0)return null;const m={rect:u,width:e[0],height:e[1],sdf:n,simplePattern:h,pixelRatio:c,page:p};return this._mosaicRects.set(t,m),g(a)&&(i("esri-mosaic-debug")&&this._showDebugSprite(e,a.data),this._copy({rect:u,spriteSize:e,spriteData:a.data,page:p,pageSize:d,repeat:r,sdf:n})),m},h.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length},h.processNextItem=function(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)},h.getSpriteItems=function(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e},h.getMosaicItemPosition=function(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const a=e.width,o=e.height,r=s.SPRITE_PADDING,n=this._mosaicPages[e.page].size;return{size:[e.width,e.height],tl:[(i.x+r)/n[0],(i.y+r)/n[1]],br:[(i.x+r+a)/n[0],(i.y+r+o)/n[1]],page:e.page}},h.bind=function(t,e,s=0,a=0){const o=this._mosaicPages[s],r=o.mosaicsData;let n=o.texture;if(n||(n=d(t,o.size),o.texture=n),n.setSamplingMode(e),g(r))t.bindTexture(n,a),o.dirty&&(n.setData(new Uint8Array(r.data.buffer)),n.generateMipmap(),i("esri-mosaic-debug")&&this._showDebugPage(s));else{r.data.bindFrame(t,n,a),n.generateMipmap()}o.dirty=!1},h.dispose=function(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;if(!g(i)){i.data.destroy()}}this._mosaicPages=null,this._mosaicRects.clear()},n._copyBits=function(t,e,i,s,a,o,r,n,h,c,g){let u=s*e+i,p=n*o+r;if(g){p-=o;for(let r=-1;r<=c;r++,u=((r+c)%c+s)*e+i,p+=o)for(let e=-1;e<=h;e++)a[p+e]=t[u+(e+h)%h]}else for(let d=0;d<c;d++){for(let e=0;e<h;e++)a[p+e]=t[u+e];u+=e,p+=o}},h._copy=function(t){if(t.page>=this._mosaicPages.length)return;const i=this._mosaicPages[t.page],a=i.mosaicsData;if(!g(i.mosaicsData))throw new e("mapview-invalid-resource","unsuitable data type!");const o=t.spriteData,r=a.data;r&&o||console.error("Source or target images are uninitialized!"),n._copyBits(o,t.spriteSize[0],0,0,r,t.pageSize[0],t.rect.x+s.SPRITE_PADDING,t.rect.y+s.SPRITE_PADDING,t.spriteSize[0],t.spriteSize[1],t.repeat),i.dirty=!0},h._allocateImage=function(t,e){t+=2*s.SPRITE_PADDING,e+=2*s.SPRITE_PADDING;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil(a.log2(t)),s=2**Math.ceil(a.log2(e)),r=new o(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[r,this._mosaicPages.length-1,[i,s]]}const n=this._binPack.allocate(t,e);if(n.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&g(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new r(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[n,this._currentPage,[this._pageWidth,this._pageHeight]]},h._showDebugSprite=function([t,e],i){const s=document.createElement("canvas");s.width=t,s.height=e,s.setAttribute("style",`position: absolute; top: ${4+204*p++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const a=s.getContext("2d"),o=new ImageData(t,e);o.data.set(new Uint8Array(i.buffer)),a.putImageData(o,0,0),document.body.appendChild(s)},h._showDebugPage=function(t){const e=this._mosaicPages[t],{size:[i,s],mosaicsData:a}=e;if(!g(a))return void console.error("Could not show sprite mosaic debug for non-static resource");const o=`mosaicDebugPage${t}`,r=document.getElementById(o)??document.createElement("canvas");r.id=o,r.width=i,r.height=s,r.setAttribute("style",`position: absolute; top: ${4+204*t}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const n=r.getContext("2d"),h=new ImageData(i,s);h.data.set(new Uint8Array(a.data.buffer)),n.putImageData(h,0,0),document.body.appendChild(r)},t._createClass(n,[{key:"itemCount",get:function(){return this._mosaicRects.size}}]),n}(),p=0;function d(t,e){const i=new c.TextureDescriptor;return i.width=e[0],i.height=e[1],i.wrapMode=n.TextureWrapMode.CLAMP_TO_EDGE,new h.Texture(t,i,null)}return u}));
