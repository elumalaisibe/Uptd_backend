/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/events","../../../core/has","../../../core/maybe","../../../core/scheduling","../../../chunks/mat3f32","../../../symbols/cim/CIMResourceManager","./Container","./webgl/BufferPool","./webgl/enums","./webgl/Painter","./webgl/Profiler","../support/Timeline","../../support/screenshotUtils","../../webgl/contextUtils","../../webgl/enums","../../webgl/FramebufferObject","../../webgl/RenderbufferDescriptor","../../webgl/RenderingContext","../../webgl/TextureDescriptor","../../webgl/capabilities/isWebGL2Context","../../../core/imageUtils"],(function(e,t,r,n,i,s,a,o,d,h,l,c,u,p,f,m,_,b,g,w,y,R,P,x){"use strict";const T=2e3;let C=function(e){function C(s,o){var h;(h=e.call(this)||this)._trash=new Set,h._renderRemainingTime=0,h._lastFrameRenderTime=0,h.renderRequested=!1,h.stage=t._assertThisInitialized(h),h._stationary=!0;const{canvas:c=document.createElement("canvas"),alpha:m=!0,stencil:b=!0,contextOptions:g={}}=o;h._canvas=c;const w={alpha:m,antialias:!1,depth:!0,stencil:b},R=_.createContextForView("2d",c,w);h.context=new y.RenderingContext(R??null,g),h.resourceManager=new d,h.painter=new u(h.context,t._assertThisInitialized(h),h.resourceManager),i("esri-2d-profiler")&&(h._debugOutput=document.createElement("div"),h._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),s.appendChild(h._debugOutput));const P=()=>h._highlightGradient;return h._renderParameters={drawPhase:0,state:h.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:h.context,painter:h.painter,timeline:o.timeline||new f.Timeline,renderingOptions:o.renderingOptions,requestRender:()=>h.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new p.Profiler(h.context,h._debugOutput),dataUploadCounter:0,get highlightGradient(){return P()}},h._taskHandle=a.addFrameTask({render:e=>h.renderFrame(e)}),h._taskHandle.pause(),h._lostWebGLContextHandle=n.on(c,"webglcontextlost",(e=>{h.emit("webgl-error",{error:new r("webgl-context-lost",e.statusMessage)})})),h._bufferPool=new l.BufferPool,c.setAttribute("style","width: 100%; height:100%; display:block;"),s.appendChild(c),h}t._inherits(C,e);var L=C.prototype;return L.destroy=function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle=s.removeMaybe(this._taskHandle),this._lostWebGLContextHandle=s.removeMaybe(this._lostWebGLContextHandle),this._canvas.parentNode?.removeChild(this._canvas),this._debugOutput?.parentNode?.removeChild(this._debugOutput),this._bufferPool.destroy(),this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null},L.trashDisplayObject=function(e){this._trash.add(e),this.requestRender()},L.untrashDisplayObject=function(e){return this._trash.delete(e)},L.requestRender=function(){this._renderRemainingTime=T,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())},L.renderFrame=function(e){const t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")},L._createTransforms=function(){return{dvs:o.create()}},L.renderChildren=function(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)},L._renderChildren=function(e,t){const r=this.context;this.painter.textureUploadManager.upload(),r.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=c.WGLDrawPhase.MAP,this.painter.beforeRenderLayers(r,this.backgroundColor);for(const n of e)n.processRender(t);this.painter.prepareDisplay(t,this.backgroundColor,this.state.padding),this.painter.renderLayers(r),t.drawPhase=c.WGLDrawPhase.HIGHLIGHT,this.painter.beforeRenderLayers(r);for(const n of e)n.processRender(t);this.painter.renderLayers(r);if(this._isLabelDrawPhaseRequired(e)){t.drawPhase=c.WGLDrawPhase.LABEL,this.painter.beforeRenderLayers(r);for(const r of e)r.processRender(t);this.painter.renderLayers(r)}if(i("esri-tiles-debug")){t.drawPhase=c.WGLDrawPhase.DEBUG,this.painter.beforeRenderLayers(r);for(const r of e)r.processRender(t);this.painter.renderLayers(r)}t.profiler.recordEnd("drawLayers"),r.logInfo()},L.doRender=function(e){const r=this.context,{state:n,pixelRatio:i}=e;this._resizeCanvas(e),r.setViewport(0,0,i*n.size[0],i*n.size[1]),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),t._get(t._getPrototypeOf(C.prototype),"doRender",this).call(this,e)},L.takeScreenshot=async function(e){const t=Math.round(this.state.size[0]*e.resolutionScale),r=Math.round(this.state.size[1]*e.resolutionScale),n=e.resolutionScale,i=this.context,s=this._state.clone();if(null!=e.rotation){const t=s.viewpoint;s.viewpoint.rotation=e.rotation,s.viewpoint=t}const a={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:s,pixelRatio:n,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1},o=P(i.gl),d=new R.TextureDescriptor(t,r);d.wrapMode=b.TextureWrapMode.CLAMP_TO_EDGE,d.internalFormat=o?b.SizedPixelFormat.RGBA8:b.PixelFormat.RGBA,d.isImmutable=o;const h=new g.FramebufferObject(i,d,new w.RenderbufferDescriptor(b.RenderbufferFormat.DEPTH_STENCIL,t,r)),l=i.getBoundFramebufferObject(),c=i.getViewport();i.bindFramebuffer(h),i.setViewport(0,0,t,r),this._renderChildren(e.children,a);const u=this._readbackScreenshot(h,{...e.cropArea,y:r-(e.cropArea.y+e.cropArea.height)});i.bindFramebuffer(l),i.setViewport(c.x,c.y,c.width,c.height),this.requestRender();const p=await u;let f;return 1===e.outputScale?f=p:(f=new ImageData(Math.round(p.width*e.outputScale),Math.round(p.height*e.outputScale)),m.resampleHermite(p,f,!0)),h.dispose(),f},L._readbackScreenshot=async function(e,t){const r=x.createEmptyImageData(t.width,t.height,document.createElement("canvas"));return await e.readPixelsAsync(t.x,t.y,t.width,t.height,b.PixelFormat.RGBA,b.PixelType.UNSIGNED_BYTE,new Uint8Array(r.data.buffer)),r},L._resizeCanvas=function(e){const t=this._canvas,r=t.style,{state:{size:n},pixelRatio:i}=e,s=n[0],a=n[1],o=Math.round(s*i),d=Math.round(a*i);t.width===o&&t.height===d||(t.width=o,t.height=d),r.width=s+"px",r.height=a+"px"},L._emptyTrash=function(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}},L._isLabelDrawPhaseRequired=function(e){let t=!1;for(const r of e){if(!(r instanceof h.Container)){t=t||!1;break}if("hasLabels"in r&&r.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(r.children)}return t},t._createClass(C,[{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}}]),C}(h.Container);e.EXTRA_RENDER_TIME=T,e.Stage=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
