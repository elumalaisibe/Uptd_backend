/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/promiseUtils","../utils","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexArrayObject","../../../../webgl/VertexElementDescriptor"],(function(t,e,a,r,i,s,o,n,l,c){"use strict";let m=function(){function t(t){this._params=t,this.animated=!1}var i=t.prototype;return i.isCompatible=function(e){if(!(e instanceof t))return!1;if(!r.timeExtentsEqual(this._params.timeExtent,e._params.timeExtent))return!1;let a=!0;return a=a&&this._params.loadImagery===e._params.loadImagery,a=a&&this._params.color.kind===e._params.color.kind,a=a&&this._params.opacity.kind===e._params.opacity.kind,a},i.load=async function(t,e){const{extent:r,size:i}=t;a.throwIfAborted(e);const s=await this._params.loadImagery(r,i[0],i[1],this._params.timeExtent,e);return new h(s,{color:this._params.color,opacity:this._params.opacity})},i.render=function(t,e,a){const{context:i}=t,{program:o}=a;i.setFaceCullingEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunction(s.BlendFactor.ONE,s.BlendFactor.ONE_MINUS_SRC_ALPHA),i.useProgram(o),o.setUniformMatrix3fv("u_dvsMat3",e.dvsMat3),i.bindTexture(a.texture,0),o.setUniform1i("u_texture",0),o.setUniform1f("u_Min",a.min),o.setUniform1f("u_Max",a.max),r.setUniforms(o,"color","vec4",this._params.color),r.setUniforms(o,"opacity","float",this._params.opacity),i.bindVAO(a.vertexArray),i.drawArrays(s.PrimitiveType.TRIANGLE_STRIP,0,4)},e._createClass(t)}();const p=new Map;p.set("a_position",0),p.set("a_texcoord",1);const u={geometry:[new c.VertexElementDescriptor("a_position",2,s.DataType.UNSIGNED_SHORT,0,8),new c.VertexElementDescriptor("a_texcoord",2,s.DataType.UNSIGNED_SHORT,4,8)]},f={vsPath:"raster/flow/imagery",fsPath:"raster/flow/imagery",attributes:p};let h=function(){function t(t,e){this._flowData=t,this._values=e}var a=t.prototype;return a.attach=function(t){const{context:e}=t,{width:a,height:r}=this._flowData,c={geometry:i.BufferObject.createVertex(e,s.Usage.STATIC_DRAW,new Uint16Array([0,0,0,1,a,0,1,1,0,r,0,0,a,r,1,0]))},m=new l.VertexArrayObject(e,p,u,c),h=[];"ramp"===this._values.color.kind&&h.push("vvColor"),"ramp"===this._values.opacity.kind&&h.push("vvOpacity");const _=t.painter.materialManager.getProgram(f,h);let d=1e6,x=-1e6;for(let i=0;i<r;i++)for(let t=0;t<a;t++)if(0!==this._flowData.mask[i*a+t]){const e=this._flowData.data[2*(i*a+t)],r=this._flowData.data[2*(i*a+t)+1],s=Math.sqrt(e*e+r*r);d=Math.min(d,s),x=Math.max(x,s)}const y=new Uint8Array(4*a*r);for(let i=0;i<r;i++)for(let t=0;t<a;t++)if(0!==this._flowData.mask[i*a+t]){const e=this._flowData.data[2*(i*a+t)],r=this._flowData.data[2*(i*a+t)+1],s=(Math.sqrt(e*e+r*r)-d)/(x-d);y[4*(i*a+t)]=255*s,y[4*(i*a+t)+1]=0,y[4*(i*a+t)+2]=0,y[4*(i*a+t)+3]=255}else y[4*(i*a+t)]=0,y[4*(i*a+t)+1]=0,y[4*(i*a+t)+2]=0,y[4*(i*a+t)+3]=0;const w=new n.TextureDescriptor;w.internalFormat=s.PixelFormat.RGBA,w.wrapMode=s.TextureWrapMode.CLAMP_TO_EDGE,w.flipped=!0,w.width=a,w.height=r;const g=new o.Texture(e,w,y);this.vertexArray=m,this.program=_,this.texture=g,this.min=d,this.max=x,this._flowData=null},a.detach=function(){this.vertexArray.dispose(),this.texture.dispose()},e._createClass(t,[{key:"ready",get:function(){return this.program.compiled}}]),t}();t.Imagery=m,t.ImageryResources=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
