/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/promiseUtils","../utils","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject","../../../../webgl/VertexElementDescriptor"],(function(e,t,a,r,s,i,n){"use strict";let o=function(){function r(e){this._params=e}var i=r.prototype;return i.isCompatible=function(e){return e instanceof r&&a.areStreamlinesCompatible(this._params,e._params)},i.load=async function(e,a){const{extent:r,size:s}=e;t.throwIfAborted(a);const i=await this._params.loadImagery(r,s[0],s[1],this._params.timeExtent,a),{vertexData:n,indexData:o}=await this._params.createFlowMesh("Streamlines",this._params.simulationSettings,i,a);return new f(n,o,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})},i.render=function(e,t,r){const{context:i}=e,{program:n}=r;i.setFaceCullingEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunction(s.BlendFactor.ONE,s.BlendFactor.ONE_MINUS_SRC_ALPHA),i.useProgram(n),n.setUniform1f("u_time",t.time),n.setUniform1f("u_trailLength",this._params.trailLength),n.setUniform1f("u_flowSpeed",this._params.flowSpeed),n.setUniform1f("u_featheringSize",this._params.featheringSize),n.setUniform1f("u_featheringOffset",this._params.featheringOffset),n.setUniform1f("u_introFade",this._params.introFade?1:0),n.setUniform1f("u_fadeToZero",this._params.fadeToZero?1:0),n.setUniform1f("u_decayRate",this._params.decayRate),n.setUniformMatrix3fv("u_dvsMat3",t.dvsMat3),n.setUniformMatrix3fv("u_displayViewMat3",t.displayViewMat3),a.setUniforms(n,"color","vec4",this._params.color),a.setUniforms(n,"opacity","float",this._params.opacity),a.setUniforms(n,"size","float",this._params.size),i.bindVAO(r.vertexArray),i.drawElements(s.PrimitiveType.TRIANGLES,r.indexCount,s.DataType.UNSIGNED_INT,0)},e._createClass(r,[{key:"animated",get:function(){return this._params.flowSpeed>0}}]),r}();const m=new Map;m.set("a_positionAndSide",0),m.set("a_timeInfo",1),m.set("a_extrude",2),m.set("a_speed",3);const p={geometry:[new n.VertexElementDescriptor("a_positionAndSide",3,s.DataType.FLOAT,0,36),new n.VertexElementDescriptor("a_timeInfo",3,s.DataType.FLOAT,12,36),new n.VertexElementDescriptor("a_extrude",2,s.DataType.FLOAT,24,36),new n.VertexElementDescriptor("a_speed",1,s.DataType.FLOAT,32,36)]},l={vsPath:"raster/flow/streamlines",fsPath:"raster/flow/streamlines",attributes:m};let f=function(){function t(e,t,a){this._vertexData=e,this._indexData=t,this._values=a}var a=t.prototype;return a.attach=function(e){const{context:t}=e,a=r.BufferObject.createVertex(t,s.Usage.STATIC_DRAW,this._vertexData),n=r.BufferObject.createIndex(t,s.Usage.STATIC_DRAW,this._indexData),o={geometry:a},f=new i.VertexArrayObject(t,m,p,o,n),c=[];"ramp"===this._values.color.kind&&c.push("vvColor"),"ramp"===this._values.opacity.kind&&c.push("vvOpacity"),"ramp"===this._values.size.kind&&c.push("vvSize");const _=e.painter.materialManager.getProgram(l,c);this.vertexArray=f,this.program=_,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null},a.detach=function(){this.vertexArray.dispose()},e._createClass(t,[{key:"ready",get:function(){return this.program.compiled}}]),t}();return o}));
