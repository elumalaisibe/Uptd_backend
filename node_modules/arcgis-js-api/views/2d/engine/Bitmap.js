/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe","../../../core/promiseUtils","../../../chunks/mat3","../../../chunks/mat3f32","../../../chunks/vec2f32","./DisplayObject","./ImageryBitmapSource","../../webgl/contextUtils","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(t,e,i,r,s,o,n,u,h,a,l,c,d){"use strict";function _(t){return t&&"render"in t}function p(t){const e=document.createElement("canvas");return e.width=t.width,e.height=t.height,t.render(e.getContext("2d")),e}function f(t){return _(t)?t instanceof h?i.applySome(t.getRenderedRasterPixels(),(t=>t.renderedRasterPixels)):p(t):t}let x=function(t){function i(i=null,r=!1){var s;return(s=t.call(this)||this).blendFunction="standard",s._sourceWidth=0,s._sourceHeight=0,s._textureInvalidated=!1,s._texture=null,s.stencilRef=0,s.coordScale=[1,1],s._height=void 0,s.pixelRatio=1,s.resolution=0,s.rotation=0,s._source=null,s._width=void 0,s.x=0,s.y=0,s.immutable=r,s.source=i,s.requestRender=s.requestRender.bind(e._assertThisInitialized(s)),s}e._inherits(i,t);var u=i.prototype;return u.destroy=function(){this._texture&&(this._texture.dispose(),this._texture=null),null!=this._uploadStatus&&(this._uploadStatus.controller.abort(),this._uploadStatus=null)},u.beforeRender=function(t){e._get(e._getPrototypeOf(i.prototype),"beforeRender",this).call(this,t),this.updateTexture(t)},u.setSourceAsync=async function(t,e){null!=this._uploadStatus&&this._uploadStatus.controller.abort();const i=new AbortController,s=r.createResolver();return r.onAbortOrThrow(e,(()=>i.abort())),r.onAbortOrThrow(i,(t=>s.reject(t))),this._uploadStatus={controller:i,resolver:s},this.source=t,s.promise},u.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this._source instanceof HTMLImageElement?(this._sourceHeight=this._source.naturalHeight,this._sourceWidth=this._source.naturalWidth):this._source&&(this._sourceHeight=this._source.height,this._sourceWidth=this._source.width))},u.updateTransitionProperties=function(t,r){t>=64&&(this.fadeTransitionEnabled=!1,this.inFadeTransition=!1),e._get(e._getPrototypeOf(i.prototype),"updateTransitionProperties",this).call(this,t,r)},u.setTransform=function(t){const e=s.identity(this.transforms.dvs),[i,r]=t.toScreenNoRotation([0,0],[this.x,this.y]),o=this.resolution/this.pixelRatio/t.resolution,u=o*this.width,h=o*this.height,a=Math.PI*this.rotation/180;s.translate(e,e,n.fromValues(i,r)),s.translate(e,e,n.fromValues(u/2,h/2)),s.rotate(e,e,-a),s.translate(e,e,n.fromValues(-u/2,-h/2)),s.scaleByVec2(e,e,n.fromValues(u,h)),s.multiply(this.transforms.dvs,t.displayViewMat3,e)},u.setSamplingProfile=function(t){this._texture&&(t.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(t.samplingMode))},u.bind=function(t,e){this._texture&&t.bindTexture(this._texture,e)},u.updateTexture=async function({context:t,painter:e}){if(!this._textureInvalidated)return;if(this._textureInvalidated=!1,this._texture||(this._texture=this._createTexture(t)),!this.source)return void this._texture.setData(null);this._texture.resize(this._sourceWidth,this._sourceHeight);const i=f(this.source);try{if(null!=this._uploadStatus){const{controller:t,resolver:r}=this._uploadStatus,s={signal:t.signal},{width:o,height:n}=this,u=this._texture,h=e.textureUploadManager;await h.enqueueTextureUpdate({data:i,texture:u,width:o,height:n},s),r.resolve(),this._uploadStatus=null}else this._texture.setData(i);this.ready()}catch(s){r.throwIfNotAbortError(s)}},u.onDetach=function(){this.destroy()},u._createTransforms=function(){return{dvs:o.create()}},u._createTexture=function(t){const e=this.immutable&&t.type===a.ContextType.WEBGL2,i=new d.TextureDescriptor;return i.internalFormat=e?l.SizedPixelFormat.RGBA8:l.PixelFormat.RGBA,i.wrapMode=l.TextureWrapMode.CLAMP_TO_EDGE,i.isImmutable=e,i.width=this._sourceWidth,i.height=this._sourceHeight,new c.Texture(t,i)},e._createClass(i,[{key:"isSourceScaled",get:function(){return this.width!==this._sourceWidth||this.height!==this._sourceHeight}},{key:"height",get:function(){return void 0!==this._height?this._height:this._sourceHeight},set:function(t){this._height=t}},{key:"source",get:function(){return this._source},set:function(t){null==t&&null==this._source||(this._source=t,this.invalidateTexture(),this.requestRender())}},{key:"width",get:function(){return void 0!==this._width?this._width:this._sourceWidth},set:function(t){this._width=t}}]),i}(u.DisplayObject);t.Bitmap=x,t.isImageSource=_,t.rasterize=p,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
