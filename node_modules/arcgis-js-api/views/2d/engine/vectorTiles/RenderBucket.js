/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/typedArrayUtil","./enums","./decluttering/util","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject"],(function(e,t,n,r,a,i,s,o,c){"use strict";let f=function(){function e(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let n=1;const r=new Uint32Array(e);this.layerUIDs=[];const a=r[n++];for(let i=0;i<a;i++)this.layerUIDs[i]=r[n++];this.bufferDataOffset=n,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}var n=e.prototype;return n.destroy=function(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)},n.prepareForRendering=function(e){null!=this._data&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)},t._createClass(e,[{key:"isPreparedForRendering",get:function(){return null==this._data}},{key:"offset",get:function(){return this.bufferDataOffset}},{key:"data",get:function(){return this._data}}]),e}(),u=function(e){function r(t,n){var r;(r=e.call(this,t,n)||this).type=a.BucketType.LINE,r.lineIndexStart=0,r.lineIndexCount=0;const i=new Uint32Array(t);let s=r.bufferDataOffset;r.lineIndexStart=i[s++],r.lineIndexCount=i[s++];const o=i[s++];if(o>0){r.patternMap=new Map;for(let e=0;e<o;e++){const e=i[s++],t=i[s++],n=i[s++];r.patternMap.set(e,[t,n])}}return r.bufferDataOffset=s,r}t._inherits(r,e);var i=r.prototype;return i.hasData=function(){return this.lineIndexCount>0},i.triangleCount=function(){return this.lineIndexCount/3},i.doDestroy=function(){this.vao=n.disposeMaybe(this.vao)},i.doPrepareForRendering=function(e,t,n){const r=new Uint32Array(t),a=new Int32Array(r.buffer),i=r[n++],f=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,new Int32Array(a.buffer,4*n,i));n+=i;const u=r[n++],y=s.BufferObject.createIndex(e,o.Usage.STATIC_DRAW,new Uint32Array(r.buffer,4*n,u));n+=u;const l=this.layer.lineMaterial;this.vao=new c.VertexArrayObject(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:f},y)},t._createClass(r,[{key:"memoryUsed",get:function(){return(this.data?.byteLength??0)+(this.vao?.memoryEstimate??0)}}]),r}(f),y=function(e){function r(t,n){var r;(r=e.call(this,t,n)||this).type=a.BucketType.FILL,r.fillIndexStart=0,r.fillIndexCount=0,r.outlineIndexStart=0,r.outlineIndexCount=0;const i=new Uint32Array(t);let s=r.bufferDataOffset;r.fillIndexStart=i[s++],r.fillIndexCount=i[s++],r.outlineIndexStart=i[s++],r.outlineIndexCount=i[s++];const o=i[s++];if(o>0){r.patternMap=new Map;for(let e=0;e<o;e++){const e=i[s++],t=i[s++],n=i[s++];r.patternMap.set(e,[t,n])}}return r.bufferDataOffset=s,r}t._inherits(r,e);var i=r.prototype;return i.hasData=function(){return this.fillIndexCount>0||this.outlineIndexCount>0},i.triangleCount=function(){return(this.fillIndexCount+this.outlineIndexCount)/3},i.doDestroy=function(){this.fillVAO=n.disposeMaybe(this.fillVAO),this.outlineVAO=n.disposeMaybe(this.outlineVAO)},i.doPrepareForRendering=function(e,t,n){const r=new Uint32Array(t),a=new Int32Array(r.buffer),i=r[n++],f=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,new Int32Array(a.buffer,4*n,i));n+=i;const u=r[n++],y=s.BufferObject.createIndex(e,o.Usage.STATIC_DRAW,new Uint32Array(r.buffer,4*n,u));n+=u;const l=r[n++],h=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,new Int32Array(a.buffer,4*n,l));n+=l;const d=r[n++],A=s.BufferObject.createIndex(e,o.Usage.STATIC_DRAW,new Uint32Array(r.buffer,4*n,d));n+=d;const b=this.layer,g=b.fillMaterial,p=b.outlineMaterial;this.fillVAO=new c.VertexArrayObject(e,g.getAttributeLocations(),g.getLayoutInfo(),{geometry:f},y),this.outlineVAO=new c.VertexArrayObject(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:h},A)},t._createClass(r,[{key:"memoryUsed",get:function(){return(this.data?.byteLength??0)+(this.fillVAO?.memoryEstimate??0)+(this.outlineVAO?.memoryEstimate??0)}}]),r}(f),l=function(e){function f(t,n,r){var s;(s=e.call(this,t,n)||this).type=a.BucketType.SYMBOL,s.iconPerPageElementsMap=new Map,s.glyphPerPageElementsMap=new Map,s.symbolInstances=[],s.isIconSDF=!1,s.opacityChanged=!1,s.lastOpacityUpdate=0,s.symbols=[];const o=new Uint32Array(t),c=new Int32Array(t),f=new Float32Array(t);let u=s.bufferDataOffset;s.isIconSDF=!!o[u++];const y=o[u++];for(let e=0;e<y;e++){const e=o[u++],t=o[u++],n=o[u++];s.iconPerPageElementsMap.set(e,[t,n])}const l=o[u++];for(let e=0;e<l;e++){const e=o[u++],t=o[u++],n=o[u++];s.glyphPerPageElementsMap.set(e,[t,n])}const h=o[u++],d=o[u++];return s.iconOpacity=new Int32Array(h),s.textOpacity=new Int32Array(d),u=i.deserializeSymbols(o,c,f,u,s.symbols,r),s.bufferDataOffset=u,s}t._inherits(f,e);var u=f.prototype;return u.hasData=function(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0},u.triangleCount=function(){let e=0;for(const[t,n]of this.iconPerPageElementsMap)e+=n[1];for(const[t,n]of this.glyphPerPageElementsMap)e+=n[1];return e/3},u.doDestroy=function(){this.iconVAO=n.disposeMaybe(this.iconVAO),this.textVAO=n.disposeMaybe(this.textVAO)},u.updateOpacityInfo=function(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.vertexBuffers.opacity;e.length>0&&e.byteLength===t.byteLength&&t.setSubData(e,0,0,e.length);const n=this.textOpacity,r=this.textVAO.vertexBuffers.opacity;n.length>0&&n.byteLength===r.byteLength&&r.setSubData(n,0,0,n.length)},u.doPrepareForRendering=function(e,t,n){const r=new Uint32Array(t),a=new Int32Array(r.buffer),i=r[n++],f=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,new Int32Array(a.buffer,4*n,i));n+=i;const u=r[n++],y=s.BufferObject.createIndex(e,o.Usage.STATIC_DRAW,new Uint32Array(r.buffer,4*n,u));n+=u;const l=r[n++],h=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,new Int32Array(a.buffer,4*n,l));n+=l;const d=r[n++],A=s.BufferObject.createIndex(e,o.Usage.STATIC_DRAW,new Uint32Array(r.buffer,4*n,d));n+=d;const b=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,this.iconOpacity.buffer),g=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,this.textOpacity.buffer),p=this.layer,I=p.iconMaterial,O=p.textMaterial;this.iconVAO=new c.VertexArrayObject(e,I.getAttributeLocations(),I.getLayoutInfo(),{geometry:f,opacity:b},y),this.textVAO=new c.VertexArrayObject(e,O.getAttributeLocations(),O.getLayoutInfo(),{geometry:h,opacity:g},A)},t._createClass(f,[{key:"memoryUsed",get:function(){return(this.data?.byteLength??0)+(this.iconVAO?.memoryEstimate??0)+(this.textVAO?.memoryEstimate??0)+r.estimateSize(this.iconOpacity)+r.estimateSize(this.textOpacity)}}]),f}(f),h=function(e){function r(t,n){var r;(r=e.call(this,t,n)||this).type=a.BucketType.CIRCLE,r.circleIndexStart=0,r.circleIndexCount=0;const i=new Uint32Array(t);let s=r.bufferDataOffset;return r.circleIndexStart=i[s++],r.circleIndexCount=i[s++],r.bufferDataOffset=s,r}t._inherits(r,e);var i=r.prototype;return i.hasData=function(){return this.circleIndexCount>0},i.triangleCount=function(){return this.circleIndexCount/3},i.doDestroy=function(){this.vao=n.disposeMaybe(this.vao)},i.doPrepareForRendering=function(e,t,n){const r=new Uint32Array(t),a=new Int32Array(r.buffer),i=r[n++],f=s.BufferObject.createVertex(e,o.Usage.STATIC_DRAW,new Int32Array(a.buffer,4*n,i));n+=i;const u=r[n++],y=s.BufferObject.createIndex(e,o.Usage.STATIC_DRAW,new Uint32Array(r.buffer,4*n,u));n+=u;const l=this.layer.circleMaterial;this.vao=new c.VertexArrayObject(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:f},y)},t._createClass(r,[{key:"memoryUsed",get:function(){return(this.data?.byteLength??0)+(this.vao?.memoryEstimate??0)}}]),r}(f);e.CircleRenderBucket=h,e.FillRenderBucket=y,e.LineRenderBucket=u,e.RenderBucketBase=f,e.SymbolRenderBucket=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
