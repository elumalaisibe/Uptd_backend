/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../geometry/support/TileClipper","./GeometryUtils","./TextShaping","./decluttering/config","./style/StyleDefinition"],(function(e,t,n,i,o,l,a){"use strict";const h=4096,s=512,c=8,r=.5,m=2;let g=t._createClass((function(e,t,n=0,i=-1,o=r){this.x=e,this.y=t,this.angle=n,this.segment=i,this.minzoom=o})),I=t._createClass((function(e,t,n,o,l,a=r,h=i.C_INFINITY){this.anchor=e,this.labelAngle=t,this.glyphAngle=n,this.page=o,this.alternateVerticalGlyph=l,this.minzoom=a,this.maxzoom=h})),y=t._createClass((function(e,t,n,i,o,l,a,h,s,c,r,m){this.tl=e,this.tr=t,this.bl=n,this.br=i,this.mosaicRect=o,this.labelAngle=l,this.minAngle=a,this.maxAngle=h,this.anchor=s,this.minzoom=c,this.maxzoom=r,this.page=m})),T=t._createClass((function(e){this.shapes=e})),P=function(){function e(){}var h=e.prototype;return h.getIconPlacement=function(e,t,o){const h=new n.Point(e.x,e.y),s=o.rotationAlignment===a.RotationAlignment.MAP,c=o.keepUpright;let r=o.rotate*i.C_DEG_TO_RAD;s&&(r+=e.angle);const m=new T([]);return o.allowOverlap&&o.ignorePlacement||!l.DECLUTTER_TILES||(m.iconColliders=[]),this._addIconPlacement(m,h,t,o,r),s&&c&&this._addIconPlacement(m,h,t,o,r+i.C_PI),m},h._addIconPlacement=function(e,t,o,h,s){const c=o.pixelRatio,m=o.width/c,g=o.height/c,I=h.offset;let T=I[0],P=I[1];switch(h.anchor){case a.SymbolAnchor.CENTER:T-=m/2,P-=g/2;break;case a.SymbolAnchor.LEFT:P-=g/2;break;case a.SymbolAnchor.RIGHT:T-=m,P-=g/2;break;case a.SymbolAnchor.TOP:T-=m/2;break;case a.SymbolAnchor.BOTTOM:T-=m/2,P-=g;break;case a.SymbolAnchor.TOP_LEFT:break;case a.SymbolAnchor.BOTTOM_LEFT:P-=g;break;case a.SymbolAnchor.TOP_RIGHT:T-=m;break;case a.SymbolAnchor.BOTTOM_RIGHT:T-=m,P-=g}const d=o.rect,x=2/c,_=T-x,p=P-x,w=_+d.width/c,f=p+d.height/c,b=new n.Point(_,p),u=new n.Point(w,f),S=new n.Point(_,f),A=new n.Point(w,p);if(0!==s){const e=Math.cos(s),t=Math.sin(s);b.rotate(e,t),u.rotate(e,t),S.rotate(e,t),A.rotate(e,t)}const E=new y(b,A,S,u,d,s,0,256,t,r,i.C_INFINITY,0);if(e.shapes.push(E),(!h.allowOverlap||!h.ignorePlacement)&&l.DECLUTTER_TILES){const n=h.size,o=h.padding,l={xTile:t.x,yTile:t.y,dxPixels:T*n-o,dyPixels:P*n-o,hard:!h.optional,partIndex:0,width:m*n+2*o,height:g*n+2*o,angle:s,minLod:r,maxLod:i.C_INFINITY};e.iconColliders.push(l)}},h.getTextPlacement=function(e,t,l,h){const s=new n.Point(e.x,e.y),g=h.rotate*i.C_DEG_TO_RAD,P=h.rotationAlignment===a.RotationAlignment.MAP,d=h.keepUpright,x=h.padding;let _=r;const p=!P?0:e.angle,w=e.segment>=0&&P,f=h.allowOverlap&&h.ignorePlacement?null:[],b=[],u=4,S=!w;let A=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,L=A,O=E;const C=(w||P)&&d,N=h.size/o.SDF_GLYPH_SIZE;let G=!1;for(const n of t)if(n.vertical){G=!0;break}let F,k=0,M=0;if(!w&&G){const e=o.TextShaping.getTextBox(t,h.lineHeight*o.SDF_GLYPH_SIZE);switch(h.anchor){case a.SymbolAnchor.LEFT:k=e.height/2,M=-e.width/2;break;case a.SymbolAnchor.RIGHT:k=-e.height/2,M=e.width/2;break;case a.SymbolAnchor.TOP:k=e.height/2,M=e.width/2;break;case a.SymbolAnchor.BOTTOM:k=-e.height/2,M=-e.width/2;break;case a.SymbolAnchor.TOP_LEFT:k=e.height;break;case a.SymbolAnchor.BOTTOM_LEFT:M=-e.width;break;case a.SymbolAnchor.TOP_RIGHT:M=e.width;break;case a.SymbolAnchor.BOTTOM_RIGHT:k=-e.height}}k+=h.offset[0]*o.SDF_GLYPH_SIZE,M+=h.offset[1]*o.SDF_GLYPH_SIZE;for(const a of t){const t=a.glyphMosaicItem;if(!t||t.rect.isEmpty)continue;const T=t.rect,R=t.metrics,Y=t.page;if(f&&S){if(void 0!==F&&F!==a.y){let t,n,o,l;G?(t=-O+k,n=A+M,o=O-L,l=E-A):(t=A+k,n=L+M,o=E-A,l=O-L);const a={xTile:e.x,yTile:e.y,dxPixels:t*N-x,dyPixels:n*N-x,hard:!h.optional,partIndex:1,width:o*N+2*x,height:l*N+2*x,angle:g,minLod:r,maxLod:i.C_INFINITY};f.push(a),A=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,L=A,O=E}F=a.y}const v=[];if(w){const n=.5*t.metrics.width,i=(a.x+R.left-u+n)*N*c;if(_=this._placeGlyph(e,_,i,l,e.segment,1,a.vertical,Y,v),d&&(_=this._placeGlyph(e,_,i,l,e.segment,-1,a.vertical,Y,v)),_>=m)break}else v.push(new I(s,p,p,Y,!1)),P&&d&&v.push(new I(s,p+i.C_PI,p+i.C_PI,Y,!1));const D=a.x+R.left,H=a.y-o.SDF_GLYPH_BASELINE-R.top,z=D+R.width,B=H+R.height;let V,Z,U,q,X,j,J,K;if(!w&&G)if(a.vertical){const e=(D+z)/2-R.height/2,t=(H+B)/2+R.width/2;V=new n.Point(-t-u+k,e-u+M),Z=new n.Point(V.x+T.width,V.y+T.height),U=new n.Point(V.x,Z.y),q=new n.Point(Z.x,V.y)}else V=new n.Point(-H+u+k,D-u+M),Z=new n.Point(V.x-T.height,V.y+T.width),U=new n.Point(Z.x,V.y),q=new n.Point(V.x,Z.y);else V=new n.Point(D-u+k,H-u+M),Z=new n.Point(V.x+T.width,V.y+T.height),U=new n.Point(V.x,Z.y),q=new n.Point(Z.x,V.y);for(const i of v){let t,o,l,s;if(i.alternateVerticalGlyph){if(!X){const e=(D+z)/2+k,t=(H+B)/2+M;X=new n.Point(e-R.height/2-u,t+R.width/2+u),j=new n.Point(X.x+T.height,X.y-T.width),J=new n.Point(j.x,X.y),K=new n.Point(X.x,j.y)}t=X,o=J,l=K,s=j}else t=V,o=U,l=q,s=Z;const c=H,r=B,I=i.glyphAngle+g;if(0!==I){const e=Math.cos(I),n=Math.sin(I);t=t.clone(),o=o?.clone(),l=l?.clone(),s=s?.clone(),t.rotate(e,n),s?.rotate(e,n),o?.rotate(e,n),l?.rotate(e,n)}let P=0,d=256;if(w&&G?a.vertical?i.alternateVerticalGlyph?(P=32,d=96):(P=224,d=32):(P=224,d=96):(P=192,d=64),b.push(new y(t,l,o,s,T,i.labelAngle,P,d,i.anchor,i.minzoom,i.maxzoom,i.page)),f&&(!C||this._legible(i.labelAngle)))if(S)D<A&&(A=D),c<L&&(L=c),z>E&&(E=z),r>O&&(O=r);else if(i.minzoom<m){const t={xTile:e.x,yTile:e.y,dxPixels:(D+k)*N-x,dyPixels:(c+k)*N-x,hard:!h.optional,partIndex:1,width:(z-D)*N+2*x,height:(r-c)*N+2*x,angle:I,minLod:i.minzoom,maxLod:i.maxzoom};f.push(t)}}}if(_>=m)return null;if(f&&S){let t,n,o,l;G?(t=-O+k,n=A+M,o=O-L,l=E-A):(t=A+k,n=L+M,o=E-A,l=O-L);const a={xTile:e.x,yTile:e.y,dxPixels:t*N-x,dyPixels:n*N-x,hard:!h.optional,partIndex:1,width:o*N+2*x,height:l*N+2*x,angle:g,minLod:r,maxLod:i.C_INFINITY};f.push(a)}const R=new T(b);return f&&f.length>0&&(R.textColliders=f),R},h._legible=function(e){const t=i.radToByte(e);return t<65||t>=193},h._placeGlyph=function(e,t,o,l,a,h,s,c,r){let m=h;const g=m<0?i.positiveMod(e.angle+i.C_PI,i.C_2PI):e.angle;let y=0;o<0&&(m*=-1,o*=-1,y=i.C_PI),m>0&&++a;let T=new n.Point(e.x,e.y),P=l[a],d=i.C_INFINITY;if(l.length<=a)return d;for(;;){const e=P.x-T.x,n=P.y-T.y,h=Math.sqrt(e*e+n*n),x=Math.max(o/h,t),_=e/h,p=n/h,w=i.positiveMod(Math.atan2(p,_)+y,i.C_2PI);if(r.push(new I(T,g,w,c,!1,x,d)),s&&r.push(new I(T,g,w,c,!0,x,d)),x<=t)return x;T=P.clone();do{if(a+=m,l.length<=a||a<0)return x;P=l[a]}while(T.isEqual(P));let f=P.x-T.x,b=P.y-T.y;const u=Math.sqrt(f*f+b*b);f*=h/u,b*=h/u,T.x-=f,T.y-=b,d=x}},t._createClass(e)}();e.Anchor=g,e.PlacedSymbol=y,e.Placement=T,e.PlacementEngine=P,e.TILE_COORD_SIZE=h,e.TILE_PIXEL_RATIO=c,e.TILE_PIXEL_SIZE=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
