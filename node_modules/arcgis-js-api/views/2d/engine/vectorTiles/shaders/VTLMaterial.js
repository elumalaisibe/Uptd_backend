/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../MemoryBuffer","./enums","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(t,e,n,o,i,a){"use strict";let s=function(){function t(t){this._locations=new Map,this._key=t}var s=t.prototype;return s.defines=function(){return[]},s.getStride=function(){return this._layoutInfo||this._buildAttributesInfo(),this._stride},s.getAttributeLocations=function(){return 0===this._locations.size&&this._buildAttributesInfo(),this._locations},s.getLayoutInfo=function(){return this._layoutInfo||this._buildAttributesInfo(),this._layoutInfo},s.getEncodingInfos=function(){return this._propertyEncodingInfo||this._buildAttributesInfo(),this._propertyEncodingInfo},s.getUniforms=function(){return this._uniforms||this._buildAttributesInfo(),this._uniforms},s.getShaderHeader=function(){return this._shaderHeader||this._buildAttributesInfo(),this._shaderHeader},s.getShaderMain=function(){return this._shaderMain||this._buildAttributesInfo(),this._shaderMain},s.setDataUniforms=function(t,e,n,o,i){const a=this.getUniforms();for(const s of a){const{name:a,type:r,getValue:c}=s,u=c(n,e,o,i);if(null!==u)switch(r){case"float":t.setUniform1f(a,u);break;case"vec2":t.setUniform2fv(a,u);break;case"vec4":t.setUniform4fv(a,u)}}},s.encodeAttributes=function(t,e,n,i){const a=this.attributesInfo(),s=this.getEncodingInfos(),r=[];let c=0,u=0;for(const y of Object.keys(s)){const f=s[y],{type:d,precisionFactor:l,isLayout:p}=a[y],_=p?n.getLayoutProperty(y):n.getPaintProperty(y),h=_.interpolator?.getInterpolationRange(e);let T=0;for(const n of f){const{offset:a,bufferElementsToAdd:s}=n;if(s>0){for(let t=0;t<s;t++)r.push(0);c+=u,u=n.bufferElementsToAdd}const y=i??_.getValue(h?h[T]:e,t);switch(d){case o.EncodingType.R8_SIGNED:case o.EncodingType.R8_UNSIGNED:r[c]|=this._encodeByte(y*(l||1),8*a);break;case o.EncodingType.R16_SIGNED:case o.EncodingType.R16_UNSIGNED:r[c]|=this._encodeShort(y*(l||1),8*a);break;case o.EncodingType.R8G8_SIGNED:case o.EncodingType.R8G8_UNSIGNED:r[c]|=this._encodeByte(y*(l||1),8*a),r[c]|=this._encodeByte(y*(l||1),8*a+8);break;case o.EncodingType.R16G16_SIGNED:case o.EncodingType.R16G16_UNSIGNED:r[c]|=this._encodeShort(y*(l||1),8*a),r[c]|=this._encodeShort(y*(l||1),8*a+16);break;case o.EncodingType.R8G8B8A8_SIGNED:case o.EncodingType.R8G8B8A8_UNSIGNED:r[c]|=this._encodeByte(y*(l||1),8*a),r[c]|=this._encodeByte(y*(l||1),8*a+8),r[c]|=this._encodeByte(y*(l||1),8*a+16),r[c]|=this._encodeByte(y*(l||1),8*a+24);break;case o.EncodingType.R8G8B8A8_COLOR:r[c]=this._encodeColor(y);break;case o.EncodingType.R16G16B16A16_DASHARRAY:case o.EncodingType.R16G16B16A16_PATTERN:this._encodePattern(c,r,y);break;default:throw new Error("Unsupported encoding type")}T++}}return r},s.getAtributeState=function(t){let e=0;const n=3+2*t;return e|=this._bit(n),e|=this._bit(n+1)<<1,e},s._buildAttributesInfo=function(){const e=[],n={},a={};let s=-1;const r=this.attributesInfo(),c=this.attributes();let u=-1;for(const i of c){u++;const c=this.getAtributeState(u);if(c===o.AttributeStatus.UNIFORM||c===o.AttributeStatus.UNUSED)continue;const y=r[i],f=[];n[i]=f;const d=y.type;for(let n=0;n<c;n++){const{dataType:n,bytesPerElement:o,count:i,normalized:r}=t._encodingInfo[d],c=o*i,u=`${n}-${!0===r}`;let y=a[u],l=0;if(!y||y.count+i>4)s++,y={dataIndex:s,count:0,offset:0},4!==i&&(a[u]=y),e.push({location:-1,name:"a_data_"+s,count:i,type:n,normalized:r}),l=Math.ceil(Math.max(c/4,1));else{const t=e[y.dataIndex];t.count+=i;l=Math.ceil(Math.max(t.count*o/4,1))-Math.ceil(Math.max(y.offset/4,1))}f.push({dataIndex:y.dataIndex,offset:y.offset,bufferElementsToAdd:l}),y.offset+=c,y.count+=i}}for(const t of e)switch(t.type){case i.DataType.BYTE:case i.DataType.UNSIGNED_BYTE:t.count=4;break;case i.DataType.SHORT:case i.DataType.UNSIGNED_SHORT:t.count+=t.count%2}this._buildVertexBufferLayout(e);let y=0;const f=this._layoutInfo.geometry;for(const t of f)this._locations.set(t.name,y++);const d=this._layoutInfo.opacity;if(d)for(const t of d)this._locations.set(t.name,y++);this._buildShaderInfo(e,n),this._propertyEncodingInfo=n},s._buildVertexBufferLayout=function(t){const e={},n=this.geometryInfo();let o=n[0].stride;if(0===t.length)e.geometry=n;else{const i=[];let s=o;for(const e of t)o+=r(e.type)*e.count;for(const t of n)i.push(new a.VertexElementDescriptor(t.name,t.count,t.type,t.offset,o,t.normalized));for(const e of t)i.push(new a.VertexElementDescriptor(e.name,e.count,e.type,s,o,e.normalized)),s+=r(e.type)*e.count;e.geometry=i}this.opacityInfo()&&(e.opacity=this.opacityInfo()),this._layoutInfo=e,this._stride=o},s._buildShaderInfo=function(e,n){let i="\n",a="\n";const s=[];for(const t of e)i+=`attribute ${this._getType(t.count)} ${t.name};\n`;const r=this.attributes(),u=this.attributesInfo();let y=-1;for(const f of r){y++;const{name:e,type:r,precisionFactor:d,isLayout:l}=u[f],p=d&&1!==d?" * "+1/d:"",{bytesPerElement:_,count:h}=t._encodingInfo[r],T=t=>`a_data_${t.dataIndex}${c(h,t.offset,_)}`;switch(this.getAtributeState(y)){case o.AttributeStatus.UNIFORM:{const t=this._getType(h),n=`u_${e}`;s.push({name:n,type:t,getValue:(t,e,n,i)=>{const a=l?t.getLayoutValue(f,e):t.getPaintValue(f,e);if(r===o.EncodingType.R16G16B16A16_DASHARRAY){const n=t.getDashKey(a,t.getLayoutValue("line-cap",e)),o=i.getMosaicItemPosition(n,!1);if(null==o)return null;const{tl:s,br:r}=o;return[s[0],r[1],r[0],s[1]]}if(r===o.EncodingType.R16G16B16A16_PATTERN){const t=i.getMosaicItemPosition(a,!f.includes("line-"));if(null==t)return null;const{tl:e,br:n}=t;return[e[0],n[1],n[0],e[1]]}if(r===o.EncodingType.R8G8B8A8_COLOR){const t=a[3];return[t*a[0],t*a[1],t*a[2],t]}return a}}),i+=`uniform ${t} ${n};\n`,a+=`${t} ${e} = ${n};\n`}break;case o.AttributeStatus.DATA_DRIVEN:{const t=T(n[f][0]);a+=`${this._getType(h)} ${e} = ${t}${p};\n`}break;case o.AttributeStatus.INTERPOLATED_DATA_DRIVEN:{const t=`u_t_${e}`;s.push({name:t,type:"float",getValue:(t,e,n,o)=>(l?t.getLayoutProperty(f):t.getPaintProperty(f)).interpolator.interpolationUniformValue(n,e)}),i+=`uniform float ${t};\n`;const o=T(n[f][0]),r=T(n[f][1]);a+=`${this._getType(h)} ${e} = mix(${o}${p}, ${r}${p}, ${t});\n`}}}this._shaderHeader=i,this._shaderMain=a,this._uniforms=s},s._bit=function(t){return(this._key&1<<t)>>t},s._getType=function(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}throw new Error("Invalid count")},s._encodeColor=function(t){const e=255*t[3];return n.i8888to32(t[0]*e,t[1]*e,t[2]*e,e)},s._encodePattern=function(t,e,n){if(!n||!n.rect)return;const o=2,i=n.rect,a=n.width,s=n.height;e[t]=this._encodeShort(i.x+o,0),e[t]|=this._encodeShort(i.y+o+s,16),e[t+1]=this._encodeShort(i.x+o+a,0),e[t+1]|=this._encodeShort(i.y+o,16)},s._encodeByte=function(t,e){return(255&t)<<e},s._encodeShort=function(t,e){return(65535&t)<<e},e._createClass(t,[{key:"key",get:function(){return this._key}},{key:"type",get:function(){return 7&this._key}}]),t}();s._encodingInfo={[o.EncodingType.R8_SIGNED]:{dataType:i.DataType.BYTE,bytesPerElement:1,count:1,normalized:!1},[o.EncodingType.R8_UNSIGNED]:{dataType:i.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:1,normalized:!1},[o.EncodingType.R16_SIGNED]:{dataType:i.DataType.SHORT,bytesPerElement:2,count:1,normalized:!1},[o.EncodingType.R16_UNSIGNED]:{dataType:i.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:1,normalized:!1},[o.EncodingType.R8G8_SIGNED]:{dataType:i.DataType.BYTE,bytesPerElement:1,count:2,normalized:!1},[o.EncodingType.R8G8_UNSIGNED]:{dataType:i.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:2,normalized:!1},[o.EncodingType.R16G16_SIGNED]:{dataType:i.DataType.SHORT,bytesPerElement:2,count:2,normalized:!1},[o.EncodingType.R16G16_UNSIGNED]:{dataType:i.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:2,normalized:!1},[o.EncodingType.R8G8B8A8_SIGNED]:{dataType:i.DataType.BYTE,bytesPerElement:1,count:4,normalized:!1},[o.EncodingType.R8G8B8A8_UNSIGNED]:{dataType:i.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!1},[o.EncodingType.R8G8B8A8_COLOR]:{dataType:i.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!0},[o.EncodingType.R16G16B16A16_DASHARRAY]:{dataType:i.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:4,normalized:!1},[o.EncodingType.R16G16B16A16_PATTERN]:{dataType:i.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:4,normalized:!1}};const r=t=>{switch(t){case i.DataType.FLOAT:case i.DataType.INT:case i.DataType.UNSIGNED_INT:return 4;case i.DataType.SHORT:case i.DataType.UNSIGNED_SHORT:return 2;case i.DataType.BYTE:case i.DataType.UNSIGNED_BYTE:return 1}},c=(t,e,n)=>{const o=e/n;if(1===t)switch(o){case 0:return".x";case 1:return".y";case 2:return".z";case 3:return".w"}else if(2===t)switch(o){case 0:return".xy";case 1:return".yz";case 2:return".zw"}else if(3===t)switch(o){case 0:return".xyz";case 1:return".yzw"}return""};t.VTLMaterial=s,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
