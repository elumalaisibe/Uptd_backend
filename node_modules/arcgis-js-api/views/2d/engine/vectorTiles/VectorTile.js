/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../chunks/mat3","../../../../chunks/mat3f32","./enums","./RenderBucket","./decluttering/config","../webgl/TiledDisplayObject"],(function(e,t,s,a,r,i,n,o,c){"use strict";let l=function(e){function s(t,s,a,r,i,n,o,c=null){var l;return(l=e.call(this,t,s,a,r,i,n,4096,4096)||this).styleRepository=o,l._memCache=c,l.type="vector-tile",l._referenced=0,l._hasSymbolBuckets=!1,l._memoryUsedByLayerData=0,l.layerData=new Map,l.layerCount=0,l.status="loading",l.allSymbolsFadingOut=!1,l.lastOpacityUpdate=0,l.symbols=new Map,l.isCoverage=!1,l.neededForCoverage=!1,l.decluttered=!1,l.invalidating=!1,l.parentTile=null,l.childrenTiles=new Set,l._processed=!1,l._referenced=1,l.id=t.id,l}t._inherits(s,e);var c=s.prototype;return c.setData=function(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0},c.deleteLayerData=function(e){let t=!1;for(const s of e)if(this.layerData.has(s)){const e=this.layerData.get(s);this._memoryUsedByLayerData-=e.memoryUsed,e.type===i.BucketType.SYMBOL&&this.symbols.has(s)&&(this.symbols.delete(s),t=!0),e.destroy(),this.layerData.delete(s),this.layerCount--}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&this.emit("symbols-changed"),this.requestRender()},c.processed=function(){return this._processed},c.hasData=function(){return this.layerCount>0},c.dispose=function(){"unloaded"!==this.status&&(h.delete(this),s._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")},c.release=function(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)},c.retain=function(){++this._referenced},c.changeDataImpl=function(e){let t=!1;if(e){const{bucketsWithData:s,emptyBuckets:a}=e,r=this._createRenderBuckets(s);if(a&&a.byteLength>0){const e=new Uint32Array(a);for(const t of e)this._deleteLayerData(t)}for(const[e,n]of r)this._deleteLayerData(e),n.type===i.BucketType.SYMBOL&&(this.symbols.set(e,n.symbols),t=!0),this._memoryUsedByLayerData+=n.memoryUsed,this.layerData.set(e,n),this.layerCount++;this._memCache?.updateSize(this.key.id,this,this.memoryUsed)}this._hasSymbolBuckets=!1;for(const[s,a]of this.layerData)a.type===i.BucketType.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")},c.attachWithContext=function(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}},c.setTransform=function(e){t._get(t._getPrototypeOf(s.prototype),"setTransform",this).call(this,e);const r=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*r,n=this.height/this.rangeY*r,o=[0,0];e.toScreen(o,[this.x,this.y]);const c=this.transforms.tileUnitsToPixels;a.identity(c),a.translate(c,c,o),a.rotate(c,c,Math.PI*e.rotation/180),a.scale(c,c,[i,n,1])},c._createTransforms=function(){return{dvs:r.create(),tileMat3:r.create(),tileUnitsToPixels:r.create()}},s._destroyRenderBuckets=function(e){if(!e)return;const t=new Set;e.forEach((e=>{t.has(e)||(e.destroy(),t.add(e))})),e.clear()},c._createRenderBuckets=function(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e)}return t},c._deserializeBucket=function(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case i.BucketType.FILL:s=new n.FillRenderBucket(e,this.styleRepository);break;case i.BucketType.LINE:s=new n.LineRenderBucket(e,this.styleRepository);break;case i.BucketType.SYMBOL:s=new n.SymbolRenderBucket(e,this.styleRepository,this);break;case i.BucketType.CIRCLE:s=new n.CircleRenderBucket(e,this.styleRepository)}return t.set(e,s),s},c._deleteLayerData=function(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--},t._createClass(s,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<o.FADE_DURATION}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<o.FADE_DURATION)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"referenced",get:function(){return this._referenced}},{key:"memoryUsed",get:function(){return this._memoryUsedByLayerData+256}}]),s}(c.TiledDisplayObject);const h=new Map;function y(){h.forEach(((e,t)=>{console.log(`\n${t.key}:`),e[0].forEach((e=>console.log(e))),console.log("========"),e[1].forEach((e=>console.log(e)))}))}e.VectorTile=l,e.printAllocations=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
