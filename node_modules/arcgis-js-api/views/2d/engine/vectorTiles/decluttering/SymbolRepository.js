/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","./util"],(function(e,s,o){"use strict";const t=32,l=8,n=64;let i=function(){function e(e,s,o){this.tileCoordRange=e,this._visibleTiles=s,this._createUnique=o,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}var i=e.prototype;return i.add=function(e,s){this._uniqueSymbolLayerArray=null;let i=this._tiles.get(e.id);i||(i={symbols:new Map},this._tiles.set(e.id,i));const r=new Map;if(s)for(const o of s)i.symbols.has(o)&&(r.set(o,i.symbols.get(o)),i.symbols.delete(o));else for(const[o,t]of e.layerData)i.symbols.has(o)&&(r.set(o,i.symbols.get(o)),i.symbols.delete(o));this._removeSymbols(r);const y=e.symbols,a=new Map;for(const[f,u]of y){let e=u.length;if(e>=t){let s=this.tileCoordRange;do{s/=2,e/=4}while(e>l&&s>n);const t=new o.GridIndex(this.tileCoordRange,this.tileCoordRange,s);a.set(f,{flat:u,index:t}),i.symbols.set(f,{flat:u,index:t});for(const e of u)t.getCell(e.xTile,e.yTile).push(e)}else a.set(f,{flat:u}),i.symbols.set(f,{flat:u})}this._addSymbols(e.key,y)},i.deleteStyleLayers=function(e){this._uniqueSymbolLayerArray=null;for(const[s,o]of this._tiles){const t=new Map;for(const s of e)o.symbols.has(s)&&(t.set(s,o.symbols.get(s)),o.symbols.delete(s));this._removeSymbols(t),0===o.symbols.size&&this._tiles.delete(s)}},i.removeTile=function(e){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(e.id);if(!s)return;const o=new Map;for(const[t,l]of e.symbols)s.symbols.has(t)&&(o.set(t,s.symbols.get(t)),s.symbols.delete(t));this._removeSymbols(o),0===s.symbols.size&&this._tiles.delete(e.id)},i._removeSymbols=function(e){for(const[s,{flat:o}]of e)for(const e of o){const o=e.unique,t=o.tileSymbols,l=t.length-1;for(let s=0;s<l;s++)if(t[s]===e){t[s]=t[l];break}if(t.length=l,0===l){const e=this._uniqueSymbolsReferences.get(s);e.delete(o),0===e.size&&this._uniqueSymbolsReferences.delete(s)}e.unique=null}},i._addSymbols=function(e,s){if(0===s.size)return;const o=this._visibleTiles;for(const t of o)t.parentTile||t.key.world!==e.world||t.key.level===e.level&&!t.key.equals(e)||this._matchSymbols(t,e,s);for(const[t,l]of s)for(const e of l)if(null==e.unique){const s=this._createUnique();e.unique=s,s.tileSymbols.push(e);let o=this._uniqueSymbolsReferences.get(t);o||(o=new Set,this._uniqueSymbolsReferences.set(t,o)),o.add(s)}},i._matchSymbols=function(e,s,t){if(e.key.level>s.level){const o=e.key.level-s.level;if(e.key.row>>o!==s.row||e.key.col>>o!==s.col)return}if(s.level>e.key.level){const o=s.level-e.key.level;if(s.row>>o!==e.key.row||s.col>>o!==e.key.col)return}if(s.equals(e.key)){for(const o of e.childrenTiles)this._matchSymbols(o,s,t);return}const l=new Map;for(const[n,i]of t){const t=[];for(const l of i){const n=o.tileCoordChange(this.tileCoordRange,l.xTile,s.level,s.col,e.key.level,e.key.col),i=o.tileCoordChange(this.tileCoordRange,l.yTile,s.level,s.row,e.key.level,e.key.row);n>=0&&n<this.tileCoordRange&&i>=0&&i<this.tileCoordRange&&t.push({symbol:l,xTransformed:n,yTransformed:i})}const r=[],y=e.key.level<s.level?1:1<<e.key.level-s.level,a=this._tiles.get(e.id).symbols.get(n);if(a){const e=a.flat;for(const s of t){let o,t=!1;const l=s.xTransformed,n=s.yTransformed;o=null!=a.index?a.index.getCell(l,n):e;const i=s.symbol,f=i.hash;for(const e of o)if(f===e.hash&&Math.abs(l-e.xTile)<=y&&Math.abs(n-e.yTile)<=y){const s=e.unique;i.unique=s,s.tileSymbols.push(i),t=!0;break}t||r.push(i)}}r.length>0&&l.set(n,r)}for(const o of e.childrenTiles)this._matchSymbols(o,s,l)},i._createUniqueSymbolLayerArray=function(){const e=this._uniqueSymbolsReferences,s=new Array(e.size);let o,t=0;for(const[l,n]of e){const e=new Array(n.size);o=0;for(const s of n)e[o++]=s;s[t]={styleLayerUID:l,uniqueSymbols:e},t++}return s},s._createClass(e,[{key:"uniqueSymbols",get:function(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}}]),e}();e.SymbolRepository=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
