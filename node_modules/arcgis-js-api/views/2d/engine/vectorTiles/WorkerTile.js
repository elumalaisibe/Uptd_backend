/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/promiseUtils","./Placement","./TileParser","../../tiling/enums"],(function(t,e,s,r,n){"use strict";return function(){function i(t,e,r,i){this.status=n.TileStatus.INITIALIZED,this.placementEngine=new s.PlacementEngine,this.tileKey=t,this.refKeys=e,this._workerTileHandler=r,this._styleRepository=i}var a=i.prototype;return a.release=function(){this.tileKey="",this.refKeys=null,this.status=n.TileStatus.INITIALIZED,this._workerTileHandler=null},a.parse=async function(t,s){const r=s&&s.signal;if(null!=r){const t=()=>{r.removeEventListener("abort",t),this.status=n.TileStatus.INVALID};r.addEventListener("abort",t)}let i;const a={bucketsWithData:[],emptyBuckets:null};try{i=await this._parse(t,s)}catch(h){if(e.isAbortError(h))throw h;return{result:a,transferList:[]}}this.status=n.TileStatus.READY;const l=a.bucketsWithData,u=[];for(const e of i)if(e.hasFeatures()){const t=e.serialize();l.push(t)}else u.push(e.layer.uid);const o=[...l];let c=null;return u.length>0&&(c=Uint32Array.from(u),o.push(c.buffer)),a.emptyBuckets=c,{result:a,transferList:o}},a.setObsolete=function(){this.status=n.TileStatus.INVALID},a.getLayers=function(){return this._workerTileHandler.getLayers()},a.getWorkerTileHandler=function(){return this._workerTileHandler},a._parse=async function(t,e){const s=t.sourceName2DataAndRefKey;if(0===Object.keys(s).length)return[];this.status=n.TileStatus.MODIFIED;return new r(s,this,e.client,this._styleRepository,t.styleLayerUIDs).parse(e)},t._createClass(i)}()}));
