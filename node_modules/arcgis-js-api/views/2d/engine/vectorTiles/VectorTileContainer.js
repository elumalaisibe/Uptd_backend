/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/promiseUtils","../../../../geometry/support/aaBoundingRect","./decluttering/SymbolFader","./style/StyleDefinition","../webgl/enums","../webgl/RenderableTile","../webgl/TileContainer","../../tiling/TileCoverage","../../tiling/TileKey","../../../webgl/enums"],(function(e,t,s,i,r,n,l,o,a,d,c,h){"use strict";const y=1e-6;function u(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||s.getValue()!==n.Visibility.NONE&&(void 0===e.minzoom||e.minzoom<t+y)&&(void 0===e.maxzoom||e.maxzoom>=t-y))return!0}return!1}let p=function(e){function a(t){var s;return(s=e.call(this,t)||this)._backgroundTiles=[],s._pointToCallbacks=new Map,s}t._inherits(a,e);var p=a.prototype;return p.destroy=function(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()},p.setStyleResources=function(e,t,s){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=s,null==this._symbolFader){const e=new r.SymbolFader(this._styleRepository,this.children);e.on("fade-start",(()=>{this.emit("fade-start"),this.requestRender()})),e.on("fade-complete",(()=>{this.emit("fade-complete"),this.requestRender()})),this._symbolFader=e}this._symbolFader.styleRepository=s},p.setSpriteMosaic=function(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e},p.deleteStyleLayers=function(e){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(e)},p.hitTest=async function(e){const t=s.createResolver();return this._pointToCallbacks.set(e,t),this.requestRender(),t.promise},p.enterTileInvalidation=function(){for(const e of this.children)e.invalidating=!0},p.createRenderParams=function(e){return{...t._get(t._getPrototypeOf(a.prototype),"createRenderParams",this).call(this,e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}},p.doRender=function(e){!this.visible||e.drawPhase!==l.WGLDrawPhase.MAP&&e.drawPhase!==l.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||t._get(t._getPrototypeOf(a.prototype),"doRender",this).call(this,e)},p.addChild=function(e){return t._get(t._getPrototypeOf(a.prototype),"addChild",this).call(this,e),null!=this._symbolFader?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e},p.removeChild=function(e){return null!=this._symbolFader&&this._symbolFader.removeTile(e),this.requestRender(),t._get(t._getPrototypeOf(a.prototype),"removeChild",this).call(this,e)},p.renderChildren=function(e){const{drawPhase:s}=e;if(s!==l.WGLDrawPhase.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=l.WGLDrawPhase.HITTEST;const t=e.painter.effects.hittestVTL;t.bind(e),this._doRender(e),t.draw(e,this._pointToCallbacks),t.unbind(e),e.drawPhase=s}}else t._get(t._getPrototypeOf(a.prototype),"renderChildren",this).call(this,e)},p.removeAllChildren=function(){for(let e=0;e<this.children.length;e++){const t=this.children[e];null!=this._symbolFader&&this._symbolFader.removeTile(t),t.dispose()}t._get(t._getPrototypeOf(a.prototype),"removeAllChildren",this).call(this)},p.getStencilTarget=function(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))},p.restartDeclutter=function(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()},p._doRender=function(e){const{context:s}=e,i=this._styleRepository;if(!i)return;const r=i.layers;let n=!0;e.drawPhase===l.WGLDrawPhase.HITTEST&&(n=!1),i.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,i.backgroundBucketIds)),t._get(t._getPrototypeOf(a.prototype),"renderChildren",this).call(this,e),e.drawPhase===l.WGLDrawPhase.MAP&&this._fade(e.displayLevel,e.state);const o=this.children.filter((e=>e.visible&&e.hasData()));if(!o||0===o.length)return s.bindVAO(),s.setStencilTestEnabled(!0),void s.setBlendingEnabled(!0);for(const t of o)t.triangleCount=0;s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(h.StencilOperation.KEEP,h.StencilOperation.KEEP,h.StencilOperation.REPLACE),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(h.CompareFunction.LEQUAL),s.setClearDepth(1),s.clear(s.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let t=r.length-1;t>=0;t--)this._renderStyleLayer(r[t],e,o);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(n),s.setBlendFunctionSeparate(h.BlendFactor.ONE,h.BlendFactor.ONE_MINUS_SRC_ALPHA,h.BlendFactor.ONE,h.BlendFactor.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let t=0;t<r.length;t++)this._renderStyleLayer(r[t],e,o);s.bindVAO(),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!0)},p._fade=function(e,t){null!=this._symbolFader&&(this._symbolFader.update(e,t)||this.requestRender())},p._renderStyleLayer=function(e,t,s){const{painter:i,renderPass:r}=t;if(void 0===e)return;const l=e.getLayoutProperty("visibility");if(l&&l.getValue()===n.Visibility.NONE)return;let o;switch(e.type){case n.StyleLayerType.BACKGROUND:return;case n.StyleLayerType.FILL:if("opaque"!==r&&"translucent"!==t.renderPass)return;o="vtlFill";break;case n.StyleLayerType.LINE:if("translucent"!==r)return;o="vtlLine";break;case n.StyleLayerType.CIRCLE:if("translucent"!==r)return;o="vtlCircle";break;case n.StyleLayerType.SYMBOL:if("translucent"!==r)return;o="vtlSymbol"}if(s=e.type===n.StyleLayerType.SYMBOL?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==o){const i=t.displayLevel;if(0===s.length||void 0!==e.minzoom&&e.minzoom>=i+y||void 0!==e.maxzoom&&e.maxzoom<i-y)return}const a=e.uid;t.styleLayerUID=a,t.styleLayer=e;for(const n of s)if(n.layerData.has(a)){i.renderObjects(t,s,o);break}},p._renderBackgroundLayers=function(e,t){const{context:s,displayLevel:r,painter:a,state:y}=e,p=this._styleRepository;let f=!1;for(const i of t){if(p.getLayerById(i).type===n.StyleLayerType.BACKGROUND&&u(p.getLayerById(i),r)){f=!0;break}}if(!f)return;const _=this._tileInfoView.getTileCoverage(e.state,0,!0,"smallest"),{spans:g,lodInfo:b}=_,{level:m}=b,T=i.create(),L=[];if(this._renderPasses){const t=this._renderPasses[0];null!=this._clippingInfos&&(t.brushes[0].prepareState(e),t.brushes[0].drawMany(e,this._clippingInfos))}const S=this._backgroundTiles;let P,C=0;for(const{row:n,colFrom:l,colTo:d}of g)for(let e=l;e<=d;e++){if(C<S.length)P=S[C],P.key.set(m,n,b.normalizeCol(e),b.getWorldForColumn(e)),this._tileInfoView.getTileBounds(T,P.key,!1),P.x=T[0],P.y=T[3],P.resolution=this._tileInfoView.getTileResolution(m);else{const t=new c(m,n,b.normalizeCol(e),b.getWorldForColumn(e)),s=this._tileInfoView.getTileBounds(i.create(),t),r=this._tileInfoView.getTileResolution(m);P=new o.RenderableTile(t,r,s[0],s[3],512,512,4096,4096),S.push(P)}P.setTransform(y),L.push(P),C++}s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(h.StencilOperation.KEEP,h.StencilOperation.KEEP,h.StencilOperation.REPLACE),s.setStencilFunction(h.CompareFunction.EQUAL,0,255);let E=!0;e.drawPhase===l.WGLDrawPhase.HITTEST&&(E=!1),s.setStencilTestEnabled(E);for(const i of t){const t=p.getLayerById(i);t.type===n.StyleLayerType.BACKGROUND&&u(t,r)&&(e.styleLayerUID=t.uid,e.styleLayer=t,a.renderObjects(e,L,"vtlBackground"))}d.pool.release(_)},t._createClass(a)}(a);e.VectorTileContainer=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
