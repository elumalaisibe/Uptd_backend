/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/workers/workers","./GlyphMosaic","./GlyphSource","./SpriteMosaic","../../tiling/TileKey"],(function(t,e,r,s,i,o,n,l,a,c){"use strict";let u=function(){function t(t,e,r){this._layer=t,this._styleRepository=e,this.devicePixelRatio=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}var u=t.prototype;return u.destroy=function(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=r.abortMaybe(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null},u.start=async function(t){this._requestSprite(t);const e=this._layer.currentStyleInfo.glyphsUrl,r=new l(e?i.addQueryParameters(e,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new n(1024,1024,r),this._broadcastPromise=o.open("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then((e=>{if(this._layer&&(this._connection?.close(),this._connection=e,this._layer&&!this._connection.closed)){const r=e.broadcast("setStyle",this._layer.currentStyleInfo.style,t);Promise.all(r).catch((t=>s.throwIfNotAbortError(t)))}}))},u._requestSprite=function(t){this._spriteSourceAbortController?.abort();const e=new AbortController;this._spriteSourceAbortController=e;const r=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,r&&(this._inputSignalEventListener=h(e),r.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:i}=e,o={...t,signal:i};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,o),this._spriteSourcePromise.then((t=>{s.throwIfAbortError(i),this._spriteMosaic=new a(1024,1024,250),this._spriteMosaic.setSpriteSource(t)}))},u.updateStyle=async function(t){return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),this._broadcastPromise},u.setSpriteSource=function(t){const e=new a(1024,1024,250);return e.setSpriteSource(t),this._spriteMosaic=e,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,e},u.setStyle=async function(t,e){await this._broadcastPromise,this._styleRepository=t,this._requestSprite();const r=new l(this._layer.currentStyleInfo.glyphsUrl?i.addQueryParameters(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new n(1024,1024,r),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",e)),this._broadcastPromise},u.fetchTileData=function(t,e){return this._getRefKeys(t,e).then((t=>{const r=this._layer.sourceNameToSource,s=[];for(const e in r)s.push(e);return this._getSourcesData(s,t,e)}))},u.parseTileData=function(t,e){const r=t&&t.data;if(!r)return Promise.resolve(null);const{sourceName2DataAndRefKey:s,transferList:i}=r;return 0===Object.keys(s).length?Promise.resolve(null):this._broadcastPromise.then((()=>this._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:s,styleLayerUIDs:t.styleLayerUIDs},{...e,transferList:i})))},u.getSprites=async function(t){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(t)},u.getGlyphs=function(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)},u._getTilePayload=async function(t,e,r){const i=c.pool.acquire(t.id),o=this._layer.sourceNameToSource[e],{level:n,row:l,col:a}=i;c.pool.release(i);try{return{protobuff:await o.requestTile(n,l,a,r),sourceName:e}}catch(u){if(s.isAbortError(u))throw u;return{protobuff:null,sourceName:e}}},u._getRefKeys=function(t,e){const r=this._layer.sourceNameToSource,i=new Array;for(const s in r){const o=r[s].getRefKey(t,e);i.push(o)}return s.eachAlways(i)},u._getSourcesData=function(t,e,r){const i=[];for(let s=0;s<e.length;s++)if(null==e[s].value||null==t[s])i.push(null);else{const o=this._getTilePayload(e[s].value,t[s],r);i.push(o)}return s.eachAlways(i).then((t=>{const r={},s=[];for(let i=0;i<t.length;i++){const o=t[i].value;if(o&&(o.protobuff&&o.protobuff.byteLength>0)){const t=e[i].value.id;r[o.sourceName]={refKey:t,protobuff:o.protobuff},s.push(o.protobuff)}}return{sourceName2DataAndRefKey:r,transferList:s}}))},e._createClass(t,[{key:"spriteMosaic",get:function(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}},{key:"glyphMosaic",get:function(){return this._glyphMosaic}}]),t}();function h(t){return()=>t.abort()}t.TileHandler=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
