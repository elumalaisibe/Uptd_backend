/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/has","../../../../chunks/mat3","../../../../chunks/mat3f32","../../../../chunks/vec2f32","../../../../layers/support/rasterFunctions/vectorFieldUtils","../DisplayObject","../webgl/Utils","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject"],(function(e,t,a,s,r,i,o,n,l,c,u,h){"use strict";let d=function(e){function a(t=null){var a;return(a=e.call(this)||this)._source=null,a._symbolizerParameters=null,a._vaoInvalidated=!0,a.coordScale=[1,1],a.height=null,a.key=null,a.offset=null,a.stencilRef=0,a.resolution=null,a.pixelRatio=1,a.x=0,a.y=0,a.rotation=0,a.rawPixelData=null,a.vaoData=null,a.width=null,a.source=t,a}t._inherits(a,e);var n=a.prototype;return n.destroy=function(){null!=this.vaoData&&(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null)},n.invalidateVAO=function(){this._vaoInvalidated||null==this.vaoData||(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())},n.updateVectorFieldVAO=function(e){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,null!=this.source&&null==this.vaoData){const{style:t}=this.symbolizerParameters;switch(t){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const t=o.createVFMesh(this.source,this.symbolizerParameters),a=this._createVectorFieldVAO(e.context,t);this.vaoData={magdir:a}}break;case"simple_scalar":{const t=o.createVFMeshScalar(this.source,this.symbolizerParameters),a=this._createVectorFieldVAO(e.context,t);this.vaoData={scalar:a}}break;case"wind_speed":{const t=o.createVFMesh(this.source,this.symbolizerParameters),a=this._createVectorFieldVAO(e.context,t),s=o.createVFMeshScalar(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(e.context,s);this.vaoData={magdir:a,scalar:r}}}}this.ready(),this.requestRender()}},n._createTransforms=function(){return{dvs:r.create()}},n.setTransform=function(e){const t=s.identity(this.transforms.dvs),[a,r]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.resolution/this.pixelRatio/e.resolution,n=o*this.width,l=o*this.height,c=Math.PI*this.rotation/180;s.translate(t,t,i.fromValues(a,r)),s.translate(t,t,i.fromValues(n/2,l/2)),s.rotate(t,t,-c),s.translate(t,t,i.fromValues(-n/2,-l/2)),s.scaleByVec2(t,t,i.fromValues(n,l)),s.multiply(this.transforms.dvs,e.displayViewMat3,t)},n.onAttach=function(){this.invalidateVAO()},n.onDetach=function(){this.invalidateVAO()},n._createVectorFieldVAO=function(e,t){const{vertexData:a,indexData:s}=t,r=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Float32Array(a)),i=c.BufferObject.createIndex(e,u.Usage.STATIC_DRAW,new Uint32Array(s)),o=l.createProgramDescriptor("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:u.DataType.FLOAT,normalized:!1},{location:1,name:"a_offset",count:2,type:u.DataType.FLOAT,normalized:!1},{location:2,name:"a_vv",count:2,type:u.DataType.FLOAT,normalized:!1}]});return{vao:new h.VertexArrayObject(e,o.attributes,o.bufferLayouts,{geometry:r},i),elementCount:s.length}},t._createClass(a,[{key:"symbolizerParameters",get:function(){return this._symbolizerParameters},set:function(e){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(e)&&(this._symbolizerParameters=e,this.invalidateVAO())}},{key:"source",get:function(){return this._source},set:function(e){this._source=e,this.invalidateVAO()}}]),a}(n.DisplayObject);e.RasterVFDisplayObject=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
