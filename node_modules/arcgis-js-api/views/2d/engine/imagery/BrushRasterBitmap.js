/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","./RasterBitmap","./colorizer/rasterColorizer","./processor/rasterProcessor","../webgl/definitions","../webgl/VertexStream","../webgl/brushes/WGLBrush","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/rasterUtils"],(function(e,t,r,n,s,i,o,a,c,d,u){"use strict";let f=function(a){function f(){var e;return(e=a.apply(this,arguments)||this).name="raster",e._quad=null,e._rendererUniformInfos=new Map,e._fbo=null,e}e._inherits(f,a);var m=f.prototype;return m.dispose=function(){t.disposeMaybe(this._quad),t.disposeMaybe(this._fbo)},m.prepareState=function(e){const{context:t,renderPass:r}=e,n="raster"===r;t.setBlendingEnabled(!n),t.setBlendFunctionSeparate(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA,c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!n)},m.draw=function(e,t){if(!r.hasSource(t)||t.suspended)return;const{renderPass:n}=e;if("raster-bitmap"!==n)return"raster"===n?this._process(e,t):void this._drawBitmap(e,t,!0);this._drawBitmap(e,t)},m._process=function(e,r){const{rasterFunction:n}=e,i="Reproject"===n.name;if(!(i?!(r.rasterTexture&&r.projected):!r.processed))return;const{timeline:o,context:a}=e;o.begin(this.name);const d=a.getBoundFramebufferObject(),u=a.getViewport();i||(r.processedTexture=t.disposeMaybe(r.processedTexture)),a.setStencilFunction(c.CompareFunction.EQUAL,r.stencilRef,255),r.updateTexture(e),this._initQuad(a);const{isStandardRasterTileSize:f,fbo:m}=this._getRasterFBO(a,r.width,r.height);s.process(e,this._quad,m,r),f||m.dispose(),a.bindFramebuffer(d),a.setViewport(u.x,u.y,u.width,u.height),o.end(this.name)},m._drawBitmap=function(e,t,r=!1){const{timeline:s,context:i}=e;if(s.begin(this.name),i.setStencilFunction(c.CompareFunction.EQUAL,t.stencilRef,255),t.updateTexture(e),r&&!t.processedTexture){if(t.updateProcessedTexture(),!t.processedTexture)return void s.end(this.name);t.processed=!0}this._initBitmapCommonUniforms(t);const a=t.symbolizerParameters.type,d=n.getColorizer(a),{requestRender:u,allowDelayedRender:f}=e,{defines:m,program:l}=d.createProgram(e,t,r);if(f&&null!=u&&!l.compiled)return void u();i.useProgram(l);const h=this._getUniformInfos(a,i,l,m);this._quad||(this._quad=new o(i,[0,0,1,0,0,1,1,1])),d.bindTextureAndUniforms(e,l,t,h,r),this._quad.draw(),s.end(this.name)},m._initBitmapCommonUniforms=function(e){if(!e.commonUniforms){const t=u.getBasicGridUniforms(1,[0,0]),{transformGrid:r,width:n,height:s}=e,i=u.getCommonUniforms(r,[n,s],[e.source.width,e.source.height],1,!1);e.commonUniforms={...t,...i,u_coordScale:e.coordScale}}},m._getRasterFBO=function(e,t,r){const n=t===i.TILE_SIZE||r===i.TILE_SIZE;return n?(this._fbo||(this._fbo=this._createNewFBO(e,t,r)),{isStandardRasterTileSize:n,fbo:this._fbo}):{isStandardRasterTileSize:n,fbo:this._createNewFBO(e,t,r)}},m._createNewFBO=function(e,t,r){const n=s.createTextureDescriptor(e,t,r);return new d.FramebufferObject(e,n)},m._initQuad=function(e){this._quad||(this._quad=new o(e,[0,0,1,0,0,1,1,1]))},m._getUniformInfos=function(e,t,r,n){const s=n.length>0?e+"-"+n.join("-"):e;if(this._rendererUniformInfos.has(s))return this._rendererUniformInfos.get(s);const i=u.getUniformLocationInfos(t,r);return this._rendererUniformInfos.set(s,i),i},e._createClass(f)}(a);return f}));
