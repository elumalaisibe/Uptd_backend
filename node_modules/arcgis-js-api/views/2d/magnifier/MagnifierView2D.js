/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../request","../../../core/asyncUtils","../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/urlUtils","../../../chunks/mat3f32","../engine/DisplayObject","../engine/webgl/DefaultVertexAttributeLayouts","../engine/webgl/enums","../engine/webgl/shaders/MagnifierPrograms","../../magnifier/resources","../../webgl/BufferObject","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor","../../webgl/VertexArrayObject"],(function(e,t,r,s,i,a,n,o,l,u,c,h,d,_,m,g,p,f,b){"use strict";return function(u){function x(){var e;return(e=u.call(this)||this)._handles=new s,e._resourcePixelRatio=1,e.visible=!1,e}e._inherits(x,u);var y=x.prototype;return y.destroy=function(){this._handles=a.destroyMaybe(this._handles),this._disposeRenderResources(),this._resourcesTask=a.abortMaybe(this._resourcesTask)},y._createTransforms=function(){return{dvs:l.create()}},y.doRender=function(e){const t=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==h.WGLDrawPhase.MAP||!this._canRender())return;this._updateResources(e);const r=this._magnifier;if(null==r.position)return;const s=e.pixelRatio,a=r.size*s,n=1/r.factor,o=Math.ceil(n*a);this._readbackTexture.resize(o,o);const{size:l}=e.state,u=s*l[0],c=s*l[1],d=.5*o,_=.5*o,m=i.clamp(s*r.position.x,d,u-d-1),p=i.clamp(c-s*r.position.y,_,c-_-1);t.setBlendingEnabled(!0);const f=m-d,b=p-_,x=this._readbackTexture;t.bindTexture(x,0),t.gl.copyTexImage2D(x.descriptor.target,0,x.descriptor.pixelFormat,f,b,o,o,0);const y=this.backgroundColor,T=y?[y.a*y.r/255,y.a*y.g/255,y.a*y.b/255,y.a]:[1,1,1,1],k=(m+r.offset.x*s)/u*2-1,R=(p-r.offset.y*s)/c*2-1,v=a/u*2,w=a/c*2,A=this._program;t.bindVAO(this._vertexArrayObject),t.bindTexture(this._overlayTexture,6),t.bindTexture(this._maskTexture,7),t.useProgram(A),A.setUniform4fv("u_background",T),A.setUniform1i("u_readbackTexture",0),A.setUniform1i("u_overlayTexture",6),A.setUniform1i("u_maskTexture",7),A.setUniform4f("u_drawPos",k,R,v,w),A.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),A.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawArrays(g.PrimitiveType.TRIANGLE_STRIP,0,4),t.bindVAO()},y._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier},y._reloadResources=function(){this._resourcesTask&&this._resourcesTask.abort();const e=null!=this._magnifier?this._magnifier.maskUrl:null,s=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=r.createTask((async r=>{const i=null==e||null==s?_.loadMagnifierResources(r):null,a=null!=e?t(e,{responseType:"image",signal:r}).then((e=>e.data)):i.then((e=>e.mask)),n=null!=s?t(s,{responseType:"image",signal:r}).then((e=>e.data)):i.then((e=>e.overlay)),[o,l]=await Promise.all([a,n]);this.mask=o,this.overlay=l,this._disposeRenderResources(),this.requestRender()}))},y._disposeRenderResources=function(){this._readbackTexture=a.disposeMaybe(this._readbackTexture),this._overlayTexture=a.disposeMaybe(this._overlayTexture),this._maskTexture=a.disposeMaybe(this._maskTexture),this._vertexArrayObject=a.disposeMaybe(this._vertexArrayObject),this._program=a.disposeMaybe(this._program)},y._updateResources=function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const r=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=d.createMagnifierProgram(t);const s=new Uint16Array([0,1,0,0,1,1,1,0]),i=d.magnifierProgramTemplate.attributes;this._vertexArrayObject=new b.VertexArrayObject(t,i,c.Pos2us,{geometry:m.BufferObject.createVertex(t,g.Usage.STATIC_DRAW,s)}),this.overlay.width=r,this.overlay.height=r;const a=new f.TextureDescriptor;a.internalFormat=g.PixelFormat.RGBA,a.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,a.samplingMode=g.TextureSamplingMode.NEAREST,a.flipped=!0,a.preMultiplyAlpha=!o.isSVG(this.overlay.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new p.Texture(t,a,this.overlay),this.mask.width=r,this.mask.height=r,a.pixelFormat=a.internalFormat=g.PixelFormat.ALPHA,this._maskTexture=new p.Texture(t,a,this.mask);const n=1/this._magnifier.factor;a.pixelFormat=a.internalFormat=g.PixelFormat.RGBA,a.width=a.height=Math.ceil(n*r),a.samplingMode=g.TextureSamplingMode.LINEAR,a.flipped=!1,this._readbackTexture=new p.Texture(t,a)},e._createClass(x,[{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([n.watch((()=>e.version),(()=>{this.visible=e.visible&&null!=e.position&&e.size>0,this.requestRender()}),n.initial),n.watch((()=>[e.maskUrl,e.overlayUrl]),(()=>this._reloadResources())),n.watch((()=>e.size),(()=>{this._disposeRenderResources(),this.requestRender()}))])}}]),x}(u.DisplayObject)}));
