/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","./ControlPointsTransformTool","./TransformTool"],(function(o,t,e,r,a,s,n,i,d,l,c,h){"use strict";const T={redo:"r",undo:"z"};o.MediaTransformToolsWrapper=function(o){function e(t){var e;return(e=o.call(this,t)||this)._transformTool=null,e._controlPointsTransformTool=null,e._advancedModeTransformTool=null,e._activeTool=null,e._sharedUndoStack=[],e._sharedRedoStack=[],e._originalOpacity=null,e.activeHandle=0,e}t._inherits(e,o);var r=e.prototype;return r.initialize=function(){const{view:o,mediaElement:t,preserveAspectRatio:e,snapRotation:r,advancedMode:s}=this;this._originalOpacity=t.opacity,this._transformTool=new h.TransformTool({target:t,view:o,preserveAspectRatio:e,snapRotation:r}),this._controlPointsTransformTool=new c.ControlPointsTransformTool({mediaElement:t,view:o}),this._advancedModeTransformTool=new c.ControlPointsTransformTool({mediaElement:s.mediaElement,view:s.view}),this._transformTool.setSharedUndoStack(this._sharedUndoStack),this._transformTool.setSharedRedoStack(this._sharedRedoStack),this._controlPointsTransformTool.setSharedUndoStack(this._sharedUndoStack),this._controlPointsTransformTool.setSharedRedoStack(this._sharedRedoStack),this._advancedModeTransformTool.setSharedUndoStack(this._sharedUndoStack),this._advancedModeTransformTool.setSharedRedoStack(this._sharedRedoStack);const n=t.georeference,i=s.mediaElement.georeference;s.view.tools.addMany([this._advancedModeTransformTool]),"controlPoints"in i&&"controlPoints"in n&&this.addHandles([s.view.on("key-down",(o=>{o.key===T.undo&&this.canUndo()&&(this.undo(),o.stopPropagation()),o.key===T.redo&&this.canRedo()&&(this.redo(),o.stopPropagation())})),s.view.on("focus",(async o=>{this._controlPointsTransformTool.removeHighlightActiveHandle(),this._advancedModeTransformTool.highlightActiveHandle()})),a.watch((()=>i.controlPoints),(o=>{n.controlPoints=o.map((({sourcePoint:o},t)=>({sourcePoint:o,mapPoint:n.controlPoints[t].mapPoint}))),this._activeTool?.refresh()})),a.watch((()=>this._controlPointsTransformTool.activeHandle),(o=>{this._advancedModeTransformTool.updateActiveHandle(o),this.activeHandle=o})),a.watch((()=>this._advancedModeTransformTool.activeHandle),(o=>{this._controlPointsTransformTool.updateActiveHandle(o),this.activeHandle=o}))]),this.addHandles([o.on("key-down",(o=>{o.key===T.undo&&this.canUndo()&&(this.undo(),o.stopPropagation()),o.key===T.redo&&this.canRedo()&&(this.redo(),o.stopPropagation())})),o.on("focus",(async o=>{this._advancedModeTransformTool.removeHighlightActiveHandle(),this._controlPointsTransformTool.highlightActiveHandle()}))]),o.tools.addMany([this._transformTool,this._controlPointsTransformTool]),o.activeTool=this._transformTool,this._activeTool=this._transformTool,o.focus()},r.destroy=function(){this._transformTool?.destroy(),this._controlPointsTransformTool?.destroy(),this._transformTool=null,this._controlPointsTransformTool=null,this._advancedModeTransformTool=null,this._activeTool=null,this._sharedUndoStack=null,this._sharedRedoStack=null},r.canUndo=function(){return this._sharedUndoStack.length>0},r.canRedo=function(){return this._sharedRedoStack.length>0},r.undo=function(){if(this._sharedUndoStack.length>0){const{tool:o,operation:t}=this._sharedUndoStack.pop();o!==this._activeTool&&o.refresh(),t.undo(),o.updateGraphics(),this._sharedRedoStack.push({tool:o,operation:t}),this._activeTool!==o&&this._activeTool?.refresh()}},r.redo=function(){if(this._sharedRedoStack.length>0){const{tool:o,operation:t}=this._sharedRedoStack.pop();o!==this._activeTool&&o.refresh(),t.apply(),o.updateGraphics(),this._sharedUndoStack.push({tool:o,operation:t}),this._activeTool!==o&&this._activeTool?.refresh()}},r.refresh=function(){this._activeTool.refresh()},r.reset=function(){this._activeTool.reset(),this._advancedModeTransformTool.reset()},r.enableAdvancedMode=async function(){this.view.activeTool=this._controlPointsTransformTool,this._activeTool=this._controlPointsTransformTool,this._activeTool.refresh(),await this.advancedMode.view.when(),this.advancedMode.view.activeTool=this._advancedModeTransformTool,this._originalOpacity=this._controlPointsTransformTool.mediaElement.opacity,this._controlPointsTransformTool.mediaElement.opacity=.25*this._originalOpacity},r.disableAdvancedMode=function(){this.view.activeTool=this._transformTool,this._activeTool=this._transformTool,this._activeTool.refresh(),this.advancedMode.view.activeTool=null,this._controlPointsTransformTool.mediaElement.opacity=this._originalOpacity},t._createClass(e)}(r),e.__decorate([s.property()],o.MediaTransformToolsWrapper.prototype,"activeHandle",void 0),e.__decorate([s.property({constructOnly:!0})],o.MediaTransformToolsWrapper.prototype,"advancedMode",void 0),e.__decorate([s.property()],o.MediaTransformToolsWrapper.prototype,"preserveAspectRatio",void 0),e.__decorate([s.property()],o.MediaTransformToolsWrapper.prototype,"snapRotation",void 0),e.__decorate([s.property({constructOnly:!0,nonNullable:!0})],o.MediaTransformToolsWrapper.prototype,"mediaElement",void 0),e.__decorate([s.property({constructOnly:!0})],o.MediaTransformToolsWrapper.prototype,"view",void 0),o.MediaTransformToolsWrapper=e.__decorate([l.subclass("esri.views.2d.interactive.editingTools.MediaTransformToolsWrapper")],o.MediaTransformToolsWrapper),o.KEYS=T,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
