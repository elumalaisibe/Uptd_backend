/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../geometry/support/spatialReferenceUtils","./LODInfo","./TileCoverage","./TileKey","./TileSpan"],(function(e,t,o,l,n,i){"use strict";const s=new n("0/0/0/0");let r=function(){function t(e,t,o,l,n,i,s,r){this.x=e,this.ymin=t,this.ymax=o,this.invM=l,this.leftAdjust=n,this.rightAdjust=i,this.leftBound=s,this.rightBound=r}t.create=function(e,o){e[1]>o[1]&&([e,o]=[o,e]);const[l,n]=e,[i,s]=o,r=i-l,c=s-n,a=0!==c?r/c:0,f=(Math.ceil(n)-n)*a,h=(Math.floor(n)-n)*a;return new t(l,Math.floor(n),Math.ceil(s),a,r<0?f:h,r<0?h:f,r<0?i:l,r<0?l:i)};var o=t.prototype;return o.incrRow=function(){this.x+=this.invM},o.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},o.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},e._createClass(t)}();const c=[[0,0],[0,0],[0,0],[0,0]],a=1e-6;return function(){function n(e,t=null,l=e.lods[0].level,n=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=t,this.scales=[],this._infoByScale={},this._infoByLevel={};const i=e.lods.filter((e=>e.level>=l&&e.level<=n));this.minScale=i[0].scale,this.maxScale=i[i.length-1].scale;const s=this._lodInfos=i.map((l=>o.create(e,l,t)));i.forEach(((e,t)=>{this._infoByLevel[e.level]=s[t],this._infoByScale[e.scale]=s[t],this.scales[t]=e.scale}),this),this._wrap=e.isWrappable}var f=n.prototype;return f.getLODInfoAt=function(e){return this._infoByLevel["number"==typeof e?e:e.level]},f.getTileBounds=function(e,t,o=!1){s.set(t);const l=this._infoByLevel[s.level];return l?l.getTileBounds(e,s,o):e},f.getTileCoords=function(e,t,o=!1){s.set(t);const l=this._infoByLevel[s.level];return l?l.getTileCoords(e,s,o):e},f.getTileCoverage=function(e,t=192,o=!0,n="closest"){if(!o&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const s="closest"===n?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),a=l.pool.acquire(s),f=this._wrap;let h,u,g,m=1/0,d=-1/0;const v=a.spans;c[0][0]=c[0][1]=c[1][1]=c[3][0]=-t,c[1][0]=c[2][0]=e.size[0]+t,c[2][1]=c[3][1]=e.size[1]+t;for(const l of c)e.toMap(l,l),l[0]=s.getColumnForX(l[0]),l[1]=s.getRowForY(l[1]);const y=[];let _=3;for(let l=0;l<4;l++){if(c[l][1]===c[_][1]){_=l;continue}const e=r.create(c[l],c[_]);m=Math.min(e.ymin,m),d=Math.max(e.ymax,d),void 0===y[e.ymin]&&(y[e.ymin]=[]),y[e.ymin].push(e),_=l}if(null==m||null==d||d-m>100)return null;let p=[];for(h=m;h<d;){null!=y[h]&&(p=p.concat(y[h])),u=1/0,g=-1/0;for(let e=p.length-1;e>=0;e--){const t=p[e];u=Math.min(u,t.getLeftCol()),g=Math.max(g,t.getRightCol())}if(u=Math.floor(u),g=Math.floor(g),h>=s.first[1]&&h<=s.last[1])if(f)if(s.size[0]<s.worldSize[0]){const e=Math.floor(g/s.worldSize[0]);for(let t=Math.floor(u/s.worldSize[0]);t<=e;t++)v.push(new i(h,Math.max(s.getFirstColumnForWorld(t),u),Math.min(s.getLastColumnForWorld(t),g)))}else v.push(new i(h,u,g));else u>s.last[0]||g<s.first[0]||(u=Math.max(u,s.first[0]),g=Math.min(g,s.last[0]),v.push(new i(h,u,g)));h+=1;for(let e=p.length-1;e>=0;e--){const t=p[e];t.ymax>=h?t.incrRow():p.splice(e,1)}}return a},f.getTileParentId=function(e){s.set(e);const t=this._infoByLevel[s.level],o=this._lodInfos.indexOf(t)-1;return o<0?null:(this._getTileIdAtLOD(s,this._lodInfos[o],s),s.id)},f.getTileResolution=function(e){const t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1},f.getTileScale=function(e){const t=this._infoByLevel[e.level];return t?t.scale:-1},f.intersects=function(e,t){s.set(t);const o=this._infoByLevel[s.level],l=e.lodInfo;if(l.resolution>o.resolution){this._getTileIdAtLOD(s,l,s);const t=l.denormalizeCol(s.col,s.world);for(const o of e.spans)if(o.row===s.row&&o.colFrom<=t&&o.colTo>=t)return!0}if(l.resolution<o.resolution){const[t,n,i,r]=e.spans.reduce(((e,t)=>(e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e)),[1/0,-1/0,1/0,-1/0]),c=o.denormalizeCol(s.col,s.world),a=l.getColumnForX(o.getXForColumn(c)),f=l.getRowForY(o.getYForRow(s.row)),h=l.getColumnForX(o.getXForColumn(c+1))-1,u=l.getRowForY(o.getYForRow(s.row+1))-1;return!(a>r||h<i||f>n||u<t)}const n=l.denormalizeCol(s.col,s.world),i=e.spans.some((e=>e.row===s.row&&e.colFrom<=n&&e.colTo>=n));return i},f.normalizeBounds=function(e,o,l){if(e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],this._wrap){const o=t.getInfo(this.tileInfo.spatialReference),n=-l*(o.valid[1]-o.valid[0]);e[0]+=n,e[2]+=n}return e},f.getSmallestInfoForScale=function(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let o=1;o<t.length-1;o++)if(e>t[o]+a)return this._infoByScale[t[o-1]];return this._infoByScale[t[t.length-1]]},f.getClosestInfoForScale=function(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce(((t,o)=>Math.abs(o-e)<Math.abs(t-e)?o:t),t[0])),this._infoByScale[e]},f.scaleToLevel=function(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let o=t.length-1;o>=0;o--)if(e<t[o]){if(o===t.length-1)return this._infoByScale[t[t.length-1]].level;return this._infoByScale[t[o]].level+(t[o]-e)/(t[o]-t[o+1])}return this._infoByScale[t[0]].level},f.scaleToZoom=function(e){return this.tileInfo.scaleToZoom(e)},f._getTileIdAtLOD=function(e,t,o){const l=this._infoByLevel[o.level];return e.set(o),t.resolution<l.resolution?null:(t.resolution===l.resolution||(e.level=t.level,e.col=Math.floor(o.col*l.resolution/t.resolution+.01),e.row=Math.floor(o.row*l.resolution/t.resolution+.01)),e)},e._createClass(n,[{key:"spatialReference",get:function(){return this.tileInfo.spatialReference}}]),n}()}));
