/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../geometry/support/aaBoundingRect","./TileCache","./TileCoverage","./TileKey"],(function(e,i,t,s,l){"use strict";const o=new l(0,0,0,0),n=new Map,a=[],h=[];return function(){function l(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,null!=e.resampling&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new t(e.cacheSize,this.tileInfoView,(e=>{this.releaseTile(e)})))}var c=l.prototype;return c.destroy=function(){this.tileIndex.clear()},c.update=function(e){const{resampling:i,tileIndex:t}=this,{scale:l,center:c,resolution:r}=e.state,{minScale:f,maxScale:u}=this.tileInfoView,d=!e.stationary&&l>this._previousScale;if(this._previousScale=l,!i&&(l>f||l<u))return this.tiles.length=0,void this.clear();const y=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!y)return this.tiles.length=0,void this.clear();const{spans:p,lodInfo:g}=y,{level:I}=g;this.tiles.length=0,t.forEach((e=>e.visible=!0));let v=0,T=0;if(p.length>0)for(const{row:s,colFrom:a,colTo:h}of p)for(let e=a;e<=h;e++){v++;const i=o.set(I,s,g.normalizeCol(e),g.getWorldForColumn(e)).id;let l=t.get(i);if(l)l.isReady?(n.set(i,l),T++):d||this._addParentTile(i,n);else{if(this._tileCache?.has(i)){if(l=this._tileCache.pop(i),this.tileIndex.set(i,l),l.isReady){n.set(i,l),T++;continue}}else l=this.acquireTile(o),this.tileIndex.set(i,l);d||this._addParentTile(i,n)}}const _=T===v;for(const[s,C]of t){if(n.has(s))continue;o.set(s);const e=this.tileInfoView.intersects(y,o),i="purge"===this.cachePolicy?o.level!==I:o.level>I;!e||!d&&_?!i&&e||a.push(C):C.isReady?i&&"purge"===this.cachePolicy&&this._hasReadyAncestor(o,I)?a.push(C):h.push(C):i&&a.push(C)}for(const s of h)s.isReady&&n.set(s.key.id,s);for(const s of a)this._tileCache?this._tileCache.add(s):this.releaseTile(s),t.delete(s.key.id);for(const s of n.values())this.tiles.push(s);for(const s of t.values())n.has(s.key.id)||(s.visible=!1);this._tileCache?.prune(I,c,r),s.pool.release(y),h.length=0,a.length=0,n.clear()},c.clear=function(){const{tileIndex:e}=this;for(const i of e.values())this.releaseTile(i);e.clear()},c.refresh=function(e){for(const i of this.tileIndex.values())this.tiles.includes(i)?e(i):a.push(i);for(const i of a)this.releaseTile(i),this.tileIndex.delete(i.key.id);this._tileCache?.clear()},c.updateCacheSize=function(e){this._tileCache&&(this._tileCache.maxSize=e)},c._addParentTile=function(e,i){let t=e,s=null;for(;t=this.tileInfoView.getTileParentId(t),t;)if(this.tileIndex.has(t)){if(s=this.tileIndex.get(t),s?.isReady){i.has(s.key.id)||i.set(s.key.id,s);break}}else if(this._tileCache?.has(t)&&(s=this._tileCache.pop(t),this.tileIndex.set(t,s),s?.isReady)){i.has(s.key.id)||i.set(s.key.id,s);break}},c._hasReadyAncestor=function(e,t){const s=i.create();this.tileInfoView.getTileBounds(s,e,!0);for(const l of this.tileIndex.values())if(l.isReady&&l.key.level>=t&&l.key.level<e.level){const e=i.create();if(this.tileInfoView.getTileBounds(e,l.key,!0),i.contains(e,s))return!0}return!1},e._createClass(l)}()}));
