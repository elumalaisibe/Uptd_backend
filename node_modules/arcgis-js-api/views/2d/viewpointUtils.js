/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../Viewpoint","../../core/Collection","../../core/unitUtils","../../chunks/common","../../chunks/mat2d","../../chunks/mat2df64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/projection","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils"],(function(e,t,n,r,a,o,c,i,s,u,l,f,y,m,g){"use strict";const p=96,d=39.37,x=180/Math.PI;function h(e){return e.wkid?e:e.spatialReference||m.WGS84}function b(e,t){return t.type?i.set(e,t.x,t.y):i.copy(e,t)}function w(e){return r.getMetersPerUnitForSR(e)}function R(e,t){const n=Math.max(1,t[0]),r=Math.max(1,t[1]);return Math.max(e.width/n,e.height/r)*W(e.spatialReference)}async function S(e,t,r,a){let o,c;if(!e)return null;if(Array.isArray(e)&&!e.length)return null;if(n.isCollection(e)&&(e=e.toArray()),Array.isArray(e)&&e.length&&"object"==typeof e[0]){const n=e.every((e=>"attributes"in e)),o=e.some((e=>!e.geometry));let c=e;if(n&&o&&t&&t.allLayerViews){const n=new Map;for(const t of e){const e=t.layer,r=n.get(e)||[],a=t.attributes[e.objectIdField];null!=a&&r.push(a),n.set(e,r)}const r=[];n.forEach(((e,n)=>{const a=t.allLayerViews.find((e=>e.layer.id===n.id));if(a&&"queryFeatures"in a){const t=n.createQuery();t.objectIds=e,t.returnGeometry=!0,r.push(a.queryFeatures(t))}}));const a=await Promise.all(r),o=[];for(const e of a)if(e&&e.features&&e.features.length)for(const t of e.features)null!=t.geometry&&o.push(t.geometry);c=o}for(const e of c)a=await S(e,t,r,a);return a}if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])o=new f(e);else if(e instanceof l)o=e;else if("geometry"in e)if(e.geometry)o=e.geometry;else if(e.layer){const n=e.layer,r=t.allLayerViews.find((e=>e.layer.id===n.id));if(r&&"queryFeatures"in r){const t=n.createQuery();t.objectIds=[e.attributes[n.objectIdField]],t.returnGeometry=!0;const a=await r.queryFeatures(t);o=a?.features?.[0]?.geometry}}if(null==o)return null;if(c="point"===o.type?new u({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference}):o.extent,!c)return null;y.isLoaded()||y.canProjectWithoutEngine(c.spatialReference,r)||await y.load();const i=y.project(c,r);return i?a=a?a.union(i):i:null}function G(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale){const t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every((e=>"layer"in e))){let t=0,n=0;for(const r of e){const e=r.layer;e&&e.minScale&&e.maxScale&&(t=e.minScale<t?e.minScale:t,n=e.maxScale>n?e.maxScale:n)}return t&&n?{min:t,max:n}:null}}}function A(e,t){return g.equals(h(e),t)?e:y.project(e,t)}async function M(e,n){if(!e||!n)return new t({targetGeometry:new f,scale:0,rotation:0});let r=n.spatialReference;const{constraints:a,padding:o,viewpoint:c,size:i}=n,s=[o?i[0]-o.left-o.right:i[0],o?i[1]-o.top-o.bottom:i[1]];let l=null;e instanceof t?l=e:e.viewpoint?l=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(l=e.target);let m=null;l&&l.targetGeometry?m=l.targetGeometry:e instanceof u?m=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(m=await S(e.center,n,r)||await S(e.extent,n,r)||await S(e.target,n,r)||await S(e,n,r)),!m&&c&&c.targetGeometry?m=c.targetGeometry:!m&&n.extent&&(m=n.extent),r||(r=h(n.spatialReference||n.extent||m)),y.isLoaded()||g.equals(m.spatialReference,r)||y.canProjectWithoutEngine(m,r)||await y.load();const p=A(m.center??m,r);let d=0;if(l&&null!=l.targetGeometry&&"point"===l.targetGeometry.type)d=l.scale;else if("scale"in e&&e.scale)d=e.scale;else if("zoom"in e&&-1!==e.zoom&&a&&a.effectiveLODs)d=a.zoomToScale(e.zoom);else if(Array.isArray(m)||"point"===m.type||"extent"===m.type&&0===m.width&&0===m.height){const e=A(n.extent,r);d=null!=e?R(e,s):n.extent?R(n.extent,s):c.scale}else d=R(A(m.extent,r),s);const x=G(e);x&&(x.min&&x.min>d?d=x.min:x.max&&x.max<d&&(d=x.max));let b=0;l?b=l.rotation:e.hasOwnProperty("rotation")?b=e.rotation:c&&(b=c.rotation);let w=new t({targetGeometry:p,scale:d,rotation:b});return a&&(w=a.fit(w),a.constrainByGeometry(w),a.rotationEnabled||(w.rotation=b)),w}function k(e,t){const n=e.targetGeometry,r=t.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function j(e,t,n){return n?i.set(e,.5*(t[0]-n.right+n.left),.5*(t[1]-n.bottom+n.top)):i.scale(e,t,.5)}const v=function(){const e=s.create();return function(t,n,r){const a=n.targetGeometry;b(e,a);const o=.5*V(n);return t.xmin=e[0]-o*r[0],t.ymin=e[1]-o*r[1],t.xmax=e[0]+o*r[0],t.ymax=e[1]+o*r[1],t.spatialReference=a.spatialReference,t}}();function P(e,t,n,r,a){return D(e,t,n.center),e.scale=R(n,r),a?.constraints?.constrain(e),e}function T(e,t,n,r){return I(e,t,n,r),o.invert(e,e)}const z=function(){const e=s.create();return function(t,n,r){return i.sub(t,q(t,n),j(e,n,r))}}(),F=function(){const e=c.create(),t=s.create();return function(n,r,a,c){const s=V(r),u=N(r);return i.set(t,s,s),o.fromScaling(e,t),o.rotate(e,e,u),o.translate(e,e,z(t,a,c)),o.translate(e,e,[0,c.top-c.bottom]),i.set(n,e[4],e[5])}}();function V(e){return e.scale*E(e.targetGeometry)}function E(e){return null!=e&&g.isValid(e.spatialReference)?1/(w(e.spatialReference)*d*p):1}function N(e){return a.toRadian(e.rotation)||0}function W(e){return g.isValid(e)?w(e)*d*p:1}function q(e,t){return i.scale(e,t,.5)}const B=function(){const e=s.create(),t=s.create(),n=s.create();return function(r,a,c,s,u,l){return i.negate(e,a),i.scale(t,c,.5*l),i.set(n,1/s*l,-1/s*l),o.fromTranslation(r,t),u&&o.rotate(r,r,u),o.scale(r,r,n),o.translate(r,r,e),r}}(),I=function(){const e=s.create();return function(t,n,r,a){const o=V(n),c=N(n);return b(e,n.targetGeometry),B(t,e,r,o,c,a)}}(),L=function(){const e=s.create();return function(t,n,r,a){const o=V(n);return b(e,n.targetGeometry),B(t,e,r,o,0,a)}}();function C(e){const t=g.getInfo(e);return t?t.valid[1]-t.valid[0]:0}function O(e,t){return Math.round(C(e)/t)}const U=function(){const e=s.create(),t=s.create(),n=[0,0,0];return function(r,a,o){i.subtract(e,r,a),i.normalize(e,e),i.subtract(t,r,o),i.normalize(t,t),i.cross(n,e,t);let c=Math.acos(i.dot(e,t)/(i.length(e)*i.length(t)))*x;return n[2]<0&&(c=-c),isNaN(c)&&(c=0),c}}(),Q=function(){const e=s.create();return function(t,n,r,a){const o=t.targetGeometry;return k(t,n),F(e,n,r,a),o.x+=e[0],o.y+=e[1],t}}(),D=function(e,t,n){k(e,t);const r=e.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e},H=function(){const e=s.create();return function(t,n,r,a,o){o||(o="center"),i.sub(e,r,a),i.scale(e,e,.5);const c=e[0],s=e[1];switch(o){case"center":i.set(e,0,0);break;case"left":i.set(e,-c,0);break;case"top":i.set(e,0,s);break;case"right":i.set(e,c,0);break;case"bottom":i.set(e,0,-s);break;case"top-left":i.set(e,-c,s);break;case"bottom-left":i.set(e,-c,-s);break;case"top-right":i.set(e,c,s);break;case"bottom-right":i.set(e,c,-s)}return te(t,n,e),t}}();function J(e,t,n){return k(e,t),e.rotation+=n,e}function K(e,t,n){return k(e,t),e.rotation=n,e}const X=function(){const e=s.create();return function(t,n,r,a,o){return k(t,n),isNaN(r)||0===r||(_(e,a,n,o),t.scale=n.scale*r,ee(e,e,t,o),te(t,t,i.set(e,e[0]-a[0],a[1]-e[1]))),t}}();function Y(e,t,n){return k(e,t),e.scale=n,e}const Z=function(){const e=s.create();return function(t,n,r,a,o,c){return k(t,n),isNaN(r)||0===r||(_(e,o,n,c),t.scale=n.scale*r,t.rotation+=a,ee(e,e,t,c),te(t,t,i.set(e,e[0]-o[0],o[1]-e[1]))),t}}(),$=function(){const e=s.create(),t=s.create();return function(n,r,a,o,c,s,u){return z(t,s,u),i.add(e,c,t),o?Z(n,r,a,o,e,s):X(n,r,a,e,s)}}(),_=function(){const e=c.create();return function(t,n,r,a){return i.transformMat2d(t,n,T(e,r,a,1))}}(),ee=function(){const e=c.create();return function(t,n,r,a){return i.transformMat2d(t,n,I(e,r,a,1))}}(),te=function(){const e=s.create(),t=c.create();return function(n,r,a){k(n,r);const c=V(r),u=n.targetGeometry;return o.fromRotation(t,N(r)),o.scale(t,t,s.fromValues(c,c)),i.transformMat2d(e,a,t),u.x+=e[0],u.y+=e[1],n}}();e.addPadding=Q,e.angleBetween=U,e.centerAt=D,e.copy=k,e.create=M,e.extentToScale=R,e.getAnchor=j,e.getExtent=v,e.getMatrix=B,e.getPaddingMapTranslation=F,e.getPaddingScreenTranslation=z,e.getResolution=V,e.getResolutionToScaleFactor=W,e.getTransform=I,e.getTransformNoRotation=L,e.getWorldScreenWidth=O,e.getWorldWidth=C,e.padAndScaleAndRotateBy=$,e.resize=H,e.rotateBy=J,e.rotateTo=K,e.scaleAndRotateBy=Z,e.scaleTo=Y,e.setExtent=P,e.toMap=_,e.toScreen=ee,e.translateBy=te,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
