/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/support/heightModelInfoUtils","../ViewingMode","./projectionUtils"],(function(e,t,a,n,r,o,s,i,l,p,u,c,d,f,h){"use strict";e.DefaultsFromMap=function(e){function a(t){var a;return(a=e.call(this,t)||this).required={tileInfo:!1,heightModelInfo:!1,extent:!1},a.defaultSpatialReference=null,a.userSpatialReference=null,a.sourcePreloadCount=10,a.priorityCollection=null,a.requiresExtentInSpatialReference=!0,a.suspended=!1,a._projectExtentTask={task:null,input:null,output:null,spatialReference:null},a}t._inherits(a,e);var n=a.prototype;return n.destroy=function(){this._projectExtentTask.task&&(this._projectExtentTask.task=o.abortMaybe(this._projectExtentTask.task)),this._set("map",null)},n._narrowDownSpatialReferenceCandidates=function(e,t){if(null==e)return t;const a=[],n=(e,t)=>null!=e?null!=t?e===t&&e:e:t;for(const r of e)for(const e of t){if(!r.spatialReference.equals(e.spatialReference))continue;const t=n(r.viewingMode,e.viewingMode);if(!1!==t){a.push({spatialReference:r.spatialReference,viewingMode:t});break}}return a.length>0?a:null},n._pickSpatialReferenceCandidate=function(e){const t=this.defaultSpatialReference;return null==e||e.length<1?null!=t?{spatialReference:t,viewingMode:null}:null:(null!=t&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==f.ViewingMode.Local))&&(e=e.filter((({viewingMode:e})=>e!==f.ViewingMode.Local))),e[0])},n._getSupportedSpatialReferences=function(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const a=[];for(const n of t){const t=this.getSpatialReferenceSupport({spatialReference:n,layer:e});if(null!=t){const e=null!=t.constraints?t.constraints:[{spatialReference:n,viewingMode:null}];for(const{spatialReference:t,viewingMode:n}of e)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!t.equals(this.userSpatialReference)||a.push({spatialReference:t,viewingMode:n})}}return a},n._pickExtentCandidate=function(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]},n._collectLayers=function(e){if("loaded"!==this._loadMaybe(this.map?.()))return{layers:[],updating:!0};const t=new y;for(const a of e)if(this._collectCollection(a,t),t.preloading===this.sourcePreloadCount)break;return{layers:t.layers,updating:t.updating}},n._collectCollection=function(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const a of e.layers){switch(this._loadMaybe(a)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":t.updating||t.layers.push(a),"layers"in a&&this._collectCollection({layers:a.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}},n._loadMaybe=function(e){return e&&"loadStatus"in e&&null!=e.loadStatus?"not-loaded"===e.loadStatus?(e.load().catch((e=>{s.isAbortError(e)||console.log(e)})),"loading"):e.loadStatus:"loaded"},t._createClass(a,[{key:"ready",get:function(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}},{key:"heightModelInfoReady",get:function(){return!this._heightModelInfoTask.updating}},{key:"spatialReference",get:function(){return null!=this.userSpatialReference?this.userSpatialReference:this._spatialReferenceTask.spatialReference}},{key:"extent",get:function(){return this._extentTask.extent}},{key:"heightModelInfo",get:function(){return this._heightModelInfoTask.heightModelInfo}},{key:"vcsWkid",get:function(){return this._heightModelInfoTask.vcsWkid}},{key:"latestVcsWkid",get:function(){return this._heightModelInfoTask.latestVcsWkid}},{key:"viewingMode",get:function(){return null==this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}},{key:"tileInfo",get:function(){return this._tileInfoTask.tileInfo}},{key:"mapCollections",get:function(){const e=this.map?.(),t=[];return null!=this.priorityCollection&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}},{key:"_allLayers",get:function(){return this._collectLayers(this.mapCollections)}},{key:"_spatialReferenceTask",get:function(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;let a=null;for(const r of e){const e=this._getSupportedSpatialReferences(r);if(e.length>0){const t=this._narrowDownSpatialReferenceCandidates(a,e);null!=t&&(a=t)}if(null!=a&&1===a.length)break}if(t&&(null==a||1!==a.length))return{updating:!0};const n=this._pickSpatialReferenceCandidate(a);return{spatialReference:null!=n?n.spatialReference:null,viewingMode:null!=n?n.viewingMode:null,updating:!1}}},{key:"_tileInfoTask",get:function(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:t}=this._collectLayers([{parent:this.map?.()?.basemap,layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const t=e[0].tileInfo;return{tileInfo:t&&t.spatialReference.equals(this.spatialReference)?t:null,updating:!1}}return{updating:t}}},{key:"_heightModelInfoTask",get:function(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;for(const a of e)if(d.supportsHeightModelInfo(a)){const e=d.deriveHeightModelInfoFromLayer(a);if(e)return{heightModelInfo:e,vcsWkid:a.spatialReference?.vcsWkid,latestVcsWkid:a.spatialReference?.latestVcsWkid,updating:!1}}return{updating:t}}},{key:"_extentCandidatesTask",get:function(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,t=e.updating,a=[];for(const n of e.layers){const e="fullExtents"in n&&n.fullExtents||(null!=n.fullExtent?[n.fullExtent]:[]),t=this.requiresExtentInSpatialReference?null:e[0],r=e.find((e=>e.spatialReference.equals(this.spatialReference)))??t;if(r)return{candidates:[{extent:r,layer:n}],updating:!1};if(this._getSupportedSpatialReferences(n).length>0)for(const o of e)a.push({extent:o,layer:n})}return{candidates:a,updating:t}}},{key:"_extentTask",get:function(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(null==e||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const a=this._pickExtentCandidate(e),n=this.spatialReference;return a.extent.equals(this._projectExtentTask.input)&&n.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished}:(null!=this._projectExtentTask.task&&(this._projectExtentTask.task=o.abortMaybe(this._projectExtentTask.task)),this._projectExtentTask={input:a.extent.clone(),output:null,spatialReference:n.clone(),task:r.createTask((async e=>{try{const t=await h.projectWithEngineOrService(a.extent,n,"portalItem"in a.layer?a.layer.portalItem:void 0,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if(s.isAborted(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0})}}]),a}(n),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"required",void 0),a.__decorate([i.property({constructOnly:!0})],e.DefaultsFromMap.prototype,"map",void 0),a.__decorate([i.property({constructOnly:!0})],e.DefaultsFromMap.prototype,"getSpatialReferenceSupport",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"defaultSpatialReference",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"userSpatialReference",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"sourcePreloadCount",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"priorityCollection",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"requiresExtentInSpatialReference",void 0),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"suspended",void 0),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"ready",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"heightModelInfoReady",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"spatialReference",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"extent",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"heightModelInfo",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"vcsWkid",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"latestVcsWkid",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"viewingMode",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"tileInfo",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"mapCollections",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_allLayers",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_spatialReferenceTask",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_tileInfoTask",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_heightModelInfoTask",null),a.__decorate([i.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_extentCandidatesTask",null),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"_extentTask",null),a.__decorate([i.property()],e.DefaultsFromMap.prototype,"_projectExtentTask",void 0),e.DefaultsFromMap=a.__decorate([c.subclass("esri.views.support.DefaultsFromMap")],e.DefaultsFromMap);let y=t._createClass((function(){this.layers=new Array,this.preloading=-1,this.updating=!1}));Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
