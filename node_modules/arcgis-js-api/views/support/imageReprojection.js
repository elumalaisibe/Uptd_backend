/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../request","../../geometry/Point","../../geometry/projection","../../layers/support/rasterFunctions/rasterProjectionHelper","../2d/engine/Bitmap","../2d/engine/webgl/VertexStream","../2d/engine/webgl/shaders/MaterialPrograms","../webgl/enums","../webgl/FramebufferObject","../webgl/rasterUtils","../webgl/RenderingContext","../webgl/Texture","../webgl/TextureDescriptor"],(function(t,e,r,i,a,n,s,o,c,u,p,h,x,m,d){"use strict";let g=function(){function t(e){if(this._ownsRctx=!1,e)this._ownsRctx=!1,this._rctx=e;else{if(t._instance)return t._instanceRefCount++,t._instance;t._instanceRefCount=1,t._instance=this,this._ownsRctx=!0;const e=document.createElement("canvas").getContext("webgl");e.getExtension("OES_texture_float"),this._rctx=new x.RenderingContext(e,{})}const r={applyProjection:!0,bilinear:!1,bicubic:!1},i=c.createProgramTemplate("raster/reproject","raster/reproject",new Map([["a_position",0]]),r);this._program=this._rctx.programCache.acquire(i.shaders.vertexShader,i.shaders.fragmentShader,i.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new o(this._rctx,[0,0,1,0,0,1,1,1])}var g=t.prototype;return g.reprojectTexture=function(t,e,r=!1){const s=a.project(t.extent,e),o=new i({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:c,y:x}=n.projectResolution(o,e,t.extent);let m=(c+x)/2;const g=Math.round((s.xmax-s.xmin)/m),_=Math.round((s.ymax-s.ymin)/m);m=(s.width/g+s.height/_)/2;const f=new i({x:m,y:m,spatialReference:s.spatialReference}),l=n.getProjectionOffsetGrid({projectedExtent:s,srcBufferExtent:t.extent,pixelSize:f,hasWrapAround:!0,spacing:[16,16]}),w=h.createTransformTexture(this._rctx,l),b=new d.TextureDescriptor(g,_);b.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE;const T=new p.FramebufferObject(this._rctx,b);this._rctx.bindFramebuffer(T),this._rctx.setViewport(0,0,g,_),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(w,1),this._quad.bind();const{width:D=0,height:C=0}=t.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",D,C),this._program.setUniform2fv("u_transformSpacing",l.spacing),this._program.setUniform2fv("u_transformGridSize",l.size),this._program.setUniform2f("u_targetImageSize",g,_),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),w.dispose(),r){const{width:t,height:e}=T,r=new ImageData(t??0,e??0);T.readPixels(0,0,t??0,e??0,u.PixelFormat.RGBA,u.PixelType.UNSIGNED_BYTE,r.data);const i=T.detachColorTexture(u.ColorAttachment.COLOR_ATTACHMENT0);return T.dispose(),{texture:i,extent:s,imageData:r}}const R=T.detachColorTexture(u.ColorAttachment.COLOR_ATTACHMENT0);return T.dispose(),{texture:R,extent:s}},g.reprojectBitmapData=function(t,e){const r=s.isImageSource(t.bitmapData)?s.rasterize(t.bitmapData):t.bitmapData,i=new d.TextureDescriptor;i.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE,i.width=t.bitmapData.width,i.height=t.bitmapData.height;const a=new m.Texture(this._rctx,i,r),n=this.reprojectTexture({texture:a,extent:t.extent},e,!0);n.texture.dispose();const o=document.createElement("canvas"),c=n.imageData;o.width=c.width,o.height=c.height;return o.getContext("2d").putImageData(c,0,0),{bitmapData:o,extent:n.extent}},g.loadAndReprojectBitmapData=async function(t,e,i){const a=(await r(t,{responseType:"image"})).data,n=document.createElement("canvas");n.width=a.width,n.height=a.height;const s=n.getContext("2d");s.drawImage(a,0,0);const o=s.getImageData(0,0,n.width,n.height);if(e.spatialReference.equals(i))return{bitmapData:o,extent:e};const c=this.reprojectBitmapData({bitmapData:o,extent:e},i);return{bitmapData:c.bitmapData,extent:c.extent}},g.destroy=function(){this._ownsRctx?(t._instanceRefCount--,0===t._instanceRefCount&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),t._instance=null)):(this._quad.dispose(),this._program.dispose())},e._createClass(t)}();g._instanceRefCount=0,t.ImageReprojector=g,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
