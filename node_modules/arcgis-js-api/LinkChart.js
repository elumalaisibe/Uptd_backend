/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","./chunks/_rollupPluginBabelHelpers","./chunks/tslib.es6","./Map","./core/Error","./core/Loadable","./core/loadAll","./core/Logger","./core/MultiOriginJSONSupport","./core/Promise","./core/urlUtils","./core/Version","./core/accessorSupport/decorators/property","./core/accessorSupport/ensureType","./core/arrayUtils","./core/has","./core/accessorSupport/decorators/subclass","./core/accessorSupport/read","./linkchart/InitialViewProperties","./portal/Portal","./portal/PortalItem","./webmap/initialViewPropertiesUtils"],(function(t,e,r,o,i,a,s,l,n,c,p,h,d,u,y,m,_,P,S,O,g,f){"use strict";let w=function(r){function o(t){var e;return(e=r.call(this,t)||this).initialViewProperties=new S,e.portalItem=null,e}e._inherits(o,r);var a=o.prototype;return a.load=function(t){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)},a.destroy=function(){const t=this.portalItem;this.portalItem=null,t?.destroy()},a.initialize=function(){if(this.when().catch((t=>{l.getLogger(this).error("#load()","Failed to load link chart",t)})),this.sourceJSON){let e;try{e=this._validateJSON(this.sourceJSON)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(e)}},a.loadAll=function(){return s.loadAll(this,(t=>{t(this.ground,this.basemap,this.layers,this.tables)}))},a.read=function(t,r){r={...r,origin:"link-chart"},P.readLoadable(this,t,(r=>e._get(e._getPrototypeOf(o.prototype),"read",this).call(this,t,r)),r)},a._loadFromSource=function(){return this.sourceJSON?this._loadFromJSON(this.sourceJSON,{origin:"link-chart"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):Promise.resolve()},a._loadFromJSON=function(e,r){const o={context:{...r,layerContainerType:"operational-layers"}};return this.portalItem&&(o.context.portal=this.portalItem.portal||O.getDefault()),new Promise(((e,r)=>t(["./layers/support/layersCreator"],e,r))).then((({populateOperationalLayers:t})=>{const r=[],i=e.operationalLayers;i&&i.length&&r.push(t(this.layers,i,o));const a={...o,context:{...o.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},s=e.tables;return s&&s.length&&r.push(t(this.tables,s,a)),Promise.allSettled(r).then((()=>{}))}))},a._loadFromItem=async function(t){if(await t.load().catch((t=>{throw new i("linkchart:load-portal-item","Failed to load portal item",{error:t})})),t.type!==this.constructor.PORTAL_ITEM_TYPE)throw new i("linkchart:invalid-portal-item",`Invalid portal item type '${t.type}', expected '${this.constructor.PORTAL_ITEM_TYPE}'`,{type:t.type});const e=await t.fetchData();this.sourceJSON=e;const r={origin:"link-chart",url:p.urlToObject(t.itemUrl),portal:t.portal||O.getDefault(),portalItem:t,readResourcePaths:[]};await this._readAndLoadFromJSON(e,r);const o=await f.computeInitialViewpoint(this.initialViewProperties,t,l.getLogger(this));if(o){const t=this.initialViewProperties?.clone()??new S;t.viewpoint=o,this.initialViewProperties=t}},a._readAndLoadFromJSON=function(t,e){const r=this._validateJSON(t);return this.read(r,e),this._loadFromJSON(r,e)},a._validateJSON=function(t){const e=h.Version.parse(t.version||"","linkchart");return this.constructor.VERSION.validate(e),t.version=`${e.major}.${e.minor}`,t},e._createClass(o)}(n.MultiOriginJSONMixin(a.LoadableMixin(c.EsriPromiseMixin(o))));w.PORTAL_ITEM_TYPE="Link Chart",w.VERSION=new h.Version(2,27),r.__decorate([d.property({type:S,nonNullable:!0,json:{read:{source:["background","initialState.viewpoint","mapRangeInfo","spatialReference"]}}})],w.prototype,"initialViewProperties",void 0),r.__decorate([d.property({json:{read:!1}})],w.prototype,"layers",void 0),r.__decorate([d.property()],w.prototype,"linkChartProperties",void 0),r.__decorate([d.property({type:g})],w.prototype,"portalItem",void 0),r.__decorate([d.property()],w.prototype,"sourceJSON",void 0),r.__decorate([d.property({json:{read:!1}})],w.prototype,"tables",void 0),w=r.__decorate([_.subclass("esri.LinkChart")],w);return w}));
