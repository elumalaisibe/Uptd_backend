/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Error","../core/HandleOwner","../core/Loadable","../core/Logger","../core/Promise","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","../chunks/vec3f64","./Extent","./Geometry","./Point","./Polygon","./support/axisAngleDegrees","./support/MeshComponent","./support/MeshGeoreferencedRelativeVertexSpace","./support/MeshGeoreferencedVertexSpace","./support/MeshLocalVertexSpace","./support/MeshTransform","./support/MeshVertexAttributes","./support/triangulationUtils","./support/meshUtils/bounds","./support/meshUtils/centerAt","./support/meshUtils/georeference","./support/meshUtils/loadExternal","./support/meshUtils/Metadata","./support/meshUtils/offset","./support/meshUtils/primitives","./support/meshUtils/rotate","./support/meshUtils/scale"],(function(e,t,r,n,o,s,i,a,c,p,l,u,h,d,f,m,g,x,y,v,S,w,b,_,P,M,A,U,E,F,L,R,z,C,G,O,k){"use strict";var j;const V="esri.geometry.Mesh",T={base:null,key:"type",defaultKeyValue:"georeferenced",typeMap:{georeferenced:_,"georeferenced-relative":b,local:P}};let B=j=function(r){function o(e){var t;return(t=r.call(this,e)||this).components=null,t.vertexSpace=new _,t.transform=null,t.metadata=new z.Metadata,t.hasZ=!0,t.hasM=!1,t.vertexAttributes=new A.MeshVertexAttributes,t.type="mesh",t}t._inherits(o,r);var s=o.prototype;return s.initialize=function(){(0===this.metadata.externalSources.length||this.vertexAttributes.position.length)&&(this.loadStatus="loaded"),this.when((()=>{this.handles.add(p.watch((()=>({vertexAttributes:this.vertexAttributes,components:this.components?.map((e=>e.clone()))})),(()=>this._clearSources()),{once:!0,sync:!0}))}))},s.addComponent=function(e){this.loaded?(this.components||(this.components=[]),this.components.push(w.from(e)),this.notifyChange("components")):i.getLogger(this).error("addComponent()","Mesh must be loaded before applying operations")},s.removeComponent=function(e){if(this.loaded){if(this.components){const t=this.components.indexOf(e);if(-1!==t)return this.components.splice(t,1),void this.notifyChange("components")}i.getLogger(this).error("removeComponent()","Provided component is not part of the list of components")}else i.getLogger(this).error("removeComponent()","Mesh must be loaded before applying operations")},s.rotate=function(e,t,r,n){return S.composeAxes(e,t,r,D),O.rotate(this,D,n),this},s.offset=function(e,t,r,n){return this.loaded?(W[0]=e,W[1]=t,W[2]=r,C.offset(this,W,n),this):(i.getLogger(this).error("offset()","Mesh must be loaded before applying operations"),this)},s.scale=function(e,t){return this.loaded?(k.scale(this,e,t),this):(i.getLogger(this).error("scale()","Mesh must be loaded before applying operations"),this)},s.centerAt=function(e,t){return this.loaded?(F.centerAt(this,e,t),this):(i.getLogger(this).error("centerAt()","Mesh must be loaded before applying operations"),this)},s.load=function(e){const{metadata:{displaySource:t}}=this;return t&&this.addResolvingPromise(R.loadExternal(this,t,e)),Promise.resolve(this)},s.addExternalSources=function(e){this.metadata.externalSources.addMany(e)},s.updateDisplaySource=function(e){this.metadata.displaySource=e},s.clone=function(){return this.cloneWithVertexSpace(this.vertexSpace.clone())},s.cloneWithVertexSpace=function(e){let t=null;if(this.components){const e=new Map,r=new Map;t=this.components.map((t=>t.cloneWithDeduplication(e,r)))}const r={components:t,spatialReference:this.spatialReference,vertexAttributes:this.vertexAttributes.clone(),vertexSpace:e,transform:this.transform?.clone()??null,metadata:this.metadata.clone()};return new j(r)},s.cloneShallow=function(){return new j({components:this.components,spatialReference:this.spatialReference,vertexAttributes:this.vertexAttributes,vertexSpace:this.vertexSpace.clone(),transform:this.transform,metadata:this.metadata})},s.vertexAttributesChanged=function(){this.notifyChange("vertexAttributes")},s.toBinaryGLTF=async function(t){const r=new Promise(((t,r)=>e(["./support/meshUtils/exporters/gltf/gltfexport"],t,r))),n=this.load(),o=await Promise.all([r,n]),{toBinaryGLTF:s}=o[0];return s(this,t)},s._clearSources=function(){this.metadata.clearSources()},o.createBox=function(e,t){if(!(e instanceof y))return i.getLogger(V).error(".createBox()","expected location to be a Point instance"),null;const r=new j(G.convertUnitGeometry(G.createUnitSizeBox(),e,t));return t&&t.imageFace&&"all"!==t.imageFace?G.extractSingleFaceOfBox(r,t.imageFace):r},o.createSphere=function(e,t){return e instanceof y?new j(G.convertUnitGeometry(G.createUnitSizeSphere(t&&t.densificationFactor||0),e,t)):(i.getLogger(V).error(".createSphere()","expected location to be a Point instance"),null)},o.createCylinder=function(e,t){return e instanceof y?new j(G.convertUnitGeometry(G.createUnitSizeCylinder(t&&t.densificationFactor||0),e,t)):(i.getLogger(V).error(".createCylinder()","expected location to be a Point instance"),null)},o.createPlane=function(e,t){if(!(e instanceof y))return i.getLogger(V).error(".createPlane()","expected location to be a Point instance"),null;const r=t?.facing??"up",n=G.convertPlaneSizeParameter(r,t?.size);return new j(G.convertUnitGeometry(G.createUnitSizePlane(r),e,{...t,size:n}))},o.createFromPolygon=function(e,t){if(!(e instanceof v))return i.getLogger(V).error(".createFromPolygon()","expected polygon to be a Polygon instance"),null;const r=U.triangulate(e);return new j({vertexAttributes:new A.MeshVertexAttributes({position:r.position}),components:[new w({faces:r.faces,shading:"flat",material:t?.material??null})],spatialReference:e.spatialReference,vertexSpace:new _})},o.createFromGLTF=async function(t,r,o){if(!(t instanceof y))throw i.getLogger(V).error(".createfromGLTF()","expected location to be a Point instance"),new n("invalid-input","Expected location to be a Point instance");const{loadGLTFMesh:s}=await c.whenOrAbort(new Promise(((t,r)=>e(["./support/meshUtils/loadGLTFMesh"],t,r))),o);return new j(await s(t,r,o))},o.createFromFiles=async function(e,t,r){if(!(e instanceof y)){const e="Expected location to be a Point instance";throw i.getLogger(V).error(".createFromFiles()",e),new n("invalid-input",e)}const o=j.createWithExternalSource(e,t),s=r?.layer;if(!s){const e="A layer is needed to convert the files";throw i.getLogger(V).error(".createFromFiles()",e),new n("invalid-input",e)}const[a]=await s.uploadAssets([o],r);return a},o.createWithExternalSource=function(e,t,r){const n=r?.extent??null,{x:o,y:s,z:i,spatialReference:a}=e,c=r?.transform?.clone()??new M,p=r?.vertexSpace??new P({origin:[o,s,i??0]}),l={source:t,extent:n},u=new z.Metadata;return u.externalSources.push(l),new j({metadata:u,transform:c,vertexSpace:p,spatialReference:a})},o.createIncomplete=function(e,t){const{x:r,y:o,z:s,spatialReference:i}=e,a=t?.transform?.clone()??new M,c=t?.vertexSpace??new P({origin:[r,o,s??0]}),p=new j({transform:a,vertexSpace:c,spatialReference:i});return p.addResolvingPromise(Promise.reject(new n("mesh-incomplete","Mesh resources are not complete"))),p},t._createClass(o,[{key:"hasExtent",get:function(){return this.loaded?this.vertexAttributes.position.length>0&&(!this.components||this.components.length>0):null!=this.metadata.displaySource?.extent}},{key:"_transformedExtent",get:function(){const{components:e,spatialReference:t,vertexAttributes:r,vertexSpace:n}=this,o=r.position;if(0===o.length||e&&0===e.length)return new g({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t});if("local"===n.type){const{_untransformedExtent:e,transform:r}=this;return E.getProjectedExtent(e,r,n,t)}if("georeferenced-relative"===n.type){const{transform:e}=this,r=L.project({positions:o,transform:e,vertexSpace:n,inSpatialReference:t,outSpatialReference:t,local:!1});return E.getExtentFromPositions(r,t)}return E.getExtentFromPositions(o,t)}},{key:"_untransformedExtent",get:function(){return E.getExtentFromPositions(this.vertexAttributes.position,this.spatialReference)}},{key:"anchor",get:function(){const{vertexSpace:e}=this;if(e.isRelative)return e.getOriginPoint(this.spatialReference);const{center:t,zmin:r}=this._transformedExtent;return new y({x:t.x,y:t.y,z:r,spatialReference:this.spatialReference})}},{key:"origin",get:function(){const{vertexSpace:e}=this;return e.isRelative?e.getOriginPoint(this.spatialReference):this._transformedExtent.center}},{key:"extent",get:function(){return this.loaded||null==this.metadata?.displaySource?.extent?this._transformedExtent:this.metadata.displaySource.extent.clone()}},{key:"memoryUsage",get:function(){let e=0;if(e+=this.vertexAttributes.memoryUsage,null!=this.components)for(const t of this.components)e+=t.memoryUsage;return e}}]),o}(o.HandleOwnerMixin(s.LoadableMixin(a.EsriPromiseMixin(x))));r.__decorate([l.property({type:[w],json:{write:!0}})],B.prototype,"components",void 0),r.__decorate([l.property({nonNullable:!0,types:T,constructOnly:!0,json:{write:!0}})],B.prototype,"vertexSpace",void 0),r.__decorate([l.property({type:M,json:{write:!0}})],B.prototype,"transform",void 0),r.__decorate([l.property({constructOnly:!0})],B.prototype,"metadata",void 0),r.__decorate([l.property()],B.prototype,"hasExtent",null),r.__decorate([l.property()],B.prototype,"_transformedExtent",null),r.__decorate([l.property()],B.prototype,"_untransformedExtent",null),r.__decorate([l.property()],B.prototype,"anchor",null),r.__decorate([l.property()],B.prototype,"origin",null),r.__decorate([l.property({readOnly:!0,json:{read:!1}})],B.prototype,"extent",null),r.__decorate([l.property({readOnly:!0,json:{read:!1,write:!0,default:!0}})],B.prototype,"hasZ",void 0),r.__decorate([l.property({readOnly:!0,json:{read:!1,write:!0,default:!1}})],B.prototype,"hasM",void 0),r.__decorate([l.property({type:A.MeshVertexAttributes,nonNullable:!0,json:{write:!0}})],B.prototype,"vertexAttributes",void 0),B=j=r.__decorate([f.subclass(V)],B);const W=m.create(),D=S.create();return B}));
