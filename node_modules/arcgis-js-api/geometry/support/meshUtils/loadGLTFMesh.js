/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../Color","../../../request","../../../core/MapUtils","../../../core/mathUtils","../../../chunks/mat3","../../../chunks/mat3f64","../../../chunks/vec3f64","../../../chunks/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshTextureTransform","../MeshVertexAttributes","../buffer/BufferView","../../../chunks/vec32","../../../chunks/vec42","../buffer/utils","./georeference","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/glTF/internal/resourceUtils","../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA","../../../views/webgl/enums","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec22"],(function(e,t,r,n,o,s,l,a,u,i,c,f,m,d,p,g,x,w,T,V,h,v,M,B,b,y,C,A){"use strict";async function R(e,t,r){const n={...r,useTransform:r?.useTransform??!0},o=new V.DefaultLoadingContext(E(n)),s=(await h.loadGLTF(o,t,n,!0)).model,l=s.lods.shift(),a=new Map,u=new Map;s.textures.forEach(((e,t)=>a.set(t,k(e)))),s.materials.forEach(((e,t)=>u.set(t,L(e,a))));const i=S(l);for(const d of i.parts)$(i,d,u);const{position:c,normal:f,tangent:m,color:p,texCoord0:g}=i.vertexAttributes,x={position:c.typedBuffer,normal:null!=f?f.typedBuffer:null,tangent:null!=m?m.typedBuffer:null,uv:null!=g?g.typedBuffer:null,color:null!=p?p.typedBuffer:null},w=T.georeferenceByTransform(x,e,n);return{transform:w.transform,vertexSpace:w.vertexSpace,components:i.components,spatialReference:e.spatialReference,vertexAttributes:new d.MeshVertexAttributes({position:w.vertexAttributes.position,normal:w.vertexAttributes.normal,tangent:w.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function E(e){const t=e?.resolveFile;return t?{busy:!1,request:async(e,n,o)=>{const s=t(e),l="image"===n?"image":"binary"===n?"array-buffer":"json";return(await r(s,{responseType:l,signal:null!=o?o.signal:null})).data}}:null}function F(e,t){if(null==e)return"-";const r=e.typedBuffer;return`${n.getOrCreateMapValue(t,r.buffer,(()=>t.size))}/${r.byteOffset}/${r.byteLength}`}function O(e){return null!=e?e.toString():"-"}function S(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},o=new Map,s=new Map,l=[];for(const a of e.parts){const{attributes:{position:e,normal:u,color:i,tangent:c,texCoord0:f}}=a,m=`\n      ${F(e,o)}/\n      ${F(u,o)}/\n      ${F(i,o)}/\n      ${F(c,o)}/\n      ${F(f,o)}/\n      ${O(a.transform)}\n    `;let d=!1;const p=n.getOrCreateMapValue(s,m,(()=>(d=!0,{start:t,length:e.count})));d&&(t+=e.count),u&&(r.normal=!0),i&&(r.color=!0),c&&(r.tangent=!0),f&&(r.texCoord0=!0),l.push({gltf:a,writeVertices:d,region:p})}return{vertexAttributes:{position:w.createBuffer(p.BufferViewVec3f64,t),normal:r.normal?w.createBuffer(p.BufferViewVec3f,t):null,tangent:r.tangent?w.createBuffer(p.BufferViewVec4f,t):null,color:r.color?w.createBuffer(p.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?w.createBuffer(p.BufferViewVec2f,t):null},parts:l,components:[]}}function k(e){return new f({data:(M.isEncodedMeshTexture(e.data),e.data),wrap:U(e.parameters.wrap)})}function L(e,r){const n=new t(G(e.color,e.opacity)),s=e.emissiveFactor?new t(I(e.emissiveFactor)):null,l=e=>e?new m({scale:e.scale?[e.scale[0],e.scale[1]]:[1,1],rotation:o.rad2deg(e.rotation??0),offset:e.offset?[e.offset[0],e.offset[1]]:[0,0]}):null;return new c({color:n,colorTexture:r.get(e.textureColor),normalTexture:r.get(e.textureNormal),emissiveColor:s,emissiveTexture:r.get(e.textureEmissive),occlusionTexture:r.get(e.textureOcclusion),alphaMode:P(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r.get(e.textureMetallicRoughness),colorTextureTransform:l(e.colorTextureTransform),normalTextureTransform:l(e.normalTextureTransform),occlusionTextureTransform:l(e.occlusionTextureTransform),emissiveTextureTransform:l(e.emissiveTextureTransform),metallicRoughnessTextureTransform:l(e.metallicRoughnessTextureTransform)})}function $(e,t,r){t.writeVertices&&D(e,t);const{indices:n,attributes:o,primitiveType:s,material:l}=t.gltf;let a=v.convertPrimitiveToTriangles(n||o.position.count,s);const u=t.region.start;if(u){const e=new Uint32Array(a);for(let t=0;t<a.length;t++)e[t]+=u;a=e}e.components.push(new i({faces:a,material:r.get(l),shading:o.normal?"source":"flat",trustSourceNormals:!0}))}function D(e,t){const{position:r,normal:n,tangent:a,color:u,texCoord0:i}=e.vertexAttributes,c=t.region.start,{attributes:f,transform:m}=t.gltf,d=f.position.count;if(g.transformMat4View(r.slice(c,d),f.position,m),null!=f.normal&&null!=n){const e=s.normalFromMat4(l.create(),m),t=n.slice(c,d);g.transformMat3View(t,f.normal,e),o.hasScaling(e)&&g.normalizeView(t,t)}else null!=n&&y.fill(n,0,0,1,{dstIndex:c,count:d});if(null!=f.tangent&&null!=a){const e=s.normalFromMat4(l.create(),m),t=a.slice(c,d);x.transformMat3View(t,f.tangent,e),o.hasScaling(e)&&x.normalize(t,t)}else null!=a&&C.fill(a,0,0,1,1,{dstIndex:c,count:d});if(null!=f.texCoord0&&null!=i?A.normalizeIntegerBufferView(i.slice(c,d),f.texCoord0):null!=i&&A.fill(i,0,0,{dstIndex:c,count:d}),null!=f.color&&null!=u){const e=f.color,t=u.slice(c,d);if(4===e.elementCount)e instanceof p.BufferViewVec4f?x.scaleView(t,e,255):e instanceof p.BufferViewVec4u8?C.copyView(t,e):e instanceof p.BufferViewVec4u16&&x.scaleView(t,e,1/256);else{C.fill(t,255,255,255,255);const r=p.BufferViewVec3u8.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof p.BufferViewVec3f?g.scaleView(r,e,255):e instanceof p.BufferViewVec3u8?y.copyView(r,e):e instanceof p.BufferViewVec3u16&&g.scaleView(r,e,1/256)}}else null!=u&&C.fill(u.slice(c,d),255,255,255,255)}function P(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function U(e){return{horizontal:_(e.s),vertical:_(e.t)}}function _(e){switch(e){case b.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";case b.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case b.TextureWrapMode.REPEAT:return"repeat"}}function z(e){return e**(1/B.COLOR_GAMMA)*255}function G(e,t){return u.fromValues(z(e[0]),z(e[1]),z(e[2]),t)}function I(e){return a.fromValues(z(e[0]),z(e[1]),z(e[2]))}e.loadGLTFMesh=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
