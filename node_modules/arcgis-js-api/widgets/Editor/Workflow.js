/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass"],(function(t,e,r,o,s,n,i,a,p,c,l,h){"use strict";let d=function(e){function o(t){var r;return(r=e.call(this,t)||this)._indexHistory=[],r._lastStepIndex=-1,r._stepIndex=-1,r._setupAbortController=null,r._handleKeys={afterCommit:"after-commit",beforeCommit:"before-commit"},r.data=void 0,r.started=!1,r.steps=[],r.type=null,r}t._inherits(o,e);var s=o.prototype;return s.back=async function(t=(()=>Promise.resolve(!0))){if(this.hasPendingEdits){if(!await t())return}this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0})},s.cancel=async function(t={force:!0}){return!1!==t.force?this._cancel(t):new Promise(((e,o)=>{this.emit("cancel-request",{controller:{allow:()=>{this._cancel({...t,force:!0}).then(e)},deny:()=>o(new r("workflow:cancel-denied","Request to cancel workflow was denied."))}})}))},s.commit=async function(){this.handles.remove(this._handleKeys.beforeCommit),await(this.onCommit?.(this.data)),this.handles.remove(this._handleKeys.afterCommit),this.emit("commit")},s.go=async function(t){const{steps:e}=this,r=e.findIndex((e=>e.id===t));this._indexHistory.push(this._stepIndex),await this._go(r)},s.next=async function(){this._indexHistory.push(this._stepIndex),await this._go(this._stepIndex+1)},s.previous=async function(t={cancelCurrentStep:!1}){await this._go(this._indexHistory.pop(),t.cancelCurrentStep)},s.reset=async function(){await this._cancel({notify:!1}),await this.start()},s.save=async function(){await this.commit(),await this.reset()},s.start=async function(){this._set("started",!0);const t=-1===this._stepIndex?0:this._stepIndex;await this._go(t)},s._cancel=async function({notify:t=!0,error:e}={}){this.started&&(this._set("started",!1),await this.steps[this._stepIndex].tearDown({canceled:!0})),this.handles.remove([this._handleKeys.afterCommit,this._handleKeys.beforeCommit]),this._resetIndexing(t),t&&this.emit("cancel",{error:e})},s._go=async function(t=-1,e=!1){const{steps:r}=this;if(t<=-1||t>=r.length)return;if(!this.started)return this._stepIndex=t,void this._notifyStepProps();this._lastStepIndex>-1&&(this._setupAbortController=n.abortMaybe(this._setupAbortController),await r[this._lastStepIndex].tearDown({canceled:e})),this._setupAbortController=new AbortController;const o=this._setupAbortController.signal;try{await r[t].setUp(o)}catch(s){i.throwIfNotAbortError(s)}this._setupAbortController.signal===o&&(this._setupAbortController=null),o.aborted||(this._lastStepIndex=t,this._stepIndex=t,this._notifyStepProps())},s._resetIndexing=function(t=!0){this._stepIndex=-1,this._lastStepIndex=-1,this._indexHistory.length=0,t&&this._notifyStepProps()},s._notifyStepProps=function(){this.notifyChange("stepId"),this.notifyChange("hasPreviousStep"),this.notifyChange("hasNextStep")},t._createClass(o,[{key:"hasNextStep",get:function(){const{steps:t}=this;return!!(t&&this._stepIndex<t.filter((t=>!t.parent)).length-1)}},{key:"hasPreviousStep",get:function(){return this._stepIndex>0}},{key:"reliesOnOwnerAdminPrivileges",get:function(){return!1}},{key:"hasInvalidFormTemplate",get:function(){return!1}},{key:"hasUnsupportedFields",get:function(){return!1}},{key:"shouldShowAttachments",get:function(){return!1}},{key:"shouldAllowAttachmentEditing",get:function(){return!1}},{key:"stepId",get:function(){const{steps:t}=this,e=t&&t[this._stepIndex];return e&&e.id}},{key:"helpMessage",get:function(){}},{key:"hasPendingEdits",get:function(){return!1}},{key:"keyboardCancellationEnabled",get:function(){return!0}}]),o}(s.HandleOwnerMixin(o.EventedAccessor));e.__decorate([a.property()],d.prototype,"data",void 0),e.__decorate([a.property()],d.prototype,"hasNextStep",null),e.__decorate([a.property()],d.prototype,"hasPreviousStep",null),e.__decorate([a.property()],d.prototype,"onCommit",void 0),e.__decorate([a.property()],d.prototype,"reliesOnOwnerAdminPrivileges",null),e.__decorate([a.property()],d.prototype,"hasInvalidFormTemplate",null),e.__decorate([a.property()],d.prototype,"hasUnsupportedFields",null),e.__decorate([a.property()],d.prototype,"shouldShowAttachments",null),e.__decorate([a.property()],d.prototype,"shouldAllowAttachmentEditing",null),e.__decorate([a.property()],d.prototype,"started",void 0),e.__decorate([a.property({readOnly:!0})],d.prototype,"stepId",null),e.__decorate([a.property()],d.prototype,"steps",void 0),e.__decorate([a.property({readOnly:!0})],d.prototype,"type",void 0),e.__decorate([a.property()],d.prototype,"helpMessage",null),e.__decorate([a.property()],d.prototype,"hasPendingEdits",null),e.__decorate([a.property()],d.prototype,"keyboardCancellationEnabled",null),d=e.__decorate([h.subclass("esri.widgets.Editor.Workflow")],d);return d}));
