/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/asyncUtils","../../core/Collection","../../core/deprecate","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../layers/support/editableLayers","../../layers/support/layerUtils","../../portal/support/urlUtils","../Attachments/AttachmentsViewModel","./CreateFeaturesWorkflow","./CreateWorkflow","./deprecationUtils","./UpdateWorkflow","./workflowUtils","../FeatureForm/featureFormUtils","../FeatureForm/FeatureFormViewModel","../FeatureTemplates/FeatureTemplatesViewModel","../Sketch/SketchViewModel","../Spinner/SpinnerViewModel"],(function(e,t,a,r,o,i,s,n,l,c,d,p,u,w,f,h,y,k,m,_,g,v,b,W,F,C,E,I,U,O,A,M){"use strict";const V="esri.widgets.Editor.EditorViewModel",T=l.getLogger(V),S=["create","create-features","update"];function L(e,t,a){T.error(new i(e,t,a))}function P(e,t){return e?e.find((e=>e.layer===t)):void 0}let D=function(t){function s(a){var o;return(o=t.call(this,a)||this)._editableItems=new r,o._sketchGraphicsLayer=new k({listMode:"hide",internal:!0}),o._updateEditableItemsTask=null,o.activeWorkflow=null,o._activityQueue=[],o.failures=[],o.attachmentsViewModel=new v({capabilities:{editing:!0}}),o.featureFormViewModel=new U,o.featureTemplatesViewModel=new O,o.sketchViewModel=new A({layer:o._sketchGraphicsLayer}),o.spinnerViewModel=new M,o.pageStack=[],o.showDiscardEditsPrompt=()=>Promise.resolve(!0),o._candidateCommitted=!1,o.useDeprecatedCreateWorkflow=!1,o.back=async()=>{o.canGoBack&&(o.activeWorkflow?.hasPreviousStep?await o.activeWorkflow.back(o.showDiscardEditsPrompt):await o._cancelWorkflow({force:!o.hasPendingEdits}))},o.saveWorkflow=async()=>{const{featureFormViewModel:t}=e._assertThisInitialized(o);if(t.submit(),!t.submittable)return;const a=t.getValues();t.validateContingencyConstraints(a,{includeIncompleteViolations:!0}).length>0||await(o.activeWorkflow?.save())},o.selectFeature=(e,t=!1)=>{const a=o.activeWorkflow;o._candidateCommitted||"update"!==a?.type||(a.data.rootFeature=e,t&&(a.next(),o._candidateCommitted=!0))},o}e._inherits(s,t);var n=s.prototype;return n.initialize=function(){this.addHandles([p.watch((()=>{const e=this.view?.map?.editableLayers.filter((({parent:e,visible:t})=>e&&"visible"in e?t&&e.visible:t)),t=this.view?.allLayerViews,a=t?.filter((t=>!!e?.includes(t.layer)&&!t.suspended));return[e,a,this.layerInfos,this.allowedWorkflows]}),(()=>this._updateEditableItems()),p.initial),p.on((()=>this.activeWorkflow),"cancel",(()=>this.emit("workflow-cancel"))),p.on((()=>this.activeWorkflow),"commit",(()=>this.emit("workflow-commit"))),p.on((()=>this.activeWorkflow),"complete",(()=>{this.emit("workflow-commit"),this._set("activeWorkflow",null)})),p.when((()=>this.view?.map),(e=>e.add(this._sketchGraphicsLayer)),p.initial),p.watch((()=>this._editableItems.toArray()),(()=>{const{activeWorkflow:e}=this;if(this.refreshCreationTemplates(),!e)return;const{stepId:t}=e;"create"!==e.type?"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdate||"awaiting-update-feature-candidate"===t&&!e.data.candidates.some((e=>{const t=this._editableItems.find((t=>t.layer===e.layer));return t&&t.supports.includes("update")})))&&this._cancelWorkflow():"awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow()})),p.watch((()=>this.page),((e,t)=>{const a=this.pageStack.slice(),r=a.indexOf(e);-1===r&&t?a.push(t):a.splice(r),this.pageStack=a})),p.when((()=>"awaiting-update-feature-candidate"===this.state),(()=>this._candidateCommitted=!1)),p.on((()=>this.featureTemplatesViewModel),"select",(async({item:e,oldItem:t})=>{const{activeWorkflow:a}=this,r=!!e&&e.id===t?.id,o="create-features"===a?.type&&a.data.upload?.error;if(a)try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return this.featureTemplatesViewModel.select(t,{emit:!1})}if(!e||r&&!o)return;const i={layer:e.layer,template:e.template};if(e.supportsUpload)return this.startCreateFeaturesWorkflow(i);this.useDeprecatedCreateWorkflow?this.startCreateWorkflowAtFeatureCreation(i):this.startCreateFeaturesWorkflowAtFeatureCreation(i)})),p.on((()=>this.view),"key-down",(e=>{"Escape"===e.key&&this.activeWorkflow?.keyboardCancellationEnabled&&this.back()}))])},n.destroy=function(){this._cancelWorkflow().then((()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer),this.view=null})),this._updateEditableItemsTask=c.abortMaybe(this._updateEditableItemsTask)},n.startCreateWorkflowAtFeatureTypeSelection=async function(){if(F.workflowDeprecation(T,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),await p.whenOnce((()=>!this.updating)),!this.canCreate)return void L("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow();await e.start(),this._set("activeWorkflow",e)},n.startCreateFeaturesWorkflowAtFeatureTypeSelection=async function(){return this.startCreateFeaturesWorkflow()},n.startCreateWorkflowAtFeatureCreation=async function(e){if(F.workflowDeprecation(T,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),await p.whenOnce((()=>!this.updating)),!this.canCreate)return void L("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("awaiting-feature-to-create");t.data.creationInfo=e,await t.start(),this._set("activeWorkflow",t)},n.startCreateFeaturesWorkflowAtFeatureCreation=async function(e){return this.startCreateFeaturesWorkflow(e,"creating-features")},n.startCreateFeaturesWorkflow=async function(e,t="awaiting-feature-creation-info"){if(await p.whenOnce((()=>!this.updating)),!this.canCreate)throw new i("editing:unsupported-workflow","Creating features is unsupported or disabled.");await this._cancelWorkflow();const a=this._createCreateFeaturesWorkflow(e,t);await a.start(),this._set("activeWorkflow",a)},n.startCreateWorkflowAtFeatureEdit=async function(e){if(F.workflowDeprecation(T,"startCreateWorkflowAtFeatureEdit"),await p.whenOnce((()=>!this.updating)),!this.canCreate)return void L("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("editing-new-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)},n.startUpdateWorkflowAtFeatureSelection=async function(){if(await p.whenOnce((()=>!this.updating)),!this.canUpdate)return void L("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow();await e.start(),this._set("activeWorkflow",e)},n.startUpdateWorkflowAtMultipleFeatureSelection=async function(e){if(await p.whenOnce((()=>!this.updating)),!this.canUpdate)return void L("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,await t.start(),this._set("activeWorkflow",t)},n.startUpdateWorkflowAtFeatureEdit=async function(e){if(await p.whenOnce((()=>!this.updating)),!this.canUpdate)return void L("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.rootFeature=e,await t.start(),this._set("activeWorkflow",t)},n.deleteFeatureFromWorkflow=async function(){const{activeWorkflow:e}=this;e&&"update"===e.type?await e.deleteActiveFeature():L("editing:unsupported-workflow","Deleting requires an active update workflow.")},n.cancelWorkflow=async function(e){return this._cancelWorkflow({warn:!0,...e})},n.findEditableItemForLayer=function(e){const t="subtype-sublayer"===e.type?e.parent:e;return this._editableItems.find((e=>e.layer===t))},n.itemHasInvalidFormTemplate=function(e){return!!e&&(this.findEditableItemForLayer(e.layer)?.hasInvalidFormTemplate??!1)},n.itemHasUnsupportedFields=function(e){return!!e&&(this.findEditableItemForLayer(e.layer)?.hasUnsupportedFields??!1)},n.refreshCreationTemplates=function(){const e=[];for(const{layer:t,supports:a}of this._editableItems)t.loaded&&a.includes("create")&&e.push(t);this.featureTemplatesViewModel.layers=e},n.toggleUpdateWorkflow=async function(){this.canUpdate&&(this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&"awaiting-feature-to-update"===this.state?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection()))},n._updateEditableItems=async function(){c.abortMaybe(this._updateEditableItemsTask);const e=a.createTask((async e=>{const t=this.view?.allLayerViews,a=this.view?.map,o=a?.editableLayers.toArray()??[],i=a?.allTables.toArray().filter(_.isFeatureLayer)??[];await Promise.all(i.map((e=>e.load())));const s=i.filter((e=>m.isEditableLayer(e))),n=[...o.reverse(),...s.reverse()].filter((e=>"mesh"!==e.geometryType||"3d"===this.view?.type));if(!t||!o)return;const l=[],c=[];for(const r of n){const a=t.find((e=>e.layer===r)),o=a?l:c;if("subtype-group"===r.type){await r.loadAll(),d.throwIfAborted(e);for(let e=r.sublayers.length-1;e>=0;--e)o.push(this._makeEditableItemForLayer(r.sublayers.at(e),!!a?.suspended))}else o.push(this._makeEditableItemForLayer(r,!!a?.suspended))}if(e.aborted)return;const p=this._editableItems;this._editableItems=new r(l.concat(c)),p.destroy()}));this.updatingHandles.addPromise(e.promise),this._updateEditableItemsTask=e},n._cancelWorkflow=async function(e){const t=this.activeWorkflow;if(!t)return void(e&&e.warn&&L("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||!1!==e.force)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await t.cancel(e);await t.cancel(e),this._set("activeWorkflow",null)},n._createCreateFeaturesWorkflow=function(e,t){return b.create({viewModel:this,creationInfo:e,startAt:t,applyEditsCallback:(e,t,a)=>this._applyEdits(e,t,a),addAttachmentsCallback:(e,t)=>this._addAttachments(e,t)})},n._createCreateWorkflow=function(e){return W.create(this,e,((e,t,a)=>this._applyEdits(e,t,a)))},n._createUpdateWorkflow=function(e){return C.create(this,e,((e,t)=>this._applyEdits(e,t)))},n._addAttachments=function(e,t){const a=t.map((t=>this._addAttachment(e,t.feature,t.attachment)))??[];return Promise.all(a)},n._addAttachment=async function(e,t,a){let r=null;if("geojson"===e.type||"scene"===e.type||"oriented-imagery"===e.type)throw new i("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return await this._queueOperation((async()=>(r=await(e.addAttachment?.(t,a).catch((e=>{throw e?.error||e})))??null,r))),r},n._applyEdits=async function(e,t,a){let r=null;const o=e.url?await _.getOwningPortalUrl(e.url):null,i={returnServiceEditsOption:(!o||!g.parseKnownArcGISOnlineDomain(o))&&!RegExp("/hosted/","i").test(e.url)?"original-and-current-features":void 0,...a};return await this._queueOperation((async()=>{const a=await E.whenEditorLayerView(this.view,e).catch((()=>null));return r=await e.applyEdits(t,i),a&&await p.whenOnce((()=>!a.updating)),r})),r},n._queueOperation=function(e){this._activityQueue.push(e),this.notifyChange("syncing");const t=(e,t)=>{const a=t.indexOf(e);a>-1&&t.splice(a,1)};return e().then((e=>{if("error"in e&&e.error)throw e.error;if("addFeatureResults"in e){const{addFeatureResults:t,deleteFeatureResults:a,updateFeatureResults:r}=e,o=t.find((e=>!!e.error))||r.find((e=>!!e.error))||a.find((e=>!!e.error));if(o)throw o.error}return e})).catch((a=>{L("editing:operation-error","An error occurred.",{error:a});const r={error:a,retry:()=>(t(r,this.failures),this._queueOperation(e)),cancel:()=>{t(r,this.failures)}};this._set("failures",[...this.failures,r])})).then((()=>{t(e,this._activityQueue),this.notifyChange("syncing")}))},n._makeEditableItemForLayer=function(e,t=!0){const a=_.getEffectiveLayerCapabilities(e),r=a?.operations,o=P(this.layerInfos,e),i=I.formTemplateHasInvalidFields(e),s=e.fields.some((({type:e})=>I.unsupportedDateFieldTypes.has(e))),n=i||s,{allowedWorkflows:l}=this,c=l.includes("create")||l.includes("create-features"),d=l.includes("update"),p=e=>!o||!1!==o.enabled&&!1!==o[e],u=c&&!!r?.supportsAdd&&p("addEnabled"),w=d&&!!r?.supportsUpdate&&p("updateEnabled"),f=!n&&d&&!!r?.supportsDelete&&p("deleteEnabled"),h=[];t||(u&&h.push("create"),w&&h.push("update"),f&&h.push("delete"));const y=w&&!n&&(!o||!1!==o.attributeUpdatesEnabled),k=w&&!n&&!!a?.editing?.supportsGeometryUpdate&&(!o||!1!==o.geometryUpdatesEnabled),m=!(!a?.data?.supportsAttachment||o&&!1===o.allowAttachments);return{layer:e,supports:h,attributeUpdatesEnabled:y,geometryUpdatesEnabled:k,hasAttachments:m,attachmentsOnCreateEnabled:m&&c&&(!o||!1!==o.attachmentsOnCreateEnabled),attachmentsOnUpdateEnabled:!n&&m&&(!o||!1!==o.attachmentsOnUpdateEnabled),hasInvalidFormTemplate:i,hasUnsupportedFields:s}},e._createClass(s,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(e){e&&0!==e.length||(e=[...S]),this._set("allowedWorkflows",e)}},{key:"canCreate",get:function(){return this._editableItems.some((e=>e.supports.includes("create")))}},{key:"canUpdate",get:function(){return this._editableItems.some((({attachmentsOnUpdateEnabled:e,layer:t,supports:a})=>{const r=a.includes("update")||a.includes("delete")||e,o=t.parent,i=!(o&&"visible"in o)||!!o.visible;return t.visible&&i&&r}))}},{key:"editableItems",get:function(){return this._editableItems}},{key:"labelOptions",get:function(){return this.sketchViewModel.labelOptions},set:function(e){this.sketchViewModel.labelOptions=e}},{key:"layerInfos",set:function(e){e?.some((e=>("allowAttachments"in e&&o.deprecated(T,"Property: layerInfo.allowAttachments",{replacement:"layerInfo.attachmentsOnCreateEnabled or layerInfo.attachmentsOnUpdateEnabled",version:"4.26"}),!0))),this._set("layerInfos",e)}},{key:"snappingOptions",get:function(){return this.sketchViewModel.snappingOptions},set:function(e){this.sketchViewModel.snappingOptions=e}},{key:"state",get:function(){if(!this.get("view.ready")||0===this._editableItems.length)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this;return t?t.stepId:"ready"}},{key:"syncing",get:function(){return this._activityQueue.length>0}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"tooltipOptions",get:function(){return this.sketchViewModel.tooltipOptions},set:function(e){this.sketchViewModel.tooltipOptions=e}},{key:"view",set:function(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}},{key:"page",get:function(){const{activeWorkflow:e,state:t}=this;return"awaiting-feature-to-update"===t||"awaiting-feature-to-create"===t||"create-features"===e?.type&&0===e.numPendingFeatures?"ready":t??"disabled"}},{key:"selectedTemplateItem",get:function(){const{activeWorkflow:e}=this;if("create-features"===e?.type&&0===e.numPendingFeatures){const t=e.data.creationInfo?.template;if(!t)return;for(const e of this.featureTemplatesViewModel.items)if("findByTemplate"in e){const a=e.findByTemplate(t);if(a)return a}else if(e.template===t)return e}}},{key:"featureFormDisabled",get:function(){const{activeWorkflow:e}=this;return"update"===e?.type&&!1===e.activeEditableItem?.attributeUpdatesEnabled}},{key:"canGoBack",get:function(){return null!=this.activeWorkflow&&!this.syncing}},{key:"shouldShowDeleteButton",get:function(){const{activeWorkflow:e}=this;return!!e&&"update"===e.type&&!!e.activeEditableItem?.supports.includes("delete")}},{key:"hasPendingEdits",get:function(){return this.activeWorkflow?.hasPendingEdits??!1}}]),s}(n.HandleOwnerMixin(s.EventedAccessor));t.__decorate([u.property()],D.prototype,"_editableItems",void 0),t.__decorate([u.property({readOnly:!0})],D.prototype,"activeWorkflow",void 0),t.__decorate([u.property({readOnly:!0})],D.prototype,"_activityQueue",void 0),t.__decorate([u.property({value:[...S]})],D.prototype,"allowedWorkflows",null),t.__decorate([u.property({readOnly:!0})],D.prototype,"canCreate",null),t.__decorate([u.property({readOnly:!0})],D.prototype,"canUpdate",null),t.__decorate([u.property()],D.prototype,"editableItems",null),t.__decorate([u.property({readOnly:!0})],D.prototype,"failures",void 0),t.__decorate([u.property()],D.prototype,"attachmentsViewModel",void 0),t.__decorate([u.property()],D.prototype,"featureFormViewModel",void 0),t.__decorate([u.property()],D.prototype,"featureTemplatesViewModel",void 0),t.__decorate([u.property()],D.prototype,"labelOptions",null),t.__decorate([u.property()],D.prototype,"layerInfos",null),t.__decorate([u.property()],D.prototype,"sketchViewModel",void 0),t.__decorate([u.property()],D.prototype,"snappingOptions",null),t.__decorate([u.property()],D.prototype,"spinnerViewModel",void 0),t.__decorate([u.property()],D.prototype,"state",null),t.__decorate([u.property({readOnly:!0})],D.prototype,"syncing",null),t.__decorate([u.property()],D.prototype,"updating",null),t.__decorate([u.property()],D.prototype,"tooltipOptions",null),t.__decorate([u.property()],D.prototype,"view",null),t.__decorate([u.property()],D.prototype,"pageStack",void 0),t.__decorate([u.property()],D.prototype,"showDiscardEditsPrompt",void 0),t.__decorate([u.property()],D.prototype,"_candidateCommitted",void 0),t.__decorate([u.property()],D.prototype,"page",null),t.__decorate([u.property()],D.prototype,"selectedTemplateItem",null),t.__decorate([u.property()],D.prototype,"featureFormDisabled",null),t.__decorate([u.property()],D.prototype,"canGoBack",null),t.__decorate([u.property()],D.prototype,"shouldShowDeleteButton",null),t.__decorate([u.property()],D.prototype,"hasPendingEdits",null),t.__decorate([u.property()],D.prototype,"useDeprecatedCreateWorkflow",void 0),D=t.__decorate([y.subclass(V)],D);return D}));
