/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../Graphic","../../core/asyncUtils","../../core/has","../../core/handleUtils","../../core/lang","../../core/promiseUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/accessorSupport/diffUtils","../../layers/support/fieldUtils","../../renderers/support/clickToleranceUtils","../../renderers/support/lengthUtils","../../renderers/visualVariables/support/sizeVariableUtils","../../renderers/visualVariables/support/visualVariableUtils","../../support/featureFlags","../../symbols/support/symbolConversion","../../symbols/support/symbolUtils","../../views/3d/layers/graphics/GraphicState","../../views/support/drapedUtils","../../views/support/hitTestSelectUtils"],(function(e,t,a,n,i,r,l,s,o,c,u,p,d,y,f,h,g,b,m,w,v,S){"use strict";function U(e){const t=e.sourceLayer;if(!t||"feature"!==t.type||!A(t.renderer))return{rotation:null,size:null};let a=null,n=null;const i=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&null!=h.getRotationAngle(t,e)));1===i.length&&(a=I(i[0],t));const r=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&f.getTransformationType(t)===f.TransformationType.RealWorldSize&&null!=h.getSize(t,e)));return 1===r.length&&(n=F(r[0],t)),{rotation:a,size:n}}function I(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,n=e.field,i=t.fields&&t.fields.filter((e=>e.name===n)),r=i&&1===i.length?i[0].type:"double",l={initial:0,current:0};return{field:n,fieldType:r,getDefault:()=>Promise.resolve(0),getValue:e=>(l.current=l.initial-a*e,k((l.current+360)%360,r)),initValue:e=>{l.initial=null!=e?e:l.current,l.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function V(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function T(t,a,n){if(null==a)return 0;const{symbol:i}=b.to3D(a);if(null==i||"web-style"===i.type||"cim"===i.type)return 0;const r=i.symbolLayers.at(0);if(!r)return 0;switch(r.type){case"icon":{const{computeIconLayerResourceSize:t}=await new Promise(((t,a)=>e(["../../symbols/support/symbolLayerUtils"],t,a)));return r.size||Math.min(_.icon,(await t(r,_.icon))[0])||_.icon}case"text":return r.size||_.text;case"line":return r.size||_.line;case"object":{const{computeObjectLayerResourceSize:a}=await new Promise(((t,a)=>e(["../../symbols/support/symbolLayerUtils"],t,a)));return V(await a(r,t.scale/_.viewScaleSizeFactor),n)}case"path":return(null!=r.width?r.width:r.height)||t.scale/_.viewScaleSizeFactor;case"extrude":return r.size||t.scale/_.viewScaleSizeFactor;default:return 0}}function F(e,t){const a=e.field,n=e.axis,i=t.fields&&t.fields.filter((e=>e.name===a)),r=i&&1===i.length?i[0].type:"double",l={updating:!1,initial:0,current:0},s=y.meterIn[e.valueUnit]??1;let o;return o="area"===e.valueRepresentation?e=>(e*s/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*s/2:e=>e*s,{field:a,fieldType:r,getDefault:async(e,t)=>k(o(await T(t,e,n)),r),getValue:(e,t)=>(l.initial||(l.initial=t.pixelSizeAt(t.center)),l.current=l.initial*e,k(l.current,r)),initValue:e=>{l.initial=null!=e?e:l.current,l.current=0},isUpdatingInteractively:!1,displayUnit:Y(e.valueUnit),axis:e.axis}}function k(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function A(e){switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function L(e,t){const a=await m.getDisplayedSymbol(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t});null!=u.diff(e.symbol,a)&&(e.symbol=a)}function G(e){if(!e)throw new Error("no geometry type");return"multipatch"===e?"mesh":e}async function x(e,t,a,n){await z(e,t,n);const i=e.on("create",(async i=>{if("cancel"===i.state)return z(e,t,n);if("complete"===i.state){const e=i.graphic;e.sourceLayer||(e.sourceLayer=t.layer),e.attributes||(e.attributes={...t.template?.prototype.attributes}),await L(e,n),a(e)}}));return r.handlesGroup([i,r.makeHandle((()=>e.cancel()))])}async function z(e,t,a){const n=t.layer,i={...t.template?.prototype.attributes};await O(e,n,i,a),e.layer.elevationInfo=n.elevationInfo,await e.create(G(n.geometryType),{graphicProperties:{attributes:i,sourceLayer:n},hasZ:n.capabilities.data.supportsZ,geometryToPlace:t.geometryToPlace??void 0})}async function O(e,t,n,i){const r=new a({sourceLayer:t,attributes:n}),{rotation:l,size:s}=U(r);let o=await m.getDisplayedSymbol(r,{useSourceLayer:!0,webStyleCache:i}),c=!1;for(const a of[s,l]){if(null==a)continue;null==n[a.field]&&(n[a.field]=await a.getDefault(o,e.view),c=!0)}switch(c&&(o=await m.getDisplayedSymbol(r,{useSourceLayer:!0,webStyleCache:i})),o?.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=o;break;case"simple-line":case"line-3d":e.polylineSymbol=o;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":e.pointSymbol=o}E(e.tooltipOptions,s,l)}function E(e,t,a){e.visualVariables=null!=t||null!=a?{size:null!=t?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:null!=a?{valueType:a.fieldType,rotationType:a.rotationType??"geographic"}:null}:null}function C(e,t){return e?e.find((e=>e.layer===t)):void 0}async function M(e,t,a,n){if(0===e.length)return[];const{updatable:i,graphicsByLayer:r}=await a.async((async()=>{const{results:i}=await s.whenOrAbort(S.hitTestSelectSimilarDistance(t,a),n),r=new Map,l=e=>{const t=e.layer,a=r.get(t);if(!a){const e=new Array;return r.set(t,e),e}return a};S.filterGraphicHits(i).forEach((({graphic:e})=>l(e).push(e)));const o=e.filter((({supports:e,layer:t})=>e.includes("update")&&r.has(t)));return 0!==o.length&&a.stopPropagation(),{updatable:o,graphicsByLayer:r}}));return s.whenOrAbort(s.eachAlways(i.map((async({layer:e})=>{const{objectIdField:t}=e,a="displayField"in e?e.displayField:null,i=[t];null!=a&&e.fieldsIndex.has(a)&&i.push(a);const l=r.get(e);if(!!l.some((e=>i.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=i,t.returnGeometry=!1,t.objectIds=l.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:n}).then((({features:e})=>e))}return l}))),n)}async function D(e,t,a,n){if(0===e.length)return[];let i=null;const r=await a.async((async()=>{const{results:r}=await s.whenOrAbort(t.hitTest(a),n);if(0===r.length)return[];const l=new Set;i=S.filterGraphicHits(r),i.forEach((({graphic:e})=>e&&l.add(e.layer)));const o=e.items.filter((({layer:e,supports:t,attachmentsOnUpdateEnabled:a})=>l.has(e)&&(t.includes("update")||t.includes("delete")||a)));return o.length>0&&a.stopPropagation(),o}));return s.whenOrAbort(s.eachAlways(r.map((({layer:e})=>{const r=e.objectIdField,l="displayField"in e?e.displayField:null,s=p.getDisplayFieldName({displayField:l,fields:e.fields}),o=[r];null!=s&&e.fieldsIndex.has(s)&&o.push(s);const c=e.createQuery();c.outFields=o,c.returnGeometry=!1;const u="renderer"in e?d.calculateTolerance({renderer:e.renderer,event:a}):0;return c.geometry=v.createQueryGeometry(a.mapPoint,u,t),c.outSpatialReference=t.spatialReference,e.queryFeatures(c,{signal:n}).then((({features:t})=>(i?.forEach((({graphic:a})=>{a.layer!==e||t.some((e=>e.getObjectId()===a.getObjectId()))||t.push(a)})),t)))}))),n)}async function j(e,t,a,n){switch(t.type){case"3d":return M(e,t,a,n);case"2d":return D(e,t,a,n)}}async function P(e,t,a){const{sourceLayer:n}=e,i=n.createQuery();i.objectIds=[e.getAttribute(n.objectIdField)],i.outFields=["*"],i.outSpatialReference=t,i.returnM=n.capabilities.data.supportsM,i.returnZ=n.capabilities.data.supportsZ,g.sceneLayerEditingEnabled()&&g.i3sPatchingEnabled()&&"scene"===n.type&&null!=n.infoFor3D&&(i.returnGeometry=!0,i.formatOf3DObjects="3D_glb");const r=await n.queryFeatures(i,{signal:a});s.throwIfAborted(a);return r.features[0]}async function R(e){const{graphic:t,sketchViewModel:a,sourceLayer:n,visualVariables:i,webStyleCache:r}=e;let l=!1;const{rotation:s,size:o}=i;[s,o].forEach((async e=>{if(null==e)return;const n=t.getAttribute(e.field);if(null!=n)e.initValue(n);else{const n=await e.getDefault(t.symbol,a.view);e.initValue(n),t.setAttribute(e.field,n),l=!0}})),l&&await L(t,r);const c={multipleSelectionEnabled:!1};return"point"===n.geometryType&&(c.enableRotation=null!=s,c.enableScaling=null!=o),E(a.tooltipOptions,o,s),a.layer.elevationInfo=n.elevationInfo,a.update(t,c)}function H(e){return null==e||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e}function q(e){return null==e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}async function W(e,t,a,n,i){if(null==t.geometry||"point"!==t.geometry?.type)return;const r=n.rotation,l=H(a.toolEventInfo);if(null!=r&&null!=l)if("rotate-stop"===l.type)r.isUpdatingInteractively=!1,r.initValue();else{r.isUpdatingInteractively=!0;const{field:a,getValue:n}=r;t.setAttribute(a,n(l.angle,e))}const s=n.size,o=q(a.toolEventInfo);if(null!=s&&null!=o)if("scale-stop"===o.type)s.isUpdatingInteractively=!1,s.initValue();else{s.isUpdatingInteractively=!0;const{field:a,getValue:n}=s;t.setAttribute(a,n(o.xScale,e))}await L(t,i)}async function Q(e,t,a,n,i,l){const s=le(e);await L(s,l),n.map.add(a.layer),a.layer.add(s);const c=e.sourceLayer,u=ae(n,c);await N(n,s),await R({graphic:s,sketchViewModel:a,sourceLayer:c,visualVariables:t,webStyleCache:l});const p=Z(a,e,s);let d=null;u.then((e=>d=e)).catch((()=>{}));const y=t.size,f=t.rotation,h=o.watch((()=>e.attributes),(async e=>{let t=!1;for(const a in e){const n=e[a];n!==s.getAttribute(a)&&(s.setAttribute(a,n),null==y||y.isUpdatingInteractively||y.field!==a||y.initValue(n),null==f||f.isUpdatingInteractively||f.field!==a||f.initValue(n),(null==d||d.requiredFields.includes(a))&&(t=!0))}t&&await L(s,l)})),g=a.on("update",(async e=>{const r=e.graphics[0];if("complete"===e.state)return R({graphic:r,sketchViewModel:a,sourceLayer:c,visualVariables:t,webStyleCache:l});await W(n,r,e,t,l),i(le(r),e)})),b=a.on(["undo","redo"],(async e=>{i(le(e.graphics[0]),e)})),m=a.updateOnGraphicClick;return{visual:r.handlesGroup([p,r.makeHandle((()=>{a.updateOnGraphicClick=m}))]),interactive:r.handlesGroup([b,g,r.makeHandle((()=>a.cancel())),h,r.makeHandle((()=>{a.updateOnGraphicClick=!1}))])}}function Z(e,t,a){const i=e.view,l=t.sourceLayer,c=t.layer,u=t.getAttribute(c.objectIdField);let p=null;function d(e){p?.abort(),p=n.createTask((async t=>{const a=await ae(i,l);s.throwIfAborted(t),a.setVisibility?.(u,e)}))}return d(!1),r.handlesGroup([B(i,a,(e=>d(!e))),r.makeHandle((async()=>{d(!0);const t=await ae(i,l);await o.whenOnce((()=>!t.updating)),e.layer.remove(a)}))])}function B(e,t,a){if("3d"===e.type){const n=new w.GraphicState({graphic:t});return r.handlesGroup([e.trackGraphicState(n),o.watch((()=>n.displaying),a)])}return o.watch((()=>t.visible),a)}async function N(e,t){if("3d"===e.type){const a=new w.GraphicState({graphic:t}),n=e.trackGraphicState(a);await o.whenOnce((()=>a.displaying)),n.remove()}else await o.whenOnce((()=>t.visible))}const _={icon:c.px2pt(24),text:c.px2pt(12),line:c.px2pt(1),viewScaleSizeFactor:100};function J(e,t,a){let n=!1;return e.filter((e=>!!n||(n=e===t,n))).map((e=>a[e]()))}function K(e){if(1!==e.length)return null;const t=e[0];if("items"in t){const e=t;return 1===e.items.length?e.items[0]:null}return t}function X(e,t){if(e.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===t[0].id){const a=K(e.viewModel.featureTemplatesViewModel.items);null==a||a.supportsUpload||(e.creationInfo=a,t.shift())}return t}function Y(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}function $(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}function ee(e){const{creationInfo:t,viewModel:a}=e;if(!t)return!1;const{layer:n}=t,i=a.editableItems.find((e=>e.layer===n));if(i)return i.attachmentsOnCreateEnabled;const r=n.capabilities?.data,l=a.layerInfos?.find((e=>e.layer===n));return!(!(r&&"supportsAttachment"in r&&r.supportsAttachment)||l&&(!1===l.allowAttachments||!1===l.attachmentsOnUpdateEnabled))}const te=e=>/-stop/.test(e)||/vertex-/.test(e),ae=(e,t)=>{const a="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(a)};function ne(e){return"createInteractiveEditSession"in e}const ie=Symbol();function re(e){return e&&"object"==typeof e&&ie in e}function le(e){const t=e.geometry;if("mesh"===t?.type){const a=e.cloneShallow();return a.attributes=l.clone(e.attributes),a.geometry=t.cloneShallow(),a.geometry.transform=t.transform?.clone()??null,a}return e.clone()}function se(e){const t=e.cursor;return e.cursor="progress",r.makeHandle((()=>e.cursor=t))}t.UsesSketchViewModelSymbol=ie,t.avoidFeatureTemplateSelectionWithOnlyOneItem=X,t.canCreateInteractiveEditSession=ne,t.cloneGraphicExceptMesh=le,t.createWorkflowSteps=J,t.fetchCandidates=j,t.fetchFullFeature=P,t.findLayerInfo=C,t.getVisualVariableAttributes=U,t.isTerminalUpdateEventType=te,t.prepareAttachmentsForCreateWorkflow=$,t.setUpFeatureAdd=x,t.setUpGeometryUpdate=Q,t.shouldShowAttachmentsForCreateWorkflow=ee,t.showProgressCursor=se,t.sizeDefaults=_,t.sizeVariableUnitToLengthUnit=Y,t.startCreatingNewFeature=z,t.startUpdatingFeature=R,t.updateGraphicSymbolWhenRequired=L,t.visualVariableInteractiveUpdate=W,t.whenEditorLayerView=ae,t.whenGraphicDisplayed=N,t.workflowUsesSketchViewModel=re,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
