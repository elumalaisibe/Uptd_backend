/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/arrayUtils","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/uuid","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../views/draw/support/helpMessageUtils","../../views/interactive/snapping/FeatureSnappingLayerSource","./CreateFeaturesWorkflowData","./modelUploadUtils","./Workflow","./workflowUtils"],(function(e,t,a,n,r,i,o,s,l,c,d,u,h,p,f,g,m,w,y){"use strict";var v;const _=Symbol(),b=Symbol();let k=v=function(t){function s(e){var a;return(a=t.call(this,e)||this).type="create-features",a.createFeatureState="create-new",a._featureFormHandle=null,a._visualVariableAttributes={rotation:null,size:null},a._attachmentFileInfos=new Map,a._highlightHandles=new Map,a._preventDefaultActionOnCancel=!1,a._lastActiveGraphics=[],a}e._inherits(s,t);var l=s.prototype;return l.enter=async function(){const{featureFormViewModel:e}=this.data.viewModel,t=e.relatedRecordCallbacks;e.relatedRecordCallbacks=null,this.addHandles(n.makeHandle((()=>{e.relatedRecordCallbacks=t})),b)},l.exit=function(){this.removeHandles(b)},l.updatePendingFeature=async function(e,t){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),a.remove(this._lastActiveGraphics,e),this._startUpdating(e,t)},s.create=function(e){const{addAttachmentsCallback:t,applyEditsCallback:a,creationInfo:n,startAt:r,viewModel:i}=e,o=new v({data:new g.CreateFeaturesWorkflowData({creationInfo:n,viewModel:i}),onCommit:async e=>{const{creationInfo:n}=e;if(!n)return;n.geometryToPlace&&(e.creationInfo=null);const r=e.pendingFeatures.toArray(),{layer:i}=n,s=i.capabilities?.editing.supportsGlobalId&&"globalIdField"in i,l=o._attachmentFileInfos;if(s){const e=M(r,i,l);return void await a(i,e,{globalIdUsed:!0})}const c=await a(i,{addFeatures:r});if(l.size>0){const e=c?.addFeatureResults??[];await t(i,I(r,e,i,l))}}});return o._set("steps",this._createWorkflowSteps(o,r)),o},l._fadeExistingFeatures=function(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",n.makeHandle((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,n.makeHandle((()=>e.opacity=t))},l._highlight=function(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))},l._removeHighlight=function(e){r.removeMaybe(this._highlightHandles.get(e)),this._highlightHandles.delete(e)},l._startCreating=async function(e){const{data:t}=this,{creationInfo:a}=t;if(a)return this.createFeatureState="create-new",y.startCreatingNewFeature(t.viewModel.sketchViewModel,a,e)},l._startUpdating=async function(e,t){const{pendingFeatures:a}=this;a.includes(e)||a.add(e);const{creationInfo:i,viewModel:o}=this.data,{featureFormViewModel:s,layerInfos:l,sketchViewModel:c,view:d}=o;if(!d||!i)return;const u=i.layer,p=y.findLayerInfo(l,u),f=p?.formTemplate,g=d.spatialReference;return s.set({arcadeEditType:"INSERT",feature:e,formTemplate:f,spatialReference:g,map:d.map}),this._removeHighlight(e),await y.updateGraphicSymbolWhenRequired(e,t),r.removeMaybe(this._featureFormHandle),this._featureFormHandle=n.handlesGroup([s.on("value-change",(async()=>{e.attributes=s.getValues(),await y.updateGraphicSymbolWhenRequired(e,t)})),c.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&y.isTerminalUpdateEventType(e.toolEventInfo.type))&&s.notifyFeatureGeometryChanged()}))]),this.createFeatureState="update-pending",this._visualVariableAttributes=y.getVisualVariableAttributes(e),h.isTable(u)?void 0:y.startUpdatingFeature({graphic:e,sketchViewModel:c,sourceLayer:u,visualVariables:this._visualVariableAttributes,webStyleCache:t})},s._createWorkflowSteps=function(e,t="awaiting-feature-creation-info"){const{data:a,handles:n}=e,s={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(t){const{creationInfo:r,viewModel:o}=a,{view:s}=o;if(s)if(m.isModelUpload(r)){const r=await m.waitForModelUpload({view:s,data:a,signal:t,next:()=>e.next(),cancel:()=>o.cancelWorkflow()});i.throwIfAborted(t),n.add(r,this.id)}else a.creationInfo=null,n.add(o.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(a.creationInfo=e,o.activeWorkflow?.next())})),this.id)},async tearDown(){n.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(n.has(this.id))return;const{viewModel:t}=a,{view:i}=t;if(!i)return;const s=new Map,l=[],c=[];e._lastActiveGraphics=[],e._featureFormHandle=r.removeMaybe(e._featureFormHandle),e._visualVariableAttributes={rotation:null,size:null},y.prepareAttachmentsForCreateWorkflow(t.attachmentsViewModel),l.push(o.watch((()=>t.attachmentsViewModel.mode),(t=>{switch(t){case"add":e.go("adding-attachment");break;case"edit":e.go("editing-attachment")}})));const d=y.showProgressCursor(i);l.push(d);const u=h.isTable(e.data.creationInfo?.layer);try{if(!u){const t=v._configureSketchViewModel(e,s);l.push(t.beforeCommit),c.push(t.afterCommit)}const n=a.creationInfo?.initialFeature;n?(u||t.sketchViewModel.layer.add(n),await e._startUpdating(n,s)):await e._startCreating(s)}finally{d.remove()}l.push(e._featureFormHandle),n.add(l,e._handleKeys.beforeCommit),n.add([...l,...c],this.id)},async tearDown(t){const{viewModel:r}=a;if(t.canceled){const{pendingFeatures:t}=e;t.drain((e=>r.sketchViewModel.layer.remove(e))),n.remove([this.id,_]),r.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear()}}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:n,fileInfos:r}=t;e._attachmentFileInfos.set(n,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:n,fileInfos:r}=t;e._attachmentFileInfos.set(n,r.toArray()),t.mode="view"}})},l=y.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,s);return y.avoidFeatureTemplateSelectionWithOnlyOneItem(a,l)},s._configureSketchViewModel=function(e,t){const{data:r,handles:i}=e,{viewModel:s}=r,{view:l}=s,c=s.sketchViewModel;let d=null;const u=[];if(!l)return{beforeCommit:n.makeHandle(),afterCommit:n.makeHandle()};const h=c.updateOnGraphicClick;return c.updateOnGraphicClick=!1,"2d"===l.type&&r.creationInfo&&u.push(e._fadeExistingFeatures(r.creationInfo.layer)),u.push(c.on("create",(async a=>{if("cancel"===a.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(t);const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("complete"===a.state&&a.graphic)return e._startUpdating(a.graphic,t)})),c.on("update",(async a=>{const{viewModel:n}=r,{attachmentsViewModel:s,featureFormViewModel:c}=n,u=a.graphics[0];if("complete"===a.state){if(u!==d&&(e._lastActiveGraphics.push(u),e._highlight(u)),d=null,e.numPendingFeatures===r.creationInfo?.maxFeatures){const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("add"!==s.mode&&"edit"!==s.mode||n.activeWorkflow?.previous(),a.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);i.add([y.showProgressCursor(l),l.on("click",(e=>e.preventDefault()))],_),await o.whenOnce((()=>!c.updating)),i.remove(_),e._startCreating(t)}if("start"===a.state){e._removeHighlight(u),"add"!==s.mode&&"edit"!==s.mode||n.activeWorkflow?.previous(),s.fileInfos.removeAll(),s.graphic=u,s.mode="view";(e._attachmentFileInfos.get(u)||[]).forEach((({file:e,form:t})=>s.addFile(e,t)))}const h=e._visualVariableAttributes;await y.visualVariableInteractiveUpdate(l,u,a,h,t);const p=u.attributes,{rotation:f,size:g}=h;if(null!=f){const{field:e}=f;c.setValue(e,p[e])}if(null!=g){const{field:e}=g;c.setValue(e,p[e])}})),c.on("delete",(async t=>{const n=t.graphics[0];e.pendingFeatures.remove(n),a.remove(e._lastActiveGraphics,n),d=n})),l.on("immediate-click",(async a=>{if(m.isModelUpload(r.creationInfo))return;const{results:n}=await l.hitTest(a,{include:c.layer}),i=n.find((e=>"graphic"===e.type));if(!i)return;const o=i.graphic;if("transform"===c.activeTool||"reshape"===c.activeTool){if(c.updateGraphics.at(0)===o)return;await e.updatePendingFeature(o,t)}})),n.makeHandle((()=>c.cancel())),F(c,r)),{beforeCommit:n.handlesGroup(u),afterCommit:n.makeHandle((()=>{c.updateOnGraphicClick=h}))}},e._createClass(s,[{key:"hasPendingEdits",get:function(){if(this.numPendingFeatures)return!0;const{data:e}=this,{upload:t}=e;return!(!t||t.error)||!!e.creationInfo?.geometryToPlace}},{key:"helpMessage",get:function(){const{creationInfo:e,viewModel:t}=this.data;if("creating-features"!==this.stepId||!e)return;const a=e.layer.geometryType,n=t.sketchViewModel.createGraphic?.geometry;return p.getDrawHelpMessage(a,n,t.view)}},{key:"numPendingFeatures",get:function(){return this.pendingFeatures.length}},{key:"pendingFeatures",get:function(){return this.data.pendingFeatures}},{key:"keyboardCancellationEnabled",get:function(){return 0===this.numPendingFeatures}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const{creationInfo:e}=this.data;if(!e)return!1;const{layer:t}=e,a=t.capabilities?.operations.supportsAdd,n=h.getEffectiveLayerCapabilities(t)?.operations.supportsAdd;return h.getEffectiveEditingEnabled(t)&&!t.editingEnabled||!!n&&!a}},{key:"shouldShowAttachments",get:function(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&y.shouldShowAttachmentsForCreateWorkflow(this.data)}},{key:"shouldAllowAttachmentEditing",get:function(){return this.shouldShowAttachments}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"test",get:function(){return{addAttachment:(e,t)=>{this._attachmentFileInfos.set(e,t)}}}}]),s}(w);function F(e,t){let a=null;const i=()=>e.snappingOptions.featureSources,s=()=>(a=new f({layer:e.layer}),i().add(a),a),l=()=>{null!=a&&(i().remove(a),a=r.destroyMaybe(a))};return n.handlesGroup([o.watch((()=>{const e=t.creationInfo?.layer,a=i().find((t=>t.layer===e));return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{if(!e)return l();a??(a=s()),a.enabled=t}),o.syncAndInitial),n.makeHandle(l)])}function I(e,t,a,n){const r=[];return t.forEach(((t,i)=>{if(!t.error){const o=e[i],s=n.get(o)||[];o.attributes[a.objectIdField]=t.objectId,s.forEach((({form:e})=>r.push({feature:o,attachment:e})))}})),r}function M(e,t,a){const n=[],r=t.globalIdField;return e.forEach(((t,i)=>{var o;(o=e[i].attributes)[r]??(o[r]=s.generateBracedUUID()),(a?.get(t)||[]).forEach((({file:e})=>n.push({feature:t,attachment:{globalId:s.generateBracedUUID(),data:e}})))})),n.length?{addFeatures:e,addAttachments:n}:{addFeatures:e}}t.__decorate([l.property()],k.prototype,"hasPendingEdits",null),t.__decorate([l.property()],k.prototype,"helpMessage",null),t.__decorate([l.property()],k.prototype,"keyboardCancellationEnabled",null),t.__decorate([l.property()],k.prototype,"reliesOnOwnerAdminPrivileges",null),t.__decorate([l.property()],k.prototype,"shouldShowAttachments",null),t.__decorate([l.property()],k.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([l.property()],k.prototype,"updating",null),k=v=t.__decorate([u.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],k);return k}));
