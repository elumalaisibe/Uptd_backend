/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../views/draw/support/helpMessageUtils","./CreateWorkflowData","./Edits","./Workflow","./workflowUtils"],(function(e,t,a,i,r,o,n,s,l,d,c,u,w,p){"use strict";var f;let h=f=function(t){function i(e){var a;return(a=t.call(this,e)||this).type="create",a}return e._inherits(i,t),i.create=function(e,t,a){const i=new f({data:new c({edits:new u.Edits,viewModel:e}),onCommit:async e=>{await a(e.creationInfo.layer,{addFeatures:[e.edits.feature]})}});return i._set("steps",this._createWorkflowSteps(i,t)),i},i._createWorkflowSteps=function(e,t="awaiting-feature-creation-info"){const{data:i,handles:r}=e,o=new Map,n={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){i.creationInfo=null,i.edits.feature=null,i.viewModel.featureTemplatesViewModel.select(null),r.add(i.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(i.creationInfo=e,i.viewModel.activeWorkflow?.next())})),this.id)},async tearDown(){r.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){r.add(await p.setUpFeatureAdd(i.viewModel.sketchViewModel,i.creationInfo,(e=>{i.edits.feature=e,i.viewModel.activeWorkflow?.next()}),o),this.id)},async tearDown(){r.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const e=i.edits.feature,t=e.sourceLayer,n=i.viewModel,s=n.sketchViewModel,l=p.findLayerInfo(n.layerInfos,t),d=l?.formTemplate,{spatialReference:c}=n.view;n.featureFormViewModel.set({arcadeEditType:"INSERT",feature:e,formTemplate:d,spatialReference:c}),s.allowDeleteKey=!1,p.prepareAttachmentsForCreateWorkflow(n.attachmentsViewModel);const u=p.getVisualVariableAttributes(e);await p.startUpdatingFeature({graphic:e,sketchViewModel:s,sourceLayer:t,visualVariables:u,webStyleCache:o});const w=s.on("update",(async e=>{const a=e.graphics[0];if("complete"===e.state)return p.startUpdatingFeature({graphic:a,sketchViewModel:s,sourceLayer:t,visualVariables:u,webStyleCache:o});await p.visualVariableInteractiveUpdate(s.view,a,e,u,o);const i=a.attributes;if(null!=u.rotation){const{field:e}=u.rotation;n.featureFormViewModel.setValue(e,i[e])}if(null!=u.size){const{field:e}=u.size;n.featureFormViewModel.setValue(e,i[e])}}));r.add([i.viewModel.featureFormViewModel.on("value-change",(async()=>{i.edits.updateAttributes(i.viewModel.featureFormViewModel.getValues()),e.attributes=i.edits.feature.attributes,"3d"===s.view.type&&await p.updateGraphicSymbolWhenRequired(e,o)})),w,a.watch((()=>i.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&i.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&i.viewModel.activeWorkflow.go("editing-attachment")}))],this.id)},async tearDown(e){e.canceled&&i.viewModel.sketchViewModel.layer.removeAll(),r.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}})},s=p.createWorkflowSteps(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],t,n);return p.avoidFeatureTemplateSelectionWithOnlyOneItem(i,s)},e._createClass(i,[{key:"shouldShowAttachments",get:function(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&p.shouldShowAttachmentsForCreateWorkflow(this.data)}},{key:"shouldAllowAttachmentEditing",get:function(){return this.shouldShowAttachments}},{key:"hasPendingEdits",get:function(){return!0}},{key:"helpMessage",get:function(){if("editing-new-feature"!==this.stepId)return;const{creationInfo:e,viewModel:t}=this.data,a=t.sketchViewModel.createGraphic?.geometry,i=e.layer.geometryType;return d.getDrawHelpMessage(i,a,t.view)}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const{layer:e}=this.data.creationInfo,t=e.capabilities?.operations.supportsAdd,a=l.getEffectiveLayerCapabilities(e)?.operations.supportsAdd;return l.getEffectiveEditingEnabled(e)&&!e.editingEnabled||!!a&&!t}}]),i}(w);t.__decorate([i.property()],h.prototype,"shouldShowAttachments",null),t.__decorate([i.property()],h.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([i.property()],h.prototype,"hasPendingEdits",null),t.__decorate([i.property()],h.prototype,"helpMessage",null),t.__decorate([i.property()],h.prototype,"reliesOnOwnerAdminPrivileges",null),h=f=t.__decorate([s.subclass("esri.widgets.Editor.CreateWorkflow")],h);return h}));
