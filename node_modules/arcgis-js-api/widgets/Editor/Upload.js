/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Error","../../core/events","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/Point","../../layers/support/infoFor3D"],(function(e,o,t,r,n,c,s,a,l,i,u,p,d,f,y,h,m,_){"use strict";const w=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));o.Upload=function(o){function r(){var e;return(e=o.call(this,{})||this)._uploadTask=null,e}t._inherits(r,o);var n=r.prototype;return n.destroy=function(){this.cancel()},n.uploadTo=function(o){this.cancel(),this._uploadTask=c.createTask((async t=>{const r=await b(o);if(u.throwIfAborted(t),0===r.length)throw u.createAbortError();const n=(await new Promise(((o,t)=>e(["../../geometry/Mesh"],(e=>o(w(e))),t)))).default;u.throwIfAborted(t);const c=new m({x:0,y:0,z:0,spatialReference:o.spatialReference}),a=await n.createFromFiles(c,r,{layer:o,signal:t});if(u.throwIfAborted(t),!a)throw new s("editor:upload","could not upload or convert model");return a.load()}))},n.cancel=function(){this._uploadTask=i.abortMaybe(this._uploadTask)},t._createClass(r,[{key:"state",get:function(){const e=this._uploadTask;return e?e.finished?e.error?u.isAbortError(e.error)?"canceled":"error":"success":"pending":"default"}},{key:"result",get:function(){return this._uploadTask?.value??null}},{key:"error",get:function(){return this._uploadTask?.error??null}}]),r}(n),r.__decorate([p.property()],o.Upload.prototype,"state",null),r.__decorate([p.property()],o.Upload.prototype,"result",null),r.__decorate([p.property()],o.Upload.prototype,"error",null),r.__decorate([p.property()],o.Upload.prototype,"_uploadTask",void 0),o.Upload=r.__decorate([h.subclass("esri.widgets.Editor.Upload")],o.Upload);let g=null;async function b(e){return"showOpenFilePicker"in window&&!g?k(e):T(e)}async function k(e){try{const o=await window.showOpenFilePicker({multiple:!0,excludeAcceptAllOption:!0,types:_.getFilePickerAcceptTypes(e.infoFor3D)});return Promise.all(o.map((e=>e.getFile())))}catch(o){return u.throwIfNotAbortError(o),[]}}async function T(e){const o=u.createResolver();let t;const r=document.createElement("input");r.type="file",r.multiple=!0,r.accept=_.getSupportedExtensions(e.infoFor3D).join(",");const n=l.handlesGroup([a.on(r,"change",(()=>s(c()))),l.makeHandle((()=>clearTimeout(t))),a.on(document,["focus","focusin"],i),a.on(window,["focus","focusin"],i)]);function c(){return r.files?Array.from(r.files):[]}function s(e){n.remove(),o.resolve(e)}function i(){clearTimeout(t),t=setTimeout((()=>{if(!document.hasFocus())return;const e=c();0===e.length&&s(e)}),U)}return g?g(r):r.click(),o.promise.finally((()=>n.remove()))}function v(e){g=o=>{setTimeout((()=>{const t=new DataTransfer;e.forEach((e=>t.items.add(e))),o.files=t.files,o.dispatchEvent(new Event("change"))}))}}function F(){g=null}const U=5e3;o.clearPromptForFilesStub=F,o.simulateSelectingFiles=v,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})}));
