/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/MapUtils","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,s,o,a,n,i,c,u,l){"use strict";const p="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",f="esri.widgets.FeatureForm.FormExpressionsManager";e.FormExpressionsManager=function(e){function r(t){var r;return(r=e.call(this,t)||this)._fieldReferencesLookup=new Map,r._fieldsAffectedLookup=new Map,r._latestFieldValues={...t.feature.attributes},r}t._inherits(r,e);var s=r.prototype;return s.initialize=function(){this._dependencyGraph=this._buildDependencyGraph()},s.evaluateAll=function(){return this._evaluate(this.executors)},s.evaluateExpressions=function(e){return this._evaluate(e)},s.evaluateInvalidated=function(e){const{_fieldReferencesLookup:t,_latestFieldValues:r,feature:s}=this,o=new Set;for(const a of e)if(r[a]=s.getAttribute(a),t.has(a))for(const e of t.get(a))o.add(e);return this._evaluate([...o])},s.evaluateInvalidatedByGeometry=async function(){if(this._fieldReferencesLookup.has(p))return this._evaluate([...this._fieldReferencesLookup.get(p)])},s.resetExecutors=function(){for(const e of this.executors)e.reset()},s._buildDependencyGraph=function(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:r}=this,s=new Map(this.fieldInputs.map((e=>[e.name,e]))),a=new Map(r.map((e=>[e,new Array])));for(const n of r){for(const r of n.fieldsUsed){o.getOrCreateMapValue(e,r,(()=>new Set)).add(n);const i=s.get(r),c=i?.valueExpressionExecutor,u=i?.editableExpressionExecutor;if(null!=c&&c!==n){a.get(c).push(n);o.getOrCreateMapValue(t,c,(()=>new Set)).add(i)}if(null!=u&&u!==n){a.get(u).push(n);o.getOrCreateMapValue(t,u,(()=>new Set)).add(i)}}if(n.geometryUsed){o.getOrCreateMapValue(e,p,(()=>new Set)).add(n)}}return a},s._evaluate=async function(e){const t=new Map,{_dependencyGraph:r,_fieldsAffectedLookup:s,_latestFieldValues:o}=this;for(const a of e)d(a,t,r);for(const[i,{resolver:c,dependencyPromises:u}]of t){Promise.all(u).then((async()=>{const[e,t]=this._makeContext(o);return i.executeAsync(e,t)})).then((()=>{if(s.has(i))for(const e of s.get(i))this._latestFieldValues[e.name]=e.value;c.resolve()}),(e=>{!e||a.isAbortError(e)||_(e)||i.markStale(),c.reject(e)}))}const n=(await Promise.allSettled(Array.from(t.values(),(({resolver:e})=>e.promise)))).filter((e=>"rejected"===e.status&&!(a.isAbortError(e.reason)||_(e.reason))));if(n.length>0)throw new AggregateError(n,"One or more expression executions failed")},s._makeContext=function(e){const[t,r]=this._baseContext,s=this.feature.clone();return s.attributes=e,[{...t,$feature:s},r]},t._createClass(r,[{key:"_baseContext",get:function(){const{editType:e,layer:t,map:r,originalFeature:s,spatialReference:o}=this.arcadeContextInfo,a="feature"===t?.type?t:"scene"===t?.type&&null!=t.associatedLayer?t.associatedLayer:void 0;return[{$originalfeature:s,$editcontext:{editType:e},$layer:a,$featureset:a,$datastore:t?.url,$map:r},{spatialReference:o??void 0}]}},{key:"feature",set:function(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}}]),r}(s),r.__decorate([n.property()],e.FormExpressionsManager.prototype,"_baseContext",null),r.__decorate([n.property()],e.FormExpressionsManager.prototype,"feature",null),r.__decorate([n.property()],e.FormExpressionsManager.prototype,"executors",void 0),r.__decorate([n.property()],e.FormExpressionsManager.prototype,"fieldInputs",void 0),r.__decorate([n.property()],e.FormExpressionsManager.prototype,"arcadeContextInfo",void 0),e.FormExpressionsManager=r.__decorate([l.subclass(f)],e.FormExpressionsManager);const d=(e,t,r)=>{if(t.has(e))return;const s=a.createResolver();t.set(e,{resolver:s,dependencyPromises:[]}),e.abort();const o=r.get(e);for(const a of o)d(a,t,r),t.get(a).dependencyPromises.push(s.promise)},_=e=>e&&"object"==typeof e&&"message"in e&&"Cancelled"===e.message;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
