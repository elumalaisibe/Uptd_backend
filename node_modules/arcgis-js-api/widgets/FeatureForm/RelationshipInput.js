/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../Feature/FeatureRelationship/FeatureRelationshipViewModel","../Feature/support/featureUtils","./EditableInput"],(function(e,t,r,o,i,n,a,l,s,p,u,d){"use strict";const y=3;let c=function(t){function o(e){var o;return(o=t.call(this,e)||this)._relationshipVM=null,o.group=null,o.type="relationship",o.handles.add([r.watch((()=>({feature:o.feature,element:o.element,layer:o.layer})),(e=>o._createRelationshipVM(e)),r.initial)]),o}e._inherits(o,t);var i=o.prototype;return i.destroy=function(){this._relationshipVM?.destroy()},i.incrementPage=function(){this._relationshipVM&&this._relationshipVM.featurePage++},i.getRelatedFeatureByObjectId=function(e){return this._relationshipVM?.getRelatedFeatureByObjectId(e)},i._createRelationshipVM=function(e){const{feature:t,element:r,layer:o}=e;if(this._relationshipVM?.destroy(),!t||!r||!o)return;const{displayCount:i,map:n,orderByFields:a,relationshipId:l,showAllEnabled:s}=this;u.isRelatableFeatureSupportedLayer(o)&&(this._relationshipVM=new p({graphic:t,displayCount:i,layer:o,map:n,orderByFields:a,relationshipId:l,showAllEnabled:s}))},e._createClass(o,[{key:"canAddRelatedFeature",get:function(){const{editable:e,featureCount:t,_relationshipVM:r}=this;if(!r?.relationship||!this.loaded||!this.relatedLayerAllowsAdds)return!1;const{cardinality:o,role:i}=r.relationship;return!("one-to-one"===o&&t>0)&&("many-to-many"!==o&&(!("one-to-many"===o&&"destination"===i&&t>0)&&e))}},{key:"displayCount",get:function(){return this.element.displayCount??y}},{key:"displayType",get:function(){return this.element.displayType}},{key:"editable",get:function(){return!!this.relatedLayerAllowsEdits&&(this.evaluatedEditableExpression??!1)}},{key:"featureCount",get:function(){return this._relationshipVM?.featureCount??0}},{key:"map",get:function(){return this._get("map")},set:function(e){e&&this._relationshipVM?.set("map",e),this._set("map",e)}},{key:"orderByFields",get:function(){return this.element.orderByFields}},{key:"relationshipId",get:function(){return this.element.relationshipId}},{key:"relatedFeatureInfos",get:function(){return this._relationshipVM?.relatedFeatureInfos??[]}},{key:"relatedLayer",get:function(){return this._relationshipVM?.relatedLayer}},{key:"relatedLayerAllowsAdds",get:function(){const{relatedLayer:e}=this;if(!e||!this.relatedLayerAllowsEdits)return!1;const t=s.getEffectiveLayerCapabilities(e);return!!t?.operations?.supportsAdd}},{key:"relatedLayerAllowsEdits",get:function(){const{relatedLayer:e}=this;if(!e)return!1;const t=s.getEffectiveLayerCapabilities(e);return!!t?.operations?.supportsEditing}},{key:"showAllEnabled",get:function(){return this._get("showAllEnabled")},set:function(e){this._relationshipVM?.set("showAllEnabled",e),this._set("showAllEnabled",e)}},{key:"showAllActionVisible",get:function(){return!this.showAllEnabled&&this.featureCount>0&&this.featureCount>this.displayCount}},{key:"visible",get:function(){const{_relationshipVM:e,relatedLayer:t}=this;if(!e?.relationship)return!1;const{cardinality:r}=e.relationship;return"many-to-many"!==r&&(!(t&&!s.isTable(t))&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element))}},{key:"updating",get:function(){return"loading"===this._relationshipVM?.state||"querying"===this._relationshipVM?.state}},{key:"loaded",get:function(){return"ready"===this._relationshipVM?.state}}]),o}(d);t.__decorate([o.property()],c.prototype,"canAddRelatedFeature",null),t.__decorate([o.property()],c.prototype,"displayCount",null),t.__decorate([o.property()],c.prototype,"displayType",null),t.__decorate([o.property()],c.prototype,"editable",null),t.__decorate([o.property()],c.prototype,"group",void 0),t.__decorate([o.property()],c.prototype,"map",null),t.__decorate([o.property()],c.prototype,"orderByFields",null),t.__decorate([o.property()],c.prototype,"relationshipId",null),t.__decorate([o.property()],c.prototype,"relatedFeatureInfos",null),t.__decorate([o.property()],c.prototype,"relatedLayer",null),t.__decorate([o.property()],c.prototype,"relatedLayerAllowsAdds",null),t.__decorate([o.property()],c.prototype,"relatedLayerAllowsEdits",null),t.__decorate([o.property()],c.prototype,"showAllEnabled",null),t.__decorate([o.property()],c.prototype,"showAllActionVisible",null),t.__decorate([o.property({readOnly:!0})],c.prototype,"type",void 0),t.__decorate([o.property()],c.prototype,"visible",null),t.__decorate([o.property()],c.prototype,"updating",null),t.__decorate([o.property()],c.prototype,"incrementPage",null),t.__decorate([o.property()],c.prototype,"getRelatedFeatureByObjectId",null),c=t.__decorate([l.subclass("esri.widgets.FeatureForm.RelationshipInput")],c);return c}));
