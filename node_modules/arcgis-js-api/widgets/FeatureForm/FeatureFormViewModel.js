/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../core/deprecate","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/Promise","../../core/reactiveUtils","../../core/string","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../form/FormTemplate","../../layers/support/ContingentValue","../../layers/support/editableLayers","../../layers/support/LayerContingentValuesCache","./featureFormUtils","./FieldInput","./FormExpressionArcadeExecutor","./FormExpressionsManager","./GroupInput","./RelationshipInput"],(function(e,t,n,i,s,o,r,a,l,u,p,c,d,f,h,y,g,m,_,v,I,E,F,C,x,b){"use strict";const V=new n({attributes:{}}),w=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],A=["visibilityExpression"],T=["editableExpression","visibilityExpression"],M="#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",k="#JSAPI_CONTINGENT_VALUE_ANY_HASH",R="#JSAPI_CONTINGENT_VALUE_NULL_HASH",j="esri.widgets.FeatureForm.FeatureFormViewModel",N=r.getLogger(j);let L=function(t){function n(e){var n;return(n=t.call(this,e)||this)._expressionExecutorLookup=new Map,n._expressionsManager=null,n._contingentValuesCache=null,n._featureClone=V.clone(),n._initialFeature=V.clone(),n.arcadeEditType="NA",n.contingencyConstraintViolations=new Map,n.disabled=!1,n.inputs=[],n.map=null,n.relatedRecordCallbacks=null,n.strict=!1,n}e._inherits(n,t);var s=n.prototype;return s.initialize=function(){const e=u.watch((()=>[this.layer,!!this.layer?.loaded,this.formTemplate,this.feature,this.arcadeEditType]),(([e,t])=>{null!=e&&(t?this._updateInputs():e.load().catch((()=>r.getLogger(this).error("Failed to load layer",e.loadError))))}),{equals:([e,t,n,i,s],[o,r,a,l,u])=>e===o&&t===r&&n===a&&i===l&&s===u,initial:!0}),t=u.watch((()=>this._arcadeContextInfo),(e=>{null!=this._expressionsManager&&(this._expressionsManager.arcadeContextInfo=e)})),n=u.watch((()=>this.layer),(e=>{const t="subtype-sublayer"===e?.type?e.parent:"feature"===e?.type?e:null;t&&this.addResolvingPromise(v.createLoadedLayerContingentValuesCache(t).then((e=>{this._contingentValuesCache=e,this.notifyChange("fieldsWithContingentValues")})))}),{initial:!0});this.handles.add([e,t,n])},s.destroy=function(){this.feature=null,this.layer=null,this._contingentValuesCache=a.destroyMaybe(this._contingentValuesCache)},s.formHeaderVisible=function(){const{activeRelationshipInput:e,formDescription:t,formTitle:n}=this;return!(e||!t&&!n)},s.findField=function(e){return this.allFieldInputs.find((t=>t.name===e))},s.getValue=function(e){const{_featureClone:t,layer:n}=this,i=!!n?.getField(e);return t.getAttribute(e)??(i?null:void 0)},s.setValue=function(e,t){const{_featureClone:n,strict:i}=this,s=this.findField(e);t=""===t?null:t,s&&n.getAttribute(e)!==t&&(s.value=t,i&&!s.valid||(this._afterValueChange(s),null!=this._expressionsManager&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([s.name]).finally((()=>this._afterExpressionsEvaluated())))))},s.getValues=function(){return{...this._featureClone.attributes}},s.submit=function(){const e=this.allFieldInputs,t=new Set(e.filter((e=>e.valid)).map((({name:e})=>e))),n=e.filter((e=>!e.valid)).map((({name:e})=>e)),i=this.getValues();if(this.validateContingencyConstraints(i,{includeIncompleteViolations:!0}).length>0)for(const[s,o]of this.contingencyConstraintViolations.entries())"error"===o.type&&(t.delete(s),n.push(s));this.emit("submit",{valid:[...t],invalid:n,values:i})},s.validateContingencyConstraints=function(e,t){const{_contingentValuesCache:n}=this,i=new Map;if(this.contingencyConstraintViolations=i,null==n)return[];const{invalid:s,incomplete:o}=n.validateContingencyConstraints(e),r=[...s,...t?.includeIncompleteViolations?o:[]];for(const a of r)for(const e of a.fieldGroup.fields)i.set(e,a);return r},s.notifyFeatureGeometryChanged=function(){const{_expressionsManager:e,feature:t,_featureClone:n}=this;n.geometry=t.geometry,null!=e&&this.updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally((()=>this._afterExpressionsEvaluated())))},s._emitChangeEvent=function({name:e,valid:t,value:n}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:n,valid:t})},s._updateInputs=function(){const{_featureClone:e,_initialFeature:t,arcadeEditType:n,formTemplate:i,inputs:s,layer:o}=this;if(!o)return;const r={arcadeEditType:n,feature:e,initialFeature:t,layer:o},a=s.slice(),l=null!=i&&i.elements&&i.elements.length>0?this._updateInputsUsingFormElements(a,i.elements,r):this._updateInputsUsingLayerFields(a,o?.fields,r);this.inputs=l},s._updateInputsUsingFormElements=function(e,t,n){const i=new Map;for(const r of e)if(I.isGroupInput(r)){i.set(r.element,r);for(const e of r.inputs)e.element&&i.set(e.element,e)}else r.element&&i.set(r.element,r);const s=new Map,o=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:i,updatedElements:t.filter(S),sharedInitializationProperties:n,group:null,newExpressionExecutorPromises:s});this.updatingHandles.addPromise(Promise.all(Array.from(s.values())).then((()=>{const e=Array.from(this._expressionExecutorLookup.values()),t=I.flattenFieldInputs(o);return this._createExpressionsManager(e,t),this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated()))})));for(const[r,a]of i.entries())i.delete(r),a.destroy();return o},s._updateInputsUsingFormElementsRecursive=function(e){const{existingInputsByElement:t,updatedElements:n,sharedInitializationProperties:i,group:s,newExpressionExecutorPromises:o}=e,r=[];for(const a of n){const e=t.has(a),n=e?t.get(a):I.isGroupElement(a)?this._makeGroupInputFromElement(a,i):I.isFieldElement(a)?this._makeFieldInputFromElement(a,i,s):I.isRelationshipElement(a)?this._makeRelationshipInputFromElement(a,i,s):null;if(n){if(r.push(n),e)if(t.delete(a),I.isGroupInput(n)){const{feature:e}=i;n.set({feature:e})}else if(I.isRelationshipInput(n)){const e=this.relationshipId===a.relationshipId;n.set(i),n.set({map:this.map,showAllEnabled:e})}else n.set(i);else this._assignExpressionExecutors(n,a,o);if(I.isGroupElement(a)){const e=a.elements.filter((e=>S(e)));n.inputs=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:t,updatedElements:e,sharedInitializationProperties:i,group:n,newExpressionExecutorPromises:o})}}}return r},s._updateInputsUsingLayerFields=function(e,t,n){if(!Array.isArray(t))return r.getLogger(this).warn(this.declaredClass,"No attribute fields found."),[];const i=new Map;for(const r of e)if(I.isGroupInput(r)){for(const e of r.inputs)e.destroy();r.inputs.length=0,r.destroy()}else I.isRelationshipInput(r)?r.destroy():I.isFieldInput(r)&&(null!==r.element?r.destroy():i.set(r.field,r));const s=[],{arcadeEditType:o,feature:a,initialFeature:l,layer:u}=n;for(const r of t){const e=i.get(r)??new E({arcadeEditType:o,field:r,feature:a,initialFeature:l,layer:u,value:a?.getAttribute(r.name)??null});s.push(e),i.delete(r)}for(const[r,p]of i.entries())i.delete(r),p.destroy();return s},s._resetFieldInputValues=function(e){for(const t of this.allFieldInputs)t.value=e.getAttribute(t.name)},s._makeFieldInputFromElement=function(e,t,n){const{arcadeEditType:i,feature:s,initialFeature:o,layer:r}=t,{fieldName:a}=e,l=a&&this._layerFieldsByName.get(a);return l?new E({arcadeEditType:i,element:e,field:l,value:s?.getAttribute(e.fieldName)??null,feature:s,initialFeature:o,layer:r,group:n}):null},s._makeGroupInputFromElement=function(e,t){const{feature:n,layer:i}=t;return new x({element:e,inputs:[],feature:n,layer:i})},s._makeRelationshipInputFromElement=function(e,t,n=null){const{map:i}=this,{feature:s,layer:o}=t;return new b({element:e,feature:s,group:n,layer:o,map:i})},s._assignExpressionExecutors=function(e,t,n){const i=I.isGroupElement(t)?A:I.isRelationshipElement(t)?T:w,s=[];for(const o of i){const i=t[o],{_expressionExecutorLookup:s}=this;if(null!=i&&""!==i){const t=`${o}Executor`,r=this._expressionInfosLookup.get(i)?.expression??i;if(s.has(r))e[t]=s.get(r);else if(n.has(r)){const i=n.get(r).then((n=>(e[t]=n,n)));n.set(r,i)}else{const i=F.createFormExpressionArcadeExecutor(r,this.layer).then((n=>(e[t]=n,s.set(r,n),n)));n.set(r,i)}}}return s},s._createExpressionsManager=function(e,t){const{_arcadeContextInfo:n,_featureClone:i}=this;this._expressionsManager=new C.FormExpressionsManager({executors:e,feature:i,arcadeContextInfo:n,fieldInputs:t})},s._afterValueChange=function(e){const{name:t,value:n}=e,{_featureClone:i,formTemplate:s,layer:o}=this;if(!o)return;const r=i.getAttribute(t);i.setAttribute(t,n);const{typeFieldName:a,types:l}=I.getNormalizedFeatureTypeInfo(o);if(t===a&&n!==r){if("subtype-sublayer"===o.type){const e=o.parent?.findSublayerForFeature(i);i.sourceLayer=this.feature.sourceLayer=e}const e=new Set;for(const t of l)if(t.domains&&"object"==typeof t.domains)for(const n of Object.keys(t.domains))e.add(n);for(const t of e){const e=this.findField(t);e&&e.notifyChange("domain")}}if(null!=s){const{description:e,title:n}=s;n&&p.templateHasKey(n,t)&&this.notifyChange("formTitle"),e&&p.templateHasKey(e,t)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)},s._afterExpressionsEvaluated=function(){const{_featureClone:e}=this;for(const t of this.allFieldInputs)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)},s._joinContingentValues=function(){const e=this._contingentValuesCache;if(null==e)return[];const{typeFieldName:t}=I.getNormalizedFeatureTypeInfo(this.layer),n=t?this.getValue(t):null,i=[];for(const r of e.fieldGroups){const{contingencies:e,fields:t,name:s}=r,o=[];for(const i of e)i.isRetired||null!=i.subtype&&i.subtype.code!==n||o.push({values:i.values});o.length>0&&i.push({name:s,fields:t,contingencies:o})}const[s,o]=this._generateJoinPlan(i);return[...s.flatMap((e=>this._joinFieldGroupContingencies(e))),...o.flatMap((e=>e.contingencies))]},s._generateJoinPlan=function(e){const t=new Map,n=[],i=new Set;for(const l of e)for(const e of l.fields)if(t.has(e)){const s=t.get(e),o=l,r=[s.name,o.name].sort().join("|");if(i.has(r))continue;n.push([s,o]),i.add(r),t.set(e,o)}else t.set(e,l);const s=new Set(n.flat()),o=new Set(e);for(const l of s)o.delete(l);const r=new Map,a=new Map;for(const l of new Set(n.flat())){const e=Symbol(l.name);r.set(e,new Set([l])),a.set(l,e)}for(const[l,u]of n){const e=a.get(l),t=a.get(u);if(e===t)continue;const n=r.get(e),i=r.get(t);for(const s of i)n.add(s),a.set(s,e);r.delete(t)}return[[...r.values()].map((e=>[...e])),[...o]]},s._joinFieldGroupContingencies=function(e){const t=e.slice(),n=t.shift();let i=t.shift(),s=this._generateJoinKey(n.fields,i.fields),o=new Set([...n.fields,...i.fields]),r=new Map;for(const l of n.contingencies){const[e]=this._hashContingency(l,s.codedValueFields,!0);r.has(e)?r.get(e)?.push(l):r.set(e,[l])}for(;t.length>0;){const e=new Map,n=t.shift(),a=this._generateJoinKey(o,n.fields);for(const t of i.contingencies){const[n,i]=this._hashContingency(t,s.codedValueFields),o=i?this._findMatchingContingenciesWithAnyHashMask(r,n):r.get(n);if(r.has(k)&&o?.push(...this._findMatchingContingenciesContainingAny(t,r.get(k),s.codedValueFields)),null!=o)for(const r of o){const n=s.rangeFields.length>0?this._joinContingenciesWithRangeDomains(r,t,s.rangeFields):this._joinContingencies(r,t);if(null==n)break;const[i]=this._hashContingency(n,a.codedValueFields,!0);e.has(i)?e.get(i)?.push(n):e.set(i,[n])}}r=e,i=n,s=a,o=new Set([...o,...i.fields])}const a=[];for(const l of i.contingencies){const[e,t]=this._hashContingency(l,s.codedValueFields),n=t?this._findMatchingContingenciesWithAnyHashMask(r,e):r.get(e);if(r.has(k)&&n.push(...this._findMatchingContingenciesContainingAny(l,r.get(k),s.codedValueFields)),null!=n)for(const i of n){const e=s.rangeFields.length>0?this._joinContingenciesWithRangeDomains(i,l,s.rangeFields):this._joinContingencies(i,l);null!=e&&a.push(e)}}return a},s._joinContingencies=function(e,t){const n={values:{...e.values,...t.values}};for(const[i,s]of Object.entries(n.values))"any"===s.objectType&&null!=e.values[i]&&(n.values[i]=e.values[i]);return n},s._joinContingenciesWithRangeDomains=function(e,t,n){const i=this._joinContingencies(e,t);for(const s of n){const n=e.values[s],o=t.values[s],{leftIsNull:r,rightIsNull:a,bothAreNull:l,leftIsAny:u,rightIsAny:p,bothAreAny:c,leftIsRange:d,rightIsRange:f}=this._compareObjectTypes(n.objectType,o.objectType);if(l||c)continue;if(r&&p||a&&u){i.values[s]=new m({objectType:"null"});continue}if(r&&f||a&&d)return null;u?(n.minValue=-1/0,n.maxValue=1/0):p&&(o.minValue=-1/0,o.maxValue=1/0);const h=Math.max(n.minValue,o.minValue),y=Math.min(n.maxValue,o.maxValue);if(h>y)return null;i.values[s]=new m({objectType:"range",minValue:h,maxValue:y})}return i},s._findMatchingContingenciesContainingAny=function(e,t,n){return t.filter((t=>n.every((n=>{const i=t.values[n],s=e.values[n];return"any"===i.objectType||"any"===s.objectType||i.codedValue?.code===s.codedValue?.code}))))},s._findMatchingContingenciesWithAnyHashMask=function(e,t){const n=RegExp(`${t}$`),i=[];for(const[s,o]of e){if(s===k)break;n.test(s)&&i.push(...o)}return i},s._generateJoinKey=function(e,t){const n=Array.isArray(e)?new Set(e):e,i=Array.isArray(t)?new Set(t):t,s=n.size<i.size?n:i,o=s===n?i:n,r=new Set,a=new Set;for(const l of s)if(o.has(l)){const e=this.layer?.getFieldDomain(l,{feature:this.feature});if(null==e)continue;switch(e.type){case"coded-value":r.add(l);break;case"range":a.add(l)}}return{codedValueFields:[...r],rangeFields:[...a]}},s._hashContingency=function(e,t,n=!1){if(t.length<1)return[M,!1];const i=[];let s=!1;for(const o of t){const t=e.values[o];if("any"===t.objectType){if(n)return[k,!0];s=!0,i.push(`${o}:.*`)}else"null"===t.objectType?i.push(`${o}:${R}`):i.push(`${o}:${t.codedValue?.code}`)}return[i.sort().join("&"),s]},s._compareObjectTypes=function(e,t){return{leftIsNull:"null"===e,rightIsNull:"null"===t,bothAreNull:"null"===e&&"null"===t,leftIsAny:"any"===e,rightIsAny:"any"===t,bothAreAny:"any"===e&&"any"===t,leftIsRange:"range"===e,rightIsRange:"range"===t}},e._createClass(n,[{key:"_expressionInfosLookup",get:function(){return new Map(this.formTemplate?.expressionInfos?.map((e=>[e.name,e])))}},{key:"activeRelationshipInput",get:function(){return this.allRelationshipInputs.find((e=>e.relationshipId===this.relationshipId))}},{key:"_arcadeContextInfo",get:function(){const{_initialFeature:e,arcadeEditType:t,layer:n,map:i,spatialReference:s}=this;return{layer:_.isEditableLayer(n)?n:null,originalFeature:e,editType:t,map:i,spatialReference:s}}},{key:"allFieldInputs",get:function(){return I.flattenFieldInputs(this.inputs)}},{key:"allRelationshipInputs",get:function(){return I.flattenRelationshipInputs(this.inputs)}},{key:"_layerFieldsByName",get:function(){return new Map(this.layer?.fields.map((e=>[e.name,e])))}},{key:"feature",get:function(){return this._get("feature")},set:function(e){this._featureClone=e?e.clone():V.clone(),this._initialFeature=this._featureClone.clone(),e?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach((t=>t.feature=e))):(this.inputs.forEach((e=>e.destroy())),this.inputs.length=0),this.contingencyConstraintViolations.clear(),null!=this._expressionsManager&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated())))),this._set("feature",e)}},{key:"fieldsWithContingentValues",get:function(){if(null==this._contingentValuesCache)return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap((e=>e.fields));return new Set(e)}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}},{key:"formDescription",get:function(){const{formTemplate:e,layer:t}=this;return null!=e&&e.description&&t?I.parseFormTemplateString(e.description,this.getValues(),t.fieldsIndex):null}},{key:"formTitle",get:function(){const{formTemplate:e,layer:t}=this;return null!=e&&e.title&&t?I.parseFormTemplateString(e.title,this.getValues(),t.fieldsIndex):null}},{key:"inputFields",get:function(){return i.deprecatedProperty(N,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs},set:function(e){i.deprecatedProperty(N,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs=e}},{key:"joinedContingentValues",get:function(){return this._joinContingentValues()}},{key:"layer",get:function(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(e){this._override("layer",e)}},{key:"relationshipId",get:function(){return this._get("relationshipId")},set:function(e){const t=this.allRelationshipInputs;if(null!=e&&e===this.relationshipId||t.forEach((e=>e.showAllEnabled=!1)),null!=e){const n=t.find((t=>t.relationshipId===e));n&&(n.showAllEnabled=!0)}this._set("relationshipId",e)}},{key:"spatialReference",get:function(){return this.layer?.spatialReference??null},set:function(e){this._override("spatialReference",e)}},{key:"state",get:function(){return this.get("layer.loaded")?"ready":"disabled"}},{key:"submittable",get:function(){return!!this.valid||this.allFieldInputs.filter((e=>!e.valid)).every((({submittable:e})=>e))}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"valid",get:function(){const e=this.allFieldInputs;return e.length>0&&e.every((({valid:e})=>e))}},{key:"view",get:function(){return i.deprecatedProperty(N,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._get("view")},set:function(e){i.deprecatedProperty(N,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._set("view",e),e?.map&&(this.map=e.map)}}]),n}(o.HandleOwnerMixin(l.EsriPromiseMixin(s.EventedAccessor)));function S(e){return"field"===e.type||"group"===e.type||"relationship"===e.type||(r.getLogger(j).warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)}t.__decorate([c.property()],L.prototype,"_expressionInfosLookup",null),t.__decorate([c.property()],L.prototype,"_featureClone",void 0),t.__decorate([c.property()],L.prototype,"activeRelationshipInput",null),t.__decorate([c.property()],L.prototype,"_arcadeContextInfo",null),t.__decorate([c.property({readOnly:!0})],L.prototype,"allFieldInputs",null),t.__decorate([c.property()],L.prototype,"allRelationshipInputs",null),t.__decorate([c.property()],L.prototype,"_layerFieldsByName",null),t.__decorate([c.property()],L.prototype,"arcadeEditType",void 0),t.__decorate([c.property()],L.prototype,"contingencyConstraintViolations",void 0),t.__decorate([c.property()],L.prototype,"disabled",void 0),t.__decorate([c.property()],L.prototype,"feature",null),t.__decorate([c.property()],L.prototype,"fieldsWithContingentValues",null),t.__decorate([c.property({type:g})],L.prototype,"formTemplate",null),t.__decorate([c.property()],L.prototype,"formDescription",null),t.__decorate([c.property()],L.prototype,"formTitle",null),t.__decorate([c.property()],L.prototype,"formHeaderVisible",null),t.__decorate([c.property()],L.prototype,"inputs",void 0),t.__decorate([c.property()],L.prototype,"inputFields",null),t.__decorate([c.property()],L.prototype,"joinedContingentValues",null),t.__decorate([c.property()],L.prototype,"layer",null),t.__decorate([c.property()],L.prototype,"map",void 0),t.__decorate([c.property()],L.prototype,"relatedRecordCallbacks",void 0),t.__decorate([c.property()],L.prototype,"relationshipId",null),t.__decorate([c.property()],L.prototype,"spatialReference",null),t.__decorate([c.property()],L.prototype,"state",null),t.__decorate([c.property()],L.prototype,"strict",void 0),t.__decorate([c.property()],L.prototype,"submittable",null),t.__decorate([c.property()],L.prototype,"updating",null),t.__decorate([c.property()],L.prototype,"valid",null),t.__decorate([c.property()],L.prototype,"view",null),t.__decorate([c.property()],L.prototype,"getValues",null),t.__decorate([c.property()],L.prototype,"submit",null),L=t.__decorate([y.subclass(j)],L);return L}));
