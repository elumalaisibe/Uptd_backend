/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/CodedValue","../../layers/support/CodedValueDomain","../../layers/support/Domain","../../layers/support/InheritedDomain","../../layers/support/RangeDomain","../../layers/support/domainUtils","../../layers/support/fieldUtils","../Feature/support/featureUtils","./EditableInput","./featureFormUtils"],(function(e,t,i,r,n,l,o,a,u,s,p,d,y,c,_,m,f){"use strict";var h;!function(e){e.Text="text",e.Number="number",e.Date="date",e.Unsupported="unsupported"}(h||(h={}));const g="__internal-type-based-coded-value-domain__";let E=function(t){function i(e){var i;return(i=t.call(this,e)||this)._storedValue=null,i.error=null,i.field=null,i.group=null,i.requiredExpressionExecutor=null,i.type="field",i.valueExpressionExecutor=null,i}e._inherits(i,t);var r=i.prototype;return r._isDomainCompatible=function(e){const{field:t}=this;if("coded-value"===e?.type){const i=typeof e.codedValues[0].code;if("string"===i&&c.isStringField(t)||"number"===i&&c.isNumericField(t))return!0}return!!("range"===e?.type&&c.isNumericField(t)||c.isDateField(t))},r._validate=function(){const{dataType:e,domain:t,field:i,initialFeature:r,minLength:n,required:l,valid:o,value:a}=this,u=l&&null==a,s=void 0!==o;return!u&&r.getAttribute(i.name)===a&&s?null:u?c.TypeValidationError.INVALID_TYPE:"text"===e&&n>-1&&"string"==typeof a&&a.length<n?f.LengthValidationError.TOO_SHORT:t?null!==a||l?y.validateDomainValue(t,a):null:c.validateFieldValue(i,a)},e._createClass(i,[{key:"_dateRange",get:function(){const{element:e}=this;if("datetime-picker"===e?.input?.type){const{max:t,min:i}=e.input;return{max:t,min:i}}return{min:null,max:null}}},{key:"_configAllowsEdits",get:function(){const{element:e,layer:t,name:i}=this;if(null!=e)return e.editableExpression?!!this.evaluatedEditableExpression:!1!==e.editable;if(t?.userHasUpdateItemPrivileges)return!0;const r=t&&"popupTemplate"in t?t?.popupTemplate?.fieldInfos?.find((({fieldName:e})=>e===i)):null;return r?.isEditable??!0}},{key:"_layerAndFieldAllowEdits",get:function(){return this.layerAllowsEdits&&this.field?.editable}},{key:"_isVisibleByDefault",get:function(){const{field:e,layer:t}=this;return!!e?.visible&&c.isFieldVisibleByDefault(e,t)}},{key:"_isEditTrackingField",get:function(){return c.getLowerCaseEditTrackingFields(this.layer).includes(this.name?.toLowerCase())}},{key:"_shouldUseValueExpression",get:function(){return this._layerAndFieldAllowEdits&&!this._configAllowsEdits&&null!=this.valueExpressionExecutor}},{key:"dataType",get:function(){const{field:e}=this;return c.isNumericField(e)?h.Number:c.isStringField(e)?h.Text:c.isDateField(e)?h.Date:h.Unsupported}},{key:"dateDataType",get:function(){if(this.dataType===h.Date)return"date"!==this.field.type?"string":"number"}},{key:"domain",get:function(){const{layer:e}=this,{typeFieldName:t,types:i}=f.getNormalizedFeatureTypeInfo(e);if(t===this.name&&null==this.field.domain)return new u({name:g,codedValues:i.map((({code:e,name:t})=>new a.CodedValue({code:e,name:t})))});const{feature:r}=this,n=e?.getFieldDomain(this.name,{feature:r}),l=this.element?.domain;return null!=l&&this._isDomainCompatible(l)?l:n}},{key:"editable",get:function(){return!!this._layerAndFieldAllowEdits&&(this.evaluatedEditableExpression??this._configAllowsEdits)}},{key:"evaluatedRequiredExpression",get:function(){const{requiredExpressionExecutor:e}=this;return null!=e?!!e.lastEvaluatedValue:null}},{key:"evaluatedValueExpression",get:function(){const{valueExpressionExecutor:e}=this;return null!=e?e.lastEvaluatedValue:null}},{key:"hint",get:function(){return this.element?.hint}},{key:"includeDate",get:function(){return!(this.dataType!==h.Date||"time-only"===this.field.type)}},{key:"includeTime",get:function(){const{element:e,field:t}=this;if(this.dataType!==h.Date)return!1;if("time-only"===t.type)return!0;if("date-only"===t.type)return!1;const i="datetime-picker"===e?.input?.type?e.input.includeTime:void 0;return void 0===i||i}},{key:"includeTimestamp",get:function(){return"timestamp-offset"===this.field.type}},{key:"initialFeature",set:function(e){this._set("initialFeature",e),this.notifyChange("valid")}},{key:"inputType",get:function(){return this.element?.input?.type}},{key:"isRelationshipKeyField",get:function(){const{field:e,layer:t}=this;return _.isRelatableFeatureSupportedLayer(t)&&!!t.relationships?.some((t=>t.keyField===e.name))}},{key:"label",get:function(){return this.element?.label||this.field.alias||this.field.name}},{key:"maxLength",get:function(){const e=-1;if(this.dataType===h.Date)return e;const{field:t,element:i}=this,r=t?.length,n=f.isFieldElementWithTextInput(i)?i.input.maxLength:NaN;return null!=n&&!isNaN(n)&&n>=e&&(r===e||n<=r)?n:r}},{key:"minLength",get:function(){const e=-1;if(this.dataType===h.Date)return e;const{field:t,element:i}=this,r=t?.length,n=f.isFieldElementWithTextInput(i)?i.input.minLength:NaN;return null!=n&&!isNaN(n)&&n>=e&&(r===e||n<=r)?n:e}},{key:"name",get:function(){return this.field?.name}},{key:"range",get:function(){const{_dateRange:e,domain:t,field:i}=this,{max:r,min:n}=e,l=null!=r&&v(r)?r.getTime():null,o=null!=n&&v(n)?n.getTime():null,a=y.getDomainRange(t)||c.getFieldRange(i);if(!a)return{max:l,min:o};const u=a.max===Number.MAX_VALUE?null:a.max,s=a.min===Number.MIN_VALUE?null:a.min;return{max:null!=l&&(null===u||null!=u&&l<u)?l:u,min:null!=o&&(null===s||null!=s&&o>s)?o:s}}},{key:"required",get:function(){const{editable:e,evaluatedRequiredExpression:t,field:i,visible:r}=this;return!!e&&(!1===i?.nullable||!(!r||null==t)&&t)},set:function(e){this._overrideIfSome("required",e)}},{key:"submittable",get:function(){const{field:e,required:t,valid:i,value:r}=this;return(!t||null!=r)&&(!!i||this.initialFeature.getAttribute(e.name)===r)}},{key:"updating",get:function(){const{editableExpressionExecutor:e,valueExpressionExecutor:t}=this;return null!=t&&t.updating||null!=e&&e.updating}},{key:"valid",get:function(){const e=this.editable?this._validate():null;return this._set("error",e),null===e}},{key:"value",get:function(){if(this._shouldUseValueExpression){const e=this.evaluatedValueExpression;if(this.dataType===h.Date){if(e instanceof Date)return e.getTime();if("number"!=typeof e)return parseInt(e,10)}return null!=e&&"object"==typeof e?e.toString():e}return this.get("_storedValue")},set:function(e){this.notifyChange("evaluatedVisibilityExpression"),this.set("_storedValue",e)}},{key:"visible",get:function(){return!this._isEditTrackingField&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element||this._isVisibleByDefault)}}]),i}(m);t.__decorate([i.property()],E.prototype,"_storedValue",void 0),t.__decorate([i.property()],E.prototype,"_configAllowsEdits",null),t.__decorate([i.property()],E.prototype,"_layerAndFieldAllowEdits",null),t.__decorate([i.property()],E.prototype,"_isVisibleByDefault",null),t.__decorate([i.property()],E.prototype,"_isEditTrackingField",null),t.__decorate([i.property()],E.prototype,"_shouldUseValueExpression",null),t.__decorate([i.property()],E.prototype,"dataType",null),t.__decorate([i.property()],E.prototype,"dateDataType",null),t.__decorate([i.property()],E.prototype,"domain",null),t.__decorate([i.property()],E.prototype,"editable",null),t.__decorate([i.property({readOnly:!0})],E.prototype,"error",void 0),t.__decorate([i.property()],E.prototype,"evaluatedRequiredExpression",null),t.__decorate([i.property()],E.prototype,"evaluatedValueExpression",null),t.__decorate([i.property()],E.prototype,"field",void 0),t.__decorate([i.property()],E.prototype,"group",void 0),t.__decorate([i.property({readOnly:!0})],E.prototype,"hint",null),t.__decorate([i.property()],E.prototype,"includeDate",null),t.__decorate([i.property()],E.prototype,"includeTime",null),t.__decorate([i.property()],E.prototype,"includeTimestamp",null),t.__decorate([i.property()],E.prototype,"initialFeature",null),t.__decorate([i.property({readOnly:!0})],E.prototype,"inputType",null),t.__decorate([i.property()],E.prototype,"label",null),t.__decorate([i.property()],E.prototype,"maxLength",null),t.__decorate([i.property()],E.prototype,"minLength",null),t.__decorate([i.property({readOnly:!0})],E.prototype,"name",null),t.__decorate([i.property()],E.prototype,"range",null),t.__decorate([i.property()],E.prototype,"required",null),t.__decorate([i.property()],E.prototype,"requiredExpressionExecutor",void 0),t.__decorate([i.property()],E.prototype,"submittable",null),t.__decorate([i.property({readOnly:!0})],E.prototype,"type",void 0),t.__decorate([i.property()],E.prototype,"updating",null),t.__decorate([i.property()],E.prototype,"valid",null),t.__decorate([i.property({value:null})],E.prototype,"value",null),t.__decorate([i.property()],E.prototype,"valueExpressionExecutor",void 0),t.__decorate([i.property()],E.prototype,"visible",null),E=t.__decorate([o.subclass("esri.widgets.FeatureForm.FieldInput")],E);const v=e=>e&&!Number.isNaN(e.valueOf());return E}));
