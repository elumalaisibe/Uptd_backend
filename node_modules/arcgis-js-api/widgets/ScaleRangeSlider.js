/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/domUtils","../core/events","../core/HandleOwner","../core/maybe","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","../intl/number","./Slider","./Widget","./ScaleRangeSlider/css","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel","./support/componentsUtils","./support/Popover","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/jsxFactory","./support/widgetUtils","../intl/substitute"],(function(e,t,n,a,l,i,s,c,o,r,u,d,S,m,p,v,h,_,M,f,g,y,b,w,x,C,I,T){"use strict";const k={preview:!0,scaleMenus:{maxScaleMenu:!0,minScaleMenu:!0}},R={maximumFractionDigits:0};let L=function(n){function a(e,a){var s;return(s=n.call(this,e,a)||this)._activeMenu=null,s._activeMenuNode=null,s._activeMenuToggleNode=null,s._activeThumb=null,s._customMaxScale=-1,s._customMinScale=-1,s._focusedMenuItemIndex=-1,s._maxScaleMenuPopover=new b({owner:t._assertThisInitialized(s),placement:"bottom-end",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:()=>s._maxScaleMenuEnabled?s.renderMaxScaleMenu():null}),s._minScaleMenuPopover=new b({owner:t._assertThisInitialized(s),placement:"bottom-start",anchorElement:()=>s._activeMenuToggleNode,renderContentFunction:()=>s._minScaleMenuEnabled?s.renderMinScaleMenu():null}),s._maxThumbNode=null,s._minThumbNode=null,s._previewAutoCloseTimeoutId=void 0,s._previewPopover=new b({owner:t._assertThisInitialized(s),placement:"top",anchorElement:()=>0===s._activeThumb?s._minThumbNode:s._maxThumbNode,offset:[0,16],renderContentFunction:s.renderScalePreview}),s._scaleMenuNode=null,s._slider=new v({thumbCreatedFunction:(e,n,a)=>{0===e&&(s._minThumbNode=a),1===e&&(s._maxThumbNode=a),s.addHandles([i.on(a,"mouseenter",(()=>{const{visibleElements:{preview:n}}=t._assertThisInitialized(s);s._activeThumb=e,s._previewPopover.open=n,s.scheduleRender()})),i.on(a,"mouseleave",(()=>{s._previewAutoCloseTimeoutId||(s._activeThumb=null,s._previewPopover.open=!1,s.scheduleRender())}))])}}),s.disabled=!1,s.messages=null,s.region="US",s.viewModel=new g,s.visibleElements=k,s._handleScaleMenuToggleClick=e=>{const t=e.currentTarget,n=t.getAttribute("data-type"),a="menu-closing-click-handle";if(s.handles.remove(a),n===s._activeMenu)return s._setActiveMenu(null),void(s._activeMenuToggleNode=null);s._setActiveMenu(n),s._activeMenuToggleNode=t,s.handles.add(i.on(document,"mousedown",(e=>{const t=e.target,n=l.closest(t,`.${_.CSS.scaleMenuToggle}`),i=n&&n.getAttribute("data-type");if(n&&i===s._activeMenu)return;!i&&s._scaleMenuNode&&!s._scaleMenuNode.contains(t)&&(s._setActiveMenu(null),s.handles.remove(a),s.scheduleRender())})),a)},s._afterMenuListCreate=e=>{s._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},s._handleCustomScaleEntry=e=>{s._setScaleFromMenuSelection(e),s._customMaxScale=-1,s._customMinScale=-1},s._handleCustomScaleInputBlur=()=>{"max"===s._activeMenu?s._customMaxScale=-1:s._customMinScale=-1},s._handleCustomScaleInputKeyDown=e=>{const n=e.currentTarget,{handleCustomScaleSelect:a}=n["data-render-props"],{key:l,ctrlKey:i,metaKey:c}=e,{viewModel:{scaleRanges:o}}=t._assertThisInitialized(s);if("Enter"===l){const t=s.parseScale(n.value);return a?.(isNaN(t)?-1:o.clampScale(t)),e.preventDefault(),void e.stopPropagation()}if(l.length>1||i||c)return;/[:,.\d]/.test(l)||(e.preventDefault(),e.stopPropagation())},s._handleScaleMenuKeyDown=e=>{const t=i.eventKey(e);if("Escape"===t||"Tab"===t)return s._setActiveMenu(null),void s._activeMenuToggleNode?.focus();if("ArrowUp"!==t&&"ArrowDown"!==t)return;const n=Array.from(s._activeMenuNode?.children??[]),a=s._focusedMenuItemIndex,l="ArrowUp"===t?(0===a?n.length:a)-1:(a+1)%n.length;e.preventDefault(),e.stopPropagation(),n[l].focus(),s._focusedMenuItemIndex=l},s}t._inherits(a,n);var s=a.prototype;return s.loadDependencies=function(){return y.loadCalciteComponents({icon:()=>new Promise(((t,n)=>e(["../chunks/calcite-icon"],t,n)))})},s.initialize=function(){this.addHandles([o.watch((()=>this.viewModel),(e=>this._slider.viewModel=e?.sliderViewModel??null),o.initial),o.watch((()=>this._interactive),(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)}),o.initial),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,clearTimeout(this._previewAutoCloseTimeoutId);const n=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=void 0,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),n)})),o.when((()=>!0===this.view?.stationary),(()=>this.scheduleRender()))])},s.destroy=function(){this._previewPopover=c.destroyMaybe(this._previewPopover),this._maxScaleMenuPopover=c.destroyMaybe(this._maxScaleMenuPopover),this._minScaleMenuPopover=c.destroyMaybe(this._minScaleMenuPopover),this._slider=c.destroyMaybe(this._slider)},s.castVisibleElements=function(e){return{...k,...e,scaleMenus:"boolean"==typeof e?.scaleMenus?e.scaleMenus:{...k.scaleMenus,...e?.scaleMenus}}},s.formatScale=function(e){return`1:${p.formatNumber(e,R)}`},s.parseScale=function(e){const t=p.getFormatter().formatToParts(100000.1),n=t.find((e=>"decimal"===e.type))?.value??"",a=t.find((e=>"group"===e.type))?.value??"",l=/[^\d.\s]/g,i=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replaceAll(a,"").replaceAll(n,".").replaceAll(l,"");return parseFloat(i)},s.render=function(){const{_interactive:e,_slider:t,label:n,messages:a,view:l,viewModel:{scaleRanges:i,state:s}}=this,c=a.scaleRangeLabels,o=c[i.findScaleRangeByIndex(t.values[0]).id],r=c[i.findScaleRangeByIndex(t.values[1]).id];return t.layout=I.isRTL(this.container)?"horizontal-reversed":"horizontal",C.tsx("div",{"aria-label":n,class:this.classes(_.CSS.base,_.CSS.widget,e?null:_.CSS.disabled)},"ready"===s&&l?this.renderCurrentScaleIndicator():null,t.render(),C.tsx("div",{class:_.CSS.scaleMenuContainer,key:"scale-menu-toggles"},this._minScaleMenuEnabled?this.renderScaleMenuToggle("min",o):null,this._maxScaleMenuEnabled?this.renderScaleMenuToggle("max",r):null))},s.renderMinScaleMenu=function(){const{effectiveMaxScale:e,effectiveMinScaleLimit:t,view:n,viewModel:{scaleRanges:a}}=this,l=n?n.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:a.findScaleRange(e).minScale,map:l})},s.renderMaxScaleMenu=function(){const{effectiveMinScale:e,effectiveMaxScaleLimit:t,view:n,viewModel:{scaleRanges:a}}=this,l=n?n.scale:void 0;return this.renderScaleMenu({type:"max",min:a.findScaleRange(e).maxScale,max:t,map:l})},s.renderScalePreview=function(){const{_activeThumb:e,_slider:t,region:n,viewModel:{scaleRanges:a}}=this,l=0===e?t.values[0]:t.values[1],i=Object.keys(f.RecommendedScales).indexOf(a.findScaleRangeByIndex(l).id),s={backgroundImage:M.getScalePreviewSource(n),backgroundPosition:M.getScalePreviewSpriteBackgroundPosition(i)};return C.tsx("div",{class:_.CSS.scalePreview},C.tsx("div",{class:_.CSS.scalePreviewThumbnail,styles:s}))},s.renderScaleMenu=function({map:e,min:t,max:n,type:a}){const l=f.fromScaleRange({minScale:t,maxScale:n}),i=this.messages.featuredScaleLabels,s=f.RecommendedScales,c=Object.keys(s).filter((e=>l.contains(s[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:i[e],scaleValue:s[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:o,_customMinScale:r,messages:u}=this,d="max"===a?o:r;return C.tsx("div",{bind:this,class:_.CSS.scaleMenu,"data-type":a,id:`${this.id}__scale-menu--${a}`,key:`${a}-scale-menu`,afterCreate:I.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},C.tsx("div",{class:_.CSS.scaleMenuScroller},C.tsx("ul",{class:_.CSS.scaleMenuList,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:d,scaleLabel:u.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:u.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,c)))},s._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this.effectiveMaxScale:this._customMinScale=this.effectiveMinScale},s.renderScaleMenuToggle=function(e,t){const{_activeMenu:n,_interactive:a}=this,l=n===e;return C.tsx("button",{"aria-controls":l?`${this.id}__scale-menu--${e}`:"","aria-pressed":l?"true":"false",class:this.classes(_.CSS.scaleMenuToggle,l?_.CSS.scaleMenuToggleActive:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!a,type:"button"},C.tsx("div",{class:_.CSS.scaleMenuToggleText,"aria-label":t,title:t},t),C.tsx("span",{class:this.classes(_.CSS.scaleMenuToggleIcon,_.CSS.expandIcon),"aria-hidden":"true"}))},s.renderScaleMenuItem=function(e){const{scaleValue:t,scaleLabel:n,valueVisible:a,handleNamedScaleSelect:l,handleCustomScaleSelect:i=null}=e,{id:s}=this,c=`${s}__custom-scale-input`;return C.tsx("li",{bind:this,class:_.CSS.scaleMenuListItem,"data-scale":t,key:n,onclick:l,onkeydown:l,tabIndex:-1},C.tsx("calcite-icon",{icon:"bullet-point",key:"bullet-icon",scale:"m",class:_.CSS.scaleMenuListItemIcon}),C.tsx("div",{class:_.CSS.scaleMenuListItemContent},C.tsx("label",{class:_.CSS.scaleItemLabel,for:c},n),a?C.tsx("div",{class:_.CSS.scaleItemValue,key:"value"},this.formatScale(t)):null,t>-1&&i?C.tsx("input",{afterCreate:this._focusAndSelectInputOnCreate,class:this.classes(_.CSS.scaleItemValue,_.CSS.scaleItemValueEditable),"data-render-props":e,id:c,key:"value",value:this.formatScale(t),onkeydown:this._handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):null))},s._focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},s.renderCurrentScaleIndicator=function(){const{_slider:e,messages:t,view:n,viewModel:{scaleRanges:a}}=this,l=a.clampScale(n.scale),i=this.viewModel.mapScaleToSlider(l),s=i/e.max,c=t.scaleRangeLabels[a.findScaleRangeByIndex(i).id],o=T.substitute(t.currentScaleTooltip,{scaleLabel:c});return C.tsx("div",{class:_.CSS.scaleIndicatorContainer,key:"scale-indicator"},C.tsx("div",{"aria-label":o,class:_.CSS.scaleIndicator,styles:{left:(I.isRTL(this.container)?-1:1)*s*100+"%"},title:o},this.renderCurrentScaleIndicatorIcon()))},s.renderCurrentScaleIndicatorIcon=function(){return C.tsx("svg",{class:_.CSS.scaleIndicatorIcon,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},C.tsx("polygon",{points:"4 0 8 8 0 8"}))},s._handleRecommendedScaleClick=function(e){const t=Number(e.currentTarget["data-scale"]);this._setScaleFromMenuSelection(t)},s._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this.effectiveMinScale-1):this.minScale=Math.max(e,this.effectiveMaxScale+1),this._setActiveMenu(null),this._activeMenuToggleNode?.focus()},s._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},t._createClass(a,[{key:"_maxScaleMenuEnabled",get:function(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.maxScaleMenu}},{key:"_minScaleMenuEnabled",get:function(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.minScaleMenu}},{key:"_interactive",get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}},{key:"effectiveMaxScale",get:function(){return this.viewModel.effectiveMaxScale}},{key:"effectiveMinScale",get:function(){return this.viewModel.effectiveMinScale}},{key:"effectiveMaxScaleLimit",get:function(){return this.viewModel.effectiveMaxScaleLimit}},{key:"effectiveMinScaleLimit",get:function(){return this.viewModel.effectiveMinScaleLimit}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"maxScale",get:function(){return this.viewModel.maxScale},set:function(e){this.viewModel.maxScale=e}},{key:"maxScaleLimit",get:function(){return this.viewModel.maxScaleLimit},set:function(e){this.viewModel.maxScaleLimit=e}},{key:"minScale",get:function(){return this.viewModel.minScale},set:function(e){this.viewModel.minScale=e}},{key:"minScaleLimit",get:function(){return this.viewModel.minScaleLimit},set:function(e){this.viewModel.minScaleLimit=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}}]),a}(s.HandleOwnerMixin(h));n.__decorate([r.property()],L.prototype,"_maxScaleMenuEnabled",null),n.__decorate([r.property()],L.prototype,"_minScaleMenuEnabled",null),n.__decorate([r.property()],L.prototype,"_slider",void 0),n.__decorate([r.property({readOnly:!0})],L.prototype,"_interactive",null),n.__decorate([r.property()],L.prototype,"disabled",void 0),n.__decorate([r.property()],L.prototype,"effectiveMaxScale",null),n.__decorate([r.property()],L.prototype,"effectiveMinScale",null),n.__decorate([r.property()],L.prototype,"effectiveMaxScaleLimit",null),n.__decorate([r.property()],L.prototype,"effectiveMinScaleLimit",null),n.__decorate([r.property()],L.prototype,"label",null),n.__decorate([r.property()],L.prototype,"layer",null),n.__decorate([r.property()],L.prototype,"maxScale",null),n.__decorate([r.property()],L.prototype,"maxScaleLimit",null),n.__decorate([r.property(),x.messageBundle("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],L.prototype,"messages",void 0),n.__decorate([r.property()],L.prototype,"minScale",null),n.__decorate([r.property()],L.prototype,"minScaleLimit",null),n.__decorate([r.property()],L.prototype,"region",void 0),n.__decorate([r.property()],L.prototype,"view",null),n.__decorate([r.property()],L.prototype,"viewModel",void 0),n.__decorate([r.property()],L.prototype,"visibleElements",void 0),n.__decorate([u.cast("visibleElements")],L.prototype,"castVisibleElements",null),n.__decorate([w.accessibleHandler()],L.prototype,"_handleScaleSelection",null),n.__decorate([w.accessibleHandler()],L.prototype,"_handleRecommendedScaleClick",null),L=n.__decorate([m.subclass("esri.widgets.ScaleRangeSlider")],L);return L}));
