/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/HandleOwner","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./support/componentsUtils","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","./UtilityNetworkTrace/UtilityNetworkTraceViewModel","./UtilityNetworkTrace/support/GraphicHandler"],(function(e,t,s,i,r,o,l,n,a,c,d,u,h,p,g,_,w,m){"use strict";const b="esri-utility-trace-network",v={base:b,loaderContainer:`${b}__loader-container`,loader:`${b}__loader`,fadeIn:`${b}--fade-in`,addButtonContainer:`${b}__add-button-container`,noticeContainer:`${b}__notice-container`,listContainer:`${b}__list-container`,resultsContainer:`${b}__results-container`,flow:`${b}__flow`,numberInput:`${b}__number-input`,esriWidget:"esri-widget",esriWidgetPanel:"esri-widget--panel",esriWidgetDisabled:"esri-widget--disabled",esriButton:"esri-button",esriButtonTertiary:"esri-button--tertiary",esriInput:"esri-input",esriMatchHeight:"esri-match-height",iconHandle:"esri-icon-handle-vertical",iconPlus:"esri-icon-plus",iconEdit:"esri-icon-edit",iconHandleHorizontal:"esri-icon-handle-horizontal",iconRefresh:"esri-icon-refresh",iconLink:"esri-icon-link",iconRemove:"esri-icon-erase",widgetIcon:"esri-icon-UtilityNetworkTrace",header:"esri-widget__heading",loading:"esri-icon-loading-indicator",rotating:"esri-rotating"},y="esri.widgets.UtilityNetworkTrace";function f(e){return{height:e+"px"}}function T(e){return{width:e+"px"}}function S(){return{width:"75%"}}function x(){return{textAlign:"center",padding:"1rem"}}function k(){return{width:"100%"}}function R(){return{height:"100%"}}const A={NOEXTENTION:-2147208474};let C=function(s){function i(e,t){var i;return(i=s.call(this,e,t)||this)._tracesExists=!0,i._graphicHandler=null,i._selectToolActive=!1,i._activeTrace=null,i._activeSwatch="",i._traceHeaderForFlow="",i._assetGroupHeader="",i._assetTypeHeader="",i._traceResultsFunctions=[],i._traceResultsAssetGroup=[],i._traceResultsAssetType=[],i._traceResultsIndividual=[],i._showTraceResultFunctions=!1,i._showTraceResultAssetGroup=!1,i._showTraceResultAssetType=!1,i._showIndividualRecords=!1,i._activeTab="input",i._flagViewType="starting-point",i._alertRemoveModal=!1,i._warningNoFlag=!1,i._warningNoTraceSelected=!1,i._warningNoStartAssetFound=!1,i._warningNoBarrierAssetFound=!1,i._warningNoTerminal=!1,i._confirmReset=!1,i._showResultOptions=!1,i._resultObjectIdField="objectid",i._resultDisplayField="objectid",i._resultSortField="objectid",i._resultSortOrder="desc",i._swatchNode=null,i._individualResultNode=null,i._symbolStartFlag=null,i._symbolBarrier=null,i._watchHandler=null,i._loadUNError=!0,i._errorMessage="",i.disabled=!0,i.iconClass=v.widgetIcon,i.inputSettings=[],i.messages=null,i.messagesUnits=null,i.viewModel=new w,i}t._inherits(i,s);var o=i.prototype;return o.initialize=function(){this._utilityNetworkTraceInitialized(),this._graphicHandler=new m.GraphicHandler},o.checkCanTrace=async function(){this._confirmReset=!1;const e=this.viewModel.checkCanTrace();e.status?(this._warningNoFlag=!1,this._warningNoTraceSelected=!1,this._warningNoTraceSelected=!1,this._warningNoTerminal=!1,this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1,this.switchTab("result"),this.viewModel._activeProgress=!0,this.viewModel.removeResultAreaGrahicsLayer(),await this.viewModel.callTrace(),this.viewModel._activeProgress=!1):e.issues.forEach((e=>{switch(e){case"noStart":this._warningNoFlag=!0;break;case"noTerminalSelected":this._warningNoTerminal=!0;break;default:this._warningNoTraceSelected=!0}}))},o.confirmReset=function(){this._confirmReset=!0},o.render=function(){const{state:e}=this.viewModel;this._mixCustomStrings(),this._overrideFlagSymbol();const t="loading"===e?this.renderLoading():this.renderUtilityNetworkTrace();return _.tsx("div",{class:this.classes(v.base,v.esriWidget,v.esriWidgetPanel,{[v.esriWidgetDisabled]:this.disabled}),styles:R()},t)},o.loadDependencies=function(){return u.loadCalciteComponents({action:()=>new Promise(((t,s)=>e(["../chunks/calcite-action"],t,s))),"action-group":()=>new Promise(((t,s)=>e(["../chunks/calcite-action-group"],t,s))),"action-pad":()=>new Promise(((t,s)=>e(["../chunks/calcite-action-pad"],t,s))),block:()=>new Promise(((t,s)=>e(["../chunks/calcite-block"],t,s))),"block-section":()=>new Promise(((t,s)=>e(["../chunks/calcite-block-section"],t,s))),button:()=>new Promise(((t,s)=>e(["../chunks/calcite-button"],t,s))),checkbox:()=>new Promise(((t,s)=>e(["../chunks/calcite-checkbox"],t,s))),"color-picker-swatch":()=>new Promise(((t,s)=>e(["../chunks/calcite-color-picker-swatch"],t,s))),combobox:()=>new Promise(((t,s)=>e(["../chunks/calcite-combobox"],t,s))),"combobox-item":()=>new Promise(((t,s)=>e(["../chunks/calcite-combobox-item"],t,s))),flow:()=>new Promise(((t,s)=>e(["../chunks/calcite-flow"],t,s))),"flow-item":()=>new Promise(((t,s)=>e(["../chunks/calcite-flow-item"],t,s))),icon:()=>new Promise(((t,s)=>e(["../chunks/calcite-icon"],t,s))),"input-number":()=>new Promise(((t,s)=>e(["../chunks/calcite-input-number"],t,s))),label:()=>new Promise(((t,s)=>e(["../chunks/calcite-label"],t,s))),list:()=>new Promise(((t,s)=>e(["../chunks/calcite-list"],t,s))),"list-item":()=>new Promise(((t,s)=>e(["../chunks/calcite-list-item"],t,s))),loader:()=>new Promise(((t,s)=>e(["../chunks/calcite-loader"],t,s))),modal:()=>new Promise(((t,s)=>e(["../chunks/calcite-modal"],t,s))),notice:()=>new Promise(((t,s)=>e(["../chunks/calcite-notice"],t,s))),option:()=>new Promise(((t,s)=>e(["../chunks/calcite-option"],t,s))),panel:()=>new Promise(((t,s)=>e(["../chunks/calcite-panel"],t,s))),popover:()=>new Promise(((t,s)=>e(["../chunks/calcite-popover"],t,s))),select:()=>new Promise(((t,s)=>e(["../chunks/calcite-select"],t,s))),tab:()=>new Promise(((t,s)=>e(["../chunks/calcite-tab"],t,s))),"tab-nav":()=>new Promise(((t,s)=>e(["../chunks/calcite-tab-nav"],t,s))),"tab-title":()=>new Promise(((t,s)=>e(["../chunks/calcite-tab-title"],t,s))),tabs:()=>new Promise(((t,s)=>e(["../chunks/calcite-tabs"],t,s)))})},o.switchTab=function(e){this._activeTab=e},o.switchToFunctions=function(e,t){this._traceResultsFunctions=e,this._showTraceResultFunctions=t},o.switchToAssetGroup=function(e,t,s){this._traceHeaderForFlow=t,this._traceResultsAssetGroup=e,this._showTraceResultAssetGroup=s},o.switchToAssetType=function(e,t,s){this._assetGroupHeader=t,this._traceResultsAssetType=e,this._showTraceResultAssetType=s},o.switchToIndividualRecords=function(e,t,s){this._assetTypeHeader=t,this._traceResultsIndividual=e,this._showIndividualRecords=s},o.renderLoading=function(){return _.tsx("div",{class:v.loaderContainer,key:"loader"},_.tsx("div",{class:v.loader}))},o.renderUtilityNetworkTrace=function(){const{messages:e}=this;let t=_.tsx("calcite-tabs",{position:"top",layout:"center",styles:k()},_.tsx("calcite-tab-nav",{slot:"title-group"},_.tsx("calcite-tab-title",{selected:"input"===this._activeTab,onclick:()=>{this.switchTab("input")}},e.inputsStrings.headerTabInputs),_.tsx("calcite-tab-title",{selected:"result"===this._activeTab,onclick:()=>{this.switchTab("result")}},e.resultsStrings.headerTabResults)),_.tsx("calcite-tab",{selected:"input"===this._activeTab},this.renderInputPanel()),_.tsx("calcite-tab",{selected:"result"===this._activeTab},this.viewModel._activeProgress?_.tsx("calcite-loader",{label:e.alertsStrings.traceExecuting,text:e.alertsStrings.traceExecuting,type:"indeterminate"}):this.viewModel.traceResults.length>0?this.renderResultPanel():this.renderWarningMessage("noTraceExecuted",!1),_.tsx("calcite-modal",{open:this._confirmReset,kind:"brand",scale:"m",width:"s",onCalciteModalClose:()=>{this._confirmReset=!1}},_.tsx("h3",{slot:"header"},e.resultsStrings.startOverButton),_.tsx("div",{slot:"content"},e.resultsStrings.startOverValidation),_.tsx("calcite-button",{slot:"secondary",width:"full",appearance:"outline",onclick:()=>{this._confirmReset=!1}},e.globalStrings.cancel),_.tsx("calcite-button",{slot:"primary",width:"full",onclick:()=>{this._confirmReset=!1,this.viewModel.reset(),this.switchTab("input")}},e.globalStrings.ok))));return this._tracesExists||(t=_.tsx("calcite-panel",null,this.renderWarningMessage("noTraceConfig",!1))),this._loadUNError||(t=_.tsx("calcite-panel",null,this.renderWarningMessage("loadUNError",!1,this._errorMessage))),t},o.renderInputPanel=function(){const{messages:e}=this;return _.tsx("calcite-flow",{class:v.flow},_.tsx("calcite-flow-item",null,this._warningNoFlag?this.renderWarningMessage("flag",!0):null,this._warningNoTerminal?this.renderWarningMessage("noTerminal",!0):null,this._warningNoTraceSelected?this.renderWarningMessage("trace",!0):null,this.renderTraceSelectorContainer(),this.renderStartFlagsContainer(),this.renderBarriersFlagsContainer(),this._warningNoFlag&&this._warningNoTraceSelected?_.tsx("div",{styles:f(10)}):null,_.tsx("calcite-button",{slot:"footer",scale:"m",kind:"brand",width:"full",onclick:()=>{this.checkCanTrace()}},e.tracingStrings.runTrace)),this._selectToolActive?this.renderActiveTool():null)},o.renderResultPanel=function(){return _.tsx("calcite-flow",{styles:R()},this.renderTraceResults(),this._showTraceResultFunctions?this.renderTraceResultFunctions():null,this._showTraceResultAssetGroup?this.renderTraceResultByAssetGroup():null,this._showTraceResultAssetType?this.renderTraceResultByAssetType():null,this._showIndividualRecords?this.renderTraceResultIndividual():null,this._showIndividualRecords?this.renderTraceResultIndividualPopover():null)},o.renderStartFlagsContainer=function(){const{messages:e}=this,t=[];let s=[];s=this.viewModel._flags.filter((e=>"starting-point"===e.type)),s.forEach((e=>{e.displayValue&&t.push(this.renderFlagRow(e,"start"))}));let i=null;return this._symbolStartFlag&&(i=this._getSymbolIcon(this._symbolStartFlag)),_.tsx("calcite-block",{heading:e.inputsStrings.headerStartingPoint+" ("+s.length+")",open:!0,collapsible:!0},_.tsx("div",{slot:"icon"},i||_.tsx("calcite-icon",{icon:"pin",scale:"s"})),_.tsx("div",null,e.inputsStrings.startingPointHint),_.tsx("div",{class:v.listContainer},t),this._warningNoStartAssetFound?this.renderWarningMessage("noStartAsset",!0):null,_.tsx("div",{class:v.addButtonContainer},_.tsx("calcite-button",{alignment:"center",appearance:"outline",iconStart:"plus",scale:"m",href:"",label:e.inputsStrings.addPointOption,onclick:()=>{this._flagViewType="starting-point",this._selectToolActive=!0,this._warningNoStartAssetFound=!1,this.viewModel.addFlagByHit("starting-point",this._symbolStartFlag).then((e=>{e?this._warningNoFlag=!1:this._warningNoStartAssetFound=!0,this._selectToolActive=!1}))},round:!0})))},o.renderBarriersFlagsContainer=function(){const{messages:e}=this,t=[];let s=[];s=this.viewModel._flags.filter((e=>"barrier"===e.type)),s.forEach((e=>{e.displayValue&&t.push(this.renderFlagRow(e,"barrier"))}));let i=null;return this._symbolBarrier&&(i=this._getSymbolIcon(this._symbolBarrier)),_.tsx("calcite-block",{heading:e.inputsStrings.headerBarrier+" ("+s.length+")",open:!1,collapsible:!0},_.tsx("div",{slot:"icon"},i||_.tsx("calcite-icon",{icon:"x-circle-f",scale:"s"})),_.tsx("div",null,e.inputsStrings.barrierPointHint),_.tsx("div",{class:v.listContainer},t),this._warningNoBarrierAssetFound?this.renderWarningMessage("noBarrierAsset",!0):null,_.tsx("div",{class:v.addButtonContainer},_.tsx("calcite-button",{alignment:"center",appearance:"outline",kind:"brand",iconStart:"plus",scale:"m",href:"",round:!0,label:e.inputsStrings.addPointOption,onclick:()=>{this._flagViewType="barrier",this._selectToolActive=!0,this._warningNoBarrierAssetFound=!1,this.viewModel.addFlagByHit("barrier",this._symbolBarrier).then((e=>{e||(this._warningNoBarrierAssetFound=!0),this._selectToolActive=!1}))}})))},o.renderFlagRow=function(e,t){const{messages:s}=this,i=[];let r=!1;return null!=e.allTerminals&&e.allTerminals.terminals.length>0&&(r=!0,e.allTerminals.terminals.forEach((t=>{let s=!1;e?.selectedTerminals?.includes(t.id)&&(s=!0),i.push(_.tsx("calcite-combobox-item",{key:t.name,selected:s,value:t.id,textLabel:t.name}))}))),_.tsx("calcite-block",{key:"pop"+e.globalId+e.type+e.id+t,heading:e.displayValue?.value??"",collapsible:null!==e.allTerminals||"barrier"===e.type},_.tsx("calcite-action",{textEnabled:!0,slot:"header-menu-actions",text:s.globalStrings.remove,label:s.globalStrings.remove,onclick:()=>{this.viewModel.removeFlag(e)},scale:"s",icon:"trash"}),_.tsx("calcite-action",{textEnabled:!0,slot:"header-menu-actions",text:s.globalStrings.zoomToFeature,label:s.globalStrings.zoomToFeature,onclick:()=>{this.viewModel.zoomToAsset(e.details.geometry)},scale:"s",icon:"zoom-to-object"}),"barrier"===e.type?_.tsx("calcite-label",{scale:"s",layout:"inline"},_.tsx("calcite-checkbox",{checked:e.isFilterBarrier,scale:"s",onclick:()=>{this.viewModel.manageFilterBarrier(!e.isFilterBarrier,e)}}),s.inputsStrings.barrierFilter):null,r?_.tsx("calcite-combobox",{label:s.globalStrings.selectTerminalPlaceholder,placeholder:s.globalStrings.selectTerminalPlaceholder,selectionMode:"multiple",scale:"s",maxItems:0,onCalciteComboboxChange:t=>{t.target.selectedItems.length>0?(e.selectedTerminals=[],t.target.selectedItems.forEach((t=>{this.viewModel.addTerminal(t.value,e)}))):e.selectedTerminals=[]},onCalciteComboboxChipClose:t=>{t.preventDefault(),this.viewModel.removeTerminal(t.target.value,e)}},i):null)},o.renderActiveTool=function(){const{messages:e}=this;let t=null;return"starting-point"===this._flagViewType?this._symbolStartFlag&&(t=this._getSymbolIcon(this._symbolStartFlag)):this._symbolBarrier&&(t=this._getSymbolIcon(this._symbolBarrier)),_.tsx("calcite-flow-item",{onCalciteFlowItemBack:()=>{this.viewModel._clickHandler&&(this.viewModel._clickHandler.remove(),this.view?.popup&&(this.view.popupEnabled=!0)),this._selectToolActive=!1},heading:e.inputsStrings.addPointOption},_.tsx("calcite-block",{open:!0,collapsible:!1,heading:""},_.tsx("div",{styles:x()},t||_.tsx("calcite-icon",{icon:"starting-point"===this._flagViewType?"pin-plus":"x-circle-f",scale:"m"})),_.tsx("div",{styles:x()},e.inputsStrings.addPointHint)))},o.renderTraceSelectorContainer=function(){const{messages:e}=this,t=[];let s=e.tracingStrings.traceOperation,i=0;return this.viewModel._traces.length>0&&this.viewModel._traces.forEach((e=>{t.push(_.tsx("calcite-combobox-item",{key:e.globalId,selected:e.selected,value:e.globalId,textLabel:e.title,onCalciteComboboxItemChange:e=>{const t=e.target;this.viewModel.selectTraces(t.selected,t.value),this.viewModel._traces.length>0&&(this._warningNoTraceSelected=!1)}})),e.selected&&i++})),s+=` (${i})`,_.tsx("calcite-block",{heading:s,open:!0,collapsible:!0},_.tsx("calcite-icon",{icon:"utility-network-trace",scale:"s",slot:"icon"}),_.tsx("calcite-combobox",{label:e.inputsStrings.selectTraces,placeholder:e.inputsStrings.selectTraces,selectionMode:"multiple",overlayPositioning:"fixed",scale:"s",maxItems:0},t))},o.renderStartOverContainer=function(){const{messages:e}=this;return _.tsx("calcite-button",{slot:"footer",scale:"m",kind:"brand",width:"full",onclick:()=>{this.confirmReset()}},e.resultsStrings.startOverButton)},o.renderWarningMessage=function(e,t,s){const{messages:i}=this;let r=i.alertsStrings.NoRunAlertHeader,o=i.alertsStrings.noResultsInfo;switch(e){case"flag":r=i.alertsStrings.startingPointAlertHeader,o=i.alertsStrings.startingPointAlert;break;case"noTerminal":r=i.alertsStrings.noTerminalDefinedHeader,o=i.alertsStrings.noTerminalDefined;break;case"trace":r=i.alertsStrings.selectTraceAlertHeader,o=i.alertsStrings.selectTraceAlert;break;case"noTraceExecuted":r=i.alertsStrings.NoRunAlertHeader,o=i.alertsStrings.noResultsInfo;break;case"noBarrierAsset":case"noStartAsset":r=i.alertsStrings.noAssetsFoundHeader,o=i.alertsStrings.noAssetFound;break;case"noTraceConfig":r="",o=i.alertsStrings.noTraceSupported;break;default:r=i.alertsStrings.genericErrorHeader,o=s||""}return _.tsx("div",{class:v.noticeContainer,key:e},_.tsx("calcite-notice",{key:e,open:!0,closable:t,icon:!0,scale:"s",width:"auto",kind:"danger",onCalciteNoticeClose:()=>{switch(e){case"flag":this._warningNoFlag=!1;break;case"noTerminal":this._warningNoTerminal=!1;break;case"trace":this._warningNoTraceSelected=!1;break;case"noStartAsset":this._warningNoStartAssetFound=!1;break;case"noBarrierAsset":this._warningNoBarrierAssetFound=!1}}},_.tsx("div",{slot:"title"},r),_.tsx("div",{slot:"message"},o)))},o.renderRemoveTraceContainer=function(e){const{messages:t}=this;return _.tsx("calcite-action",{textEnabled:!0,slot:"header-menu-actions",text:t.globalStrings.clearResults,label:t.globalStrings.clearResults,onclick:()=>{this._alertRemoveModal=!0,this._activeTrace=e.trace},scale:"s",icon:"trash"})},o.renderHighlightColorPicker=function(e,t,s){const{messages:i}=this,r=[],o=new RegExp(`^${e.hex}$`,"i");for(let l=0;l<m.HIGHLIGHT_COLOR.length;l++)r.push(_.tsx("calcite-action",{key:l,active:o.test(this._graphicHandler?.getHighlightColor(l).hex),text:i.resultsStrings.graphicColor,label:i.resultsStrings.graphicColor,scale:"s",onclick:()=>{"aggregate"===s?this.viewModel.changeResultGraphicColor(this._graphicHandler?.getHighlightColor(l),t):this.viewModel.changeResultAreaColor(t,this._graphicHandler?.getHighlightColor(l))}},_.tsx("calcite-color-picker-swatch",{scale:"s",color:this._graphicHandler?.getHighlightColor(l).hex,active:o.test(this._graphicHandler?.getHighlightColor(l).hex)})));return _.tsx("calcite-action-pad",{position:"start",layout:"grid",expandDisabled:!0},_.tsx("calcite-action-group",{layout:"grid",columns:4},r))},o.renderTraceResults=function(){const{messages:e}=this,t=this.viewModel.traceResults,s=[];return t.forEach(((t,i)=>{let r=[],o=[],l=!1,n=!1,a=!1,c="";null!==t.results&&t.results.hasOwnProperty("elements")?(null!==t.results.aggregatedGeometry&&(n=!0),null!==t.results.globalFunctionResults&&t.results.globalFunctionResults.length>0&&(o=t.results.globalFunctionResults,o.length>0&&(a=!0)),t.results.elements&&t.results.elements.length>0&&(r=t.results.elements,r.length>0&&(l=!0)),(n||l)&&(c=this.messagesUnits.units[t.resultArea?.unit]?.abbr),s.push(_.tsx("calcite-block",{key:t.trace.title,heading:t.trace.title,description:t.trace.description??"",collapsible:!0,open:!0},this.renderRemoveTraceContainer(t),_.tsx("calcite-list",null,a?_.tsx("calcite-list-item",{label:e.resultsStrings.functionHeader+" ("+o.length+")",onCalciteListItemSelect:()=>{this.switchToFunctions(o,!0)}},_.tsx("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})):null,l&&this.viewModel.showSelectionAttributes?_.tsx("calcite-list-item",{key:this.id,label:e.resultsStrings.viewFeatures+" ("+r.length+")",onCalciteListItemSelect:()=>{this.switchToAssetGroup(this._groupResultsByAssetGroup(t),t.trace.title+" ("+r.length+")",!0)}},_.tsx("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})):this.viewModel.showSelectionAttributes?_.tsx("calcite-label",{layout:"inline",scale:"s"},e.resultsStrings.noSelectionResults):null),l?_.tsx("calcite-label",{layout:"inline",scale:"s",onclick:e=>{e.preventDefault(),e.stopPropagation(),this.viewModel.mergeSelection(!t.selectionEnabled,t.trace)}},_.tsx("calcite-checkbox",{checked:t.selectionEnabled,scale:"m",onclick:e=>{e.preventDefault(),e.stopPropagation(),this.viewModel.mergeSelection(!t.selectionEnabled,t.trace)}}),this.viewModel.showSelectionAttributes?e.resultsStrings.selectFeatures:e.resultsStrings.selectFeatures+" ("+r.length+")"):null,n?_.tsx("calcite-block-section",{toggleDisplay:"switch",text:e.resultsStrings.highlightTrace,open:t.graphicEnabled,onCalciteBlockSectionToggle:e=>{e.target.open?this.viewModel.changeResultGraphicColor(t.graphicColor,t):this.viewModel.removeResultGraphicFromView(t)}},_.tsx("calcite-list",{selectionMode:"none"},_.tsx("calcite-list-item",{label:e.resultsStrings.graphicColor,onclick:e=>{const t=e.target;this._swatchNode=t,this._activeSwatch="aggGeom_"+i}},_.tsx("calcite-color-picker-swatch",{scale:"s",color:t.graphicColor.hex,slot:"actions-end"})))):null,this.enableResultArea&&(n||l)?_.tsx("calcite-block-section",{toggleDisplay:"switch",text:e.resultsStrings.resultAreaHeader,open:t.resultArea?.show,onCalciteBlockSectionToggle:e=>{e.target.open?this.viewModel.addResultAreaToMap(t):this.viewModel.removeResultAreaFromMap(t)}},_.tsx("calcite-list",{selectionMode:"none"},_.tsx("calcite-list-item",{label:e.resultsStrings.graphicColor,onclick:e=>{const t=e.target;this._swatchNode=t,this._activeSwatch="resultArea_"+i}},_.tsx("calcite-color-picker-swatch",{scale:"s",color:t.resultArea?.color.hex,slot:"actions-end"}))),_.tsx("calcite-list",{selectionMode:"none"},_.tsx("calcite-list-item",{label:e.resultsStrings.resultAreaBuffer},_.tsx("calcite-input-number",{scale:"s",slot:"actions-end",max:999999,maxLength:999999,min:0,suffixText:c,value:t.resultArea?.distance.toString(),class:v.numberInput,onCalciteInputNumberChange:e=>{if(!this.view||!this.view.popup)return;this.view.popup.visible&&this.view.closePopup();const s=e.target;t.resultArea.distance>=0?(t.resultArea.distance=parseInt(s.value,10),this.viewModel.removeResultAreaFromMap(t),this.viewModel.addResultAreaToMap(t)):(t.resultArea.distance=0,this.viewModel.removeResultAreaFromMap(t),this.viewModel.addResultAreaToMap(t))}})))):null,_.tsx("calcite-popover",{autoClose:!0,closable:!0,label:e.resultsStrings.graphicColor,referenceElement:this._swatchNode,placement:"auto-start",offsetDistance:0,offsetSkidding:0,scale:"s",open:this._activeSwatch==="aggGeom_"+i||this._activeSwatch==="resultArea_"+i,onCalcitePopoverClose:()=>{this._swatchNode=null,this._activeSwatch=null}},this.renderHighlightColorPicker(this._activeSwatch==="resultArea_"+i?t.resultArea?.color:t.graphicColor,t,this._activeSwatch==="resultArea_"+i?"resultArea":"aggregate"))))):s.push(_.tsx("calcite-block",{key:"error-"+i,heading:t.trace.title,collapsible:!1,open:!0},this.renderRemoveTraceContainer(t),this.renderWarningMessage("noController",!1,t.status)))})),_.tsx("calcite-flow-item",{key:"traceResults",styles:R()},s,this.renderStartOverContainer(),_.tsx("calcite-modal",{open:this._alertRemoveModal,kind:"brand",scale:"m",width:"s",onCalciteModalClose:()=>{this._alertRemoveModal=!1}},_.tsx("h3",{slot:"header"},e.globalStrings.clearResults),_.tsx("div",{slot:"content"},e.alertsStrings.clearResultsAlert),_.tsx("calcite-button",{slot:"secondary",width:"full",appearance:"outline",onclick:()=>{this._alertRemoveModal=!1}},e.globalStrings.cancel),_.tsx("calcite-button",{slot:"primary",width:"full",onclick:()=>{this._activeTrace&&this.viewModel.clearResult(this._activeTrace),this._alertRemoveModal=!1,0===this.viewModel.traceResults.length?this.switchTab("input"):(this._activeTrace=this.viewModel.traceResults[0].trace,this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1)}},e.globalStrings.ok)))},o.renderTraceResultFunctions=function(){const{messages:e}=this,t=this._traceResultsFunctions,s=[];return t.forEach((e=>{s.push(this.renderResultRowFunctions(e))})),_.tsx("calcite-flow-item",{key:"functionResultMultiple",onCalciteFlowItemBack:()=>{this.switchToFunctions([],!1)},heading:e.resultsStrings.functionHeader},s,this.renderStartOverContainer())},o.renderTraceResultByAssetGroup=function(){const e=this._traceResultsAssetGroup,t=[];for(const s in e){const i=e[s];for(const e in i)t.push(this.renderResultRowAssetGroup(i[e]))}return _.tsx("calcite-flow-item",{key:"assetGroupResultMultiple",onCalciteFlowItemBack:()=>{this.switchToAssetGroup([],"",!1)},heading:this._traceHeaderForFlow},_.tsx("calcite-list",null,t),this.renderStartOverContainer())},o.renderTraceResultByAssetType=function(){const e=this._traceResultsAssetType,t=[];for(const s in e)e[s].length>0&&t.push(this.renderResultRowAssetType(e[s]));return _.tsx("calcite-flow-item",{key:"assetTypeResult",onCalciteFlowItemBack:()=>{this.switchToAssetType([],"",!1)},heading:this._assetGroupHeader},_.tsx("calcite-list",{selectionMode:"none"},t),this.renderStartOverContainer())},o.renderTraceResultIndividual=function(){const{messages:e}=this,t=this._traceResultsIndividual;t.sort(this._compare(this._resultSortField,this._resultSortOrder));const s=[];if(t.length>0){t[0].details.fields.some((e=>e.name.toLowerCase()===this._resultDisplayField.toLocaleLowerCase()))||(this._resultDisplayField=this._resultObjectIdField,this._resultSortField=this._resultObjectIdField),t.forEach((e=>{s.push(this.renderResultRowIndividual(e))}))}return _.tsx("calcite-flow-item",{key:"individualResult",onCalciteFlowItemBack:()=>{this._showResultOptions=!1,this.switchToIndividualRecords([],"",!1)},heading:this._assetTypeHeader},_.tsx("calcite-action",{slot:"header-actions-end",text:e.resultsStrings.displayAttribute,onclick:()=>{this._showResultOptions=!0},scale:"m",icon:"gear",label:e.resultsStrings.displayAttribute,id:"field_options"+this.id,afterCreate:h.storeNode,bind:this,"data-node-ref":"_individualResultNode"}),_.tsx("calcite-list",{selectionMode:"none"},s),this.renderStartOverContainer())},o.renderTraceResultIndividualPopover=function(){const{messages:e}=this,t=this._traceResultsIndividual,s=[],i=[];return t.length>0&&t[0].details.fields.forEach((e=>{s.push(_.tsx("calcite-option",{key:"display"+e.name,label:e.alias,value:e.name,selected:e.name===this._resultDisplayField})),i.push(_.tsx("calcite-option",{key:"sort"+e.name,label:e.alias,value:e.name,selected:e.name===this._resultSortField}))})),_.tsx("calcite-popover",{autoClose:!0,label:e.resultsStrings.displayAttribute,referenceElement:this._individualResultNode,placement:"left-start",overlayPositioning:"fixed",offsetDistance:0,offsetSkidding:0,open:this._showResultOptions,styles:null!==this.domNode?T(.75*this.domNode.clientWidth):S()},_.tsx("calcite-block",{heading:"",open:!0},_.tsx("calcite-label",{scale:"s"},e.resultsStrings.displayAttribute,_.tsx("calcite-select",{scale:"s",label:e.resultsStrings.displayAttribute,onCalciteSelectChange:e=>{const t=e.target;this._resultDisplayField=t.selectedOption.value,this._showResultOptions=!1}},s)),_.tsx("calcite-label",{scale:"s"},e.resultsStrings.sortBy,_.tsx("calcite-select",{scale:"s",label:e.resultsStrings.sortBy,onCalciteSelectChange:e=>{const s=e.target;this._resultSortField=s.selectedOption.value,t.sort(this._compare(this._resultSortField,this._resultSortOrder)),this._traceResultsIndividual=t,this._showResultOptions=!1}},i))))},o.renderResultRow=function(e){let t=e[0].assetGroupCode;const s=this.viewModel.getValidSources().filter((t=>t.sourceId===e[0].networkSourceId));if(s.length>0){const i=s[0].assetGroups.filter((t=>t.assetGroupCode===e[0].assetGroupCode));i.length>0&&(t=i[0].assetGroupName)}return _.tsx("calcite-list-item",{label:t+" ("+e.length+")",onCalciteListItemSelect:()=>{this.switchToAssetType(this._groupResultsByAssetType(e),t+" ("+e.length+")",!0)}},_.tsx("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))},o.renderResultRowFunctions=function(e){return _.tsx("calcite-block",{heading:e.networkAttributeName+" "+e.functionType+" = "+e.result,collapsible:!1})},o.renderResultRowAssetGroup=function(e){const t=this._getAssetGroupName(e[0]);return _.tsx("calcite-list-item",{label:t+" ("+e.length+")",onCalciteListItemSelect:()=>{this.switchToAssetType(this._groupResultsByAssetType(e),t+" ("+e.length+")",!0)}},_.tsx("calcite-icon",{slot:"content-end",icon:"chevron-right",scale:"s"}))},o.renderResultRowAssetType=function(e){const t=this._getAssetTypeName(e[0]);return _.tsx("calcite-list-item",{label:t+" ("+e.length+")",onCalciteListItemSelect:()=>{this.viewModel.queryFeaturesById(e).then((s=>{if(s?.length){this._resultObjectIdField=s[0].layer.objectIdField,"objectid"===this._resultDisplayField&&(this._resultDisplayField=s[0].layer.objectIdField),"objectid"===this._resultSortField&&(this._resultSortField=s[0].layer.objectIdField);const i=this._appendAttributes(e,s,"objectId");this.switchToIndividualRecords(i,t+" ("+e.length+")",!0)}else this.switchToIndividualRecords(e,t+" ("+e.length+")",!0)}))}},_.tsx("calcite-icon",{slot:"content-end",icon:"chevron-right",scale:"s"}))},o.renderResultRowIndividual=function(e){const{messages:t}=this;let s="",i=null;for(let r=0;r<e.details.fields.length;r++)e.details.fields[r].name===this._resultDisplayField&&(i=e.details.fields[r]);if("date"===i.type){s=new Date(e.details.attributes[this._resultDisplayField]).toDateString()}else if(null!==i.domain){const t=i.domain.codedValues;let r="";for(let s=0;s<t.length;s++)t[s].code===e.details.attributes[this._resultDisplayField]&&(r=t[s].name);s=r}else s="assetgroup"===this._resultDisplayField.toLocaleLowerCase()?this._getAssetGroupName(e):"assettype"===this._resultDisplayField.toLocaleLowerCase()?this._getAssetTypeName(e):e.details.attributes[this._resultDisplayField];return s&&""!==s&&null!==s?"string"==typeof s&&(s.trim()||(s=t.resultsStrings.noValue)):s=t.resultsStrings.noValue,_.tsx("calcite-list-item",{label:s,onCalciteListItemSelect:()=>{this.viewModel.zoomToAsset(e.details.geometry)}},_.tsx("calcite-icon",{icon:"zoom-to-object",textLabel:t.globalStrings.zoomToFeature,scale:"s",slot:"content-end"}))},o._mixCustomStrings=function(){const{messages:e}=this;this.inputSettings.length>0&&this.inputSettings.forEach((t=>{"starting-point"===t.type&&(e.inputsStrings.headerStartingPoint=t.label,e.inputsStrings.startingPointHint=t.description),"barrier"===t.type&&(e.inputsStrings.headerBarrier=t.label,e.inputsStrings.barrierPointHint=t.description)}))},o._overrideFlagSymbol=function(){this.inputSettings.length>0&&this.inputSettings.forEach((e=>{"starting-point"===e.type?this._symbolStartFlag=e.symbol:this._symbolBarrier=e.symbol,this.viewModel.changeFlagSymbol(e.type,e.symbol)}))},o._utilityNetworkTraceInitialized=function(){return this.viewModel.loadUtilityNetwork().then((e=>{if(e)return this.viewModel.selectTracesOnLoad(),this._registerWatchers(),this.viewModel._traces.length<=0&&(this._tracesExists=!1),this.viewModel.flags.length>0&&this._processFlagOnLoad(),this.view?.when().then((()=>{this._watchViewState()}));this._tracesExists=!1,this.disabled=!1})).catch((e=>{const{messages:t}=this;this._loadUNError=!1,e.details.raw.extendedCode===A.NOEXTENTION?this._errorMessage=t?.alertsStrings?.noUserExtension||e.message:this._errorMessage=e.message,this.disabled=!1}))},o._processFlagOnLoad=function(){return this.view?.when().then((()=>{this._watchHandler=r.when((()=>!this.view?.updating),(async()=>{this._warningNoFlag=!1,this._warningNoBarrierAssetFound=!1,this._warningNoStartAssetFound=!1;const e=await this.viewModel.addFlagsOnLoad();this.viewModel.removeFlagsOnLoadWatcher(),e.includes("barrier")&&(this._warningNoBarrierAssetFound=!0),e.includes("starting-point")&&(this._warningNoStartAssetFound=!0),this.disabled=!1,null!==this._watchHandler&&this._watchHandler.remove()}))}))},o._registerWatchers=function(){this.addHandles([r.watch((()=>this.selectedTraces),(()=>{this.viewModel.selectTracesOnLoad(),this.scheduleRender()})),r.watch((()=>this.defaultGraphicColor),(()=>{this.viewModel.traceResults.length>0&&this.viewModel.traceResults.forEach((e=>{this.viewModel.changeResultGraphicColor(this.viewModel.defaultGraphicColor,e)})),this.scheduleRender()}))])},o._groupResultsByAssetGroup=function(e){const t=[],s=e.results?.elements,i=this._groupBy(s??[],"networkSourceId");for(const r in i)t.push(this._groupBy(i[r],"assetGroupCode"));return t},o._groupResultsByAssetType=function(e){return this._groupBy(e,"assetTypeCode")},o._appendAttributes=function(e,t,s){const i=[];return e.forEach((e=>{t.forEach((t=>{t.featureSet.features.forEach((r=>{e[s]===r.attributes[this._resultObjectIdField]&&(e.details=r,e.details.fields=t.featureSet.fields,i.push(e))}))}))})),i},o._getAssetGroupName=function(e){let t=e.assetGroupCode.toString();const s=e.assetGroupCode,i=this.viewModel.getValidSources().find((t=>t.sourceId===e.networkSourceId));if(i){const e=i.assetGroups.find((e=>e.assetGroupCode===s));e&&(t=e.assetGroupName)}return t},o._getAssetTypeName=function(e){let t=e.assetTypeCode.toString();const s=e.assetGroupCode,i=this.viewModel.getValidSources().find((t=>t.sourceId===e.networkSourceId));if(i){const r=i.assetGroups.find((e=>e.assetGroupCode===s));if(r){const s=r.assetTypes.find((t=>t.assetTypeCode===e.assetTypeCode));s&&(t=s.assetTypeName)}}return t},o._compare=function(e,t){return(s,i)=>{let r=0,o=s.details.attributes[e],l=i.details.attributes[e];return isNaN(o)&&(o=o.toLowerCase()),isNaN(l)&&(l=l.toLowerCase()),"desc"===t?o>l?r=1:o<l&&(r=-1):o<l?r=1:o>l&&(r=-1),r}},o._groupBy=function(e,t){return e.reduce(((e,s)=>((e[s[t]]=e[s[t]]||[]).push(s),e)),{})},o._getSymbolIcon=function(e){return"picture-marker"===e.type?_.tsx("img",{src:e.url??void 0,width:e.width,height:e.height}):null},o._watchViewState=function(){this._watchHandler=r.when((()=>!this.view?.updating),(()=>{this.disabled=!1,null!==this._watchHandler&&this._watchHandler.remove()}),{initial:!0})},t._createClass(i,[{key:"defaultGraphicColor",get:function(){return this.viewModel.defaultGraphicColor},set:function(e){this.viewModel.defaultGraphicColor=e}},{key:"flags",get:function(){return this.viewModel.flags},set:function(e){this.viewModel.flags=e}},{key:"gdbVersion",get:function(){return this.viewModel.gdbVersion},set:function(e){this.viewModel.gdbVersion=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"resultAreaProperties",get:function(){return this.viewModel.resultAreaProperties},set:function(e){this.viewModel.resultAreaProperties=e}},{key:"selectedTraces",get:function(){return this.viewModel.selectedTraces},set:function(e){this.viewModel.selectedTraces=e}},{key:"selectOnComplete",get:function(){return this.viewModel.selectOnComplete},set:function(e){this.viewModel.selectOnComplete=e}},{key:"showGraphicsOnComplete",get:function(){return this.viewModel.showGraphicsOnComplete},set:function(e){this.viewModel.showGraphicsOnComplete=e}},{key:"enableResultArea",get:function(){return this.viewModel.enableResultArea},set:function(e){this.viewModel.enableResultArea=e}},{key:"showSelectionAttributes",get:function(){return this.viewModel.showSelectionAttributes},set:function(e){this.viewModel.showSelectionAttributes=e}},{key:"utilityNetwork",get:function(){return this.viewModel.utilityNetwork},set:function(e){this.viewModel.utilityNetwork=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}}]),i}(i.HandleOwnerMixin(d));s.__decorate([o.property()],C.prototype,"_tracesExists",void 0),s.__decorate([o.property()],C.prototype,"_selectToolActive",void 0),s.__decorate([o.property()],C.prototype,"_activeTrace",void 0),s.__decorate([o.property()],C.prototype,"_activeSwatch",void 0),s.__decorate([o.property()],C.prototype,"_traceHeaderForFlow",void 0),s.__decorate([o.property()],C.prototype,"_assetGroupHeader",void 0),s.__decorate([o.property()],C.prototype,"_assetTypeHeader",void 0),s.__decorate([o.property()],C.prototype,"_traceResultsFunctions",void 0),s.__decorate([o.property()],C.prototype,"_traceResultsAssetGroup",void 0),s.__decorate([o.property()],C.prototype,"_traceResultsAssetType",void 0),s.__decorate([o.property()],C.prototype,"_traceResultsIndividual",void 0),s.__decorate([o.property()],C.prototype,"_showTraceResultFunctions",void 0),s.__decorate([o.property()],C.prototype,"_showTraceResultAssetGroup",void 0),s.__decorate([o.property()],C.prototype,"_showTraceResultAssetType",void 0),s.__decorate([o.property()],C.prototype,"_showIndividualRecords",void 0),s.__decorate([o.property()],C.prototype,"_activeTab",void 0),s.__decorate([o.property()],C.prototype,"_alertRemoveModal",void 0),s.__decorate([o.property()],C.prototype,"_warningNoFlag",void 0),s.__decorate([o.property()],C.prototype,"_warningNoTraceSelected",void 0),s.__decorate([o.property()],C.prototype,"_confirmReset",void 0),s.__decorate([o.property()],C.prototype,"_swatchNode",void 0),s.__decorate([o.property()],C.prototype,"_errorMessage",void 0),s.__decorate([o.property()],C.prototype,"defaultGraphicColor",null),s.__decorate([o.property()],C.prototype,"disabled",void 0),s.__decorate([o.property()],C.prototype,"flags",null),s.__decorate([o.property()],C.prototype,"gdbVersion",null),s.__decorate([o.property()],C.prototype,"iconClass",void 0),s.__decorate([o.property()],C.prototype,"inputSettings",void 0),s.__decorate([o.property()],C.prototype,"label",null),s.__decorate([o.property(),p.messageBundle("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace")],C.prototype,"messages",void 0),s.__decorate([o.property(),p.messageBundle("esri/core/t9n/Units")],C.prototype,"messagesUnits",void 0),s.__decorate([o.property()],C.prototype,"resultAreaProperties",null),s.__decorate([o.property()],C.prototype,"selectedTraces",null),s.__decorate([o.property()],C.prototype,"selectOnComplete",null),s.__decorate([o.property()],C.prototype,"showGraphicsOnComplete",null),s.__decorate([o.property()],C.prototype,"enableResultArea",null),s.__decorate([o.property()],C.prototype,"showSelectionAttributes",null),s.__decorate([o.property()],C.prototype,"utilityNetwork",null),s.__decorate([o.property()],C.prototype,"view",null),s.__decorate([g.vmEvent(["add-flag","add-flag-complete","add-flag-error","select-features","clear-selection"]),o.property({type:w})],C.prototype,"viewModel",void 0),C=s.__decorate([c.subclass(y)],C);return C}));
