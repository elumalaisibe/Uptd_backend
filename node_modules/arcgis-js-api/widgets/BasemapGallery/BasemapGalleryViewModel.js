/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Basemap","../../core/Collection","../../core/HandleOwner","../../core/Loadable","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/projection","../../geometry/support/spatialReferenceUtils","../../support/basemapUtils","./support/basemapCompatibilityUtils","./support/BasemapGalleryItem","./support/LocalBasemapsSource","./support/PortalBasemapsSource"],(function(e,t,a,i,r,s,o,n,c,p,l,u,d,m,y,h,f,v,_){"use strict";const b=i.ofType(f);function w(e){return e&&"esri.portal.Portal"===e.declaredClass}function g(e){return e&&!(e instanceof _)&&(!!e.portal||!!e.query)}function B(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}let I=function(t){function r(e){var a;return(a=t.call(this,e)||this)._loadingProjectionEngine=!1,a.items=new b,a.source=new _,a.view=null,a}e._inherits(r,t);var n=r.prototype;return n.initialize=function(){const e=()=>this._recreateItems();this.handles.add([o.watch((()=>"ready"===this.state?this.compatibilityFunction:null),(()=>this._updateItems())),o.on((()=>this.source?.basemaps),"change",e,{onListenerAdd:e}),o.when((()=>this.view),(()=>{this.source instanceof _&&(this.source.viewType=this.view?.type)}),{once:!0})])},n.castSource=function(e){return Array.isArray(e)||i.isCollection(e)?new v({basemaps:e}):w(e)?new _({portal:e}):g(e)?new _(e):B(e)?e:null},n.basemapEquals=function(e,t){return y.contentEquals(e,t)},n.refresh=function(){this._recreateItems()},n.load=function(e){return this.addResolvingPromise(s.isLoadable(this.source)?this.source.load(e):null),Promise.resolve(this)},n._recreateItems=function(){const e=this.source?.basemaps,{view:t,compatibilityFunction:a}=this;this.items.removeAll().forEach((e=>e.destroy())),e&&this.items.addMany(e.map((e=>new f({basemap:e,compatibilityFunction:a,view:t}))))},n._updateItems=function(){for(const e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view},e._createClass(r,[{key:"activeBasemap",get:function(){return this.view?.map?.basemap??null},set:function(e){const t=this.view;if(!t?.map)return;const i="string"==typeof e?a.fromId(e):e;if(!i||!t.ready)return t.map.basemap=i,void this._clearOverride("activeBasemap");const r=i.spatialReference||this.items?.find((e=>this.basemapEquals(i,e.basemap)))?.spatialReference;if(r&&"spatialReferenceLocked"in t&&!t.spatialReferenceLocked){const a=t.spatialReference;if(null!=r&&!m.equals(a,r)&&!d.canProjectWithoutEngine(t.spatialReference,r)&&!d.isLoaded())return this._override("activeBasemap",i),this._loadingProjectionEngine=!0,void d.load().then((()=>{this._get("activeBasemap")===e&&(t.map.basemap=e,t.spatialReference=r,this._clearOverride("activeBasemap"))}),(()=>{})).then((()=>{this._loadingProjectionEngine=!1}));t.map.basemap=i,this._clearOverride("activeBasemap"),null==r||m.equals(t.spatialReference,r)||(t.spatialReference=r)}else t.map.basemap=i,this._clearOverride("activeBasemap")}},{key:"activeBasemapIndex",get:function(){const{state:e,items:t,activeBasemap:a}=this;if("ready"!==e)return-1;const i=t.findIndex((e=>e.basemap===a));return-1===i?t.findIndex((e=>this.basemapEquals(e.basemap,a))):i}},{key:"compatibilityFunction",get:function(){return"3d"===this.view?.type?h.default3DCompatibility:h.default2DCompatibility},set:function(e){this._overrideIfSome("compatibilityFunction",e)}},{key:"state",get:function(){return this.view?.ready&&this.source?this._loadingProjectionEngine?"loading":"ready":"disabled"}}]),r}(r.HandleOwnerMixin(s));t.__decorate([n.property()],I.prototype,"_loadingProjectionEngine",void 0),t.__decorate([n.property()],I.prototype,"activeBasemap",null),t.__decorate([n.property({readOnly:!0})],I.prototype,"activeBasemapIndex",null),t.__decorate([n.property()],I.prototype,"compatibilityFunction",null),t.__decorate([n.property({readOnly:!0,type:b})],I.prototype,"items",void 0),t.__decorate([n.property()],I.prototype,"source",void 0),t.__decorate([c.cast("source")],I.prototype,"castSource",null),t.__decorate([n.property({readOnly:!0})],I.prototype,"state",null),t.__decorate([n.property()],I.prototype,"view",void 0),I=t.__decorate([u.subclass("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],I);return I}));
