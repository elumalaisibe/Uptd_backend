/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../request","../../core/Collection","../../core/Error","../../core/lang","../../core/Loadable","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../intl/date","../../intl/locale","../../portal/Portal","../../rest/geoprocessor/execute","../../rest/geoprocessor/GPOptions","../../core/has","../../geometry/support/normalizeUtils","../../layers/support/Field","../../layers/support/MapImage","../../config","../../kernel","../../core/urlUtils","../../rest/support/DataFile","../../rest/support/FeatureSet","../../rest/support/LinearUnit","../../rest/support/ParameterValue","../../rest/support/RasterData","../../rest/support/JobInfo","../../rest/print","../../rest/support/fileFormat","../../rest/support/layoutTemplate","../../rest/support/PrintParameters","../../rest/support/PrintTemplate","./CustomTemplate"],(function(e,t,r,o,a,s,i,l,n,p,c,u,d,m,f,y,h,v,_,T,w,x,g,O,S,E,P,b,C,L,I,U,D,F){"use strict";const k=6e4,N=o.ofType(F);function V(e){e.layoutOptions||(e.layoutOptions={}),e.layoutOptions.customTextElements||(e.layoutOptions.customTextElements=[]);const t="date";if(!e.layoutOptions.customTextElements.find((e=>t in e))){const{customTextElements:t}=e.layoutOptions;let r=c.formatDate(Date.now(),c.convertDateFormatToIntlOptions("short-date"));"ar"===u.getLanguage()&&(r="â€"+r),t.push({date:r})}}let A=function(t){function o(r){var o;return(o=t.call(this,r)||this)._serviceTemplateCustomTextElements=null,o.allowedFormats="all",o.allowedLayouts="all",o.defaultTemplates=new N,o.extraParameters=null,o.includeDefaultTemplates=!0,o.error=null,o.portal=d.getDefault(),o.printServiceUrl=null,o.templatesInfo=null,o.updateDelay=1e3,o.view=null,o.templateCustomTextElements=null,o.print=o.print.bind(e._assertThisInitialized(o)),o}e._inherits(o,t);var i=o.prototype;return i.destroy=function(){this.view=null},i.load=async function(e){return this.addResolvingPromise(this._loadResources(e).catch((e=>this.error=e))),this},i.print=async function(e){const{view:t,extraParameters:r,updateDelay:o}=this;if(!t)throw new a("print:view-required","view is not set");V(e);const s=new U({view:t,template:e,extraParameters:r,updateDelay:o});try{return await C.execute(this.effectivePrintServiceUrl,s)}catch(i){throw new a("print:export-error","An error occurred while exporting the web map.",{error:i})}},i.toPrintTemplate=function({attributionEnabled:e,author:t,copyright:r,customTextElements:o,dpi:a,forceFeatureAttributes:s,format:i,height:l,layout:n,legendEnabled:p,northArrowEnabled:c,scale:u,scaleEnabled:d,title:m,width:f}){const y=new D({attributionVisible:e,forceFeatureAttributes:s,format:i,layout:n,layoutOptions:{authorText:t||"",copyrightText:r||"",customTextElements:o,titleText:m||""},outScale:u??0,scalePreserved:d});f&&(y.exportOptions.width=f),l&&(y.exportOptions.height=l),a&&(y.exportOptions.dpi=a),!p&&y.layoutOptions&&(y.layoutOptions.legendLayers=[]);const h=this.templateToNorthArrowInfo[n];if(h){!(h.visible===c)&&y.layoutOptions&&(y.layoutOptions.elementOverrides={[h.name]:{visible:c}})}return y},i._loadResources=async function(e){let t=[];const{printServiceUrl:r}=this;if(!r){if(this.destroyed)return;const{portal:r}=this;try{await r.load(e)}catch(s){throw new a("print:could-not-load-portal","Cannot load print resource information from portal",{url:this.effectivePrintServiceUrl})}const o=r.helperServices?.printTask;o&&(this._set("effectivePrintServiceUrl",o.url),t=(o?.templates??[]).map((e=>F.fromJSON(e))))}t.length>0&&this.defaultTemplates.addMany(t);const o=this.effectivePrintServiceUrl?.toLowerCase().split("/");if(-1===(o?.indexOf("gpserver")??-1))throw new a("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});this._processLayoutTemplateInfos(await this._getLayoutTemplatesInfo(e)),await this._loadServiceDescription(e)},i._loadServiceDescription=async function(e){const t=await this._getPrintTemplatesFromService(e);this._set("templatesInfo",t)},i._getLayoutTemplatesInfo=async function(e){let t=[];const r=async t=>{const r=this.effectivePrintServiceUrl.replace(/(\/GPServer\/).+/i,`$1${encodeURI(t)}`);return(await m.execute(r,null,null,e)).results[0].value};try{t=await r("Get Layout Templates Info Task")}catch(o){}if(!t||t.length<1)try{t=await r("Get Layout Templates Info")}catch(o){}return t},i._processLayoutTemplateInfos=function(e){const t={},r={};e.forEach((({layoutTemplate:e,layoutOptions:{customTextElements:o,mapSurroundInfos:a}})=>{const s=I.fromJSON(e);t[s]=o,a&&(r[s]=a.find((e=>"CIMMarkerNorthArrow"===e.type)))})),this._serviceTemplateCustomTextElements=Object.freeze(t),this.templateToNorthArrowInfo=r},i._getPrintTemplatesFromService=async function(e){return r(this.effectivePrintServiceUrl,{...e,query:{f:"json"},timeout:k}).then((e=>{const t=e&&e.data,r=t&&t.parameters;let o=null,a=null;r.forEach((e=>{let t=e.choiceList&&e.choiceList.slice(),r=-1;t&&t.length&&e.defaultValue&&(r=t.indexOf(e.defaultValue)),r>-1&&(t.splice(r,1),t.unshift(e.defaultValue));const s=(e,t)=>{const r="all"===t?e:e.filter((e=>t.includes(e)));return 0===r.length?e:r};if("Format"===e.name){const r=s(t.map(L.fromJSON),this.allowedFormats),a=L.fromJSON(e.defaultValue);o={defaultValue:r.includes(a)?a:r[0],choiceList:r}}else if("Layout_Template"===e.name){t=t.filter((e=>"map_only"!==e.toLowerCase()));let r,o=-1;t.some(((e,t)=>{const r=e.toLowerCase();return r.includes("letter")&&r.includes("landscape")?(o=t,!0):!(!r.includes("a4")||!r.includes("landscape"))&&(o=t,!1)})),o>0&&(r=t[o],t.splice(o,1),t.unshift(r));const i=s(t.map(I.fromJSON),this.allowedLayouts),l=I.fromJSON(e.defaultValue);a={defaultValue:i.includes(l)?l:i[0],choiceList:i}}})),this.error=null;return{format:o,layout:a}})).catch((e=>{throw new a("print:unavailable-service-info","Can't fetch templates info from service",{error:e})}))},e._createClass(o,[{key:"effectivePrintServiceUrl",get:function(){return this.printServiceUrl??null}},{key:"effectiveTemplateCustomTextElements",get:function(){if(!this._serviceTemplateCustomTextElements)return{};const e=s.clone(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach((t=>{const r=e[t];if(r){const e=this.templateCustomTextElements?.[t];r.forEach((t=>{const[r]=Object.entries(t)[0];e?.forEach((e=>{const[o,a]=Object.entries(e)[0];r===o&&(t[r]=a)}))}))}})),Object.freeze(e)}},{key:"state",get:function(){return"loading"===this.loadStatus?"initializing":this.error||"failed"===this.loadStatus?"error":this.get("view.ready")&&"loaded"===this.loadStatus?"ready":"disabled"}}]),o}(i);t.__decorate([l.property()],A.prototype,"_serviceTemplateCustomTextElements",void 0),t.__decorate([l.property()],A.prototype,"allowedFormats",void 0),t.__decorate([l.property()],A.prototype,"allowedLayouts",void 0),t.__decorate([l.property({type:N})],A.prototype,"defaultTemplates",void 0),t.__decorate([l.property()],A.prototype,"extraParameters",void 0),t.__decorate([l.property()],A.prototype,"includeDefaultTemplates",void 0),t.__decorate([l.property({readOnly:!0})],A.prototype,"effectivePrintServiceUrl",null),t.__decorate([l.property()],A.prototype,"effectiveTemplateCustomTextElements",null),t.__decorate([l.property()],A.prototype,"error",void 0),t.__decorate([l.property({type:d})],A.prototype,"portal",void 0),t.__decorate([l.property()],A.prototype,"printServiceUrl",void 0),t.__decorate([l.property({readOnly:!0})],A.prototype,"state",null),t.__decorate([l.property({readOnly:!0})],A.prototype,"templatesInfo",void 0),t.__decorate([l.property()],A.prototype,"updateDelay",void 0),t.__decorate([l.property()],A.prototype,"view",void 0),t.__decorate([l.property()],A.prototype,"templateCustomTextElements",void 0),t.__decorate([l.property()],A.prototype,"templateToNorthArrowInfo",void 0),A=t.__decorate([p.subclass("esri.widgets.Print.PrintViewModel")],A);return A}));
