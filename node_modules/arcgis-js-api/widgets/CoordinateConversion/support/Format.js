/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Accessor","../../../core/Error","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../geometry/coordinateFormatter","../../../geometry/projection","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","./coordinateConversionUtils","../../../geometry/SpatialReference"],(function(e,t,r,n,o,i,a,s,c,l,u,p,d,f,h,m){"use strict";let g=function(t){function r(e){var r;return(r=t.call(this,e)||this).conversionInfo=null,r.coordinateSegments=null,r.defaultPattern=null,r.name=null,r.viewModel=null,r}e._inherits(r,t);var n=r.prototype;return n.convert=async function(e){if(!h.isValidPoint(e))throw new o("format:invalid-point","Could not convert invalid point.",{point:e});const t=this.get("conversionInfo.convert");if(t)return Promise.resolve().then((()=>t(e)));const r=await this._project(e,this.spatialReference);return{location:r,coordinate:await this._getCoordinate(r)}},n.getConversionStrategy=function(){const e=this._viewSpatialReference;return this.get("conversionInfo.convert")||this.get("viewModel.formatterAvailable")||"xy"===this.name&&(e.isWebMercator||e.isWGS84)||"basemap"===this.name?"client":"server"},n.getDisplayCoordinate=function(e){if(!e)return null;if(!this.coordinateSegments||!this.currentPattern)return e;let t=this.currentPattern;const r=this._getSegmentMatches(e,!1);for(let n=this.coordinateSegments.length-1;n>=0;n--){const e=this.coordinateSegments[n];t=t.replace(e.alias,r[n])}return t},n.parseUserInput=function(e){const{defaultPattern:t,_additionalCharactersPattern:r,coordinateSegments:n}=this;if(!t||!r)return"";let o=t.replace(r,"");e=e.replace(r,"");const i=this._getSegmentMatches(e,!0);if(n)for(let a=n.length-1;a>=0;a--){const e=n[a];o=o.replace(e.alias,i[a])}return o},n._getSegmentMatches=function(e,t){const r=new Array,{coordinateSegments:n}=this;if(!n)return r;for(let o=0;o<n.length;o++){const i=n[o],a=e.match(i.searchPattern);if(!a){r.push("");continue}let s=a[0];if(e=e.replace(s,"").trim(),i.substitution){const e=t?i.substitution.input(s):i.substitution.output(s);e&&(s=`${e}`)}r.push(s)}return r},n.reverseConvert=async function(e){const t=this.parseUserInput(e),r=this.get("conversionInfo.reverseConvert");let n;if(r)n=r(t);else if("xy"===this.name||"basemap"===this.name)n=h.fromXY(t,this.spatialReference);else if(this.viewModel?.formatterAvailable)switch(this.name){case"dd":case"ddm":case"dms":n=u.fromLatitudeLongitude(t,this.spatialReference);break;case"mgrs":{const e="automatic";n=u.fromMgrs(t,this.spatialReference,e);break}case"utm":{const e="latitude-band-indicators";n=u.fromUtm(t,this.spatialReference,e);break}case"usng":n=u.fromUsng(t,this.spatialReference);break;default:n=null}if(!n)throw new o("format:invalid-input","Could not parse input into point.",{userInput:e});return this._project(n,this._viewSpatialReference)},n._getCoordinate=async function(e){const t=this.get("viewModel.view.scale");if(!h.isValidPoint(e))throw new o("format:invalid-point","Could not transform invalid point into coordinate.",{point:e});if(this.get("viewModel.formatterAvailable")||"basemap"===this.name||"xy"===this.name)switch(this.name){case"dd":case"ddm":case"dms":{const r=h.getDegreePrecision(t);return u.toLatitudeLongitude(e,this.name,r)}case"mgrs":{const t=!1,r=5,n="automatic";return u.toMgrs(e,n,r,t)}case"usng":{const t=!1,r=5;return u.toUsng(e,r,t)}case"utm":{const t=!0,r="latitude-band-indicators";return u.toUtm(e,r,t)}default:return h.pointToCoordinate(e,t)}return h.pointToCoordinate(e,t)},n._project=async function(e,t){if(d.equals(e.spatialReference,t)||!t)return e;if(this.viewModel?.formatterAvailable&&p.isLoaded())return p.project(e,t);if(!this.viewModel?.formatterAvailable){const r=f.project(e,t);if(null!=r)return r}return null},e._createClass(r,[{key:"currentPattern",get:function(){return this._get("currentPattern")||this._get("defaultPattern")},set:function(e){this._set("currentPattern",e)}},{key:"label",get:function(){return this.name??""},set:function(e){this._overrideIfSome("label",e)}},{key:"hasDisplayProperties",get:function(){return!(!this.defaultPattern||!this.coordinateSegments)}},{key:"spatialReference",get:function(){return"basemap"===this.name?this._viewSpatialReference:this.conversionInfo?.spatialReference??m.WGS84},set:function(e){this._overrideIfSome("spatialReference",e)}},{key:"_viewSpatialReference",get:function(){return this.get("viewModel.view.spatialReference")||m.WGS84}},{key:"_additionalCharactersPattern",get:function(){const e=this.get("coordinateSegments");if(!e)return null;const t=e.map((e=>e.alias)),r=this.currentPattern.replaceAll(new RegExp(`["nsew${t.join()}]`,"gi"),"").replaceAll(" ","");return new RegExp(`[${r}]`,"g")}},{key:"test",get:function(){return{additionalCharactersPattern:this._additionalCharactersPattern}}}]),r}(n);t.__decorate([i.property()],g.prototype,"conversionInfo",void 0),t.__decorate([i.property()],g.prototype,"coordinateSegments",void 0),t.__decorate([i.property()],g.prototype,"currentPattern",null),t.__decorate([i.property()],g.prototype,"label",null),t.__decorate([i.property()],g.prototype,"defaultPattern",void 0),t.__decorate([i.property({readOnly:!0})],g.prototype,"hasDisplayProperties",null),t.__decorate([i.property()],g.prototype,"name",void 0),t.__decorate([i.property({type:m})],g.prototype,"spatialReference",null),t.__decorate([i.property()],g.prototype,"viewModel",void 0),t.__decorate([i.property({readOnly:!0})],g.prototype,"_viewSpatialReference",null),t.__decorate([i.property({readOnly:!0})],g.prototype,"_additionalCharactersPattern",null),g=t.__decorate([l.subclass("esri.widgets.CoordinateConversion.support.Format")],g);return g}));
