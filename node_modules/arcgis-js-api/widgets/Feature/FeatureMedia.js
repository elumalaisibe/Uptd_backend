/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../core/a11yUtils","../../core/events","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../renderers/support/utils","../Widget","./FeatureMedia/FeatureMediaViewModel","./support/FeatureElementInfo","./support/featureUtils","../support/chartUtilsAm5","../support/componentsUtils","../support/widgetUtils","../support/decorators/messageBundle","../support/jsxFactory","../../support/themeUtils","../../intl/substitute"],(function(e,t,i,r,n,a,o,s,l,d,c,u,m,h,p,f,_,v,M,g,w,y,I,A){"use strict";const x="esri-feature-media",C={base:x,mediaContainer:`${x}__container`,mediaItemContainer:`${x}__item-container`,mediaItem:`${x}__item`,mediaItemText:`${x}__item-text`,mediaItemTitle:`${x}__item-title`,mediaItemCaption:`${x}__item-caption`,mediaNavigation:`${x}__item-navigation`,mediaPagination:`${x}__pagination`,mediaPaginationText:`${x}__pagination-text`,mediaPrevious:`${x}__previous`,mediaPreviousIconLTR:`${x}__previous-icon`,mediaPreviousIconRTL:`${x}__previous-icon--rtl`,mediaNext:`${x}__next`,mediaNextIconLTR:`${x}__next-icon`,mediaNextIconRTL:`${x}__next-icon--rtl`,mediaChart:`${x}__chart`,mediaPaginationButton:`${x}__pagination-button`,mediaPaginationIcon:`${x}__pagination-icon`,mediaChartRendered:`${x}__chart--rendered`},T=15,b="category",R="value",S="rgba(50, 50, 50, 1)",F=250,P=500,k=200;let $=function(i){function r(r,n){var a;return(a=i.call(this,r,n)||this)._refreshTimer=null,a._refreshIntervalInfo=null,a._featureElementInfo=null,a._chartRootMap=new WeakMap,a.viewModel=new p,a.messages=null,a._disposeChart=e=>{a._chartRootMap.get(e)?.dispose(),a._chartRootMap.delete(e)},a._createChart=async i=>{const{destroyed:r,viewModel:n}=t._assertThisInitialized(a);if(r||!n||!i)return;const{createRoot:o}=await new Promise(((t,i)=>e(["../support/chartUtilsAm5"],t,i))),s=await o(i);a._chartRootMap.set(i,s),a._renderChart({mediaInfo:n.activeMediaInfo,root:s})},a}t._inherits(r,i);var s=r.prototype;return s.initialize=function(){this._featureElementInfo=new f,this.addHandles([o.watch((()=>[this.viewModel?.activeMediaInfo,this.viewModel?.activeMediaInfoIndex]),(()=>this._setupMediaRefreshTimer()),o.initial),o.watch((()=>[this.viewModel?.description,this.viewModel?.title]),(()=>this._setupFeatureElementInfo()),o.initial)])},s.loadDependencies=function(){return M.loadCalciteComponents({icon:()=>new Promise(((t,i)=>e(["../../chunks/calcite-icon"],t,i)))})},s.destroy=function(){this._clearMediaRefreshTimer(),this._featureElementInfo?.destroy()},s.render=function(){return y.tsx("div",{bind:this,class:C.base,onkeyup:this._handleMediaKeyup},this._featureElementInfo?.render(),this.renderMedia())},s.renderMedia=function(){const{formattedMediaInfoCount:e,activeMediaInfoIndex:t}=this.viewModel,i=this.renderMediaText();return e?y.tsx("div",{key:"media-element-container",class:C.mediaContainer},this.renderMediaInfo(),y.tsx("div",{class:C.mediaNavigation},i,y.tsx("div",{class:C.mediaPagination},this.renderMediaPageButton("previous"),y.tsx("span",{class:C.mediaPaginationText},A.substitute(this.messages.pageText,{index:t+1,total:e})),this.renderMediaPageButton("next")))):null},s.renderMediaText=function(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const t=e&&e.title?y.tsx("div",{key:"media-title",class:C.mediaItemTitle,innerHTML:e.title}):null,i=e&&e.caption?y.tsx("div",{key:"media-caption",class:C.mediaItemCaption,innerHTML:e.caption}):null;return t||i?y.tsx("div",{key:"media-text",class:C.mediaItemText},t,i):null},s.renderImageMediaInfo=function(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:n,refreshInterval:a,altText:o,title:s,type:l}=e,{sourceURL:d,linkURL:c}=n,u=_.shouldOpenInNewTab(c??void 0)?"_blank":"_self",m="_blank"===u?"noreferrer":"",h=a?t:null,p=h?h.timestamp:0,f=h?h.sourceURL:d,v=y.tsx("img",{alt:o||s,key:`media-${l}-${i}-${r}-${p}`,src:f??void 0});return(c?y.tsx("a",{title:s,href:c,rel:m,target:u},v):null)??v},s.renderChartMediaInfo=function(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return y.tsx("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:C.mediaChart,afterCreate:this._createChart,afterRemoved:this._disposeChart})},s.renderMediaInfoType=function(){const{activeMediaInfo:e}=this.viewModel;return e?"image"===e.type?this.renderImageMediaInfo(e):e.type.includes("chart")?this.renderChartMediaInfo(e):null:null},s.renderMediaInfo=function(){const{activeMediaInfo:e}=this.viewModel;return e?y.tsx("div",{key:"media-container",class:C.mediaItemContainer},y.tsx("div",{key:"media-item-container",class:C.mediaItem},this.renderMediaInfoType())):null},s.renderMediaPageButton=function(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t="previous"===e,i=t?this.messages.previous:this.messages.next,r=t?"chevron-left":"chevron-right",n=t?"media-previous":"media-next",a=t?this._previous:this._next;return y.tsx("button",{type:"button",key:n,title:i,"aria-label":i,tabIndex:0,class:C.mediaPaginationButton,bind:this,onclick:a},y.tsx("calcite-icon",{class:C.mediaPaginationIcon,scale:"s",icon:r}))},s._setupFeatureElementInfo=function(){const{description:e,title:t}=this;this._featureElementInfo?.set({description:e,title:t})},s._next=function(){this.viewModel.next()},s._previous=function(){this.viewModel.previous()},s._getRenderer=function(){if(!this.viewModel)return;const{isAggregate:e,layer:t}=this.viewModel;return e&&t?.featureReduction&&"renderer"in t.featureReduction?t.featureReduction.renderer:t?.renderer},s._getRendererColors=async function(){const{colorAm5:t}=await new Promise(((t,i)=>e(["./FeatureMedia/chartCommon"],t,i))),i=new Map,r=this._getRenderer(),n="default";if(!r)return i;const a=await m.getColorsFromRenderer(r);a.delete(n);return Array.from(a.values()).every((e=>1===e?.length))?(Array.from(a.keys()).forEach((e=>{const r=a.get(e)?.[0]?.toCss(!0);r&&i.set(e,t(r))})),i):i},s._handleMediaKeyup=function(e){const t=a.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.viewModel.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.viewModel.next())},s._canAnimateChart=function(){return!!this.viewModel&&(!!this.viewModel.abilities.chartAnimation&&!n.prefersReducedMotion())},s._getChartAnimationMS=function(){return this._canAnimateChart()?F:0},s._getChartSeriesAnimationMS=function(){return this._canAnimateChart()?P:0},s._renderChart=async function(t){const{root:i,mediaInfo:r}=t,{value:n,type:a}=r,{ResponsiveThemeAm5:o,DarkThemeAm5:s,AnimatedThemeAm5:l,ColorSetAm5:d,ThemeAm5:c}=await new Promise(((t,i)=>e(["./FeatureMedia/chartCommon"],t,i))),u=c.new(i);u.rule("ColorSet").set("colors",v.esriChartColorSet);const m=[o.new(i),u];I.isDarkTheme()&&m.push(s.new(i)),this._canAnimateChart()&&m.push(l.new(i)),i.setThemes(m);const h=await this._getRendererColors(),p=d.new(i,{}),f=n.series.map(((e,t)=>{const i=h.get(e.fieldName)||p.getIndex(t);return{[b]:e.tooltip,[R]:e.value,columnSettings:{fill:i,stroke:i}}})).filter((e=>"pie-chart"!==a||null!=e.value&&e.value>0));"pie-chart"===a?this._createPieChart(t,f):this._createXYChart(t,f)},s._getDirection=function(){return g.isRTL(this.container)?"rtl":"ltr"},s._isInversed=function(){return!!g.isRTL(this.container)},s._customizeChartTooltip=async function(t,i="horizontal"){const{colorAm5:r}=await new Promise(((t,i)=>e(["./FeatureMedia/chartCommon"],t,i)));t.setAll({pointerOrientation:i}),t.get("background")?.setAll({stroke:r(S)}),t.label.setAll({direction:this._getDirection(),oversizedBehavior:"wrap",maxWidth:k})},s._createPieChart=async function(t,i){const{TooltipAm5:r}=await new Promise(((t,i)=>e(["./FeatureMedia/chartCommon"],t,i))),{PieChartAm5:n,PieSeriesAm5:a}=await new Promise(((t,i)=>e(["./FeatureMedia/pieChart"],t,i))),{mediaInfo:o,root:s}=t,{title:l}=o,d=5,c=o?.altText||o?.title||"",u=s.container.children.push(n.new(s,{ariaLabel:c,focusable:!0,paddingBottom:d,paddingTop:d,paddingLeft:d,paddingRight:d})),m="{category}: {valuePercentTotal.formatNumber('0.00')}%\n ({value})",h=r.new(s,{labelText:m}),p=u.series.push(a.new(s,{name:l,valueField:R,categoryField:b,tooltip:h}));p.ticks.template.set("forceHidden",!0),p.labels.template.set("forceHidden",!0),p.slices.template.states.create("active",{shiftRadius:d}),this._customizeChartTooltip(h),p.slices.template.setAll({ariaLabel:m,focusable:!0,templateField:"columnSettings"}),p.data.setAll(i),p.appear(this._getChartSeriesAnimationMS()),u.appear(this._getChartAnimationMS()),u.root.dom.classList.toggle(C.mediaChartRendered,!0)},s._getMinSeriesValue=function(e){let t=0;return e.forEach((e=>t=Math.min(e.value,t))),t},s._createColumnChart=async function(t,i,r){const{TooltipAm5:n,ScrollbarAm5:a}=await new Promise(((t,i)=>e(["./FeatureMedia/chartCommon"],t,i))),{CategoryAxisAm5:o,AxisRendererXAm5:s,ValueAxisAm5:l,AxisRendererYAm5:d,ColumnSeriesAm5:c}=await new Promise(((t,i)=>e(["./FeatureMedia/xyChart"],t,i))),{mediaInfo:u,root:m}=i,{value:h,title:p}=u;t.setAll({wheelX:"panX",wheelY:"zoomX"});const f=t.xAxes.push(o.new(m,{renderer:s.new(m,{inversed:this._isInversed()}),categoryField:b}));f.get("renderer").labels.template.setAll({forceHidden:!0});const _=t.yAxes.push(l.new(m,{renderer:d.new(m,{inside:!1}),min:this._getMinSeriesValue(h.series)}));_.get("renderer").labels.template.setAll({direction:this._getDirection()});const v="{categoryX}",M=n.new(m,{labelText:v}),g=t.series.push(c.new(m,{name:p,xAxis:f,yAxis:_,valueYField:R,categoryXField:b,tooltip:M}));this._customizeChartTooltip(M),g.columns.template.setAll({ariaLabel:v,focusable:!0,templateField:"columnSettings"}),h.series.length>T&&t.set("scrollbarX",a.new(m,{orientation:"horizontal"})),f.data.setAll(r),g.data.setAll(r),g.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())},s._createBarChart=async function(t,i,r){const{TooltipAm5:n,ScrollbarAm5:a}=await new Promise(((t,i)=>e(["./FeatureMedia/chartCommon"],t,i))),{CategoryAxisAm5:o,AxisRendererXAm5:s,ValueAxisAm5:l,AxisRendererYAm5:d,ColumnSeriesAm5:c}=await new Promise(((t,i)=>e(["./FeatureMedia/xyChart"],t,i))),{mediaInfo:u,root:m}=i,{value:h,title:p}=u;t.setAll({wheelX:"panY",wheelY:"zoomY"});const f=t.yAxes.push(o.new(m,{renderer:d.new(m,{inversed:!0}),categoryField:b}));f.get("renderer").labels.template.setAll({forceHidden:!0});const _=t.xAxes.push(l.new(m,{renderer:s.new(m,{inside:!1,inversed:this._isInversed()}),min:this._getMinSeriesValue(h.series)}));_.get("renderer").labels.template.setAll({direction:this._getDirection()});const v="{categoryY}",M=n.new(m,{labelText:v}),g=t.series.push(c.new(m,{name:p,xAxis:_,yAxis:f,valueXField:R,categoryYField:b,tooltip:M}));this._customizeChartTooltip(M,"vertical"),g.columns.template.setAll({ariaLabel:v,focusable:!0,templateField:"columnSettings"}),h.series.length>T&&t.set("scrollbarY",a.new(m,{orientation:"vertical"})),f.data.setAll(r),g.data.setAll(r),g.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())},s._createLineChart=async function(t,i,r){const{TooltipAm5:n,ScrollbarAm5:a}=await new Promise(((t,i)=>e(["./FeatureMedia/chartCommon"],t,i))),{CategoryAxisAm5:o,AxisRendererXAm5:s,ValueAxisAm5:l,AxisRendererYAm5:d,LineSeriesAm5:c}=await new Promise(((t,i)=>e(["./FeatureMedia/xyChart"],t,i))),{root:u,mediaInfo:m}=i,{value:h,title:p}=m;t.setAll({wheelX:"panX",wheelY:"zoomX"});const f=t.xAxes.push(o.new(u,{renderer:s.new(u,{inversed:this._isInversed()}),categoryField:b}));f.get("renderer").labels.template.setAll({forceHidden:!0});const _=t.yAxes.push(l.new(u,{renderer:d.new(u,{inside:!1}),min:this._getMinSeriesValue(h.series)}));_.get("renderer").labels.template.setAll({direction:this._getDirection()});const v="{categoryX}",M=n.new(u,{labelText:v}),g=t.series.push(c.new(u,{name:p,xAxis:f,yAxis:_,valueYField:R,categoryXField:b,tooltip:M}));this._customizeChartTooltip(M,"vertical"),h.series.length>T&&t.set("scrollbarX",a.new(u,{orientation:"horizontal"})),f.data.setAll(r),g.data.setAll(r),g.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())},s._createXYChart=async function(t,i){const{XYChartAm5:r,XYCursorAm5:n}=await new Promise(((t,i)=>e(["./FeatureMedia/xyChart"],t,i))),{root:a,mediaInfo:o}=t,{type:s}=o,l=o?.altText||o?.title||"",d=a.container.children.push(r.new(a,{ariaLabel:l,focusable:!0,panX:!0,panY:!0}));d.set("cursor",n.new(a,{})),"column-chart"===s&&await this._createColumnChart(d,t,i),"bar-chart"===s&&await this._createBarChart(d,t,i),"line-chart"===s&&await this._createLineChart(d,t,i),d.root.dom.classList.toggle(C.mediaChartRendered,!0)},s._clearMediaRefreshTimer=function(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)},s._updateMediaInfoTimestamp=function(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:e&&this._getImageSource(e,t)}},s._setupMediaRefreshTimer=function(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&"image"===e.type&&e.refreshInterval&&this._setRefreshTimeout(e)},s._setRefreshTimeout=function(e){const{refreshInterval:t,value:i}=e;if(!t)return;const r=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const n=setInterval((()=>{this._updateMediaInfoTimestamp(i.sourceURL)}),r);this._refreshTimer=n},s._getImageSource=function(e,t){const i=e.includes("?")?"&":"?",[r,n=""]=e.split("#");return`${r}${i}timestamp=${t}${n?"#":""}${n}`},t._createClass(r,[{key:"attributes",get:function(){return this.viewModel.attributes},set:function(e){this.viewModel.attributes=e}},{key:"activeMediaInfoIndex",get:function(){return this.viewModel.activeMediaInfoIndex},set:function(e){this.viewModel.activeMediaInfoIndex=e}},{key:"description",get:function(){return this.viewModel.description},set:function(e){this.viewModel.description=e}},{key:"fieldInfoMap",get:function(){return this.viewModel.fieldInfoMap},set:function(e){this.viewModel.fieldInfoMap=e}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"mediaInfos",get:function(){return this.viewModel.mediaInfos},set:function(e){this.viewModel.mediaInfos=e}},{key:"popupTemplate",get:function(){return this.viewModel.popupTemplate},set:function(e){this.viewModel.popupTemplate=e}},{key:"relatedInfos",get:function(){return this.viewModel.relatedInfos},set:function(e){this.viewModel.relatedInfos=e}},{key:"title",get:function(){return this.viewModel.title},set:function(e){this.viewModel.title=e}}]),r}(h);i.__decorate([s.property()],$.prototype,"_refreshIntervalInfo",void 0),i.__decorate([s.property()],$.prototype,"attributes",null),i.__decorate([s.property()],$.prototype,"activeMediaInfoIndex",null),i.__decorate([s.property()],$.prototype,"description",null),i.__decorate([s.property()],$.prototype,"fieldInfoMap",null),i.__decorate([s.property()],$.prototype,"layer",null),i.__decorate([s.property()],$.prototype,"mediaInfos",null),i.__decorate([s.property()],$.prototype,"popupTemplate",null),i.__decorate([s.property()],$.prototype,"relatedInfos",null),i.__decorate([s.property()],$.prototype,"title",null),i.__decorate([s.property({type:p})],$.prototype,"viewModel",void 0),i.__decorate([s.property(),w.messageBundle("esri/widgets/Feature/t9n/Feature")],$.prototype,"messages",void 0),$=i.__decorate([u.subclass("esri.widgets.Feature.FeatureMedia")],$);return $}));
