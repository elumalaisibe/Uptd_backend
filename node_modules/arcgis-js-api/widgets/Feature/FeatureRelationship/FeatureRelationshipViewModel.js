/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/arrayUtils","../../../core/Clonable","../../../core/Collection","../../../core/HandleOwner","../../../core/Identifiable","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../rest/support/RelationshipQuery","../support/featureUtils","../../FeatureForm/featureFormUtils"],(function(e,t,r,o,a,l,n,u,i,s,d,y,c,p,_,h,b,C){"use strict";const g=100;let f=function(t){function r(r){var o;return(o=t.call(this,r)||this)._loaded=!1,o._queryAbortController=null,o._queryPageAbortController=null,o._queryFeatureCountAbortController=null,o.featuresPerPage=10,o.description=null,o.graphic=null,o.layer=null,o.map=null,o.orderByFields=null,o.featureCount=0,o.relationshipId=null,o.showAllEnabled=!1,o.title=null,o._cancelQuery=()=>{const{_queryAbortController:t}=e._assertThisInitialized(o);t&&t.abort(),o._queryAbortController=null},o._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=e._assertThisInitialized(o);t&&t.abort(),o._queryFeatureCountAbortController=null},o._cancelQueryPage=()=>{const{_queryPageAbortController:t}=e._assertThisInitialized(o);t&&t.abort(),o._queryPageAbortController=null},o._queryController=async()=>{o._cancelQuery();const e=new AbortController;o._queryAbortController=e,await s.ignoreAbortErrors(o._query()),o._queryAbortController===e&&(o._queryAbortController=null)},o._queryFeatureCountController=async()=>{o._loaded=!1,o._cancelQueryFeatureCount();const e=new AbortController;o._queryFeatureCountAbortController=e,await s.ignoreAbortErrors(o._queryFeatureCount()),o._queryFeatureCountAbortController===e&&(o._queryFeatureCountAbortController=null),o._loaded=!0},o._queryPageController=async()=>{const e=new AbortController;o._queryPageAbortController=e,await s.ignoreAbortErrors(o._queryPage()),o._queryPageAbortController===e&&(o._queryPageAbortController=null)},o._queryDebounced=s.debounce(o._queryController,g),o._queryFeatureCountDebounced=s.debounce(o._queryFeatureCountController,g),o._queryPageDebounced=s.debounce(o._queryPageController,g),o._query=async()=>{const{_queryAbortController:t,relatedFeatures:r}=e._assertThisInitialized(o);o.featureCount&&(o._destroyRelatedFeatureViewModels(),o.featurePage=1,r.removeAll(),o.destroyed||r.addMany(o._sliceFeatures(await o._queryRelatedFeatures({signal:t?.signal}))))},o.handles.add([d.watch((()=>[o.displayCount,o.graphic,o.layer,o.layer?.loaded,o.map,o.orderByFields,o.relationshipId,o.featuresPerPage,o.showAllEnabled,o.canQuery,o.featureCount]),(()=>o._queryDebounced()),d.initial),d.watch((()=>[o.featurePage,o.showAllEnabled]),(()=>o._queryPageDebounced())),d.watch((()=>[o.layer,o.relationshipId,o.objectId,o.canQuery]),(()=>o._queryFeatureCountDebounced()))]),o}e._inherits(r,t);var o=r.prototype;return o.destroy=function(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()},o.getRelatedFeatureByObjectId=function(e){return this.relatedFeatures.find((t=>t.getObjectId()===e))},o._destroyRelatedFeatureViewModels=function(){this.relatedFeatureViewModels?.forEach((e=>!e.destroyed&&e.destroy())),this.relatedFeatureViewModels.removeAll()},o._queryFeatureCount=async function(){const{layer:e,relatedLayer:t,relationshipId:r,objectId:o,_queryFeatureCountAbortController:a,canQuery:l,supportsCacheHint:n}=this;if(await(e?.load()),await(t?.load()),!l||!e||!t)return void this._set("featureCount",0);const u=t.createQuery(),i=new h({cacheHint:n,relationshipId:r,returnGeometry:!1,objectIds:[o],where:u.where??void 0}),s=await e.queryRelatedFeaturesCount(i,{signal:a?.signal});this._set("featureCount",s[o]||0)},o._sliceFeatures=function(e){const{showAllEnabled:t,displayCount:r}=this;return t?e:r?e.slice(0,r):[]},o._queryPage=async function(){const{relatedFeatures:e,featurePage:t,showAllEnabled:r,_queryPageAbortController:o,featureCount:a}=this;!r||t<2||!a||e.addMany(await this._queryRelatedFeatures({signal:o?.signal}))},o._queryRelatedFeatures=async function(e){const{orderByFieldsFixedCasing:t,showAllEnabled:r,featuresPerPage:o,displayCount:l,layer:n,relationshipId:u,featurePage:i,featureCount:s,relatedLayer:d,supportsCacheHint:y}=this,{canQuery:c,objectId:p}=this;if(!c||!n||!d)return[];const _=r?((i-1)*o+s)%s:0,b=r?o:l,g=d.objectIdField,f=[...t.map((e=>e.field)),...C.getFieldsInTitleAndDesc(d),g].filter(a.isSome),F=t.map((e=>`${e.field} ${e.order}`)),q=d.createQuery(),A=new h({orderByFields:F,start:_,num:b,outFields:f,cacheHint:y,relationshipId:u,returnGeometry:!1,objectIds:[p],where:q.where??void 0}),m=await n.queryRelatedFeatures(A,{signal:e?.signal}),w=m[p]?.features||[];return w.forEach((e=>{e.sourceLayer=d,e.layer=d})),w},e._createClass(r,[{key:"featurePage",get:function(){return this._get("featurePage")},set:function(e){const{featuresPerPage:t,featureCount:r}=this,o=1,a=Math.ceil(r/t)||1;this._set("featurePage",Math.min(Math.max(e,o),a))}},{key:"orderByFieldsFixedCasing",get:function(){const{orderByFields:e,relatedLayer:t}=this;return e&&t?.loaded?e.map((e=>{const r=e.clone();return r.field=b.getFixedFieldName(e.field,t),r})):e??[]}},{key:"supportsCacheHint",get:function(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}},{key:"canLoad",get:function(){return!!this.map&&"number"==typeof this.relationshipId&&"number"==typeof this.objectId}},{key:"canQuery",get:function(){const e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&"number"==typeof this.relationshipId&&"number"==typeof this.objectId&&e?.supportsCount&&e?.supportsPagination)}},{key:"itemDescriptionFieldName",get:function(){return this.orderByFieldsFixedCasing[0]?.field||null}},{key:"displayCount",get:function(){return this._get("displayCount")},set:function(e){const t=0,r=10;this._set("displayCount",Math.min(Math.max(e,t),r))}},{key:"objectId",get:function(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}},{key:"objectIdField",get:function(){return this.layer?.objectIdField||null}},{key:"relatedFeatures",get:function(){return this._get("relatedFeatures")||new n}},{key:"relatedFeatureInfos",get:function(){const{itemDescriptionFieldName:e,relatedFeatures:t,relatedLayer:r}=this;if(!t.length||!r)return[];const o=r&&"formTemplate"in r&&r.formTemplate,a=o&&o?.title||void 0;return t.map((t=>{let o;if(e){const a=t.getAttribute(e),l=r.fieldsIndex.get(e);if(l){const t=C.getComputedAttributes([a],[l])[e];null!=t&&(o=t.toString())}}return{feature:t,description:o,title:a?C.parseFormTemplateString(a,t.attributes,r.fieldsIndex):void 0}})).toArray()}},{key:"relatedLayer",get:function(){const{layer:e,map:t,relationship:r}=this;return e?.loaded&&t&&r?b.findRelatedLayer(t,e,r)??null:null}},{key:"relationship",get:function(){const{relationshipId:e,layer:t}=this;return"number"==typeof e?t?.relationships?.find((({id:t})=>t===e))??null:null}},{key:"relatedFeatureViewModels",get:function(){return this._get("relatedFeatureViewModels")||new n}},{key:"state",get:function(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:r,canQuery:o,_loaded:a,canLoad:l}=this;return t||l&&!a?"loading":e||r?"querying":o?"ready":"disabled"}}]),r}(l.ClonableMixin(i.IdentifiableMixin(u.HandleOwnerMixin(o))));t.__decorate([y.property()],f.prototype,"_loaded",void 0),t.__decorate([y.property()],f.prototype,"_queryAbortController",void 0),t.__decorate([y.property()],f.prototype,"_queryPageAbortController",void 0),t.__decorate([y.property()],f.prototype,"_queryFeatureCountAbortController",void 0),t.__decorate([y.property({value:1})],f.prototype,"featurePage",null),t.__decorate([y.property()],f.prototype,"featuresPerPage",void 0),t.__decorate([y.property({readOnly:!0})],f.prototype,"orderByFieldsFixedCasing",null),t.__decorate([y.property({readOnly:!0})],f.prototype,"supportsCacheHint",null),t.__decorate([y.property({readOnly:!0})],f.prototype,"canLoad",null),t.__decorate([y.property({readOnly:!0})],f.prototype,"canQuery",null),t.__decorate([y.property()],f.prototype,"description",void 0),t.__decorate([y.property({readOnly:!0})],f.prototype,"itemDescriptionFieldName",null),t.__decorate([y.property({value:3})],f.prototype,"displayCount",null),t.__decorate([y.property({type:r})],f.prototype,"graphic",void 0),t.__decorate([y.property()],f.prototype,"layer",void 0),t.__decorate([y.property()],f.prototype,"map",void 0),t.__decorate([y.property({readOnly:!0})],f.prototype,"objectId",null),t.__decorate([y.property({readOnly:!0})],f.prototype,"objectIdField",null),t.__decorate([y.property()],f.prototype,"orderByFields",void 0),t.__decorate([y.property({readOnly:!0})],f.prototype,"relatedFeatures",null),t.__decorate([y.property({readOnly:!0})],f.prototype,"relatedFeatureInfos",null),t.__decorate([y.property({readOnly:!0})],f.prototype,"relatedLayer",null),t.__decorate([y.property({readOnly:!0})],f.prototype,"relationship",null),t.__decorate([y.property()],f.prototype,"featureCount",void 0),t.__decorate([y.property({readOnly:!0})],f.prototype,"relatedFeatureViewModels",null),t.__decorate([y.property()],f.prototype,"relationshipId",void 0),t.__decorate([y.property()],f.prototype,"showAllEnabled",void 0),t.__decorate([y.property()],f.prototype,"state",null),t.__decorate([y.property()],f.prototype,"title",void 0),t.__decorate([y.property()],f.prototype,"getRelatedFeatureByObjectId",null),f=t.__decorate([_.subclass("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],f);return f}));
