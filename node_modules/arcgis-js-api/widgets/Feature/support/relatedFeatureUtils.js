/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../request","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../core/has","../../../layers/support/source/DataLayerSource","../../../rest/query/executeQueryJSON","../../../config","../../../kernel","../../../core/arrayUtils","../../../core/urlUtils","../../../core/unitUtils","../../../geometry/support/spatialReferenceUtils","../../../layers/graphics/featureConversionUtils","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Multipoint","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/Polyline","../../../geometry/support/normalizeUtils","../../../core/pbf","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../rest/query/support/AttachmentInfo","../../../rest/support/AttachmentQuery","../../../geometry","../../../rest/support/RelationshipQuery","../../../rest/support/TopFeaturesQuery","../../../rest/support/StatisticDefinition","./featureUtils"],(function(e,t,r,s,i,o,n,a,l,u,c,d,f,p,y,h,F,g,I,S,m,w,b,R,$,q,T,U,A,N,j,v,L){"use strict";const Q="esri.widgets.Feature.support.relatedFeatureUtils",O=s.getLogger(Q),x=new Map;function P(e){if(!L.isRelatedField(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}}function C(e,t){if(!t.relationships)return null;let r=null;const{relationships:s}=t;return s.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}function k({originRelationship:e,relationships:t,layerId:r}){let s=null;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e?.id&&(s=t),!!s))),s}function D(e,t){const r=t.toLowerCase();for(const s in e)if(s.toLowerCase()===r)return e[s];return null}function E(e,t){const r=C(e,t);if(!r)return;return{url:`${t.url}/${r.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}function J(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:s}=e,i=r&&r.value;t.relatedFeatures=i?i.features:[];const o=s&&s.value;t.relatedStatsFeatures=o?o.features:[]}function M(e,t,r,s){const i=new N;return i.outFields=["*"],i.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),i.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures?.(i,s)??Promise.resolve({})}function z(e,t,r){let s=0;const i=[];for(;s<t.length;)i.push(`${e} IN (${t.slice(s,r+s)})`),s+=r;return i.join(" OR ")}async function G(e,t,r,s){const n=r.layerId.toString(),{layerInfo:a,relation:u,relatedFields:c,outStatistics:d,url:f,sourceSpatialReference:p}=t;if(!a||!u)return null;const y=k({originRelationship:u,relationships:a.relationships,layerId:n});if(y?.relationshipTableId&&y.keyFieldInRelationshipTable){const t=(await M(e,y,r,s))[e.attributes[r.objectIdField]];if(!t)return null;const o=t.features.map((e=>e.attributes[a.objectIdField]));if(d?.length&&a.supportsStatistics){const e=new q;e.where=z(a.objectIdField,o,1e3),e.outFields=c,e.outStatistics=d,e.sourceSpatialReference=p;const r={features:Promise.resolve(t),statsFeatures:l.executeQueryJSON(f,e)};return i.eachAlways(r)}}const h=y?.keyField;if(h){const r=o.isNumericField(W(a.fields,h)),n=D(e.attributes,u.keyField),c=r?`${h}=${n}`:`${h}='${n}'`,d=l.executeQueryJSON(f,new q({where:c,outFields:t.relatedFields,sourceSpatialReference:p}),s),y=t.outStatistics&&t.outStatistics.length>0&&a.supportsStatistics?l.executeQueryJSON(f,new q({where:c,outFields:t.relatedFields,outStatistics:t.outStatistics,sourceSpatialReference:p}),s):null,F={features:d};return y&&(F.statsFeatures=y),i.eachAlways(F)}return null}function B(e,r){return t(e,{query:{f:"json"},signal:r&&r.signal})}function H({relatedInfos:e,layer:t},s){const o={};return e.forEach(((e,s)=>{const{relation:i}=e;if(!i){const e=new r("relation-required","A relation is required on a layer to retrieve related records.");throw O.error(e),e}const{relatedTableId:n}=i;if("number"!=typeof n){const e=new r("A related table ID is required on a layer to retrieve related records.");throw O.error(e),e}const a=`${t.url}/${n}`,l=x.get(a),u=l??B(a);l||x.set(a,u),o[s]=u})),i.whenOrAbort(i.eachAlways(o),s)}function K({graphic:e,relatedInfos:t,layer:r},s){const o={};return t.forEach(((t,i)=>{t.layerInfo&&(o[i]=G(e,t,r,s))})),i.eachAlways(o)}function V({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields?.push(t),r.statisticType){const s=new v({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(s)}}function W(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}e.createRelatedInfo=E,e.getDestinationRelation=k,e.getRelatedFieldInfo=P,e.queryLayerInfos=H,e.queryRelatedFeatures=K,e.setRelatedFeatures=J,e.updateRelatedInfo=V,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
