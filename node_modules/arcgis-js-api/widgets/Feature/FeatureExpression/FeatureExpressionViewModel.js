/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/HandleOwner","../../../core/reactiveUtils","../../../core/throttle","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../popup/content/AttachmentsContent","../../../popup/content/Content","../../../popup/content/CustomContent","../../../popup/content/ExpressionContent","../../../popup/content/FieldsContent","../../../popup/content/MediaContent","../../../popup/content/RelationshipContent","../../../popup/content/TextContent","../../../popup/ElementExpressionInfo","../FeatureContent/FeatureContentViewModel","../FeatureFields/FeatureFieldsViewModel","../FeatureMedia/FeatureMediaViewModel","../support/arcadeFeatureUtils"],(function(e,t,o,n,r,l,i,a,s,p,c,d,u,_,y,m,h,f,w,C,E,v,b,M,x){"use strict";const F=1;let V=function(t){function o(o){var n;return(n=t.call(this,o)||this)._abortController=null,n.expressionInfo=null,n.graphic=null,n.contentElement=null,n.contentElementViewModel=null,n.interceptor=null,n.view=null,n._cancelQuery=()=>{const{_abortController:t}=e._assertThisInitialized(n);t&&t.abort(),n._abortController=null},n._createVM=()=>{const e=n.contentElement?.type;n.contentElementViewModel?.destroy();const t="fields"===e?new b:"media"===e?new M:"text"===e?new v:null;n._set("contentElementViewModel",t)},n._compile=async()=>{n._cancelQuery();const e=new AbortController;n._abortController=e,await n._compileExpression(),n._abortController===e&&(n._abortController=null)},n._compileThrottled=i.throttle(n._compile,F,e._assertThisInitialized(n)),n._compileExpression=async()=>{const{expressionInfo:t,graphic:o,interceptor:r,spatialReference:l,map:i,view:a,_abortController:s}=e._assertThisInitialized(n);if(!(t&&o&&l&&i))return void n._set("contentElement",null);const p=await x.loadArcadeUtils();if(s!==n._abortController)return;const c=await x.createCompiledExpression({arcadeUtils:p,expressionInfo:t,graphic:o,interceptor:r,map:i,spatialReference:l,view:a});if(!c||"esri.arcade.Dictionary"!==c.declaredClass)return void n._set("contentElement",null);const d=await c.castAsJsonAsync(s?.signal),u=d?.type,_="media"===u?f.fromJSON(d):"text"===u?C.fromJSON(d):"fields"===u?h.fromJSON(d):null;n._set("contentElement",_)},n.handles.add([l.watch((()=>[n.expressionInfo,n.graphic,n.map,n.spatialReference,n.view]),(()=>n._compileThrottled()),l.initial),l.watch((()=>[n.contentElement]),(()=>n._createVM()),l.initial)]),n}e._inherits(o,t);var n=o.prototype;return n.initialize=function(){this.addHandles(this._compileThrottled)},n.destroy=function(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)},e._createClass(o,[{key:"spatialReference",get:function(){return this.view?.spatialReference??null},set:function(e){this._override("spatialReference",e)}},{key:"state",get:function(){const{_abortController:e,contentElement:t,contentElementViewModel:o}=this;return e?"loading":t||o?"ready":"disabled"}},{key:"map",get:function(){return this.view?.map??null},set:function(e){this._override("map",e)}}]),o}(r.HandleOwnerMixin(n));t.__decorate([a.property()],V.prototype,"_abortController",void 0),t.__decorate([a.property({type:E})],V.prototype,"expressionInfo",void 0),t.__decorate([a.property({type:o})],V.prototype,"graphic",void 0),t.__decorate([a.property({readOnly:!0})],V.prototype,"contentElement",void 0),t.__decorate([a.property({readOnly:!0})],V.prototype,"contentElementViewModel",void 0),t.__decorate([a.property()],V.prototype,"interceptor",void 0),t.__decorate([a.property()],V.prototype,"spatialReference",null),t.__decorate([a.property({readOnly:!0})],V.prototype,"state",null),t.__decorate([a.property()],V.prototype,"map",null),t.__decorate([a.property()],V.prototype,"view",void 0),V=t.__decorate([d.subclass("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],V);return V}));
