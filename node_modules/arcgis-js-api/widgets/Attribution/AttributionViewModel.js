/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/asyncUtils","../../core/Collection","../../core/HandleOwner","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/SpatialReference","../../geometry/support/contains","../../geometry/support/webMercatorUtils"],(function(t,e,i,n,r,o,a,s,c,u,l,d,h,p,y){"use strict";function f(t,e){return t&&"copyright"in t&&(!e||"function"==typeof t.originOf&&"user"===t.originOf("copyright"))}function b(t,e){return t.length!==e.length||t.some(((t,i)=>t.text!==e[i].text))}function g(t,e,i){if(!i||!e)return;t.find((t=>t.layerView===e&&t.text===i))||t.push({text:i,layerView:e})}function m(t){return"bing-maps"===t.type}const _=[];let A=function(e){function r(t){var i;return(i=e.call(this,t)||this)._clear=()=>{i._fetchedAttributionData.clear(),i._pendingAttributions.clear(),i.handles.remove("suspension"),i.notifyChange("state")},i._pendingAttributions=new Set,i._fetchedAttributionData=new Map,i.items=new n,i.view=null,i._allLayerViewsChange=t=>{i.handles.remove("suspension");const e=i.get("view.allLayerViews");e&&i.handles.add(e.map((t=>o.watch((()=>[t.suspended,t.layer?.attributionVisible]),(()=>i._updateAttributionItems())))),"suspension"),t&&t.removed&&t.removed.forEach((t=>{i._pendingAttributions.delete(t),i._fetchedAttributionData.delete(t)})),i._updateAttributionItems()},i.handles.add([o.on((()=>i.view?.allLayerViews),"change",(t=>i._allLayerViewsChange(t)),{onListenerAdd:()=>i._allLayerViewsChange(),onListenerRemove:i._clear}),o.when((()=>!0===i.view?.stationary),(()=>i._updateAttributionItems()))]),i}t._inherits(r,e);var a=r.prototype;return a.destroy=function(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()},a._updateAttributionItems=function(){const t=this.view,e=t?.allLayerViews;_.length=0,t&&e?(e.forEach((e=>{if(e.suspended||!e.layer?.attributionVisible)return;const i=e.layer;if(f(i,"user"))return void g(_,e,i.copyright);if(i.hasAttributionData){if(this._fetchedAttributionData.has(e)){const n=this._fetchedAttributionData.get(e);return void(n?g(_,e,this._getDynamicAttribution(n,t,i)):f(i)&&g(_,e,i.copyright))}return void this._fetchAttributionData(e)}const n=i.get("portalItem.accessInformation");g(_,e,n||i.copyright)})),b(this.items,_)&&(this.items.removeAll(),this.items.addMany(_)),_.length=0,this.notifyChange("state")):this._clear()},a._fetchAttributionData=async function(t){if(this._pendingAttributions.has(t))return;this._pendingAttributions.add(t);const e=await i.result(t.layer.fetchAttributionData());if(this._pendingAttributions.has(t)){const i=e.ok?this._createContributionIndex(e.value,m(t.layer)):null;this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,i)}this._updateAttributionItems()},a._createContributionIndex=function(t,e){const i=t.contributors,n={};if(!i)return n;for(let o=0;o<i.length;o++){const t=i[o],a=t.coverageAreas;if(!a)return;for(const i of a){const a=i.bbox,s=i.zoomMin-(e&&i.zoomMin?1:0),c=i.zoomMax-(e&&i.zoomMax?1:0),u=new d({xmin:a[1],ymin:a[0],xmax:a[3],ymax:a[2],spatialReference:h.WGS84}),l={extent:y.geographicToWebMercator(u),attribution:t.attribution||"",score:null!=i.score?i.score:100,id:o};for(let t=s;t<=c;t++){var r;n[r=t]??(n[r]=[]),n[t].push(l)}}}return n.maxKey=Math.max.apply(null,Object.keys(n)),n},a._getDynamicAttribution=function(t,e,i){const{extent:n,scale:r}=e;let o=i.tileInfo?.scaleToZoom(r)??0;if(o=Math.min(t.maxKey??0,Math.round(o)),!n||null==o||o<=-1)return"";const a=t[o],s=y.project(n.center.clone().normalize(),e.spatialReference),c=new Set;return a?a.filter((t=>{const e=t.id,i=!c.has(e)&&s&&t.extent&&p.extentContainsPoint(t.extent,s);return i&&c.add(e),i})).sort(((t,e)=>e.score-t.score||t.objectId-e.objectId)).map((t=>t.attribution)).join(", "):""},t._createClass(r,[{key:"state",get:function(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}}]),r}(r.HandleOwner);e.__decorate([a.property({readOnly:!0,type:n})],A.prototype,"items",void 0),e.__decorate([a.property({readOnly:!0})],A.prototype,"state",null),e.__decorate([a.property()],A.prototype,"view",void 0),A=e.__decorate([l.subclass("esri.widgets.Attribution.AttributionViewModel")],A);return A}));
