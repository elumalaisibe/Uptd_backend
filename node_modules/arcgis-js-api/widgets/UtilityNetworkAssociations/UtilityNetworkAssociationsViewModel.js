/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../intl","../../core/Accessor","../../core/Handles","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/Point","../../geometry/Polyline","../../geometry/projection","../../layers/GraphicsLayer","../../rest/networks/synthesizeAssociationGeometries","../../rest/networks/support/SynthesizeAssociationGeometriesParameters","../../symbols/CIMSymbol","../../symbols/SimpleLineSymbol","../../views/draw/support/layerUtils","../../intl/messages","../../intl/locale"],(function(t,e,i,s,r,n,a,o,c,l,y,h,u,m,p,A,w,d,v,_,L,g,S,f){"use strict";let b=function(e){function s(t){var i;return(i=e.call(this,t)||this)._handles=new n,i._internalArrowsLayerConnectivity=i._createInternalGraphicsLayer("Connectivity Associations - Arrows (Internal)"),i._internalArrowsLayerStructuralAttachment=i._createInternalGraphicsLayer("Structural Attachment Associations - Arrows (Internal)"),i._internalGraphicsLayerConnectivity=i._createInternalGraphicsLayer("Connectivity Associations (Internal)"),i._internalGraphicsLayerStructuralAttachment=i._createInternalGraphicsLayer("Structural Attachment Associations (Internal)"),i.connectivityAssociationsLineSymbol=new L({style:"short-dash",width:2,color:[190,159,159,1]}),i.errorMessage="",i.maxAllowableAssociations=250,i.showArrowsConnectivity=!1,i.showArrowsStructuralAttachment=!1,i.structuralAttachmentAssociationsLineSymbol=new L({style:"short-dash",width:2,color:[159,190,159,1]}),i.utilityNetwork=null,i}t._inherits(s,e);var r=s.prototype;return r.initialize=function(){S.fetchMessageBundle("esri/widgets/UtilityNetworkAssociations/t9n/UtilityNetworkAssociations").then((t=>{this.messages=t})),this._handles.add([f.onLocaleChange((async()=>{this.messages=await S.fetchMessageBundle("esri/widgets/UtilityNetworkAssociations/t9n/UtilityNetworkAssociations")})),a.watch((()=>this.view),(t=>{t&&(g.addUniqueLayer(t,this._internalGraphicsLayerConnectivity),g.addUniqueLayer(t,this._internalArrowsLayerConnectivity),g.addUniqueLayer(t,this._internalGraphicsLayerStructuralAttachment),g.addUniqueLayer(t,this._internalArrowsLayerStructuralAttachment)),this._internalGraphicsLayerConnectivity.visible=this.includeConnectivityAssociations,this._internalGraphicsLayerStructuralAttachment.visible=this.includeStructuralAttachmentAssociations}))])},r.destroy=function(){this.view=null,this._removeInternalGraphicsLayers()},r.removeAssociations=function(){this._internalGraphicsLayerConnectivity.removeAll(),this._internalGraphicsLayerStructuralAttachment.removeAll(),this._internalArrowsLayerConnectivity.removeAll(),this._internalArrowsLayerStructuralAttachment.removeAll()},r.showAssociations=async function(){const{messages:t}=this;try{if(this._set("state","executing"),!this.includeConnectivityAssociations&&!this.includeStructuralAttachmentAssociations)return void this.removeAssociations();this._internalGraphicsLayerConnectivity.visible=this.includeConnectivityAssociations,this._internalGraphicsLayerStructuralAttachment.visible=this.includeStructuralAttachmentAssociations,this._internalArrowsLayerConnectivity.visible=this.showArrowsConnectivity&&this.includeConnectivityAssociations,this._internalArrowsLayerStructuralAttachment.visible=this.showArrowsStructuralAttachment&&this.includeStructuralAttachmentAssociations,this.removeAssociations(),A.isLoaded()||await A.load(),this.utilityNetwork.loaded||await this.utilityNetwork.load();const e=this.utilityNetwork.spatialReference,s=A.project(new m({x:this.view?.extent.xmin,y:this.view?.extent.ymin,spatialReference:this.view?.spatialReference}),e),r=A.project(new m({x:this.view?.extent.xmax,y:this.view?.extent.ymax,spatialReference:this.view?.spatialReference}),e),n=new u({xmin:s.x,ymin:s.y,xmax:r.x,ymax:r.y,spatialReference:e}),a=new v({returnConnectivityAssociations:this.includeConnectivityAssociations,returnAttachmentAssociations:this.includeStructuralAttachmentAssociations,extent:n,outSpatialReference:this.utilityNetwork.spatialReference,maxGeometryCount:this.maxAllowableAssociations,gdbVersion:(this.view?.map.allLayers?.items.find((t=>"feature"===t.type))).gdbVersion,moment:this.moment}),o=await d.synthesizeAssociationGeometries(null!==this.utilityNetwork.networkServiceUrl?this.utilityNetwork.networkServiceUrl:"",a);let c=[],l=[],y=[],h=[];if(o){if(!0===o.maxGeometryCountExceeded)return this._set("state","warning"),void this._set("errorMessage",t.infoStrings.maxAllowableAssociationsExceeded);if(0===o.associations.length)return this._set("state","warning"),void this._set("errorMessage",t.infoStrings.noAssociationsFound);c=o.associations.filter((t=>"connectivity"===t.associationType)).map((t=>{const e=new p({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new i({geometry:e,symbol:this.connectivityAssociationsLineSymbol})})),l=o.associations.filter((t=>"connectivity"===t.associationType)).map((t=>{const e=new p({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new i({geometry:e,symbol:this._getCIMSymbolArrows(this.connectivityAssociationsLineSymbol.color)})})),y=o.associations.filter((t=>"attachment"===t.associationType)).map((t=>{const e=new p({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new i({geometry:e,symbol:this.structuralAttachmentAssociationsLineSymbol})})),h=o.associations.filter((t=>"attachment"===t.associationType)).map((t=>{const e=new p({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new i({geometry:e,symbol:this._getCIMSymbolArrows(this.structuralAttachmentAssociationsLineSymbol.color)})}))}c.length>0&&(this._internalGraphicsLayerConnectivity.addMany(c),this._internalArrowsLayerConnectivity.addMany(l)),y.length>0&&(this._internalGraphicsLayerStructuralAttachment.addMany(y),this._internalArrowsLayerStructuralAttachment.addMany(h)),this._set("state","ready")}catch(e){this._set("state","failed"),this._set("errorMessage",e.message)}},r._createInternalGraphicsLayer=function(t){return new w({listMode:"hide",internal:!0,title:t})},r._getCIMSymbolArrows=function(t){return new _({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementAtExtremities",extremityPlacement:"JustEnd",angleToLine:!0},frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-18,-5.47],[-18,5.6],[1.96,-.03],[-18,-5.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:[t.r,t.g,t.b,255*t.a]}]}}]}]}}})},r._removeInternalGraphicsLayers=function(){this._internalGraphicsLayerConnectivity&&this._internalGraphicsLayerStructuralAttachment&&this.view&&this.view.map&&(this.view.map.remove(this._internalGraphicsLayerConnectivity),this.view.map.remove(this._internalGraphicsLayerStructuralAttachment),this.view.map.remove(this._internalArrowsLayerConnectivity),this.view.map.remove(this._internalArrowsLayerStructuralAttachment))},r._utilityNetworkExists=function(){const{messages:t}=this;return!!this.utilityNetwork||(this._set("errorMessage",t.infoStrings.noUtilityNetwork),!1)},t._createClass(s,[{key:"includeConnectivityAssociations",set:function(t){this._set("includeConnectivityAssociations",t),this._internalGraphicsLayerConnectivity.visible=t,this._internalArrowsLayerConnectivity.visible=t&&this.showArrowsConnectivity}},{key:"includeStructuralAttachmentAssociations",set:function(t){this._set("includeStructuralAttachmentAssociations",t),this._internalGraphicsLayerStructuralAttachment.visible=t,this._internalArrowsLayerStructuralAttachment.visible=t&&this.showArrowsStructuralAttachment}},{key:"state",get:function(){const{view:t}=this;return t?.ready&&this._utilityNetworkExists()?"ready":"disabled"}},{key:"view",get:function(){return this._get("view")},set:function(t){this._set("view",t)}}]),s}(r);e.__decorate([o.property()],b.prototype,"connectivityAssociationsLineSymbol",void 0),e.__decorate([o.property({readOnly:!0})],b.prototype,"errorMessage",void 0),e.__decorate([o.property({type:Boolean,value:!0})],b.prototype,"includeConnectivityAssociations",null),e.__decorate([o.property({type:Boolean,value:!0})],b.prototype,"includeStructuralAttachmentAssociations",null),e.__decorate([o.property()],b.prototype,"maxAllowableAssociations",void 0),e.__decorate([o.property()],b.prototype,"messages",void 0),e.__decorate([o.property()],b.prototype,"moment",void 0),e.__decorate([o.property()],b.prototype,"showArrowsConnectivity",void 0),e.__decorate([o.property()],b.prototype,"showArrowsStructuralAttachment",void 0),e.__decorate([o.property({readOnly:!0})],b.prototype,"state",null),e.__decorate([o.property()],b.prototype,"structuralAttachmentAssociationsLineSymbol",void 0),e.__decorate([o.property()],b.prototype,"utilityNetwork",void 0),e.__decorate([o.property({value:null})],b.prototype,"view",null),b=e.__decorate([h.subclass("esri.widgets.UtilityNetworkAssociations.UtilityNetworkAssociationsViewModel")],b);return b}));
