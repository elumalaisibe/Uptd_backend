/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../core/events","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../Widget","./datePickerUtils","./DatePickerViewModel","./Popover","./decorators/accessibleHandler","./decorators/messageBundle","./jsxFactory","./widgetUtils","../../chunks/datetime","../../intl/date","../../intl/locale"],(function(e,t,a,i,n,o,s,r,d,l,c,h,u,_,p,y,v,D,f,g,m,k){"use strict";const w="esri-date-picker",b={base:w,datePicker:`${w}__calendar`,monthPicker:`${w}__month-picker`,dayPicker:`${w}__day-picker`,week:`${w}__week-item`,nearbyMonth:`${w}__day-item--nearby-month`,activeDay:`${w}__day-item--active`,today:`${w}__day-item--today`,selectedDay:`${w}__day-item--selected`,day:`${w}__day-item`,dayHeader:`${w}__day-item--header`,yearPicker:`${w}__year-picker`,selectedYear:`${w}__year-picker-item--selected`,year:`${w}__year-picker-item`,monthDropdown:`${w}__month-dropdown`,date:`${w}__date`,datePickerToggle:`${w}__calendar-toggle`,dateInput:`${w}__input`,dateTextInput:`${w}__text-input`,leadingIcon:`${w}__icon--leading`,previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",calendarIcon:"esri-icon-calendar",widget:"esri-widget",button:"esri-widget--button",input:"esri-input",select:"esri-select"},x={year:"numeric",month:"2-digit",day:"2-digit"},P=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"];let M=function(t){function a(a,i){var n;return(n=t.call(this,a,i)||this)._calendarNode=null,n._inputOrButtonNode=null,n._rootNode=null,n._requestDayPickerFocusOnCreate=!1,n._activeDate=null,n._calendarPopover=new p({owner:e._assertThisInitialized(n),placement:"bottom-start",anchorElement:()=>n._rootNode,renderContentFunction:n._renderCalendar}),n._isOpen=!1,n.dateInputEnabled=!1,n.messages=null,n.commitOnMonthChange=!1,n.viewModel=new _,n.disabled=!1,n.toggle=n.toggle.bind(e._assertThisInitialized(n)),n}e._inherits(a,t);var s=a.prototype;return s.initialize=function(){this.addHandles(o.watch((()=>({viewModel:this.viewModel,value:this.viewModel?.value})),(({viewModel:e,value:t})=>{!this.destroyed&&e&&null!=this.onChange&&this.onChange(t)}),o.sync))},s.destroy=function(){this._calendarPopover.destroy()},s.render=function(){return D.tsx("div",{afterCreate:f.storeNode,bind:this,class:this.classes(b.base,b.widget),"data-node-ref":"_rootNode"},this.dateInputEnabled?this._renderInputAndButtonMode():this._renderButtonOnlyMode())},s.toggle=function(){this._isOpen?this.close():this.open()},s.open=function(e=!0){this._activeDate=g.DateTime.fromJSDate(this.viewModel.value),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=e},s.close=function(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,e&&this._inputOrButtonNode?.focus()},s._renderButtonOnlyMode=function(){const e=m.formatDate(this.viewModel.value,x),{disabled:t,_isOpen:a,messages:i}=this;return D.tsx("div",{key:`date-button-${t}`,afterCreate:f.storeNode,"aria-controls":a?this._getCalendarId():null,"aria-expanded":a.toString(),"aria-haspopup":"true","aria-label":i.setDate,"aria-pressed":a.toString(),bind:this,class:this.classes(b.button,b.select,b.datePickerToggle),"data-node-ref":"_inputOrButtonNode",onclick:this.toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:t?void 0:0},D.tsx("span",{class:b.date},e))},s._renderInputAndButtonMode=function(){const e=m.formatDate(this.viewModel.value,x),{_isOpen:t,messages:a}=this;return D.tsx("div",{class:this.classes(b.dateInput)},D.tsx("input",{afterCreate:f.storeNode,"data-node-ref":"_inputOrButtonNode","aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(b.dateTextInput,b.input),key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),D.tsx("span",{"aria-hidden":"true",class:this.classes(b.leadingIcon,b.calendarIcon)}))},s._handleDateInputClick=function(){this.open(!1)},s._handleDateInputKeyDown=function(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this.close():"ArrowDown"===t&&(this.open(),e.preventDefault())},s._handleDateButtonKeyDown=function(e){const{key:t,shiftKey:a}=e;this._isOpen&&"Tab"===t&&a?this.close():f.isActivationKey(t)&&this.toggle()},s._handleDateInputBlur=function(e){this._isOpen||this._handleDateText(e)},s._handleDateText=function(e){const t=e.currentTarget;let a;try{a=u.parseDateIntoParts(t.value,x)}catch(o){return n.getLogger(this).warn(o),void(t.value=m.formatDate(this.viewModel.value,x))}const i=g.DateTime.fromObject(a);i.isValid?(this.viewModel.value=i.toJSDate(),this._activeDate=i):t.value=m.formatDate(this.viewModel.value,x)},s._handleDatePickerKeydown=function(e){"Escape"===i.eventKey(e)&&(this.close(),e.preventDefault(),e.stopPropagation())},s._renderCalendar=function(){const e=this._activeDate;if(!e)return null;const t=g.DateTime.fromJSDate(this.viewModel.value);return D.tsx("div",{afterCreate:f.storeNode,bind:this,class:this.classes(b.datePicker,b.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",tabIndex:-1,onfocusout:this._onCalendarFocusOut,onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},s._getCalendarId=function(){return`date-picker__calendar--${this.id}`},s._onCalendarFocusOut=function(e){const t=e.relatedTarget;t&&t instanceof Node&&(this._calendarNode?.contains(t)||this._rootNode?.contains(t))||this.close(!1)},s._renderMonthPicker=function(e){const t=f.isRTL(this.container),a=t?b.nextIcon:b.previousIcon,i=t?b.previousIcon:b.nextIcon,n=g.Info.months("long",{locale:k.getLocale()}).map(((t,a)=>{const i=e.month-1===a;return D.tsx("option",{selected:i,value:a.toString()},t)})),{disabled:o,messages:s}=this;return D.tsx("div",{class:b.monthPicker},D.tsx("div",{key:`previous-month-${o}`,"aria-label":s.goToPreviousMonth,bind:this,class:b.button,onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:o?void 0:0,title:s.goToPreviousMonth},D.tsx("span",{"aria-hidden":"true",class:a})),D.tsx("select",{"aria-live":"assertive","aria-label":s.selectMonth,bind:this,class:this.classes(b.monthDropdown,b.select),disabled:o,id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:s.selectMonth},n),D.tsx("div",{key:`next-month-${o}`,"aria-label":s.goToNextMonth,bind:this,class:b.button,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:o?void 0:0,title:s.goToNextMonth},D.tsx("span",{"aria-hidden":"true",class:i})))},s._renderDayPicker=function(e,t){const a=this._getWeekLabels(),i=this._getDayId(e),n=this._renderMonth(e,t),{id:o,disabled:s}=this;return D.tsx("div",{key:`day-picker-${s}`,afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":`${o}__month-picker ${o}__selected-year`,bind:this,class:b.dayPicker,id:`${o}__day-picker`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:s?void 0:0},D.tsx("div",{class:b.week,role:"row"},a.map((e=>D.tsx("div",{"aria-label":e.name,class:this.classes(b.day,b.dayHeader),role:"columnheader",title:e.name},e.abbr)))),n)},s._getDayId=function(e){return`${this.id}__${m.formatDate(e.valueOf(),x)}`},s._handleDayPickerCreate=function(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())},s._getWeekLabels=function(){const e=[],t={weekday:"long"},a={weekday:"narrow"};let i=g.DateTime.now().set({weekday:u.getFirstDayOfWeek(k.getLocale())});for(let n=0;n<7;n++)e.push({name:m.formatDate(i.valueOf(),t),abbr:m.formatDate(i.valueOf(),a)}),i=i.plus({day:1});return e},s._handleDayPickerKeydown=function(e){const{ctrlKey:t,shiftKey:a}=e,n=i.eventKey(e);if(!P.includes(n))return;let o=this._activeDate;if(o){if("ArrowLeft"===n)o=o.minus({day:1});else if("ArrowRight"===n)o=o.plus({day:1});else if("ArrowUp"===n)o=o.minus({week:1});else if("ArrowDown"===n)o=o.plus({week:1});else if("PageUp"===n){const e=a?"year":"month";o=o.minus({[e]:1})}else if("PageDown"===n){const e=a?"year":"month";o=o.plus({[e]:1})}else if("Home"===n){const e=t?"year":"month";o=o.startOf(e)}else if("End"===n){const e=t?"year":"month";o=o.endOf(e)}else f.isActivationKey(n)&&(this.viewModel.value=o.toJSDate(),this.close());this._activeDate=o,e.preventDefault(),e.stopPropagation()}},s._renderMonth=function(e,t){const a=g.DateTime.now(),i=e.startOf("month"),n=e.endOf("month"),o=6,s=7;let r=i.minus({day:u.getLocaleDayOfWeek(k.getLocale(),i.weekday)});const d=[];for(let l=0;l<o;l++){const o=[];for(let d=0;d<s;d++){const s=r.day,d=r.hasSame(e,"day"),l=r.hasSame(t,"day"),c=this._getDayId(r),h=g.Interval.fromDateTimes(i,n),u={[b.nearbyMonth]:!h.contains(r),[b.today]:r.hasSame(a,"day"),[b.activeDay]:d,[b.selectedDay]:l};o.push(D.tsx("div",{"aria-label":s.toString(),"aria-selected":d.toString(),bind:this,class:this.classes(b.day,u),"data-iso-date":r.toISO(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},s)),r=r.plus({day:1})}d.push(D.tsx("div",{class:b.week,role:"row"},o))}return d},s._renderYearPicker=function(e){const t={year:"numeric"},a=e,i=m.formatDate(a.valueOf(),t),n=m.formatDate(a.plus({year:1}).valueOf(),t),o=m.formatDate(a.minus({year:1}).valueOf(),t),{disabled:s,messages:r}=this;return D.tsx("div",{class:b.yearPicker},D.tsx("div",{key:`previous-year-${s}`,"aria-label":r.goToPreviousYear,bind:this,class:b.year,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:s?void 0:0,title:r.goToPreviousYear},o),D.tsx("div",{class:this.classes(b.year,b.selectedYear),id:`${this.id}__selected-year`},i),D.tsx("div",{key:`next-year-${s}`,"aria-label":r.goToNextYear,bind:this,class:b.year,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:s?void 0:0,title:r.goToNextYear},n))},s._setMonth=function(e){const t=e.target,a=Number(t.value)+1;this._activeDate&&(this._activeDate=this._activeDate.set({month:a}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))},s._setPreviousMonth=function(){this._activeDate&&(this._activeDate=this._activeDate.minus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))},s._handlePreviousMonthKeyDown=function(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this.close();f.isActivationKey(e.key)&&this._setPreviousMonth()},s._setNextMonth=function(){this._activeDate&&(this._activeDate=this._activeDate.plus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))},s._setPreviousYear=function(){this._activeDate=this._activeDate?.minus({year:1})??null},s._setNextYear=function(){this._activeDate=this._activeDate?.plus({year:1})??null},s._handleNextYearKeyDown=function(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this.close();f.isActivationKey(e.key)&&this._setNextYear()},s._handleSelectedDate=function(e){const t=e.target;this.viewModel.value=g.DateTime.fromISO(t.getAttribute("data-iso-date")).toJSDate(),this.close()},e._createClass(a,[{key:"value",get:function(){return this.viewModel.value},set:function(e){this.viewModel.value=e}},{key:"isOpen",get:function(){return this._isOpen}}]),a}(h);t.__decorate([s.property()],M.prototype,"_activeDate",void 0),t.__decorate([s.property()],M.prototype,"_calendarPopover",void 0),t.__decorate([s.property()],M.prototype,"_isOpen",void 0),t.__decorate([s.property()],M.prototype,"dateInputEnabled",void 0),t.__decorate([s.property(),v.messageBundle("esri/widgets/support/t9n/DatePicker")],M.prototype,"messages",void 0),t.__decorate([s.property()],M.prototype,"value",null),t.__decorate([s.property()],M.prototype,"commitOnMonthChange",void 0),t.__decorate([s.property({type:_})],M.prototype,"viewModel",void 0),t.__decorate([s.property()],M.prototype,"onChange",void 0),t.__decorate([s.property()],M.prototype,"disabled",void 0),t.__decorate([s.property()],M.prototype,"isOpen",null),t.__decorate([y.accessibleHandler()],M.prototype,"_setNextMonth",null),t.__decorate([y.accessibleHandler()],M.prototype,"_setPreviousYear",null),t.__decorate([y.accessibleHandler()],M.prototype,"_handleSelectedDate",null),M=t.__decorate([c.subclass("esri.widgets.support.DatePicker")],M);return M}));
