/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Collection","../core/events","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","./support/widgetUtils","./TableList/ListItem","./TableList/TableListViewModel","./TableList/support/tableListUtils","../chunks/sortable.esm"],(function(e,t,i,s,n,o,r,a,l,c,d,u,m,h,g,_,p,b,f,y){"use strict";function I(e,t,i){e.splice(i,0,e.splice(t,1)[0])}const v=i.ofType(p),A="root-tables",S="data-layer-uid",w="layerUid",T="esri-table-list",C={base:T,esriWidget:"esri-widget",esriWidgetPanel:"esri-widget--panel",noItems:`${T}__no-items`,list:`${T}__list`,listRoot:`${T}__list--root`,item:`${T}__item`,itemChosen:`${T}__item--chosen`,itemMessage:`${T}__item--has-message`,itemSelectable:`${T}__item--selectable`,itemContainer:`${T}__item-container`,actionsMenu:`${T}__item-actions-menu`,actionsMenuItem:`${T}__item-actions-menu-item`,actionsMenuItemActive:`${T}__item-actions-menu-item--active`,actions:`${T}__item-actions`,actionsList:`${T}__item-actions-list`,action:`${T}__item-action`,actionIcon:`${T}__item-action-icon`,actionImage:`${T}__item-action-image`,actionTitle:`${T}__item-action-title`,actionToggle:`${T}__action-toggle`,actionToggleOn:`${T}__action-toggle--on`,message:`${T}__item-message`,title:`${T}__item-title`,publishing:`${T}__publishing`,disabled:"esri-disabled",disabledElement:"esri-disabled-element",hidden:"esri-hidden",rotating:"esri-rotating",iconEllipses:"esri-icon-handle-horizontal",iconNoticeTriangle:"esri-icon-notice-triangle",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",widgetIcon:"esri-icon-table"},$={actions:"actions",actionSection:"action-section",items:"items"};function k(e){const{actionsOpen:t}=e;t&&(e.actionsOpen=!1)}const x={statusIndicators:!0,errors:!1};let E=function(t){function i(e,i){var s;return(s=t.call(this,e,i)||this)._sortable=null,s._sortableNode=null,s._focusSortUid=null,s.visibleItems=null,s.iconClass=C.widgetIcon,s.icon=null,s.messages=null,s.messagesCommon=null,s.multipleSelectionEnabled=!1,s.selectionEnabled=!1,s.selectedItems=new v,s.viewModel=new b,s.visibleElements={...x},s}e._inherits(i,t);var o=i.prototype;return o.initialize=function(){this._setVisibleItems(this.tableItems),this.addHandles([n.watch((()=>this.visibleElements),(()=>this._itemsChanged())),n.on((()=>this.viewModel.tableItems),"change",(()=>this._itemsChanged())),n.watch((()=>this.selectionEnabled),(()=>this._toggleSorting()),n.initial)])},o.destroy=function(){this._destroySortable()},o.castVisibleElements=function(e){return{...x,...e}},o.triggerAction=function(e,t){return this.viewModel.triggerAction(e,t)},o.render=function(){const{visibleItems:e}=this,t=this.viewModel?.state,i={[C.hidden]:"loading"===t,[C.disabled]:"disabled"===t};return g.tsx("div",{class:this.classes(C.base,C.esriWidget,C.esriWidgetPanel,i)},e?.length?this.renderList():this.renderNoItems())},o.renderNoItems=function(){return g.tsx("div",{class:C.noItems},this.messages.noItemsToDisplay)},o.renderList=function(){const{visibleItems:e,messages:t,selectionEnabled:i}=this;return g.tsx("ul",{"aria-label":t.widgetLabel,role:i?"listbox":void 0,afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"data-node-ref":"_sortableNode",bind:this,class:this.classes(C.list,C.listRoot)},e?.map((e=>this.renderItem(e))).toArray())},o.renderItem=function(e){const{id:t,selectionEnabled:i,selectedItems:s}=this,n=`${`${t}_${e.uid}`}__title`,o=this._hasMessage(e),r={[C.itemMessage]:!!o,[C.itemSelectable]:i};if(i){const t={[S]:e.layer?.uid};return g.tsx("li",{key:`item-with-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(C.item,r),"aria-labelledby":n,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,"data-item":e,tabIndex:0,"aria-selected":f.findSelectedItem(e,s)?"true":"false",role:"option",...t},this.renderItemContent(e,n))}return g.tsx("li",{key:`item-no-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(C.item,r),"aria-labelledby":n},this.renderItemContent(e,n))},o.renderActionsMenuIcon=function(e,t){const{messagesCommon:i}=this,s={[C.actionsMenuItemActive]:e.actionsOpen};return g.tsx("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(C.actionsMenuItem,s),tabindex:"0",role:"button","aria-controls":t,"aria-label":i.options,title:i.options},g.tsx("span",{"aria-hidden":"true",class:C.iconEllipses}))},o.renderActionsMenu=function(e,t,i,s){const n=1===i&&this._getSingleActionButton(t),o=n?this.renderAction({item:e,action:n,singleAction:!0}):null,r=!n&&i?this.renderActionsMenuIcon(e,s):null;return r||n?g.tsx("div",{key:"actions-menu",class:C.actionsMenu},o,r):null},o.renderItemMessage=function(e){return e.error?g.tsx("div",{key:"esri-table-list__error",class:C.message,role:"alert"},g.tsx("span",{"aria-hidden":"true",class:C.iconNoticeTriangle}),this.messages.tableError):null},o.renderItemStatus=function(e){const{visibleElements:t}=this;if(!t.statusIndicators)return null;const{publishing:i}=e;return g.tsx("span",{class:this.classes({[C.publishing]:i}),key:"layer-item-status"})},o.renderItemContent=function(e,t){const{id:i}=this,s=`${`${i}_${e.uid}`}_actions`,n=this._filterActions(e.actionsSections),o=this._countActions(n);return[g.tsx("div",{key:"list-item-container",class:C.itemContainer},this.renderTitle(e,t),this.renderItemStatus(e),this.renderActionsMenu(e,n,o,s)),this.renderItemMessage(e),o?this.renderActionsSections(e,n,s):null]},o.renderTitle=function(e,t){const{messages:i}=this,s=e.title||i.untitledTable;return g.tsx("span",{key:"layer-title-container",id:t,class:C.title},s)},o.renderActionsSections=function(e,t,i){const s=t.toArray().map(((t,i)=>g.tsx("ul",{key:`${e}-action-section-${i}`,class:C.actionsList},this.renderActionSection(e,t))));return g.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"actions-section",id:i,class:C.actions,hidden:!e.actionsOpen||null},s)},o.renderActionSection=function(e,t){return(t&&t.toArray()).map((t=>this.renderAction({item:e,action:t})))},o.renderActionIcon=function(e){const{active:t,className:i}=e,s=this._getIconImageStyles(e),n="button"!==e.type||e.image||i?i:C.iconDefaultAction,o={[C.actionImage]:!t&&!!s["background-image"],[C.iconLoading]:t,[C.rotating]:t};return n&&!t&&(o[n]=!0),g.tsx("span",{key:"action-icon","aria-hidden":"true",class:this.classes(C.actionIcon,o),styles:s})},o.renderActionTitle=function(e,t){return t?null:g.tsx("span",{key:"action-title",class:C.actionTitle},e)},o.renderAction=function(e){const{item:t,action:i,singleAction:s}=e,{active:n,disabled:o,title:r}=i,a={[C.actionsMenuItem]:s&&"button"===i.type,[C.action]:n||!s&&"toggle"!==i.type,[C.actionToggle]:!n&&"toggle"===i.type,[C.actionToggleOn]:!n&&"toggle"===i.type&&i.value,[C.disabledElement]:o},l=[this.renderActionIcon(i),this.renderActionTitle(r,s)];return s?g.tsx("div",{bind:this,"data-item":t,"data-action":i,role:"button",key:`single-action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:a,tabindex:"0",title:r??void 0,"aria-label":r},l):g.tsx("li",{bind:this,"data-item":t,"data-action":i,key:`action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:a,tabindex:"0",role:"button",title:r??void 0,"aria-label":r},l)},o._hasMessage=function(e){return!!e.error},o._filterActions=function(e){return e.map((e=>e.filter((e=>e.visible))))},o._setVisibleItems=function(e){this.visibleItems=e?.filter((e=>!e.hidden&&(this.visibleElements.errors||!e.error)))},o._destroySortable=function(){const{_sortable:e}=this;e&&e.destroy(),this._sortable=null},o._toggleSorting=function(){const{_sortable:e,_sortableNode:t,selectionEnabled:i}=this;if(t)if(e)e.option("disabled",!i);else{const e=y.Sortable.create(t,{dataIdAttr:S,group:A,fallbackTolerance:4,disabled:!i,onSort:()=>this._sortTablesToItems(e.toArray()),chosenClass:C.itemChosen});this._sortable=e}},o._sortNodeCreated=function(e){this._sortableNode=e,this._toggleSorting()},o._sortTablesToItems=function(e){const t=this.map?.tables;t&&t.sort(((t,i)=>{const s=e.indexOf(t.uid),n=e.indexOf(i.uid);return s>n?-1:s<n?1:0}))},o._getSingleActionButton=function(e){return e.reduce((e=>e)).filter((e=>e&&"button"===e.type)).at(0)},o._focusListItem=function(e){const{_focusSortUid:t}=this;if(!e||!t)return;const i=L(e);i.layer?.uid===t&&(e.focus(),this._focusSortUid=null)},o._watchActionSectionChanges=function(e){const t=()=>this.scheduleRender();this.addHandles(e.on("change",t),$.actionSection),e.forEach((e=>this._renderOnActionChanges(e)))},o._renderOnActionChanges=function(e){const t=()=>this.scheduleRender();"toggle"!==e.type?"slider"!==e.type?this.addHandles(n.watch((()=>[e.className,e.image,e.id,e.title,e.visible]),t,n.initial),$.actions):this.addHandles(n.watch((()=>[e.className,e.id,e.title,e.visible,e.value,e.displayValueEnabled,e.max,e.min,e.step]),t,n.initial),$.actions):this.addHandles(n.watch((()=>[e.className,e.image,e.id,e.title,e.visible,e.value]),t,n.initial),$.actions)},o._renderOnItemChanges=function(e){const t=()=>this.scheduleRender();this.addHandles([n.watch((()=>[e.actionsOpen,e.title,e.error,e.publishing]),t,n.initial),n.watch((()=>[e.hidden,e.error]),(()=>this._setVisibleItems(this.tableItems))),e.actionsSections.on("change",t)],$.items),e.actionsSections.forEach((e=>this._watchActionSectionChanges(e)))},o._itemsChanged=function(){const{tableItems:e}=this.viewModel;this._setVisibleItems(e),this.removeHandles($.actionSection),this.removeHandles($.actions),this.removeHandles($.items),e.forEach((e=>this._renderOnItemChanges(e))),this.scheduleRender()},o._countActions=function(e){return e.reduce(((e,t)=>e+t.length),0)},o._getIconImageStyles=function(e){const t="esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?`url("${t}")`:void 0}},o._selectionKeydown=function(e){const t=["ArrowDown","ArrowUp"],i=s.eventKey(e);if(!t.includes(i))return void this._toggleSelection(e);e.stopPropagation();const n=e.currentTarget["data-item"],{_sortable:o,selectedItems:r}=this;if(!o)return;const a=f.findSelectedItem(n,r),l=o.toArray(),c=e.target,d=l.indexOf(c.dataset[w]);if(-1!==d){if("ArrowDown"===i){const e=d+1;if(e>=l.length)return;a?(I(l,d,e),o.sort(l),this._sortTablesToItems(o.toArray()),this._focusSortUid=n.layer?.uid):(this._focusSortUid=n.layer?.uid,this.scheduleRender())}if("ArrowUp"===i){const e=d-1;if(e<=-1)return;a?(I(l,d,e),o.sort(l),this._sortTablesToItems(o.toArray()),this._focusSortUid=n.layer?.uid):(this._focusSortUid=n.layer?.uid,this.scheduleRender())}}},o._toggleActionsOpen=function(e){const t=L(e.currentTarget),{actionsOpen:i}=t,s=!i;s&&this.tableItems.forEach((e=>k(e))),t.actionsOpen=s,e.stopPropagation()},o._triggerAction=function(e){const t=e.currentTarget,i=M(t),s=L(t);"toggle"===i.type&&(i.value=!i.value),this.triggerAction(i,s),e.stopPropagation()},o._toggleSelection=function(e){e.stopPropagation();const{multipleSelectionEnabled:t,selectedItems:i}=this,s=t&&(e.metaKey||e.ctrlKey),n=L(e.currentTarget),o=f.findSelectedItem(n,i),{length:r}=i;if(!s)return r&&!(o&&1===r)?(i.removeAll(),void i.add(n)):void(o?i.remove(o):i.add(n));o?i.remove(o):i.add(n)},e._createClass(i,[{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"listItemCreatedFunction",get:function(){return this.viewModel.listItemCreatedFunction},set:function(e){this.viewModel.listItemCreatedFunction=e}},{key:"map",get:function(){return this.viewModel.map},set:function(e){this.viewModel.map=e}},{key:"tableItems",get:function(){return this.viewModel.tableItems}},{key:"test",get:function(){return{visibleItems:this.visibleItems}}}]),i}(d);function M(e){return e["data-action"]}function L(e){return e["data-item"]}t.__decorate([o.property()],E.prototype,"visibleItems",void 0),t.__decorate([o.property()],E.prototype,"iconClass",void 0),t.__decorate([o.property()],E.prototype,"icon",void 0),t.__decorate([o.property()],E.prototype,"label",null),t.__decorate([o.property()],E.prototype,"listItemCreatedFunction",null),t.__decorate([o.property()],E.prototype,"map",null),t.__decorate([o.property(),m.messageBundle("esri/widgets/TableList/t9n/TableList")],E.prototype,"messages",void 0),t.__decorate([o.property(),m.messageBundle("esri/t9n/common")],E.prototype,"messagesCommon",void 0),t.__decorate([o.property()],E.prototype,"multipleSelectionEnabled",void 0),t.__decorate([o.property()],E.prototype,"selectionEnabled",void 0),t.__decorate([o.property()],E.prototype,"selectedItems",void 0),t.__decorate([o.property({readOnly:!0})],E.prototype,"tableItems",null),t.__decorate([h.vmEvent("trigger-action"),o.property({type:b})],E.prototype,"viewModel",void 0),t.__decorate([o.property()],E.prototype,"visibleElements",void 0),t.__decorate([r.cast("visibleElements")],E.prototype,"castVisibleElements",null),t.__decorate([u.accessibleHandler()],E.prototype,"_toggleActionsOpen",null),t.__decorate([u.accessibleHandler()],E.prototype,"_triggerAction",null),t.__decorate([u.accessibleHandler()],E.prototype,"_toggleSelection",null),E=t.__decorate([c.subclass("esri.widgets.TableList")],E);return E}));
