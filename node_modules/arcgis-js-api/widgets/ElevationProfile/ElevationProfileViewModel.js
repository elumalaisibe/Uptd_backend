/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Graphic","../../core/Accessor","../../core/arrayUtils","../../core/ByteSizeUnit","../../core/Collection","../../core/collectionUtils","../../core/Logger","../../core/LRUCache","../../core/maybe","../../core/memoize","../../core/reactiveUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/ElevationQueryTileCache","../../properties/defaultUnit","./ElevationProfileController","./ElevationProfileLineGround","./elevationProfileLineTypes","./ElevationProfileTool","./support/constants","./support/geometryUtils","./support/ProfileGenerationError","./support/profileUtils","./support/statisticsUtils"],(function(e,t,r,i,o,n,l,s,a,u,c,p,h,d,f,y,_,v,g,m,E,P,b,U,S,C,k,w,O){"use strict";let T=function(t){function r(e){var r;return(r=t.call(this,e)||this).view=null,r.input=null,r._getEffectiveUnitsMemoized=p.memoize(((e,t)=>({distance:e,elevation:t}))),r.geodesicDistanceThreshold=1e5,r.hoveredChartPosition=null,r.uniformChartScaling=!1,r.defaultUnit=null,r.queue=null,r._currentTileCache=null,r.error=null,r._defaultProfileLineGround=new P,r._userUnitOptions=null,r._userUnit=null,e?.profiles||(r.profiles=new l([r._defaultProfileLineGround])),r}e._inherits(r,t);var i=r.prototype;return i.initialize=function(){this.addHandles(h.watch((()=>this.view),(e=>{if(null==e)return void a.getLogger(this).warnOnce("no view. Widget will be disabled until a view is provided.");this.removeHandles(G);const t="3d"===e.type?e.resourceController:void 0;this.queue?.destroy(),this.queue=w.createProfileQueue(t?.scheduler);const r=t?.addUpdatingObject(this);r&&this.addHandles(r,G)}),h.syncAndInitial)),this.tool=new U.ElevationProfileTool({viewModel:this}),this._controller=new E.ElevationProfileController({viewModel:this})},i.destroy=function(){this._defaultProfileLineGround=c.destroyMaybe(this._defaultProfileLineGround),this._controller=c.destroyMaybe(this._controller),this._currentTileCache=c.destroyMaybe(this._currentTileCache),this.tool=c.destroyMaybe(this.tool),this.queue=c.destroyMaybe(this.queue)},i.start=function(e){this.tool.interaction.start(e)},i.stop=function(){this.tool.interaction.stop()},i.cancel=function(){this.tool.interaction.cancel()},i.clear=function(){this.tool.interaction.clear()},i._findSelectableUnit=function(e,t){const r=this.unitOptions;return null!=e&&r.includes(e)?e:t?this._findSelectableUnit(t):r[0]},i._filteredOrAllUnits=function(e){const t=(null!=e?e:[]).filter((e=>d.measurementLengthUnits.includes(e)));return 0===t.length?d.measurementLengthUnits.slice():t},e._createClass(r,[{key:"profiles",get:function(){return this._get("profiles")},set:function(e){const t=this._get("profiles"),r=e??new l;this._set("profiles",s.referenceSetter(r,t))}},{key:"state",get:function(){const e=this.view;return null!=e&&e.ready?this.tool.state:S.ElevationProfileState.Disabled}},{key:"progress",get:function(){let e=0,t=0;for(const r of this.visibleProfiles)e++,t+=r.progress;return e>0?t/e:0}},{key:"unitOptions",get:function(){return this._filteredOrAllUnits(this._userUnitOptions)},set:function(e){this._userUnitOptions=e,this._set("unitOptions",this._filteredOrAllUnits(this._userUnitOptions))}},{key:"unit",get:function(){return this._userUnit?(this._userUnit=this._findSelectableUnit(this._userUnit,this.defaultUnit),this._userUnit):this._findSelectableUnit(this.defaultUnit)},set:function(e){this._userUnit=e?this._findSelectableUnit(e,this._userUnit):null,this.notifyChange("unit")}},{key:"effectiveUnits",get:function(){const e=O.getBoundsInMeters(this.visibleProfiles.map((e=>e.result))),t=d.preferredLengthUnit(e.maxDistance,"meters",this.unit),r=d.preferredVerticalLengthUnit(e.maxElevation,"meters",this.unit);return this._getEffectiveUnitsMemoized(t,r)}},{key:"highlightEnabled",get:function(){return this.tool.highlightEnabled},set:function(e){this.tool.highlightEnabled=e}},{key:"hasVertices",get:function(){const e=c.applySome(this.input,(e=>e.geometry));return C.isPolyline(e)&&e.paths.reduce(((e,t)=>e+t.length),0)>0}},{key:"hoveredPoints",get:function(){return null!=this.input&&this.visible&&this.tool.editable?this.visibleProfiles.map((e=>{const t=e.hoveredPoint;return null!=t?{hoveredPoint:t,color:e.color}:null})).filter(o.isSome):[]}},{key:"statistics",get:function(){return O.mergeStatistics(this.visibleProfiles.map((e=>e.statistics)))}},{key:"chartData",get:function(){if(null==this.input)return null;const{effectiveUnits:e,progress:t,statistics:r,visibleProfiles:i,uniformChartScaling:o}=this,n=i.filter((e=>e.hasZ)).map((e=>({id:e.id,type:e.type,title:e.title,color:e.color,samples:e.samples,progress:e.progress,chartFillEnabled:e.chartFillEnabled,chartStrokeWidth:e.chartStrokeWidth,chartStrokeOffsetY:e.chartStrokeOffsetY,viewVisualizationEnabled:e.viewVisualizationEnabled})));return 0===n.length?null:{lines:n,effectiveUnits:e,statistics:r,refined:1===t,dynamicElevationRange:i.some((e=>"view"===e.type)),uniformScaling:o}}},{key:"visibleProfiles",get:function(){return this.profiles.toArray().filter((e=>e.available&&e.visible))}},{key:"minDemResolutions",get:function(){const e=[];for(const{minDemResolution:t}of this.visibleProfiles)null!=t&&e.push(t);return e}},{key:"minDemResolution",get:function(){return o.min(this.minDemResolutions)}},{key:"errorState",get:function(){const e=c.applySome(this.input,(e=>e.geometry));if(!C.isValidInputPath(e))return S.ElevationProfileErrorState.NoValidInput;if(null!=this.error){if(k.isProfileGenerationError(this.error))switch(this.error.cause){case k.ProfileGenerationErrorCause.TooComplex:return S.ElevationProfileErrorState.TooComplex;case k.ProfileGenerationErrorCause.InvalidGeometry:return S.ElevationProfileErrorState.InvalidGeometry;case k.ProfileGenerationErrorCause.InvalidElevationInfo:return S.ElevationProfileErrorState.InvalidElevationInfo;case k.ProfileGenerationErrorCause.ElevationQueryError:return S.ElevationProfileErrorState.NoValidInput}return S.ElevationProfileErrorState.UnknownError}return 0===this.visibleProfiles.length?S.ElevationProfileErrorState.NoVisibleProfiles:null==this.chartData&&1===this.progress?S.ElevationProfileErrorState.RefinedButNoChartData:S.ElevationProfileErrorState.None}},{key:"tileCache",get:function(){this._currentTileCache=c.destroyMaybe(this._currentTileCache);const e=this.view;if(null!=e&&"3d"===e?.type){const t=e.basemapTerrain?.elevationQueryCache;if(null!=t)return t}return null==this._currentTileCache&&(this._currentTileCache=new g.ElevationQueryTileCache(new u.LRUCache(20*n.ByteSizeUnit.MEGABYTES))),this._currentTileCache}},{key:"visible",get:function(){return this.tool.visible},set:function(e){this.tool.visible=e}},{key:"inputIsSketched",get:function(){return this.tool.interaction.isSketchedGraphic(this.input)}},{key:"elevationProvider",get:function(){const e=this.view;return null!=e&&"3d"===e.type?e.elevationProvider:null}},{key:"updating",get:function(){const{progress:e}=this;return e>0&&e<1}}]),r}(i);t.__decorate([f.property()],T.prototype,"view",void 0),t.__decorate([f.property({type:r})],T.prototype,"input",void 0),t.__decorate([f.property({type:b.ElevationProfileLineCollection,nonNullable:!0})],T.prototype,"profiles",null),t.__decorate([f.property({readOnly:!0})],T.prototype,"state",null),t.__decorate([f.property({readOnly:!0})],T.prototype,"progress",null),t.__decorate([f.property()],T.prototype,"unitOptions",null),t.__decorate([f.property()],T.prototype,"unit",null),t.__decorate([f.property({readOnly:!0})],T.prototype,"effectiveUnits",null),t.__decorate([f.property({type:Number})],T.prototype,"geodesicDistanceThreshold",void 0),t.__decorate([f.property()],T.prototype,"hoveredChartPosition",void 0),t.__decorate([f.property()],T.prototype,"uniformChartScaling",void 0),t.__decorate([f.property()],T.prototype,"highlightEnabled",null),t.__decorate([f.property({readOnly:!0})],T.prototype,"hoveredPoints",null),t.__decorate([f.property({readOnly:!0})],T.prototype,"statistics",null),t.__decorate([f.property()],T.prototype,"chartData",null),t.__decorate([f.property()],T.prototype,"visibleProfiles",null),t.__decorate([f.property()],T.prototype,"minDemResolutions",null),t.__decorate([f.property({readOnly:!0})],T.prototype,"minDemResolution",null),t.__decorate([f.property({readOnly:!0})],T.prototype,"errorState",null),t.__decorate([f.property(m.defaultUnitPropertyMetadata)],T.prototype,"defaultUnit",void 0),t.__decorate([f.property()],T.prototype,"queue",void 0),t.__decorate([f.property()],T.prototype,"tileCache",null),t.__decorate([f.property()],T.prototype,"tool",void 0),t.__decorate([f.property()],T.prototype,"visible",null),t.__decorate([f.property()],T.prototype,"error",void 0),t.__decorate([f.property()],T.prototype,"inputIsSketched",null),t.__decorate([f.property()],T.prototype,"elevationProvider",null),t.__decorate([f.property()],T.prototype,"updating",null),t.__decorate([f.property()],T.prototype,"_defaultProfileLineGround",void 0),t.__decorate([f.property()],T.prototype,"_userUnitOptions",void 0),t.__decorate([f.property()],T.prototype,"_controller",void 0),t.__decorate([f.property()],T.prototype,"_userUnit",void 0),T=t.__decorate([v.subclass("esri.widgets.ElevationProfile.ElevationProfileViewModel")],T);const G=Symbol("updating-object");return T}));
