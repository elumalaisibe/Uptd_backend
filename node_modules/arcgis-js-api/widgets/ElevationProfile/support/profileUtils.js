/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../core/arrayUtils","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../geometry/Multipoint","../../../geometry/support/coordsUtils","../../../geometry/support/spatialReferenceUtils","../../../views/support/QueueProcessor","../../../views/support/Scheduler","./constants","./geometryUtils","./ProfileGenerationError","./statisticsUtils","../../support/traversalUtils"],(function(e,t,r,o,n,s,i,l,a,u,c,p,f,d,h){"use strict";async function*m(e,t){const{view:r,geometry:s,elevationInfo:i,providers:l,options:a}=e,u=r.spatialReference;if(!u||null==s||!p.isValidInputPath(s))throw new f.ProfileGenerationError(f.ProfileGenerationErrorCause.InvalidGeometry);const d=l.length;if(0===d)return null;const h=Math.round(a.maxTotalSamples/d);if(p.countPoints(s)>h)throw new f.ProfileGenerationError(f.ProfileGenerationErrorCause.TooComplex);const m=await p.densifyPath(s,i,r,u,a,h,t);let g=0;const w=new Array(d),P=new Array(d);for(let o=0;o<d;o++){const r=R(m);w[o]=r,g+=r.samples.length;const n={...e,provider:l[o],result:r,densificationResult:m};P[o]=y(n,t)[Symbol.iterator]()}if(g>a.maxTotalSamples)throw new f.ProfileGenerationError(f.ProfileGenerationErrorCause.TooComplex);const v=await Promise.all(P.map((e=>{const t=e.next();return!0===t.done?Promise.resolve(null):t.value})));n.throwIfAborted(t);for(let o=0;o<d;o++)w[o]=v[o];yield w,await n.after(e.delayAfterPreview??c.getConfig().delayAfterPreviewMillis,null,t.signal);const E=[];try{let e;do{e=!1;for(let t=0;t<d;t++){const r=P[t].next();!1===r.done&&(E.push({resultPromise:r.value,index:t}),e=!0)}}while(e)}finally{P.forEach((e=>e.return?.()))}for(const{resultPromise:o,index:c}of E)w[c]=await o,n.throwIfAborted(t),yield w;o.forEachSome(w,(e=>{e.progress=1})),yield w}function*y(e,r){const{densificationResult:o}=e,n={...e,abortOptions:r,densificationResult:o},s=h.breadthFirstBinaryPartitioning(0,n.result.samples.length),i=s.slice(0,n.provider.numSamplesForPreview);yield g(n,i,!0);const l=t.splitIntoChunks(s,n.provider.numSamplesPerChunk);for(const t of l)yield g(n,t,!1)}async function g({densificationResult:e,result:t,provider:r,queue:o,abortOptions:i,cache:l},a,u){const{densifiedPath:p,pathLength:f}=e,d=t.spatialReference,{samples:h}=t,m=[];for(let n=0;n<a.length;n++){const e=h[a[n]];m[n]=e.coordinate}try{return await o.push({geometry:new s({spatialReference:d,points:m,hasZ:p.hasZ}),provider:r,indices:a,preview:u,result:t,queryOptions:{...c.getConfig().defaultQueryOptions(),minDemResolution:u?Math.round(f/r.numSamplesForPreview):Math.round(f/h.length),cache:l}},i),{...t}}catch(y){return n.isAbortError(y)?null:c.ERROR_RESULT}}function w(e){return new a.QueueProcessor({priority:u.TaskPriority.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:async e=>{n.throwIfAborted(e.queryOptions);try{await P(e)}catch(t){n.throwIfNotAbortError(t)}}})}async function P({geometry:e,provider:t,indices:r,preview:o,result:n,queryOptions:s}){if(0===r.length)return;const i=(await C(t,e,s)).geometry,{hasZ:l,points:a}=i,u=s.noDataValue,{samples:c}=n;for(let p=0;p<r.length;p++){const e=c[r[p]];if(e.isHole)continue;const t=l?a[p][2]:null;null===t||t===u?e.sampledZ=null:(n.hasZ=!0,e.sampledZ=t),e.sampled=!0}v(c),n.progress=o?0:n.progress+r.length/c.length,n.statistics=d.getStatistics(n.samples,n.spatialReference)}function v(e){const t=e.length-1;let r=0;for(let o=1;o<=t;o++){(e[o].sampled||o===t)&&(E(e,r,o),r=o)}}function E(e,t,o){if(o-t==1)return;const n=e[t],s=n.sampledZ,i=e[o],l=i.sampledZ;if(null==s||null==l){for(let r=t+1;r<o;r++)e[r].sampledZ=null;return}const a=n.distance,u=i.distance-a;for(let c=t+1;c<o;c++){const t=e[c],o=(t.distance-a)/u;t.sampledZ=r.lerp(s,l,o)}}function R({densifiedPath:e,distances:t}){const r=e.spatialReference,o=l.getInfo(r),n=e.paths,s=n.length,a=[];let u=null,c=0;for(let l=0;l<s;l++){const e=n[l],r=e.length,s=t[l];for(let t=0;t<r;t++){const r=e[t],n=s[t];o&&(r[0]=i.unnormalizedCoordinate(r[0],o.valid[0],o.valid[1])),u&&0===t&&Z(a,u,r,c,n),a.push(b(r,n)),u=r,c=n}}return{progress:0,samples:a,hasZ:!1,statistics:null,spatialReference:r}}function Z(e,t,r,o,n){e.push(S(t,o)),e.push(S(r,n))}function b(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!1,isHole:!1}}function S(e,t){return{coordinate:e,distance:t,sampledZ:null,sampled:!0,isHole:!0}}async function C(e,t,r){try{return await e.queryElevation(t,r)}catch(o){throw new f.ProfileGenerationError(f.ProfileGenerationErrorCause.ElevationQueryError)}}e.createProfileQueue=w,e.generateProfile=y,e.generateProfiles=m,e.interpolateElevations=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
