/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../geometry","../../core/Accessor","../../core/screenUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/support/geodesicUtils","../../geometry/support/normalizeUtils","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/WKIDUnitConversion","../../geometry/SpatialReference","../../geometry/Polyline","../../geometry/Point"],(function(e,t,r,n,i,s,o,c,a,l,u,p,d,m,f,h,g,y,w){"use strict";function v(e){return e>.5?{min:.5,max:1}:e>.2?{min:.2,max:.5}:{min:.1,max:.2}}function S(e,t){switch(t){case"metric":return e>1e3?{distance:s.convertUnit(e,"meters","kilometers"),unit:"kilometer"}:e>1?{distance:e,unit:"meter"}:e>.01?{distance:s.convertUnit(e,"meters","centimeters"),unit:"centimeter"}:{distance:s.convertUnit(e,"meters","millimeters"),unit:"millimeter"};case"imperial":case"non-metric":return e>1609.344?{distance:s.convertUnit(e,"meters","miles"),unit:"mile"}:e>.3048?{distance:s.convertUnit(e,"meters","feet"),unit:"foot"}:{distance:s.convertUnit(e,"meters","inches"),unit:"inch"}}}function _(e){const{isWebMercator:t,wkt:r}=e;return t||(r?.includes("WGS_1984_Web_Mercator")??!1)}function U(e){const{wkid:t,wkt:r}=e;if(null!=t&&null!=h[t])return h.values[h[t]];if(null!=r){const e=r.lastIndexOf(",")+1,t=r.lastIndexOf("]]");return parseFloat(r.substring(e,t))}return 1}function b({state:{paddedViewState:e},spatialReference:t,width:r}){return t.isWrappable&&e.worldScreenWidth<r}function M(e,t){const{x:r,y:n}=e?f.webMercatorToGeographic(t,!0):t;return[r,n]}let P=function(t){function r(e){var r;return(r=t.call(this,e)||this).scaleComputedFrom=i.createScreenPoint(),r.view=null,r}e._inherits(r,t);var n=r.prototype;return n.getScaleBarProperties=function(e,t){if("disabled"===this.state||isNaN(e)||!t||!this.view)return null;const r=this._getDistanceInMeters();return null==r?null:this._getScaleBarProps(e,r,t)},n._getDistanceInMeters=function(){const{state:e,spatialReference:t}=this.view;if(!m.isValid(t))return null;const{isGeographic:r}=t,n=_(t);if(!r&&!n){return e.extent.width*U(t)}const[i,s]=this._getScaleMeasuringPoints(),o=n||r&&!p.isSupported(t)?g.WGS84:t,c=new y({paths:[[M(n,i),M(n,s)]],spatialReference:o}),a=d.straightLineDensify(c,10);let l;try{[l]=p.geodesicLengths([a],"meters")}catch{return null}return l},n._getScaleMeasuringPoints=function(){const e=this.view,{width:t,height:r,position:n,spatialReference:s}=e;if(b(e)){const e=m.getInfo(s),{valid:t}=e;return[new w(t[0],0,s),new w(t[1],0,s)]}let o=this.scaleComputedFrom.y-n[1];o>r?o=r:o<0&&(o=0);const c=i.createScreenPoint(0,o),a=i.createScreenPoint(t,o);return[e.toMap(c),e.toMap(a)]},n._getScaleBarProps=function(e,t,r){const n=this.view,i=e*t/(b(n)?n.state.paddedViewState.worldScreenWidth:n.width);if(i<.001)return null;const s=S(i,r),{distance:o,unit:c}=s;let a=o,l=0;for(;a>=1;)a/=10,l++;const{min:u,max:p}=v(a),d=p/a>=a/u?u:p;return{length:e*(d/a),value:10**l*d,unit:c}},e._createClass(r,[{key:"state",get:function(){return this.view?.ready&&"2d"===this.view?.type?"ready":"disabled"}}]),r}(n);t.__decorate([o.property()],P.prototype,"scaleComputedFrom",void 0),t.__decorate([o.property({readOnly:!0})],P.prototype,"state",null),t.__decorate([o.property()],P.prototype,"view",void 0),P=t.__decorate([u.subclass("esri.widgets.Scalebar.ScaleBarViewModel")],P);return P}));
