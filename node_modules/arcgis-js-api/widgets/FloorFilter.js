/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/events","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./FloorFilter/css","./FloorFilter/FloorFilterViewModel","./support/Heading","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/substitute"],(function(e,t,s,i,l,n,o,r,a,c,d,u,h,v,f,S,p,m){"use strict";const g=["ArrowUp","ArrowDown","End","Home"];let M=function(t){function s(e,s){var i;return(i=t.call(this,e,s)||this)._activeMenu=null,i._activeMenuIndex={levels:-1,menuItems:-1},i._baseNode=null,i._facilitiesListNode=null,i._levelsListNode=null,i._sitesListNode=null,i._searchInput=null,i.viewModel=new h,i.messages=null,i.messagesCommon=null,i.headingLevel=2,i._resizeObserver=new ResizeObserver((()=>i.scheduleRender())),i.addHandles(l.watch((()=>i._searchInput),(()=>i._focusSearch()))),i}e._inherits(s,t);var n=s.prototype;return n.destroy=function(){this._resizeObserver?.disconnect()},n.updateWebDocument=function(e){return this.viewModel.updateWebDocument(e)},n.render=function(){const{longNames:e}=this,t=e&&this.viewModel.isNormalMode?"expanded":"collapsed",s=this.renderButtons(),i=this.renderFilterMenu(),l=p.tsx("div",{class:this.classes(u.CSS.separator)}),n=this._getComponentPosition(),o=this._getPosition(n),r="top-right"===n||"bottom-right"===n,a="top-left"===n||"bottom-left"===n,c=f.isRTL(this.container),d=c&&a||!c&&r?i:s,h=c&&a||!c&&r?s:i;return p.tsx("div",{afterCreate:this._afterBaseNodeCreate,key:"floor-filter-menu",class:this.classes(u.CSS.floorFilter,u.CSS.esriWidget,`${u.CSS.floorFilterLayout}${t}`,`${u.CSS.floorFilterPosition}${o}`)},d,this.viewModel?.filterMenuOpen&&l,h)},n.renderButtons=function(){const e=this._getComponentPosition(),t=[];return"top"===this._getPosition(e)?(t.push(this.renderBrowseButton()),t.push(this.renderLevelButtons()),t.push(this.renderCloseLevelsButton()),t.push(this.renderZoomButton()),t.push(this.renderCollapseToggleButton())):(t.push(this.renderCollapseToggleButton()),t.push(this.renderZoomButton()),t.push(this.renderCloseLevelsButton()),t.push(this.renderLevelButtons()),t.push(this.renderBrowseButton())),p.tsx("div",{key:"button-container",class:this.classes(u.CSS.esriWidget,u.CSS.buttonContainer)},t)},n.renderBrowseButton=function(){const{longNames:e,messages:t}=this;return p.tsx("button",{key:"browse-button",title:t.buttons.browse,bind:this,class:this.classes(u.CSS.esriWidget,u.CSS.esriWidgetButton,u.CSS.esriInteractive,("loading"===this.viewModel.state||"disabled"===this.viewModel.state)&&u.CSS.esriButtonDisabled,u.CSS.browseButton,this.viewModel?.filterMenuOpen&&u.CSS.esriWidgetButtonActive),"aria-expanded":this.viewModel.filterMenuOpen.toString(),"aria-label":t.buttons.browse,onclick:this._toggleFilterMenu,type:"button"},p.tsx("div",{class:this.classes(u.CSS.buttonInfo)},p.tsx("span",{class:this.classes(u.CSS.esriIcon,u.CSS.urbanIcon)}),p.tsx("span",{class:this.classes(u.CSS.buttonLabel)},e&&this.viewModel.isNormalMode&&t.buttons.browse)))},n.renderLevelButtons=function(){if(!this.viewModel?.filterFeatures?.levels?.levelsInfo||!this.facility)return null;const{facility:e,messagesCommon:t,messages:s}=this,i=this.viewModel?.getFacility(e),l=this.viewModel?.getFacilityLevels(e),n=l.map((e=>this.renderLevelButton(e)));if(!n.length)return null;const o=i&&m.substitute(s.selector.levelsLabel,{name:`"${i.name}"`});if(this._isWebScene(this.view?.map)&&n?.length>1){const s={id:`all--${e}`,facilityId:e,shortName:t.all,longName:t.all,levelNumber:null,verticalOrder:null},i=this.renderLevelButton(s);n.push(i)}return p.tsx("ul",{key:"levels-button-container",class:this.classes(u.CSS.levelsContainer),bind:this,"data-id":"levels",afterCreate:f.storeNode,"data-node-ref":"_levelsListNode","aria-label":o,onkeydown:this._handleListKeydown},n)},n.renderLevelButton=function(e){const{longNames:t}=this,{shortName:s,longName:i,id:l}=e,n=`levels--${l}`,o=this.level===l,r=t&&this.viewModel.isNormalMode?i:s;return this.viewModel.isNormalMode||o||this.viewModel.levelsExpanded?p.tsx("li",{key:n},p.tsx("button",{"data-id":l,"data-list-id":"levels",bind:this,class:this.classes(u.CSS.esriWidgetButton,o?u.CSS.esriWidgetButtonActive:null,u.CSS.esriInteractive,u.CSS.levelButton),onclick:this._levelSelected,onfocus:this._onItemFocus,type:"button"},r)):null},n.renderCloseLevelsButton=function(){if(!this.level||this.viewModel.isNormalMode||!this.viewModel.levelsExpanded)return null;const{messagesCommon:e}=this;return p.tsx("button",{key:"close-levels-button",title:e.close,bind:this,class:this.classes(u.CSS.esriWidget,u.CSS.esriWidgetButton,u.CSS.esriInteractive,u.CSS.closeLevelsButton),"aria-label":e.close,onclick:this._closeLevels,type:"button"},p.tsx("div",{class:this.classes(u.CSS.buttonInfo)},p.tsx("span",{class:this.classes(u.CSS.esriIcon,u.CSS.closeIcon)})))},n.renderZoomButton=function(){const{longNames:e,messages:t,facility:s,site:i}=this,l=this.viewModel?.filterMenuType,n=this.viewModel?.filterMenuOpen,o=this.viewModel?.getSite(i),r=this.viewModel?.getFacility(s),a="site"===l&&n?!o:!r;return p.tsx("button",{key:"zoom-button",title:t.buttons.zoomTo,bind:this,class:this.classes(u.CSS.esriWidget,u.CSS.esriWidgetButton,a&&u.CSS.esriButtonDisabled,u.CSS.esriInteractive,this.viewModel?.getFacilityLevels(s).length>0?u.CSS.zoomButtonLevels:u.CSS.zoomButton),"aria-label":t.buttons.zoomTo,onclick:this._zoomToClicked,type:"button"},p.tsx("div",{class:this.classes(u.CSS.buttonInfo)},p.tsx("span",{class:this.classes(u.CSS.esriIcon,u.CSS.zoomToIcon)}),p.tsx("span",{class:this.classes(u.CSS.buttonLabel)},e&&this.viewModel.isNormalMode&&t.buttons.zoomTo)))},n.renderCollapseToggleButton=function(){const{longNames:e,messagesCommon:t}=this,s=e?u.CSS.collapseIconRight:u.CSS.expandIconRight,i=this.classes(u.CSS.esriIcon,s),l=e?t.collapse:t.expand;return p.tsx("button",{key:"minimize-toggle-button",title:l,bind:this,class:this.classes(u.CSS.esriWidget,u.CSS.esriWidgetButton,u.CSS.esriInteractive,u.CSS.minimizeToggleButton),"aria-label":l,onclick:this._toggleCollapsed,type:"button"},p.tsx("div",{class:this.classes(u.CSS.buttonInfo)},p.tsx("span",{class:i}),p.tsx("span",{class:this.classes(u.CSS.buttonLabel)},e&&this.viewModel.isNormalMode&&t.collapse)))},n.renderFilterMenu=function(){return this.viewModel?.filterMenuOpen?"site"===this.viewModel?.filterMenuType?this.renderSiteFilterMenu():"facility"===this.viewModel?.filterMenuType?this.renderFacilityFilterMenu():null:null},n.renderSiteFilterMenu=function(){const{messages:e,messagesCommon:t}=this,s=this.site?this.viewModel?.getSite(this.site)?.name:e.selector.selectSite,i=p.tsx("div",{key:"filter-menu-site-header",class:this.classes(`${u.CSS.filterMenuHeader}`)},p.tsx("div",{class:this.classes(u.CSS.filterMenuHeaderTextGroup)},p.tsx(v.Heading,{level:this.headingLevel,class:this.classes(u.CSS.filterMenuHeaderText)},s)),p.tsx("button",{bind:this,title:t.close,class:this.classes(u.CSS.esriIcon,u.CSS.closeIcon),onclick:this._closeClicked,type:"button"})),l=this.renderSearchInput(),n=this.renderSiteItems();return p.tsx("div",{key:"filter-menu-site",class:this.classes(u.CSS.filterMenu)},i,l,n)},n.renderFacilityFilterMenu=function(){const{messages:e,messagesCommon:t,site:s}=this,i=this.viewModel?.getSite(s)?.name,l=this.facility&&this.viewModel?.getFacility(this.facility)?.name||e.selector.selectFacility,n=this.viewModel.hasMultipleSites?p.tsx("button",{bind:this,title:t.back,class:this.classes(u.CSS.filterMenuHeaderBack),onclick:this._backClicked,type:"button"},p.tsx("span",{class:this.classes(f.isRTL(this.container)?u.CSS.rightIcon:u.CSS.leftIcon)})):null,o=this.viewModel.hasMultipleSites?p.tsx(v.Heading,{level:v.incrementHeadingLevel(this.headingLevel),class:this.classes(u.CSS.filterMenuHeaderSubtext)},i):null,r=p.tsx("div",{key:"filter-menu-site-header",class:this.classes(u.CSS.filterMenuHeader)},n,p.tsx("div",{class:this.classes(u.CSS.filterMenuHeaderTextGroup)},p.tsx(v.Heading,{level:this.headingLevel,class:this.classes(u.CSS.filterMenuHeaderText)},l),o),p.tsx("button",{bind:this,title:t.close,class:this.classes(u.CSS.esriIcon,u.CSS.closeIcon),onclick:this._closeClicked,type:"button"})),a=this.renderSearchInput(),c=this.renderFacilityItems();return p.tsx("div",{key:"filter-menu-facility",class:this.classes(u.CSS.filterMenu)},r,a,c)},n.renderSearchInput=function(){const{messagesCommon:e}=this;return p.tsx("div",{key:"filter-menu-search",class:this.classes(u.CSS.filterMenuSearch)},p.tsx("span",{class:this.classes(u.CSS.esriIcon,u.CSS.searchIcon)}),p.tsx("input",{bind:this,key:"filter-menu-search__input",afterCreate:f.storeNode,"data-node-ref":"_searchInput",class:this.classes(u.CSS.filterMenuSearchInput),placeholder:e.search,oninput:this._onSearchChange,onpaste:this._onSearchChange,value:this.viewModel.searchTerm??void 0}))},n.renderBlueCircle=function(){return p.tsx("span",{key:"floor-filter__selected-item-circle",class:this.classes(u.CSS.selectedItemCircle)})},n.renderSiteItems=function(){if(!this.viewModel?.filterFeatures?.sites?.sitesInfo)return null;const{messages:e}=this,t=this.viewModel.filterFeatures.sites.sitesInfo,s=this.viewModel.filterSites(t).map((e=>this.renderSiteItem(e))),i=0===s.length&&this.viewModel?.searchTerm&&p.tsx("div",{class:this.classes(u.CSS.esriWidgetContentEmpty)},e.noResults);return p.tsx("ul",{key:"filter-menu-items--sites",class:this.classes(u.CSS.filterMenuItems),bind:this,afterCreate:f.storeNode,"data-node-ref":"_sitesListNode","data-id":"sites",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":e.selector.sitesLabel},s,i)},n.renderSiteItem=function(e){const{name:t,id:s}=e,i=`filter-menu-site--${s}`,l=this.site===s;return p.tsx("li",{key:i},p.tsx("button",{"data-id":s,"data-list-id":"sites",bind:this,class:this.classes(u.CSS.filterMenuSite),onclick:this._siteSelected,onfocus:this._onItemFocus,type:"button"},l&&this.renderBlueCircle(),p.tsx("span",{class:this.classes(l?u.CSS.filterMenuSelectedItem:u.CSS.filterMenuItemName)},t),p.tsx("span",{class:this.classes(f.isRTL(this.container)?u.CSS.leftIcon:u.CSS.rightIcon)})))},n.renderFacilityItems=function(){if(!this.viewModel?.filterFeatures?.facilities?.facilitiesInfo)return null;const{messages:e,site:t}=this,s=this.viewModel.getSite(t),i=this.viewModel.filterFeatures.facilities.facilitiesInfo,l=this.viewModel.filterFacilities(i).map((e=>this.renderFacilityItem(e))),n=0===l.length&&this.viewModel?.searchTerm&&p.tsx("div",{class:this.classes(u.CSS.esriWidgetContentEmpty)},e.noResults),o=s?m.substitute(e.selector.siteFacilitiesLabel,{name:`"${s.name}"`}):e.selector.facilitiesLabel;return p.tsx("ul",{key:"filter-menu-items--facilities",class:this.classes(u.CSS.filterMenuItems),bind:this,afterCreate:f.storeNode,"data-node-ref":"_facilitiesListNode","data-id":"facilities",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":o},l,n)},n.renderFacilityItem=function(e){const{name:t,id:s}=e,i=`filter-menu-facility--${s}`,l=this.facility===s;return p.tsx("li",{key:i},p.tsx("button",{"data-id":s,"data-list-id":"facilities",bind:this,class:this.classes(u.CSS.filterMenuFacility),onclick:this._facilitySelected,onfocus:this._onItemFocus,type:"button"},l&&this.renderBlueCircle(),p.tsx("span",{class:this.classes(l?u.CSS.filterMenuSelectedItem:u.CSS.filterMenuItemName)},t)))},n._afterBaseNodeCreate=function(e){this._baseNode&&this._resizeObserver?.unobserve(this._baseNode),this._baseNode=e,this._resizeObserver?.observe(this._baseNode)},n._toggleCollapsed=function(){this.longNames=!this.longNames},n._toggleFilterMenu=function(){const e=this.viewModel?.filterMenuOpen??!1;this.viewModel.filterMenuOpen=!e},n._setFilterMenuType=function(e){this.viewModel.filterMenuType=e},n._zoomToClicked=function(){if(this.site&&"site"===this.viewModel?.filterMenuType&&this.viewModel?.filterMenuOpen){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}else if(this.facility){const e=this.viewModel?.getFacility(this.facility);this.viewModel.goTo(e)}else if(this.site){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}},n._onSearchChange=function(e){const t=e.target;""===t.value?this.viewModel.searchTerm=null:t.value&&this.viewModel?.searchTerm!==t.value&&(this.viewModel.searchTerm=t.value.toLowerCase().trim())},n._closeClicked=function(){this.viewModel.searchTerm=null,this.viewModel.filterMenuOpen=!1},n._backClicked=function(){this._setFilterMenuType("site"),this.viewModel.searchTerm=null},n._siteSelected=function(e){const t=e.currentTarget.getAttribute("data-id"),s=this.viewModel.getSite(t);let i=!1;this.site!==t&&(this.facility=null,this.level=null,i=!0,this.viewModel.levelsExpanded=!1),this.site=t,this.viewModel.searchTerm=null,this._setFilterMenuType("facility"),this.viewModel.goTo(s),i&&this.viewModel.setFloors(null)},n._facilitySelected=function(e){const t=e.currentTarget.getAttribute("data-id"),s=this.viewModel.getFacility(t);let i=!1;if(this.facility!==t){if("base-floors"===this.viewModel.filterMode){const e=this.viewModel?.getBaseLevel(s);this.level=e?e.id:null}else this.level=null;i=!0,this.viewModel.levelsExpanded=!1}if(this.facility=t,this.viewModel.goTo(s),i){const e=this.viewModel.getLevel(this.level);this.viewModel.setFloors(e)}if(!this.viewModel.isNormalMode){const e=this.viewModel.getFacilityLevels(t);e?.length>1&&(this.viewModel.levelsExpanded=!0)}setTimeout((()=>this._focusActiveLevel()),50)},n._levelSelected=function(e){const t=e.currentTarget.getAttribute("data-id");this.level=t},n._closeLevels=function(){this.viewModel.levelsExpanded=!1},n._isWebScene=function(e){return"esri.WebScene"===e?.declaredClass},n._getComponentPosition=function(){return null!=this.container?this.view?.ui?.getPosition(this.container):null},n._getPosition=function(e){switch(e){case"bottom-right":case"bottom-left":return"bottom";default:return"top"}},n._handleListKeydown=function(e){const t=e.currentTarget.getAttribute("data-id");let s=null;"sites"===t||"facilities"===t?(this._activeMenu!==t&&(this._activeMenuIndex.menuItems=-1),this._activeMenu=t,s="menuItems"):"levels"===t&&(s="levels");const l="sites"===t?this._sitesListNode:"facilities"===t?this._facilitiesListNode:"levels"===t?this._levelsListNode:null,n=i.eventKey(e),o="Tab"===n,r=g.includes(n);r&&e.preventDefault();const a=l?.getElementsByTagName("li");a&&0!==a.length&&(r||o)&&this._handleItemNavigation(n,e.shiftKey,a,o,s)},n._handleItemNavigation=function(e,t,s,i,l){if(!l)return;this._activeMenuIndex[l]===s.length&&this._activeMenuIndex[l]--,-1===this._activeMenuIndex[l]&&this._activeMenuIndex[l]++;const n=this._activeMenuIndex[l];switch(e){case"Home":this._activeMenuIndex[l]=0;break;case"End":this._activeMenuIndex[l]=s.length-1;break;case"ArrowUp":this._activeMenuIndex[l]=this._activeMenuIndex[l]<=0?s.length-1:this._activeMenuIndex[l]-1;break;case"ArrowDown":this._activeMenuIndex[l]=this._activeMenuIndex[l]===s.length-1?0:this._activeMenuIndex[l]+1}if("Tab"===e&&t&&this._activeMenuIndex[l]>=0&&this._activeMenuIndex[l]--,"Tab"===e&&!t&&this._activeMenuIndex[l]<s.length&&this._activeMenuIndex[l]++,n!==this._activeMenuIndex[l]&&this._activeMenuIndex[l]>-1&&this._activeMenuIndex[l]<s.length&&!i){const e=s[this._activeMenuIndex[l]].getElementsByTagName("button"),t=1===e?.length?e[0]:null;t?.focus()}},n._focusSearch=function(){this._searchInput?.focus()},n._focusActiveLevel=function(){const{level:e}=this,t=this._levelsListNode,s=t?.getElementsByTagName("li");if(!e||!t||!s)return;const i=this._facilitiesListNode?.getElementsByTagName("li");this._activeMenuIndex.menuItems=i?i.length-1:-1;const l=[];for(let n=0;n<s.length;n++){const e=s[n].getElementsByTagName("button");1===e?.length&&l.push(e[0])}l.forEach(((t,s)=>{t.getAttribute("data-id")===e&&(t.focus(),this._activeMenuIndex.levels=s)}))},n._onItemFocus=function(e){const t=e.currentTarget,s=t.getAttribute("data-list-id"),i=t.getAttribute("data-id"),l="sites"===s?this._sitesListNode:"facilities"===s?this._facilitiesListNode:"levels"===s?this._levelsListNode:null;if(!l)return;const n=l?.getElementsByTagName("li");if(!n)return;const o=[];Array.from(n).forEach((e=>{const t=e.getElementsByTagName("button");1===t?.length&&o.push(t[0])}));let r=null;switch(s){case"sites":case"facilities":r="menuItems";break;case"levels":r="levels"}if(!r)return;const a=r;o.forEach(((e,t)=>{e.getAttribute("data-id")===i&&this._activeMenuIndex[a]!==t&&(this._activeMenuIndex[a]=t)}))},e._createClass(s,[{key:"enabled",get:function(){return this.viewModel.enabled},set:function(e){this.viewModel.enabled=e}},{key:"longNames",get:function(){return this.viewModel.longNames},set:function(e){this.viewModel.longNames=e}},{key:"minimized",get:function(){return this.viewModel.minimized},set:function(e){this.viewModel.minimized=e}},{key:"pinnedLevels",get:function(){return this.viewModel.pinnedLevels},set:function(e){this.viewModel.pinnedLevels=e}},{key:"site",get:function(){return this.viewModel.site},set:function(e){this.viewModel.site=e}},{key:"facility",get:function(){return this.viewModel.facility},set:function(e){this.viewModel.facility=e}},{key:"level",get:function(){return this.viewModel.level},set:function(e){this.viewModel.level=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}},{key:"goToOverride",get:function(){return this.viewModel.goToOverride},set:function(e){this.viewModel.goToOverride=e}}]),s}(d);t.__decorate([n.property()],M.prototype,"_searchInput",void 0),t.__decorate([n.property()],M.prototype,"enabled",null),t.__decorate([n.property()],M.prototype,"longNames",null),t.__decorate([n.property()],M.prototype,"minimized",null),t.__decorate([n.property()],M.prototype,"pinnedLevels",null),t.__decorate([n.property()],M.prototype,"site",null),t.__decorate([n.property()],M.prototype,"facility",null),t.__decorate([n.property()],M.prototype,"level",null),t.__decorate([n.property()],M.prototype,"view",null),t.__decorate([n.property({type:h})],M.prototype,"viewModel",void 0),t.__decorate([n.property(),S.messageBundle("esri/widgets/FloorFilter/t9n/FloorFilter")],M.prototype,"messages",void 0),t.__decorate([n.property(),S.messageBundle("esri/t9n/common")],M.prototype,"messagesCommon",void 0),t.__decorate([n.property()],M.prototype,"goToOverride",null),t.__decorate([n.property()],M.prototype,"headingLevel",void 0),M=t.__decorate([c.subclass("esri.widgets.FloorFilter")],M);return M}));
