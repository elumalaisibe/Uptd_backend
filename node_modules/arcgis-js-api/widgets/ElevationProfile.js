/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/asyncUtils","../core/maybe","../core/memoize","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Widget","./ElevationProfile/css","./ElevationProfile/ElevationProfileViewModel","./ElevationProfile/ElevationProfileVisibleElements","./ElevationProfile/components/Legend","./ElevationProfile/components/SettingsButton","./ElevationProfile/support/chartUtils","./ElevationProfile/support/constants","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(t,e,n,o,r,i,s,a,l,c,h,d,u,p,_,C,f,y,m,v,S,g,k){"use strict";var b;!function(t){t.Sketch="sketch",t.SketchCancel="sketch-cancel",t.SketchDone="sketch-done",t.Select="select",t.SelectCancel="select-cancel"}(b||(b={}));const w=[{type:b.Select},{type:b.Sketch}],E={[v.ElevationProfileErrorState.None]:null,[v.ElevationProfileErrorState.NoValidInput]:"noProfile",[v.ElevationProfileErrorState.NoVisibleProfiles]:"noProfile",[v.ElevationProfileErrorState.RefinedButNoChartData]:"noProfile",[v.ElevationProfileErrorState.TooComplex]:"tooComplex",[v.ElevationProfileErrorState.UnknownError]:"unknown",[v.ElevationProfileErrorState.InvalidGeometry]:"invalidGeometry",[v.ElevationProfileErrorState.InvalidElevationInfo]:"invalidElevationInfo"},M=Symbol("resize-observer-handle");let P=function(e){function a(t,n){var o;return(o=e.call(this,t,n)||this).viewModel=null,o.visibleElements=new C,o.iconClass=p.CSS.widgetIcon,o.icon=null,o.messages=null,o.messagesCommon=null,o.messagesUnits=null,o._chartContainer=null,o._chart=null,o._chartInitTask=null,o._chartIsRefined=!1,o._width=0,o._zoomOutButtonVisible=!1,o._getChartUpdateParamsMemoized=r.memoize(((t,e,n,o)=>({chart:t,data:e,stationary:n,messages:o}))),o._getDetailsPropsMemoized=r.memoize(((t,e)=>({effectiveUnits:t,profiles:e}))),t?.viewModel||(o._defaultViewModel=new _({view:t?.view}),o.viewModel=o._defaultViewModel),o}t._inherits(a,e);var l=a.prototype;return l.initialize=function(){this._legend=new f.Legend(this._legendProps),this._settingsButton=new y.SettingsButton(this._settingsButtonProps),this.addHandles([s.watch((()=>this._legendProps),(t=>this._legend.set(t))),s.watch((()=>this._settingsButtonProps),(t=>this._settingsButton.set(t)))])},l.postInitialize=function(){this.addHandles([s.watch((()=>({container:this._chartContainer,width:this._width})),(({container:t,width:e})=>{this._destroyChart(),null!=t&&e>0&&this._initializeChart(t)}),s.initial),s.watch((()=>this._chartUpdateParams),(()=>this._updateChart(this._chartUpdateParams)),s.initial)])},l.destroy=function(){this._destroyChart(),null!=this._defaultViewModel&&this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy(),this._legend=o.destroyMaybe(this._legend),this._settingsButton=o.destroyMaybe(this._settingsButton)},l.render=function(){const{viewModel:t,visible:e}=this;return k.tsx("div",{key:this,class:this.classes({[p.CSS.base]:e,[p.CSS.esriWidget]:e,[p.CSS.esriWidgetDisabled]:e&&"disabled"===t.state,[p.CSS.portrait]:this._portrait,[p.CSS.refined]:1===t.progress}),"aria-label":this.messages.widgetLabel},k.tsx("div",{key:"content-wrapper",bind:this,afterCreate:this._onContentWrapperAfterCreate,afterRemoved:this._onContentWrapperRemoved},e&&this._renderContentForState()))},l._renderContentForState=function(){switch(this.viewModel.state){case v.ElevationProfileState.Ready:return this._renderContentForReadyState();case v.ElevationProfileState.Selecting:return this._renderContentForSelectingState();case v.ElevationProfileState.Creating:return this._renderContentForCreatingState();case v.ElevationProfileState.Selected:return this._renderContentForSelectedState();case v.ElevationProfileState.Created:return this._renderContentForCreatedState();case v.ElevationProfileState.Disabled:return this._renderContentForReadyState()}},l._renderContentForReadyState=function(){const{sketchButton:t,selectButton:e}=this.visibleElements,n=this.messages;let o;return o=t&&e?n.readyPrompt:t?n.readyPromptCreateOnly:e?n.readyPromptSelectOnly:n.errors?.noProfile,this._renderContent({prompt:o,chart:!1,actions:w})},l._renderContentForSelectingState=function(){const t=this.view;if(null==t)return null;const e=this.messages[`selectingPrompt-${t.type}`];return this._renderContent({prompt:e,chart:!1,actions:[{type:b.SelectCancel}]})},l._renderContentForCreatingState=function(){const{view:t,viewModel:e}=this;if(null==t)return null;const n=e.hasVertices?[{type:b.SketchCancel},{type:b.SketchDone,disabled:!e.tool.interaction.canStopCreating}]:[{type:b.Select},{type:b.Sketch,disabled:!0}];if(e.errorState===v.ElevationProfileErrorState.NoValidInput){const e=this.messages[`creatingPrompt-${t.type}`];return this._renderContent({chart:!1,actions:n,prompt:e})}const o=this._getErrorMessage();return o?this._renderContent({chart:!1,actions:n,prompt:o}):this._renderContent({chart:!0,actions:n})},l._renderContentForSelectedState=function(){const t=this._getErrorMessage();return t?this._renderContent({chart:!1,actions:w,prompt:t}):this._renderContent({chart:!0,actions:w})},l._renderContentForCreatedState=function(){const t=this._getErrorMessage();return t?this._renderContent({chart:!1,actions:w,prompt:t}):this._renderContent({chart:!0,actions:w})},l._getErrorMessage=function(){const t=E[this.viewModel.errorState];return t?this.messages?.errors?.[t]:null},l._renderContent=function(t){const e=null!=t.prompt?this._renderPrompt(t.prompt):t.chart&&this._renderChart(),n=null!=this.viewModel.input;return[k.tsx("header",{key:"header",class:p.CSS.header},this._zoomOutButtonVisible&&this._renderZoomOutButton(),this.visibleElements.clearButton&&n&&this._renderClearButton(),this.visibleElements.settingsButton&&this._settingsButton.render()),k.tsx("div",{class:p.CSS.mainContainer},e),this.visibleElements.legend&&this._legend.render(),this._renderActions(t)]},l._renderZoomOutButton=function(){return k.tsx("button",{key:"zoom-out",class:p.CSS.zoomOutButton,bind:this,onclick:this._onZoomOutButtonClick,title:this.messages.zoomOut,type:"button"})},l._onZoomOutButtonClick=function(){o.applySome(this._chart,(t=>t.zoomOut()))},l._renderClearButton=function(){return k.tsx("button",{key:"clear-profile",class:p.CSS.clearButton,bind:this,onclick:this._onClearButtonClick,title:this.messages.clearProfile,type:"button"})},l._onClearButtonClick=function(){this.viewModel.clear()},l._renderPrompt=function(t){return[k.tsx("div",{key:"prompt-container",bind:this,class:p.CSS.promptContainer},k.tsx("p",null,t))]},l._renderChart=function(){if(!this.visibleElements.chart)return[k.tsx("div",{key:"empty-chart-container",class:p.CSS.chartContainer})];const t=this._chartIsRefined||this._canRenderChart();if(!t)return[this._renderSpinner({size:"large"}),k.tsx("div",{key:"chart-container-empty",class:p.CSS.chartContainer})];const{chartData:e,progress:n}=this.viewModel;return[null!=e&&n>0&&n<1&&this._renderSpinner({size:t?"small":"large"}),k.tsx("div",{key:"chart-container",bind:this,class:p.CSS.chartContainer,afterCreate:this._onChartContainerAfterCreate,afterRemoved:this._onChartContainerRemoved})]},l._renderSpinner=function(t){return k.tsx("div",{key:"spinner",class:this.classes(p.CSS.chartSpinner,{[p.CSS.chartSpinnerSmall]:"small"===t.size}),afterCreate:this._onSpinnerAfterCreate,exitAnimation:this._onSpinnerExit})},l._onSpinnerAfterCreate=function(t){requestAnimationFrame((()=>t.classList.add(p.CSS.chartSpinnerVisible)))},l._onSpinnerExit=function(t,e){t.classList.remove(p.CSS.chartSpinnerVisible),setTimeout(e,200)},l._canRenderChart=function(){const t=this.viewModel.chartData;if(null==t)return!1;if(!this.viewModel.inputIsSketched)return t.refined;let e=0;for(const{samples:n}of t.lines)e+=null!=n?n.length:0;return t.refined||e<=v.getConfig().largeChartSamples},l._renderActions=function({actions:t}){const e=t.map((t=>{switch(t.type){case b.Sketch:return this.visibleElements.sketchButton&&this._renderAction({action:t,onClick:this._onSketchButtonClick,className:p.CSS.sketchButton,label:this.messages.sketchButtonLabel});case b.SketchCancel:return this.visibleElements.sketchButton&&this._renderAction({action:t,onClick:this._onCancelButtonClick,className:p.CSS.sketchCancelButton,label:this.messagesCommon.cancel});case b.SketchDone:return this.visibleElements.sketchButton&&this._renderAction({action:t,onClick:this._onDoneButtonClick,className:p.CSS.sketchDoneButton,label:this.messagesCommon.done});case b.Select:return this.visibleElements.selectButton&&this._renderAction({action:t,onClick:this._onSelectButtonClick,className:p.CSS.selectButton,label:this.messages.selectButtonLabel});case b.SelectCancel:return this.visibleElements.selectButton&&this._renderAction({action:t,onClick:this._onCancelButtonClick,className:p.CSS.selectCancelButton,label:this.messagesCommon.cancel})}})).filter(Boolean);return e.length?k.tsx("footer",{key:"footer",class:p.CSS.footer},e):null},l._renderAction=function({action:t,onClick:e,className:n,label:o}){return k.tsx("button",{key:`action-${t.type}`,class:this.classes(p.CSS.actionButton,n,{[p.CSS.buttonDisabled]:!!t.disabled}),bind:this,disabled:t.disabled,onclick:e,type:"button"},o)},l._onSketchButtonClick=function(){this.viewModel.start({mode:"sketch"})},l._onSelectButtonClick=function(){this.viewModel.start({mode:"select"})},l._onCancelButtonClick=function(){this.viewModel.cancel()},l._onDoneButtonClick=function(){this.viewModel.stop()},l._onContentWrapperAfterCreate=function(t){const e=S.onResize(t,(t=>{this._width=t.contentRect.width}));this.addHandles(e,M)},l._onContentWrapperRemoved=function(){this.removeHandles(M)},l._updateChart=function(t){const{data:e,chart:n,messages:o,stationary:r}=t;null!=n&&null!=o&&r&&this._canRenderChart()&&(n.update(t),this._chartIsRefined=null!=e&&e.refined)},l._onChartContainerAfterCreate=function(t){this._chartContainer=t},l._onChartContainerRemoved=function(){this._chartContainer=null},l._initializeChart=function(t){o.abortMaybe(this._chartInitTask),this._chartInitTask=n.createTask((async e=>{const n=await m.createChart({container:t,abortOptions:{signal:e},onRangeChange:(t,e)=>{this._zoomOutButtonVisible=1!==t||1!==e},onCursorPositionChange:t=>{this.viewModel.hoveredChartPosition=t}});if(e.aborted)throw o.destroyMaybe(n),i.createAbortError();this._chart=n,this._updateChart(this._chartUpdateParams)}))},l._destroyChart=function(){this._chartInitTask=o.abortMaybe(this._chartInitTask),this._chart=o.destroyMaybe(this._chart),this._chartIsRefined=!1},t._createClass(a,[{key:"view",get:function(){return this.viewModel.view},set:function(t){this.viewModel.view=t}},{key:"input",get:function(){return this.viewModel.input},set:function(t){this.viewModel.input=t}},{key:"profiles",get:function(){return this.viewModel.profiles},set:function(t){this.viewModel.profiles=t}},{key:"unitOptions",get:function(){return this.viewModel.unitOptions},set:function(t){this.viewModel.unitOptions=t}},{key:"unit",get:function(){return this.viewModel.unit},set:function(t){this.viewModel.unit=t}},{key:"geodesicDistanceThreshold",get:function(){return this.viewModel.geodesicDistanceThreshold},set:function(t){this.viewModel.geodesicDistanceThreshold=t}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(t){this._overrideIfSome("label",t)}},{key:"visible",get:function(){return this.viewModel.visible},set:function(t){this.viewModel.visible=t}},{key:"_portrait",get:function(){return this._width<v.getConfig().portraitModePixelBreakpoint}},{key:"_chartUpdateParams",get:function(){const t=this.view;return this._getChartUpdateParamsMemoized(this._chart,this.viewModel.chartData,null==t||t.stationary,this._chartMessages)}},{key:"_chartMessages",get:function(){return{...this.messagesUnits,...this.messages}}},{key:"_legendProps",get:function(){return this._getDetailsPropsMemoized(this.viewModel.effectiveUnits,this._profilesArray)}},{key:"_profilesArray",get:function(){return this.profiles.toArray()}},{key:"_settingsButtonProps",get:function(){return{viewModel:this.viewModel,visibleElements:this.visibleElements}}},{key:"test",get:function(){return{chart:this._chart}}}]),a}(u);e.__decorate([a.property({type:_})],P.prototype,"viewModel",void 0),e.__decorate([a.property()],P.prototype,"view",null),e.__decorate([a.property()],P.prototype,"input",null),e.__decorate([a.property()],P.prototype,"profiles",null),e.__decorate([a.property()],P.prototype,"unitOptions",null),e.__decorate([a.property()],P.prototype,"unit",null),e.__decorate([a.property()],P.prototype,"geodesicDistanceThreshold",null),e.__decorate([a.property({type:C,nonNullable:!0})],P.prototype,"visibleElements",void 0),e.__decorate([a.property()],P.prototype,"iconClass",void 0),e.__decorate([a.property()],P.prototype,"icon",void 0),e.__decorate([a.property()],P.prototype,"label",null),e.__decorate([a.property()],P.prototype,"visible",null),e.__decorate([a.property(),g.messageBundle("esri/widgets/ElevationProfile/t9n/ElevationProfile")],P.prototype,"messages",void 0),e.__decorate([a.property(),g.messageBundle("esri/t9n/common")],P.prototype,"messagesCommon",void 0),e.__decorate([a.property(),g.messageBundle("esri/core/t9n/Units")],P.prototype,"messagesUnits",void 0),e.__decorate([a.property()],P.prototype,"_chartContainer",void 0),e.__decorate([a.property()],P.prototype,"_chart",void 0),e.__decorate([a.property()],P.prototype,"_chartInitTask",void 0),e.__decorate([a.property()],P.prototype,"_chartIsRefined",void 0),e.__decorate([a.property()],P.prototype,"_settingsButton",void 0),e.__decorate([a.property()],P.prototype,"_legend",void 0),e.__decorate([a.property()],P.prototype,"_width",void 0),e.__decorate([a.property()],P.prototype,"_portrait",null),e.__decorate([a.property()],P.prototype,"_zoomOutButtonVisible",void 0),e.__decorate([a.property()],P.prototype,"_chartUpdateParams",null),e.__decorate([a.property()],P.prototype,"_chartMessages",null),e.__decorate([a.property()],P.prototype,"_legendProps",null),e.__decorate([a.property()],P.prototype,"_profilesArray",null),e.__decorate([a.property()],P.prototype,"_settingsButtonProps",null),P=e.__decorate([d.subclass("esri.widgets.ElevationProfile")],P);return P}));
