/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/arrayUtils","../core/compilerUtils","../core/deprecate","../core/Logger","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/subclass","./Widget","./FeatureForm/css","./FeatureForm/featureFormUtils","./FeatureForm/FeatureFormViewModel","./support/componentsUtils","./support/Heading","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","../chunks/datetime","../intl/substitute","../intl/locale"],(function(e,t,i,n,a,s,l,r,o,u,d,c,p,h,m,_,f,v,b,g,I,y,F,w,C){"use strict";const S="TT",R="data-field-name",x="latn",k=e=>"valueAsDate"in e,T="esri.widgets.FeatureForm",D=r.getLogger(T);let M=function(i){function n(e,n){var a;return(a=i.call(this,e,n)||this)._dateFieldInputMap=new Map,a._activeInputName="",a._activeNumberFieldEdit=null,a._fieldFocusNeeded=!1,a._fieldToInitialIncompatibleDomainValue=new Map,a._switchFieldsWithInitialIncompatibleValue=new Set,a._userUpdatedFieldInputNames=new Set,a._listObserverNode=null,a._listObserver=new IntersectionObserver((e=>{e.length&&e[0].isIntersecting&&a._incrementRelatedRecordPage()}),{root:window.document}),a.groupDisplay="all",a.headingLevel=2,a.messages=null,a.messagesCommon=null,a.messagesFeature=null,a.messagesTemplates=null,a.viewModel=new _,a._onShowAllRelatedRecordsClick=e=>{const{feature:i,relatedRecordCallbacks:n}=t._assertThisInitialized(a);i&&n?.showAllRelatedRecords&&n.showAllRelatedRecords({parentFeature:i,relationshipId:e})},a._onAddRelatedRecordsClick=(e,i)=>{const{feature:n,relatedRecordCallbacks:s}=t._assertThisInitialized(a);n&&s?.addRelatedRecord&&s.addRelatedRecord({parentFeature:n,relatedLayer:i,relationshipId:e})},a._handleInputInput=e=>{a._commitInputValue(e.currentTarget)},a._handleFormKeyDown=a._handleFormKeyDown.bind(t._assertThisInitialized(a)),a._handleInputBlur=a._handleInputBlur.bind(t._assertThisInitialized(a)),a._handleInputFocus=a._handleInputFocus.bind(t._assertThisInitialized(a)),a._handleNumberInputMouseDown=a._handleNumberInputMouseDown.bind(t._assertThisInitialized(a)),a._handleInputKeyDown=a._handleInputKeyDown.bind(t._assertThisInitialized(a)),a._handleOptionChange=a._handleOptionChange.bind(t._assertThisInitialized(a)),a._handleGroupClick=a._handleGroupClick.bind(t._assertThisInitialized(a)),a._handleSubmit=a._handleSubmit.bind(t._assertThisInitialized(a)),a._afterInputCreateOrUpdate=a._afterInputCreateOrUpdate.bind(t._assertThisInitialized(a)),a._afterDateInputCreateOrUpdate=a._afterDateInputCreateOrUpdate.bind(t._assertThisInitialized(a)),a}t._inherits(n,i);var r=n.prototype;return r.initialize=function(){this.addHandles([o.watch((()=>this.feature),(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e?.name||"",this._userUpdatedFieldInputNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._dateFieldInputMap.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedFieldInputNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})),o.watch((()=>[this.viewModel.activeRelationshipInput,this._listObserverNode]),(()=>this._onObserverChange()))])},r.loadDependencies=function(){return f.loadCalciteComponents({button:()=>new Promise(((t,i)=>e(["../chunks/calcite-button"],t,i))),combobox:()=>new Promise(((t,i)=>e(["../chunks/calcite-combobox"],t,i))),"combobox-item":()=>new Promise(((t,i)=>e(["../chunks/calcite-combobox-item"],t,i))),"combobox-item-group":()=>new Promise(((t,i)=>e(["../chunks/calcite-combobox-item-group"],t,i))),icon:()=>new Promise(((t,i)=>e(["../chunks/calcite-icon"],t,i))),"input-date-picker":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-date-picker"],t,i))),"input-message":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-message"],t,i))),"input-time-picker":()=>new Promise(((t,i)=>e(["../chunks/calcite-input-time-picker"],t,i))),list:()=>new Promise(((t,i)=>e(["../chunks/calcite-list"],t,i))),"list-item":()=>new Promise(((t,i)=>e(["../chunks/calcite-list-item"],t,i))),loader:()=>new Promise(((t,i)=>e(["../chunks/calcite-loader"],t,i))),notice:()=>new Promise(((t,i)=>e(["../chunks/calcite-notice"],t,i))),progress:()=>new Promise(((t,i)=>e(["../chunks/calcite-progress"],t,i))),switch:()=>new Promise(((t,i)=>e(["../chunks/calcite-switch"],t,i)))})},r.destroy=function(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode)},r.getValues=function(){return this.viewModel.getValues()},r.submit=function(){return this.viewModel.submit()},r.render=function(){const{state:e}=this.viewModel;return y.tsx("div",{class:this.classes(h.CSS.base,h.CSS.widget,h.CSS.panel)},"ready"===e?this._renderForm():null)},r._renderForm=function(){return y.tsx("form",{class:h.CSS.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},this._renderHeader(),this._renderInputs())},r._renderHeader=function(){const e=this.viewModel;if(!e.formHeaderVisible)return;const t=null!=e.formTitle&&y.tsx(v.Heading,{key:"title",level:this.headingLevel},e.formTitle),i=null!=e.formDescription&&y.tsx("p",{class:h.CSS.description,key:"description"},e.formDescription);return y.tsx("div",{class:h.CSS.formHeader},t,i)},r._renderInputs=function(){const{viewModel:e}=this;return e.activeRelationshipInput?this._renderActiveRelationshipInput(e.activeRelationshipInput):e.inputs.filter(a.isSome).filter((e=>e.visible)).map(((e,t)=>m.isGroupInput(e)?this._renderGroup(e,t):m.isFieldInput(e)?this._renderLabeledField(e):m.isRelationshipInput(e)?this._renderRelationshipInput(e):void 0))},r._renderActiveRelationshipInput=function(e){return this._renderRelationshipInput(e)},r._renderDescriptionOrEmpty=function(e,t){return null==e?null:y.tsx("div",{class:this.classes(h.CSS.description),id:t},e)},r._renderGroup=function(e,t){const{formTemplate:i,disabled:n}=this,{description:a,inputs:s,label:l,state:r}=e,o=s.filter((e=>e.visible)),u=this.viewModel.findField(this._activeInputName),d=!(!u||u.group!==e),c=`${this.id}_group_${t}`,p=`${this.id}_group-label_${t}`,_=`${this.id}_group-description_${t}`,f=this._renderDescriptionOrEmpty(a,_),b="sequential"===this.groupDisplay,g=b?d:"expanded"===r,I=g?h.CSS.collapseIcon:h.CSS.expandIcon;return y.tsx("fieldset",{"aria-expanded":g.toString(),"aria-labelledby":p,"aria-describedby":a?_:"",class:this.classes(h.CSS.group,b?h.CSS.groupSequential:null,g?null:h.CSS.groupCollapsed,d?h.CSS.groupActive:null,n?h.CSS.inputDisabled:null),disabled:n,"data-group":e,id:c,key:t,onclick:this._handleGroupClick},y.tsx("button",{role:b?"presentation":void 0,class:h.CSS.groupHeader,type:"button",tabIndex:b?-1:0},y.tsx("div",{class:h.CSS.groupTitle},y.tsx(v.Heading,{class:h.CSS.groupLabel,id:p,level:null!=i&&i.title?v.incrementHeadingLevel(this.headingLevel):this.headingLevel},l),f),b?null:y.tsx("span",{class:this.classes(I,h.CSS.groupToggleIcon)})),o.map((e=>m.isFieldInput(e)?this._renderLabeledField(e):m.isRelationshipInput(e)?this._renderRelationshipInput(e):void 0)))},r._getFocusableInput=function(e,t){const i=this.viewModel.allFieldInputs,n="forward"===e?i:i.slice().reverse();let a;if(!t||m.isRelationshipInput(t))a=0;else if(m.isGroupInput(t)){const e=t.inputs.find(m.isFieldInput);a=e?n.indexOf(e):0}else{let i;if(m.isInputInGroupInput(t)&&"collapsed"===t.group.state){const n=t.group.inputs.filter(m.isFieldInput);i="forward"===e?n[n.length-1]:n[0]}else i=t;a=n.indexOf(i)+1}for(let s=a;s<n.length;s++){const e=n[s];if(e.visible&&m.isFieldInput(e))return e}return null},r._renderLabeledField=function(e){const{dataType:t,feature:i,label:n,layer:a}=e;return y.tsx("label",{key:`${a.id}-${i.uid}-${e.name}`,class:h.CSS.label},[n,"unsupported"!==t?this._renderFieldInput(e):this._renderUnsupportedField(e),this._renderAuxiliaryText(e)])},r._renderFieldInput=function(e){const{dataType:t,domain:i,name:n,updating:a,value:s}=e,l=this.getCommonInputProps(e);if("coded-value"===i?.type){if(m.isFieldElementWithInputType(e.element,"switch")){const{element:t}=e;if(!(this._switchFieldsWithInitialIncompatibleValue.has(n)||null==s||t.input.onValue!==s&&t.input.offValue!==s))return this._renderSwitchFieldInput(e,l);this._switchFieldsWithInitialIncompatibleValue.add(n)}return"radio-buttons"===e.inputType?this._renderRadioButtonsFieldInput(e,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),l):this._renderSelectFieldInput(e,this._getFieldValueOptions(n,i),l)}if("datetime-picker"===e.inputType||"date"===t)return this._renderDateFieldInput(e,l);const r="number"===t?y.tsx("input",{type:"number",...l,value:null!=this._activeNumberFieldEdit&&this._activeNumberFieldEdit.fieldName===e.name?this._activeNumberFieldEdit.value:`${l.value}`}):"text-area"===e.inputType?y.tsx("textarea",{...l}):y.tsx("input",{type:"text",...l});return a?y.tsx("div",{key:`${l.key}-input-updating-wrapper`,class:h.CSS.fieldInputWrapper},r,y.tsx("div",{class:h.CSS.fieldInputLoader},y.tsx("calcite-progress",{type:"indeterminate"}))):r},r._renderDateFieldInput=function(e,t){const{dateDataType:i,includeTime:n,label:a,name:s,valid:l,value:r}=e,{readOnly:o,required:u}=t;if("string"===i)return this._renderUnsupportedField(e,m.formatDateFieldValue(e.field,t.value));const{date:d,time:c}=this._formatValueForDateInputs(r),p=null!=t.max?this._formatValueForDateInputs(t.max):void 0,_=null!=t.min?this._formatValueForDateInputs(t.min):void 0,f=p?.date??void 0,v=_?.date??void 0,b={afterCreate:this._afterDateInputCreate,afterUpdate:this._afterDateInputCreateOrUpdate,"aria-invalid":!l,label:a,numberingSystem:x,overlayPositioning:"fixed",readOnly:o,required:u,tabIndex:0,[R]:s};return y.tsx("div",{key:`${t.key}-date-time-container`,class:h.CSS.dateInputContainer},y.tsx("calcite-input-date-picker",{bind:this,...b,class:this.classes(t.class,h.CSS.inputDate),"data-date-part":"date",key:`${t.key}-date-input`,valueAsDate:d??void 0,maxAsDate:f,minAsDate:v,onCalciteInputDatePickerChange:e=>this._commitDateChanges(e.target),onblur:e=>this._commitDateChanges(e.target,!0)}),n?y.tsx("calcite-input-time-picker",{bind:this,...b,class:this.classes(t.class,h.CSS.inputTime),"data-date-part":"time",key:`${t.key}-time-input`,value:c??void 0,step:1,onCalciteInputTimePickerChange:e=>this._commitDateChanges(e.target),onfocus:e=>{e.target.calciteTimePickerEl&&(e.target.calciteTimePickerEl.showSecond=!0)},onblur:e=>this._commitDateChanges(e.target,!0)}):null)},r._renderUnsupportedField=function(e,t){const i=this.getCommonInputProps(e);return y.tsx("input",{afterCreate:i.afterCreate,afterUpdate:i.afterUpdate,class:this.classes(h.CSS.input,h.CSS.fieldInput,h.CSS.inputDisabled),onfocus:i.onfocus,readOnly:!0,tabIndex:i.tabIndex,type:"text",value:null!=t?`${t}`:i.value,[R]:i[R]})},r._renderSelectFieldInput=function(e,t,i){const{element:n,required:a,value:s}=e,{messages:l,messagesTemplates:r}=this,o=t.map((e=>e.map((e=>y.tsx("calcite-combobox-item",{value:`${e.value}`,textLabel:e.name,key:`#${e.value}`,selected:s===e.value}))))),[u,d]=o;this._registerIncompatibleValue(s,t.flat(),e,(e=>{d.unshift(y.tsx("calcite-combobox-item",{value:`${e}`,textLabel:`${e}`,key:"incompatible-option",readOnly:!0}))}));const c=d.length>0?[y.tsx("calcite-combobox-item-group",{key:"recommended",label:l.recommended},u),y.tsx("calcite-combobox-item-group",{key:"other",label:r.other},d)]:u,p=null==n,h=m.isFieldElementWithInputType(n,"combo-box"),_=p||h&&n.input?.showNoValueOption;if(!a&&_){const e="",t=h&&n.input.noValueOptionLabel||l.empty;c.unshift(y.tsx("calcite-combobox-item",{value:e,textLabel:l.empty,key:"empty-option"},t))}return y.tsx("calcite-combobox",{...i,selectionMode:"single",disabled:i.readOnly,allowCustomValues:!1,clearDisabled:!0,onCalciteComboboxChange:e=>this._handleOptionChange(e.target)},c)},r._registerIncompatibleValue=function(e,t,i,n){const a=this._fieldToInitialIncompatibleDomainValue,s=a.has(i.name);(s||null!=e&&""!==e&&!t.some((t=>t.value===e)))&&(s||a.set(i.name,e),n?.(e))},r._renderRadioButtonsFieldInput=function(e,t,i){const{element:n,name:a,required:s,value:l}=e,r=t.map((e=>this._renderRadioButton({key:e.name,label:e.name,name:a,value:e.value,selected:e.value===l,props:i})));this._registerIncompatibleValue(l,t,e);const o=null==n,u=m.isFieldElementWithInputType(n,"radio-buttons"),d=o||u&&n.input?.showNoValueOption;if(!s&&d){const e="",t=u&&n.input.noValueOptionLabel||this.messages.empty,s=l===e||null===l;r.unshift(this._renderRadioButton({key:"empty-option",label:t,name:a,value:e,selected:s,props:i}))}return y.tsx("div",{key:`${i.key}-radio`,class:h.CSS.inputRadioGroup},r)},r._renderSwitchFieldInput=function(e,t){const{value:i}=e,n=!!m.isFieldElementWithInputType(e.element,"switch")&&i===e.element.input.onValue;return y.tsx("calcite-switch",{...t,class:h.CSS.inputSwitch,onCalciteSwitchChange:e=>this._commitInputValue(e.target),checked:n,disabled:t.readOnly})},r._renderRadioButton=function({key:e,name:t,value:i,selected:n,label:a,props:s}){return y.tsx("label",{key:e,class:h.CSS.inputRadioLabel},y.tsx("input",{...s,class:h.CSS.inputRadio,name:t,type:"radio",value:i,checked:n,disabled:s.readOnly,onchange:e=>this._commitInputValue(e.target)}),a)},r._renderAuxiliaryText=function(e){const t=this._userUpdatedFieldInputNames.has(e.name)&&!e.valid?m.getErrorMessageForFieldInput(e,this.messages):null!=this.viewModel.contingencyConstraintViolations.get(e.name)?this.messages.validationErrors.valuesIncompatible:null!=e.valueExpressionExecutor&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return null!=t?y.tsx("calcite-input-message",{status:"invalid",icon:!0},t):this._renderDescriptionOrEmpty(e.description)},r._renderShowAllRelatedRecordsListItem=function(e){const{featureCount:t,relationshipId:i,showAllActionVisible:n}=e,{relatedRecordCallbacks:a}=this;if(!n||!a?.showAllRelatedRecords)return;const s=this.messages;return y.tsx("calcite-list-item",{description:w.substitute(s.totalCount,{count:t}),label:s.showAll,value:!0,onCalciteListItemSelect:()=>this._onShowAllRelatedRecordsClick(i)},y.tsx("calcite-icon",{slot:"content-end",scale:"s",icon:"list"}))},r._renderAddRelatedRecordButton=function(e){const{canAddRelatedFeature:t,relationshipId:i,relatedLayer:n}=e,{relatedRecordCallbacks:a}=this;if(t&&a?.addRelatedRecord&&n)return y.tsx("calcite-button",{alignment:"center",appearance:"outline-fill",class:h.CSS.centeredButton,disabled:e.updating,iconStart:"plus",key:`${i}-add-button`,round:!0,scale:"s",width:"half",onclick:()=>this._onAddRelatedRecordsClick(i,n)},this.messages.addRecord)},r._renderRelatedRecordListItem=function(e,t){const{feature:i,description:n,title:a}=e,{feature:s,relatedRecordCallbacks:l}=this,r=()=>{l?.editRelatedRecord&&s&&l.editRelatedRecord({parentFeature:s,relationshipId:t,relatedFeature:i})};return y.tsx("calcite-list-item",{bind:this,description:n,label:a,key:`${t}-${i.uid}`,value:a,onclick:r},y.tsx("calcite-icon",{slot:"content-start",scale:"m",icon:m.getIconForFeature(i)}),y.tsx("calcite-icon",{slot:"content-end",scale:"s",icon:"chevron-right"}))},r._renderRelationshipInput=function(e){if(!this._relatedRecordsEnabled||!e.editable)return;const{featureCount:t,relationshipId:i,showAllEnabled:n}=e,a=n?null:this._renderDescriptionOrEmpty(e.description),s=t>0?this._renderRelatedRecordsList(e):e.loaded?this._renderNoRelatedRecordsNotice():void 0;return y.tsx("label",{class:this.classes(h.CSS.label,h.CSS.relationshipLabel),key:`relationship-${i}-container`},y.tsx("div",null,this._renderRelatedRecordsHeaderContainer(e),a,s),this._renderAddRelatedRecordButton(e))},r._renderRelatedRecordsHeaderContainer=function(e){const t=e.updating||!e.loaded;return y.tsx("div",{class:h.CSS.relatedRecordsHeader,key:`relationship-${e.relationshipId}-header`},y.tsx("span",null,e.label),t?y.tsx("calcite-loader",{label:this.messagesCommon?.loading,inline:!0,key:"loader",scale:"s",type:"indeterminate"}):void 0)},r._renderRelatedRecordsList=function(e){const{relationshipId:t}=e;return y.tsx("calcite-list",{class:h.CSS.relatedRecordsList},e.relatedFeatureInfos.map((e=>this._renderRelatedRecordListItem(e,t))),this._renderShowAllRelatedRecordsListItem(e),this._renderObserverNode())},r._renderNoRelatedRecordsNotice=function(){return y.tsx("calcite-notice",{open:!0,scale:"s",kind:"brand",icon:"information",width:"full"},y.tsx("div",{slot:"message"},this.messagesFeature.noRelatedFeatures))},r._renderObserverNode=function(){if(this.viewModel.activeRelationshipInput?.showAllEnabled)return y.tsx("div",{key:"feature-observer",class:h.CSS.listObserver,bind:this,afterCreate:this._afterListObserverCreated,afterRemoved:this._afterListObserverRemoved})},r.getCommonInputProps=function(e){const{disabled:t,groupDisplay:i}=this,{dataType:n,editable:a,group:s,hint:l,label:r,maxLength:o,minLength:u,name:d,required:c,valid:p,value:m}=e,_=this._userUpdatedFieldInputNames.has(d),f=!a||t,v="all"===i&&null!=s&&"collapsed"===s.state;return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(h.CSS.input,h.CSS.fieldInput,f?h.CSS.inputDisabled:null,_&&!p?h.CSS.inputInvalid:null),key:d,label:r,minlength:u>-1?`${u}`:"",maxlength:o>-1?`${o}`:"",...e.range,readOnly:f,value:null==m?"":`${m}`,[R]:d,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===n?this._handleNumberInputMouseDown:void 0,placeholder:"number"===n||"text"===n?l??void 0:"",required:c,tabIndex:v?-1:0}},r._handleNumberInputMouseDown=function({target:e}){e.focus(),this.scheduleRender()},r._getFieldValueOptions=function(e,t){const i=t.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),n=this.viewModel.fieldsWithContingentValues.has(e)?this._getContingentValueOptions(e):[];if(n.length>0){const e=new Set(n.map((e=>e.value)));return[n,i.filter((t=>!e.has(t.value)))]}return[i,[]]},r._getContingentValueOptions=function(e){const t={};for(const a of this.viewModel.allFieldInputs){const{name:i,value:n}=a;null!=n&&i!==e&&this.viewModel.fieldsWithContingentValues.has(i)&&(t[i]=n)}const i=this.viewModel.joinedContingentValues.slice(),n=new Map;for(const a of i){const i=a.values[e];if(null==i||"code"!==i.objectType&&"null"!==i.objectType)continue;const{code:s,name:l}=i.codedValue&&"null"!==i.objectType?i.codedValue:{code:"",name:this.messages.empty};if(n.has(s))continue;Object.entries(t).every((([e,t])=>!a.values.hasOwnProperty(e)||this._valueIsValidContingentValue(t,a.values[e])))&&n.set(s,{name:l,value:s})}return[...n.values()]},r._getFieldInputFromHTMLElement=function(e){return this.viewModel.findField(e.getAttribute(R))},r._afterDateInputCreate=async function(e){this._afterDateInputCreateOrUpdate(e)},r._afterDateInputCreateOrUpdate=function(e){const{name:t}=this._getFieldInputFromHTMLElement(e),i=this._dateFieldInputMap.get(t),n=k(e);null!=i?n?i.date=e:i.time=e:this._dateFieldInputMap.set(t,{[n?"date":"time"]:e}),this._afterInputCreateOrUpdate(e)},r._afterInputCreateOrUpdate=function(e){const{viewModel:t}=this,i=this._getFieldInputFromHTMLElement(e),n=t.findField(this._activeInputName),a=this._fieldToInitialIncompatibleDomainValue.get(i.name)===i.value;this._fieldFocusNeeded&&n===i&&("radio-buttons"!==i.inputType||a||e.checked)&&(this._fieldFocusNeeded=!1,m.isInputInGroupInput(i)&&(i.group.state="expanded"),e.focus())},r._handleInputFocus=function(e){const t=e.target,i=this._getFieldInputFromHTMLElement(t);this._activeInputName=i.name,m.isNumberFieldInput(i)&&(this._activeNumberFieldEdit={fieldName:i.name,input:t,value:t.value})},r._handleInputBlur=function(e){const t=e.target,i=this._getFieldInputFromHTMLElement(t);"number"===i.dataType&&null!=this._activeNumberFieldEdit&&(this._activeNumberFieldEdit.input.value=`${i.value}`,this._activeNumberFieldEdit=null),this._commitInputValue(t),this.scheduleRender()},r._commitDateChanges=function(e,t=!1){const{name:i}=this._getFieldInputFromHTMLElement(e);if(!this._dateFieldInputMap.has(i))return;const n=this._dateFieldInputMap.get(i);if(!n||!n.date)return;const a=this._getFieldValueFromDateInput(e),s=this._getFieldValueFromDateInputs(n.date,n.time);this.viewModel.getValue(i)!==s&&(null!==a&&null!==s?this._updateFieldValue(i,s):t&&this._updateFieldValue(i,null))},r._commitInputValue=function(e){const t=this._getFieldInputFromHTMLElement(e);null!=this._activeNumberFieldEdit&&m.isNumberFieldInput(t)&&(this._activeNumberFieldEdit.value=e.value),this._updateFieldValue(t.name,this._parseValue(e))},r._handleInputKeyDown=function(e){const{key:t,altKey:i,ctrlKey:n,metaKey:a}=e,s=this._getFieldInputFromHTMLElement(e.target);if("Enter"===t)m.isInputInGroupInput(s)&&"collapsed"===s.group.state&&(s.group.state="expanded");else{const{type:l}=s.field,r="single"===l||"double"===l;if(("integer"===l||"small-integer"===l||r)&&(!i&&!n&&!a)&&1===t.length){const i=Number(t),n=["-","+"],a=["e","."],s=r?[...n,...a]:n;isNaN(i)&&!s.includes(t)&&e.preventDefault()}}},r._updateFieldValue=function(e,t){if(this.viewModel.setValue(e,t),this._userUpdatedFieldInputNames.add(e),this.viewModel.fieldsWithContingentValues.has(e)){const e=Object.fromEntries(Object.entries(this.getValues()).filter((([e,t])=>null!=t)));this.viewModel.validateContingencyConstraints(e)}},r._parseValue=function(e){const t=this._getFieldInputFromHTMLElement(e),i=e.value;if(m.isFieldElementWithInputType(t.element,"switch")&&"CALCITE-COMBOBOX"!==e.tagName)return e.checked?t.element.input.onValue:t.element.input.offValue;if("radio-buttons"===t.inputType&&"radio"===e.type&&!e.checked)return t.value;const{dataType:n}=t;return"number"===n?i?parseFloat(i):null:i},r._handleOptionChange=function(e){this._commitInputValue(e),this.scheduleRender()},r._handleGroupClick=function(e){const t=e.currentTarget["data-group"],i="expanded"===t.state,n="sequential"===this.groupDisplay,a=`.${h.CSS.groupHeader}`;if(!(i&&!e.target.closest(a))){if(this._activeInputName=this._getFocusableInput("forward",t)?.name||"",n){const n=e.target.closest(a);if(i&&!n)return;this.viewModel.inputs.forEach((e=>{m.isGroupInput(e)&&e!==t&&(e.state="collapsed")}))}t.state=i?"collapsed":"expanded",this._fieldFocusNeeded=n,this.scheduleRender()}},r._handleSubmit=function(e){e.preventDefault()},r._handleFormKeyDown=function(e){"Enter"===e.key&&this.viewModel.submit()},r._getDefaultLocaleOptions=function(){return{locale:C.getLocale(),numberingSystem:x}},r._getFieldValueFromDateInputs=function(e,t){const i=this._getDateTimeFromInput(e),n=this._getDateTimeFromInput(t);if(!i&&!n)return null;const a=this._getFieldInputFromHTMLElement(e).range,s=Date.now(),l=null!=a.max&&a.max<s?a.max:s,r=F.DateTime.fromMillis(l,this._getDefaultLocaleOptions()),o=i||r,{year:u,month:d,day:c}=o,{hour:p,minute:h,second:m}=n||r,_=o.set({year:u,month:d,day:c,hour:p,minute:h,second:m});return _.isValid?_.toMillis():null},r._getDateTimeFromInput=function(e){if(!e)return null;let t=null;if(k(e)){const i=e.valueAsDate;if(!i||Array.isArray(i))return null;t=F.DateTime.fromJSDate(i)}else{if(!e.value)return null;t=F.DateTime.fromFormat(e.value,S,this._getDefaultLocaleOptions())}return t??null},r._getFieldValueFromDateInput=function(e){return this._dateTimeToFieldValue(this._getDateTimeFromInput(e))},r._dateTimeToFieldValue=function(e){return e?.isValid?e.toMillis():null},r._dateTimeFromFieldValue=function(e){return null===e?null:F.DateTime.fromMillis(e,this._getDefaultLocaleOptions())},r._formatValueForDateInputs=function(e){if(null==e||isNaN(e))return{date:null,time:null};const t=this._dateTimeFromFieldValue(e);return t?{date:t.toJSDate(),time:t.toFormat(S,this._getDefaultLocaleOptions())}:{date:null,time:null}},r._valueIsValidContingentValue=function(e,t){switch(t.objectType){case"any":return!0;case"null":return null==e;case"code":return e===t.codedValue?.code;case"range":return null!=e&&null!=t.minValue&&null!=t.maxValue&&+e>=t.minValue&&+e<=t.maxValue;default:return s.neverReached(t.objectType),!1}},r._afterListObserverCreated=function(e){this.viewModel.activeRelationshipInput&&(this._listObserverNode=e)},r._afterListObserverRemoved=function(){this._listObserverNode=null},r._onObserverChange=async function(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode);const e=this.viewModel.activeRelationshipInput;if(!e)return;const{showAllEnabled:t,updating:i}=e;this._listObserverNode&&!i&&t&&this._listObserver.observe(this._listObserverNode)},r._incrementRelatedRecordPage=function(){const e=this.viewModel.activeRelationshipInput;e?.incrementPage()},t._createClass(n,[{key:"_relatedRecordsEnabled",get:function(){const e=this.relatedRecordCallbacks;return!(!e||!(e.addRelatedRecord||e.editRelatedRecord||e.showAllRelatedRecords))}},{key:"disabled",get:function(){return this.viewModel.disabled},set:function(e){this.viewModel.disabled=e}},{key:"feature",get:function(){return this.viewModel.feature},set:function(e){this.viewModel.feature=e}},{key:"formTemplate",get:function(){return this.viewModel.formTemplate},set:function(e){this.viewModel.formTemplate=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"layer",get:function(){return this.viewModel.layer},set:function(e){this.viewModel.layer=e}},{key:"map",get:function(){return this.viewModel.map},set:function(e){this.viewModel.map=e}},{key:"relatedRecordCallbacks",get:function(){return this.viewModel.relatedRecordCallbacks},set:function(e){this.viewModel.relatedRecordCallbacks=e}},{key:"relationshipId",get:function(){return this.viewModel.relationshipId},set:function(e){this.viewModel.relationshipId=e}},{key:"spatialReference",get:function(){return this.viewModel.spatialReference},set:function(e){this.viewModel.spatialReference=e}},{key:"strict",get:function(){return this.viewModel.strict},set:function(e){this.viewModel.strict=e}},{key:"view",get:function(){return l.deprecatedProperty(D,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view},set:function(e){l.deprecatedProperty(D,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view=e}}]),n}(p);i.__decorate([u.property()],M.prototype,"_listObserverNode",void 0),i.__decorate([u.property()],M.prototype,"_relatedRecordsEnabled",null),i.__decorate([u.property()],M.prototype,"disabled",null),i.__decorate([u.property()],M.prototype,"feature",null),i.__decorate([u.property()],M.prototype,"formTemplate",null),i.__decorate([u.property()],M.prototype,"groupDisplay",void 0),i.__decorate([u.property()],M.prototype,"headingLevel",void 0),i.__decorate([u.property()],M.prototype,"label",null),i.__decorate([u.property()],M.prototype,"layer",null),i.__decorate([u.property()],M.prototype,"map",null),i.__decorate([u.property(),g.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],M.prototype,"messages",void 0),i.__decorate([u.property(),g.messageBundle("esri/t9n/common")],M.prototype,"messagesCommon",void 0),i.__decorate([u.property(),g.messageBundle("esri/widgets/Feature/t9n/Feature")],M.prototype,"messagesFeature",void 0),i.__decorate([u.property(),g.messageBundle("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],M.prototype,"messagesTemplates",void 0),i.__decorate([u.property()],M.prototype,"relatedRecordCallbacks",null),i.__decorate([u.property()],M.prototype,"relationshipId",null),i.__decorate([u.property()],M.prototype,"spatialReference",null),i.__decorate([u.property()],M.prototype,"strict",null),i.__decorate([u.property()],M.prototype,"view",null),i.__decorate([u.property(),I.vmEvent(["value-change","submit"])],M.prototype,"viewModel",void 0),M=i.__decorate([c.subclass(T)],M);return M}));
