/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../TimeExtent","../../TimeInterval","../../core/Collection","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/timeUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../webdoc/Widgets","../../webdoc/widgets/TimeSlider"],(function(t,e,n,i,l,r,o,s,a,u,m,c,p,d,h,f,_,y,w,g){"use strict";const T=1e4;function v(t){return null!=t&&void 0!==t.count}function x(t){return null!=t&&void 0!==t.interval}function E(t){return null!=t&&void 0!==t.dates}function b(t){return null!=t&&"object"==typeof t&&"declaredClass"in t&&"esri.WebMap"===t.declaredClass}let C=function(n){function l(t){var e;return(e=n.call(this,t)||this)._animationController=null,e._isViewTimeExtentInitialized=!1,e._timerId=null,e.actions=new r,e.fullTimeExtent=null,e.loop=!1,e.mode="time-window",e.stops={count:10},e.timeExtent=null,e.view=null,e}e._inherits(l,n);var o=l.prototype;return o.initialize=function(){this.handles.add([c.watch((()=>this.effectiveStops),(()=>{null==this.timeExtent&&(this.timeExtent=this._getDefaultTimeExtent())}),c.initial),c.watch((()=>this.view),((t,e)=>{this._unregisterWidget(e),this._registerWidget(t)}),c.syncAndInitial),c.watch((()=>this.timeExtent),(t=>{if(null==this.view)return;const e=this.view.timeExtent;(null!=t&&!t.isAllTime||null!=e&&!e.isAllTime)&&(null!=t&&null!=e&&t.equals(e)||(this.view.timeExtent=t))}),c.initial),c.watch((()=>u.applySome(this.view,(t=>t.timeExtent))),(t=>{this._isViewTimeExtentInitialized?(null!=t&&!t.isAllTime||null!=this.timeExtent&&!this.timeExtent.isAllTime)&&(null!=t&&null!=this.timeExtent&&t.equals(this.timeExtent)||(this.timeExtent=t)):this._isViewTimeExtentInitialized=!0}))])},o.destroy=function(){null!=this._timerId&&(clearInterval(this._timerId),this._timerId=null),this._unregisterWidget(this.view),this.view=null,null!=this._animationController&&(this._animationController.abort(),this._animationController=null)},l.getPropertiesFromWebMap=async function(e,n){if(null==e||!b(e))return null;await e.load({signal:n});const i=e?.widgets?.timeSlider;if(!i)return null;const{getFullTimeExtentFromWebDocument:l,getModeFromTimeSlider:r,getStopsFromTimeSlider:o,getTimeExtentFromTimeSlider:s}=await new Promise(((e,n)=>t(["./utils"],e,n))),a=await l(e,n),u=i.loop,m=r(i);return{fullTimeExtent:a,loop:u,mode:m,playRate:i.stopDelay??2e3,stops:o(i),timeExtent:s(i,m)}},o.next=function(){this._step({forward:!0,allowRestart:!1})},o.play=function(){this._startAnimation()},o.previous=function(){this._step({forward:!1,allowRestart:!1})},o.stop=function(){this._stopAnimation()},o.triggerAction=function(t){this.emit("trigger-action",{action:t})},o.updateWebDocument=function(t){if(b(t)){const e=new g({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:v(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:x(this.stops)?this.stops.interval:null,stops:E(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new w({timeSlider:e})}},o.valuesToTimeExtent=function(t){if(null==t)return null;const e=t.sort(((t,e)=>t-e)).map((t=>new Date(t))),n=e.length>0?e[0]:null,l=e.length>1?e[1]:null;switch(this.mode){case"time-window":return new i({start:n,end:l});case"instant":return new i({start:n,end:n});case"cumulative-from-start":return new i({start:null,end:n});case"cumulative-from-end":return new i({start:n,end:null});default:return i.allTime}},o._animate=async function(){try{const t=this.view,e=u.applySome(this._animationController,(t=>t.signal));await Promise.all([m.after(this.playRate,null,e),null!=t&&c.whenOnce((()=>!1===t.updating),e)])}catch(t){return m.isAbortError(t)||a.getLogger(this).error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),null!=this._animationController&&this._animate()},o._divideTimeExtentByCount=function(t,e=10){if(!t||!e)return[];const{start:n,end:i}=t;if(null==n||null==i)return[];if(e>T)return this._divideTimeExtentByCount(t);const l=[],r=n.getTime(),o=i.getTime()-r;for(let s=0;s<=e;s++)l.push(new Date(r+s/e*o));return l},o._divideTimeExtentByInterval=function(t,e,n=T){if(!t||!e)return[];const{start:i,end:l}=t;if(null==i||null==l)return[];const r=l.getTime()-i.getTime(),o=e.toMilliseconds();if(o<=0||r/o>n)return this._divideTimeExtentByCount(t);const s=[],{value:a,unit:u}=e;let m=i;for(;m.getTime()<=l.getTime();)s.push(new Date(m.getTime())),m=p.offsetDate(m,a,u);return s},o._getDefaultTimeExtent=function(){const{effectiveStops:t,mode:e}=this;if(null==t||!e)return null;switch(e){case"time-window":return t.length>1?new i({start:t[0],end:t[1]}):null;case"cumulative-from-start":return t.length>0?new i({start:null,end:t[0]}):null;case"cumulative-from-end":return t.length>0?new i({start:t[0],end:null}):null;case"instant":return t.length>0?new i({start:t[0],end:t[0]}):null;default:return null}},o._registerWidget=function(t){if(null!=t){t.persistableViewModels.includes(this)||t.persistableViewModels.add(this)}},o._startAnimation=function(){this._stopAnimation(),this._animationController=new AbortController,this._step({forward:!0,allowRestart:!0}),this._animate()},o._step=function(t){const{forward:e,allowRestart:n}=t,{effectiveStops:i}=this;if(null==this.timeExtentValues||null==i)return;const l=i.map((t=>t.getTime())),r=this.timeExtentValues.map((t=>{const e=l.indexOf(t);if(-1!==e)return e;const n=l.reduce(((e,n)=>Math.abs(n-t)<Math.abs(e-t)?n:e));return l.indexOf(n)})),o=r.map((t=>t+(e?1:-1))),s=o.some((t=>t<0||t>l.length-1)),{loop:a,state:u}=this;if(s)if(a||n){const t=Math.min(...r),n=Math.max(...r),i=(e?r.map((e=>e-t)):r.map((t=>t+(l.length-1-n)))).map((t=>l[t]));this.timeExtent=this.valuesToTimeExtent(i)}else"playing"===u&&this.stop();else{const t=o.map((t=>l[t]));this.timeExtent=this.valuesToTimeExtent(t)}},o._stopAnimation=function(){null!=this._animationController&&(this._animationController.abort(),this._animationController=null)},o._unregisterWidget=function(t){null!=t&&t.persistableViewModels.remove(this)},e._createClass(l,[{key:"effectiveStops",get:function(){const{fullTimeExtent:t,stops:e}=this;if(E(e)){const{dates:n}=e;if(null==n||0===n.length)return null;const i=n.sort(((t,e)=>t.getTime()-e.getTime()));if(null==t)return i;const{start:l,end:r}=t;if(null==l||null==r)return i;return i.filter((t=>!(t.getTime()<l.getTime()||t.getTime()>r.getTime())))}if(v(e)){const n=e.timeExtent??t;return this._divideTimeExtentByCount(n,e.count)}if(x(e)){const n=e.timeExtent??t;return this._divideTimeExtentByInterval(n,e.interval)}return[]}},{key:"playRate",set:function(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._set("playRate",t))}},{key:"state",get:function(){return null==this.fullTimeExtent?"disabled":null!=this._animationController?"playing":"ready"}},{key:"timeExtentValues",get:function(){const{mode:t,timeExtent:e}=this;if(null==e||e.isAllTime||e.isEmpty)return null;const{start:n,end:i}=e;switch(t){case"cumulative-from-end":case"instant":return null!=n?[n.getTime()]:null;case"cumulative-from-start":return null!=i?[i.getTime()]:null;case"time-window":return null!=n&&null!=i?[n.getTime(),i.getTime()]:null}}}]),l}(s.HandleOwnerMixin(o.EventedAccessor));n.__decorate([d.property()],C.prototype,"_animationController",void 0),n.__decorate([d.property({type:r})],C.prototype,"actions",void 0),n.__decorate([d.property({readOnly:!0})],C.prototype,"effectiveStops",null),n.__decorate([d.property({type:i})],C.prototype,"fullTimeExtent",void 0),n.__decorate([d.property({nonNullable:!0})],C.prototype,"loop",void 0),n.__decorate([d.property({nonNullable:!0})],C.prototype,"mode",void 0),n.__decorate([d.property({nonNullable:!0,value:1e3})],C.prototype,"playRate",null),n.__decorate([d.property({readOnly:!0})],C.prototype,"state",null),n.__decorate([d.property({cast:t=>null==t?null:(x(t)&&(t.interval=h.ensureType(l,t.interval)),(x(t)||v(t))&&(t.timeExtent=h.ensureType(i,t.timeExtent)),t)})],C.prototype,"stops",void 0),n.__decorate([d.property({type:i})],C.prototype,"timeExtent",void 0),n.__decorate([d.property({readOnly:!0})],C.prototype,"timeExtentValues",null),n.__decorate([d.property()],C.prototype,"view",void 0),n.__decorate([d.property()],C.prototype,"next",null),n.__decorate([d.property()],C.prototype,"play",null),n.__decorate([d.property()],C.prototype,"previous",null),n.__decorate([d.property()],C.prototype,"stop",null),n.__decorate([d.property()],C.prototype,"updateWebDocument",null),C=n.__decorate([y.subclass("esri.widgets.TimeSlider.TimeSliderViewModel")],C);return C}));
