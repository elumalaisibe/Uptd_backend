/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../portal/Portal","../../Widget","../../support/componentsUtils","../../support/widgetUtils","../../support/decorators/messageBundle","../../support/jsxFactory"],(function(e,t,s,r,a,o,i,l,n,c,u,p,d,h,m,_){"use strict";const g="esri-save-layer",y={panel:`${g}`,error:`${g}__error`,errorIcon:`${g}__error-icon`,errorLabel:`${g}__error-label`,layerNameLabel:`${g}__layer-name-label`,portalFolderLabel:`${g}__portal-folder-label`,processLabel:`${g}__process-label`,processLoader:`${g}__process-loader`};t.SaveLayer=function(t){function r(e,s){var r;return(r=t.call(this,e,s)||this)._folders=null,r._layer=null,r._layerNameInput=null,r._portalFolderCombobox=null,r._userName=null,r.messages=null,r.messagesCommon=null,r.messagesIdentity=null,r.opened=!1,r.state="initialized",r.close=()=>{r.opened=!1,r.state="initialized"},r}s._inherits(r,t);var o=r.prototype;return o.loadDependencies=function(){return d.loadCalciteComponents({button:()=>new Promise(((t,s)=>e(["../../../chunks/calcite-button"],t,s))),combobox:()=>new Promise(((t,s)=>e(["../../../chunks/calcite-combobox"],t,s))),"combobox-item":()=>new Promise(((t,s)=>e(["../../../chunks/calcite-combobox-item"],t,s))),icon:()=>new Promise(((t,s)=>e(["../../../chunks/calcite-icon"],t,s))),input:()=>new Promise(((t,s)=>e(["../../../chunks/calcite-input"],t,s))),label:()=>new Promise(((t,s)=>e(["../../../chunks/calcite-label"],t,s))),loader:()=>new Promise(((t,s)=>e(["../../../chunks/calcite-loader"],t,s))),panel:()=>new Promise(((t,s)=>e(["../../../chunks/calcite-panel"],t,s)))})},o.open=async function(e){this.state="initialized",this.opened=!0,this._layer=e,this.state="connect-to-portal";const t=u.getDefault();try{await t.signIn()}catch(r){return void(a.isAbortError(r)||"identity-manager:user-aborted"===r.name?this.close():this.state="connect-to-portal-error")}this.state="fetch-portal-information";const{user:s}=t;this._userName=s?.username;try{this._folders=await(s?.fetchFolders())}catch{return void(this.state="fetch-portal-information-error")}this.state="save-layer"},o.render=function(){switch(this.state){case"initialized":return this._renderInitialized();case"connect-to-portal":return this._renderProcess(this.messagesIdentity.lblSigning);case"connect-to-portal-error":return this._renderError(this.messages.errors.authenticating);case"fetch-portal-information":return this._renderProcess(this.messages.processing.fetching);case"fetch-portal-information-error":return this._renderError(this.messages.errors.fetching);case"save-layer":return this._renderSaveLayer();case"saving":return this._renderProcess(this.messages.processing.saving);case"saving-error":return this._renderError(this.messages.errors.saving)}},o._renderError=function(e){return _.tsx("calcite-panel",{class:y.panel,heading:this.messages.widgetLabel,key:`${g}-error-panel`},_.tsx("div",{class:y.error},_.tsx("calcite-icon",{class:y.errorIcon,icon:"exclamation-mark-triangle",scale:"l",textLabel:this.messagesCommon.errorMessage}),_.tsx("calcite-label",{class:y.errorLabel},e)),_.tsx("calcite-button",{appearance:"outline",onclick:this.close,slot:"footer-actions",width:"half"},this.messagesCommon.close))},o._renderInitialized=function(){return _.tsx("calcite-panel",{class:y.panel,heading:this.messages.widgetLabel,key:`${g}-initialize-panel`})},o._renderProcess=function(e){return _.tsx("calcite-panel",{class:y.panel,heading:this.messages.widgetLabel,key:`${g}-process-panel`},_.tsx("calcite-loader",{class:y.processLoader,label:e}),_.tsx("calcite-label",{class:y.processLabel,alignment:"center"},e))},o._renderSaveLayer=function(){if(null==this._layer||null==this._folders||null==this._userName)return this._renderInitialized();const{stops:e}=this._layer,t=`${e.at(0).name} - ${e.at(-1).name}`,s=this._folders.map((e=>_.tsx("calcite-combobox-item",{key:`${g}-folder-${e.id}`,textLabel:e.title??"",value:e.id})));return s.unshift(_.tsx("calcite-combobox-item",{key:`${g}-folder-home`,selected:!0,textLabel:`${this._userName} (${this.messagesCommon.home})`,value:null})),_.tsx("calcite-panel",{class:y.panel,heading:this.messages.widgetLabel,key:`${g}-save-panel`},_.tsx("calcite-label",{class:y.layerNameLabel},this.messages.laverName,_.tsx("calcite-input",{afterCreate:e=>{this._layerNameInput=e},label:this.messages.laverName,value:t})),_.tsx("calcite-label",{class:y.portalFolderLabel},this.messages.saveInFolder,_.tsx("calcite-combobox",{afterCreate:e=>{this._portalFolderCombobox=e},label:this.messages.saveInFolder,overlayPositioning:"fixed",selectionMode:"single"},s)),_.tsx("calcite-button",{onclick:()=>this._saveButtonClick(),slot:"footer-actions",width:"half"},this.messagesCommon.save),_.tsx("calcite-button",{appearance:"outline",onclick:()=>{this.close()},slot:"footer-actions",width:"half"},this.messagesCommon.cancel))},o._saveButtonClick=function(){this.state="saving",this._saveLayer().then((()=>{this.close()})).catch((()=>{this.state="saving-error"}))},o._saveLayer=async function(){if(null==this._layer||null==this._folders)return;const e=this._layerNameInput?.value,t=this._portalFolderCombobox?.value,s=this._folders.find((e=>e.id===t));await this._layer.saveAs({title:e},{folder:s})},s._createClass(r,[{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}}]),r}(p),r.__decorate([o.property()],t.SaveLayer.prototype,"label",null),r.__decorate([o.property(),m.messageBundle("esri/widgets/support/t9n/SaveLayer")],t.SaveLayer.prototype,"messages",void 0),r.__decorate([o.property(),m.messageBundle("esri/t9n/common")],t.SaveLayer.prototype,"messagesCommon",void 0),r.__decorate([o.property(),m.messageBundle("esri/identity/t9n/identity")],t.SaveLayer.prototype,"messagesIdentity",void 0),r.__decorate([o.property()],t.SaveLayer.prototype,"opened",void 0),r.__decorate([o.property()],t.SaveLayer.prototype,"state",void 0),t.SaveLayer=r.__decorate([c.subclass("esri.widgets.Directions.SaveLayer")],t.SaveLayer),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
