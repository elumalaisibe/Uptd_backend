/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/Collection","../../core/Error","../../core/HandleOwner","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../layers/support/layerUtils","../../rest/networks/support/ValidateNetworkTopologyParameters","../../intl/locale","../../intl/messages"],(function(e,t,i,r,o,s,a,n,l,d,c,y,p,h,u,w,_,A,k){"use strict";const g={noDirtyAreasInExtent:-2147208940,noUtilityNetworkExtension:-2147208474,cannotAcquireVersionLock_v10:-2147217146,cannotAcquireVersionLock_v11:-2147220947};let x=function(t){function i(e){var i;return(i=t.call(this,e)||this)._activeOperationDidSucceed=!1,i._initialValidationsFinished=!1,i._dirtyAreasLayer=null,i._noViewPropertyErrorMessage="Property 'view' is missing on UtilityNetworkValidateTopologyViewModel.",i._validView=!1,i.executionError="",i.extentToValidate="current",i.loadErrors=new o,i}e._inherits(i,t);var r=i.prototype;return r.initialize=function(){const e=async()=>{this.messages||(this.messages=await k.fetchMessageBundle("esri/widgets/UtilityNetworkValidateTopology/t9n/UtilityNetworkValidateTopology"))};e().then((()=>{this.view||(this.view=null),this.utilityNetwork||(this.utilityNetwork=null),this.addHandles([l.watch((()=>[this.view,this.utilityNetwork]),(async()=>{const{loadErrors:e,messages:t}=this,i=t.info;if(this._initialValidationsFinished=!1,e.removeAll(),this._validView=!0,this._dirtyAreasLayer=null,this.view&&"2d"===this.view.type||(this._validView=!1,n.getLogger(this).error(new s("validateNetworkTopology:missing-property",this._noViewPropertyErrorMessage))),this.utilityNetwork&&"utility"===this.utilityNetwork.type){this.utilityNetwork.loaded||await this.utilityNetwork.load(),await this._checkUtilityNetworkExtension();const t=1===e.length&&this.loadErrors.find((e=>e===i.noUtilityNetworkServiceUserTypeExtension));e.length&&!t||this._setDirtyAreasLayer(),this._validView&&(this._initialValidationsFinished=!0)}else this.loadErrors.push(i.noUtilityNetwork)}),{initial:!0}),l.on((()=>this.view?.map?.layers),"change",(()=>{const{loadErrors:e,messages:t}=this,i=t.info,r=e.find((e=>e===i.noUtilityNetwork)),o=e.find((e=>e===i.noUtilityNetworkServiceUserTypeExtension));this._initialValidationsFinished=!1,r||(e.removeAll(),o&&e.push(i.noUtilityNetworkServiceUserTypeExtension),this._setDirtyAreasLayer()),this._validView&&(this._initialValidationsFinished=!0)})),A.onLocaleChange(e)])}))},r.validateTopology=async function(){const{messages:e,utilityNetwork:t,view:i}=this;if(!this.loadErrors.length){let r;this._activeOperationDidSucceed=!1,this._set("executionError",""),r="current"===this.extentToValidate?{xmin:i?.extent.xmin,ymin:i?.extent.ymin,xmax:i?.extent.xmax,ymax:i?.extent.ymax,spatialReference:{wkid:i?.spatialReference.wkid,latestWkid:i?.spatialReference.latestWkid}}:{xmin:t?.fullExtent?.xmin,ymin:t?.fullExtent?.ymin,xmax:t?.fullExtent?.xmax,ymax:t?.fullExtent?.ymax,spatialReference:{wkid:t?.spatialReference.wkid,latestWkid:t?.spatialReference.latestWkid}},this.updatingHandles.addPromise(t?.validateTopology(new _({gdbVersion:this._dirtyAreasLayer.gdbVersion,validateArea:new u(r)})).then((()=>{this._activeOperationDidSucceed=!0}),(t=>{let i="Error: "+t;t instanceof s&&t.details&&t.details.raw&&(t.details.raw.extendedCode===g.noDirtyAreasInExtent?i=e.info.noDirtyAreasInExtent:t.details.raw.extendedCode!==g.cannotAcquireVersionLock_v10&&t.details.raw.extendedCode!==g.cannotAcquireVersionLock_v11||(i=e.info.cannotAcquireVersionLock)),this._set("executionError",i)})))}},r._setDirtyAreasLayer=function(){const e=this.view?.map.layers;if(e){const t=e.items.filter((e=>w.isFeatureLayer(e))).find((e=>e.parsedUrl?.path===this.utilityNetwork?.networkSystemLayers.dirtyAreasLayerUrl));t?this._dirtyAreasLayer=t:this.loadErrors.push(this.messages.info.noDirtyAreasLayer)}},r._checkUtilityNetworkExtension=async function(){await(this.utilityNetwork?.queryNamedTraceConfigurations({globalIds:["{AAAAAAAA-AAAA-AAAA-AAAA-AAAAAAAAAAAA}"]}).catch((e=>{e.details.raw.extendedCode===g.noUtilityNetworkExtension?this.loadErrors.push(this.messages.info.noUtilityNetworkServiceUserTypeExtension):this.loadErrors.push(e.message)})))},e._createClass(i,[{key:"state",get:function(){return this.loadErrors.length?"disabled":this.executionError?"failed":this.updatingHandles.updating?"executing":this._activeOperationDidSucceed?"success":this._initialValidationsFinished?"ready":"loading"}},{key:"utilityNetwork",set:function(e){this._get("utilityNetwork")!==e&&this._set("utilityNetwork",e)}},{key:"view",set:function(e){this._get("view")!==e&&this._set("view",e)}}]),i}(a.HandleOwnerMixin(r));t.__decorate([d.property()],x.prototype,"_initialValidationsFinished",void 0),t.__decorate([d.property()],x.prototype,"_dirtyAreasLayer",void 0),t.__decorate([d.property({readOnly:!0})],x.prototype,"executionError",void 0),t.__decorate([d.property()],x.prototype,"extentToValidate",void 0),t.__decorate([d.property()],x.prototype,"loadErrors",void 0),t.__decorate([d.property()],x.prototype,"messages",void 0),t.__decorate([d.property({readOnly:!0})],x.prototype,"state",null),t.__decorate([d.property()],x.prototype,"utilityNetwork",null),t.__decorate([d.property()],x.prototype,"view",null),x=t.__decorate([h.subclass("esri.widgets.UtilityNetworkValidateTopology.UtilityNetworkValidateTopologyViewModel")],x);return x}));
