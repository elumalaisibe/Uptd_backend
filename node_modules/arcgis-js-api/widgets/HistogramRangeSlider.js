/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../Color","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Histogram","./Slider","./Widget","./HistogramRangeSlider/HistogramRangeSliderViewModel","./smartMapping/support/utils","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,i,r,n,a,o,s,l,d,u,c,h,p,g,_,m){"use strict";const y="esri-histogram-range-slider",v={base:y,sliderContainer:`${y}__slider-container`,histogramContainer:`${y}__histogram-container`,rangeTypePrefix:`${y}__range-type--`,esriWidget:"esri-widget",widgetIcon:"esri-icon-edit",disabled:"esri-disabled"};let b=function(t){function n(e,r){var n;return(n=t.call(this,e,r)||this)._barElements=[],n._histogram=null,n._slider=null,n.barCreatedFunction=null,n.dataLines=null,n.dataLineCreatedFunction=null,n.excludedBarColor=new i("#d7e5f0"),n.includedBarColor=new i("#599dd4"),n.messages=null,n.standardDeviationCount=1,n.viewModel=new h,n}e._inherits(n,t);var a=n.prototype;return a.initialize=function(){const{average:e,bins:t,hasTimeData:i,max:n,min:a,viewModel:o}=this;this._updateBarFill=this._updateBarFill.bind(this),this._histogram=new d({average:e,bins:t,barCreatedFunction:(e,t)=>{0===e&&(this._barElements=[]),this._barElements.push(t),this._updateBarFill(e,t),this.barCreatedFunction&&this.barCreatedFunction(e,t)},dataLines:this._getDataLines(),dataLineCreatedFunction:(e,t)=>{this.dataLineCreatedFunction&&this.dataLineCreatedFunction(e,t)},labelFormatFunction:this.labelFormatFunction,layout:"horizontal",max:n,min:a}),this._slider=new u({labelFormatFunction:this.labelFormatFunction,layout:"horizontal",visibleElements:{labels:!0,rangeLabels:!0},rangeLabelInputsEnabled:!i,viewModel:o}),this.addHandles([this._slider.on(["max-change","min-change"],(e=>this.emit(e.type,e))),this._slider.on(["segment-drag","thumb-change","thumb-drag"],(e=>{this._updateBarFills(),this.emit(e.type,e)})),r.watch((()=>this.bins),(e=>{if(e&&this._histogram.bins){const t=this._histogram.bins.length-e.length;this._barElements.splice(-t,t)}else this._barElements=[];this._histogram.set({bins:e}),this._updateBarFills(),this.scheduleRender()})),r.watch((()=>[this.max,this.min,this.rangeType,this.values]),(([e,t])=>{this._histogram.set({max:e,min:t}),this._updateBarFills(),this.scheduleRender()})),r.watch((()=>[this.average,this.dataLines,this.standardDeviation,this.standardDeviationCount]),(([e])=>{this._histogram.set({average:e,dataLines:this._getDataLines()})})),r.watch((()=>this.labelFormatFunction),(e=>{this._histogram.set({labelFormatFunction:e})})),r.watch((()=>this.hasTimeData),(e=>{this._slider.set({rangeLabelInputsEnabled:!e})}))])},a.generateWhereClause=function(e){return this.viewModel.generateWhereClause(e)},a.render=function(){const{rangeType:e,viewModel:t,label:i}=this,r=this.classes(v.base,v.esriWidget,`${v.rangeTypePrefix}${e}`,"disabled"===t.state?v.disabled:null);return m.tsx("div",{"aria-label":i,class:r},"disabled"===t.state?null:this.renderContent())},a.renderContent=function(){return[this.renderHistogram(),this.renderSlider()]},a.renderSlider=function(){return m.tsx("div",{key:`${this.id}-slider-container`,class:v.sliderContainer},this._slider.render())},a.renderHistogram=function(){return m.tsx("div",{class:v.histogramContainer},this._histogram.render())},a._getDataLines=function(){return[...this._getStandardDeviationDataLines(),...this.dataLines||[]]},a._getStandardDeviationDataLines=function(){const{average:e,standardDeviation:t,standardDeviationCount:i}=this;return p.getDeviationValues(t,e,i).map((e=>({value:e})))},a._updateBarFills=function(){this._barElements.forEach(((e,t)=>this._updateBarFill(t,e)))},a._updateBarFill=function(e,t){t.setAttribute("fill",this._getFillForBar(e)?.toHex()??"")},a._getFillForBar=function(e){const{bins:t,rangeType:i,values:r}=this;if(-1===e||!t?.length||!i||!r?.length)return null;const n=t[e];if(!n)return null;const{maxValue:a,minValue:o}=n,s=a-o,l=r[0]>o&&r[0]<a;switch(i){case"equal":case"not-equal":return this.includedBarColor;case"less-than":case"at-most":return l?this._getBlendedColor((r[0]-o)/s):a<=r[0]?this.includedBarColor:this.excludedBarColor;case"greater-than":case"at-least":return l?this._getBlendedColor(1-(r[0]-o)/s):o>=r[0]?this.includedBarColor:this.excludedBarColor;case"between":if(2===r.length)return r[0]>o&&r[0]<a?this._getBlendedColor(1-(r[0]-o)/s):r[1]>o&&r[1]<a?this._getBlendedColor((r[1]-o)/s):o>=r[0]&&a<=r[1]?this.includedBarColor:this.excludedBarColor;break;case"not-between":if(2===r.length)return r[0]>o&&r[0]<a?this._getBlendedColor((r[0]-o)/s):r[1]>o&&r[1]<a?this._getBlendedColor(1-(r[1]-o)/s):o>r[0]&&a<r[1]?this.excludedBarColor:this.includedBarColor}return this.includedBarColor},a._getBlendedColor=function(e){return i.blendColors(this.excludedBarColor,this.includedBarColor,e)},e._createClass(n,[{key:"average",get:function(){return this.viewModel.average},set:function(e){this.viewModel.average=e}},{key:"bins",get:function(){return this.viewModel.bins},set:function(e){this.viewModel.bins=e}},{key:"hasTimeData",get:function(){return this.viewModel.hasTimeData},set:function(e){this.viewModel.hasTimeData=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"labelFormatFunction",get:function(){return this.viewModel.labelFormatFunction},set:function(e){this.viewModel.labelFormatFunction=e}},{key:"max",get:function(){return this.viewModel.max},set:function(e){this.viewModel.max=e}},{key:"min",get:function(){return this.viewModel.min},set:function(e){this.viewModel.min=e}},{key:"precision",get:function(){return this.viewModel.precision},set:function(e){this.viewModel.precision=e}},{key:"rangeType",get:function(){return this.viewModel.rangeType},set:function(e){this.viewModel.rangeType=e}},{key:"standardDeviation",get:function(){return this.viewModel.standardDeviation},set:function(e){this.viewModel.standardDeviation=e}},{key:"values",get:function(){return this.viewModel.values},set:function(e){this.viewModel.values=e}}]),n}(c);t.__decorate([n.property()],b.prototype,"average",null),t.__decorate([n.property()],b.prototype,"barCreatedFunction",void 0),t.__decorate([n.property()],b.prototype,"bins",null),t.__decorate([n.property()],b.prototype,"dataLines",void 0),t.__decorate([n.property()],b.prototype,"dataLineCreatedFunction",void 0),t.__decorate([n.property({type:i,json:{type:[a.Integer],write:!0}})],b.prototype,"excludedBarColor",void 0),t.__decorate([n.property()],b.prototype,"hasTimeData",null),t.__decorate([n.property({type:i,json:{type:[a.Integer],write:!0}})],b.prototype,"includedBarColor",void 0),t.__decorate([n.property()],b.prototype,"label",null),t.__decorate([n.property()],b.prototype,"labelFormatFunction",null),t.__decorate([n.property()],b.prototype,"max",null),t.__decorate([n.property(),_.messageBundle("esri/widgets/HistogramRangeSlider/t9n/HistogramRangeSlider")],b.prototype,"messages",void 0),t.__decorate([n.property()],b.prototype,"min",null),t.__decorate([n.property()],b.prototype,"precision",null),t.__decorate([n.property()],b.prototype,"rangeType",null),t.__decorate([n.property()],b.prototype,"standardDeviation",null),t.__decorate([n.property()],b.prototype,"standardDeviationCount",void 0),t.__decorate([n.property()],b.prototype,"values",null),t.__decorate([n.property()],b.prototype,"viewModel",void 0),b=t.__decorate([l.subclass("esri.widgets.HistogramRangeSlider")],b);return b}));
