/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../Color","../../core/Accessor","../../core/arrayUtils","../../core/asyncUtils","../../core/has","../../core/Handles","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/timeUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/accessorSupport/decorators/subclass","../../chunks/vec3f64","../../views/3d/support/earthUtils","../../views/3d/support/sunUtils","../../views/3d/webgl-engine/shaders/ShadowCastVisualizeTechniqueConfiguration","./DiscreteOptions","./DurationMode","./DurationOptions","./ShadowCastState","./ShadowTooltipViewModel","./ShadowVisualizationType","./ThresholdOptions","../support/traversalUtils"],(function(e,t,r,i,o,n,a,s,l,c,d,p,u,h,_,y,f,w,v,m,g,T,b,D,P,O,z,S){"use strict";const C=[],V=f.create(),U=[],k=255,A=u.convertTime(1,"hours","milliseconds"),E=500;let R=function(t){function i(e){var r;return(r=t.call(this,e)||this).view=null,r.tooltip=new P.ShadowTooltipViewModel({getDuration:(e,t)=>r.getDuration(e,t)}),r.startTimeOfDay=u.convertTime(10,"hours","milliseconds"),r.endTimeOfDay=u.convertTime(16,"hours","milliseconds"),r.visualizationType=O.ShadowVisualizationType.Threshold,r.thresholdOptions=new z,r.durationOptions=new b,r.discreteOptions=new g,r._running=!0,r._handles=new s,r._stopPreviewingTask=null,r._forcePreview=!1,r._autoRestoreForcePreviewEnabled=!0,r._utcOffset=null,r.date=new Date,r}e._inherits(i,t);var a=i.prototype;return a.initialize=function(){this._handles.add([d.watch((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:e,tooltipEnabled:t})=>{this.tooltip.view=e,this.tooltip.enabled=t}),d.syncAndInitial),d.watch((()=>this._forcePreviewDependencies),(()=>{l.abortMaybe(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=n.createTask((async e=>{await c.after(E,e),c.throwIfAborted(e),this._forcePreview=!1})))}),d.syncAndInitial),d.watch((()=>({renderer:this.renderer,parameters:this._visualizationParameters})),(e=>M(e.renderer,e.parameters)),d.syncAndInitial),d.watch((()=>({renderer:this.renderer,parameters:{lightDirections:this._lightDirections}})),(e=>M(e.renderer,e.parameters)),d.syncAndInitial),d.watch((()=>({renderer:this.renderer,parameters:{enabled:this._running}})),(e=>M(e.renderer,e.parameters)),d.syncAndInitial),d.watch((()=>({renderer:this.renderer,parameters:{previewing:this._previewing}})),(e=>M(e.renderer,e.parameters)),d.syncAndInitial)])},a.destroy=function(){this.stop(),this._handles=l.destroyMaybe(this._handles),l.destroyMaybe(this.tooltip)},a.start=function(){this._running=!0},a.stop=function(){this._running=!1},a.setRunning=function(e){this._running=e},a.getDuration=async function(e,t){const{view:r,renderer:i}=this;if(null==r||null==i)return 0;const o=r.state.camera.screenToRender(p.createScreenPointArray(e.x,e.y),p.createRenderScreenPointArray()),n=i.readAccumulatedShadow(o),a=this._sampleCount;if(0===a)return 0;return n*a*(this._duration/a)},e._createClass(i,[{key:"state",get:function(){return null!=this.view&&this.view.ready&&null!=this._referencePosition?D.ShadowCastState.Ready:D.ShadowCastState.Disabled}},{key:"date",set:function(e){const t=new Date(e);t.setHours(0,0,0,0),this._set("date",t)}},{key:"utcOffset",get:function(){return this._utcOffset??this._utcOffsetAuto},set:function(e){this._utcOffset=e}},{key:"testData",get:function(){return{setAutoRestoreForcedPreviewEnabled:e=>{this._autoRestoreForcePreviewEnabled=e},setForcedPreview:e=>{this._forcePreview=e},isPreviewing:()=>this._previewing}}},{key:"_previewing",get:function(){const{view:e}=this;return null==e||null==e.allLayerViews||(this._forcePreview||!e.stationary||e.allLayerViews.some((e=>N(e)&&e.updating)))}},{key:"_utcOffsetAuto",get:function(){const e=this._referencePosition;return null!=e?w.longitudeToTimezone(e[0],!1):0}},{key:"_dateUTCOffset",get:function(){let e=this.date;return e=u.offsetDateUTC(e,-e.getTimezoneOffset(),"minutes"),e=u.offsetDateUTC(e,-this.utcOffset,"hours"),e}},{key:"_startDateTimeUTC",get:function(){return u.offsetDateUTC(this._dateUTCOffset,this.startTimeOfDay)}},{key:"_endDateTimeUTC",get:function(){return u.offsetDateUTC(this._dateUTCOffset,this.endTimeOfDay)}},{key:"_referencePosition",get:function(){return l.applySome(this.view,(e=>l.applySome(e.environmentManager,(e=>e.referencePositionWGS84Comparable))))}},{key:"_interval",get:function(){const e=this._duration>0?Math.floor(this._duration/k):k,t=this.discreteOptions.interval;switch(this.visualizationType){case O.ShadowVisualizationType.Threshold:case O.ShadowVisualizationType.Duration:return e;case O.ShadowVisualizationType.Discrete:return t>0?t:e}}},{key:"_sampleCount",get:function(){return this._lightDirections.length}},{key:"_duration",get:function(){return this.endTimeOfDay-this.startTimeOfDay}},{key:"_lightDirections",get:function(){const{view:e}=this;if(null==e)return C;const t="global"===e.viewingMode?V:this._referencePosition;if(null==t)return C;const r=this._interval,i=v.computeDirectionsOverTime(this._startDateTimeUTC,this._endDateTimeUTC,r,t,e.state.viewingMode),o=i.length;U.length=0;const n=S.breadthFirstBinaryPartitioning(0,o,U),a=new Array(o);for(let s=0;s<o;++s)a[s]=i[n[s]];return a}},{key:"_tooltipEnabled",get:function(){return this.state===D.ShadowCastState.Ready&&this.visualizationType!==O.ShadowVisualizationType.Discrete&&this._running&&!this._previewing}},{key:"_visualizationParameters",get:function(){if(!this._running)return null;switch(this.visualizationType){case O.ShadowVisualizationType.Threshold:return this._thresholdVisualizationParameters;case O.ShadowVisualizationType.Duration:return this._durationVisualizationParameters;case O.ShadowVisualizationType.Discrete:return this._discreteVisualizationParameters}}},{key:"_thresholdVisualizationParameters",get:function(){const{value:e,color:t}=this.thresholdOptions,i=this._duration;return{visualization:m.ShadowCastVisualization.Threshold,color:r.toUnitRGBA(t),threshold:i>0?e/this._duration:0}}},{key:"_durationVisualizationParameters",get:function(){const{color:e,mode:t}=this.durationOptions,i=this._duration,o=i>0&&t===T.DurationMode.Hourly?A/i:0;return{color:r.toUnitRGBA(e),visualization:m.ShadowCastVisualization.Gradient,bandsEnabled:o>0,bandSize:o}}},{key:"_discreteVisualizationParameters",get:function(){return{color:r.toUnitRGBA(this.discreteOptions.color),visualization:m.ShadowCastVisualization.Gradient,bandsEnabled:!1,bandSize:0}}},{key:"_forcePreviewDependencies",get:function(){const{view:e}=this;if(null==e)return null;const t=e.slicePlane,r=e.allLayerViews.toArray().filter(N),i=r.map((e=>e.layer)).filter(o.isSome),n=r.map((e=>e.visible)),a=i.map((e=>e.visible)),s=i.map((e=>e.opacity)),l=i.filter((e=>"definitionExpression"in e)).map((e=>e.definitionExpression)),c=r.filter((e=>"filter"in e)).map((e=>e.filter));return{slicePlane:t,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:n,layerVisibilities:a,layerOpacities:s,filters:c,definitionExpressions:l}}},{key:"renderer",get:function(){const{view:e}=this;if(null==e)return null;const t=e._stage;return null==t?null:t.renderer}}]),i}(i);function M(e,t){null!=e&&null!=t&&e.setParameters({shadowCastOptions:t})}function N(e){if(e.suspended)return!1;switch(e.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"ogc-feature-3d":case"route-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":return!0;case"base-dynamic-3d":case"dimension-3d":case"imagery-3d":case"imagery-tile-3d":case"line-of-sight-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"media-3d":default:return!1;case"group":return e.layerViews.toArray().some((e=>N(e)))}}t.__decorate([h.property()],R.prototype,"state",null),t.__decorate([h.property()],R.prototype,"view",void 0),t.__decorate([h.property()],R.prototype,"tooltip",void 0),t.__decorate([h.property({nonNullable:!0})],R.prototype,"date",null),t.__decorate([h.property({nonNullable:!0})],R.prototype,"utcOffset",null),t.__decorate([h.property({nonNullable:!0})],R.prototype,"startTimeOfDay",void 0),t.__decorate([h.property({nonNullable:!0})],R.prototype,"endTimeOfDay",void 0),t.__decorate([h.property({nonNullable:!0})],R.prototype,"visualizationType",void 0),t.__decorate([h.property({type:z,nonNullable:!0})],R.prototype,"thresholdOptions",void 0),t.__decorate([h.property({type:b,nonNullable:!0})],R.prototype,"durationOptions",void 0),t.__decorate([h.property({type:g,nonNullable:!0})],R.prototype,"discreteOptions",void 0),t.__decorate([h.property()],R.prototype,"_running",void 0),t.__decorate([h.property()],R.prototype,"_handles",void 0),t.__decorate([h.property()],R.prototype,"_stopPreviewingTask",void 0),t.__decorate([h.property()],R.prototype,"_forcePreview",void 0),t.__decorate([h.property()],R.prototype,"_autoRestoreForcePreviewEnabled",void 0),t.__decorate([h.property()],R.prototype,"_previewing",null),t.__decorate([h.property()],R.prototype,"_utcOffset",void 0),t.__decorate([h.property()],R.prototype,"_utcOffsetAuto",null),t.__decorate([h.property()],R.prototype,"_dateUTCOffset",null),t.__decorate([h.property()],R.prototype,"_startDateTimeUTC",null),t.__decorate([h.property()],R.prototype,"_endDateTimeUTC",null),t.__decorate([h.property()],R.prototype,"_referencePosition",null),t.__decorate([h.property()],R.prototype,"_interval",null),t.__decorate([h.property()],R.prototype,"_sampleCount",null),t.__decorate([h.property()],R.prototype,"_duration",null),t.__decorate([h.property()],R.prototype,"_lightDirections",null),t.__decorate([h.property()],R.prototype,"_tooltipEnabled",null),t.__decorate([h.property()],R.prototype,"_visualizationParameters",null),t.__decorate([h.property()],R.prototype,"_thresholdVisualizationParameters",null),t.__decorate([h.property()],R.prototype,"_durationVisualizationParameters",null),t.__decorate([h.property()],R.prototype,"_discreteVisualizationParameters",null),t.__decorate([h.property()],R.prototype,"_forcePreviewDependencies",null),t.__decorate([h.property()],R.prototype,"renderer",null),R=t.__decorate([y.subclass("esri.widgets.ShadowCast.ShadowCastViewModel")],R);return R}));
