/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../intl","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../symbols/support/svgUtils","../../../symbols/support/utils","../../Widget","./CardCSS","./support/relationshipUtils","./support/univariateUtils","../support/styleUtils","../../support/Heading","../../support/decorators/accessibleHandler","../../support/decorators/messageBundle","../../support/jsxFactory","../../support/widgetUtils","../../../intl/substitute"],(function(e,t,s,i,a,o,r,n,l,c,d,p,h,m,y,S,g,u,v,f,C,b,x){"use strict";const _=25,w=25,L=768,R=100;var z;!function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"}(z||(z={}));const N="#ddd",$=window.devicePixelRatio;function k(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.at(t-1),i=s.resource&&s.resource.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const t=e.style;return"circle"===t||"diamond"===t||"cross"===t}}}function I(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.at(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}let A=function(t){function s(e,s){var i;return(i=t.call(this,e,s)||this)._hasIndicators=!1,i._selectedSectionName=null,i._sectionNames=[],i._sectionMap=new Map,i.activeLayerInfos=null,i.headingLevel=3,i.layout=z.Stack,i.messages=null,i.messagesCommon=null,i.type="card",i.view=null,i}e._inherits(s,t);var o=s.prototype;return o.initialize=function(){this.addHandles(i.watch((()=>this.activeLayerInfos),(e=>{this.removeAllHandles(),this._watchForSectionChanges(e)})))},o.render=function(){const{view:e}=this;this._hasIndicators=this.layout===z.Auto&&e&&e.container.clientWidth<=L||this.layout===z.Stack;const t=this.activeLayerInfos,s=t&&t.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const i=this._sectionNames.length,a=this._sectionNames.map(((e,t)=>{const s=x.substitute(this.messagesCommon.pagination.pageText,{index:t+1,total:i});return C.tsx("div",{key:e,role:"tab",id:e,"aria-label":s,"aria-controls":`${e}-panel`,"aria-selected":(this._selectedSectionName===e).toString(),tabIndex:this._selectedSectionName===e?0:-1,title:s,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(m.CSS.indicator,{[m.CSS.activated]:this._selectedSectionName===e}),"data-section-name":e})})),o=this._hasIndicators&&i>1?C.tsx("div",{class:m.CSS.indicatorContainer,key:"carousel-navigation",role:"tablist"},a):null,r=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):s&&s.length?s:null,n={[m.CSS.stacked]:this._hasIndicators};return C.tsx("div",{class:this.classes(m.CSS.base,n)},r||C.tsx("div",{class:m.CSS.message},this.messages.noLegend),o)},o._selectSection=function(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)},o._focusSection=function(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}},o._switchSectionOnArrowPress=function(e){const t=e.key,s="ArrowLeft"===t?-1:1,i=e.target.getAttribute("data-section-name"),a=this._sectionNames.indexOf(i),o=this._sectionNames;let r=null;-1!==a&&(o[a+s]?r=document.getElementById(o[a+s]):"ArrowLeft"===t?r=document.getElementById(o[o.length-1]):"ArrowRight"===t&&(r=document.getElementById(o[0])),r?.focus())},o._watchForSectionChanges=function(e){if(this._generateSectionNames(),e){e.forEach((e=>{const t=`activeLayerInfo-${e.layer.uid}-version-change`;this.removeHandles(t),this._watchForSectionChanges(e.children),this.addHandles(i.watch((()=>e.version),(()=>this._generateSectionNames())),t)}));const t="activeLayerInfos-collection-change";this.removeHandles(t),this.addHandles(e.on("change",(()=>this._watchForSectionChanges(e))),t)}},o._generateSectionNames=function(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)},o._getSectionName=function(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`},o._generateSectionNamesForActiveLayerInfo=function(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))}))},o._renderLegendForLayer=function(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return C.tsx("div",{key:e.layer.uid,class:this.classes(m.CSS.service,m.CSS.groupLayer)},C.tsx("div",{class:m.CSS.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some((e=>"relationship-ramp"===e.type)),i=t.map(((t,i)=>this._renderLegendForElement(t,e,i,s))).filter((e=>!!e));if(!i.length)return null;const a={[m.CSS.groupLayerChild]:!!e.parent};return C.tsx("div",{key:e.layer.uid,class:this.classes(m.CSS.service,a)},C.tsx("div",{class:m.CSS.serviceCaptionContainer},C.tsx("div",{class:m.CSS.serviceCaptionText},e.title)),C.tsx("div",{class:m.CSS.serviceContent},i))}},o._renderLegendForElement=function(e,t,s,i=!1,a=!1){const o="color-ramp"===e.type,r="opacity-ramp"===e.type,n="size-ramp"===e.type,l=t.layer;let c=null;if("string"==typeof e.title)c=e.title;else if(e.title){const t=e.title,s=g.getTitle(this.messages,t,o||r);c=t.title?`${t.title} (${s})`:s}const d=this._getSectionName(l,e,s),p=this._hasIndicators&&!a?C.tsx("div",null,C.tsx(u.Heading,{level:this.headingLevel,class:m.CSS.carouselTitle},t.title),C.tsx(u.Heading,{level:u.incrementHeadingLevel(this.headingLevel),class:m.CSS.layerCaption},c)):c?C.tsx(u.Heading,{level:this.headingLevel,class:m.CSS.layerCaption},c):null,h=t.effectList;let S=null;if("symbol-table"===e.type){const s=e.infos.map(((s,i)=>this._renderLegendForElementInfo(s,t,e.legendType,i))).filter((e=>!!e));if(s.length){const e=s[0].properties.classes&&s[0].properties.classes[m.CSS.symbolRow],t={[m.CSS.labelContainer]:!e&&!i,[m.CSS.relationshipLabelContainer]:i};S=C.tsx("div",{class:this.classes(t)},s)}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?S=this._renderLegendForRamp(e,l.opacity,h):n?S=this._renderSizeRamp(e,l.opacity):"pie-chart-ramp"===e.type?S=this._renderPieChartRamp(e):"relationship-ramp"===e.type?S=y.renderRelationshipRamp(e,this.id,{opacity:l.opacity,effectList:h,ariaLabel:this.messages.previewRelationshipRampAriaLabel}):"univariate-above-and-below-ramp"===e.type?S=this._renderUnivariateAboveAndBelowRamp(e,l.opacity,h):"univariate-color-size-ramp"===e.type&&(S=this._renderUnivariateColorSizeRamp(e,l.opacity,h));if(!S)return null;const v=C.tsx("div",{key:d,class:m.CSS.section,id:`${d}-panel`,role:"tabpanel","aria-labelledby":d,tabIndex:0},[p,S]);return a||this._sectionMap.set(d,v),v},o._renderPieChartRamp=function(e){return C.tsx("div",{class:m.CSS.pieChartRampPreview,bind:e.preview,afterCreate:g.attachToNode})},o._renderUnivariateAboveAndBelowRamp=function(e,t,s){const{sizeRampElement:i,colorRampElement:a}=S.getUnivariateAboveAndBelowRampElements(e,t,"horizontal");if(!i)return null;const o=S.getUnivariateSizeRampSize(i,"full",!0,"horizontal"),r=S.getUnivariateColorRampSize(i,"above",!0,"horizontal"),n=S.getUnivariateColorRampSize(i,"below",!0,"horizontal"),l=12,c=this.messages?.previewColorRampAriaLabel,d=S.getUnivariateColorRampPreview(a,{width:r,height:l,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s,ariaLabel:c}),p=S.getUnivariateColorRampPreview(a,{width:n,height:l,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s,ariaLabel:c}),h=S.getUnivariateColorRampMargin(i,"card"),y=i.infos.map((e=>e.label)),u=y.length-1,v=y.map(((e,t)=>0===t||t===u?C.tsx("div",{key:t},e):null)),f={display:"flex",flexDirection:"column"},x={display:"flex",flexDirection:"row"},_={marginTop:"3px",display:"flex"};b.isRTL(this.container)?_.marginRight=`${h}px`:_.marginLeft=`${h}px`;const w={width:`${o}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return C.tsx("div",{class:m.CSS.layerRow,key:"size-ramp-preview",styles:f},C.tsx("div",{class:this.classes(m.CSS.symbolContainer,m.CSS.sizeRampHorizontal),styles:x},i.infos.map(((e,t)=>C.tsx("div",{key:t,class:m.CSS.symbol,bind:e.preview,afterCreate:g.attachToNode})))),d?C.tsx("div",{class:m.CSS.univariateAboveAndBelowColorRamp,styles:_,key:"color-ramp-preview"},C.tsx("div",{bind:d,afterCreate:g.attachToNode}),C.tsx("div",{bind:p,afterCreate:g.attachToNode})):null,C.tsx("div",{class:m.CSS.layerInfo},C.tsx("div",{class:m.CSS.rampLabelsContainer,styles:w},v)))},o._renderUnivariateColorSizeRamp=function(e,t,s){const{sizeRampElement:i,colorRampElement:a}=S.getUnivariateColorSizeRampElements(e,"horizontal");if(!i)return null;const o=S.getUnivariateSizeRampSize(i,"full",!1,"horizontal"),r=S.getUnivariateColorRampSize(i,"full",!1,"horizontal"),n=12,l=S.getUnivariateColorRampPreview(a,{width:r,height:n,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s,ariaLabel:this.messages?.previewColorRampAriaLabel}),c=S.getUnivariateColorRampMargin(i,"card"),d=i.infos.length-1,p=i.infos.map(((e,t)=>0===t||t===d?C.tsx("div",{key:t},e.label):null)),h={display:"flex",flexDirection:"column"},y={display:"flex",flexDirection:"row"},u={marginTop:"3px",display:"flex"};b.isRTL(this.container)?u.marginRight=`${c}px`:u.marginLeft=`${c}px`;const v={width:`${o}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return C.tsx("div",{class:m.CSS.layerRow,key:"size-ramp-preview",styles:h},C.tsx("div",{class:this.classes(m.CSS.symbolContainer,m.CSS.sizeRampHorizontal),styles:y},i.infos.map(((e,t)=>C.tsx("div",{key:t,class:m.CSS.symbol,bind:e.preview,afterCreate:g.attachToNode})))),C.tsx("div",{class:m.CSS.univariateAboveAndBelowColorRamp,styles:u,key:"color-ramp-preview"},C.tsx("div",{bind:l,afterCreate:g.attachToNode})),C.tsx("div",{class:m.CSS.layerInfo},C.tsx("div",{class:m.CSS.rampLabelsContainer,styles:v},p)))},o._renderLegendForElementInfo=function(e,t,s,i){const a=t.layer;if(e.type)return this._renderLegendForElement(e,t,i,!1,!0);const o=g.isImageryStretchedLegend(a,s);if(e.preview){if(!e.symbol||!e.symbol.type.includes("simple-fill")){if(!e.label)return C.tsx("div",{key:i,bind:e.preview,afterCreate:g.attachToNode});const t={[m.CSS.symbolCell]:this._hasIndicators};return C.tsx("div",{key:i,class:this.classes(m.CSS.layerRow,{[m.CSS.symbolRow]:this._hasIndicators})},C.tsx("div",{class:this.classes(t),bind:e.preview,afterCreate:g.attachToNode}),C.tsx("div",{class:this.classes(m.CSS.imageLabel,{[m.CSS.labelCell]:this._hasIndicators})},g.getTitle(this.messages,e.label,!1)||""))}let s=255,o=255,r=255,n=0,l=255,c=255,d=255,h=0;const y=e.symbol.color&&e.symbol.color.a,S=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;y&&(s=e.symbol.color.r,o=e.symbol.color.g,r=e.symbol.color.b,n=e.symbol.color.a*a.opacity),S&&(l=e.symbol.outline.color.r,c=e.symbol.outline.color.g,d=e.symbol.outline.color.b,h=e.symbol.outline.color.a*a.opacity);const u=e.symbol.color?.isBright??!0,v=u?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",f={background:y?`rgba(${s}, ${o}, ${r}, ${n})`:"none",color:u?"black":"white",textShadow:`-1px -1px 0 ${v},\n                                              1px -1px 0 ${v},\n                                              -1px 1px 0 ${v},\n                                              1px 1px 0 ${v}`,border:S?`1px solid rgba(${l}, ${c}, ${d}, ${h})`:"none",filter:p.getCSSFilterFromEffectList(t.effectList)??void 0};return C.tsx("div",{key:i,class:m.CSS.layerRow},C.tsx("div",{class:m.CSS.labelElement,styles:f}," ",e.label," "))}if(e.src){const t=this._renderImage(e,a,o);return C.tsx("div",{key:i,class:m.CSS.layerRow},t,C.tsx("div",{class:m.CSS.imageLabel},e.label||""))}},o._renderImage=function(e,t,s){const{label:i,src:a,opacity:o}=e,r={[m.CSS.imageryLayerStretchedImage]:s,[m.CSS.symbol]:!s},n={opacity:`${null!=o?o:t.opacity}`};return C.tsx("img",{alt:g.getTitle(this.messages,i,!1),"aria-label":g.getTitle(this.messages,i,!1),src:a,border:0,width:e.width,height:e.height,class:this.classes(r),styles:n})},o._renderSizeRampLines=function(e){const t=e.infos,s=t[0],i=t[t.length-1],o=s.symbol,r=this._hasIndicators,n=a.pt2px(s.size+s.outlineSize)*$,l=a.pt2px(i.size+i.outlineSize)*$,c=r?n:n+50*$,d=r?n/2+50*$:n,p=I(o),h=k(o),m=document.createElement("canvas");m.width=c,m.height=d,m.style.width=m.width/$+"px",m.style.height=m.height/$+"px";const y=m.getContext("2d");if(r){y.beginPath();const e=0,t=0,s=c/2-l/2,i=d;y.moveTo(e,t),y.lineTo(s,i);const a=c,o=0,r=c/2+l/2,n=d;y.moveTo(a,o),y.lineTo(r,n)}else{y.beginPath();const e=0,t=d/2-l/2,s=c,i=0;y.moveTo(e,t),y.lineTo(s,i);const a=0,o=d/2+l/2,r=c,n=d;y.moveTo(a,o),y.lineTo(r,n)}return y.strokeStyle=N,y.stroke(),C.tsx("div",{bind:m,afterCreate:g.attachToNode,styles:r?{display:"flex",marginTop:`-${p?0:h?n/2:0}px`,marginBottom:`-${p?l:h?l/2:0}px`}:{display:"flex",marginRight:`-${p?0:h?n/2:0}px`,marginLeft:`-${p?0:h?l/2:0}px`}})},o._renderSizeRamp=function(e,t){const s=e.infos,i=s[0].label,a=s[s.length-1].label;let o=s[0].preview,r=s[s.length-1].preview;const n=this._hasIndicators,l={"flex-direction":n?"column":"row-reverse"};o&&(o=o.cloneNode(!0),o.style.display="flex"),r&&(r=r.cloneNode(!0),r.style.display="flex");const c={opacity:null!=t?`${t}`:""};return C.tsx("div",{class:this.classes(m.CSS.layerRow,{[m.CSS.sizeRampRow]:n})},C.tsx("div",{class:m.CSS.rampLabel},n?i:a),C.tsx("div",{class:m.CSS.sizeRampContainer,styles:l},C.tsx("div",{bind:o,afterCreate:g.attachToNode,class:m.CSS.sizeRampPreview,styles:c}),this._renderSizeRampLines(e),C.tsx("div",{bind:r,afterCreate:g.attachToNode,class:m.CSS.sizeRampContainer,styles:c})),C.tsx("div",{class:m.CSS.rampLabel},n?a:i))},o._renderLegendForRamp=function(e,t,s){const i=e.infos,a="heatmap-ramp"===e.type,o=i.length-1,r=w,n=o>2&&!a?_*o:R,l=n+20,c=10,h=i.slice(0).reverse();h.forEach(((e,t)=>{e.offset=a?e.ratio:t/o}));const y=h.length-1,S=h.length%2!=0&&h[h.length/2|0],g=S&&C.tsx("div",{class:m.CSS.intervalSeparatorsContainer},C.tsx("div",{class:m.CSS.intervalSeparator},"|"),C.tsx("div",{class:m.CSS.rampLabel},S.label)),u=i[i.length-1].label,v=i[0].label,f=[[{shape:{type:"path",path:`M0 ${r/2} L${c} 0 L${c} ${r} Z`},fill:h[0].color,stroke:{width:0}},{shape:{type:"rect",x:c,y:0,width:n,height:r},fill:{type:"linear",x1:c,y1:0,x2:n+c,y2:0,colors:h},stroke:{width:0}},{shape:{type:"path",path:`M${n+c} 0 L${l} ${r/2} L${n+c} ${r} Z`},fill:h[y].color,stroke:{width:0}}]],b=d.renderSVG(f,l,r),{messages:x}=this,L={filter:p.getCSSFilterFromEffectList(s)??void 0,opacity:null==t?void 0:`${t}`},z={justifyContent:"center"};return C.tsx("div",{class:m.CSS.layerRow,styles:z},C.tsx("div",{class:m.CSS.rampLabel},a?x[u]:u),C.tsx("div",{class:m.CSS.symbolContainer},C.tsx("div",{styles:L},b),g),C.tsx("div",{class:m.CSS.rampLabel},a?x[v]:v))},e._createClass(s)}(h);t.__decorate([o.property()],A.prototype,"activeLayerInfos",void 0),t.__decorate([o.property()],A.prototype,"headingLevel",void 0),t.__decorate([o.property()],A.prototype,"layout",void 0),t.__decorate([o.property(),f.messageBundle("esri/widgets/Legend/t9n/Legend")],A.prototype,"messages",void 0),t.__decorate([o.property(),f.messageBundle("esri/t9n/common")],A.prototype,"messagesCommon",void 0),t.__decorate([o.property({readOnly:!0})],A.prototype,"type",void 0),t.__decorate([o.property()],A.prototype,"view",void 0),t.__decorate([v.accessibleHandler()],A.prototype,"_selectSection",null),A=t.__decorate([c.subclass("esri.widgets.Legend.styles.Card")],A);return A}));
