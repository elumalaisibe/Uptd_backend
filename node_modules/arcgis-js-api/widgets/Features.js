/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../intl","../core/Collection","../core/events","../core/Logger","../core/reactiveUtils","../core/throttle","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","./Feature","./Spinner","./Widget","./Feature/resources","./Feature/support/FeatureContentMixin","./Features/FeaturesViewModel","./Features/FeaturesVisibleElements","./Popup/actionUtils","./support/componentsUtils","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","../intl/substitute"],(function(e,t,o,i,n,r,s,l,a,c,u,d,p,h,_,w,v,f,m,g,F,M,y,b,x,I,R,k){"use strict";const C="esri-features",A={calciteModeLight:"calcite-mode-light",calciteModeDark:"calcite-mode-dark",esriWidget:"esri-widget",esriWidgetPanel:"esri-widget--panel",base:`${C}`,container:`${C}__container`,contentFeature:`${C}__content-feature`,footer:`${C}__footer`,featureMenuObserver:`${C}__feature-menu-observer`,actionExit:`${C}__action--exit`},S="selected-index",E=0,O="features-spinner";let N=function(o){function i(e,i){var r;return(r=o.call(this,e,i)||this)._featureMenuIntersectionObserverCallback=([e])=>{e?.isIntersecting&&null!=r.viewModel.featurePage&&r.viewModel.featurePage++},r._featureMenuIntersectionObserver=new IntersectionObserver(r._featureMenuIntersectionObserverCallback,{root:window.document}),r._featureMenuIntersectionObserverNode=null,r._focusFeatureMenuFlowItem=!1,r._spinner=null,r._feature=null,r._relatedRecordsFlowItems=new n,r._focusRootFlowItem=!1,r._rootFlowItemNode=null,r._featureMenuViewportNode=null,r._exitRelatedRecordsActions=new WeakMap,r._featureSelectionActions=new WeakMap,r.icon=null,r.headingLevel=2,r.messages=null,r.messagesCommon=null,r.viewModel=new g,r.visibleElements=new F,r._renderAction=(e,o)=>{const i=r._getActionTitle(e);return R.tsx("calcite-action",{appearance:"solid",bind:t._assertThisInitialized(r),icon:r._getActionIcon(e),onclick:r._triggerAction,"data-action-uid":e.uid,disabled:e.disabled,indicator:e.indicator,loading:e.active,active:"toggle"===e.type&&e.value,key:`action-${o}`,text:i},R.tsx("calcite-tooltip",{placement:"bottom",overlayPositioning:"fixed",label:i,slot:"tooltip"},i))},r._openFeatureMenu=()=>{r.featureMenuOpen=!0},r._previousFeature=()=>{r.viewModel.selectedFeatureIndex--},r._nextFeature=()=>{r.viewModel.selectedFeatureIndex++},r._handleFeatureMenuBack=()=>{r._focusRootFlowItem=!0,r.featureMenuOpen=!1,r.viewModel.browseClusterEnabled=!1},r._handleOpenRelatedFeature=e=>{r._openRelatedFeature(e)},r._displaySpinnerThrottled=a.throttle((()=>r._displaySpinner()),E),r._addSelectedFeatureIndexHandle(),r.addHandles([r._displaySpinnerThrottled,l.watch((()=>r.viewModel?.active),(()=>r._toggleScreenLocationEnabled())),l.watch((()=>r.visibleElements?.spinner),(e=>r._spinnerEnabledChange(e))),l.watch((()=>r.viewModel?.view),((e,t)=>r._viewChange(e,t))),l.watch((()=>r.viewModel?.view?.ready),((e,t)=>r._viewReadyChange(e??!1,t??!1))),l.watch((()=>[r.viewModel?.waitingForResult,r.viewModel?.location]),(()=>{r._hideSpinner(),r._displaySpinnerThrottled()})),l.watch((()=>r.selectedFeatureWidget),(()=>r._destroyRelatedRecordsFlowItemWidgets())),l.watch((()=>{const e=r.selectedFeatureWidget?.viewModel;return[e?.title,e?.state]}),(()=>r._setTitleFromFeatureWidget())),l.watch((()=>{const e=r.selectedFeatureWidget?.viewModel;return[e?.content,e?.state]}),(()=>r._setContentFromFeatureWidget())),l.watch((()=>r.viewModel?.featureViewModels),(()=>r._featureMenuViewportScrollTop()))]),r}t._inherits(i,o);var c=i.prototype;return c.loadDependencies=function(){return y.loadCalciteComponents({action:()=>new Promise(((t,o)=>e(["../chunks/calcite-action"],t,o))),"action-bar":()=>new Promise(((t,o)=>e(["../chunks/calcite-action-bar"],t,o))),"action-group":()=>new Promise(((t,o)=>e(["../chunks/calcite-action-group"],t,o))),button:()=>new Promise(((t,o)=>e(["../chunks/calcite-button"],t,o))),flow:()=>new Promise(((t,o)=>e(["../chunks/calcite-flow"],t,o))),"flow-item":()=>new Promise(((t,o)=>e(["../chunks/calcite-flow-item"],t,o))),list:()=>new Promise(((t,o)=>e(["../chunks/calcite-list"],t,o))),"list-item":()=>new Promise(((t,o)=>e(["../chunks/calcite-list-item"],t,o))),tooltip:()=>new Promise(((t,o)=>e(["../chunks/calcite-tooltip"],t,o)))})},c.destroy=function(){this._destroyRelatedRecordsFlowItemWidgets(),this._destroySelectedFeatureWidget(),this._destroySpinner(),this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver?.disconnect()},c.blur=function(){const{active:e}=this.viewModel;e||s.getLogger(this.declaredClass).warn("Features can only be blurred when currently active."),this._rootFlowItemNode?.blur()},c.clear=function(){return this.viewModel.clear()},c.close=function(){this.viewModel.visible=!1},c.fetchFeatures=function(e,t){return this.viewModel.fetchFeatures(e,t)},c.focus=function(){const{container:e}=this,{active:t}=this.viewModel;if(t||s.getLogger(this.declaredClass).warn("Features can only be blurred when currently active."),!e)return;const o=e.querySelectorAll("calcite-flow-item"),i=o[o?.length-1];this.scheduleRender(),requestAnimationFrame((()=>i?.setFocus()))},c.next=function(){return this.viewModel.next()},c.open=function(e){this.removeHandles(S),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()},c.previous=function(){return this.viewModel.previous()},c.triggerAction=function(e){return this.viewModel.triggerAction(e)},c.render=function(){return R.tsx("div",{class:this.classes(A.base,A.esriWidget,A.esriWidgetPanel)},this._renderContentContainer())},c._renderFooter=function(){return this._featureNavigationVisible?R.tsx("div",{slot:"footer",class:A.footer,key:"footer-actions"},this._renderPagination(),this._renderFeatureMenuButton()):null},c._renderFeatureMenuButton=function(){const{messages:e,messagesCommon:t}=this,{featureCount:o,selectedFeatureIndex:i,pendingPromisesCount:n}=this.viewModel;return R.tsx("calcite-action-group",{layout:"horizontal"},n>0?R.tsx("calcite-action",{appearance:"solid",key:"feature-menu-loading-action",loading:!0,scale:"s",text:t.loading||"",label:t.loading||""}):R.tsx("calcite-action",{appearance:"solid",key:"feature-menu-button",bind:this,scale:"s",textEnabled:!0,label:e.selectFeature||"",text:k.substitute(e.pageText||"",{total:o,index:(i+1).toLocaleString(void 0,{minimumIntegerDigits:o.toString().length,useGrouping:!1})}),onclick:this._openFeatureMenu,icon:"list"},R.tsx("calcite-tooltip",{overlayPositioning:"fixed",label:e.selectFeature,placement:"bottom",slot:"tooltip"},e.selectFeature)))},c._renderPagination=function(){const{previous:e,next:t}=this.messagesCommon.pagination;return R.tsx("calcite-action-group",{layout:"horizontal"},R.tsx("calcite-action",{appearance:"solid",label:e,text:e,iconFlipRtl:!0,icon:"chevron-left",scale:"s",onclick:this._previousFeature},R.tsx("calcite-tooltip",{placement:"bottom",overlayPositioning:"fixed",label:e,slot:"tooltip"},e)),R.tsx("calcite-action",{appearance:"solid",label:t,text:t,iconFlipRtl:!0,icon:"chevron-right",scale:"s",onclick:this._nextFeature},R.tsx("calcite-tooltip",{placement:"bottom",overlayPositioning:"fixed",label:t,slot:"tooltip"},t)))},c._renderFeatureMenuItem=function(e,t){const{selectedFeatureViewModel:o}=this.viewModel,i=e===o;return R.tsx("calcite-list-item",{bind:this,key:`feature-menu-item-${e.uid}`,selected:i,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onmouseover:this._setActiveFeature,onmouseleave:this._removeActiveFeature,"data-feature-index":t,onCalciteListItemSelect:this._selectFeature,label:e.title||this.messagesCommon.untitled})},c._renderFeatureMenu=function(){const{featureViewModels:e}=this.viewModel;return e.length>1?R.tsx("calcite-list",{selectionMode:"single",selectionAppearance:"icon"},e.filter((e=>!!e.graphic)).map(((e,t)=>this._renderFeatureMenuItem(e,t)))):null},c._renderContentFeature=function(){const{headingLevel:e,visibleElements:t}=this,{title:o,active:i}=this.viewModel,n=t.heading&&o?o:"";return R.tsx("calcite-flow-item",{bind:this,closed:!i,class:A.contentFeature,closable:t.closeButton,heading:n,headingLevel:e,onCalciteFlowItemClose:this.close,afterCreate:this._focusRootFlowItemNode,afterUpdate:this._focusRootFlowItemNode,key:"root-flow-item",onkeydown:this._onMainKeydown},this._renderActionBar(),R.tsx("div",{class:A.container},this._renderContent()),this._renderFooter())},c._renderFeatureMenuContainer=function(){const{viewModel:e,featureMenuOpen:t,messages:o,messagesCommon:i}=this,{active:n,featureViewModels:r}=e;return t?R.tsx("calcite-flow-item",{bind:this,closable:!1,closed:!n,afterCreate:this._focusFeatureMenuFlowItemNode,afterUpdate:this._focusFeatureMenuFlowItemNode,loading:e.isLoadingFeature,heading:o.selectFeature,description:k.substitute(o.total,{total:r.length}),key:"feature-menu",onCalciteFlowItemBack:this._handleFeatureMenuBack},R.tsx("div",{class:A.container},this._renderFeatureMenu()),R.tsx("div",{class:A.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),R.tsx("calcite-button",{onclick:this._handleFeatureMenuBack,slot:"footer-actions",appearance:"transparent",width:"full"},i.back)):null},c._renderContentContainer=function(){const{_relatedRecordsFlowItems:e}=this,{content:t}=this.viewModel,o=e.toArray();return R.tsx("calcite-flow",{key:t??"content"},this._renderContentFeature(),this._renderFeatureMenuContainer(),o.map((e=>this._renderRelatedRecordsFlowItem(e))),R.tsx("div",{key:"content-tooltips"},o.map((e=>this._renderRelatedRecordsFlowItemTooltips(e)))))},c._renderActionBar=function(){return this.visibleElements.actionBar&&this.viewModel.allActions?.length?R.tsx("calcite-action-bar",{key:"header-action-bar",expandDisabled:!0,slot:"action-bar"},R.tsx("calcite-action-group",null,this._renderActions())):null},c._renderActions=function(){return this.viewModel.allActions.toArray().map(this._renderAction)},c._renderContent=function(){const e=this.viewModel?.content;return e?"string"==typeof e?R.tsx("div",{class:f.CSS.contentNode,key:e,innerHTML:e}):this.renderNodeContent(e):null},c._renderRelatedRecordsFlowItem=function(e){const{messages:t}=this,{visibleElements:o}=this,{active:i}=this.viewModel,n="graphic"in e&&!e.isTable;return R.tsx("calcite-flow-item",{bind:this,closed:!i,closable:o.closeButton,heading:e.title??"",description:this._getRelatedRecordsFlowItemDescription(e),onCalciteFlowItemBack:this._handleRelatedRecordsBackClick,onCalciteFlowItemClose:this.close,key:`flow-item-${e.viewModel.uid}`},R.tsx("calcite-action",{appearance:"transparent",class:A.actionExit,icon:"move-up",label:t.exitRelatedRecords,text:t.exitRelatedRecords,slot:"header-actions-start",bind:this,afterCreate:t=>this._storeExitRelatedRecordsAction(e,t),onclick:this._destroyRelatedRecordsFlowItemWidgets}),n?R.tsx("calcite-action",{appearance:"transparent",icon:"zoom-to-object",label:t.selectFeature,text:t.selectFeature,slot:"header-actions-end",bind:this,afterCreate:t=>this._storeFeatureSelectionAction(e,t),onclick:()=>this._handleOpenRelatedFeature(e)}):null,R.tsx("div",{class:A.container},e.render()))},c._renderRelatedRecordsFlowItemTooltips=function(e){const{messages:t,_exitRelatedRecordsActions:o,_featureSelectionActions:i}=this,n=i.get(e);return[R.tsx("calcite-tooltip",{key:`exit-related-records-tooltip-${e.viewModel.uid}`,label:t.exitRelatedRecords,overlayPositioning:"fixed",referenceElement:o.get(e),placement:"top"},t.exitRelatedRecords),n?R.tsx("calcite-tooltip",{key:`select-related-record-tooltip-${e.viewModel.uid}`,label:t.selectFeature,overlayPositioning:"fixed",referenceElement:n,placement:"top"},t.selectFeature):null]},c._focusRootFlowItemNode=function(e){this._rootFlowItemNode=e,this._focusRootFlowItem&&(this._focusRootFlowItem=!1,requestAnimationFrame((()=>e?.setFocus())))},c._focusFeatureMenuFlowItemNode=function(e){this._featureMenuViewportNode=e,this._focusFeatureMenuFlowItem&&(this._focusFeatureMenuFlowItem=!1,requestAnimationFrame((()=>e?.setFocus())))},c._setActiveFeature=function(e){const{viewModel:t}=this,o=e.currentTarget["data-feature-index"];t.activeFeature=t.features[o]||null},c._removeActiveFeature=function(){this.viewModel.activeFeature=null},c._selectFeature=function(e){const t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuFlowItem=!0},c._unobserveFeatureMenuObserver=function(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)},c._featureMenuIntersectionObserverCreated=function(e){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(e),this._featureMenuIntersectionObserverNode=e},c._getActionIcon=function(e){return e.icon||"question"},c._getActionTitle=function(e){const{messages:t,selectedFeature:o,messagesCommon:i}=this,{id:n}=e,r=o?.attributes,s=e.title??"",l="zoom-to-feature"===n?k.substitute(s,{messages:t}):"remove-selected-feature"===n?k.substitute(s,{messages:i}):"zoom-to-clustered-features"===n||"browse-clustered-features"===n?k.substitute(s,{messages:t}):e.title;return l&&r?k.substitute(l,r):l??""},c._onMainKeydown=function(e){const t=r.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.next())},c._storeFeatureSelectionAction=function(e,t){this._featureSelectionActions.set(e,t),this.scheduleRender()},c._storeExitRelatedRecordsAction=function(e,t){this._exitRelatedRecordsActions.set(e,t),this.scheduleRender()},c._getRelatedRecordsFlowItemDescription=function(e){return"featureCountDescription"in e?e.featureCountDescription:e.viewModel.description??""},c._handleRelatedRecordsBackClick=function(){const e=this._relatedRecordsFlowItems.pop();e&&(this._exitRelatedRecordsActions.delete(e),this._featureSelectionActions.delete(e),"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e&&(e.viewModel=null,e.destroy()))},c._featureMenuViewportScrollTop=function(){this._featureMenuViewportNode&&this._featureMenuViewportNode.scrollContentTo({top:0})},c._setContentFromFeatureWidget=function(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)},c._openRelatedFeature=async function(e){await e.viewModel.updateGeometry();const t=e.graphic,o=t?.geometry;if(null==o||null==t)return;this._destroyRelatedRecordsFlowItemWidgets(),await this.viewModel.zoomTo({target:o});const i=M.getPointFromGeometry(o);this.open({features:[t],location:null!=i?i:void 0})},c._setTitleFromFeatureWidget=function(){const{selectedFeatureWidget:e,messagesCommon:t}=this,o=e?.viewModel;e&&(this.viewModel.title="error"===o?.state?t?.errorMessage:o?.title||"")},c._addSelectedFeatureIndexHandle=function(){const e=l.watch((()=>this.viewModel?.selectedFeatureIndex),((e,t)=>this._selectedFeatureIndexUpdated(e,t)));this.addHandles(e,S)},c._selectedFeatureIndexUpdated=function(e,t){const{featureCount:o}=this.viewModel;o&&e!==t&&-1!==e&&(this._destroyRelatedRecordsFlowItemWidgets(),this.featureMenuOpen=!1,this._rootFlowItemNode&&this._rootFlowItemNode.scrollContentTo({top:0}))},c._triggerAction=function(e){const t=e.currentTarget;if(t.disabled)return;const o=t.dataset.actionUid,{allActions:i}=this.viewModel,n=i.findIndex((e=>e.uid===o)),r=i.at(n);r&&"toggle"===r.type&&(r.value=!r.value),this.viewModel.triggerAction(n)},c._createSpinner=function(e){e&&(this._spinner=new w({view:e}),e.ui.add(this._spinner,{key:O,position:"manual"}))},c._wireUpView=function(e){this._destroySpinner(),e&&this.visibleElements?.spinner&&this._createSpinner(e)},c._hideSpinner=function(){const{_spinner:e}=this;e&&(e.location=null,e.hide())},c._viewReadyChange=function(e,t){e?this._wireUpView(this.viewModel?.view):t&&this.viewModel.clear()},c._viewChange=function(e,t){e&&t&&this.viewModel.clear()},c._destroySelectedFeatureWidget=function(){const{_feature:e}=this;e&&(e.viewModel=null,!e.destroyed&&e.destroy()),this._feature=null},c._destroyRelatedRecordsFlowItemWidgets=function(){this._relatedRecordsFlowItems.removeAll().forEach((e=>{"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e.viewModel=null,e.destroy()}))},c._toggleScreenLocationEnabled=function(){const{viewModel:e}=this;e&&(e.screenLocationEnabled=e.active)},c._displaySpinner=function(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:o}=this.viewModel;o&&t?e.show({location:t}):e.hide()},c._destroySpinner=function(){const{_spinner:e,view:t}=this;e&&(t?.ui?.remove(e,O),e.destroy(),this._spinner=null)},c._spinnerEnabledChange=function(e){this._destroySpinner(),e&&this._createSpinner(this.viewModel?.view)},t._createClass(i,[{key:"_featureNavigationVisible",get:function(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}},{key:"_activeFlowItemWidget",get:function(){return this._relatedRecordsFlowItems.at(-1)??null}},{key:"content",get:function(){return this.viewModel.content},set:function(e){this.viewModel.content=e}},{key:"featureMenuOpen",get:function(){return this.viewModel.featureMenuOpen},set:function(e){this.viewModel.featureMenuOpen=e}},{key:"features",get:function(){return this.viewModel.features},set:function(e){this.viewModel.features=e}},{key:"location",get:function(){return this.viewModel.location},set:function(e){this.viewModel.location=e}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(e){this._overrideIfSome("label",e)}},{key:"promises",get:function(){return this.viewModel.promises},set:function(e){this.viewModel.promises=e}},{key:"selectedFeature",get:function(){return this.viewModel.selectedFeature}},{key:"selectedFeatureIndex",get:function(){return this.viewModel.selectedFeatureIndex},set:function(e){this.viewModel.selectedFeatureIndex=e}},{key:"selectedFeatureWidget",get:function(){const{_feature:e,headingLevel:t,_relatedRecordsFlowItems:o}=this,{selectedFeatureViewModel:i}=this.viewModel,n={title:!1};return i?(e?(e.viewModel=i,e.visibleElements=n):this._feature=new _({flowItems:o,headingLevel:t+1,viewModel:i,visibleElements:n}),this._feature):null}},{key:"title",get:function(){return this.viewModel.title},set:function(e){this.viewModel.title=e}},{key:"updateLocationEnabled",get:function(){return this.viewModel.updateLocationEnabled},set:function(e){this.viewModel.updateLocationEnabled=e}},{key:"view",get:function(){return this.viewModel.view},set:function(e){this.viewModel.view=e}},{key:"visible",get:function(){return this.viewModel.visible},set:function(e){this.viewModel.visible=e}}]),i}(m.FeatureContentMixin(v));o.__decorate([c.property()],N.prototype,"_focusFeatureMenuFlowItem",void 0),o.__decorate([c.property()],N.prototype,"_relatedRecordsFlowItems",void 0),o.__decorate([c.property()],N.prototype,"_focusRootFlowItem",void 0),o.__decorate([c.property()],N.prototype,"_featureNavigationVisible",null),o.__decorate([c.property()],N.prototype,"_activeFlowItemWidget",null),o.__decorate([c.property()],N.prototype,"content",null),o.__decorate([c.property()],N.prototype,"icon",void 0),o.__decorate([c.property()],N.prototype,"featureMenuOpen",null),o.__decorate([c.property()],N.prototype,"features",null),o.__decorate([c.property()],N.prototype,"headingLevel",void 0),o.__decorate([c.property()],N.prototype,"location",null),o.__decorate([c.property()],N.prototype,"label",null),o.__decorate([c.property(),x.messageBundle("esri/widgets/Features/t9n/Features")],N.prototype,"messages",void 0),o.__decorate([c.property(),x.messageBundle("esri/t9n/common")],N.prototype,"messagesCommon",void 0),o.__decorate([c.property()],N.prototype,"promises",null),o.__decorate([c.property({readOnly:!0})],N.prototype,"selectedFeature",null),o.__decorate([c.property()],N.prototype,"selectedFeatureIndex",null),o.__decorate([c.property({readOnly:!0})],N.prototype,"selectedFeatureWidget",null),o.__decorate([c.property()],N.prototype,"title",null),o.__decorate([c.property()],N.prototype,"updateLocationEnabled",null),o.__decorate([c.property()],N.prototype,"view",null),o.__decorate([c.property({type:g}),I.vmEvent(["triggerAction","trigger-action"])],N.prototype,"viewModel",void 0),o.__decorate([c.property({type:F,nonNullable:!0})],N.prototype,"visibleElements",void 0),o.__decorate([c.property()],N.prototype,"visible",null),N=o.__decorate([h.subclass("esri.widgets.Features")],N);return N}));
