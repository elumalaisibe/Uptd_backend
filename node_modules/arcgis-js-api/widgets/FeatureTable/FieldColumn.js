/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../intl/date","../../intl/number","../../layers/support/CodedValueDomain","../../layers/support/editableLayers","../../layers/support/fieldUtils","../../layers/support/layerUtils","../FeatureForm/featureFormUtils","../FeatureForm/FieldInput","./Grid/EditorColumn","../support/DatePicker","../support/TimePicker","../support/widgetUtils"],(function(e,t,n,r,i,o,a,l,u,d,s,c,p,m,f,y,h,_,g,v){"use strict";const b={cancelEdit:"Escape"},F="esri-field-column",C={headerContent:`${F}__header-content`,headerLabel:`${F}__header-label`,input:`${F}__cell-input`,inputContainer:`${F}__cell__input-container`,dateInputContainer:`${F}__cell__date-input-container`,dateInputWrapper:`${F}__cell__date-input-wrapper`,button:`${F}__button`,saveIcon:"esri-icon-save",trashIcon:"esri-icon-trash",locked:"esri-icon-locked"},I=u.convertDateFormatToIntlOptions("short-date-short-time"),E=u.convertDateFormatToIntlOptions("short-date"),D={useGrouping:!0,maximumFractionDigits:20};let L=function(t){function r(n){var r;return(r=t.call(this,n)||this)._inputField=null,r.cellValueFormatFunction=({rowData:t,value:n})=>{if(r.formatFunction){const{config:t,field:i}=e._assertThisInitialized(r);return r.formatFunction({config:t,field:i,value:v.renderingSanitizer.sanitize(n)})}if(null===n)return"&nbsp;";const{config:i,field:o}=e._assertThisInitialized(r),a=t?.item?.feature,l=r._getDomainForFeature(a);if(l)return r._getComputedDomain(n,l);if("date"===o.type){const e=r._getDateFormatOptions(),t="feature"===r.layer?.type&&r.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null;return n?u.formatDate(n,{...e,...t}):null}if(f.unsupportedDateFieldTypes.has(o.type)&&n){const e=f.formatDateFieldValue(o,n);return v.renderingSanitizer.sanitize(e)}if(p.isNumericField(o)){const e=i?.format?d.convertNumberFormatToIntlOptions(i.format):D;return d.formatNumber(parseFloat(n),e)}return v.renderingSanitizer.sanitize(n)},r.cellValueValidatorFunction=({oldValue:e,value:t})=>!(r._inputField&&!r._inputField.valid)&&((!r.required||null!=t&&""!==t)&&e!==t),r.config=null,r.editingEnabled=!1,r.expressionInfos=null,r.field=null,r.formatFunction=null,r.headerRenderFunction=t=>{const{root:n}=t,{editable:i,editingEnabled:o,headerMenuEnabled:a,sortable:l}=e._assertThisInitialized(r);if(r.removeCellContent(n),n.classList.add(C.headerContent),o&&!i&&n.appendChild(r.createLockedElement()),l)r.headerSorterRenderFunction(t);else{const e=document.createElement("div");e.classList.add(C.headerLabel),e.textContent=r.label,n.appendChild(e)}a&&r.headerMenuRenderFunction(t)},r.inputRenderFunction=({root:e,column:t,rowData:n})=>{if(r.activeEditInfo?.updating)return;if(!r.editable)return;const i=r.getCellValue(t,n),o=r.createInputElement({root:e,column:t,rowData:n,value:i});if(r._set("activeEditInfo",{column:t,input:o,root:e,rowData:n,updating:!0,oldValue:i}),"date"===r.field.type)return void r._renderDateEditors(i,e,o);const a=r.createInputContainer();a.appendChild(o),r.removeCellContent(e),e.appendChild(a),o.focus(),o instanceof HTMLInputElement&&o.select(),r.grid?.notifyResize()},r.layer=null,r.parseInputValueFunction=({input:e})=>{const t=r._inputField;if(!t)return null;const n=e.value,{dataType:i,required:o}=t;return o||""!==n?"number"===i||"date"===i?parseFloat(n):"text"===i?n.trim():n:null},r.store=null,r.template=null,r.updateRowItemFunction=({rowData:e,column:t,value:n})=>{e&&(e.item.feature.attributes[t.path]=n)},r.updateStoreItemFunction=async({rowData:e,column:t,value:n})=>{if(!e||!r.store)return;const i=e.item.objectId,o=r.store.getObjectIdIndex(i)??e.index;await r.store.updateItem({index:o,name:t.path,value:n})},r}e._inherits(r,t);var i=r.prototype;return i.createInputElement=function({rowData:e,value:t}){const n=e?.item;if(!n||!n.feature)return null;this._inputField=this._setUpInputField(n.feature,t);const{field:r,maxLength:i,minLength:o,required:a}=this,{domain:l}=this._inputField;let u;"coded-value"===l?.type?(u=this._createSelectElement(t,l.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),this._inputField),u.onchange=()=>{u.onblur=null,s()}):(u=document.createElement("input"),u.type=p.isNumericField(r)?"number":"text",i>-1&&(u.maxLength=i),o>0&&(u.minLength=o)),u.classList.add(C.input),u.value=t,u.required=a;let d=!1;u.onkeydown=e=>{d=e.key===b.cancelEdit},u.onblur=()=>{u.onblur=null,s()};const s=()=>{d?this.cancel():this.submit(),this._inputField=null};return u},i.createInputContainer=function(){const e=document.createElement("div");return e.classList.add(C.inputContainer),e},i.createLockedElement=function(){const e=document.createElement("div");return e.classList.add(C.locked),e},i.getCellValue=function({path:e},t){return t?.item?.feature?.attributes?.[e]??null},i._renderDateEditors=function(e,t,r){const{config:i,messagesCommon:o,template:a}=this,l=e?new Date(e):new Date(Date.now()),u=new _({dateInputEnabled:!0,value:l}),d=new g({value:l});r.value=l.getTime().toString();let s=!e;const c=()=>{s=!0;const e=this._getCombinedDateTime(u.value,d.value);r.value=e.getTime().toString()},p=()=>{s?this.submit():this.cancel()},m=()=>{r.value=null,this.submit()};n.watch((()=>[u.value,d.value]),(()=>c()));const f=document.createElement("div"),y=document.createElement("div");u.container=f,d.container=y;const h=document.createElement("button");h.classList.add(C.button,C.saveIcon),h.onclick=()=>p(),h.title=o?.save;const v=document.createElement("button");v.classList.add(C.button,C.trashIcon),v.onclick=()=>m(),v.title=o?.clear;const b=document.createElement("div");b.classList.add(C.dateInputWrapper),b.appendChild(f),(a&&a.input&&"datetime-picker"===a.input.type&&!1!==a.input.includeTime||i&&!1!==i.includeTime)&&b.appendChild(y);const F=document.createElement("div");F.classList.add(C.dateInputContainer),F.appendChild(b),F.appendChild(h),F.appendChild(v),u.when((()=>{const e=u._inputOrButtonNode;e&&(e.onblur=e=>{const t=e.relatedTarget;t&&t.className.includes("esri-date-picker")||u.close(!1)}),this.grid?.notifyResize()})),d.when((()=>this.grid?.notifyResize())),this.removeCellContent(t),t.appendChild(F),this.grid?.notifyResize()},i._createSelectElement=function(e,t,n){let r=!1;const i=t.map((t=>{t.value===e&&(r=!0);const n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));if(null!=e&&""!==e&&!r){const t=document.createElement("option");t.text=e,t.value=e,i.unshift(t)}if(!n.required&&null==n.value){const e=document.createElement("option");e.value="",i.unshift(e)}const o=document.createElement("select");return i.forEach((e=>o.add(e))),o.value=e,o},i._setUpInputField=function(e,t){const{field:n,layer:r}=this,i=new y({feature:e,initialFeature:e.clone(),field:n,layer:r});return i.set("value",t),i},i._isDomainCompatible=function(e){const{field:t}=this;if(e&&"coded-value"===e.type){const n=typeof e.codedValues[0].code;if("string"===n&&p.isStringField(t)||"number"===n&&p.isNumericField(t))return!0}return!(!e||"range"!==e.type||!p.isNumericField(t))},i._getDomainForFeature=function(e){const{config:t,layer:n,name:r,template:i}=this;if(!n)return null;if("wfs"===n.type||"geojson"===n.type||"csv"===n.type)return null;if(i?.domain&&this._isDomainCompatible(i.domain))return i.domain;const{typeIdField:o}=n,a=o===r,l=this.field.domain;if(a&&!l)return new s({name:"__internal-type-based-coded-value-domain__",codedValues:n.types?.map((({id:e,name:t})=>({code:e,name:t})))});const u=o&&null!=r&&n.getFieldDomain(r,{feature:e})||l,d=t?.domain;return this._isDomainCompatible(d)?d:u},i._getComputedDomain=function(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const n=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return n&&n.length?n[0].name:e}return null},i._getCombinedDateTime=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())},i._getDateFormatOptions=function(){const{config:e,template:t}=this,n=t?.format?.dateFormat||e?.format?.dateFormat;return n?u.convertDateFormatToIntlOptions(n):t&&t.input&&"includeTime"in t.input==!1||!1===e?.includeTime?E:I},e._createClass(r,[{key:"alias",get:function(){return this.field?.alias}},{key:"defaultValue",get:function(){return this.field?.defaultValue}},{key:"description",get:function(){return this.template?.description??this.config?.description??this.field?.description??null}},{key:"editable",get:function(){const{config:e,editingEnabled:t,field:n,layer:r,template:i}=this;if(null==n||null==r)return!1;const o=c.isEditableLayer(r),a=m.getEffectiveLayerCapabilities(r),l=a?.operations.supportsUpdate;return!!(n.editable&&o&&l)&&(!f.unsupportedDateFieldTypes.has(n.type)&&(t?!(!1===i?.editable||!1===e?.editable):!(!i?.editable&&!e?.editable)))}},{key:"header",get:function(){return this.template?.label||this.config?.label||this.alias||this.path||null}},{key:"hidden",get:function(){const{config:e}=this;return!1===e?.visible||this._get("hidden")||!1},set:function(e){this._set("hidden",e)}},{key:"loadingMessage",get:function(){return this.messages?.loading||"..."}},{key:"maxLength",get:function(){const{field:e,config:t,template:n}=this,r=e?.length,i=n?.input&&"maxLength"in n.input?n.input.maxLength:t?.maxLength;return null!=i&&!isNaN(i)&&i>=-1&&(-1===r||i<=r)?i:r}},{key:"minLength",get:function(){const{config:e,template:t,maxLength:n}=this,r=t?.input&&"minLength"in t.input?t.input.minLength:e?.minLength||null;return n&&r<=n?r:null}},{key:"name",get:function(){return this.field?.name}},{key:"nullable",get:function(){return this.field?.nullable??!1}},{key:"path",get:function(){return this.field?.name}},{key:"required",get:function(){const{config:e,field:t,template:n}=this,r=t?.nullable,i=e?.required,o=n?.required;return this.editable&&(!r||!0===i||!0===o)}},{key:"sortable",get:function(){return this.template?!1!==this.template?.sortable:!1!==this.config?.sortable}}]),r}(h);t.__decorate([r.property({readOnly:!0})],L.prototype,"alias",null),t.__decorate([r.property()],L.prototype,"cellValueFormatFunction",void 0),t.__decorate([r.property()],L.prototype,"cellValueValidatorFunction",void 0),t.__decorate([r.property()],L.prototype,"config",void 0),t.__decorate([r.property({readOnly:!0})],L.prototype,"defaultValue",null),t.__decorate([r.property({readOnly:!0})],L.prototype,"description",null),t.__decorate([r.property({readOnly:!0})],L.prototype,"editable",null),t.__decorate([r.property()],L.prototype,"editingEnabled",void 0),t.__decorate([r.property()],L.prototype,"expressionInfos",void 0),t.__decorate([r.property()],L.prototype,"field",void 0),t.__decorate([r.property()],L.prototype,"formatFunction",void 0),t.__decorate([r.property({readOnly:!0})],L.prototype,"header",null),t.__decorate([r.property()],L.prototype,"hidden",null),t.__decorate([r.property()],L.prototype,"headerRenderFunction",void 0),t.__decorate([r.property()],L.prototype,"inputRenderFunction",void 0),t.__decorate([r.property()],L.prototype,"layer",void 0),t.__decorate([r.property({readOnly:!0})],L.prototype,"loadingMessage",null),t.__decorate([r.property()],L.prototype,"maxLength",null),t.__decorate([r.property()],L.prototype,"minLength",null),t.__decorate([r.property({readOnly:!0})],L.prototype,"name",null),t.__decorate([r.property({readOnly:!0})],L.prototype,"nullable",null),t.__decorate([r.property()],L.prototype,"parseInputValueFunction",void 0),t.__decorate([r.property({readOnly:!0})],L.prototype,"path",null),t.__decorate([r.property({readOnly:!0})],L.prototype,"required",null),t.__decorate([r.property()],L.prototype,"sortable",null),t.__decorate([r.property()],L.prototype,"store",void 0),t.__decorate([r.property()],L.prototype,"template",void 0),t.__decorate([r.property()],L.prototype,"updateRowItemFunction",void 0),t.__decorate([r.property()],L.prototype,"updateStoreItemFunction",void 0),L=t.__decorate([l.subclass("esri.widgets.FeatureTable.FieldColumn")],L);return L}));
