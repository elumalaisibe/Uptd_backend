/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe"],(function(t,e){"use strict";return function(){function n(t,e){this._lastId=-1,this._progress=e,this._parent=t}var s=n.prototype;return s.reset=function(){this._lastId=-1},s.nextBatch=function(t){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((e=>this.nextBatch(t)),(e=>this.nextBatch(t)));const n={returnpromise:null,hasset:!1},s=[];return n.returnpromise=new Promise(((a,r)=>{this._parent._getSet(this._progress).then((i=>{const h=e.unwrapOrThrow(i._known,"known");let _=h.length-1;if("GETPAGES"===h[h.length-1]&&(_-=1),this._lastId+t>_&&h.length>0&&"GETPAGES"===h[h.length-1])return void this._parent._expandPagedSet(i,this._parent._maxQueryRate(),0,0,this._progress).then((e=>{n.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(t).then(a,r)}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}));const l=e.unwrapOrThrow(i._candidates,"candidates");if(_>=this._lastId+t||0===l.length){for(let e=0;e<t;e++){const t=e+this._lastId+1;if(t>=h.length)break;s[e]=h[t]}return this._lastId+=s.length,0===s.length&&(n.hasset=!0,this._parent._mainSetInUse=null,a([])),void this._parent._getFeatureBatch(s,this._progress).then((t=>{n.hasset=!0,this._parent._mainSetInUse=null,a(t)}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}))}this._parent._refineSetBlock(i,this._parent._maxProcessingRate(),this._progress).then((()=>{n.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(t).then(a,r)}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}))}),(t=>{n.hasset=!0,this._parent._mainSetInUse=null,r(t)}))})),!1===n.hasset&&(this._parent._mainSetInUse=n.returnpromise,n.hasset=!0),n.returnpromise},s.next=function(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((t=>this.next()),(t=>this.next()));const t={returnpromise:null,hasset:!1};return t.returnpromise=new Promise(((n,s)=>{this._parent._getSet(this._progress).then((a=>{const r=e.unwrapOrThrow(a._known,"known");if(this._lastId<r.length-1)"GETPAGES"===r[this._lastId+1]?this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,0,this._progress).then((e=>(t.hasset=!0,this._parent._mainSetInUse=null,this.next()))).then(n,s):(this._lastId+=1,this._parent._getFeature(a,r[this._lastId],this._progress).then((e=>{t.hasset=!0,this._parent._mainSetInUse=null,n(e)}),(e=>{t.hasset=!0,this._parent._mainSetInUse=null,s(e)})));else{e.unwrapOrThrow(a._candidates,"candidates").length>0?this._parent._refineSetBlock(a,this._parent._maxProcessingRate(),this._progress).then((()=>{t.hasset=!0,this._parent._mainSetInUse=null,this.next().then(n,s)}),(e=>{t.hasset=!0,this._parent._mainSetInUse=null,s(e)})):(t.hasset=!0,this._parent._mainSetInUse=null,n(null))}}),(e=>{t.hasset=!0,this._parent._mainSetInUse=null,s(e)}))})),!1===t.hasset&&(this._parent._mainSetInUse=t.returnpromise,t.hasset=!0),t.returnpromise},s.count=async function(){if(-1!==this._parent._totalCount)return this._parent._totalCount;const t=await this._parent._getSet(this._progress),e=await this._refineAllSets(t);return this._parent._totalCount=e._known.length,this._parent._totalCount},s._refineAllSets=async function(t){if(t._known.length>0&&"GETPAGES"===t._known[t._known.length-1])return await this._parent._expandPagedSet(t,this._parent._maxQueryRate(),0,1,this._progress),this._refineAllSets(t);if(t._candidates.length>0){if("GETPAGES"===t._known[t._candidates.length-1])return await this._parent._expandPagedSet(t,this._parent._maxQueryRate(),0,2,this._progress),this._refineAllSets(t);const e=await this._parent._refineSetBlock(t,this._parent._maxProcessingRate(),this._progress);return e._candidates.length>0?this._refineAllSets(e):e}return t},t._createClass(n)}()}));
