/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/languageUtils","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/OrderbyClause"],(function(e,t,n,r,i,a){"use strict";return function(s){function u(e){var t;return(t=s.call(this,e)||this)._orderbyclause=null,t.declaredClass="esri.arcade.featureset.actions.OrderBy",t._maxProcessing=100,t._orderbyclause=e.orderbyclause,t._parent=e.parentfeatureset,t}e._inherits(u,s);var o=u.prototype;return o._getSet=async function(e){if(null===this._wset){await this._ensureLoaded();const t=await this._getFilteredSet("",null,null,this._orderbyclause,e);return this._checkCancelled(e),this._wset=t,this._wset}return this._wset},o.manualOrderSet=async function(e,t){const n=await this.getIdColumnDictionary(e,[],-1,t);this._orderbyclause?.order(n);const r=new i([],[],!0,null);for(let i=0;i<n.length;i++)r._known.push(n[i].id);return r},o.getIdColumnDictionary=async function(e,n,r,i){if(r<e._known.length-1){const a=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return await t.tick(this._parent._expandPagedSet(e,a,0,0,i)),this.getIdColumnDictionary(e,n,r,i);let s=r+1;const u=[];for(;s<e._known.length&&"GETPAGES"!==e._known[s];)u.push(e._known[s]),s++;r+=u.length;const o=await t.tick(this._parent._getFeatureBatch(u,i));this._checkCancelled(i);for(const e of o)n.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(e,n,r,i)}return e._candidates.length>0?(await t.tick(this._refineSetBlock(e,this._maxProcessingRate(),i)),this._checkCancelled(i),this.getIdColumnDictionary(e,n,r,i)):n},o._isInFeatureSet=function(e){return this._parent._isInFeatureSet(e)},o._getFeatures=function(e,t,n,r){return this._parent._getFeatures(e,t,n,r)},o._featureFromCache=function(e){if(void 0===this._featureCache[e]){const t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]},o._fetchAndRefineFeatures=async function(){throw new n.FeatureSetError(n.FeatureSetErrorCodes.NeverReach)},o._getFilteredSet=async function(e,t,n,r,a){await this._ensureLoaded();const s=await this._parent._getFilteredSet(e,t,n,null===r?this._orderbyclause:r,a);this._checkCancelled(a);const u=new i(s._candidates.slice(0),s._known.slice(0),s._ordered,this._clonePageDefinition(s.pagesDefinition));let o=!0;if(s._candidates.length>0&&(o=!1),!1===u._ordered){let e=await this.manualOrderSet(u,a);return!1===o&&(null===t&&null===n||(e=new i(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)))),e}return u},u.registerAction=function(){r._featuresetFunctions.orderBy=function(e){return""===e?this:new u({parentfeatureset:this,orderbyclause:new a(e)})}},e._createClass(u)}(r)}));
