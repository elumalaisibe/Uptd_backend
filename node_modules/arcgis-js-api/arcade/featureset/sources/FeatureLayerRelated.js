/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../Graphic","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared","../../../rest/support/RelationshipQuery"],(function(e,t,i,r,s,n,a){"use strict";return function(r){function l(e){var t;return(t=r.call(this,e)||this).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",t._findObjectId=-1,t._requestStandardised=!1,t._removeGeometry=!1,t._overrideFields=null,t.featureObjectId=null,e.spatialReference&&(t.spatialReference=e.spatialReference),t._transparent=!0,t._maxProcessing=1e3,t._layer=e.layer,t._wset=null,t._findObjectId=e.objectId,t.featureObjectId=e.objectId,t.relationship=e.relationship,t._relatedLayer=e.relatedLayer,void 0!==e.outFields&&(t._overrideFields=e.outFields),void 0!==e.includeGeometry&&(t._removeGeometry=!1===e.includeGeometry),t}e._inherits(l,r);var d=l.prototype;return d._maxQueryRate=function(){return n.defaultMaxRecords},d.end=function(){return this._layer},d.optimisePagingFeatureQueries=function(){},d.loadImpl=async function(){return await Promise.all([this._layer.load(),this._relatedLayer?.load()]),this._initialiseFeatureSet(),this},d.nativeCapabilities=function(){return this._relatedLayer.nativeCapabilities()},d._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const i of this.fields)if("oid"===i.type)e.push(i),t.push(i.name);else for(const r of this._overrideFields)if(r.toLowerCase()===i.name.toLowerCase()){e.push(i),t.push(i.name);break}this.fields=e,this._overrideFields=t}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types},d.databaseType=async function(){return await this._relatedLayer.databaseType(),this._databaseType=this._relatedLayer._databaseType,this._databaseType},d.isTable=function(){return this._relatedLayer.isTable()},d._isInFeatureSet=function(){return n.IdState.InFeatureSet},d._candidateIdTransform=function(e){return e},d._getSet=async function(e){if(null===this._wset){await this._ensureLoaded();const t=await this._getFilteredSet("",null,null,null,e);return this._wset=t,t}return this._wset},d._changeFeature=function(e){const i={};for(const t of this.fields)i[t.name]=e.attributes[t.name];return new t({geometry:!0===this._removeGeometry?null:e.geometry,attributes:i})},d._getFilteredSet=async function(e,t,i,r,n){if(await this.databaseType(),this.isTable()&&t&&null!==e&&""!==e){return new s([],[],!0,null)}const l=this._layer.nativeCapabilities();if(!1===l.canQueryRelated){return new s([],[],!0,null)}if(l.capabilities?.queryRelated&&l.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,i,r,n);let d="",o=!1;null!==r&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(d=r.constructClause(),o=!0);const u=new a;u.objectIds=[this._findObjectId];const c=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((e=>e.name)):["*"]);u.outFields=c,u.relationshipId=this.relationship.id,u.where="1=1";let h=!0;!0===this._removeGeometry&&(h=!1),u.returnGeometry=h,this._requestStandardised&&(u.sqlFormat="standard"),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==d?d.split(","):null;const f=await l.source.queryRelatedFeatures(u);this._checkCancelled(n);const y=f[this._findObjectId]?f[this._findObjectId].features:[],_=[];for(let s=0;s<y.length;s++)this._featureCache[y[s].attributes[this._relatedLayer.objectIdField]]=y[s],_.push(y[s].attributes[this._relatedLayer.objectIdField]);const p=t&&null!==e&&""!==e,g=null!=i;return new s(p||g?_:[],p||g?[]:_,o,null)},d._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let i=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){i=!0;break}return!1===i&&t.push(this.objectIdField),t},d._getFilteredSetUsingPaging=async function(e,t,i,r,n){let a="",l=!1;const d=this._layer.nativeCapabilities();null!==r&&d&&d.capabilities?.queryRelated&&!0===d.capabilities.queryRelated.supportsOrderBy&&(a=r.constructClause(),l=!0),await this.databaseType();const o="1=1";let u=this._maxQueryRate();const c=d.capabilities?.query.maxRecordCount;null!=c&&c<u&&(u=c);const h=t&&null!==e&&""!==e,f=null!=i;let y=null,_=!0;!0===this._removeGeometry&&(_=!1);const p=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((e=>e.name)):["*"]);return y=new s(h||f?["GETPAGES"]:[],h||f?[]:["GETPAGES"],l,{outFields:p.join(","),resultRecordCount:u,resultOffset:0,objectIds:[this._findObjectId],where:o,orderByFields:a,returnGeometry:_,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),await this._expandPagedSet(y,u,0,0,n),y},d._expandPagedSet=function(e,t,i,r,s){return this._expandPagedSetFeatureSet(e,t,i,r,s)},d._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},d._getPhysicalPage=async function(e,t,i){const r=e.pagesDefinition.internal.lastRetrieved,s=r,n=e.pagesDefinition.internal.lastPage,l=this._layer.nativeCapabilities(),d=new a;!0===this._requestStandardised&&(d.sqlFormat="standard"),d.relationshipId=this.relationship.id,d.objectIds=e.pagesDefinition.objectIds,d.resultOffset=e.pagesDefinition.internal.lastPage,d.resultRecordCount=e.pagesDefinition.resultRecordCount,d.outFields=e.pagesDefinition.outFields.split(","),d.where=e.pagesDefinition.where,d.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,d.returnGeometry=e.pagesDefinition.returnGeometry,d.outSpatialReference=this.spatialReference;const o=await l.source.queryRelatedFeatures(d);if(this._checkCancelled(i),e.pagesDefinition.internal.lastPage!==n)return 0;const u=o[this._findObjectId]?o[this._findObjectId].features:[];for(let a=0;a<u.length;a++)e.pagesDefinition.internal.set[s+a]=u[a].attributes[this._relatedLayer.objectIdField];for(let a=0;a<u.length;a++)this._featureCache[u[a].attributes[this._relatedLayer.objectIdField]]=u[a];const c=!o[this._findObjectId]||!1===o[this._findObjectId].exceededTransferLimit;return u.length!==e.pagesDefinition.resultRecordCount&&c&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=r+u.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,u.length},d._getFeatures=async function(e,t,r,s){const n=[];-1!==t&&void 0===this._featureCache[t]&&n.push(t);const a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return await this._expandPagedSet(e,a,0,0,s),this._getFeatures(e,t,r,s);let l=0;for(let i=e._lastFetchedIndex;i<e._known.length&&(l++,l<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[i]&&void 0===this._featureCache[e._known[i]]&&(e._known[i]!==t&&n.push(e._known[i]),n.length>r)))&&!(l>=r&&0===n.length);i++);if(0===n.length)return"success";throw new i.FeatureSetError(i.FeatureSetErrorCodes.MissingFeatures)},d._refineSetBlock=async function(e,t,i){return e},d._stat=async function(e,t,i,r,s,n,a){return{calculated:!1}},d._canDoAggregates=async function(e,t,i,r,s){return!1},d.relationshipMetaData=function(){return this._relatedLayer.relationshipMetaData()},d.serviceUrl=function(){return this._relatedLayer.serviceUrl()},d.queryAttachments=function(e,t,i,r,s){return this._relatedLayer.queryAttachments(e,t,i,r,s)},d.getFeatureByObjectId=function(e,t){return this._relatedLayer.getFeatureByObjectId(e,t)},d.getOwningSystemUrl=function(){return this._relatedLayer.getOwningSystemUrl()},d.getIdentityUser=function(){return this._relatedLayer.getIdentityUser()},d.getDataSourceFeatureSet=function(){return this._relatedLayer},e._createClass(l,[{key:"gdbVersion",get:function(){return this._relatedLayer.gdbVersion}},{key:"preferredTimeReference",get:function(){return this._relatedLayer?.preferredTimeReference??null}},{key:"dateFieldsTimeReference",get:function(){return this._relatedLayer?.dateFieldsTimeReference??null}},{key:"datesInUnknownTimezone",get:function(){return this._relatedLayer?.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){return this._relatedLayer?.editFieldsInfo??null}},{key:"timeInfo",get:function(){return this._relatedLayer?.timeInfo??null}}]),l}(r)}));
