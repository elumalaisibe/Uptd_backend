/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","./Dictionary","./ImmutableArray","../chunks/languageUtils","../geometry/Geometry","../geometry/Point","../geometry/support/jsonUtils","../layers/graphics/featureConversionUtils","./ArcadeDate","./executionError","./arcadeTimeUtils","./deepClone"],(function(e,t,i,r,n,s,o,a,l,u,c,f){"use strict";let d=function(){function f(){this.arcadeDeclaredClass="esri.arcade.Feature",this._optimizedGeomDefinition=null,this._geometry=null,this.attributes=null,this._layer=null,this._datesfixed=!0,this.dateTimeReferenceFieldIndex=null,this.contextTimeReference=null,this.immutable=!0,this._datefields=null,this.immutable=!0}f.createFromGraphic=function(e,t){const i=new f;return i.contextTimeReference=t??null,i._geometry=null!=e.geometry?e.geometry:null,void 0===e.attributes||null===e.attributes?i.attributes={}:i.attributes=e.attributes,e._sourceLayer?(i._layer=e._sourceLayer,i._datesfixed=!1):e._layer?(i._layer=e._layer,i._datesfixed=!1):e.layer&&"fields"in e.layer?(i._layer=e.layer,i._datesfixed=!1):e.sourceLayer&&"fields"in e.sourceLayer&&(i._layer=e.sourceLayer,i._datesfixed=!1),i._layer&&!1===i._datesfixed&&(void 0!==i._layer.dateTimeReferenceFieldIndex?i.dateTimeReferenceFieldIndex=i._layer.dateTimeReferenceFieldIndex:i.dateTimeReferenceFieldIndex=c.DateTimeReferenceFieldIndex.createFromLayer(i._layer)),i},f.createFromArcadeFeature=function(e){if(e instanceof f){const t=new f;return t._datesfixed=e._datesfixed,t.attributes=e.attributes,t._geometry=e._geometry,t._optimizedGeomDefinition=e._optimizedGeomDefinition,e._layer&&(t._layer=e._layer),t.dateTimeReferenceFieldIndex=e.dateTimeReferenceFieldIndex,t.contextTimeReference=e.contextTimeReference,t}const t={};for(const i of e.keys())t[i]=e.field(i);return f.createFromGraphicLikeObject(e.geometry(),t,e.fullSchema(),e.contextTimeReference)},f.createFromOptimisedFeature=function(e,t,i){const r=new f;return r._geometry=e.geometry?{geometry:e.geometry}:null,r._optimizedGeomDefinition=i,r.attributes=e.attributes||{},r._layer=t,r._datesfixed=!1,r},f.createFromArcadeDictionary=function(e){const i=new f;return i.attributes=e.field("attributes"),null!==i.attributes&&i.attributes instanceof t?(i.attributes=i.attributes.attributes,null===i.attributes&&(i.attributes={})):i.attributes={},i._geometry=e.field("geometry"),null!==i._geometry&&(i._geometry instanceof t?i._geometry=f.parseGeometryFromDictionary(i._geometry):i._geometry instanceof n||(i._geometry=null)),i},f.createFromGraphicLikeObject=function(e,t,i=null,r){const n=new f;return n.contextTimeReference=r??null,null===t&&(t={}),n.attributes=t,n._geometry=null!=e?e:null,n._layer=i,n._layer&&(n._datesfixed=!1,void 0!==n._layer.dateTimeReferenceFieldIndex?n.dateTimeReferenceFieldIndex=n._layer.dateTimeReferenceFieldIndex:n.dateTimeReferenceFieldIndex=c.DateTimeReferenceFieldIndex.createFromLayer(n._layer)),n};var d=f.prototype;return d.repurposeFromGraphicLikeObject=function(e,t,i=null){null===t&&(t={}),this.attributes=t,this._geometry=e??null,this._layer=i,this._layer?this._datesfixed=!1:this._datesfixed=!0},d.fieldSourceTimeZone=function(e){return this.dateTimeReferenceFieldIndex?.fieldTimeZone(e)??""},d.castToText=function(e=!1){let t="";!1===this._datesfixed&&this._fixDates();for(const s in this.attributes){""!==t&&(t+=",");const o=this.attributes[s];null==o?t+=JSON.stringify(s)+":null":r.isBoolean(o)||r.isNumber(o)||r.isString(o)?t+=JSON.stringify(s)+":"+JSON.stringify(o):o instanceof n?t+=JSON.stringify(s)+":"+r.toStringExplicit(o):o instanceof i||o instanceof Array?t+=JSON.stringify(s)+":"+r.toStringExplicit(o,null,e):o instanceof l.ArcadeDate?t+=e?JSON.stringify(s)+":"+JSON.stringify(o.getTime()):JSON.stringify(s)+":"+o.stringify():null!==o&&"object"==typeof o&&void 0!==o.castToText&&(t+=JSON.stringify(s)+":"+o.castToText(e))}return'{"geometry":'+(null===this.geometry()?"null":r.toStringExplicit(this.geometry()))+',"attributes":{'+t+"}}"},d._fixDates=function(){if(null!==this._datefields)return this._datefields.length>0&&this._fixDateFields(this._datefields),void(this._datesfixed=!0);const e=[],t=this._layer.fields;for(let i=0;i<t.length;i++){const r=t[i],n=r.type;"date"!==n&&"esriFieldTypeDate"!==n||e.push(r.name)}this._datefields=e,e.length>0&&this._fixDateFields(e),this._datesfixed=!0},d.isUnknownDateTimeField=function(e){return"unknown"===this.dateTimeReferenceFieldIndex?.fieldTimeZone(e)},d._fixDateFields=function(e){this.attributes={...this.attributes};const t=this.contextTimeReference?.timeZone??"system";for(let i=0;i<e.length;i++){let n=this.attributes[e[i]];if(null===n);else if(void 0===n){for(const s in this.attributes)if(s.toLowerCase()===e[i].toLowerCase()){if(n=this.attributes[s],null!==n){const e=this.isUnknownDateTimeField(s);r.isDate(n)?this.attributes[s]=n:n instanceof Date?this.attributes[s]=e?l.ArcadeDate.unknownDateJSToArcadeDate(n):l.ArcadeDate.dateJSAndZoneToArcadeDate(n,t):this.attributes[s]=e?l.ArcadeDate.unknownEpochToArcadeDate(n):l.ArcadeDate.epochToArcadeDate(n,t)}break}}else{const s=this.isUnknownDateTimeField(e[i]);r.isDate(n)?this.attributes[e[i]]=n:n instanceof Date?this.attributes[e[i]]=s?l.ArcadeDate.unknownDateJSToArcadeDate(n):l.ArcadeDate.dateJSAndZoneToArcadeDate(n,t):this.attributes[e[i]]=s?l.ArcadeDate.unknownEpochToArcadeDate(n):l.ArcadeDate.epochToArcadeDate(n,t)}}},d.geometry=function(){return null===this._geometry||this._geometry instanceof n||(this._optimizedGeomDefinition?(this._geometry=o.fromJSON(a.convertToGeometry(this._geometry,this._optimizedGeomDefinition.geometryType,this._optimizedGeomDefinition.hasZ,this._optimizedGeomDefinition.hasM)),this._geometry.spatialReference=this._optimizedGeomDefinition.spatialReference):this._geometry=o.fromJSON(this._geometry)),this._geometry},d.field=function(e){!1===this._datesfixed&&this._fixDates();const t=this.attributes[e];if(void 0!==t)return t;const i=e.toLowerCase();for(const r in this.attributes)if(r.toLowerCase()===i)return this.attributes[r];if(this._hasFieldDefinition(i))return null;throw new u.ArcadeExecutionError(null,u.ExecutionErrorCodes.FieldNotFound,null,{key:e})},d._hasFieldDefinition=function(e){if(null===this._layer)return!1;for(let t=0;t<this._layer.fields.length;t++){if(this._layer.fields[t].name.toLowerCase()===e)return!0}return!1},d.setField=function(e,t){if(this.immutable)throw new u.ArcadeExecutionError(null,u.ExecutionErrorCodes.Immutable,null);if(t instanceof Date&&(t=this.isUnknownDateTimeField(e)?l.ArcadeDate.unknownDateJSToArcadeDate(t):l.ArcadeDate.dateJSToArcadeDate(t)),!1===r.isSimpleType(t))throw new u.ArcadeExecutionError(null,u.ExecutionErrorCodes.TypeNotAllowedInFeature,null);const i=e.toLowerCase();if(void 0===this.attributes[e]){for(const e in this.attributes)if(e.toLowerCase()===i)return void(this.attributes[e]=t);this.attributes[e]=t}else this.attributes[e]=t},d.hasField=function(e){const t=e.toLowerCase();if(void 0!==this.attributes[e])return!0;for(const i in this.attributes)if(i.toLowerCase()===t)return!0;return!!this._hasFieldDefinition(t)},d.keys=function(){let e=[];const t={};for(const i in this.attributes)e.push(i),t[i.toLowerCase()]=1;if(null!==this._layer)for(let i=0;i<this._layer.fields.length;i++){const r=this._layer.fields[i];1!==t[r.name.toLowerCase()]&&e.push(r.name)}return e=e.sort(),e},f.parseGeometryFromDictionary=function(e){const t=f._convertDictionaryToJson(e,!0);return void 0!==t.hasm&&(t.hasM=t.hasm,delete t.hasm),void 0!==t.hasz&&(t.hasZ=t.hasz,delete t.hasz),void 0!==t.spatialreference&&(t.spatialReference=t.spatialreference,delete t.spatialreference),void 0!==t.rings&&(t.rings=this._fixPathArrays(t.rings,!0===t.hasZ,!0===t.hasZ)),void 0!==t.paths&&(t.paths=this._fixPathArrays(t.paths,!0===t.hasZ,!0===t.hasM)),void 0!==t.points&&(t.points=this._fixPointArrays(t.points,!0===t.hasZ,!0===t.hasM)),o.fromJSON(t)},f._fixPathArrays=function(e,t,r){const n=[];if(e instanceof Array)for(let i=0;i<e.length;i++)n.push(this._fixPointArrays(e[i],t,r));else if(e instanceof i)for(let i=0;i<e.length();i++)n.push(this._fixPointArrays(e.get(i),t,r));return n},f._fixPointArrays=function(e,t,r){const n=[];if(e instanceof Array)for(let o=0;o<e.length;o++){const a=e[o];a instanceof s?t&&r?n.push([a.x,a.y,a.z,a.m]):t?n.push([a.x,a.y,a.z]):r?n.push([a.x,a.y,a.m]):n.push([a.x,a.y]):a instanceof i?n.push(a.toArray()):n.push(a)}else if(e instanceof i)for(let o=0;o<e.length();o++){const a=e.get(o);a instanceof s?t&&r?n.push([a.x,a.y,a.z,a.m]):t?n.push([a.x,a.y,a.z]):r?n.push([a.x,a.y,a.m]):n.push([a.x,a.y]):a instanceof i?n.push(a.toArray()):n.push(a)}return n},f._convertDictionaryToJson=function(e,i=!1){const r={};for(const n in e.attributes){let s=e.attributes[n];s instanceof t&&(s=f._convertDictionaryToJson(s)),i?r[n.toLowerCase()]=s:r[n]=s}return r},f.parseAttributesFromDictionary=function(e){const t={};for(const i in e.attributes){const n=e.attributes[i];if(!r.isSimpleType(n))throw new u.ArcadeExecutionError(null,u.ExecutionErrorCodes.InvalidParameter,null);t[i]=n}return t},f.fromJson=function(e,t){let i=null;null!==e.geometry&&void 0!==e.geometry&&(i=o.fromJSON(e.geometry));const n={};if(null!==e.attributes&&void 0!==e.attributes)for(const s in e.attributes){const t=e.attributes[s];if(null===t)n[s]=t;else{if(!(r.isString(t)||r.isNumber(t)||r.isBoolean(t)||r.isDate(t)))throw new u.ArcadeExecutionError(null,u.ExecutionErrorCodes.InvalidParameter,null);n[s]=t}}return f.createFromGraphicLikeObject(i,n,null,t??null)},d.fullSchema=function(){return this._layer},d.gdbVersion=function(){if(null===this._layer)return"";const e=this._layer.gdbVersion;return void 0===e?"":""===e&&this._layer.capabilities&&this._layer.capabilities.isVersioned?"SDE.DEFAULT":e},d.castAsJson=function(e){const t={attributes:{},geometry:!0===e?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null};for(const i in this.attributes){const n=this.attributes[i];void 0!==n&&(t.attributes[i]=r.castAsJson(n,e))}return t},d.castAsJsonAsync=async function(e=null,t){return this.castAsJson(t)},e._createClass(f,[{key:"layerPreferredTimeZone",get:function(){return this.dateTimeReferenceFieldIndex?.layerPreferredTimeZone??""}}]),f}();return f.configureDeepClone(d),d}));
