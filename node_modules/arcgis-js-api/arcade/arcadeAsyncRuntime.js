/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","./ArcadeModule","./ArcadeModuleLoader","./Dictionary","./executionError","./Feature","./FunctionWrapper","../chunks/languageUtils","./treeAnalysis","../chunks/array","./functions/date","./functions/geomasync","./functions/geometry","./functions/maths","./functions/stats","./functions/string","../geometry/Geometry","../geometry/SpatialReference"],(function(e,r,t,o,n,i,a,c,u,s,l,d,f,E,p,w,x,h,m){"use strict";function g(e){return e&&"function"==typeof e.then}const v=100;async function y(e,r){const t=[];for(let o=0;o<r.arguments.length;o++)t.push(await R(e,r.arguments[o]));return t}async function b(e,r,t){if(!0===r.preparsed)return t(e,null,r.arguments);return t(e,r,await y(e,r))}let A=function(e){function t(r,t){var o;return(o=e.call(this)||this).definition=null,o.context=null,o.definition=r,o.context=t,o}r._inherits(t,e);var o=t.prototype;return o.createFunction=function(e){return(...r)=>{const t={spatialReference:this.context.spatialReference,console:this.context.console,lrucache:this.context.lrucache,timeReference:this.context.timeReference??null,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,localScope:{},depthCounter:{depth:e.depthCounter+1},globalScope:this.context.globalScope};if(t.depthCounter.depth>64)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.MaximumCallDepth,null);return Ee(this.definition,t,r,null)}},o.call=function(e,r){return S(e,r,((t,o,n)=>{const a={spatialReference:e.spatialReference,services:e.services,console:e.console,libraryResolver:e.libraryResolver,exports:e.exports,lrucache:e.lrucache,timeReference:e.timeReference??null,interceptor:e.interceptor,localScope:{},abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1}};if(a.depthCounter.depth>64)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.MaximumCallDepth,r);return Ee(this.definition,a,n,r)}))},o.marshalledCall=function(e,r,t,o){return o(e,r,(async(n,i,a)=>{const s={spatialReference:e.spatialReference,globalScope:t.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,abortSignal:e.abortSignal,lrucache:e.lrucache,timeReference:e.timeReference??null,interceptor:e.interceptor,localScope:{}};return a=a.map((r=>!u.isFunctionParameter(r)||r instanceof c.ScopeMarshalledFunction?r:c.wrapModuleScopedResponse(r,e,o))),c.wrapModuleScopedResponse(await Ee(this.definition,s,a,r),t,o)}))},r._createClass(t)}(c.ArcadeFunction),C=function(e){function t(r){return e.call(this,r)||this}r._inherits(t,e);var n=t.prototype;return n.global=async function(e){const r=this.executingContext.globalScope[e.toLowerCase()];if(r.valueset||(r.value=await R(this.executingContext,r.node),r.valueset=!0),u.isFunctionParameter(r.value)&&!(r.value instanceof c.ScopeMarshalledFunction)){const e=new c.ScopeMarshalledFunction;e.fn=r.value,e.parameterEvaluator=S,e.context=this.executingContext,r.value=e}return r.value},n.setGlobal=function(e,r){if(u.isFunctionParameter(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AssignModuleFunction,null);this.executingContext.globalScope[e.toLowerCase()]={value:r,valueset:!0,node:null}},n.hasGlobal=function(e){return void 0===this.executingContext.exports[e]&&(e=e.toLowerCase()),void 0!==this.executingContext.exports[e]},n.loadModule=async function(e){let r=e.spatialReference;null==r&&(r=new m({wkid:102100})),this.moduleScope=xe({},e.customfunctions,e.timeReference),this.executingContext={spatialReference:r,services:e.services,libraryResolver:new o.ArcadeModuleLoader(e.libraryResolver._moduleSingletons,this.source.syntax.loadedModules),exports:{},abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,globalScope:this.moduleScope,console:e.console??he,lrucache:e.lrucache,timeReference:e.timeReference??null,interceptor:e.interceptor,localScope:null,depthCounter:{depth:1}},await R(this.executingContext,this.source.syntax)},r._createClass(t)}(t.ArcadeModule);async function S(e,r,t){if(!0===r.preparsed){const o=t(e,null,r.arguments);return g(o),o}const o=t(e,r,await y(e,r));return g(o),o}async function R(e,r,t){if(r.breakpoint&&!0!==t){const t=r.breakpoint();return await t,R(e,r,!0)}try{switch(r?.type){case"VariableDeclarator":return await $(e,r);case"ImportDeclaration":return await Q(e,r);case"ExportNamedDeclaration":return await X(e,r);case"VariableDeclaration":return await Z(e,r,0);case"BlockStatement":case"Program":return await H(e,r);case"FunctionDeclaration":return await J(e,r);case"ReturnStatement":return await z(e,r);case"IfStatement":return await V(e,r);case"ExpressionStatement":return await W(e,r);case"UpdateExpression":return await G(e,r);case"AssignmentExpression":return await _(e,r);case"ForStatement":return await B(e,r);case"WhileStatement":return await N(e,r);case"ForInStatement":return await q(e,r);case"BreakStatement":return u.breakResult;case"EmptyStatement":return u.voidOperation;case"ContinueStatement":return u.continueResult;case"TemplateElement":return await ce(e,r);case"TemplateLiteral":return await se(e,r);case"Identifier":return await ie(e,r);case"MemberExpression":return await ee(e,r);case"Literal":return r.value;case"CallExpression":return await ae(e,r);case"UnaryExpression":return await re(e,r);case"BinaryExpression":return await oe(e,r);case"LogicalExpression":return await ne(e,r);case"ArrayExpression":return await te(e,r);case"ObjectExpression":return await F(e,r);case"Property":return await I(e,r);default:throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.Unrecognised,r)}}catch(o){throw i.ensureArcadeExecutionError(e,r,o)}}async function F(e,r){const t=[];for(let n=0;n<r.properties.length;n++)t[n]=await R(e,r.properties[n]);const o={},a=new Map;for(let n=0;n<t.length;n++){const c=t[n];if(u.isFunctionParameter(c.value))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.NoFunctionInDictionary,r);if(!1===u.isString(c.key))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.KeyMustBeString,r);let s=c.key.toString();const l=s.toLowerCase();a.has(l)?s=a.get(l):a.set(l,s),c.value===u.voidOperation?o[s]=null:o[s]=c.value}const c=new n(o);return c.immutable=!1,c}async function I(e,r){const t=await R(e,r.value);if("Identifier"===r.key.type)return{key:r.key.name,value:t};return{key:await R(e,r.key),value:t}}async function N(e,r){const t={testResult:!0,lastAction:u.voidOperation};if(t.testResult=await R(e,r.test),!1===t.testResult)return u.voidOperation;if(!0!==t.testResult)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.BooleanConditionRequired,r);for(;!0===t.testResult&&(t.lastAction=await R(e,r.body),t.lastAction!==u.breakResult)&&!(t.lastAction instanceof u.ReturnResult);)if(t.testResult=await R(e,r.test),!0!==t.testResult&&!1!==t.testResult)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.BooleanConditionRequired,r);return t.lastAction instanceof u.ReturnResult?t.lastAction:u.voidOperation}async function O(e,r,t){const o=await R(e,r.body);return t.lastAction=o,t.lastAction===u.breakResult||t.lastAction instanceof u.ReturnResult?(t.testResult=!1,t):null!==r.update?(await R(e,r.update),t):t}async function M(e,r,t){if(null!==r.test){const o=await R(e,r.test);if(!0===e.abortSignal?.aborted)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.Cancelled,r);if(t.testResult=o,!1===t.testResult)return t;if(!0!==t.testResult)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.BooleanConditionRequired,r);return O(e,r,t)}return O(e,r,t)}function k(e,r,t,o,n,i){try{M(e,r,t).then((()=>{try{!0===t.testResult?++i>v?(i=0,setTimeout((()=>{k(e,r,t,o,n,i)}),0)):k(e,r,t,o,n,i):t.lastAction instanceof u.ReturnResult?o(t.lastAction):o(u.voidOperation)}catch(a){n(a)}}),(e=>{n(e)}))}catch(a){n(a)}}function B(e,r){try{return null!==r.init?R(e,r.init).then((()=>new Promise(((t,o)=>{const n={testResult:!0,lastAction:u.voidOperation};k(e,r,n,(e=>{t(e)}),(e=>{o(e)}),0)})))):new Promise(((t,o)=>{const n={testResult:!0,lastAction:u.voidOperation};k(e,r,n,(e=>{t(e)}),(e=>{o(e)}),0)}))}catch(t){return Promise.reject(t)}}function L(e,r,t,o,n,i,a,c,s,l){try{if(o<=i)return void c(u.voidOperation);n.value="k"===a?t[i]:i,R(e,r.body).then((d=>{try{d instanceof u.ReturnResult?c(d):d===u.breakResult?c(u.voidOperation):++l>v?(l=0,setTimeout((()=>{L(e,r,t,o,n,i+1,a,c,s,l)}),0)):L(e,r,t,o,n,i+1,a,c,s,l)}catch(f){s(f)}}),(e=>{s(e)}))}catch(d){s(d)}}function P(e,r,t,o,n,i,a,c,s){try{if(t.length()<=n)return void a(u.voidOperation);o.value="k"===i?t.get(n):n,R(e,r.body).then((l=>{l instanceof u.ReturnResult?a(l):l===u.breakResult?a(u.voidOperation):++s>v?(s=0,setTimeout((()=>{P(e,r,t,o,n+1,i,a,c,s)}),0)):P(e,r,t,o,n+1,i,a,c,s)}),(e=>{c(e)}))}catch(l){c(l)}}function j(e,r,t,o,n,i){try{if(void 0===i&&(i="i"),0===t.length)return void o.resolve(u.voidOperation);L(e,r,t,t.length,n,0,i,(e=>{o.resolve(e)}),(e=>{o.reject(e)}),0)}catch(a){o.reject(a)}}function T(e,r,t,o,n,i){try{if(void 0===i&&(i="i"),0===t.length)return void o.resolve(u.voidOperation);P(e,r,t,n,0,i,(e=>{o.resolve(e)}),(e=>{o.reject(e)}),0)}catch(a){o.reject(a)}}function K(e,r,t,o,n){try{j(e,r,t.keys(),o,n,"k")}catch(i){o.reject(i)}}function D(e,r,t,o,n,i,c,s){try{e.next().then((l=>{try{if(null===l)i(u.voidOperation);else{const d=a.createFromGraphicLikeObject(l.geometry,l.attributes,o,r.timeReference);d._underlyingGraphic=l,n.value=d;R(r,t.body).then((a=>{try{a===u.breakResult?i(u.voidOperation):a instanceof u.ReturnResult?i(a):++s>v?(s=0,setTimeout((()=>{D(e,r,t,o,n,i,c,s)}),0)):D(e,r,t,o,n,i,c,s)}catch(l){c(l)}}),(e=>{c(e)}))}}catch(d){c(d)}}),(e=>{c(e)}))}catch(l){c(l)}}async function q(e,r){return new Promise(((t,o)=>{R(e,r.right).then((a=>{try{let c=null;c="VariableDeclaration"===r.left.type?R(e,r.left):Promise.resolve(),c.then((()=>{try{let c="";if("VariableDeclaration"===r.left.type){const e=r.left.declarations[0].id;"Identifier"===e.type&&(c=e.name)}else"Identifier"===r.left.type&&(c=r.left.name);if(!c)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r);c=c.toLowerCase();let s=null;if(null!=e.localScope&&void 0!==e.localScope[c]&&(s=e.localScope[c]),null===s&&void 0!==e.globalScope[c]&&(s=e.globalScope[c]),null===s)return void o(new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r));u.isArray(a)||u.isString(a)?j(e,r,a,{reject:o,resolve:t},s):u.isImmutableArray(a)?T(e,r,a,{reject:o,resolve:t},s):a instanceof n||u.isFeature(a)?K(e,r,a,{reject:o,resolve:t},s):u.isFeatureSet(a)?D(a.iterator(e.abortSignal),e,r,a,s,(e=>{t(e)}),(e=>{o(e)}),0):j(e,r,[],{reject:o,resolve:t},s)}catch(c){o(c)}}),o)}catch(c){o(c)}}),o)}))}async function G(e,r){const t=r.argument;if("MemberExpression"===t.type){const o={t:null},a=await R(e,t.object);let c=null;o.t=a,!0===t.computed?c=await R(e,t.property):"Identifier"===t.property.type&&(c=t.property.name);const s=o.t;let l;if(u.isArray(s)){if(!u.isNumber(c))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.ArrayAccessorMustBeNumber,r);if(c<0&&(c=s.length+c),c<0||c>=s.length)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.OutOfBounds,r);l=u.toNumber(s[c]),s[c]="++"===r.operator?l+1:l-1}else if(s instanceof n){if(!1===u.isString(c))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==s.hasField(c))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FieldNotFound,r,{key:c});l=u.toNumber(s.field(c)),s.setField(c,"++"===r.operator?l+1:l-1)}else if(s instanceof C){if(!1===u.isString(c))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.ModuleAccessorMustBeString,r);if(!0!==s.hasGlobal(c))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.ModuleExportNotFound,r);l=u.toNumber(await s.global(c)),s.setGlobal(c,"++"===r.operator?l+1:l-1)}else{if(!u.isFeature(s))throw u.isImmutableArray(s)?new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.Immutable,r):new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidParameter,r);if(!1===u.isString(c))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==s.hasField(c))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FieldNotFound,r,{key:c});l=u.toNumber(s.field(c)),s.setField(c,"++"===r.operator?l+1:l-1)}return!1===r.prefix?l:"++"===r.operator?l+1:l-1}const o="Identifier"===r.argument.type?r.argument.name.toLowerCase():"";if(!o)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r);let a;if(null!=e.localScope&&void 0!==e.localScope[o])return a=u.toNumber(e.localScope[o].value),e.localScope[o]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},!1===r.prefix?a:"++"===r.operator?a+1:a-1;if(void 0!==e.globalScope[o])return a=u.toNumber(e.globalScope[o].value),e.globalScope[o]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},!1===r.prefix?a:"++"===r.operator?a+1:a-1;throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r)}function U(e,r,t,o,n){switch(r){case"=":return e===u.voidOperation?null:e;case"/=":return u.toNumber(t)/u.toNumber(e);case"*=":return u.toNumber(t)*u.toNumber(e);case"-=":return u.toNumber(t)-u.toNumber(e);case"+=":return u.isString(t)||u.isString(e)?u.toString(t)+u.toString(e):u.toNumber(t)+u.toNumber(e);case"%=":return u.toNumber(t)%u.toNumber(e);default:throw new i.ArcadeExecutionError(n,i.ExecutionErrorCodes.UnsupportedOperator,o)}}async function _(e,r){const t=r.left;if("MemberExpression"===t.type){const o=await R(e,t.object);let a=null;if(!0===t.computed)a=await R(e,t.property);else{if("Identifier"!==t.property.type)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r);a=t.property.name}const c=await R(e,r.right);if(u.isArray(o)){if(!u.isNumber(a))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.ArrayAccessorMustBeNumber,r);if(a<0&&(a=o.length+a),a<0||a>o.length)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.OutOfBounds,r);if(a===o.length){if("="!==r.operator)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.OutOfBounds,r);o[a]=U(c,r.operator,o[a],r,e)}else o[a]=U(c,r.operator,o[a],r,e)}else if(o instanceof n){if(!1===u.isString(a))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0===o.hasField(a))o.setField(a,U(c,r.operator,o.field(a),r,e));else{if("="!==r.operator)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FieldNotFound,r,{key:a});o.setField(a,U(c,r.operator,null,r,e))}}else if(o instanceof C){if(!1===u.isString(a))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0!==o.hasGlobal(a))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.ModuleExportNotFound,r);o.setGlobal(a,U(c,r.operator,await o.global(a),r,e))}else{if(!u.isFeature(o))throw u.isImmutableArray(o)?new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.Immutable,r):new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidParameter,r);if(!1===u.isString(a))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.KeyAccessorMustBeString,r);if(!0===o.hasField(a))o.setField(a,U(c,r.operator,o.field(a),r,e));else{if("="!==r.operator)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FieldNotFound,r,{key:a});o.setField(a,U(c,r.operator,null,r,e))}}return u.voidOperation}const o=t.name.toLowerCase();if(null!=e.localScope&&void 0!==e.localScope[o]){const t=await R(e,r.right);return e.localScope[o]={value:U(t,r.operator,e.localScope[o].value,r,e),valueset:!0,node:r.right},u.voidOperation}if(void 0!==e.globalScope[o]){const t=await R(e,r.right);return e.globalScope[o]={value:U(t,r.operator,e.globalScope[o].value,r,e),valueset:!0,node:r.right},u.voidOperation}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r)}async function W(e,r){if("AssignmentExpression"===r.expression.type)return R(e,r.expression);if("CallExpression"===r.expression.type){const t=await R(e,r.expression);return t===u.voidOperation?u.voidOperation:new u.ImplicitResult(t)}const t=await R(e,r.expression);return t===u.voidOperation?u.voidOperation:new u.ImplicitResult(t)}async function V(e,r){const t=await R(e,r.test);if(!0===t)return R(e,r.consequent);if(!1===t)return null!==r.alternate?R(e,r.alternate):u.voidOperation;throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.BooleanConditionRequired,r)}async function H(e,r){return Y(e,r,0)}async function Y(e,r,t){if(t>=r.body.length)return u.voidOperation;const o=await R(e,r.body[t]);return o instanceof u.ReturnResult||o===u.breakResult||o===u.continueResult||t===r.body.length-1?o:Y(e,r,t+1)}async function z(e,r){if(null===r.argument)return new u.ReturnResult(u.voidOperation);const t=await R(e,r.argument);return new u.ReturnResult(t)}async function J(e,r){const t=r.id.name.toLowerCase();return e.globalScope[t]={valueset:!0,node:null,value:new A(r,e)},u.voidOperation}async function Q(e,r){const t=r.specifiers[0].local.name.toLowerCase(),o=e.libraryResolver.loadLibrary(t);let n=null;return e.libraryResolver._moduleSingletons?.has(o.uri)?n=e.libraryResolver._moduleSingletons.get(o.uri):(n=new C(o),await n.loadModule(e),e.libraryResolver._moduleSingletons?.set(o.uri,n)),e.globalScope[t]={value:n,valueset:!0,node:r},u.voidOperation}async function X(e,r){if(await R(e,r.declaration),"FunctionDeclaration"===r.declaration.type)e.exports[r.declaration.id.name.toLowerCase()]="function";else if("VariableDeclaration"===r.declaration.type)for(const t of r.declaration.declarations)e.exports[t.id.name.toLowerCase()]="variable";return u.voidOperation}async function Z(e,r,t){return t>=r.declarations.length?u.voidOperation:(await R(e,r.declarations[t]),t===r.declarations.length-1||await Z(e,r,t+1),u.voidOperation)}async function $(e,r){let t=null;if(t=null===r.init?null:await R(e,r.init),null!==e.localScope){if(t===u.voidOperation&&(t=null),"Identifier"!==r.id.type)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r);const o=r.id.name.toLowerCase();return null!=e.localScope&&(e.localScope[o]={value:t,valueset:!0,node:r.init}),u.voidOperation}if("Identifier"!==r.id.type)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r);const o=r.id.name.toLowerCase();return t===u.voidOperation&&(t=null),e.globalScope[o]={value:t,valueset:!0,node:r.init},u.voidOperation}async function ee(e,r){const t=await R(e,r.object);if(null===t)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.MemberOfNull,r);if(!1===r.computed){if("Identifier"===r.property.type){if(t instanceof n||u.isFeature(t))return t.field(r.property.name);if(t instanceof h)return E.geometryMember(t,r.property.name,e,r);if(t instanceof C){if(!t.hasGlobal(r.property.name))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r);return t.global(r.property.name)}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}let o=await R(e,r.property);if(t instanceof n||u.isFeature(t)){if(u.isString(o))return t.field(o);throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof C){if(u.isString(o))return t.global(o);throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof h){if(u.isString(o))return E.geometryMember(t,o,e,r);throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(u.isArray(t)){if(u.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(u.isImmutableArray(t)){if(u.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length()+o),o>=t.length()||o<0)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.OutOfBounds,r);return t.get(o)}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(u.isString(t)){if(u.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidMemberAccessKey,r)}async function re(e,r){const t=await R(e,r.argument);if(u.isBoolean(t)){if("!"===r.operator)return!t;if("-"===r.operator)return-1*u.toNumber(t);if("+"===r.operator)return 1*u.toNumber(t);if("~"===r.operator)return~u.toNumber(t);throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}if("-"===r.operator)return-1*u.toNumber(t);if("+"===r.operator)return 1*u.toNumber(t);if("~"===r.operator)return~u.toNumber(t);throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}async function te(e,r){const t=[];for(let o=0;o<r.elements.length;o++)t.push(await R(e,r.elements[o]));for(let o=0;o<t.length;o++){if(u.isFunctionParameter(t[o]))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.NoFunctionInArray,r);t[o]===u.voidOperation&&(t[o]=null)}return t}async function oe(e,r){const t=[];t[0]=await R(e,r.left),t[1]=await R(e,r.right);const o=t[0],n=t[1];switch(r.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return u.binaryOperator(u.toNumber(o),u.toNumber(n),r.operator);case"==":return u.equalityTest(o,n);case"!=":return!u.equalityTest(o,n);case"<":case">":case"<=":case">=":return u.greaterThanLessThan(o,n,r.operator);case"+":return u.isString(o)||u.isString(n)?u.toString(o)+u.toString(n):u.toNumber(o)+u.toNumber(n);case"-":return u.toNumber(o)-u.toNumber(n);case"*":return u.toNumber(o)*u.toNumber(n);case"/":return u.toNumber(o)/u.toNumber(n);case"%":return u.toNumber(o)%u.toNumber(n);default:throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.UnsupportedOperator,r)}}async function ne(e,r){const t=await R(e,r.left);let o=null;if(!u.isBoolean(t))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,r);switch(r.operator){case"||":if(!0===t)return t;if(o=await R(e,r.right),u.isBoolean(o))return o;throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.LogicExpressionOrAnd,r);case"&&":if(!1===t)return t;if(o=await R(e,r.right),u.isBoolean(o))return o;throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.LogicExpressionOrAnd,r);default:throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.LogicExpressionOrAnd,r)}}async function ie(e,r){const t=r.name.toLowerCase();if(null!=e.localScope&&void 0!==e.localScope[t]){const r=e.localScope[t];if(!0===r.valueset)return r.value;if(null!==r.d)return r.d;r.d=R(e,r.node);const o=await r.d;return r.value=o,r.valueset=!0,o}if(void 0!==e.globalScope[t]){const r=e.globalScope[t];if(!0===r.valueset)return r.value;if(null!==r.d)return r.d;r.d=R(e,r.node);const o=await r.d;return r.value=o,r.valueset=!0,o}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,r)}async function ae(e,r){if("MemberExpression"===r.callee.type){const t=await R(e,r.callee.object);if(!(t instanceof C))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FunctionNotFound,r);const o=!1===r.callee.computed?r.callee.property.name:await R(e,r.callee.property);if(!t.hasGlobal(o))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FunctionNotFound,r);const n=await t.global(o);if(!u.isFunctionParameter(n))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.CallNonFunction,r);return n.call(e,r)}if("Identifier"!==r.callee.type)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FunctionNotFound,r);if(null!=e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){const t=e.localScope[r.callee.name.toLowerCase()];if(u.isFunctionParameter(t.value))return t.value.call(e,r);throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.CallNonFunction,r)}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){const t=e.globalScope[r.callee.name.toLowerCase()];if(u.isFunctionParameter(t.value))return t.value.call(e,r);throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.CallNonFunction,r)}throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.FunctionNotFound,r)}async function ce(e,r){return r.value?r.value.cooked:""}function ue(e,r,t){if(u.isFunctionParameter(e))throw new i.ArcadeExecutionError(r,i.ExecutionErrorCodes.NoFunctionInTemplateLiteral,t);return e}async function se(e,r){const t=[];for(let i=0;i<r.expressions.length;i++){const o=await R(e,r.expressions[i]);t[i]=u.toString(o)}let o="",n=0;for(const i of r.quasis)if(o+=i.value?i.value.cooked:"",!1===i.tail){o+=t[n]?ue(t[n],e,r):"",n++}return o}const le={};async function de(e,r,t,o){const n=await R(e,r.arguments[t]);if(u.equalityTest(n,o))return R(e,r.arguments[t+1]);const i=r.arguments.length-t;return 1===i?R(e,r.arguments[t]):2===i?null:3===i?R(e,r.arguments[t+2]):de(e,r,t+2,o)}async function fe(e,r,t,o){if(!0===o)return R(e,r.arguments[t+1]);if(3===r.arguments.length-t)return R(e,r.arguments[t+2]);const n=await R(e,r.arguments[t+2]);if(!1===u.isBoolean(n))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.ModuleExportNotFound,r.arguments[t+2]);return fe(e,r,t+2,n)}async function Ee(e,r,t,o){const n=e.body;if(t.length!==e.params.length)throw new i.ArcadeExecutionError(r,i.ExecutionErrorCodes.WrongNumberOfParameters,null);for(let i=0;i<t.length;i++){const o=e.params[i];"Identifier"===o.type&&null!=r.localScope&&(r.localScope[o.name.toLowerCase()]={d:null,value:t[i],valueset:!0,node:null})}const a=await R(r,n);if(a instanceof u.ReturnResult)return a.value;if(a===u.breakResult)throw new i.ArcadeExecutionError(r,i.ExecutionErrorCodes.UnexpectedToken,o);if(a===u.continueResult)throw new i.ArcadeExecutionError(r,i.ExecutionErrorCodes.UnexpectedToken,o);return a instanceof u.ImplicitResult?a.value:a}d.registerFunctions(le,b),x.registerFunctions(le,b),p.registerFunctions(le,b),E.registerFunctions(le,b),w.registerFunctions(le,b),f.registerFunctions({functions:le,compiled:!1,signatures:null,evaluateIdentifier:null,mode:"async",standardFunction:b,standardFunctionAsync:S}),le.iif=async function(e,r){u.pcCheck(null===r.arguments?[]:r.arguments,3,3,e,r);const t=await R(e,r.arguments[0]);if(!1===u.isBoolean(t))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.BooleanConditionRequired,r);return R(e,t?r.arguments[1]:r.arguments[2])},le.decode=async function(e,r){if(r.arguments.length<2)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.WrongNumberOfParameters,r);if(2===r.arguments.length)return R(e,r.arguments[1]);if((r.arguments.length-1)%2==0)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.WrongNumberOfParameters,r);return de(e,r,1,await R(e,r.arguments[0]))},le.when=async function(e,r){if(r.arguments.length<3)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.WrongNumberOfParameters,r);if(r.arguments.length%2==0)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.WrongNumberOfParameters,r);const t=await R(e,r.arguments[0]);if(!1===u.isBoolean(t))throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.BooleanConditionRequired,r.arguments[0]);return fe(e,r,0,t)};const pe={fixSpatialReference:u.fixSpatialReference,parseArguments:y,standardFunction:b,standardFunctionAsync:S,evaluateIdentifier:ie};for(const ye in le)le[ye]={value:new c.NativeFunction(le[ye]),valueset:!0,node:null};const we=function(){};function xe(e,r,t){const o=new we;null==e&&(e={}),null==r&&(r={});const i=new n({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});i.immutable=!1,o.textformatting={value:i,valueset:!0,node:null};for(const n in r)o[n]={value:new c.NativeFunction(r[n]),native:!0,valueset:!0,node:null};for(const n in e)e[n]&&"esri.Graphic"===e[n].declaredClass?o[n]={value:a.createFromGraphic(e[n],t),valueset:!0,node:null}:o[n]={value:e[n],valueset:!0,node:null};return o}function he(e){console.log(e)}we.prototype=le,we.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},we.prototype.pi={value:Math.PI,valueset:!0,node:null};const me=pe;function ge(e){const r={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:b,standardFunctionAsync:S,evaluateIdentifier:ie};for(let t=0;t<e.length;t++)e[t].registerFunctions(r);for(const t in r.functions)le[t]={value:new c.NativeFunction(r.functions[t]),valueset:!0,node:null},we.prototype[t]=le[t];for(let t=0;t<r.signatures.length;t++)s.addFunctionDeclaration(r.signatures[t],"async")}async function ve(e,r){let t=r.spatialReference;null==t&&(t=new m({wkid:102100}));let n=null;e.usesModules&&(n=new o.ArcadeModuleLoader(new Map,e.loadedModules));const a=xe(r.vars,r.customfunctions,r.timeReference),c={spatialReference:t,services:r.services,exports:{},libraryResolver:n,abortSignal:void 0===r.abortSignal||null===r.abortSignal?{aborted:!1}:r.abortSignal,globalScope:a,console:r.console??he,timeReference:r.timeReference??null,lrucache:r.lrucache,interceptor:r.interceptor,localScope:null,depthCounter:{depth:1}};let s=await R(c,e);if(s instanceof u.ReturnResult&&(s=s.value),s instanceof u.ImplicitResult&&(s=s.value),s===u.voidOperation&&(s=null),s===u.breakResult)throw new i.ArcadeExecutionError(c,i.ExecutionErrorCodes.IllegalResult,null);if(s===u.continueResult)throw new i.ArcadeExecutionError(c,i.ExecutionErrorCodes.IllegalResult,null);if(u.isFunctionParameter(s))throw new i.ArcadeExecutionError(c,i.ExecutionErrorCodes.IllegalResult,null);return s}ge([l.ArrayFunctions]),e.executeScript=ve,e.extend=ge,e.functionHelper=me,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
