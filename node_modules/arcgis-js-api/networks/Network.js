/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../geometry","../Graphic","../request","../core/Error","../core/Loadable","../core/Logger","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/subclass","../geometry/Extent","../geometry/support/jsonUtils","../layers/mixins/EditBusLayer","../layers/support/arcgisLayerUrl","./support/TopologyValidationJobInfo","./support/utils","../rest/networks/support/QueryNamedTraceConfigurationsParameters","../geometry/SpatialReference"],(function(e,t,r,o,a,n,i,s,l,d,u,c,p,y,f,m,h,w,g,v,_,k,S,E,U){"use strict";const b=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let N=function(r){function o(e){var t;return(t=r.call(this,e)||this).id=null,t.title=null,t.layerUrl=null,t.dataElement=null,t.fullExtent=null,t.spatialReference=null,t.type=null,t.sourceJSON=null,t}t._inherits(o,r),o.fromPortalItem=function(e){return S.networkFromPortalItem(e)};var s=o.prototype;return s.initialize=function(){this.when().catch((e=>{u.isAbortError(e)||l.getLogger(this).error("#load()",`Failed to load layer (title: '${this.title??"no title"}', id: '${this.id??"no id"}')`,{error:e})}))},s.load=async function(e){return this.addResolvingPromise(this._fetchDataElement(this.featureServiceUrl,this.layerId.toString(),e)),this.addResolvingPromise(this._fetchLayerMetaData(this.layerUrl,e)),this},s.getLayerIdBySourceId=function(e){if(this.dataElement){const t=this.dataElement.domainNetworks;for(const r of t){for(const t of r.edgeSources??[])if(t.sourceId===e)return t.layerId;for(const t of r.junctionSources??[])if(t.sourceId===e)return t.layerId}return null}return null},s.queryNamedTraceConfigurations=async function(t,r){const{queryNamedTraceConfigurations:o}=await new Promise(((t,r)=>e(["../rest/networks/queryNamedTraceConfigurations"],t,r))),a=this.networkServiceUrl,n=new E({...t});return(await o(a,n,{...r}))?.namedTraceConfigurations??null},s.validateTopology=async function(t,r){if(!t.validateArea)throw new i("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");const[{validateNetworkTopology:o},{default:a}]=await Promise.all([new Promise(((t,r)=>e(["../rest/networks/validateNetworkTopology"],t,r))),new Promise(((t,r)=>e(["../rest/networks/support/ValidateNetworkTopologyParameters"],(e=>t(b(e))),r)))]),n=a.from(t),s=this.networkServiceUrl,l=this.featureServiceUrl,d=v.emitApplyEditsEvent(l,null,!0),u=await o(s,n,{...r});if(u?.serviceEdits){const e=[];for(const t of u.serviceEdits){const{editedFeatures:r}=t,o=r?.spatialReference?new U(r.spatialReference):null;e.push({layerId:t.layerId,editedFeatures:{adds:r?.adds?.map((e=>this._createEditedFeature(e,o)))||[],updates:r?.updates?.map((e=>({original:this._createEditedFeature(e[0],o),current:this._createEditedFeature(e[1],o)})))||[],deletes:r?.deletes?.map((e=>this._createEditedFeature(e,o)))||[],spatialReference:o}})}d.resolve({edits:null,addedFeatures:[],updatedFeatures:[],deletedFeatures:[],addedAttachments:[],updatedAttachments:[],deletedAttachments:[],editedFeatures:e,exceededTransferLimit:!1})}return u},s.submitTopologyValidationJob=async function(t,r){if(!t.validateArea)throw new i("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");if(!t.gdbVersion)throw new i("network:undefined-gdb-version","version must be defined");const[{submitValidateNetworkTopologyJob:o},{default:a}]=await Promise.all([new Promise(((t,r)=>e(["../rest/networks/validateNetworkTopology"],t,r))),new Promise(((t,r)=>e(["../rest/networks/support/ValidateNetworkTopologyParameters"],(e=>t(b(e))),r)))]),n=a.from(t),s=this.networkServiceUrl,l=this.featureServiceUrl?v.emitApplyEditsEvent(this.featureServiceUrl,null,!0):void 0,d=await o(s,n,{...r});return new k({statusUrl:d,editsResolver:l})},s._createEditedFeature=function(e,t){return new a({attributes:e.attributes,geometry:g.fromJSON({...e.geometry,spatialReference:t})})},s._fetchLayerMetaData=async function(e,t){const r=await n(e,{responseType:"json",query:{f:"json"},...t});this.sourceJSON=r.data,this.read(r.data,{origin:"service"})},s._fetchDataElement=async function(e,t,r){if(this.dataElement)return;const o=await n(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...r}).then((e=>e.data.layerDataElements?.[0]));o&&this.read(o,{origin:"service"})},t._createClass(o,[{key:"datasetName",get:function(){return this.dataElement?.name??null}},{key:"owner",get:function(){return this.dataElement?.userIdentity??null}},{key:"schemaGeneration",get:function(){return this.dataElement?.schemaGeneration??null}},{key:"parsedUrl",get:function(){return c.urlToObject(this.layerUrl)}},{key:"featureServiceUrl",get:function(){const e=_.parse(this.parsedUrl?.path);return e?.url?.path??null}},{key:"networkServiceUrl",get:function(){return this.featureServiceUrl?this.featureServiceUrl.replace(/\/FeatureServer/i,"/UtilityNetworkServer"):null}},{key:"layerId",get:function(){const e=this.parsedUrl&&_.parse(this.parsedUrl.path);return null!=e?e.sublayer:null}},{key:"networkSystemLayers",get:function(){return null}}]),o}(d.MultiOriginJSONMixin(s));r.__decorate([p.property({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:!0}},read:!1}})],N.prototype,"id",void 0),r.__decorate([p.property({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:{source:"name"}}},read:!1}})],N.prototype,"title",void 0),r.__decorate([p.property({type:String,nonNullable:!0,json:{origins:{"web-map":{read:{source:"url"},write:{target:"url",isRequired:!0}}},read:!1}})],N.prototype,"layerUrl",void 0),r.__decorate([p.property({type:Object,json:{origins:{service:{read:!0}},read:!1}})],N.prototype,"dataElement",void 0),r.__decorate([p.property({type:w,json:{origins:{service:{read:{source:"extent"}}},read:!1}})],N.prototype,"fullExtent",void 0),r.__decorate([p.property({type:U,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:!1}})],N.prototype,"spatialReference",void 0),r.__decorate([p.property({type:["utility","trace"],readOnly:!0,json:{read:!1,write:!1}})],N.prototype,"type",void 0),r.__decorate([p.property({readOnly:!0})],N.prototype,"datasetName",null),r.__decorate([p.property({readOnly:!0})],N.prototype,"owner",null),r.__decorate([p.property({readOnly:!0})],N.prototype,"schemaGeneration",null),r.__decorate([p.property({readOnly:!0})],N.prototype,"parsedUrl",null),r.__decorate([p.property({readOnly:!0})],N.prototype,"featureServiceUrl",null),r.__decorate([p.property({readOnly:!0})],N.prototype,"networkServiceUrl",null),r.__decorate([p.property({readOnly:!0})],N.prototype,"layerId",null),r.__decorate([p.property()],N.prototype,"sourceJSON",void 0),r.__decorate([p.property({readOnly:!0})],N.prototype,"networkSystemLayers",null),N=r.__decorate([h.subclass("esri.networks.Network")],N);return N}));
