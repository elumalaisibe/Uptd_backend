/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../request","../../core/Error","../../layers/support/featureQueryAll","../../portal/PortalItem","../../rest/support/FeatureSet"],(function(e,t,r,o,a,n,l){"use strict";const s=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function u(e,t){const r=[],o=new Map;for(const n of t){const t=e.getLayerIdBySourceId(n.networkSourceId);if(null==t)continue;let r=o.get(t);void 0===r&&(r=[]),r.push(n.objectId),o.set(t,r)}const a=e.featureServiceUrl;return o.forEach(((e,t)=>r.push({layerUrl:`${a}/${t}`,objectIds:e}))),r}async function i(e){const t=e.layers,r=e.layerInfos,o=e.returnGeometry||!1,n=e.outSpatialReference;await Promise.all(t.map((e=>e.load())));return(await Promise.all(t.map((async e=>{const t=r.find((t=>t.layerUrl===e.parsedUrl?.path));if(!t||!t.objectIds?.length)return{layer:e,featureSet:void 0};const s=e.createQuery();s.returnGeometry=o,s.outFields=t.outFields||["*"],s.outSpatialReference=n,s.gdbVersion=e.gdbVersion,s.objectIds=t.objectIds;const u=l.fromJSON(await a.queryAllJSON(e,s));return{layer:e,featureSet:u}})))).filter((e=>void 0!==e.featureSet))}async function c(t,r){if("Utility Network Layer"===t){const{default:t}=await new Promise(((t,r)=>e(["../UtilityNetwork"],(e=>t(s(e))),r)));return new t({layerUrl:r})}return null}async function y(e){let t="portalItem"in e?e:{portalItem:e};!t.portalItem||t.portalItem instanceof n||(t={...t,portalItem:new n(t.portalItem)});const a=t.portalItem;if(await a.load(),"Feature Service"!==a.type)throw new o("portal:unknown-item-type","Unknown item type '${type}'",{type:a.type});const l=a.url,s=await r(l,{responseType:"json",query:{f:"json"}}),u="Network Layer";if(s.data.type&&s.data.type.includes(u))return c(s.data.type,l);if(s.data.layers){const e=s.data.layers.find((e=>e.type.includes(u)));if(e){const t=`${l}/${e.id}`;return c(e.type,t)}}return null}t.getFeaturesFromLayers=i,t.getObjectIdsFromElements=u,t.networkFromPortalItem=y,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
