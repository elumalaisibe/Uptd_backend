/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../core/Error","../../layers/support/layerUtils","../../layers/support/lazyLayerLoader","../PortalItem","./layersLoader","./portalItemUtils","../../support/requestPresets"],(function(e,a,r,t,s,n,c,o){"use strict";async function i(e){!e.portalItem||e.portalItem instanceof s||(e={...e,portalItem:new s(e.portalItem)});const a=await u(e.portalItem);return new(0,a.constructor)({portalItem:e.portalItem,...a.properties})}async function u(e){await e.load();return l(await y(e))}async function y(e){switch(e.type){case"Map Service":return p(e);case"Feature Service":return m(e);case"Feature Collection":return L(e);case"Scene Service":return f(e);case"Image Service":return S(e);case"Stream Service":return N();case"Vector Tile Service":return d();case"GeoJson":return w();case"CSV":return I();case"KML":return T();case"WFS":return g();case"WMTS":return h();case"WMS":return v();case"Feed":return G();default:throw new a("portal:unknown-item-type","Unknown item type '${type}'",{type:e.type})}}async function l(e){const a=e.className,r=t.layerLookupMap[a];return{constructor:await r(),properties:e.properties}}async function p(e){return await M(e)?{className:"TileLayer"}:{className:"MapImageLayer"}}async function m(e){if(c.hasTypeKeyword(e,"Oriented Imagery Layer"))return b(e);const a=await F(e);if("object"==typeof a){const e={};return null!=a.id&&(e.layerId=a.id),{className:a.className||"FeatureLayer",properties:e}}return{className:"GroupLayer"}}async function f(e){const a=await F(e);if("object"==typeof a){const t={};let s;if(null!=a.id?(t.layerId=a.id,s=`${e.url}/layers/${a.id}`):s=e.url,e.typeKeywords?.length)for(const a of Object.keys(r.sceneServiceLayerTypeToClassName))if(e.typeKeywords.includes(a))return{className:r.sceneServiceLayerTypeToClassName[a]};const n=await o.fetchArcGISServiceJSON(s);return{className:r.sceneServiceLayerTypeToClassName[n?.layerType]||"SceneLayer",properties:t}}if(!1===a){const a=await o.fetchArcGISServiceJSON(e.url);return"Voxel"===a?.layerType?{className:"VoxelLayer"}:{className:"GroupLayer"}}return{className:"GroupLayer"}}async function L(e){await e.load();const a=c.hasTypeKeyword(e,"Map Notes"),r=c.hasTypeKeyword(e,"Markup");if(a||r)return{className:"MapNotesLayer"};if(c.hasTypeKeyword(e,"Route Layer"))return{className:"RouteLayer"};const t=await e.fetchData();return 1===n.getNumLayersAndTables(t)?{className:"FeatureLayer"}:{className:"GroupLayer"}}async function S(e){await e.load();const a=e.typeKeywords?.map((e=>e.toLowerCase()))??[];if(a.includes("elevation 3d layer"))return{className:"ElevationLayer"};if(a.includes("tiled imagery"))return{className:"ImageryTileLayer"};const r=await e.fetchData(),t=r?.layerType;if("ArcGISTiledImageServiceLayer"===t)return{className:"ImageryTileLayer"};if("ArcGISImageServiceLayer"===t)return{className:"ImageryLayer"};const s=await o.fetchArcGISServiceJSON(e.url),n=s.cacheType?.toLowerCase(),c=s.capabilities?.toLowerCase().includes("tilesonly");return"map"===n||c?{className:"ImageryTileLayer"}:{className:"ImageryLayer"}}function N(){return{className:"StreamLayer"}}function d(){return{className:"VectorTileLayer"}}function w(){return{className:"GeoJSONLayer"}}function I(){return{className:"CSVLayer"}}function T(){return{className:"KMLLayer"}}function g(){return{className:"WFSLayer"}}function v(){return{className:"WMSLayer"}}function h(){return{className:"WMTSLayer"}}function G(){return{className:"StreamLayer"}}async function b(e){await e.load();return{className:"OrientedImageryLayer",properties:await e.fetchData()}}async function M(e){return(await o.fetchArcGISServiceJSON(e.url)).tileInfo}async function F(e){const a=e.url;if(!a||/\/\d+$/.test(a))return{};await e.load();const r=await e.fetchData();if("Feature Service"===e.type){const e=O(await n.preprocessFSItemData(r,a));if("object"==typeof e){const a=n.getSubtypeGroupLayerIds(r);e.className=null!=e.id&&a.includes(e.id)?"SubtypeGroupLayer":"FeatureLayer"}return e}if(n.getNumLayersAndTables(r)>0)return O(r);return O(await o.fetchArcGISServiceJSON(a))}function O(e){return 1===n.getNumLayersAndTables(e)&&{id:n.getFirstLayerOrTableId(e)}}e.fromItem=i,e.selectLayerClassPath=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
