/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../kernel","../Error","../Logger","../maybe","../promiseUtils","./utils","./workerFactory"],(function(e,t,o,s,r,n,a,i){"use strict";const{ABORT:c,INVOKE:l,OPEN:b,OPENED:d,RESPONSE:u}=a.MessageType;return function(){function h(e,t){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=t,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",(e=>{e.preventDefault(),s.getLogger("esri.core.workers.WorkerOwner").error(e)}))}h.create=async function(e){return new h(await i.createWorker(),e)};var p=h.prototype;return p.terminate=function(){this.worker.terminate()},p.open=async function(e,t={}){const{signal:o}=t,s=a.newJobId();return new Promise(((t,r)=>{const a={resolve:t,reject:r,abortHandle:n.onAbortOrThrow(o,(()=>{this._outJobs.delete(s),this._post({type:c,jobId:s})}))};this._outJobs.set(s,a),this._post({type:b,jobId:s,modulePath:e})}))},p._onMessage=function(e){const t=a.receiveMessage(e);if(t)switch(t.type){case d:this._onOpenedMessage(t);break;case u:this._onResponseMessage(t);break;case c:this._onAbortMessage(t);break;case l:this._onInvokeMessage(t)}},p._onAbortMessage=function(e){const t=this._inJobs,o=e.jobId,s=t.get(o);s&&(s.controller&&s.controller.abort(),t.delete(o))},p._onInvokeMessage=function(e){const{methodName:o,jobId:s,data:r,abortable:i}=e,c=i?new AbortController:null,l=this._inJobs,b=t.workerMessages[o];let d;try{if("function"!=typeof b)throw new TypeError(`${o} is not a function`);d=b.call(null,r,{signal:c?c.signal:null})}catch(h){return void this._post({type:u,jobId:s,error:a.toInvokeError(h)})}n.isPromiseLike(d)?(l.set(s,{controller:c,promise:d}),d.then((e=>{l.has(s)&&(l.delete(s),this._post({type:u,jobId:s},e))}),(e=>{l.has(s)&&(l.delete(s),e||(e={message:"Error encountered at method"+o}),n.isAbortError(e)||this._post({type:u,jobId:s,error:a.toInvokeError(e||{message:`Error encountered at method ${o}`})}))}))):this._post({type:u,jobId:s},d)},p._onOpenedMessage=function(e){const{jobId:t,data:o}=e,s=this._outJobs.get(t);s&&(this._outJobs.delete(t),r.removeMaybe(s.abortHandle),s.resolve(o))},p._onResponseMessage=function(e){const{jobId:t,error:s,data:n}=e,a=this._outJobs.get(t);a&&(this._outJobs.delete(t),r.removeMaybe(a.abortHandle),s?a.reject(o.fromJSON(JSON.parse(s))):a.resolve(n))},p._post=function(e,t,o){return a.postMessage(this.worker,e,t,o)},e._createClass(h)}()}));
