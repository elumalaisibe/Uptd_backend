/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../Error","../has","../promiseUtils","./Connection","./RemoteClient","./WorkerOwner"],(function(e,t,n,r,o,i,a,s){"use strict";function l(e){if(e&&e.__esModule)return e;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e)for(const n in e)if("default"!==n){const r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:()=>e[n]})}return t.default=e,Object.freeze(t)}const c=r("host-browser")?Math.min(navigator.hardwareConcurrency-1,r("workers-pool-size")):0;let u=r("esri-mobile")?Math.min(c,3):c;u||(u=r("safari")&&r("mac")?7:2);let f=0;const m=[];function w(){k()}function d(e,t){return b(e,{client:t})}async function b(e,t){const n=new i;return await n.open(e,t),n}async function h(t,i={}){if("string"!=typeof t)throw new n("workers:undefined-module","modulePath is missing");let s=i.strategy||"distributed";if(r("host-webworker")&&!r("esri-workers")&&(s="local"),"local"===s){let n=await a.loadWorker(t);n||(n=await new Promise(((n,r)=>e([/* @vite-ignore */ /* webpackIgnore: true */t],(e=>n(l(e))),r)))),o.throwIfAborted(i.signal);const r=i.client||n;return b([a.connect(n)],{...i,client:r})}if(await k(),o.throwIfAborted(i.signal),"dedicated"===s){const e=f++%u;return b([await m[e].open(t,i)],i)}if(i.maxNumWorkers&&i.maxNumWorkers>0){const e=Math.min(i.maxNumWorkers,u);if(e<u){const n=new Array(e);for(let r=0;r<e;++r){const e=f++%u;n[r]=m[e].open(t,i)}return b(n,i)}}return b(m.map((e=>e.open(t,i))),i)}function p(){y&&(g.abort(),y=null);for(let e=0;e<m.length;e++)m[e]&&m[e].terminate();m.length=0}let g,y=null;async function k(){if(y)return y;g=new AbortController;const e=[];for(let t=0;t<u;t++){const n=s.create(t).then((e=>(m[t]=e,e)));e.push(n)}return y=Promise.all(e),y}t.Connection=i,t.RemoteClient=a,t.initialize=w,t.open=h,t.openWithPorts=d,t.terminate=p,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
