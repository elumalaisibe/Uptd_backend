/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../kernel","../Error","../events","../maybe","../promiseUtils","./registry","./utils","../../support/revision"],(function(e,t,s,o,n,r,i,l,c){"use strict";const{CLOSE:a,ABORT:h,INVOKE:u,RESPONSE:_,OPEN_PORT:p,ON:d}=l.MessageType,b=2;let g=function(){function t(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}var s=t.prototype;return s.push=function(e){e.type===l.MessageType.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),null===this._timer&&(this._timer=setTimeout(this._process,0)))},s.clear=function(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null},s._process=function(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0},e._createClass(t)}(),f=function(){function t(e,t,s){this._port=e,this._getNextJob=s,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new g((e=>this._onInvokeMessage(e))),this._client=t.client,this._onMessage=this._onMessage.bind(this),this._channel=t.channel,this._schedule=t.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}t.connect=function(e){const s=new MessageChannel;let o;o="function"==typeof e?new e:"default"in e&&"function"==typeof e.default?new e.default:e;const n=new t(s.port1,{channel:s,client:o},(()=>null));return"object"==typeof o&&"remoteClient"in o&&(o.remoteClient=n),t.clients.set(n,o),s.port2},t.loadWorker=function(e){const t=i.registry[e];return t?t():Promise.resolve(null)};var c=t.prototype;return c.close=function(){this._post({type:a}),this._close()},c.isBusy=function(){return this._outJobs.size>0},c.invoke=function(e,t,o){const i=o?.signal,c=o?.transferList;if(!this._port)return Promise.reject(new s("worker:port-closed",`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:t}));const a=l.newJobId();return new Promise(((s,o)=>{if(r.isAborted(i))return this._processWork(),void o(r.createAbortError());const l=r.onAbort(i,(()=>{const e=this._outJobs.get(a);e&&(this._outJobs.delete(a),this._processWork(),n.removeMaybe(e.abortHandle),this._post({type:h,jobId:a}),o(r.createAbortError()))})),_={resolve:s,reject:o,abortHandle:l,debugInfo:e};this._outJobs.set(a,_),this._post({type:u,jobId:a,methodName:e,abortable:null!=i},t,c)}))},c.on=function(e,t){const s=new MessageChannel;function o(e){t(e.data)}return this._port.postMessage({type:l.MessageType.ON,eventType:e,port:s.port2},[s.port2]),s.port1.addEventListener("message",o),s.port1.start(),{remove(){s.port1.postMessage({type:l.MessageType.CLOSE}),s.port1.close(),s.port1.removeEventListener("message",o)}}},c.jobAdded=function(){this._processWork()},c.openPort=function(){const e=new MessageChannel;return this._post({type:p,port:e.port2}),e.port1},c._processWork=function(){if(this._outJobs.size>=b)return;const e=this._getNextJob();if(!e)return;const{methodName:t,data:s,invokeOptions:o,resolver:n}=e;this.invoke(t,s,o).then((e=>n.resolve(e))).catch((e=>n.reject(e)))},c._close=function(){this._channel&&(this._channel=void 0),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach((e=>{n.removeMaybe(e.abortHandle),e.reject(r.createAbortError(`Worker closing, aborting job calling '${e.debugInfo}'`))})),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=null,this._client=null,this._schedule=null},c._onMessage=function(e){null!=this._schedule?this._schedule((()=>this._processMessage(e))):this._processMessage(e)},c._processMessage=function(e){const t=l.receiveMessage(e);if(t)switch(t.type){case _:this._onResponseMessage(t);break;case u:this._invokeQueue.push(t);break;case h:this._onAbortMessage(t);break;case a:this._onCloseMessage();break;case p:this._onOpenPortMessage(t);break;case d:this._onOnMessage(t)}},c._onAbortMessage=function(e){const t=this._inJobs,s=e.jobId,o=t.get(s);this._invokeQueue.push(e),o&&(o.controller&&o.controller.abort(),t.delete(s))},c._onCloseMessage=function(){const e=this._client;this._close(),e&&"destroy"in e&&t.clients.get(this)===e&&e.destroy(),t.clients.delete(this),e?.remoteClient&&(e.remoteClient=null)},c._onInvokeMessage=function(e){const{methodName:t,jobId:s,data:o,abortable:n}=e,i=n?new AbortController:null,c=this._inJobs;let a,h=this._client,u=h[t];try{if(!u&&t&&t.includes(".")){const e=t.split(".");for(let t=0;t<e.length-1;t++)h=h[e[t]],u=h[e[t+1]]}if("function"!=typeof u)throw new TypeError(`${t} is not a function`);a=u.call(h,o,{client:this,signal:i?i.signal:null})}catch(p){return void this._post({type:_,jobId:s,error:l.toInvokeError(p)})}r.isPromiseLike(a)?(c.set(s,{controller:i,promise:a}),a.then((e=>{c.has(s)&&(c.delete(s),this._post({type:_,jobId:s},e))}),(e=>{c.has(s)&&(c.delete(s),r.isAbortError(e)||this._post({type:_,jobId:s,error:l.toInvokeError(e||{message:`Error encountered at method ${t}`})}))}))):this._post({type:_,jobId:s},a)},c._onOpenPortMessage=function(e){new t(e.port,{client:this._client},(()=>null))},c._onOnMessage=function(e){const{port:t}=e,s=this._client.on(e.eventType,(e=>{t.postMessage(e)})),n=o.on(e.port,"message",(e=>{const o=l.receiveMessage(e);o?.type===l.MessageType.CLOSE&&(n.remove(),s.remove(),t.close())}))},c._onResponseMessage=function(e){const{jobId:t,error:o,data:r}=e,i=this._outJobs;if(!i.has(t))return;const l=i.get(t);i.delete(t),this._processWork(),n.removeMaybe(l.abortHandle),o?l.reject(s.fromJSON(JSON.parse(o))):l.resolve(r)},c._post=function(e,t,s){return l.postMessage(this._port,e,t,s)},e._createClass(t)}();return f.kernelInfo={buildDate:c.buildDate,fullVersion:t.fullVersion,revision:c.commitHash},f.clients=new Map,f}));
