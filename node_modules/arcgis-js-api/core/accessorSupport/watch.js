/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../ArrayPool","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./trackingUtils","./utils"],(function(e,t,r,n,l,o,u,a,i,c,s){"use strict";var d;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(d||(d={}));let h=function(){function e(){this.uid=a.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}e.acquireUntracked=function(e,t,r,l,o){return this.pool.acquire(d.Untracked,e,t,r,l,o,n.equals)},e.acquireTracked=function(e,t,r,n){return this.pool.acquire(d.Tracked,e,t,r,null,null,n)};var r=e.prototype;return r.notify=function(e,t){this.type===d.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)},r.acquire=function(e,t,r,n,l,o,u){this.uid=a.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=n,this.target=l,this.path=o,this.equals=u},r.release=function(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=a.generateUID(),this.removed=!0},t._createClass(e)}();h.pool=new l.ReentrantObjectPool(h);const f=new r,v=new Set;let m;function p(e){v.delete(e),v.add(e),m||(m=o.schedule(_))}function g(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function k(e){for(const t of v.values())t.target===e&&(t.removed=!0)}function _(){let e=10;for(;m&&e--;){m=null;const e=q(),t=f.acquire();for(const r of e){const e=r.uid;g(r),e===r.uid&&r.removed&&t.push(r)}for(const r of v)r.removed&&(t.push(r),v.delete(r));for(const r of t)h.pool.release(r);f.release(t),f.release(e),y.forEach((e=>e()))}}function q(){const e=f.acquire();e.length=v.size;let t=0;for(const r of v)e[t]=r,++t;return v.clear(),e}const y=new Set;function U(e){return y.add(e),{remove(){y.delete(e)}}}function V(e,t,r){let n=s.parse(e,t,r,((e,t,r)=>{let l,o,u=c.reactionDeferred((()=>i.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed||l&&l.uid!==o?n.remove():(l||(l=h.acquireUntracked(u,r,a,e,t),o=l.uid),p(l))}));return{remove:s.once((()=>{u.remove(),l&&(l.uid!==o||l.removed||(l.removed=!0,p(l)),l=null),n=u=null}))}}));return n}function b(e,t,r){const l=s.parse(e,t,r,((e,t,r)=>{let o=!1;return c.reaction((()=>i.valueOf(e,t)),((u,a)=>{e.__accessor__.destroyed?l.remove():o||(o=!0,n.equals(a,u)||r.call(e,u,a,t,e),o=!1)}))}));return l}function T(e,t,r,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?b(e,t,r):V(e,t,r)}function w(e,t,r){let n,l,o=c.reactionDeferred(e,((e,u)=>{n&&n.uid!==l?o.remove():(n||(n=h.acquireTracked(e,t,u,r),l=n.uid),p(n))}));return{remove:s.once((()=>{o.remove(),n&&(n.uid!==l||n.removed||(n.removed=!0,p(n)),n=null),o=null}))}}function S(e,t,r){let n=!1;return c.reaction(e,((e,l)=>{n||(n=!0,r(l,e)||t(e,l),n=!1)}))}function D(e,t,r=!1,l=n.equalsShallow){return r?S(e,t,l):w(e,t,l)}function O(e){return u.someSet(v,(t=>t.oldValue===e))}e.afterDispatch=U,e.dispatch=_,e.isValueInUse=O,e.removeTarget=k,e.watch=T,e.watchTracked=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
