/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../has","../lang","../Logger","../ObjectPool","./interfaces","./Property","./PropertyOrigin","./Store","./tracking","./tracking/Flags"],(function(t,e,i,n,r,s,o,a,c,l,u){"use strict";function f(t,e,i){return void 0!==t}function h(t,e,i,n){return void 0!==t&&(!(null==i&&t.observerObject.flags&u.Flags.NonNullable)||(n.lifecycle,s.Lifecycle.INITIALIZING,!1))}function g(t){return t&&"function"==typeof t.destroy}n.getLogger("esri.core.accessorSupport.Properties");let d=function(){function e(t){this.host=t,this.propertiesByName=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=s.Lifecycle.INITIALIZING,this.store=new c.Store,this._origin=a.OriginId.USER;const e=this.host.constructor.__accessorMetadata__;for(const i in e){const t=new o.Property(i,e[i]);this.propertiesByName.set(i,t)}this.metadatas=e}var n=e.prototype;return n.initialize=function(){this.lifecycle=s.Lifecycle.CONSTRUCTING},n.constructed=function(){this.lifecycle=s.Lifecycle.CONSTRUCTED},n.destroy=function(){this.destroyed=!0;for(const[t,e]of this.propertiesByName){if(e.metadata.autoDestroy){const i=this.internalGet(t);i&&g(i)&&(i.destroy(),~e.observerObject.flags&u.Flags.NonNullable&&this._internalSet(e,null))}e.destroy()}},n.get=function(t){const e=this.propertiesByName.get(t);if(e.metadata.get)return e.getComputed(this);l.trackAccess(e.observerObject);const i=this.store;return i.has(t)?i.get(t):e.metadata.value},n.originOf=function(t){const e=this.store.originOf(t);if(void 0===e){const e=this.propertiesByName.get(t);if(void 0!==e&&e.observerObject.flags&u.Flags.HasDefaultValue)return"defaults"}return a.idToName(e)},n.has=function(t){return!!this.propertiesByName.has(t)&&this.store.has(t)},n.keys=function(){return[...this.propertiesByName.keys()]},n.internalGet=function(t){const e=this.propertiesByName.get(t);if(f(e))return this.store.has(t)?this.store.get(t):e.metadata.value},n.internalSet=function(t,e){const i=this.propertiesByName.get(t);f(i)&&this._internalSet(i,e)},n.getDependsInfo=function(t,e,i){const n=this.propertiesByName.get(e);if(!f(n))return"";const r=new Set,s=l.runTracked({onObservableAccessed:t=>r.add(t),onTrackingEnd:()=>{}},(()=>n.metadata.get?.call(t)));let a=`${i}${t.declaredClass.split(".").pop()}.${e}: ${s}\n`;if(0===r.size)return a;i+="  ";for(const c of r){if(!(c instanceof o.Property))continue;a+=`${i}${c.propertyName}: undefined\n`}return a},n.setAtOrigin=function(t,e,i){const n=this.propertiesByName.get(t);if(f(n))return this._setAtOrigin(n,e,i)},n.isOverridden=function(t){const e=this.propertiesByName.get(t);return void 0!==e&&!!(e.observerObject.flags&u.Flags.Overriden)},n.clearOverride=function(t){const e=this.propertiesByName.get(t),i=e?.observerObject;i&&i.flags&u.Flags.Overriden&&(i.flags&=~u.Flags.Overriden,e.notifyChange())},n.override=function(t,e){const i=this.propertiesByName.get(t);if(!h(i,t,e,this))return;const n=i.metadata.cast;if(n){const t=this._cast(n,e),{valid:i,value:r}=t;if(p.release(t),!i)return;e=r}i.observerObject.flags|=u.Flags.Overriden,this._internalSet(i,e)},n.set=function(t,e){const i=this.propertiesByName.get(t);if(!h(i,t,e,this))return;const n=i.metadata.cast;if(n){const t=this._cast(n,e),{valid:i,value:r}=t;if(p.release(t),!i)return;e=r}const r=i.metadata.set;r?r.call(this.host,e):this._internalSet(i,e)},n.setDefaultOrigin=function(t){this._origin=a.nameToId(t)},n.getDefaultOrigin=function(){return a.idToName(this._origin)},n.notifyChange=function(t){const e=this.propertiesByName.get(t);void 0!==e&&e.notifyChange()},n.invalidate=function(t){const e=this.propertiesByName.get(t);void 0!==e&&e.invalidate()},n.commit=function(t){const e=this.propertiesByName.get(t);void 0!==e&&e.commit()},n._internalSet=function(t,e){const i=this.lifecycle!==s.Lifecycle.INITIALIZING?this._origin:a.OriginId.DEFAULTS;this._setAtOrigin(t,e,i)},n._setAtOrigin=function(t,e,n){const r=this.store,s=t.propertyName;r.has(s,n)&&i.equals(e,r.get(s))&&~t.observerObject.flags&u.Flags.Overriden&&n===r.originOf(s)||(t.invalidate(),r.set(s,e,n),t.commit(),l.initializeDependencyTracking(this.host,t))},n._cast=function(t,e){const i=p.acquire();return i.valid=!0,i.value=e,t&&(i.value=t.call(this.host,e,i)),i},t._createClass(e,[{key:"initialized",get:function(){return this.lifecycle!==s.Lifecycle.INITIALIZING}}]),e}();const p=new r(function(){function e(){this.value=null,this.valid=!0}var i=e.prototype;return i.acquire=function(){this.valid=!0},i.release=function(){this.value=null},t._createClass(e)}());return d}));
