/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../Accessor","../Handles","../handleUtils","../reactiveUtils","../scheduling","../accessorSupport/decorators/property","../accessorSupport/decorators/subclass"],(function(e,t,n,s,a,i,d,r,h,c){"use strict";e.WatchUpdatingTracking=function(e){function n(){var t;return(t=e.apply(this,arguments)||this).updating=!1,t._handleId=0,t._handles=new a,t._scheduleHandleId=0,t._pendingPromises=new Set,t}t._inherits(n,e);var s=n.prototype;return s.destroy=function(){this.removeAll(),this._handles.destroy()},s.add=function(e,t,n={}){return this._installWatch(e,t,n,d.watch)},s.addWhen=function(e,t,n={}){return this._installWatch(e,t,n,d.when)},s.addOnCollectionChange=function(e,t,{initial:n=!1,final:s=!1}={}){const a=++this._handleId;return this._handles.add([d.on(e,"after-changes",this._createSyncUpdatingCallback(),d.sync),d.on(e,"change",t,{onListenerAdd:n?e=>t({added:e.toArray(),removed:[]}):void 0,onListenerRemove:s?e=>t({added:[],removed:e.toArray()}):void 0})],a),i.makeHandle((()=>this._handles.remove(a)))},s.addPromise=function(e){if(null==e)return e;const t=++this._handleId;this._handles.add({remove:()=>{this._pendingPromises.delete(e)&&(0!==this._pendingPromises.size||this._handles.has(l)||this._set("updating",!1))}},t),this._pendingPromises.add(e),this._set("updating",!0);const n=()=>this._handles.remove(t);return e.then(n,n),e},s.removeAll=function(){this._pendingPromises.clear(),this._handles.removeAll(),this._set("updating",!1)},s._installWatch=function(e,t,n={},s){const a=++this._handleId;n.sync||this._installSyncUpdatingWatch(e,a);const d=s(e,t,n);return this._handles.add(d,a),i.makeHandle((()=>this._handles.remove(a)))},s._installSyncUpdatingWatch=function(e,t){const n=this._createSyncUpdatingCallback(),s=d.watch(e,n,{sync:!0,equals:()=>!1});return this._handles.add(s,t),s},s._createSyncUpdatingCallback=function(){return()=>{this._handles.remove(l),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this._handles.add(r.schedule((()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this._handles.remove(l))})),l)}},t._createClass(n)}(s),n.__decorate([h.property({readOnly:!0})],e.WatchUpdatingTracking.prototype,"updating",void 0),e.WatchUpdatingTracking=n.__decorate([c.subclass("esri.core.support.WatchUpdatingTracking")],e.WatchUpdatingTracking);const l=-42;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
