/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../chunks/_rollupPluginBabelHelpers","../geometry","../core/Error","../core/Logger","../geometry/SpatialReference"],(function(e,r,t,a,s,i,n){"use strict";const c=i.getLogger("esri.support.arcadeOnDemand");let o;function l(){return o||(o=(async()=>{const r=await new Promise(((r,t)=>e(["./arcadeUtils"],r,t)));return{arcade:r.arcade,arcadeUtils:r,Dictionary:r.Dictionary,Feature:r.arcadeFeature}})()),o}const u=(e,r,t)=>y.create(e,r,t,null,["$feature"],[]),p=(e,r,t)=>y.create(e,r,t,null,["$feature","$view"],[]),d=p,f=(e,r,t,a)=>y.create(e,r,t,a,["$feature","$view"],[]);let y=function(){function e(e,r,t,a,s,i,n){this.services=null,this.script=e,this.evaluate=a;const c=Array.isArray(i)?i:i.fields;this.fields=c,this._syntaxTree=t,this._arcade=r,this._arcadeFeature=s,this._spatialReference=n,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}e.create=async function(r,t,a,i,o,u){const{arcade:p,Feature:d,Dictionary:f}=await l(),y=n.fromJSON(t);let m;try{m=p.parseScript(r,u)}catch(E){return c.error(new s("arcade-bad-expression","Failed to parse arcade script",{script:r,error:E})),null}const h=o.reduce(((e,r)=>({...e,[r]:null})),{});let w=null;null!=i&&(w=new f(i),w.immutable=!0,h.$config=null);const g=p.scriptUsesGeometryEngine(m),v=g&&p.enableGeometrySupport(),_=p.scriptUsesFeatureSet(m)&&p.enableFeatureSetSupport(),S=p.scriptIsAsync(m),b=S&&p.enableAsyncSupport(),F={vars:h,spatialReference:y,useAsync:!!b};await Promise.all([v,_,b]);const $=new Set;await p.loadDependentModules($,m,null,S,g);const x=new f;x.immutable=!1,x.setField("scale",0);const R=p.compileScript(m,F),A=(e,r)=>("$view"in e&&e.$view&&(x.setField("scale","object"==typeof e.$view&&"scale"in e.$view?e.$view.scale:void 0),e.$view=x),w&&(e.$config=w),R({vars:e,spatialReference:y,services:r}));return new e(r,p,m,A,new d,a,y)};var r=e.prototype;return r.repurposeFeature=function(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature},r.referencesGeometry=function(){return this._referencesGeometry},r.referencesScale=function(){return this._referencesScale},t._createClass(e)}();r.ArcadeExpression=y,r.createDictionaryExpression=f,r.createLabelExpression=u,r.createRendererExpression=p,r.createVVExpression=d,r.loadArcade=l,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));
