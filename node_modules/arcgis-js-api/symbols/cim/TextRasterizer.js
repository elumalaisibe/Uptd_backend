/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../core/screenUtils","../support/textUtils"],(function(t,e,i){"use strict";function n(t){return`rgb(${t.slice(0,3).toString()})`}function s(t){return`rgba(${t.slice(0,3).toString()},${t[3]})`}function r(t,e){return"center"===t?.5*e:"right"===t?e:0}return function(){function o(t){t&&(this._textRasterizationCanvas=t)}var h=o.prototype;return h.rasterizeText=function(t,o){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const h=this._textRasterizationCanvas,a=h.getContext("2d");this._setFontProperties(a,o),this._parameters=o,this._textLines=t.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const{decoration:l,weight:c}=o.font;this._lineThroughWidthOffset=l&&"line-through"===l?.1*this._lineHeight:0;const d=null!=o.backgroundColor||null!=o.borderLine,_=d?i.BACKGROUND_PADDING:0,g=this._computeTextWidth(a,o)+2*_,f=this._lineHeight*this._textLines.length+2*_;if(h.width=g+2*this._lineThroughWidthOffset,h.height=f,0===h.width||0===h.height)return h.width=h.height=1,{size:[0,0],image:new Uint32Array(0),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0,canvas:h};this._renderedLineHeight=Math.round(this._lineHeight*o.pixelRatio),this._renderedHaloSize=e.pt2px(o.halo.size)*o.pixelRatio,this._renderedWidth=g*o.pixelRatio,this._renderedHeight=f*o.pixelRatio,this._lineThroughWidthOffset*=o.pixelRatio;const u=o.color??[0,0,0,0],p=o.halo&&o.halo.color?o.halo.color:[0,0,0,0];this._fillStyle=s(u),this._haloStyle=n(p);const x=this._renderedLineHeight,m=this._renderedHaloSize;a.save(),a.clearRect(0,0,h.width,h.height),this._setFontProperties(a,o);const b=_*o.pixelRatio,w=r(a.textAlign,this._renderedWidth-2*b)+m+b,z=m+b,v=m>0;let y=this._lineThroughWidthOffset,R=0;if(d){a.save();const t=o.backgroundColor??[0,0,0,0],i=o.borderLine?.color??[0,0,0,0],n=2*e.pt2px(o.borderLine?.size??0);a.fillStyle=s(t),a.strokeStyle=s(i),a.lineWidth=n,a.fillRect(0,0,h.width,h.height),a.strokeRect(0,0,h.width,h.height),a.restore()}v&&this._renderHalo(a,w,z,y,R,o),R+=z,y+=w;for(const e of this._textLines)v?(a.globalCompositeOperation="destination-out",a.fillStyle="rgb(0, 0, 0)",a.fillText(e,y,R),a.globalCompositeOperation="source-over",a.fillStyle=this._fillStyle,a.fillText(e,y,R)):(a.fillStyle=this._fillStyle,a.fillText(e,y,R)),l&&"none"!==l&&this._renderDecoration(a,y,R,l,c),R+=x;a.restore();const H=this._renderedWidth+2*this._lineThroughWidthOffset,C=this._renderedHeight,S=a.getImageData(0,0,H,C),T=new Uint8Array(S.data);if(o.premultiplyColors){let t;for(let e=0;e<T.length;e+=4)t=T[e+3]/255,T[e]=T[e]*t,T[e+1]=T[e+1]*t,T[e+2]=T[e+2]*t}let W,k;switch(o.horizontalAlignment){case"left":W=-.5;break;case"right":W=.5;break;default:W=0}switch(o.verticalAlignment){case"bottom":k=-.5;break;case"top":k=.5;break;default:k=0}return{size:[H,C],image:new Uint32Array(T.buffer),sdf:!1,simplePattern:!1,anchorX:W,anchorY:k,canvas:h}},h._renderHalo=function(t,e,i,n,s,r){const o=this._renderedWidth,h=this._renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=o,this._haloRasterizationCanvas.height=h;const a=this._haloRasterizationCanvas,l=a.getContext("2d");l.clearRect(0,0,o,h),this._setFontProperties(l,r);const{decoration:c,weight:d}=r.font;l.fillStyle=this._haloStyle,l.strokeStyle=this._haloStyle,l.lineJoin="round",this._renderHaloNative(l,e,i,c,d),t.globalAlpha=this._parameters.halo.color[3],t.drawImage(a,0,0,o,h,n,s,o,h),t.globalAlpha=1},h._renderHaloNative=function(t,e,i,n,s){const r=this._renderedLineHeight,o=this._renderedHaloSize;for(const h of this._textLines){const a=2*o,l=5,c=.1;for(let r=0;r<l;r++){const o=(1-(l-1)*c+r*c)*a;t.lineWidth=o,t.strokeText(h,e,i),n&&"none"!==n&&this._renderDecoration(t,e,i,n,s,o)}i+=r}},h._setFontProperties=function(t,i){const n=Math.max(i.size,.5),s=i.font,r=`${s.style} ${s.weight} ${e.pt2px(n*i.pixelRatio).toFixed(1)}px ${s.family}, sans-serif`;let o;switch(t.font=r,t.textBaseline="top",i.horizontalAlignment){case"left":default:o="left";break;case"right":o="right";break;case"center":o="center"}t.textAlign=o},h.computeTextSize=function(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const i=this._textRasterizationCanvas,n=i.getContext("2d");this._setFontProperties(n,e),this._parameters=e,this._textLines=t.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const s=this._computeTextWidth(n,e),r=this._lineHeight*this._textLines.length;return i.width=s,i.height=r,[s*e.pixelRatio,r*e.pixelRatio]},h._computeTextWidth=function(t,i){let n=0;for(const e of this._textLines)n=Math.max(n,t.measureText(e).width);const s=i.font;return("italic"===s.style||"oblique"===s.style||"string"==typeof s.weight&&("bold"===s.weight||"bolder"===s.weight)||"number"==typeof s.weight&&s.weight>600)&&(n+=.3*t.measureText("w").width),n+=2*e.pt2px(this._parameters.halo.size),Math.round(n)},h._computeLineHeight=function(){let t=1.275*this._parameters.size;const i=this._parameters.font.decoration;return i&&"underline"===i&&(t*=1.3),Math.round(t+2*e.pt2px(this._parameters.halo.size))},h._renderDecoration=function(t,e,i,n,s,r){const o=.9*this._lineHeight,h="bold"===s?.06:"bolder"===s?.09:.04;switch(t.textAlign){case"center":e-=this._renderedWidth/2;break;case"right":e-=this._renderedWidth}const a=t.textBaseline;if("underline"===n)switch(a){case"top":i+=o;break;case"middle":i+=o/2}else if("line-through"===n)switch(a){case"top":i+=o/1.5;break;case"middle":i+=o/3}const l=r?1.5*r:Math.ceil(o*h);t.save(),t.beginPath(),t.strokeStyle=t.fillStyle,t.lineWidth=l,t.moveTo(e-this._lineThroughWidthOffset,i),t.lineTo(e+this._renderedWidth+2*this._lineThroughWidthOffset,i),t.stroke(),t.restore()},t._createClass(o)}()}));
