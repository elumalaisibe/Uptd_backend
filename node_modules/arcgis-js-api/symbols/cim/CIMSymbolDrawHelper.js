/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../core/BidiText","../../core/fontUtils","../../core/lang","../../core/Logger","../../core/ObjectPool","../../core/screenUtils","../../geometry/GeometryCursor","../../geometry/support/aaBoundingRect","../../geometry/support/boundsUtils","../../geometry/support/centroid","../../geometry/support/jsonUtils","./CIMEffects","./CIMImageColorSubstitutionHelper","./CIMOperators","./CIMPlacements","./enums","./imageUtils","./Rect","./TextRasterizer","./utils","../../views/2d/engine/webgl/alignmentUtils","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/mesh/templates/shapingUtils"],(function(t,e,i,n,r,s,o,a,l,h,c,u,f,m,g,_,p,y,d,P,S,x,w,M,b){"use strict";const C=Math.PI/180,k=s.getLogger("esri.symbols.cim.CIMSymbolDrawHelper"),I=4,T=10,R=10,F=4,L=10,A=1;let v=function(){function t(t){this._t=t}t.createIdentity=function(){return new t([1,0,0,0,1,0])};var i=t.prototype;return i.clone=function(){return new t(this._t.slice())},i.transform=function(t){const e=this._t;return[e[0]*t[0]+e[1]*t[1]+e[2],e[3]*t[0]+e[4]*t[1]+e[5]]},t.createScale=function(e,i){return new t([e,0,0,0,i,0])},i.scale=function(t,e){const i=this._t;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=e,i[4]*=e,i[5]*=e,this},i.scaleRatio=function(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])},t.createTranslate=function(e,i){return new t([0,0,e,0,0,i])},i.translate=function(t,e){const i=this._t;return i[2]+=t,i[5]+=e,this},t.createRotate=function(e){const i=Math.cos(e),n=Math.sin(e);return new t([i,-n,0,n,i,0])},i.rotate=function(e){return t.multiply(this,t.createRotate(e),this)},i.angle=function(){const t=this._t[0],e=this._t[3],i=Math.sqrt(t*t+e*e);return[t/i,e/i]},t.multiply=function(t,e,i){const n=t._t,r=e._t,s=n[0]*r[0]+n[3]*r[1],o=n[1]*r[0]+n[4]*r[1],a=n[2]*r[0]+n[5]*r[1]+r[2],l=n[0]*r[3]+n[3]*r[4],h=n[1]*r[3]+n[4]*r[4],c=n[2]*r[3]+n[5]*r[4]+r[5],u=i._t;return u[0]=s,u[1]=o,u[2]=a,u[3]=l,u[4]=h,u[5]=c,i},i.invert=function(){const e=this._t;let i=e[0]*e[4]-e[1]*e[3];if(0===i)return new t([0,0,0,0,0,0]);i=1/i;const n=(e[1]*e[5]-e[2]*e[4])*i,r=(e[2]*e[3]-e[0]*e[5])*i;return new t([e[4]*i,-e[1]*i,n,-e[3]*i,e[0]*i,r])},e._createClass(t)}(),E=function(){function t(t,e){this._resourceManager=t,this._transfos=[],this._sizeTransfos=[],this._geomUnitsPerPoint=1,this._placementPool=new o(p.Placement,void 0,void 0,100),this._earlyReturn=!1,this._mapRotation=0,this._transfos.push(e||v.createIdentity()),this._sizeTransfos.push(e?e.scaleRatio():1)}var i=t.prototype;return i.setTransform=function(t,e){this._transfos=[t||v.createIdentity()],this._sizeTransfos=[e||(t?t.scaleRatio():1)]},i.setGeomUnitsPerPoint=function(t){this._geomUnitsPerPoint=t},i.transformPt=function(t){return this._transfos[this._transfos.length-1].transform(t)},i.transformSize=function(t){return t*this._sizeTransfos[this._sizeTransfos.length-1]},i.reverseTransformPt=function(t){return this._transfos[this._transfos.length-1].invert().transform(t)},i.reverseTransformSize=function(t){return t/this._sizeTransfos[this._sizeTransfos.length-1]},i.getTransformAngle=function(){return this._transfos[this._transfos.length-1].angle()},i.geomUnitsPerPoint=function(){return this.isEmbedded()?1:this._geomUnitsPerPoint},i.isEmbedded=function(){return this._transfos.length>1},i.back=function(){return this._transfos[this._transfos.length-1]},i.push=function(t,e){const i=e?t.scaleRatio():1;v.multiply(t,this.back(),t),this._transfos.push(t),this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*i)},i.pop=function(){this._transfos.splice(-1,1),this._sizeTransfos.splice(-1,1)},i.drawSymbol=function(t,e,i){if(t)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this.drawMultiLayerSymbol(t,e);break;case"CIMTextSymbol":this.drawTextSymbol(t,e,i)}},i.drawMultiLayerSymbol=function(t,e){if(!t||!e)return;const i=t.symbolLayers;if(!i)return;const n=t.effects;if(n&&n.length>0){const t=this.executeEffects(n,e);if(t){let e=t.next();for(;e;)this.drawSymbolLayers(i,e.asJSON()),e=t.next()}}else this.drawSymbolLayers(i,e)},i.executeEffects=function(t,e){const i=this._resourceManager.geometryEngine;let n=new m.SimpleEffectCursor(l.GeometryCursor.fromJSONCIM(e));for(const r of t){const t=_.getEffectOperator(r);t&&(n=t.execute(n,r,this.geomUnitsPerPoint(),null,i))}return n},i.drawSymbolLayers=function(t,e){let i=t.length;for(;i--;){const n=t[i];if(!n||!1===n.enable)continue;const r=n.effects;if(r&&r.length>0){const t=this.executeEffects(r,e);if(t){let e=null;for(;(e=t.next())&&(this.drawSymbolLayer(n,e.asJSON()),!this._earlyReturn););}}else this.drawSymbolLayer(n,e);if(this._earlyReturn)return}},i.drawSymbolLayer=function(t,e){switch(t.type){case"CIMSolidFill":this.drawSolidFill(e,t.color);break;case"CIMHatchFill":this.drawHatchFill(e,t);break;case"CIMPictureFill":this.drawPictureFill(e,t);break;case"CIMGradientFill":this.drawGradientFill(e,t);break;case"CIMSolidStroke":this.drawSolidStroke(e,t.color,t.width,t.capStyle,t.joinStyle,t.miterLimit);break;case"CIMPictureStroke":this.drawPictureStroke(e,t);break;case"CIMGradientStroke":this.drawGradientStroke(e,t);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":this.drawMarkerLayer(t,e)}},i.drawHatchFill=function(t,e){const i=this._buildHatchPolyline(e,t,this.geomUnitsPerPoint());i&&(this.pushClipPath(t),this.drawMultiLayerSymbol(e.lineSymbol,i),this.popClipPath())},i.drawPictureFill=function(t,e){},i.drawGradientFill=function(t,e){},i.drawPictureStroke=function(t,e){},i.drawGradientStroke=function(t,e){},i.drawMarkerLayer=function(t,e){const i=t.markerPlacement;if(i){const n=_.getPlacementOperator(i);if(n){const r="CIMMarkerPlacementInsidePolygon"===i.type||"CIMMarkerPlacementPolygonCenter"===i.type&&i.clipAtBoundary;r&&this.pushClipPath(e);const s=n.execute(l.GeometryCursor.fromJSONCIM(e),i,this.geomUnitsPerPoint(),null,this._resourceManager.geometryEngine);if(s){let e=null;for(;(e=s.next())&&(this.drawMarker(t,e),!this._earlyReturn););}r&&this.popClipPath()}}else{const i=this._placementPool.acquire();if(f.isPoint(e))i.tx=e.x,i.ty=e.y,this.drawMarker(t,i);else if(f.isPolygon(e)){const n=u.polygonCentroid(e);n&&([i.tx,i.ty]=n,this.drawMarker(t,i))}else for(const n of e.points)if(i.tx=n[0],i.ty=n[1],this.drawMarker(t,i),this._earlyReturn)break;this._placementPool.release(i)}},i.drawMarker=function(t,e){switch(t.type){case"CIMCharacterMarker":case"CIMPictureMarker":this.drawPictureMarker(t,e);break;case"CIMVectorMarker":this.drawVectorMarker(t,e)}},i.drawPictureMarker=function(t,e){if(!t)return;const i=this._resourceManager.getResource(t.url),n=x.getValue(t.size,T);if(null==i||n<=0)return;const r=i.width,s=i.height;if(!r||!s)return;const o=r/s,a=x.getValue(t.scaleX,1),l=v.createIdentity(),h=t.anchorPoint;if(h){let e=h.x,i=h.y;"Absolute"!==t.anchorPointUnits&&(e*=n*o*a,i*=n),l.translate(-e,-i)}let c=x.getValue(t.rotation);t.rotateClockwise&&(c=-c),this._mapRotation&&(c+=this._mapRotation),c&&l.rotate(c*C);let u=x.getValue(t.offsetX),f=x.getValue(t.offsetY);if(u||f){if(this._mapRotation){const t=C*this._mapRotation,e=Math.cos(t),i=Math.sin(t),n=u*i+f*e;u=u*e-f*i,f=n}l.translate(u,f)}const m=this.geomUnitsPerPoint();1!==m&&l.scale(m,m);const g=e.getAngle();g&&l.rotate(g),l.translate(e.tx,e.ty),this.push(l,!1),this.drawImage(t,n),this.pop()},i.drawVectorMarker=function(t,e){if(!t)return;const i=t.markerGraphics;if(!i)return;const n=x.getValue(t.size,T),r=t.frame,s=r?r.ymax-r.ymin:0,o=n&&s?n/s:1,a=v.createIdentity();r&&a.translate(.5*-(r.xmax+r.xmin),.5*-(r.ymax+r.ymin));const l=t.anchorPoint;if(l){let e=l.x,i=l.y;"Absolute"!==t.anchorPointUnits?r&&(e*=r.xmax-r.xmin,i*=r.ymax-r.ymin):(e/=o,i/=o),a.translate(-e,-i)}1!==o&&a.scale(o,o);let h=x.getValue(t.rotation);t.rotateClockwise&&(h=-h),this._mapRotation&&(h+=this._mapRotation),h&&a.rotate(h*C);let c=x.getValue(t.offsetX),u=x.getValue(t.offsetY);if(c||u){if(this._mapRotation){const t=C*this._mapRotation,e=Math.cos(t),i=Math.sin(t),n=c*i+u*e;c=c*e-u*i,u=n}a.translate(c,u)}const f=this.geomUnitsPerPoint();1!==f&&a.scale(f,f);const m=e.getAngle();m&&a.rotate(m),a.translate(e.tx,e.ty),this.push(a,t.scaleSymbolsProportionally);for(const g of i)if(g&&g.symbol&&g.geometry||k.error("Invalid marker graphic",g),this.drawSymbol(g.symbol,g.geometry,g.textString),this._earlyReturn)break;this.pop()},i.drawTextSymbol=function(t,e,i){if(!t)return;if(!f.isPoint(e))return;if(x.getValue(t.height,L)<=0)return;const n=v.createIdentity();let r=x.getValue(t.angle);r=-r,r&&n.rotate(r*C);const s=x.getValue(t.offsetX),o=x.getValue(t.offsetY);(s||o)&&n.translate(s,o);const a=this.geomUnitsPerPoint();1!==a&&n.scale(a,a),n.translate(e.x,e.y),this.push(n,!1),this.drawText(t,i),this.pop()},i._buildHatchPolyline=function(t,e,i){let n=x.getValue(t.separation,F)*i,r=x.getValue(t.rotation);if(0===n)return null;n<0&&(n=-n);let s=0;const o=.5*n;for(;s>o;)s-=n;for(;s<-o;)s+=n;const a=h.create();c.getBoundsXY(a,e),a[0]-=o,a[1]-=o,a[2]+=o,a[3]+=o;const l=[[a[0],a[1]],[a[0],a[3]],[a[2],a[3]],[a[2],a[1]]];for(;r>180;)r-=180;for(;r<0;)r+=180;const u=Math.cos(r*C),f=Math.sin(r*C),m=-n*f,g=n*u;let _,p,y,d;s=x.getValue(t.offsetX)*i*f-x.getValue(t.offsetY)*i*u,_=y=Number.MAX_VALUE,p=d=-Number.MAX_VALUE;for(const h of l){const t=h[0],e=h[1],i=u*t+f*e,n=-f*t+u*e;_=Math.min(_,i),y=Math.min(y,n),p=Math.max(p,i),d=Math.max(d,n)}y=Math.floor(y/n)*n;let P=u*_-f*y-m*s/n,S=f*_+u*y-g*s/n,w=u*p-f*y-m*s/n,M=f*p+u*y-g*s/n;const b=1+Math.round((d-y)/n),k=[];for(let h=0;h<b;h++)P+=m,S+=g,w+=m,M+=g,k.push([[P,S],[w,M]]);return{paths:k}},e._createClass(t)}(),H=function(t){function i(e,i){var n;return(n=t.call(this,e,i)||this).reset(),n}e._inherits(i,t);var n=i.prototype;return n.reset=function(){this._xmin=this._ymin=1/0,this._xmax=this._ymax=-1/0,this._clipCount=0},n.envelope=function(){return new P(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)},n.bounds=function(){return h.fromValues(this._xmin,this._ymin,this._xmax,this._ymax)},n.drawSolidFill=function(t){if(t&&!(this._clipCount>0))if(f.isPolygon(t))this._processPath(t.rings,0);else if(f.isPolyline(t))this._processPath(t.paths,0);else if(f.isExtent(t)){const e=G(t);e&&this._processPath(e.rings,0)}else console.error("drawSolidFill Unexpected geometry type!")},n.drawSolidStroke=function(t,e,i){if(!t||this._clipCount>0)return;const n=.5*this.transformSize(x.getValue(i,I));if(f.isPolygon(t))this._processPath(t.rings,n);else if(f.isPolyline(t))this._processPath(t.paths,n);else if(f.isExtent(t)){const e=G(t);e&&this._processPath(e.rings,n)}else console.error("drawSolidStroke unexpected geometry type!")},n.drawMarkerLayer=function(t,n){f.isPolygon(n)&&t.markerPlacement&&("CIMMarkerPlacementInsidePolygon"===t.markerPlacement.type||"CIMMarkerPlacementPolygonCenter"===t.markerPlacement.type&&t.markerPlacement.clipAtBoundary)?this._processPath(n.rings,0):e._get(e._getPrototypeOf(i.prototype),"drawMarkerLayer",this).call(this,t,n)},n.drawHatchFill=function(t,e){this.drawSolidFill(t)},n.drawPictureFill=function(t,e){this.drawSolidFill(t)},n.drawGradientFill=function(t,e){this.drawSolidFill(t)},n.drawPictureStroke=function(t,e){this.drawSolidStroke(t,null,e.width)},n.drawGradientStroke=function(t,e){this.drawSolidStroke(t,null,e.width)},n.pushClipPath=function(t){this.drawSolidFill(t),this._clipCount++},n.popClipPath=function(){this._clipCount--},n.drawImage=function(t,e){const{url:i}=t,n=x.getValue(t.scaleX,1);let r=n*e,s=e;const o=this._resourceManager.getResource(i);e||null==o||(r=n*o.width,s=o.height),this._merge(this.transformPt([-r/2,-s/2]),0),this._merge(this.transformPt([-r/2,s/2]),0),this._merge(this.transformPt([r/2,-s/2]),0),this._merge(this.transformPt([r/2,s/2]),0)},n.drawText=function(t,e){if(!e||0===e.length)return;this._textRasterizer||(this._textRasterizer=new S);const i=X(t),[n,r]=this._textRasterizer.computeTextSize(e,i);let s=0;switch(t.horizontalAlignment){case"Left":s=n/2;break;case"Right":s=-n/2}let o=0;switch(t.verticalAlignment){case"Bottom":o=r/2;break;case"Top":o=-r/2;break;case"Baseline":o=r/6}this._merge(this.transformPt([-n/2+s,-r/2+o]),0),this._merge(this.transformPt([-n/2+s,r/2+o]),0),this._merge(this.transformPt([n/2+s,-r/2+o]),0),this._merge(this.transformPt([n/2+s,r/2+o]),0)},n._processPath=function(t,e){if(t)for(const i of t){const t=i?i.length:0;if(t>1){this._merge(this.transformPt(i[0]),e);for(let n=1;n<t;n++)this._merge(this.transformPt(i[n]),e)}}},n._merge=function(t,e){t[0]-e<this._xmin&&(this._xmin=t[0]-e),t[0]+e>this._xmax&&(this._xmax=t[0]+e),t[1]-e<this._ymin&&(this._ymin=t[1]-e),t[1]+e>this._ymax&&(this._ymax=t[1]+e)},e._createClass(i)}(E),z=function(t){function n(){var e;return(e=t.apply(this,arguments)||this)._searchPoint=[0,0],e._searchDistPoint=0,e._textInfo=null,e}e._inherits(n,t);var r=n.prototype;return r.hitTest=function(t,e,i,n,r,s){const o=s*a.pt2px(1);this.setTransform(),this.setGeomUnitsPerPoint(o),this._searchPoint=[(t[0]+t[2])/2,(t[1]+t[3])/2],this._searchDistPoint=(t[2]-t[0])/2/o,this._textInfo=n;const l=e&&("CIMPointSymbol"===e.type&&"Map"!==e.angleAlignment||"CIMTextSymbol"===e.type);return this._mapRotation=l?r:0,this._earlyReturn=!1,this.drawSymbol(e,i),this._earlyReturn},r.drawSolidFill=function(t,e){this._hitTestFill(t)},r.drawHatchFill=function(t,e){this._hitTestFill(t)},r.drawPictureFill=function(t,e){this._hitTestFill(t)},r.drawGradientFill=function(t,e){this._hitTestFill(t)},r.drawSolidStroke=function(t,e,i,n,r,s){this._hitTestStroke(t,i)},r.drawPictureStroke=function(t,e){this._hitTestStroke(t,e.width)},r.drawGradientStroke=function(t,e){this._hitTestStroke(t,e.width)},r.drawMarkerLayer=function(t,i){t.markerPlacement&&("CIMMarkerPlacementInsidePolygon"===t.markerPlacement.type||"CIMMarkerPlacementPolygonCenter"===t.markerPlacement.type&&t.markerPlacement.clipAtBoundary)?this._hitTestFill(i):e._get(e._getPrototypeOf(n.prototype),"drawMarkerLayer",this).call(this,t,i)},r.pushClipPath=function(t){},r.popClipPath=function(){},r.drawImage=function(t,e){const{url:i}=t,n=x.getValue(t.scaleX,1),r=this._resourceManager.getResource(i);if(null==r||0===r.height||0===e)return;const s=e*this.geomUnitsPerPoint(),o=s*n*(r.width/r.height),a=this.reverseTransformPt(this._searchPoint),l=this._searchDistPoint;Math.abs(a[0])<o/2+l&&Math.abs(a[1])<s/2+l&&(this._earlyReturn=!0)},r.drawText=function(t,e){const n=this._textInfo;if(!n)return;const r=n.get(t);if(!r)return;const{text:s,mosaicItem:o}=r;if(!o?.glyphMosaicItems?.length)return;const a=x.getValue(t.height,L),{lineGapType:l,lineGap:h}=t,c=l?O(l,x.getValue(h),a):0,u=i.bidiText(s)[1],f=o.glyphMosaicItems,m="CIMBackgroundCallout"===t.callout?.type,g=b.shapeGlyphs(f,u,{scale:a/M.GLYPH_SIZE,angle:0,xOffset:0,yOffset:0,hAlign:D(t.horizontalAlignment),vAlign:B(t.verticalAlignment),maxLineWidth:512,lineHeight:M.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(c||1,4)),decoration:t.font.decoration||"none",isCIM:!0,hasBackground:m}),_=this.reverseTransformPt(this._searchPoint),p=_[0],y=_[1];for(const i of g.glyphs)if(p>i.xTopLeft&&p<i.xBottomRight&&y>-i.yBottomRight&&y<-i.yTopLeft){this._earlyReturn=!0;break}},r._hitTestFill=function(t){let e=null;if(f.isExtent(t)){const i=t;e=[[[i.xmin,i.ymin],[i.xmin,i.ymax],[i.xmax,i.ymax],[i.xmax,i.ymin],[i.xmin,i.ymin]]]}else if(f.isPolygon(t))e=t.rings;else{if(!f.isPolyline(t))return;e=t.paths}const i=this.reverseTransformPt(this._searchPoint);if(this._pointInPolygon(i,e)&&(this._earlyReturn=!0),!this._earlyReturn){const t=this.reverseTransformSize(this._searchDistPoint)*this.geomUnitsPerPoint();this._nearLine(i,e,t)&&(this._earlyReturn=!0)}},r._hitTestStroke=function(t,e){let i=null;if(f.isExtent(t)){const e=t;i=[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}else if(f.isPolygon(t))i=t.rings;else{if(!f.isPolyline(t))return;i=t.paths}const n=this.reverseTransformPt(this._searchPoint),r=x.getValue(e,I)*this.geomUnitsPerPoint(),s=this.reverseTransformSize(this._searchDistPoint)*this.geomUnitsPerPoint();this._nearLine(n,i,r/2+s)&&(this._earlyReturn=!0)},r._pointInPolygon=function(t,e){let i=0;for(const n of e){const e=n.length;for(let r=1;r<e;r++){const e=n[r-1],s=n[r];if(e[1]>t[1]==s[1]>t[1])continue;(s[0]-e[0])*(t[1]-e[1])-(s[1]-e[1])*(t[0]-e[0])>0?i++:i--}}return 0!==i},r._nearLine=function(t,e,i){for(const n of e){const e=n.length;for(let r=1;r<e;r++){const e=n[r-1],s=n[r];let o=(s[0]-e[0])*(s[0]-e[0])+(s[1]-e[1])*(s[1]-e[1]);if(0===o)continue;o=Math.sqrt(o);const a=((s[0]-e[0])*(t[1]-e[1])-(s[1]-e[1])*(t[0]-e[0]))/o;if(Math.abs(a)<i){const n=((s[0]-e[0])*(t[0]-e[0])+(s[1]-e[1])*(t[1]-e[1]))/o;if(n>-i&&n<o+i)return!0}}}return!1},e._createClass(n)}(E),V=function(t){function i(e,i,n,r){var s;return(s=t.call(this,i,n)||this)._applyAdditionalRenderProps=r,s._colorSubstitutionHelper=new g,s._ctx=e,s}e._inherits(i,t);var n=i.prototype;return n.drawSolidFill=function(t,e){if(!t)return;if(f.isPolygon(t))this._buildPath(t.rings,!0);else if(f.isPolyline(t))this._buildPath(t.paths,!0);else if(f.isExtent(t))this._buildPath(G(t).rings,!0);else{if(!f.isMultipoint(t))return;console.log("CanvasDrawHelper.drawSolidFill - No implementation!")}const i=this._ctx;i.fillStyle="string"==typeof e?e:"rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+(e[3]??255)/255+")",i.fill("evenodd")},n.drawSolidStroke=function(t,e,i,n,r,s){if(!t||!e||0===i)return;if(f.isPolygon(t))this._buildPath(t.rings,!0);else if(f.isPolyline(t))this._buildPath(t.paths,!1);else{if(!f.isExtent(t))return void console.log("CanvasDrawHelper.drawSolidStroke isn't implemented!");this._buildPath(G(t).rings,!0)}const o=this._ctx;o.strokeStyle="string"==typeof e?e:"rgba("+Math.round(e[0])+","+Math.round(e[1])+","+Math.round(e[2])+","+(e[3]??255)/255+")",o.lineWidth=Math.max(this.transformSize(i),.5),this._setCapStyle(n),this._setJoinStyle(r),o.miterLimit=s,o.stroke()},n.pushClipPath=function(t){if(this._ctx.save(),f.isPolygon(t))this._buildPath(t.rings,!0);else if(f.isPolyline(t))this._buildPath(t.paths,!0);else{if(!f.isExtent(t))return;this._buildPath(G(t).rings,!0)}this._ctx.clip("evenodd")},n.popClipPath=function(){this._ctx.restore()},n.drawImage=function(t,e){const{colorSubstitutions:i,url:n,tintColor:r}=t,s=x.getValue(t.scaleX,1),o=this._resourceManager.getResource(n);if(null==o)return;let a=e*(o.width/o.height),l=e;e||(a=o.width,l=o.height);const h=x.isSVGImage(n)||"src"in o&&x.isSVGImage(o.src);let c="getFrame"in o?d.getFirstFrame(o):o;i&&(c=this._colorSubstitutionHelper.applyColorSubstituition(c,i)),this._applyAdditionalRenderProps&&!h&&r&&(c=this._colorSubstitutionHelper.tintImageData(c,r));const u=this.transformPt([0,0]),[f,m]=this.getTransformAngle(),g=this.transformSize(1),_=this._ctx;_.save(),_.setTransform({m11:s*g*f,m12:s*g*m,m21:-g*m,m22:g*f,m41:u[0],m42:u[1]}),_.drawImage(c,-a/2,-l/2,a,l),_.restore()},n.drawText=function(t,e){if(!e||0===e.length)return;this._textRasterizer||(this._textRasterizer=new S);const i=X(t);i.size*=this.transformSize(a.px2pt(1));const n=this._textRasterizer.rasterizeText(e,i);if(!n)return;const{size:r,anchorX:s,anchorY:o,canvas:l}=n,h=r[0]*(s+.5),c=r[1]*(o-.5),u=this._ctx,f=this.transformPt([0,0]),[m,g]=this.getTransformAngle(),_=1;u.save(),u.setTransform({m11:_*m,m12:_*g,m21:-_*g,m22:_*m,m41:f[0]-_*h,m42:f[1]+_*c}),u.drawImage(l,0,0),u.restore()},n.drawPictureFill=function(t,e){if(!t)return;let{colorSubstitutions:i,height:n,offsetX:r,offsetY:s,rotation:o,scaleX:a,tintColor:l,url:h}=e;const c=this._resourceManager.getResource(h);if(null==c)return;if(f.isPolygon(t))this._buildPath(t.rings,!0);else if(f.isPolyline(t))this._buildPath(t.paths,!0);else if(f.isExtent(t))this._buildPath(G(t).rings,!0);else{if(!f.isMultipoint(t))return;console.log("CanvasDrawHelper.drawPictureFill - No implementation!")}const u=this._ctx,m=x.isSVGImage(h)||"src"in c&&x.isSVGImage(c.src);let g,_="getFrame"in c?d.getFirstFrame(c):c;if(i&&(_=this._colorSubstitutionHelper.applyColorSubstituition(_,i)),this._applyAdditionalRenderProps){m||l&&(_=this._colorSubstitutionHelper.tintImageData(_,l)),g=u.createPattern(_,"repeat");const t=this.transformSize(1);o||(o=0),r?r*=t:r=0,s?s*=t:s=0,n&&(n*=t);const e=n?n/c.height:1,i=a&&n?a*n/c.width:1;if(0!==o||1!==e||1!==i||0!==r||0!==s){const t=new DOMMatrix;t.rotateSelf(0,0,-o).translateSelf(r,s).scaleSelf(i,e,1),g.setTransform(t)}}else g=u.createPattern(_,"repeat");u.save(),u.fillStyle=g,u.fill("evenodd"),u.restore()},n.drawPictureStroke=function(t,e){if(!t)return;let{colorSubstitutions:i,capStyle:n,joinStyle:s,miterLimit:o,tintColor:l,url:h,width:c}=e;const u=this._resourceManager.getResource(h);if(null==u)return;let m;if(f.isPolygon(t))m=t.rings;else if(f.isPolyline(t))m=t.paths;else{if(!f.isExtent(t))return f.isMultipoint(t)?void console.log("CanvasDrawHelper.drawPictureStroke - No implementation!"):void 0;m=G(t).rings}c||(c=u.width);const g=x.isSVGImage(h)||"src"in u&&x.isSVGImage(u.src);let _="getFrame"in u?d.getFirstFrame(u):u;i&&(_=this._colorSubstitutionHelper.applyColorSubstituition(_,i)),this._applyAdditionalRenderProps&&(g||l&&(_=this._colorSubstitutionHelper.tintImageData(_,l)));const p=Math.max(this.transformSize(a.pt2px(c)),.5),y=p/_.width,P=this._ctx,S=P.createPattern(_,"repeat-y");let w,M;P.save(),this._setCapStyle(n),this._setJoinStyle(s),void 0!==o&&(P.miterLimit=o),P.lineWidth=p;for(let a of m)if(a=r.clone(a),N(a),a&&!(a.length<=1)){w=this.transformPt(a[0]);for(let t=1;t<a.length;t++){M=this.transformPt(a[t]);const e=U(w,M),i=new DOMMatrix;i.translateSelf(0,w[1]-p/2).scaleSelf(y,y,1).rotateSelf(0,0,90-e),S.setTransform(i),P.strokeStyle=S,P.beginPath(),P.moveTo(w[0],w[1]),P.lineTo(M[0],M[1]),P.stroke(),w=M}}P.restore()},n._buildPath=function(t,e){const i=this._ctx;if(i.beginPath(),t)for(const n of t){const t=n?n.length:0;if(t>1){let r=this.transformPt(n[0]);i.moveTo(r[0],r[1]);for(let e=1;e<t;e++)r=this.transformPt(n[e]),i.lineTo(r[0],r[1]);e&&i.closePath()}}},n._setCapStyle=function(t){switch(t){case y.LineCapStyle.Butt:this._ctx.lineCap="butt";break;case y.LineCapStyle.Round:this._ctx.lineCap="round";break;case y.LineCapStyle.Square:this._ctx.lineCap="square"}},n._setJoinStyle=function(t){switch(t){case y.LineJoinStyle.Bevel:this._ctx.lineJoin="bevel";break;case y.LineJoinStyle.Round:this._ctx.lineJoin="round";break;case y.LineJoinStyle.Miter:this._ctx.lineJoin="miter"}},e._createClass(i)}(E);function U(t,e){const i=e[0]-t[0],n=e[1]-t[1];return 180/Math.PI*Math.atan2(n,i)}const G=t=>t?{spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]}:null,D=t=>{switch(t){case"Left":return w.HAlign.Left;case"Right":return w.HAlign.Right;case"Center":return w.HAlign.Center;case"Justify":return k.warnOnce("Horizontal alignment 'justify' is not implemented. Falling back to 'center'."),w.HAlign.Center}},B=t=>{switch(t){case"Top":return w.VAlign.Top;case"Center":return w.VAlign.Center;case"Bottom":return w.VAlign.Bottom;case"Baseline":return w.VAlign.Baseline}},O=(t,e,i)=>{switch(t){case"ExtraLeading":return 1+e/i;case"Multiple":return e;case"Exact":return e/i}};function X(t,e=1){const i=x.fromCIMFontDecoration(t),r=x.fromCIMFontStyle(t.fontStyleName),s=t.fontFamilyName??n.DEFAULT_FONT_FAMILY,{weight:o,style:a}=r,l=e*(t.height||5),h=x.fromCIMHorizontalAlignment(t.horizontalAlignment),c=x.fromCIMVerticalAlignment(t.verticalAlignment),u=x.getFillColor(t),f=x.getFillColor(t.haloSymbol),m=f?e*(0|t.haloSize):0,g="CIMBackgroundCallout"===t.callout?.type?t.callout.backgroundSymbol:null,_=x.getFillColor(g),p=x.getStrokeWidth(g),y=x.getStrokeColor(g);return{color:u,size:l,horizontalAlignment:h,verticalAlignment:c,font:{family:s,style:x.getFontStyle(a),weight:x.getFontWeight(o),decoration:i},halo:{size:m||0,color:f,style:a},backgroundColor:_,borderLine:null!=p&&null!=y?{size:p,color:y}:null,pixelRatio:1,premultiplyColors:!0}}const J=1e-4;function N(t){let e,i,n,r,s,o=t[0],a=1;for(;a<t.length;)e=t[a][0]-o[0],i=t[a][1]-o[1],r=0!==e?i/e:Math.PI/2,void 0!==n&&r-n<=J?(t.splice(a-1,1),o=s):(s=o,o=t[a],a++),n=r}t.CIMSymbolDrawHelper=E,t.C_DEG_TO_RAD=C,t.CanvasDrawHelper=V,t.DEFAULT_HATCH_FILL_SEPARATION=F,t.DEFAULT_MARKER_SIZE=T,t.DEFAULT_PICTURE_FILL_HEIGHT=R,t.DEFAULT_STROKE_WIDTH=I,t.DEFAULT_TEXT_HALO_SIZE=A,t.DEFAULT_TEXT_HEIGHT=L,t.EnvDrawHelper=H,t.HittestDrawHelper=z,t.Transformation=v,t.horizontalAlignment2HAlign=D,t.lineGapType2LineHeight=O,t.verticalAlignment2VAlign=B,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
