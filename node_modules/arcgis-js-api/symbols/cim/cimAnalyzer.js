/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../Color","../../core/fontUtils","../../core/lang","../../core/Logger","../../core/screenUtils","../../core/string","../../support/arcadeOnDemand","./CIMSymbolDrawHelper","./CIMSymbolHelper","./enums","./quantizeTime","./SDFHelper","./utils","./effects/CIMEffectHelper","../../views/2d/arcade/callExpressionWithFeature","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/grouping"],(function(e,t,i,r,o,n,a,l,s,c,u,f,m,h,p,y,d,v,g){"use strict";const _=n.getLogger("esri.symbols.cim.cimAnalyzer");function S(e){switch(e){case"Butt":return f.CapType.BUTT;case"Square":return f.CapType.SQUARE;default:return f.CapType.ROUND}}function O(e){switch(e){case"Bevel":return f.JoinType.BEVEL;case"Miter":return f.JoinType.MITER;default:return f.JoinType.ROUND}}function F(e){const t=e.markerPlacement;return t&&t.angleToLine?f.Alignment.MAP:f.Alignment.SCREEN}let M=function(){function e(e,t){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],this._resourceManager=e,this._info=t}var i=e.prototype;return i.analyzeSymbolReference=async function(e,t,i){if(this._cimLayers=i??[],!e)return this._cimLayers;if(e.primitiveOverrides){this._primitiveOverrides=e.primitiveOverrides,this._poMap={};const t=[],i=this._info;for(const e of this._primitiveOverrides){const r=e.valueExpressionInfo;if(r&&i){const o=r.expression,n=s.createRendererExpression(o,i.spatialReference,i.fields).then((t=>{null!=t&&this._setPoMap(e.primitiveName,e.propertyName,t)}));t.push(n)}else null!=e.value&&this._setPoMap(e.primitiveName,e.propertyName,e.value);t.length>0&&await Promise.all(t)}}const r=e.symbol,o=[];return u.CIMSymbolHelper.fetchResources(r,this._resourceManager,o),o.length>0&&await Promise.all(o),this._analyzeSymbol(r,t),this._cimLayers},i._analyzeSymbol=function(e,t){switch(e?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(e,t,1,0,0,0)}},i._analyzeMultiLayerSymbol=function(e,t,i,r,o,n){const a=e?.symbolLayers;if(!a)return;const l=e.effects;let s=f.Alignment.SCREEN;const c=u.CIMSymbolHelper.getSize(e)??0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(s=f.Alignment.MAP);const m="CIMPolygonSymbol"===e.type;let h=a.length;for(;h--;){const f=a[h];if(!f||!1===f.enable)continue;let p;l&&l.length&&(p=[...l]);const y=f.effects;y&&y.length&&(l?p.push(...y):p=[...y]);const d=[];let v;u.OverrideHelper.findEffectOverrides(p,this._primitiveOverrides,d),v=d.length>0?this._createEffectsOverrideFunction(p,d):p;const g=[];switch(u.OverrideHelper.findApplicableOverrides(f,this._primitiveOverrides,g),f.type){case"CIMSolidFill":this._analyzeSolidFill(f,v);break;case"CIMPictureFill":this._analyzePictureFill(f,v);break;case"CIMHatchFill":this._analyzeHatchFill(f,v);break;case"CIMGradientFill":this._analyzeGradientFill(f,v);break;case"CIMSolidStroke":this._analyzeSolidStroke(f,v,m,c);break;case"CIMPictureStroke":this._analyzePictureStroke(f,v,m,c);break;case"CIMGradientStroke":this._analyzeGradientStroke(f,v,m,c);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"===e.type&&(s=F(f));const a=[],l=f.primitiveName;l&&a.push(l),this._analyzeMarker(f,v,null,a,s,c,1,t,i,r,o,n);break}default:_.error("Cannot analyze CIM layer",f.type)}}},i._analyzeSolidFill=function(e,t){const i=e.primitiveName,r=p.fromCIMColor(e.color),[o,n]=this._analyzePrimitiveOverrides(i,t,null,null),a=l.numericHash(JSON.stringify(e)+n).toString();this._cimLayers.push({type:"fill",templateHash:a,materialHash:o?()=>a:a,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,color:this._createOverrideFunction(i,"Color",r,k),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t,applyRandomOffset:!1,sampleAlphaOnly:!0})},i._analyzePictureFill=function(e,t){const i=e.primitiveName,r=p.getTintColor(e),[o,n]=this._analyzePrimitiveOverrides(i,t,null,null),a=l.numericHash(JSON.stringify(e)+n).toString(),s=l.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),u=p.getValue(e.height,c.DEFAULT_PICTURE_FILL_HEIGHT);let f=p.getValue(e.scaleX,1);if("width"in e&&"number"==typeof e.width){const t=e.width;let i=1;const r=this._resourceManager.getResource(e.url);null!=r&&(i=r.width/r.height),f/=i*(u/t)}this._cimLayers.push({type:"fill",templateHash:a,materialHash:o?()=>s:s,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(i,"TintColor",r,k),height:this._createOverrideFunction(i,"Height",u),scaleX:this._createOverrideFunction(i,"ScaleX",f),angle:this._createOverrideFunction(i,"Rotation",p.getValue(e.rotation)),offsetX:this._createOverrideFunction(i,"OffsetX",p.getValue(e.offsetX)),offsetY:this._createOverrideFunction(i,"OffsetY",p.getValue(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})},i._analyzeHatchFill=function(e,t){const i=e.primitiveName,r=this._analyzeMaterialOverrides(i,["Rotation","OffsetX","OffsetY"]);let[o,n]=this._analyzePrimitiveOverrides(i,t,null,null);const a=l.numericHash(JSON.stringify(e)+n).toString(),s=l.numericHash(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let u={r:255,g:255,b:255,a:1},f=!1;const m=e.lineSymbol?.symbolLayers?.find((e=>"CIMSolidStroke"===e.type&&null!=this._poMap[e.primitiveName]?.Color));if(m){u=p.fromCIMColor(m.color),u=this._createOverrideFunction(m.primitiveName,"Color",u,k);const e="function"==typeof u;o=o||e,f=null!=m.color||e}this._cimLayers.push({type:"fill",templateHash:a,materialHash:o&&r?this._createMaterialHashFunction(s,r):s,cim:e,materialOverrides:r,colorLocked:!!e.colorLocked,effects:t,color:u,height:this._createOverrideFunction(i,"Separation",p.getValue(e.separation,c.DEFAULT_HATCH_FILL_SEPARATION)),scaleX:1,angle:this._createOverrideFunction(i,"Rotation",p.getValue(e.rotation)),offsetX:this._createOverrideFunction(i,"OffsetX",p.getValue(e.offsetX)),offsetY:this._createOverrideFunction(i,"OffsetY",p.getValue(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!f})},i._analyzeGradientFill=function(e,t){const i=e.primitiveName,[r,o]=this._analyzePrimitiveOverrides(i,t,null,null),n=l.numericHash(JSON.stringify(e)+o).toString();this._cimLayers.push({type:"fill",templateHash:n,materialHash:r?()=>n:n,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})},i._analyzeSolidStroke=function(e,t,i,r){const o=e.primitiveName,n=p.fromCIMColor(e.color),a=p.getValue(e.width,c.DEFAULT_STROKE_WIDTH),s=S(e.capStyle),u=O(e.joinStyle),f=e.miterLimit,[m,h]=this._analyzePrimitiveOverrides(o,t,null,null),y=l.numericHash(JSON.stringify(e)+h).toString();let d,v;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();d=e.dashTemplate,v=e.scaleDash}}this._cimLayers.push({type:"line",templateHash:y,materialHash:m?()=>y:y,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(o,"Color",n,k),width:this._createOverrideFunction(o,"Width",a),cap:this._createOverrideFunction(o,"CapStyle",s),join:this._createOverrideFunction(o,"JoinStyle",u),miterLimit:f&&this._createOverrideFunction(o,"MiterLimit",f),referenceWidth:r,zOrder:C(e.name),dashTemplate:d,scaleDash:v,sampleAlphaOnly:!0})},i._analyzePictureStroke=function(e,t,i,r){const o=l.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),n=e.primitiveName,a=p.getTintColor(e),s=p.getValue(e.width,c.DEFAULT_STROKE_WIDTH),u=S(e.capStyle),f=O(e.joinStyle),m=e.miterLimit,[h,y]=this._analyzePrimitiveOverrides(n,t,null,null),d=l.numericHash(JSON.stringify(e)+y).toString();this._cimLayers.push({type:"line",templateHash:d,materialHash:h?()=>o:o,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:this._createOverrideFunction(n,"TintColor",a,k),width:this._createOverrideFunction(n,"Width",s),cap:this._createOverrideFunction(n,"CapStyle",u),join:this._createOverrideFunction(n,"JoinStyle",f),miterLimit:m&&this._createOverrideFunction(n,"MiterLimit",m),referenceWidth:r,zOrder:C(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})},i._analyzeGradientStroke=function(e,t,i,r){const o=e.primitiveName,n=p.getValue(e.width,c.DEFAULT_STROKE_WIDTH),a=S(e.capStyle),s=O(e.joinStyle),u=e.miterLimit,[f,m]=this._analyzePrimitiveOverrides(o,t,null,null),h=l.numericHash(JSON.stringify(e)+m).toString();this._cimLayers.push({type:"line",templateHash:h,materialHash:f?()=>h:h,cim:e,materialOverrides:null,isOutline:i,colorLocked:!!e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:this._createOverrideFunction(o,"Width",n),cap:this._createOverrideFunction(o,"CapStyle",a),join:this._createOverrideFunction(o,"JoinStyle",s),miterLimit:u&&this._createOverrideFunction(o,"MiterLimit",u),referenceWidth:r,zOrder:C(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})},i._analyzeMarker=function(e,t,i,r,o,n,a,l,s,u,f,m,h=!1){if(this._analyzeMarkerInsidePolygon(e,t))return;const y=p.getValue(e.size,c.DEFAULT_MARKER_SIZE),d=p.getValue(e.rotation),v=p.getValue(e.offsetX),g=p.getValue(e.offsetY);let _=this._createOverrideFunction(e.primitiveName,"Size",y),S=this._createOverrideFunction(e.primitiveName,"Rotation",d),O=this._createOverrideFunction(e.primitiveName,"OffsetX",v),F=this._createOverrideFunction(e.primitiveName,"OffsetY",g);_=this._transformSize(_,a),S=this._transformRotation(S,!!e.rotateClockwise,u);const M=this._transformOffsetX(O,F,u,a,f),C=this._transformOffsetY(O,F,u,a,m);switch(O=M,F=C,e.type){case"CIMPictureMarker":this._analyzePictureMarker(e,t,i,r,o,n,_,S,O,F,e.colorLocked||h);break;case"CIMVectorMarker":this._analyzeVectorMarker(e,t,i,r,o,n,a,l,_,S,O,F,e.colorLocked||h)}},i._analyzeMarkerInsidePolygon=function(e,t){const{markerPlacement:i,type:r}=e;if(!i||"CIMMarkerPlacementInsidePolygon"!==i.type)return!1;if("CIMVectorMarker"===r||"CIMPictureMarker"===r){const o=e.primitiveName;if(o){const[e,i]=this._analyzePrimitiveOverrides([o],t,null,null);if(e)return!1}const n=i.primitiveName;if(n){const[e,i]=this._analyzePrimitiveOverrides([n],t,null,null);if(e)return!1}if("CIMVectorMarker"===r){const{markerGraphics:t}=e;if(t)for(const e of t){const{symbol:t}=e;if("CIMPolygonSymbol"===t?.type&&t.symbolLayers){const{symbolLayers:e}=t;for(const t of e)if("CIMSolidStroke"===t.type)return!1}}}else{const{animatedSymbolProperties:t}=e;if(t)return!1}}const o=i,n=Math.abs(o.stepX),s=Math.abs(o.stepY);if(0===n||0===s)return!0;const c=["Rotation","OffsetX","OffsetY"],u=this._primitiveOverrides.filter((t=>t.primitiveName!==e.primitiveName||!c.includes(t.propertyName))),f="url"in e&&"string"==typeof e.url?e.url:void 0,m=l.numericHash(JSON.stringify(e)).toString();let h,y,d=null;if("Random"===i.gridType){const e=a.px2pt(v.RANDOM_INSIDE_POLYGON_TEXTURE_SIZE),t=Math.max(Math.floor(e/n),1),i=Math.max(Math.floor(e/s),1);h=s*i,d=e=>e?e*i:0;y=t*n/h}else i.shiftOddRows?(h=2*s,d=e=>e?2*e:0,y=n/s*.5):(h=s,d=null,y=n/s);const g=p.getTintColor(e);return this._cimLayers.push({type:"fill",templateHash:m,materialHash:m,cim:e,materialOverrides:u,colorLocked:!!e.colorLocked,effects:t,color:g,height:this._createOverrideFunction(o.primitiveName,"StepY",h,d),scaleX:y,angle:o.gridAngle,offsetX:p.getValue(o.offsetX),offsetY:p.getValue(o.offsetY),url:f,applyRandomOffset:"Random"===i.gridType,sampleAlphaOnly:!f,hasUnresolvedReplacementColor:!0}),!0},i._analyzePictureMarker=function(e,t,i,r,o,n,a,s,c,u,f){let m=p.getValue(e.scaleX,1);const h=p.getTintColor(e),y=l.numericHash(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString();i||(i=this._createMarkerPlacementOverrideFunction(e.markerPlacement));const d=this._createAnimatedSymbolPropertiesOverrideFunction(e.animatedSymbolProperties),[v,_]=this._analyzePrimitiveOverrides(r,t,i,d),S=l.numericHash(JSON.stringify(e)+_).toString(),O=e.anchorPoint??{x:0,y:0};if("width"in e&&"number"==typeof e.width){const t=e.width;let i=1;const r=this._resourceManager.getResource(e.url);null!=r&&(i=r.width/r.height);m/=i*(p.getValue(e.size)/t)}function F(e,t){return null!=d?p.evaluateValueOrFunction(d,e,t):null}const M=e.animatedSymbolProperties&&!0===e.animatedSymbolProperties.randomizeStartTime?(e,t,i,r)=>{const o=g.getMaterialGroup(r??0),n=F(e,t);return y+`-MATERIALGROUP(${o})`+`-ASP(${JSON.stringify(n)})`}:v?(e,t)=>{const i=F(e,t);return y+`-ASP(${JSON.stringify(i)})`}:y;this._cimLayers.push({type:"marker",templateHash:S,materialHash:M,cim:e,materialOverrides:null,colorLocked:!!e.colorLocked||!!f,effects:t,scaleSymbolsProportionally:!1,alignment:o,size:a,scaleX:this._createOverrideFunction(e.primitiveName,"ScaleX",m),rotation:s,offsetX:c,offsetY:u,color:this._createOverrideFunction(e.primitiveName,"TintColor",h,k),anchorPoint:{x:O.x,y:O.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:!1,referenceSize:n,sizeRatio:1,markerPlacement:i,url:e.url,animatedSymbolProperties:d})},i._analyzeVectorMarker=function(e,t,i,r,o,n,a,l,s,c,u,f,m){const h=e.markerGraphics;if(!h)return;const p=e.frame;let y=0,d=1;e.scaleSymbolsProportionally&&p&&(y=p.ymax-p.ymin,d=this._transformSize(s,1/y)),d=this._transformSize(d,a),i||(i=this._createMarkerPlacementOverrideFunction(e.markerPlacement));for(const v of h)if(v){const a=v.symbol;if(!a)continue;const h=v.primitiveName;h&&r.push(h);let g=u,_=f;if(("CIMPointSymbol"===a.type||"CIMTextSymbol"===a.type)&&p){let t=0,i=0;const r=v.geometry;"x"in r&&"y"in r&&(t+=r.x-.5*(p.xmin+p.xmax),i+=r.y-.5*(p.ymin+p.ymax));const o=e.anchorPoint;o&&("Absolute"===e.anchorPointUnits?(t-=o.x,i-=o.y):p&&(t-=(p.xmax-p.xmin)*o.x,i-=(p.ymax-p.ymin)*o.y)),g=this._transformOffsetX(t,i,c,d,u),_=this._transformOffsetY(t,i,c,d,f)}switch(a.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":l?this._analyzeMultiLayerGraphicNonSDF(e,t,i,null,v,r,o,n,y,!!m||!!e.colorLocked):this._analyzeMultiLayerGraphic(e,t,i,null,v,r,o,n,y,d,s,c,g,_,!!m||!!e.colorLocked);break;case"CIMTextSymbol":this._analyzeTextGraphic(e,t,i,v,r,o,n,y,d,s,c,g,_,m)}h&&r.pop()}},i._analyzeMultiLayerGraphic=function(e,t,i,r,o,n,a,s,c,u,f,m,d,v,g){const _=o.symbol,S=_.symbolLayers;if(!S)return;let O=S.length;if(P(S))return void this._analyzeCompositeMarkerGraphic(e,t,i,r,o,S,n,a,s,c,f,m,d,v,!!g||!!e.colorLocked);const F=this._resourceManager.geometryEngine,M=y.CIMEffectHelper.applyEffects(_.effects,o.geometry,F);if(M)for(;O--;){const _=S[O];if(!_||!1===_.enable)continue;const C=_.primitiveName;switch(C&&n.push(C),_.type){case"CIMSolidFill":case"CIMSolidStroke":{const u=y.CIMEffectHelper.applyEffects(_.effects,M,F),S=h.getExtent(u);if(!S)continue;const O="Relative"!==e.anchorPointUnits,[b,N,P]=h.getSDFMetrics(S,e.frame,e.size,e.anchorPoint,O),L="CIMSolidFill"===_.type,I={type:"sdf",geom:u,asFill:L},z=_.path,H=L?p.fromCIMColor(p.getFillColor(_)):p.fromCIMColor(p.getStrokeColor(_)),V=L?{r:0,g:0,b:0,a:0}:p.fromCIMColor(p.getStrokeColor(_)),A=p.getStrokeWidth(_)??0;if(!L&&!A)break;const T=o.primitiveName;let E=null;!L||_.colorLocked||g||(E=this._createOverrideFunction(T,"FillColor",H,k));let R=null;_.colorLocked||g||(R=this._createOverrideFunction(T,"StrokeColor",V,k));const x=this._createOverrideFunction(T,"StrokeWidth",A);let w=!1,X="";for(const e of this._primitiveOverrides)n.includes(e.primitiveName)&&(null!=e.value?X+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(w=!0));(null!=t&&"function"==typeof t||null!=i&&"function"==typeof i)&&(w=!0),(p.isFeatureValueFn(f)||p.isFeatureValueFn(m)||p.isFeatureValueFn(d)||p.isFeatureValueFn(v))&&(w=!0);const D=JSON.stringify({...e,markerGraphics:null}),J=l.numericHash(JSON.stringify(I)+z).toString(),Y=l.numericHash(JSON.stringify(o)+JSON.stringify(_)+D+X).toString();this._cimLayers.push({type:"marker",templateHash:Y,materialHash:w?()=>J:J,cim:I,materialOverrides:null,colorLocked:!!_.colorLocked||!!g,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:a,anchorPoint:{x:N,y:P},isAbsoluteAnchorPoint:O,size:f,rotation:m,offsetX:d,offsetY:v,scaleX:1,frameHeight:c,rotateClockwise:!1,referenceSize:s,sizeRatio:b,color:p.isFeatureValueFn(E)?E:this._createOverrideFunction(C,"Color",H,k),outlineColor:p.isFeatureValueFn(R)?R:this._createOverrideFunction(C,"Color",V,k),outlineWidth:p.isFeatureValueFn(x)?x:this._createOverrideFunction(C,"Width",A),markerPlacement:i,animatedSymbolProperties:r,path:z});break}case"CIMVectorMarker":_.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(e,t,i,r,o,n,a,s,c,!!g||!!_.colorLocked):this._analyzeMarker(_,t,i,n,a,s,u,!1,f,m,d,v,!!g||!!e.colorLocked);break;default:this._analyzeMultiLayerGraphicNonSDF(e,t,i,r,o,n,a,s,c,!!g||!!e.colorLocked)}C&&n.pop()}},i._analyzeTextGraphic=function(e,t,i,o,n,a,s,f,m,h,y,d,v,g){const _=[];u.OverrideHelper.findApplicableOverrides(o,this._primitiveOverrides,_);const S=o.geometry;if(!("x"in S)||!("y"in S))return;const O=o.symbol,F=p.fromCIMFontDecoration(O),M=p.fromCIMFontStyle(O.fontStyleName),C=r.getFontFamily(O.fontFamilyName);O.font={family:C,decoration:F,...M};let k=p.getValue(O.height,c.DEFAULT_TEXT_HEIGHT),b=p.getValue(O.angle),N=p.getValue(O.offsetX),P=p.getValue(O.offsetY);k=this._transformSize(k,m),b=this._transformRotation(b,!1,y);const L=this._transformOffsetX(N,P,y,m,d),I=this._transformOffsetY(N,P,y,m,v);N=L,P=I;const z=p.fromCIMColor(p.getFillColor(O));let H=p.fromCIMColor(p.getStrokeColor(O)),V=p.getStrokeWidth(O)??0;V||(H=p.fromCIMColor(p.getFillColor(O.haloSymbol)),V=p.getValue(O.haloSize)),V=this._transformSize(V,m);let A=null,T=null,E=0;if(O.callout&&"CIMBackgroundCallout"===O.callout.type){const e=O.callout;if(e.backgroundSymbol){const t=e.backgroundSymbol.symbolLayers;if(t)for(const e of t)"CIMSolidFill"===e.type?A=p.fromCIMColor(e.color):"CIMSolidStroke"===e.type&&(T=p.fromCIMColor(e.color),E=p.getValue(e.width,c.DEFAULT_STROKE_WIDTH))}}const[R,x]=this._analyzePrimitiveOverrides(n,t,i,null),w=JSON.stringify(e.effects)+Number(e.colorLocked||g).toString()+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement)+e.size.toString(),X=l.numericHash(JSON.stringify(o)+w+x).toString();let D=this._createOverrideFunction(o.primitiveName,"TextString",o.textString??"",p.adjustTextCase,O.textCase);if(null==D)return;const{fontStyleName:J}=O,Y=C+(J?"-"+J.toLowerCase():"-regular"),U=Y;"string"==typeof D&&D.includes("[")&&O.fieldMap&&(D=p.createLabelOverrideFunction(O.fieldMap,D,O.textCase)),this._cimLayers.push({type:"text",templateHash:X,materialHash:R||"function"==typeof D||/\[(.*?)\]/.test(D)?(e,t,i)=>U+"-"+p.evaluateValueOrFunction(D,e,t,i):U+"-"+l.numericHash(D),cim:O,materialOverrides:null,colorLocked:!!e.colorLocked||!!g,effects:t,alignment:a,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:Y,decoration:F,weight:M.weight,style:M.style,size:k,angle:b,offsetX:N,offsetY:P,horizontalAlignment:p.fromCIMHorizontalAlignment(O.horizontalAlignment),verticalAlignment:p.fromCIMVerticalAlignment(O.verticalAlignment),text:D,color:z,outlineColor:H,outlineSize:V,backgroundColor:A,borderLineColor:T,borderLineWidth:E,referenceSize:s,sizeRatio:1,markerPlacement:i})},i._analyzeMultiLayerGraphicNonSDF=function(e,t,i,r,o,n,s,f,m,h){const y=this._buildSimpleMarker(e,o),d=e.primitiveName,v=this._analyzeMaterialOverrides(d,["Rotation","OffsetX","OffsetY"]),[g,_]=this._analyzePrimitiveOverrides(n,null,null,null),[S,O,F]=u.CIMSymbolHelper.getTextureAnchor(y,this._resourceManager),M=p.getValue(e.rotation),C=p.getValue(e.offsetX),k=p.getValue(e.offsetY),b=l.numericHash(JSON.stringify(y)+_).toString(),N=v&&v.length>0||null!=t&&"function"==typeof t;this._cimLayers.push({type:"marker",templateHash:b,materialHash:N&&v?this._createMaterialHashFunction(b,v):b,cim:y,materialOverrides:v,colorLocked:!!e.colorLocked||!!h,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:S,y:O},isAbsoluteAnchorPoint:!1,size:p.getValue(e.size,c.DEFAULT_MARKER_SIZE),rotation:this._createOverrideFunction(d,"Rotation",M),offsetX:this._createOverrideFunction(d,"OffsetX",C),offsetY:this._createOverrideFunction(d,"OffsetY",k),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:!!e.rotateClockwise,referenceSize:f,sizeRatio:F/a.pt2px(e.size),markerPlacement:i,animatedSymbolProperties:r,avoidSDFRasterization:!0})},i._buildSimpleMarker=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}},i._analyzeCompositeMarkerGraphic=function(e,t,i,r,o,n,a,s,u,f,m,y,d,v,g){const _=o.geometry,S=n[0],O=n[1],F=h.getExtent(_);if(!F)return;const M="Relative"!==e.anchorPointUnits,[C,b,N]=h.getSDFMetrics(F,e.frame,e.size,e.anchorPoint,M),P={type:"sdf",geom:_,asFill:!0},L=O.path,I=O.primitiveName,z=S.primitiveName,H=p.fromCIMColor(O.color),V=p.fromCIMColor(S.color),A=p.getValue(S.width,c.DEFAULT_STROKE_WIDTH),T=o.primitiveName;let E=null;O.colorLocked||g||(E=this._createOverrideFunction(T,"FillColor",H,k));let R=null;S.colorLocked||g||(R=this._createOverrideFunction(T,"StrokeColor",V,k));const x=this._createOverrideFunction(T,"StrokeWidth",A);let w=!1,X="";for(const l of this._primitiveOverrides)(l.primitiveName===I||l.primitiveName===z||a.includes(l.primitiveName))&&(null!=l.value?X+=`-${l.primitiveName}-${l.propertyName}-${JSON.stringify(l.value)}`:l.valueExpressionInfo&&(w=!0));null!=i&&"function"==typeof i&&(w=!0),(p.isFeatureValueFn(m)||p.isFeatureValueFn(y)||p.isFeatureValueFn(d)||p.isFeatureValueFn(v))&&(w=!0);const D=JSON.stringify({...e,markerGraphics:null}),J=l.numericHash(JSON.stringify(P)+L).toString(),Y=l.numericHash(JSON.stringify(o)+JSON.stringify(O)+JSON.stringify(S)+D+X).toString();this._cimLayers.push({type:"marker",templateHash:Y,materialHash:w?()=>J:J,cim:P,materialOverrides:null,colorLocked:!!g,effects:t,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:b,y:N},isAbsoluteAnchorPoint:M,size:m,rotation:y,offsetX:d,offsetY:v,scaleX:1,frameHeight:f,rotateClockwise:!1,referenceSize:u,sizeRatio:C,color:p.isFeatureValueFn(E)?E:this._createOverrideFunction(I,"Color",H,k),outlineColor:p.isFeatureValueFn(R)?R:this._createOverrideFunction(z,"Color",V,k),outlineWidth:p.isFeatureValueFn(x)?x:this._createOverrideFunction(z,"Width",A),markerPlacement:i,path:L,animatedSymbolProperties:r})},i._createMaterialHashFunction=function(e,t){const i=this._info?.geometryType;if(i){const e=this._poMap;for(const r of t){if(r.valueExpressionInfo){const t=e[r.primitiveName]&&e[r.primitiveName][r.propertyName];t instanceof s.ArcadeExpression&&(r.fn=(e,r,o)=>d(t,e,{$view:o},i,r))}}}return(i,r,o)=>{for(const e of t)e.fn&&(e.value=e.fn(i,r,o));return l.numericHash(e+u.OverrideHelper.buildOverrideKey(t)).toString()}},i._setPoMap=function(e,t,i){let r;this._poMap[e]?r=this._poMap[e]:(r={},this._poMap[e]=r),r[t]=i},i._createOverrideFunction=function(e,t,i,r,o){if(null==e)return i;const n=this._poMap[e];if(null==n)return i;const a=n[t];if("string"==typeof a||"number"==typeof a||a instanceof Array)return r?r.call(null,a,o):a;const l=this._info?.geometryType;return null!=a&&a instanceof s.ArcadeExpression&&null!=l?(e,t,n)=>{let s=d(a,e,{$view:n},l,t);return null!==s&&r&&(s=r.call(null,s,o)),null!==s?s:i}:i},i._createEffectsOverrideFunction=function(e,t){const i=this._poMap,r=this._info?.geometryType;for(const o of t){if(o.valueExpressionInfo&&r){const e=i[o.primitiveName]&&i[o.primitiveName][o.propertyName];e instanceof s.ArcadeExpression&&(o.fn=(t,i,o)=>d(e,t,{$view:o},r,i))}}return(i,r,n)=>{for(const e of t)e.fn&&(e.value=e.fn(i,r,n));const a=[];for(let l of e){const e=l?.primitiveName;if(e){let i=!1;for(const r of t)if(r.primitiveName===e){const e=b(r.propertyName);null!=r.value&&r.value!==l[e]&&(i||(l=o.clone(l),i=!0),l[e]=r.value)}}a.push(l)}return a}},i._createMarkerPlacementOverrideFunction=function(e){const t=[];if(u.OverrideHelper.findApplicableOverrides(e,this._primitiveOverrides,t),null==e||0===t.length)return e;const i=this._poMap,r=this._info?.geometryType;for(const o of t){if(o.valueExpressionInfo&&r){const e=i[o.primitiveName]&&i[o.primitiveName][o.propertyName];e instanceof s.ArcadeExpression&&(o.fn=(t,i,o)=>d(e,t,{$view:o},r,i))}}return(i,r,n)=>{for(const e of t)e.fn&&(e.value=e.fn(i,r,n));const a=o.clone(e),l=e.primitiveName;for(const e of t)if(e.primitiveName===l){const t=b(e.propertyName);null!=e.value&&e.value!==a[t]&&(a[t]=e.value)}return a}},i._createAnimatedSymbolPropertiesOverrideFunction=function(e){const t=[];if(u.OverrideHelper.findApplicableOverrides(e,this._primitiveOverrides,t),null==e||0===t.length)return e;const i=this._info?.geometryType;if(i){const e=this._poMap;for(const r of t){if(r.valueExpressionInfo){const t=e[r.primitiveName]&&e[r.primitiveName][r.propertyName];t instanceof s.ArcadeExpression&&(r.fn=(e,r,o)=>d(t,e,{$view:o},i,r))}}}return(i,r,n)=>{for(const e of t)e.fn&&(e.value=e.fn(i,r,n));const a=o.clone(e),l=e.primitiveName;for(const e of t)if(e.primitiveName===l){const t=b(e.propertyName);if(null!=e.value){const i=m.quantizeIfNeeded(e.value,e.propertyName);i!==a[t]&&(a[t]=i)}}return a}},i._analyzePrimitiveOverrides=function(e,t,i,r){let o=!1,n="";"string"==typeof e&&(e=[e]);for(const a of this._primitiveOverrides)e?.includes(a.primitiveName)&&(null!=a.value?n+=`-${a.primitiveName}-${a.propertyName}-${JSON.stringify(a.value)}`:a.valueExpressionInfo&&(o=!0));return null!=t&&"function"==typeof t&&(o=!0),null!=i&&"function"==typeof i&&(o=!0),null!=r&&"function"==typeof r&&(o=!0),[o,n]},i._analyzeMaterialOverrides=function(e,t){return this._primitiveOverrides.filter((i=>i.primitiveName!==e||!t.includes(i.propertyName)))},i._transformSize=function(e,t){return p.isFeatureValueFn(e)||p.isFeatureValueFn(t)?(i,r,o)=>(p.isFeatureValueFn(e)?e(i,r,o):e)*(p.isFeatureValueFn(t)?t(i,r,o):t):e*t},i._transformRotation=function(e,t,i){return p.isFeatureValueFn(e)||p.isFeatureValueFn(i)?(r,o,n)=>{const a=p.isFeatureValueFn(e)?e(r,o,n):e,l=p.isFeatureValueFn(i)?i(r,o,n):i;return t?l-a:l+a}:t?i-e:i+e},i._transformOffsetX=function(e,t,i,r,o){if(!(p.isFeatureValueFn(e)||p.isFeatureValueFn(t)||p.isFeatureValueFn(i)||p.isFeatureValueFn(r)||p.isFeatureValueFn(o))){const n=i*Math.PI/180;if(n){const i=Math.cos(n),a=Math.sin(n);return(i*e-a*t)*r+o}return e*r+o}return(n,a,l)=>{let s=p.isFeatureValueFn(i)?i(n,a,l):i;const c=p.isFeatureValueFn(r)?r(n,a,l):r,u=p.isFeatureValueFn(e)?e(n,a,l):e,f=p.isFeatureValueFn(o)?o(n,a,l):o;if(s){s*=Math.PI/180;return(Math.cos(s)*u-Math.sin(s)*(p.isFeatureValueFn(t)?t(n,a,l):t))*c+f}return u*c+f}},i._transformOffsetY=function(e,t,i,r,o){if(!(p.isFeatureValueFn(e)||p.isFeatureValueFn(t)||p.isFeatureValueFn(i)||p.isFeatureValueFn(r)||p.isFeatureValueFn(o))){const n=i*Math.PI/180;if(n){const i=Math.cos(n);return(Math.sin(n)*e+i*t)*r+o}return t*r+o}return(n,a,l)=>{let s=p.isFeatureValueFn(i)?i(n,a,l):i;const c=p.isFeatureValueFn(r)?r(n,a,l):r,u=p.isFeatureValueFn(t)?t(n,a,l):t,f=p.isFeatureValueFn(o)?o(n,a,l):o;if(s){s*=Math.PI/180;const t=Math.cos(s);return(Math.sin(s)*(p.isFeatureValueFn(e)?e(n,a,l):e)+t*u)*c+f}return u*c+f}},t._createClass(e)}();function C(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function k(e){if(!e||0===e.length)return null;const t=new i(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function b(e){return e?e.charAt(0).toLowerCase()+e.substr(1):e}function N(e,t){if(!t||0===t.length)return e;const i=o.clone(e);return u.OverrideHelper.applyOverrides(i,t),i}const P=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&!e[0].effects&&!e[1].effects;e.CIMAnalyzer=M,e.analyzeCIMResource=N,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
