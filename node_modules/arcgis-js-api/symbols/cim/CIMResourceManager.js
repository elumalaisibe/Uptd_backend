/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../request","../../core/Error","../../core/fontUtils","../../core/promiseUtils","../../support/base64Utils","../../views/2d/engine/webgl/animatedFormats/apng","../../views/2d/engine/webgl/animatedFormats/gif"],(function(e,t,r,i,n,s,a,o){"use strict";async function u(e,i){const s=window.URL.createObjectURL(e);try{const{data:e}=await t(s,{...i,responseType:"image"});return e}catch(a){if(!n.isAbortError(a))throw new r("mapview-invalid-resource",`Could not fetch requested resource at ${s}`);throw a}finally{window.URL.revokeObjectURL(s)}}async function c(e,t){const{arrayBuffer:r,mediaType:i}=await h(e,t),n="image/png"===i;if("image/gif"===i&&o.isAnimatedGIF(r))return o.parseGif(r);if(n&&a.isAnimatedPNG(r))return a.parseApng(r,t);return u(new Blob([r],{type:i}),t)}async function h(e,i){let a;const o=";base64,";if(e.includes(o)){const t=e.indexOf(o),r=e.indexOf(o)+o.length,i=e.substring(r);a={arrayBuffer:s.base64ToArrayBuffer(i),mediaType:e.substring(0,t).replace("data:","")}}else try{const r=await t(e,{responseType:"array-buffer",...i}),n=r.data;a={arrayBuffer:n,mediaType:r.getHeader("Content-Type")}}catch(u){if(!n.isAbortError(u))throw new r("mapview-invalid-resource",`Could not fetch requested resource at ${e}`)}return a}return function(){function t(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}var r=t.prototype;return r.destroy=function(){this._inFlightResourceMap.clear(),this._resourceMap.clear()},r.getResource=function(e){return this._resourceMap.get(e)??null},r.fetchResource=async function(e,t){const r=this._resourceMap.get(e);if(r)return{width:r.width,height:r.height};let i=this._inFlightResourceMap.get(e);return i?i.then((e=>({width:e.width,height:e.height}))):(i=c(e,t),this._inFlightResourceMap.set(e,i),i.then((t=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,t),{width:t.width,height:t.height})),(()=>({width:0,height:0}))))},r.deleteResource=function(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)},r.loadFont=function(e){return i.loadFont(e)},e._createClass(t)}()}));
