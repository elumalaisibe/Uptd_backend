/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../Color","../../request","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","./cimAnalyzer","./CIMResourceManager","./CIMSymbolDrawHelper","./CIMSymbolHelper","./Rasterizer","./TextRasterizer","./utils","../support/cimSymbolUtils","../support/Symbol3DAnchorPosition2D"],(function(e,t,a,r,i,n,o,s,l,c,h,u,m,g,f,y){"use strict";var d;e.GeometryStyle=void 0,(d=e.GeometryStyle||(e.GeometryStyle={})).Legend="legend",d.Preview="preview";const p=e=>e&&e.scaleFactor?e.scaleFactor:1,w=96/72;let C=function(){function e(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new m,this._cimResourceManager=new l,this._rasterizer=new u(this._cimResourceManager)}var d=e.prototype;return d.rasterizeCIMSymbolAsync=async function(e,t,a,r,i,n,o,s){if(!e)return null;const{data:l}=e;if(!l||"CIMSymbolReference"!==l.type||!l.symbol)return null;const{symbol:u}=l;n||(n=g.mapCIMSymbolToGeometryType(u));const m=await h.OverrideHelper.resolveSymbolOverrides(l,t,this._spatialReference,i,n,o,s);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const f=this._imageDataCanvas,y=this._cimResourceManager,d=[];h.CIMSymbolHelper.fetchResources(m,y,d),h.CIMSymbolHelper.fetchFonts(m,y,d),d.length>0&&await Promise.all(d);const{width:p,height:C}=a,M=v(n,p,C,r),b=h.CIMSymbolHelper.getEnvelope(m,M,y);if(!b)return null;const I=(window.devicePixelRatio||1)*w;let _=1,x=0,z=0;switch(u.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;b.width>p&&(e=p/b.width);let t=1;b.height>C&&(t=C/b.height),"preview"===r&&(b.width<p&&(e=p/b.width),b.height<C&&(t=C/b.height)),_=Math.min(e,t),x=b.x+b.width/2,z=b.y+b.height/2}break;case"CIMLineSymbol":{let e=1;b.height>C&&(e=C/b.height),_=e,z=b.y+b.height/2;const t=b.x*_+p/2,a=(b.x+b.width)*_+p/2;if(t<0){const{paths:e}=M;e[0][0][0]-=t}if(a>p){const{paths:e}=M;e[0][2][0]-=a-p}}break;case"CIMPolygonSymbol":{x=b.x+b.width/2,z=b.y+b.height/2;const e=b.x*_+p/2,t=(b.x+b.width)*_+p/2,a=b.y*_+C/2,r=(b.y+b.height)*_+C/2,{rings:i}=M;e<0&&(i[0][0][0]-=e,i[0][3][0]-=e,i[0][4][0]-=e),a<0&&(i[0][0][1]+=a,i[0][1][1]+=a,i[0][4][1]+=a),t>p&&(i[0][1][0]-=t-p,i[0][2][0]-=t-p),r>C&&(i[0][2][1]+=r-C,i[0][3][1]+=r-C)}}f.width=p*I,f.height=C*I;const R=1;f.width+=2*R,f.height+=2*R;const S=f.getContext("2d"),P=c.Transformation.createIdentity();P.translate(-x,-z),P.scale(_*I,-_*I),P.translate(p*I/2+R,C*I/2+R),S.clearRect(0,0,f.width,f.height);return new c.CanvasDrawHelper(S,y,P,!0).drawSymbol(m,M),S.getImageData(0,0,f.width,f.height)},d.analyzeCIMSymbol3D=async function(e,t,a,r,i){const o=[],l=t?{geometryType:r,spatialReference:this._spatialReference,fields:t}:null,c=[];h.CIMSymbolHelper.fetchFonts(e.data.symbol,this._cimResourceManager,c),await Promise.all(c);const u=new s.CIMAnalyzer(this._cimResourceManager,l);let m;await u.analyzeSymbolReference(e.data,this._avoidSDF,o),n.throwIfAborted(i);for(const n of o)"CIMPictureMarker"!==n.cim.type&&"CIMPictureFill"!==n.cim.type&&"CIMPictureStroke"!==n.cim.type||(m||(m=[]),m.push(this._fetchPictureMarkerResource(n,i))),a&&"text"===n.type&&"string"==typeof n.text&&n.text.includes("[")&&(n.text=g.createLabelOverrideFunction(a,n.text,n.cim.textCase));return m&&await Promise.all(m),o},d.rasterizeCIMSymbol3D=function(e,t,a,r,i,n){const o=[];for(const s of e){r&&"function"==typeof r.scaleFactor&&(r.scaleFactor=r.scaleFactor(t,i,n));const e=this._getRasterizedResource(s,t,a,r,i,n);if(!e)continue;let l=0,c=e.anchorX||0,h=e.anchorY||0,u=!1,m=0,f=0;if("esriGeometryPoint"===a){const e=p(r);if(m=g.evaluateValueOrFunction(s.offsetX,t,i,n)*e||0,f=g.evaluateValueOrFunction(s.offsetY,t,i,n)*e||0,"marker"===s.type)l=g.evaluateValueOrFunction(s.rotation,t,i,n)||0,u=s.rotateClockwise??!1;else if("text"===s.type){if(l=g.evaluateValueOrFunction(s.angle,t,i,n)||0,void 0!==s.horizontalAlignment)switch(s.horizontalAlignment){case"left":c=-.5;break;case"right":c=.5;break;default:c=0}if(void 0!==s.verticalAlignment)switch(s.verticalAlignment){case"top":h=.5;break;case"bottom":h=-.5;break;case"baseline":h=-.25;break;default:h=0}}}null!=e&&o.push({angle:l,rotateClockWise:u,anchorX:c,anchorY:h,offsetX:m,offsetY:f,rasterizedResource:e})}return this.getSymbolImage(o)},d.getSymbolImage=function(e){const t=document.createElement("canvas"),a=i.unwrapOrThrow(t.getContext("2d"));let r=0,n=0,s=0,l=0;const c=[];for(let i=0;i<e.length;i++){const t=e[i],h=t.rasterizedResource;if(!h)continue;const u=h.size,m=t.offsetX,g=t.offsetY,f=t.anchorX,y=t.anchorY,d=t.rotateClockWise||!1;let p=t.angle,w=o.pt2px(m)-u[0]*(.5+f),C=o.pt2px(g)-u[1]*(.5+y),v=w+u[0],M=C+u[1];if(p){d&&(p=-p);const e=Math.sin(p*Math.PI/180),t=Math.cos(p*Math.PI/180),a=w*t-C*e,r=w*e+C*t,i=w*t-M*e,n=w*e+M*t,o=v*t-M*e,s=v*e+M*t,l=v*t-C*e,c=v*e+C*t;w=Math.min(a,i,o,l),C=Math.min(r,n,s,c),v=Math.max(a,i,o,l),M=Math.max(r,n,s,c)}r=w<r?w:r,n=C<n?C:n,s=v>s?v:s,l=M>l?M:l;const b=a.createImageData(h.size[0],h.size[1]);b.data.set(new Uint8ClampedArray(h.image.buffer));const I={offsetX:m,offsetY:g,rotateClockwise:d,angle:p,rasterizedImage:b,anchorX:f,anchorY:y};c.push(I)}t.width=s-r,t.height=l-n;const h=-r,u=l;for(let i=0;i<c.length;i++){const e=c[i],t=this._imageDataToCanvas(e.rasterizedImage),r=e.rasterizedImage.width,n=e.rasterizedImage.height,s=h-r*(.5+e.anchorX),l=u-n*(.5-e.anchorY);if(e.angle){const r=(360-e.angle)*Math.PI/180;a.save(),a.translate(o.pt2px(e.offsetX),-o.pt2px(e.offsetY)),a.translate(h,u),a.rotate(r),a.translate(-h,-u),a.drawImage(t,s,l),a.restore()}else a.drawImage(t,s+o.pt2px(e.offsetX),l-o.pt2px(e.offsetY))}const m=new y.Symbol3DAnchorPosition2D({x:h/t.width-.5,y:u/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:m}},d._fetchPictureMarkerResource=async function(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(await r(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(a,i)}},d._imageDataToCanvas=function(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,a=i.unwrapOrThrow(t.getContext("2d"));return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t},d._imageTo32Array=function(e,t,r,n){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const o=this._imageDataCanvas,s=i.unwrapOrThrow(o.getContext("2d"));if(o.width=t,o.height=r,s.drawImage(e,0,0,t,r),n){s.save();const i=new a(n);s.fillStyle=i.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,t,r),s.globalCompositeOperation="destination-atop",s.drawImage(e,0,0,t,r),s.restore()}return new Uint32Array(s.getImageData(0,0,t,r).data.buffer)},d._getRasterizedResource=function(e,t,a,r,n,o){let s,l,c;const h=null,u=null;if("text"===e.type)return this._rasterizeTextResource(e,t,r,n,o);({analyzedCIM:s,hash:l}=M(e,t,n,o));const m=p(r);if("CIMPictureMarker"===e.cim.type){const a=g.evaluateValueOrFunction(e.size,t,n,o)*m,{image:r,width:s,height:l}=i.unwrapOrThrow(this._getPictureResource(e,a,g.evaluateValueOrFunction(e.color,t,n,o)));return c={image:r,size:[s,l],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},c}f.scaleCIMMarker(s,m,{preserveOutlineWidth:!1});const y=s;l+=a,r&&(l+=JSON.stringify(r));const d=this._resourceCache;return d.has(l)?d.get(l):(c=this._rasterizer.rasterizeJSONResource({cim:y,type:e.type,url:e.url,mosaicHash:l,size:h,path:u},window.devicePixelRatio||1,this._avoidSDF),d.set(l,c),c)},d._rasterizeTextResource=function(e,t,a,r,i){const n=p(a),o=g.evaluateValueOrFunction(e.text,t,r,i);if(!o||0===o.length)return null;const s=e.cim,l=g.evaluateValueOrFunction(s?.fontFamilyName||e.fontName,t,r,i),c=g.evaluateValueOrFunction(s?.font?.style||e.style,t,r,i),h=g.evaluateValueOrFunction(s?.font?.weight||e.weight,t,r,i),u=g.evaluateValueOrFunction(s?.font?.decoration||e.decoration,t,r,i),m=g.evaluateValueOrFunction(e.size,t,r,i)*n,f=g.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),y=g.evaluateValueOrFunction(e.verticalAlignment,t,r,i),d=g.colorToArray(g.evaluateValueOrFunction(e.color,t,r,i)),w=g.colorToArray(g.evaluateValueOrFunction(e.outlineColor,t,r,i)),C=g.evaluateValueOrFunction(e.outlineSize,t,r,i),v=null!=e.backgroundColor?g.colorToArray(e.backgroundColor):null,M=null!=e.borderLineColor?g.colorToArray(e.borderLineColor):null,b=null!=e.borderLineWidth?e.borderLineWidth:null,I={color:d,size:m,horizontalAlignment:f,verticalAlignment:y,font:{family:l,style:c,weight:h,decoration:u},halo:{size:C||0,color:w,style:c},backgroundColor:v,borderLine:null!=M&&null!=b?{color:M,size:b}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,I)},d._getPictureResource=function(e,t,a){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const i=r.height/r.width,n=t?i>1?o.pt2px(t):o.pt2px(t)/i:r.width,s=t?i>1?o.pt2px(t)*i:o.pt2px(t):r.height;return{image:this._imageTo32Array(r,n,s,a),width:n,height:s}},t._createClass(e,[{key:"resourceManager",get:function(){return this._cimResourceManager}}]),e}();function v(e,t,a,r){const i=1,n=-t/2+i,o=t/2-i,s=a/2-i,l=-a/2+i;switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[n,0],[0,0],[o,0]]]};default:return"legend"===r?{rings:[[[n,s],[o,0],[o,l],[n,l],[n,s]]]}:{rings:[[[n,s],[o,s],[o,l],[n,l],[n,s]]]}}}function M(e,t,a,r){let i,n;if("function"==typeof e.materialHash){i=(0,e.materialHash)(t,a,r),n=s.analyzeCIMResource(e.cim,e.materialOverrides)}else i=e.materialHash,n=e.cim;return{analyzedCIM:n,hash:i}}e.CIMSymbolRasterizer=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
