/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../Color","../../symbols","../../core/asyncUtils","../../core/has","../../core/maybe","../../core/screenUtils","../../chunks/vec3f64","../../layers/effects/jsonUtils","./cimSymbolUtils","./gfxUtils","./Symbol3DMaterial"],(function(e,t,o,l,n,r,i,c,s,u,a,y,f){"use strict";const m=new o("white");function b(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}function p(e){if(!e)return 0;if(l.isSymbol3D(e)){const t=b(e);return null!=t?t:0}return c.px2pt(y.getStroke(e)?.width)}function h(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function S(e){return i.unwrapOrThrow(e.resource).href}function w(e,t){if(!e)return null;let n=null;return l.isSymbol3D(e)?n=d(e):l.isSymbol2D(e)&&(n="cim"===e.type?a.getCIMSymbolColor(e):e.color?new o(e.color):null),n?g(n,t):null}function d(e){const t=e.symbolLayers;if(!t)return null;let l=null;return t.forEach((e=>{"object"===e.type&&e.resource?.href||(l="water"===e.type?e.color:e.material?e.material.color:null)})),l?new o(l):null}function g(e,t){if(null==t||null==e)return e;const l=e.toRgba();return l[3]=l[3]*t,new o(l)}function k(e,t,o){const l=e.symbolLayers;if(!l)return;const n=e=>g(t=t??e??(null!=o?m:null),o);l.forEach((e=>{if("object"!==e.type||!e.resource?.href||t)if("water"===e.type)e.color=n(e.color);else{const t=null!=e.material?e.material.color:null,l=n(t);null==e.material?e.material=new f.Symbol3DMaterial({color:l}):e.material.color=l,null!=o&&"outline"in e&&null!=e.outline&&null!=e.outline.color&&(e.outline.color=g(e.outline.color,o))}}))}function L(e,t,o){(t=t??e.color)&&(e.color=g(t,o)),null!=o&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=g(e.outline.color,o))}function z(e,t,n){e&&(t||null!=n)&&(t&&(t=new o(t)),l.isSymbol3D(e)?k(e,t,n):l.isSymbol2D(e)&&L(e,t,n))}async function D(e,t){const o=e.symbolLayers;o&&await n.forEach(o,(async e=>x(e,t)))}async function x(e,t){switch(e.type){case"extrude":O(e,t);break;case"icon":case"line":case"text":j(e,t);break;case"path":v(e,t);break;case"object":await E(e,t)}}function j(e,t){const o=C(t);null!=o&&(e.size=o)}function C(e){for(const t of e)if("number"==typeof t)return t;return null}function O(e,t){e.size="number"==typeof t[2]?t[2]:0}async function E(e,t){const{resourceSize:o,symbolSize:l}=await U(e),n=T(t,o,l);e.width=F(t[0],l[0],o[0],n),e.depth=F(t[1],l[1],o[1],n),e.height=F(t[2],l[2],o[2],n)}function v(e,t){const o=T(t,s.ONES,[e.width,void 0,e.height]);e.width=F(t[0],e.width,1,o),e.height=F(t[2],e.height,1,o)}function T(e,t,o){for(let l=0;l<3;l++){const n=e[l];switch(n){case"symbol-value":{const e=o[l];return null!=e?e/t[l]:1}case"proportional":break;default:if(n&&t[l])return n/t[l]}}return 1}async function U(t){const{computeObjectLayerResourceSize:o}=await new Promise(((t,o)=>e(["./symbolLayerUtils"],t,o))),l=await o(t,10),{width:n,height:r,depth:i}=t,c=[n,i,r];let s=1;for(let e=0;e<3;e++){const t=c[e];if(null!=t){s=t/l[e];break}}for(let e=0;e<3;e++)null==c[e]&&(c[e]=l[e]*s);return{resourceSize:l,symbolSize:c}}function F(e,t,o,l){switch(e){case"proportional":return o*l;case"symbol-value":return null!=t?t:o;default:return e}}function M(e,t){const o=C(t);if(null!=o)switch(e.type){case"simple-marker":e.size=o;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=o,e.height=o*t):(e.width=o*t,e.height=o);break}case"simple-line":e.width=o;break;case"text":e.font.size=o}}async function I(e,t){if(e&&t)return l.isSymbol3D(e)?D(e,t):void(l.isSymbol2D(e)&&M(e,t))}function N(e,t,o){if(e&&null!=t)if(l.isSymbol3D(e)){const l=e.symbolLayers;l&&l.forEach((e=>{if(e&&"object"===e.type)switch(o){case"tilt":e.tilt=t;break;case"roll":e.roll=t;break;default:e.heading=t}}))}else l.isSymbol2D(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=t))}function R(e){if(!e)return null;const t=e.effects.filter((e=>"bloom"!==e.type)).map((e=>e.toJSON()));return u.effectFunctionsFromJSON(t)}function H(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some((e=>"extrude"===e.type))}async function J(e,t){const o=await e.fetchSymbol(t);return o||e.fetchCIMSymbol(t)}t.applyColorToSymbol=z,t.applyOpacityToColor=g,t.applyRotationToSymbol=N,t.applySizesToSymbol=I,t.fetchWebStyleSymbol=J,t.getCSSFilterFromEffectList=R,t.getColorFromSymbol=w,t.getIconHref=S,t.getSymbolOutlineSize=p,t.isVolumetricSymbol=h,t.symbolHasExtrudeSymbolLayer=H,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
