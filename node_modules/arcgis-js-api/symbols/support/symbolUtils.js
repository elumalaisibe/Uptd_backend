/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../core/has","../../support/arcadeOnDemand","./gfxUtils","./previewUtils","./renderUtils","./utils","../../widgets/Legend/styles/support/relationshipUtils","../../widgets/Legend/support/relationshipRampUtils"],(function(e,t,l,r,i,a,o,n,s,c){"use strict";let u=null;const y=[255,255,255];function f(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function p(e,t,l){const{backgroundColor:r,outline:i,dotSize:o}=e,n=l&&l.swatchSize||a.SymbolSizeDefaults.size,s=.8,c=Math.round(n*n/o**2*s),y=window.devicePixelRatio,p=document.createElement("canvas"),h=n*y;p.width=h,p.height=h,p.style.width=p.width/y+"px",p.style.height=p.height/y+"px";const d=p.getContext("2d");if(r&&(d.fillStyle=r.toCss(!0),d.fillRect(0,0,h,h),d.fill()),d.fillStyle=t?.toCss(!0)??"",u&&u.length/2===c)for(let a=0;a<2*c;a+=2){const e=u[a],t=u[a+1];d.fillRect(e,t,o*y,o*y),d.fill()}else{u=[];for(let e=0;e<2*c;e+=2){const e=f(0,h),t=f(0,h);u.push(e,t),d.fillRect(e,t,o*y,o*y),d.fill()}}i&&(i.color&&(d.strokeStyle=i.color.toCss(!0)),d.lineWidth=i.width,d.strokeRect(0,0,h,h));const b=new Image(n,n);return b.src=p.toDataURL(),b.ariaLabel=l?.ariaLabel??null,b.alt=l?.ariaLabel??"",b}function h(e,t={}){const l=t.radius||40,r=2*Math.PI*l,a=e.length,n=r/a,s=[],c=i.getStroke(t.outline);null!=c?.width&&(c.width*=2),(c||t.backgroundColor)&&s.push({shape:{type:"circle",cx:l,cy:l,r:l},fill:t.backgroundColor,stroke:c,offset:[0,0]});const u=t.values,f=u&&u.length===a&&100===u.reduce(((e,t)=>e+t),0),p=[0];for(let i=0;i<a;i++){let t=null;f&&(t=u[i]*r/100,p.push(t+p[i])),s.push({shape:{type:"circle",cx:l,cy:l,r:l/2},fill:[0,0,0,0],stroke:{width:l,dashArray:`${(t??n)/2} ${r}`,dashoffset:"-"+(f?p[i]/2:i*(n/2)),color:e[i]},offset:[0,0]})}let h=null;const d=2*l+(c?.width||0),b=t.holePercentage;if(b){c&&s.push({shape:{type:"circle",cx:l,cy:l,r:l*b},fill:null,stroke:c,offset:[0,0]});const e=d/2;h=[[{shape:{type:"circle",cx:e,cy:e,r:e},fill:y,stroke:c?{...c,color:y}:null,offset:[0,0]},{shape:{type:"circle",cx:e,cy:e,r:l*b},fill:[0,0,0],stroke:null,offset:[0,0]}]]}return o.renderSymbol([s],[d,d],{effectView:t.effectList,ignoreStrokeWidth:!0,masking:h,rotation:-90,ariaLabel:t.ariaLabel})}function d(e,t={}){const l=e?.authoringInfo;if(!("relationship"===l?.type)||!l?.numClasses||!e.uniqueValueInfos)return null;const{focus:r,numClasses:i}=l,a=c.getRelationshipRampElement({focus:r,numClasses:i,infos:e.uniqueValueInfos}),n=t&&t.node||document.createElement("div"),u=()=>s.renderRelationshipRamp(a,t.id||"relationship",{opacity:t.opacity||1,effectList:t.effectList,ariaLabel:t.ariaLabel});return o.renderOnce(n,u),n}function b(e,t={}){const l=24,r=75,i="horizontal"===t.align,a=i?r:l,o=i?l:r,n=t.width??a,s=t.height??o,c=t.gradient??!0,u=window.devicePixelRatio,y=n*u,f=s*u,p=document.createElement("canvas");p.width=y,p.height=f,p.ariaLabel=t.ariaLabel??null,p.style.width=`${n}px`,p.style.height=`${s}px`;const h=p.getContext("2d"),d=i?y:0,b=i?0:f;if(c){const t=h.createLinearGradient(0,0,d,b),l=e.length,r=1===l?0:1/(l-1);e.forEach(((e,l)=>t.addColorStop(l*r,e.toString()))),h.fillStyle=t,h.fillRect(0,0,y,f)}else{const t=i?y/e.length:y,l=i?f:f/e.length;let r=0,a=0;for(const o of e)h.fillStyle=o.toString(),h.fillRect(r,a,t,l),r=i?r+t:0,a=i?0:a+l}const g=document.createElement("div");return g.style.width=`${n}px`,g.style.height=`${s}px`,m(g,t?.effectList),g.appendChild(p),g}function m(e,t){if(!t)return;e.style.filter=n.getCSSFilterFromEffectList(t);const l=t.effects;if(l)for(const r of l)if("drop-shadow"===r?.type){r.offsetX<0?e.style.marginLeft=`${Math.abs(r.offsetX)}px`:e.style.marginRight=`${r.offsetX}px`;break}}async function g(t,l){switch(t.type){case"web-style":{const{previewWebStyleSymbol:r}=await new Promise(((t,l)=>e(["./previewWebStyleSymbol"],t,l)));return r(t,g,l)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:r}=await new Promise(((t,l)=>e(["./previewSymbol3D"],t,l)));return r(t,l)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:r}=await new Promise(((t,l)=>e(["./previewSymbol2D"],t,l)));return r(t,l)}case"cim":{const{previewCIMSymbol:r}=await new Promise(((t,l)=>e(["./previewCIMSymbol"],t,l)));return r(t,l)}default:return}}function w(e){return e&&"opacity"in e?e.opacity*w(e.parent):1}async function S(t,l){if(!t)return;const i=t.sourceLayer,a=(null!=l&&l.useSourceLayer?i:t.layer)??i,o=w(a);if(null!=t.symbol&&(null==l||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await n.fetchWebStyleSymbol(t.symbol,{...l,cache:null!=l?l.webStyleCache:null}):t.symbol.clone();return n.applyColorToSymbol(e,null,o),e}const s=(null!=l?l.renderer:null)??(a&&"renderer"in a?a.renderer:null);let c=s&&"getSymbolAsync"in s?await s.getSymbolAsync(t,l):null;if(!c)return;if(c="web-style"===c.type?await c.fetchSymbol({...l,cache:null!=l?l.webStyleCache:null}):c.clone(),!(s&&"visualVariables"in s&&s.visualVariables&&s.visualVariables.length))return n.applyColorToSymbol(c,null,o),c;if("arcadeRequiredForVisualVariables"in s&&s.arcadeRequiredForVisualVariables&&(null==l||null==l.arcade)){const e={...l};e.arcade=await r.loadArcade(),l=e}const{getColor:u,getOpacity:y,getAllSizes:f,getRotationAngle:p}=await new Promise(((t,l)=>e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l))),h=[],d=[],b=[],m=[];for(const e of s.visualVariables)switch(e.type){case"color":h.push(e);break;case"opacity":d.push(e);break;case"rotation":m.push(e);break;case"size":e.target||b.push(e)}const g=!!h.length&&h[h.length-1],S=g?u(g,t,l):null,v=!!d.length&&d[d.length-1];let C=v?y(v,t,l):null;if(null!=o&&(C=null!=C?C*o:o),n.applyColorToSymbol(c,S,C),b.length){const e=f(b,t,l);await n.applySizesToSymbol(c,e)}for(const e of m)n.applyRotationToSymbol(c,p(e,t,l),e.axis);return c}async function v(t,l){if(!t)return;const i=w(t.layer||t.sourceLayer);if(null!=t.symbol&&(null==l||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await n.fetchWebStyleSymbol(t.symbol,l):t.symbol.clone();return n.getColorFromSymbol(e,i)}const a=null!=l&&l.renderer||t.get("layer.renderer")||t.get("sourceLayer.renderer");let o=await a.getSymbolAsync(t,l);if(!o)return;o="web-style"===o.type?await n.fetchWebStyleSymbol(o,l):o.clone();const s=n.getColorFromSymbol(o,i);if(!("visualVariables"in a)||"visualVariables"in a&&!a.visualVariables||"visualVariables"in a&&!a.visualVariables?.length)return s;if(a.arcadeRequiredForVisualVariables&&(null==l||null==l.arcade)){const e={...l};e.arcade=await r.loadArcade(),l=e}const{getColor:c,getOpacity:u}=await new Promise(((t,l)=>e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l))),y=[],f=[];for(const e of a.visualVariables)switch(e.type){case"color":y.push(e);break;case"opacity":f.push(e)}const p=y.length>0?y[y.length-1]:null,h=p?c(p,t,l):s,d=f.length>0?f[f.length-1]:null;let b=d?u(d,t,l):null;return null!=i&&(b=null!=b?b*i:i),h?n.applyOpacityToColor(h,b):null}t.getDisplayedColor=v,t.getDisplayedSymbol=S,t.renderColorRampPreviewHTML=b,t.renderDotDensityPreviewHTML=p,t.renderPieChartPreviewHTML=h,t.renderPreviewHTML=g,t.renderRelationshipRampPreviewHTML=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
