/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../arcade/arcadeCompiler","../arcade/ArcadeModuleResolver","../arcade/arcadeRuntime","../arcade/executionError","../arcade/parser","../arcade/treeAnalysis","../core/has","../core/maybe"],(function(e,r,t,n,c,i,s,u,o,a){"use strict";const l=["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","isselfintersecting","ringisclockwise"];function d(){return!0}const p=d();let f=!1,S=!1,m=null,y=[];function x(e,r){if(!0===r.useAsync||!0===e.isAsync)return b(e,r);if(o("esri-csp-restrictions")){return function(r){return c.executeScript(e,r)}}try{return t.compileScript(e,r)}catch(n){if("esri.arcade.arcadeuncompilableerror"===n.declaredRootClass)return function(r){return c.executeScript(e,r)};throw n}}function b(e,r){if(null===m)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AsyncNotEnabled,null);if(o("esri-csp-restrictions")||!1===p){return function(r){return m.executeScript(e,r)}}try{return t.compileScript(e,r,!0)}catch(n){if("esri.arcade.arcadeuncompilableerror"===n.declaredRootClass)return function(r){return m.executeScript(e,r)};throw n}}function E(e){c.extend(e),t.extend(e,"sync"),null===m?y.push(e):(t.extend(e,"async"),m.extend(e))}function A(e,r=[]){return s.parseScript(e,r)}function w(e,r,t=[]){return F(s.parseScript(e,t),r)}function F(e,r){if(!0===r.useAsync||!0===e.isAsync){if(null===m)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AsyncNotEnabled,null);return m.executeScript(e,r)}return c.executeScript(e,r)}function g(e,r){return u.referencesMember(e,r)}function h(e,r){return u.referencesFunction(e,r)}function M(e,r=!1){return void 0===r&&(r=!1),u.findFieldLiterals(e)}function G(e){return u.findExpectedFieldLiterals(e)}function I(e,r=[]){return void 0===e.usesGeometry&&u.findScriptDependencies(e,r),!0===e.usesGeometry}let P=null;function D(){return P||(P=U(),P)}async function U(){const[r,t]=await Promise.all([new Promise(((r,t)=>e(["../geometry/geometryEngine"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/geomsync"],r,t)))]);return S=!0,t.setGeometryEngine(r),!0}let v=null;function C(){return null!==v||(v=L()),v}async function L(){await t.enableAsyncSupport(),m=await new Promise(((r,t)=>e(["../arcade/arcadeAsyncRuntime"],r,t)));for(const e of y)m.extend(e),t.extend(e,"async");return y=null,!0}function R(){return f}function _(){return!!m}function T(){return S}let j=null;function k(){return j||(j=z(),j)}async function z(){await C();const[r,n,c,i,s]=await Promise.all([new Promise(((r,t)=>e(["../arcade/featureSetUtils"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetbase"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetgeom"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetstats"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetstring"],r,t)))]);return V=r,m.extend([n,c,i,s]),t.extend([n,c,i,s],"async"),f=!0,!0}function N(e,r=[]){return void 0===e.usesFeatureSet&&u.findScriptDependencies(e,r),!0===e.usesFeatureSet}function O(e,r=[]){return void 0===e.isAsync&&u.findScriptDependencies(e,r),!0===e.isAsync}function q(e,r){if(r){for(const t of r)if(g(e,t))return!0;return!1}return!1}async function B(e,r,t=[],n=!1,c=null){return H(new Set,e,r,t,n,c)}async function H(e,r,t,n=[],c=!1,i=null){const s="string"==typeof r?A(r):r,u=[];return s&&(!1===T()&&(I(s)||c)&&u.push(D()),!1===_()&&(!0===s.isAsync||t)&&u.push(C()),!1===R()&&(N(s)||q(s,n))&&u.push(k())),u.length&&await Promise.all(u),await K(e,s,i,t,c),!0}function J(e,r=[]){return void 0===e.usesModules&&u.findScriptDependencies(e,r),!0===e.usesModules}async function K(e,r,t=null,c=!1,s=!1){const o=u.findModuleImports(r);null===t&&o.length>0&&(t=n.ArcadeModuleResolver.getDefault()),r.loadedModules={};for(const n of o){a.assertIsSome(t);const u=t.normalizeModuleUri(n.source);if(e.has(u.uri))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.CircularModules,null);e.add(u.uri);const o=await t.fetchModule(u);await H(e,o,c,[],s,t),e.delete(u.uri),o.isAsync&&(r.isAsync=!0),o.usesFeatureSet&&(r.usesFeatureSet=!0),o.usesGeometry&&(r.usesGeometry=!0),r.loadedModules[n.libname]={uri:u.uri,script:o}}}function Q(e){if(I(e))return!0;const r=u.findFunctionCalls(e);let t=!1;for(let n=0;n<r.length;n++)if(l.includes(r[n])){t=!0;break}return t}let V=null;function W(){return V}const X=Object.freeze(Object.defineProperty({__proto__:null,_loadScriptDependenciesImpl:H,compileScript:x,enableAsyncSupport:C,enableAsyncSupportImpl:L,enableFeatureSetSupport:k,enableFeatureSetSupportImpl:z,enableGeometrySupport:D,enableGeometrySupportImpl:U,executeScript:F,extend:E,extractExpectedFieldLiterals:G,extractFieldLiterals:M,featureSetUtils:W,isAsyncEnabled:_,isFeatureSetSupportEnabled:R,isGeometryEnabled:T,loadDependentModules:K,loadScriptDependencies:B,parseAndExecuteScript:w,parseScript:A,referencesFunction:h,referencesMember:g,scriptIsAsync:O,scriptTouchesGeometry:Q,scriptUsesFeatureSet:N,scriptUsesGeometryEngine:I,scriptUsesModules:J},Symbol.toStringTag,{value:"Module"}));r._loadScriptDependenciesImpl=H,r.arcade=X,r.compileScript=x,r.enableAsyncSupport=C,r.enableAsyncSupportImpl=L,r.enableFeatureSetSupport=k,r.enableFeatureSetSupportImpl=z,r.enableGeometrySupport=D,r.enableGeometrySupportImpl=U,r.executeScript=F,r.extend=E,r.extractExpectedFieldLiterals=G,r.extractFieldLiterals=M,r.featureSetUtils=W,r.isAsyncEnabled=_,r.isFeatureSetSupportEnabled=R,r.isGeometryEnabled=T,r.loadDependentModules=K,r.loadScriptDependencies=B,r.parseAndExecuteScript=w,r.parseScript=A,r.referencesFunction=h,r.referencesMember=g,r.scriptIsAsync=O,r.scriptTouchesGeometry=Q,r.scriptUsesFeatureSet=N,r.scriptUsesGeometryEngine=I,r.scriptUsesModules=J}));
