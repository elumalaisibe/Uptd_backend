/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../chunks/_rollupPluginBabelHelpers","../core/CircularArray","./geohashUtils","../geometry/SpatialReference","../layers/graphics/featureConversionUtils","../layers/graphics/OptimizedGeometry","../layers/graphics/data/projectionSupport","../views/2d/layers/features/support/FeatureSetReaderJSON"],(function(t,e,n,s,i,o,a,r,l){"use strict";let c=function(){function t(t=[],e,s=8096){this.onRelease=t=>{},this._nodes=0,this._root=new h(this,0,0,0),this._statisticFields=t,this._pool=s?new n(8096):null,this._serviceInfo=e}var s=t.prototype;return s.destroy=function(){this.clear()},s._acquire=function(t,e,n){this._nodes++;let s=null;return null!=this._pool&&(s=this._pool.dequeue()),null!=s?s.realloc(t,e,n):s=new h(this,t,e,n),s},s._release=function(t){this.onRelease(t),this._nodes--,null!=this._pool&&this._pool.enqueue(t)},s.dropLevels=function(t){this.forEach((e=>{if(e.depth>=t)for(let t=0;t<e.children.length;t++){const n=e.children[t];n&&this._release(n)}})),this.forEach((e=>{if(e.depth>=t)for(let t=0;t<e.children.length;t++)e.children[t]=null}))},s.clear=function(){this.forEach((t=>this._release(t))),this._root=new h(this,0,0,0)},s.insert=function(t,e,n=0){const s=l.FeatureSetReaderJSON.fromOptimizedFeatures([t],this._serviceInfo).getCursor();s.next();const i=s.readGeometry();if(!i)return;const[o,a]=i.coords,r=t.geohashX,c=t.geohashY;this.insertCursor(s,t.displayId,o,a,r,c,e,n)},s.insertCursor=function(t,e,n,s,i,o,a,r=0){let l=this._root,c=0,h=0,u=0;for(;null!==l;){if(l.depth>=r&&(l.count+=1,l.xTotal+=n,l.yTotal+=s,l.xGeohashTotal+=i,l.yGeohashTotal+=o,l.referenceId=e,this._updateStatisticsCursor(t,l,1)),c>=a)return void l.add(e);const d=Math.ceil((c+1)/2),f=Math.floor((c+1)/2),x=1-c%2,y=30-(3*d+2*f),g=30-(2*d+3*f),p=(i&7*x+3*(1-x)<<y)>>y,m=(o&3*x+7*(1-x)<<g)>>g,_=p+m*(8*x+4*(1-x));h=h<<3*x+2*(1-x)|p,u=u<<2*x+3*(1-x)|m,null==l.children[_]&&(l.children[_]=this._acquire(h,u,c+1)),c+=1,l=l.children[_]}},s.remove=function(t,e){const n=l.FeatureSetReaderJSON.fromOptimizedFeatures([t],this._serviceInfo).getCursor();n.next();const s=n.readGeometry();if(!s)return;const[i,o]=s.coords,a=t.geohashX,r=t.geohashY;this.removeCursor(n,i,o,a,r,e)},s.removeCursor=function(t,e,n,s,i,o){let a=this._root,r=0;for(;null!==a;){if(a.count-=1,a.xTotal-=e,a.yTotal-=n,a.xGeohashTotal-=s,a.yGeohashTotal-=i,this._updateStatisticsCursor(t,a,-1),r>=o)return void a.remove(t.getDisplayId());const l=Math.ceil((r+1)/2),c=Math.floor((r+1)/2),h=1-r%2,u=30-(3*l+2*c),d=30-(2*l+3*c),f=((s&7*h+3*(1-h)<<u)>>u)+((i&3*h+7*(1-h)<<d)>>d)*(8*h+4*(1-h)),x=a.children[f];1===x?.count&&(this._release(x),a.children[f]=null),r+=1,a=x}},s.forEach=function(t){let e=this._root;for(;null!==e;){const n=this._linkChildren(e)||e.next;t(e),e=n}},s.find=function(t,e,n){return this._root.find(t,e,n,0,0,0)},s.findIf=function(t){let e=null;return this.forEach((n=>{t(n)&&(e=n)})),e},s.findAllIf=function(t){const e=[];return this.forEach((n=>{t(n)&&e.push(n)})),e},s.findSingleOccupancyNode=function(t,e,n,s,i){let o=this._root;for(;null!==o;){const a=o.depth,r=o.xNode,l=o.yNode,c=1-a%2,h=o.xGeohashTotal/o.count,u=o.yGeohashTotal/o.count;if(1===o.count&&t<h&&h<=n&&e<u&&u<=s)return o;if(a>=i){o=o.next;continue}const d=Math.ceil((a+1)/2),f=Math.floor((a+1)/2),x=30-(3*d+2*f),y=30-(2*d+3*f),g=~((1<<x)-1),p=~((1<<y)-1),m=(t&g)>>x,_=(e&p)>>y,v=(n&g)>>x,M=(s&p)>>y,T=r<<3*c+2*(1-c),b=l<<2*c+3*(1-c),k=T+8*c+4*(1-c),N=b+4*c+8*(1-c),C=Math.max(T,m),I=Math.max(b,_),S=Math.min(k,v),G=Math.min(N,M);let L=null,w=null;for(let t=I;t<=G;t++)for(let e=C;e<=S;e++){const n=e-T+(t-b)*(8*c+4*(1-c)),s=o.children[n];s&&(L||(L=s,L.next=o.next),w&&(w.next=s),w=s,s.next=o.next)}o=L||o.next}return null},s.getRegionDisplayIds=function(t){let e=this._root;const{bounds:n,geohashBounds:s,level:i}=t,[o,a,r,l]=n,c=[];for(;null!==e;){const t=e.depth,n=e.xNode,h=e.yNode;if(t>=i){const t=e.xTotal/e.count,n=e.yTotal/e.count;t>=o&&t<=r&&n>=a&&n<=l&&e.displayIds.forEach((t=>c.push(t))),e=e.next;continue}const u=Math.ceil((t+1)/2),d=Math.floor((t+1)/2),f=1-t%2,x=30-(3*u+2*d),y=30-(2*u+3*d),g=~((1<<x)-1),p=~((1<<y)-1),m=(s.xLL&g)>>x,_=(s.yLL&p)>>y,v=(s.xTR&g)>>x,M=(s.yTR&p)>>y,T=n<<3*f+2*(1-f),b=h<<2*f+3*(1-f),k=T+8*f+4*(1-f),N=b+4*f+8*(1-f),C=Math.max(T,m),I=Math.max(b,_),S=Math.min(k,v),G=Math.min(N,M);let L=null,w=null;for(let s=I;s<=G;s++)for(let t=C;t<=S;t++){const n=t-T+(s-b)*(8*f+4*(1-f)),i=e.children[n];i&&(L||(L=i,L.next=e.next),w&&(w.next=i),w=i,i.next=e.next)}e=L||e.next}return c},s.getRegionStatistics=function(t){let e=this._root,n=0,s=0,i=0;const o={},{bounds:a,geohashBounds:r,level:l}=t,[c,h,u,d]=a;let f=0;for(;null!==e;){const t=e.depth,a=e.xNode,x=e.yNode;if(t>=l){const t=e.xTotal/e.count,a=e.yTotal/e.count;t>c&&t<=u&&a>h&&a<=d&&(n+=e.count,s+=e.xTotal,i+=e.yTotal,1===e.count&&(f=e.referenceId),this._aggregateStatistics(o,e.statistics)),e=e.next;continue}const y=Math.ceil((t+1)/2),g=Math.floor((t+1)/2),p=1-t%2,m=30-(3*y+2*g),_=30-(2*y+3*g),v=~((1<<m)-1),M=~((1<<_)-1),T=(r.xLL&v)>>m,b=(r.yLL&M)>>_,k=(r.xTR&v)>>m,N=(r.yTR&M)>>_,C=a<<3*p+2*(1-p),I=x<<2*p+3*(1-p),S=C+8*p+4*(1-p),G=I+4*p+8*(1-p),L=Math.max(C,T),w=Math.max(I,b),F=Math.min(S,k),R=Math.min(G,N);let z=null,O=null;for(let r=w;r<=R;r++)for(let t=L;t<=F;t++){const a=t-C+(r-I)*(8*p+4*(1-p)),l=e.children[a];if(l){if(r!==w&&r!==R&&t!==L&&t!==F){const t=l.xTotal/l.count,e=l.yTotal/l.count;t>c&&t<=u&&e>h&&e<=d&&(n+=l.count,s+=l.xTotal,i+=l.yTotal,1===l.count&&(f=l.referenceId),this._aggregateStatistics(o,l.statistics));continue}z||(z=l,z.next=e.next),O&&(O.next=l),O=l,l.next=e.next}}e=z||e.next}return{count:n,attributes:this.normalizeStatistics(o,n),xTotal:s,yTotal:i,referenceId:f}},s.getBins=function(t){const e=[],{geohashBounds:n,level:s}=t;let i=this._root;for(;null!==i;){const t=i.depth,o=i.xNode,a=i.yNode;if(t>=s){e.push(i),i=i.next;continue}const r=Math.ceil((t+1)/2),l=Math.floor((t+1)/2),c=1-t%2,h=30-(3*r+2*l),u=30-(2*r+3*l),d=~((1<<h)-1),f=~((1<<u)-1),x=(n.xLL&d)>>h,y=(n.yLL&f)>>u,g=(n.xTR&d)>>h,p=(n.yTR&f)>>u,m=o<<3*c+2*(1-c),_=a<<2*c+3*(1-c),v=m+8*c+4*(1-c),M=_+4*c+8*(1-c),T=Math.max(m,x),b=Math.max(_,y),k=Math.min(v,g),N=Math.min(M,p);let C=null,I=null;for(let e=b;e<=N;e++)for(let t=T;t<=k;t++){const n=t-m+(e-_)*(8*c+4*(1-c)),s=i.children[n];s&&(C||(C=s,C.next=i.next),I&&(I.next=s),I=s,s.next=i.next)}i=C||i.next}return e},s._linkChildren=function(t){let e=null,n=null;for(let s=0;s<=t.children.length;s++){const i=t.children[s];i&&(e||(e=i,e.next=t.next),n&&(n.next=i),n=i,i.next=t.next)}return e},s._updateStatisticsCursor=function(t,e,n){for(const s of this._statisticFields){const i=s.name,o=s.inField?t.readAttribute(s.inField):t.getComputedNumericAtIndex(s.inFieldIndex);switch(s.statisticType){case"min":{if(isNaN(o))break;if(!e.statistics[i]){e.statistics[i]={value:o};break}const t=e.statistics[i].value;e.statistics[i].value=Math.min(t,o);break}case"max":{if(isNaN(o))break;if(!e.statistics[i]){e.statistics[i]={value:o};break}const t=e.statistics[i].value;e.statistics[i].value=Math.max(t,o);break}case"count":break;case"sum":case"avg":{e.statistics[i]||(e.statistics[i]={value:0,nanCount:0});const t=e.statistics[i].value,s=e.statistics[i].nanCount??0;null==o||isNaN(o)?e.statistics[i].nanCount=s+n:e.statistics[i].value=t+n*o;break}case"avg_angle":{e.statistics[i]||(e.statistics[i]={x:0,y:0,nanCount:0});const t=e.statistics[i].x,s=e.statistics[i].y,a=e.statistics[i].nanCount??0,r=Math.PI/180;null==o||isNaN(o)?e.statistics[i].nanCount=a+n:(e.statistics[i].x=t+n*Math.cos(o*r),e.statistics[i].y=s+n*Math.sin(o*r));break}case"mode":{e.statistics[i]||(e.statistics[i]={});const t=e.statistics[i][o]||0;e.statistics[i][o]=t+n;break}}}},s._aggregateStatistics=function(t,e){for(const n of this._statisticFields){const s=n.name;switch(n.statisticType){case"min":{if(!t[s]){t[s]={value:e[s].value};break}const n=t[s].value;t[s].value=Math.min(n,e[s].value);break}case"max":{if(!t[s]){t[s]={value:e[s].value};break}const n=t[s].value;t[s].value=Math.max(n,e[s].value);break}case"count":break;case"sum":case"avg":case"avg_angle":case"mode":t[s]||(t[s]={});for(const n in e[s]){const i=t[s][n]||0;t[s][n]=i+e[s][n]}}}},s.normalizeStatistics=function(t,e){const n={};for(const s of this._statisticFields){const i=s.name;switch(s.statisticType){case"min":case"max":{const s=t[i];if(!e||!s)break;n[i]=s.value;break}case"count":if(!e)break;n[i]=e;break;case"sum":{if(!e)break;const{value:s,nanCount:o}=t[i];if(!(e-o))break;n[i]=s;break}case"avg":{if(!e)break;const{value:s,nanCount:o}=t[i];if(!(e-o))break;n[i]=s/(e-o);break}case"avg_angle":{if(!e)break;const{x:s,y:o,nanCount:a}=t[i];if(!(e-a))break;const r=s/(e-a),l=o/(e-a),c=180/Math.PI,h=Math.atan2(l,r)*c;n[i]=h;break}case"mode":{const e=t[i];let s=0,o=0,a=null;for(const t in e){const n=e[t];n===s?o+=1:n>s&&(s=n,o=1,a=t)}n[i]="null"===a||o>1?null:a;break}}}return n},e._createClass(t,[{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return this._pool?.size??0}},{key:"depth",get:function(){let t=0;return this.forEach((e=>t=Math.max(t,e.depth))),t}}]),t}(),h=function(){function t(t,e,n,s){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=t,this.children=new Array(32);for(let i=0;i<this.children.length;i++)this.children[i]=null;this.xNode=e,this.yNode=n,this.depth=s}var n=t.prototype;return n.realloc=function(t,e,n){for(let s=0;s<this.children.length;s++)this.children[s]=null;return this.xNode=t,this.yNode=e,this.depth=n,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this},n.add=function(t){this.displayIds.add(t)},n.remove=function(t){this.displayIds.delete(t)},n.getAttributes=function(){const t=this._tree.normalizeStatistics(this.statistics,this.count);return t.referenceId=null,t.aggregateId=this.id,t.aggregateCount=this.count,t},n.getGeometry=function(t,e){const n=this.getLngLatBounds(),[s,l,c,h]=n,u={rings:[[[s,l],[s,h],[c,h],[c,l],[s,l]]]},d=r.project(u,i.WGS84,t),f=o.convertFromPolygon(new a,d,!1,!1);if(null!=e){return o.quantizeOptimizedGeometry(new a,f,!1,!1,"esriGeometryPolygon",e,!1,!1)}return f},n.getGeometryCentroid=function(t,e){const n=this.getLngLatBounds(),[s,l,c,h]=n,u={x:(s+c)/2,y:(l+h)/2},d=r.project(u,i.WGS84,t),f=o.convertFromPoint(new a,d);if(null!=e){return o.quantizeOptimizedGeometry(new a,f,!1,!1,"esriGeometryPoint",e,!1,!1)}return f},n.getLngLatBounds=function(){const t=this.depth,e=Math.ceil(t/2),n=Math.floor(t/2),i=30-(3*e+2*n),o=30-(2*e+3*n),a=this.xNode<<i,r=this.yNode<<o;return s.decodeGeohashXY({geohashX:a,geohashY:r},this.depth)},n.find=function(t,e,n,s,i,o){if(s>=n)return this;const a=1-s%2,r=3*a+2*(1-a),l=2*a+3*(1-a),c=30-i-r,h=30-o-l,u=((t&7*a+3*(1-a)<<c)>>c)+((e&3*a+7*(1-a)<<h)>>h)*(8*a+4*(1-a)),d=this.children[u];return null==d?null:d.find(t,e,n,s+1,i+r,o+l)},e._createClass(t,[{key:"id",get:function(){return`${this.xNode}.${this.yNode}`}}]),t}();t.GeohashNode=h,t.GeohashTree=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
