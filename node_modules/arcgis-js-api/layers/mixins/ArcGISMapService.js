/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../request","../../core/MapUtils","../../core/promiseUtils","../../core/urlUtils","../../core/Version","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/PropertyOrigin","../../geometry/Extent","../../geometry/SpatialReference","../support/arcgisLayerUrl","../support/commonProperties","../../portal/support/portalItemUtils"],(function(e,r,t,s,o,a,i,p,l,n,c,u,d,y,h,f,m,b,_,v){"use strict";const I=e=>{let n=function(e){function t(){var r;return(r=e.apply(this,arguments)||this).capabilities=void 0,r.copyright=null,r.fullExtent=null,r.legendEnabled=!0,r.spatialReference=null,r.version=void 0,r._allLayersAndTablesMap=null,r}r._inherits(t,e);var l=t.prototype;return l.readCapabilities=function(e,r){const t=r.capabilities&&r.capabilities.split(",").map((e=>e.toLowerCase().trim()));if(!t)return{operations:{supportsExportMap:!1,supportsExportTiles:!1,supportsIdentify:!1,supportsQuery:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};const s=this.type,o="tile"!==s&&!!r.supportsDynamicLayers,a=t.includes("query"),i=t.includes("map"),l=!!r.exportTilesAllowed,n=t.includes("tilemap"),c=t.includes("data"),u="tile"!==s&&(!r.tileInfo||o),d="tile"!==s&&(!r.tileInfo||o),y="tile"!==s,h=r.cimVersion&&p.Version.parse(r.cimVersion),f=h?.since(1,4)??!1,m=h?.since(2,0)??!1;return{operations:{supportsExportMap:i,supportsExportTiles:l,supportsIdentify:a,supportsQuery:c,supportsTileMap:n},exportMap:i?{supportsArcadeExpressionForLabeling:f,supportsSublayersChanges:y,supportsDynamicLayers:o,supportsSublayerVisibility:u,supportsSublayerDefinitionExpression:d,supportsCIMSymbols:m}:null,exportTiles:l?{maxExportTilesCount:+r.maxExportTilesCount}:null}},l.readVersion=function(e,r){let t=r.currentVersion;return t||(t=r.hasOwnProperty("capabilities")||r.hasOwnProperty("tables")?10:r.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3),t},l.fetchRelatedService=async function(e){const r=this.portalItem;if(!r||!v.isHostedLayer(r))return null;this._relatedFeatureServicePromise||(this._relatedFeatureServicePromise=r.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},e).then((e=>e.find((e=>"Feature Service"===e.type))??null),(()=>null)));const t=await this._relatedFeatureServicePromise;return a.throwIfAborted(e),t?{itemId:t.id,url:t.url}:null},l.fetchSublayerInfo=async function(e,r){const{source:t}=e;if(this?.portalItem&&"tile"===this.type&&"map-layer"===t?.type&&v.isHostedLayer(this.portalItem)&&e.originIdOf("url")<h.OriginId.SERVICE){const s=await this.fetchRelatedService(r);s&&(e.url=i.join(s.url,t.mapLayerId.toString()),e.layerItemId=s.itemId)}const{url:o}=e;let a;if("data-layer"===t.type){a=(await s(o,{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey},...r})).data}else if(o&&e.originIdOf("url")>h.OriginId.SERVICE)try{a=(await this._fetchAllLayersAndTablesFromService(o)).get(t.mapLayerId)}catch{}else{let s=e.id;"map-layer"===t?.type&&(s=t.mapLayerId);try{a=(await this.fetchAllLayersAndTables(r)).get(s)}catch{}}return a},l.fetchAllLayersAndTables=async function(e){return this._fetchAllLayersAndTablesFromService(this.parsedUrl?.path,e)},l._fetchAllLayersAndTablesFromService=async function(e,r){await this.load(r),this._allLayersAndTablesMap||(this._allLayersAndTablesMap=new Map);const t=b.parse(e),p=o.getOrCreateMapValue(this._allLayersAndTablesMap,t?.url.path,(()=>s(i.join(t?.url.path,"/layers"),{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey}}).then((e=>{const r=new Map;for(const t of e.data.layers)r.set(t.id,t);return{result:r}}),(e=>({error:e}))))),l=await p;if(a.throwIfAborted(r),"result"in l)return l.result;throw l.error},r._createClass(t)}(e);return t.__decorate([l.property({readOnly:!0})],n.prototype,"capabilities",void 0),t.__decorate([d.reader("service","capabilities",["capabilities","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],n.prototype,"readCapabilities",null),t.__decorate([l.property({json:{read:{source:"copyrightText"}}})],n.prototype,"copyright",void 0),t.__decorate([l.property({type:f})],n.prototype,"fullExtent",void 0),t.__decorate([l.property(_.id)],n.prototype,"id",void 0),t.__decorate([l.property({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],n.prototype,"legendEnabled",void 0),t.__decorate([l.property(_.popupEnabled)],n.prototype,"popupEnabled",void 0),t.__decorate([l.property({type:m})],n.prototype,"spatialReference",void 0),t.__decorate([l.property({readOnly:!0})],n.prototype,"version",void 0),t.__decorate([d.reader("version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],n.prototype,"readVersion",null),n=t.__decorate([y.subclass("esri.layers.mixins.ArcGISMapService")],n),n};e.ArcGISMapService=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
