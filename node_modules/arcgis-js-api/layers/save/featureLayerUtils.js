/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../core/arrayUtils","../../core/Error","../../core/Logger","../../core/promiseUtils","../../core/accessorSupport/originUtils","../FeatureLayer","../support/arcgisLayerUrl","../support/fetchService","../support/layerUtils","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../portal/support/portalItemUtils"],(function(e,t,a,r,o,l,n,s,i,u,d,y,c,p){"use strict";const f=r.getLogger("esri.layers.FeatureLayer"),m="Feature Service";function w(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function v(e,t){if(t.type!==m)throw new a("feature-layer:portal-item-wrong-type",w(e,`should have portal item of type "${m}"`))}async function h(e){if(await e.load(),u.isFeatureCollectionLayer(e))throw new a("feature-layer:save",w(e,"using an in-memory source cannot be saved to a portal item"))}function b(e,t){let r=(e.messages??[]).filter((({type:e})=>"error"===e)).map((({name:e,message:t,details:r})=>new a(e,t,r)));if(t?.ignoreUnsupported&&(r=r.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),r.length>0)throw new a("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}async function S(e,t,a){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const r=e.write({},t);return b(t,a),r}function I(e){const{layer:t,layerJSON:a}=e;return t.isTable?{layers:[],tables:[a]}:{layers:[a],tables:[]}}function g(e){p.addTypeKeyword(e,p.TypeKeyword.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,a)=>a.indexOf(e)===t)))}function T(e){const t=e.portalItem;if(!t)throw f.error("save: requires the portalItem property to be set"),new a("feature-layer:portal-item-not-set",w(e,"requires the portalItem property to be set"));if(!t.loaded)throw new a("feature-layer:portal-item-not-loaded",w(e,"cannot be saved to a portal item that does not exist or is inaccessible"));v(e,t)}async function K(e,t){return/\/\d+\/?$/.test(e.url??"")?I(t[0]):O(e,t)}async function O(e,t){const{layer:{url:a,customParameters:r,apiKey:o}}=t[0];let l=await e.fetchData("json");l&&null!=l.layers&&null!=l.tables||(l=await F(l,{url:a??"",customParameters:r,apiKey:o},t.map((e=>e.layer.layerId))));for(const n of t)A(n.layer,n.layerJSON,l);return l}async function F(e,t,a){var r,o;e||(e={}),(r=e).layers||(r.layers=[]),(o=e).tables||(o.tables=[]);const{url:l,customParameters:n,apiKey:s}=t,{serviceJSON:u,layersJSON:d}=await i.fetchFeatureService(l,{customParameters:n,apiKey:s}),y=L(e.layers,u.layers,a),c=L(e.tables,u.tables,a);e.layers=y.itemResources,e.tables=c.itemResources;const p=[...y.added,...c.added],f=d?[...d.layers,...d.tables]:[];return await P(e,p,l,f),e}function L(e,a,r){const o=t.difference(e,a,((e,t)=>e.id===t.id));e=e.filter((e=>!o.removed.some((t=>t.id===e.id))));const l=o.added.map((({id:e})=>({id:e})));return l.forEach((({id:t})=>{e.push({id:t})})),{itemResources:e,added:l.filter((({id:e})=>!r.includes(e)))}}async function P(e,t,a,r){const l=t.map((({id:e})=>new n({url:a,layerId:e,sourceJSON:r.find((({id:t})=>t===e))})));await o.eachAlways(l.map((e=>e.load()))),l.forEach((t=>{const{layerId:a,loaded:r,defaultPopupTemplate:o}=t;if(!r||null==o)return;A(t,{id:a,popupInfo:o.toJSON()},e)}))}function A(e,t,a){e.isTable?E(a.tables,t):E(a.layers,t)}function E(e,t){if(!e)return;const a=e.findIndex((({id:e})=>e===t.id));-1===a?e.push(t):e[a]=t}function J(e){const{portalItem:t}=e;return u.isFeatureServiceLayer(e)&&!e.dynamicDataSource&&!!t?.loaded&&t.type===m}async function N(e){if(!e?.length)throw new a("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");await Promise.all(e.map((e=>e.load())));for(const o of e)if(!J(o))throw new a("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${w(o,"does not conform")}`,{layer:o});const t=e.map((e=>e.portalItem.id));if(new Set(t).size>1)throw new a("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");const r=e.map((e=>e.layerId));if(new Set(r).size!==r.length)throw new a("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service")}function x(e,t){var a,r;let o=y.from(t);return o.id&&(o=o.clone(),o.id=null),(a=o).type??(a.type=m),(r=o).portal??(r.portal=d.getDefault()),v(e,o),o}async function $(e,t){const{url:a,layerId:r,title:o,fullExtent:l,isTable:n}=e,i=s.parse(a),u=null!=i&&"FeatureServer"===i.serverType;t.url=u?a:`${a}/${r}`,t.title||(t.title=o),t.extent=null,n||null==l||(t.extent=await p.getWGS84ExtentForItem(l)),p.removeTypeKeyword(t,p.TypeKeyword.METADATA),p.removeTypeKeyword(t,p.TypeKeyword.MULTI_LAYER),p.addTypeKeyword(t,p.TypeKeyword.SINGLE_LAYER),n&&p.addTypeKeyword(t,p.TypeKeyword.TABLE),g(t)}async function U(e,t,a){const r=e.portal;await(r?.signIn()),await(r?.user?.addItem({item:e,data:t,folder:a?.folder}))}const R=o.debounce(D);async function D(e,t){await h(e),T(e);const a=e.portalItem,r=c.createForItemWrite(a),o=await S(e,r,t),n=await K(a,[{layer:e,layerJSON:o}]);return g(a),await a.update({data:n}),l.updateOrigins(r),a}const W=async(e,t)=>{await N(e);const a=e[0].portalItem,r=c.createForItemWrite(a),o=await Promise.all(e.map((e=>S(e,r,t)))),n=await K(a,e.map(((e,t)=>({layer:e,layerJSON:o[t]}))));return g(a),await a.update({data:n}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),l.updateOrigins(r),a.clone()},j=o.debounce(W),C=o.debounce(M);async function M(e,t,a){await h(e);const r=x(e,t),o=c.createForItemWrite(r),n=I({layer:e,layerJSON:await S(e,o,a)});return await $(e,r),await U(r,n,a),e.portalItem=r,l.updateOrigins(o),r}e.save=R,e.saveAll=j,e.saveAs=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
