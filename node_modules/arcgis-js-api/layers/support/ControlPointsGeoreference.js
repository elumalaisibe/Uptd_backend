/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../core/Accessor","../../core/Error","../../core/JSONSupport","../../core/Logger","../../core/perspectiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../chunks/mat3","../../chunks/mat3f64","../../chunks/vec2","../../chunks/vec2f64","../../geometry/Point","../../geometry/Polygon","../../geometry/projection","../../geometry/SpatialReference","./GeoreferenceBase"],(function(t,e,o,r,n,i,s,c,l,a,u,p,f,P,h,m,y,d,g,_,v,w,j,R){"use strict";const S=y.create(),x=g.create();let C=function(e){function o(){var t;return(t=e.apply(this,arguments)||this).sourcePoint=null,t.mapPoint=null,t}return t._inherits(o,e),t._createClass(o)}(o);e.__decorate([l.property()],C.prototype,"sourcePoint",void 0),e.__decorate([l.property({type:_})],C.prototype,"mapPoint",void 0),C=e.__decorate([P.subclass("esri.layers.support.ControlPoint")],C);let k=function(e){function o(t){var o;return(o=e.call(this,t)||this).controlPoints=null,o.height=0,o.type="control-points",o.width=0,o}t._inherits(o,e);var n=o.prototype;return n.readControlPoints=function(t,e){const o=j.fromJSON(e.spatialReference),r=y.fromValues(...e.coefficients,1);return t.map((t=>(d.set(x,t.x,t.y),s.transformProjective(x,x,r),{sourcePoint:t,mapPoint:new _({x:x[0],y:x[1],spatialReference:o})})))},n.writeControlPoints=function(t,e,o,n){if(null!=this.transform)null!=t&&O(t[0])&&(e.controlPoints=t.map((t=>{const e=t.sourcePoint;return{x:e.x,y:e.y}})),e.spatialReference=t[0].mapPoint.spatialReference.toJSON(),e.coefficients=this.transform.slice(0,8));else{const t=new r("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:n?.layer,georeference:this});n?.messages?n.messages.push(t):i.getLogger(this).error(t.name,t.message)}},n.toMap=function(t){if(null==t||null==this.transform||null==this.controlPoints||!O(this.controlPoints[0]))return null;d.set(x,t.x,t.y);const e=this.controlPoints[0].mapPoint.spatialReference;return s.transformProjective(x,x,this.transform),new _({x:x[0],y:x[1],spatialReference:e})},n.toSource=function(t){if(null==t||null==this.inverseTransform||null==this.controlPoints||!O(this.controlPoints[0]))return null;const e=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),null==(t=w.projectOrLoad(t,e).geometry)?null:(d.set(x,t.x,t.y),s.transformProjective(x,x,this.inverseTransform),c.createScreenPoint(x[0],x[1]))},n._updateTransform=function(t){const{controlPoints:e,width:o,height:r}=this;if(!(null!=e&&o>0&&r>0))return null;const[n,i,s,c]=e;if(!O(n))return null;const l=n.mapPoint.spatialReference,a=this._projectControlPoint(i,l),u=this._projectControlPoint(s,l),p=this._projectControlPoint(c,l);if(!a.valid||!u.valid||!p.valid)return null;if(!O(a.controlPoint))return null;null==t&&(t=y.create());let f=null;return f=O(u.controlPoint)&&O(p.controlPoint)?q(t,n,a.controlPoint,u.controlPoint,p.controlPoint):O(u.controlPoint)?G(t,n,a.controlPoint,u.controlPoint):B(t,n,a.controlPoint),f.every((t=>0===t))?null:f},n._projectControlPoint=function(t,e){if(!O(t))return{valid:!0,controlPoint:t};const{sourcePoint:o,mapPoint:r}=t,{geometry:n,pending:s}=w.projectOrLoad(r,e);return s?{valid:!1,controlPoint:null}:s||n?{valid:!0,controlPoint:{sourcePoint:o,mapPoint:n}}:(i.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:r.spatialReference,targetSpatialReference:e}),{valid:!1,controlPoint:null})},t._createClass(o,[{key:"coords",get:function(){if(null==this.controlPoints)return null;const t=this._updateTransform(S);if(null==t||!O(this.controlPoints[0]))return null;const e=this.controlPoints[0].mapPoint.spatialReference;return D(t,this.width,this.height,e)},set:function(t){if(null==this.controlPoints||!O(this.controlPoints[0]))return;const e=this.controlPoints[0].mapPoint.spatialReference;if(null==(t=this.projectOrWarn(t,e)))return;const{width:o,height:r}=this,{rings:[[n,i,l,a]]}=t,u={sourcePoint:c.createScreenPoint(0,r),mapPoint:new _({x:n[0],y:n[1],spatialReference:e})},p={sourcePoint:c.createScreenPoint(0,0),mapPoint:new _({x:i[0],y:i[1],spatialReference:e})},f={sourcePoint:c.createScreenPoint(o,0),mapPoint:new _({x:l[0],y:l[1],spatialReference:e})},P={sourcePoint:c.createScreenPoint(o,r),mapPoint:new _({x:a[0],y:a[1],spatialReference:e})};O(u)&&O(p)&&O(f)&&O(P)&&(q(S,u,p,f,P),this.controlPoints=this.controlPoints.map((({sourcePoint:t})=>(d.set(x,t.x,t.y),s.transformProjective(x,x,S),{sourcePoint:t,mapPoint:new _({x:x[0],y:x[1],spatialReference:e})}))))}},{key:"inverseTransform",get:function(){return null==this.transform?null:m.invert(y.create(),this.transform)}},{key:"transform",get:function(){return this._updateTransform()}}]),o}(n.JSONSupportMixin(R));function O(t){return null!=t&&null!=t.sourcePoint&&null!=t.mapPoint}e.__decorate([l.property({type:[C],json:{write:{allowNull:!1,isRequired:!0}}})],k.prototype,"controlPoints",void 0),e.__decorate([f.reader("controlPoints")],k.prototype,"readControlPoints",null),e.__decorate([h.writer("controlPoints")],k.prototype,"writeControlPoints",null),e.__decorate([l.property()],k.prototype,"coords",null),e.__decorate([l.property({json:{write:!0}})],k.prototype,"height",void 0),e.__decorate([l.property({readOnly:!0})],k.prototype,"inverseTransform",null),e.__decorate([l.property({readOnly:!0})],k.prototype,"transform",null),e.__decorate([l.property({json:{write:!0}})],k.prototype,"width",void 0),k=e.__decorate([P.subclass("esri.layers.support.ControlPointsGeoreference")],k);const T=g.create(),b=g.create(),L=g.create(),M=g.create(),N=g.create(),V=g.create(),I=g.create(),J=g.create(),A=Math.PI/2;function U(t,e,o){d.set(t,o.sourcePoint.x,o.sourcePoint.y),d.set(e,o.mapPoint.x,o.mapPoint.y)}function B(t,e,o){return U(T,N,e),U(b,V,o),d.rotate(L,b,T,A),d.rotate(M,T,b,A),d.rotate(I,V,N,-A),d.rotate(J,N,V,-A),W(t,T,b,L,M,N,V,I,J)}function G(t,e,o,r){return U(T,N,e),U(b,V,o),U(L,I,r),d.lerp(M,T,b,.5),d.rotate(M,L,M,Math.PI),d.lerp(J,N,V,.5),d.rotate(J,I,J,Math.PI),W(t,T,b,L,M,N,V,I,J)}function q(t,e,o,r,n){return U(T,N,e),U(b,V,o),U(L,I,r),U(M,J,n),W(t,T,b,L,M,N,V,I,J)}const z=new Array(8).fill(0),E=new Array(8).fill(0);function H(t,e,o,r,n){return t[0]=e[0],t[1]=e[1],t[2]=o[0],t[3]=o[1],t[4]=r[0],t[5]=r[1],t[6]=n[0],t[7]=n[1],t}function W(t,e,o,r,n,i,c,l,a){return s.getProjectiveTransform(t,H(z,e,o,r,n),H(E,i,c,l,a))}function D(t,e,o,r){const n=g.fromValues(0,o),i=g.fromValues(0,0),c=g.fromValues(e,0),l=g.fromValues(e,o);return s.transformProjective(n,n,t),s.transformProjective(i,i,t),s.transformProjective(c,c,t),s.transformProjective(l,l,t),new v({rings:[[n,i,c,l,n]],spatialReference:r})}return k}));
