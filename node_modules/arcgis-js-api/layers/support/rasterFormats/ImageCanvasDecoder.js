/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/Error","../../../core/promiseUtils","../../../chunks/Zlib"],(function(t,e,n,a){"use strict";return function(){function i(t){this._canvas=null,this._ctx=null,t&&(this._canvas=t.canvas,this._ctx=t.ctx||t.canvas&&t.canvas.getContext("2d"))}return i.prototype.decode=function(t,a,r){if(!t||t.byteLength<10)throw new e("imagecanvasdecoder: decode","required a valid encoded data as input.");let{width:s=0,height:c=0,format:h}=a;const{applyJpegMask:o}=a;if(o&&(!s||!c))throw new e("imagecanvasdecoder: decode","image width and height are needed to apply jpeg mask directly to canvas");return new Promise(((e,l)=>{let d=null;"jpg"===h&&o&&(d=i._getMask(t,{width:s,height:c}));const g=new Blob([new Uint8Array(t)],{type:"image/"+h=="jpg"?"jpeg":h}),u=URL.createObjectURL(g),w=new Image;let v;w.src=u,w.onload=()=>{if(URL.revokeObjectURL(u),n.isAborted(r))return void l(n.createAbortError());s=w.width,c=w.height,this._canvas&&this._ctx?(this._canvas.width===s&&this._canvas.height===c||(this._canvas.width=s,this._canvas.height=c),this._ctx.clearRect(0,0,s,c)):(this._canvas=document.createElement("canvas"),this._canvas.width=s,this._canvas.height=c,this._ctx=this._canvas.getContext("2d")),this._ctx.drawImage(w,0,0);const t=this._ctx.getImageData(0,0,s,c);let i;if(v=t.data,a.renderOnCanvas){if(d)for(i=0;i<d.length;i++)d[i]?v[4*i+3]=255:v[4*i+3]=0;return this._ctx.putImageData(t,0,0),void e(null)}const h=s*c,o=new Uint8Array(h),g=new Uint8Array(h),_=new Uint8Array(h);if(d)for(i=0;i<h;i++)o[i]=v[4*i],g[i]=v[4*i+1],_[i]=v[4*i+2];else for(d=new Uint8Array(h),i=0;i<h;i++)o[i]=v[4*i],g[i]=v[4*i+1],_[i]=v[4*i+2],d[i]=v[4*i+3];e({width:s,height:c,pixels:[o,g,_],mask:d,pixelType:"u8"})},w.onerror=()=>{URL.revokeObjectURL(u),l("cannot load image")}}))},i._getMask=function(t,e){let n=null;try{const i=new Uint8Array(t),r=Math.ceil(i.length/2);let s=0;const c=i.length-2;for(s=r;s<c&&(255!==i[s]||217!==i[s+1]);s++);if(s+=2,s<i.length-1){const t=new a.Zlib(i.subarray(s)).getBytes();n=new Uint8Array(e.width*e.height);let r=0;for(let e=0;e<t.length;e++)for(let a=7;a>=0;a--)n[r++]=t[e]>>a&1}}catch(i){}return n},t._createClass(i)}()}));
