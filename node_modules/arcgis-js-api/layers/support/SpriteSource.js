/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../request","../../core/Error","../../core/Logger","../../core/typedArrayUtil","../../core/urlUtils"],(function(t,e,i,s,r,a){"use strict";const o=1.15;function h(t){const e=document.createElement("canvas"),i=e.getContext("2d");e.width=t.width,e.height=t.height,i.drawImage(t,0,0,t.width,t.height);const s=i.getImageData(0,0,t.width,t.height);return{width:t.width,height:t.height,data:new Uint8Array(s.data)}}return function(){function n(t,e){this._spriteSource=t,this._maxTextureSize=e,this.devicePixelRatio=1,this._spriteImageFormat="png",this._isRetina=!1,this._spritesData={},this.image=null,this.width=null,this.height=null,this.loadStatus="not-loaded","url"===t.type&&t.spriteFormat&&(this._spriteImageFormat=t.spriteFormat),t.pixelRatio&&(this.devicePixelRatio=t.pixelRatio),this.baseURL=t.spriteUrl}var l=n.prototype;return l.getSpriteInfo=function(t){return this._spritesData?this._spritesData[t]:null},l.load=async function(t){if(this.baseURL){this.loadStatus="loading";try{await this._loadSprites(t),this.loadStatus="loaded"}catch{this.loadStatus="failed"}}else this.loadStatus="failed"},l._loadSprites=async function(t){this._isRetina=this.devicePixelRatio>o;const{width:e,height:r,data:a,json:h}=await this._getSpriteData(this._spriteSource,t),n=Object.keys(h);if(!n||0===n.length||!a)return this._spritesData=this.image=null,void(this.width=this.height=0);this._spritesData=h,this.width=e,this.height=r;const l=Math.max(this._maxTextureSize,4096);if(e>l||r>l){const t=`Sprite resource for style ${this.baseURL} is bigger than the maximum allowed of ${l} pixels}`;throw s.getLogger("esri.layers.support.SpriteSource").error(t),new i("SpriteSource",t)}let u;for(let i=0;i<a.length;i+=4)u=a[i+3]/255,a[i]=a[i]*u,a[i+1]=a[i+1]*u,a[i+2]=a[i+2]*u;this.image=a},l._getSpriteData=async function(t,s){if("image"===t.type){let e,s;if(this.devicePixelRatio<o){if(!t.spriteSource1x)throw new i("SpriteSource","no image data provided for low resolution sprites!");e=t.spriteSource1x.image,s=t.spriteSource1x.json}else{if(!t.spriteSource2x)throw new i("SpriteSource","no image data provided for high resolution sprites!");e=t.spriteSource2x.image,s=t.spriteSource2x.json}return"width"in e&&"height"in e&&"data"in e&&(r.isArrayBuffer(e.data)||r.isUint8ClampedArray(e.data))?{width:e.width,height:e.height,data:new Uint8Array(e.data),json:s}:{...h(e),json:s}}const n=a.urlToObject(this.baseURL),l=n.query?"?"+a.objectToQuery(n.query):"",u=this._isRetina?"@2x":"",d=`${n.path}${u}.${this._spriteImageFormat}${l}`,p=`${n.path}${u}.json${l}`,[c,g]=await Promise.all([e(p,s),e(d,{responseType:"image",...s})]);return{...h(g.data),json:c.data}},t._createClass(n,[{key:"spriteNames",get:function(){const t=[];for(const e in this._spritesData)t.push(e);return t.sort(),t}}]),n}()}));
