/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../request","../../core/promiseUtils","../../core/urlUtils","../../views/2d/engine/vectorTiles/style/VectorTileSource"],(function(e,r,t,o,s){"use strict";async function l(e,r){const t={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[o,s]="string"==typeof e?[e,null]:[null,e.jsonUrl];await n(t,"esri",e,s,r);return{layerDefinition:t.validatedSource,url:o,serviceUrl:t.sourceUrl,style:t.style,styleUrl:t.styleUrl,spriteUrl:t.style.sprite&&i(t.styleBase,t.style.sprite),spriteFormat:t.spriteFormat,glyphsUrl:t.style.glyphs&&i(t.styleBase,t.style.glyphs),sourceNameToSource:t.sourceNameToSource,primarySourceName:t.primarySourceName}}function i(...e){let r;for(const t of e)if(null!=t)if(o.isProtocolRelative(t)){if(r){const e=r.split("://")[0];r=e+":"+t.trim()}}else r=o.isAbsolute(t)?t:o.join(r,t);return r?o.removeTrailingSlash(r):void 0}async function n(e,s,l,i,n){let y,p,m;if(t.throwIfAborted(n),"string"==typeof l){const e=o.normalize(l);m=await r(e,{...n,responseType:"json",query:{f:"json",...n?.query}}),m.ssl&&(y&&(y=y.replace(/^http:/i,"https:")),p&&(p=p.replace(/^http:/i,"https:"))),y=e,p=e}else null!=l&&(m={data:l},y=l.jsonUrl||null,p=i);const d=m?.data;if(u(d))return e.styleUrl=y||null,c(e,d,p,n);if(a(d))return e.sourceUrl?f(e,d,p,!1,s,n):(e.sourceUrl=y||null,f(e,d,p,!0,s,n));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function u(e){return!!e&&"sources"in e&&!!e.sources}function a(e){return!u(e)}async function c(e,r,t,s){const l=t?o.removeFile(t):o.getAppBaseUrl();e.styleBase=l,e.style=r,r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const u=[];if(r.sources&&r.sources.esri){const t=r.sources.esri;t.url?await n(e,"esri",i(l,t.url),void 0,s):u.push(n(e,"esri",t,l,s))}for(const o of Object.keys(r.sources))"esri"!==o&&"vector"===r.sources[o].type&&(r.sources[o].url?u.push(n(e,o,i(l,r.sources[o].url),void 0,s)):r.sources[o].tiles&&u.push(n(e,o,r.sources[o],l,s)));await Promise.all(u)}async function f(e,r,t,l,u,a){const c=t?o.removeTrailingSlash(t)+"/":o.getAppBaseUrl(),f=y(r),p=new s(u,o.addQueryParameters(c,a?.query??{}),f);if(!l&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(p))return;null!=p.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(p.fullExtent):r.fullExtent=p.fullExtent.clone()),r.tileInfo&&p.tileInfo&&r.tileInfo.lods.length<p.tileInfo.lods.length&&(r.tileInfo=p.tileInfo)}if(l&&(e.sourceBase=c,e.source=r,e.validatedSource=f,e.primarySourceName=u),e.sourceNameToSource[u]=p,!e.style){if(null==r.defaultStyles)throw new Error;return"string"==typeof r.defaultStyles?n(e,"",i(c,r.defaultStyles,"root.json"),void 0,a):n(e,"",r.defaultStyles,i(c,"root.json"),a)}}function y(e){if(e.hasOwnProperty("tileInfo"))return e;const r={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},t=512;let o=78271.51696400007,s=295828763.7957775;const l=[],i=e.hasOwnProperty("minzoom")?+e.minzoom:0,n=e.hasOwnProperty("maxzoom")?+e.maxzoom:22;for(let u=0;u<=n;u++)u>=i&&l.push({level:u,scale:s,resolution:o}),o/=2,s/=2;return{capabilities:"TilesOnly",initialExtent:r,fullExtent:r,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:t,cols:t,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:l,spatialReference:{wkid:102100}}}}e.loadMetadata=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
