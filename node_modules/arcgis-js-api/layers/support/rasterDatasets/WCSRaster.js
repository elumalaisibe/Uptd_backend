/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../ogc/crsUtils","../DimensionalDefinition","./BaseRaster","./multipartParser","./wcsCapabilitiesParser","./wcsCoverageParser","../rasterFormats/RasterCodec","../rasterFunctions/pixelUtils","../../../geometry/Extent"],(function(e,t,i,n,s,r,o,a,l,c,d,p,u,h,f,g,m,v,w,y){"use strict";const x=["nearest neighbor","bilinear","bicubic"],b=["nearest","linear","cubic"],C="response is not a supported multipart/related mediaType with inline tiff,  switching to compability mode",I="response is not a supported multipart mediaType with inline tiff",$="response is base64 encoded which may impact layer display performance",S="server returns an exception";let T=function(t){function i(){var e;return(e=t.apply(this,arguments)||this).datasetFormat="WCSServer",e}e._inherits(i,t);var o=i.prototype;return o.open=async function(e){await this.init();const t=e?.signal,i=await this._getCapabilities(t);if(this.capabilities=i,!this.version){let e=i.capabilitiesVersion?.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=i.capabilitiesVersion:(e=i.supportedVersions.find((e=>"2.0.1"===e))||i.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}const s=i.coverages.filter((e=>null==e.coverageSubType||""===e.coverageSubType||e.coverageSubType?.toLowerCase().startsWith("rectifiedgrid")));null==this.coverageId&&(this.coverageId=s[0].id);const r=s.find((e=>e.id===this.coverageId));if(null==r)throw new n("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const o=await this._describeCoverage(t);this.coverageInfo=o[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=r.lonLatEnvelope,this.coverageInfo.supportedInterpolations=m.standardizeInterpolations(i.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:a}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(a,512,512),this._set("rasterInfo",a),null==a.spatialReference)throw new n("wcsraster-open",`coverage without spatial referernce is not supported: ${this.coverageId}`);const{pixelType:l,bandCount:c}=await this._getPixelTypeAndBandCount(t);a.pixelType=l,1===a.bandCount&&c>1&&(a.bandCount=c),this.updateTileInfo()},o.fetchRawTile=async function(e,t,i,s={}){if(this.isBlockOutside(e,t,i))return null;const{nativePixelSize:r,spatialReference:o}=this.rasterInfo,a=2**e,l=r.x*a,c=r.y*a,{blockWidth:d,blockHeight:p}=this.getBlockWidthHeight(e),{origin:u}=this.rasterInfo.storageInfo.tileInfo,h=this.getTileExtent({x:l,y:c},t,i,u,o,[d,p]),f=this.rasterInfo.extent,g=h.xmax>f.xmax,m=h.ymin<f.ymin,v=g||m;let y=h,x=d,b=p;if(v&&(y=h.clone().intersection(f),null!=y&&(g&&(x=Math.floor((y.xmax-y.xmin)/l),y.xmax=y.xmin+l*x),m&&(b=Math.floor((y.ymax-y.ymin)/c),y.ymin=y.ymax-c*b))),null==y||x<=1||b<=1)return null;const C=await this._getCoverage(y,x,b,a,s);if(!C)return null;const{coverageDescription:I}=this.coverageInfo;let{noDataValue:$,multidimensionalInfo:S}=this.rasterInfo;const{multidimensionalDefinition:T}=s;if(null!=S&&null!=T&&T.length){const e=T[0].variableName;if("2.0"===I.version){const t=I.rangeType[0].find((t=>t.name===e));$=t?.nilValue}else if("1.1"===I.version){const t=I.range.find((t=>t.identifier===e));$=t?.nullValues}}const _=await this.decodePixelBlock(C,{width:x,height:b,planes:null,pixelType:null,noDataValue:Array.isArray($)?$[0]:$});if(null==_)return null;if(_&&(_.width!==x||_.height!==b))throw new n("wcsraster-fetch",`the reponse has unexpected dimension width: ${_.width}, height: {pixelBlock.height}`);return v?w.clip(_,{x:0,y:0},{width:p,height:p}):_},o._getCapabilities=async function(e){const t={service:"WCS",request:"GetCapabilities"};this.version&&(t.version=this.version,t.acceptVersions=this.version);try{const{data:i}=await this.request(this.url,{query:t,responseType:"xml",signal:e});return g.parseCapabilities(i)}catch(i){if(!r.isAbortError(i))throw new n("wcslayer:open","wcs capabilities is not valid or supported");throw i}},o._describeCoverage=async function(e){const t={service:"WCS",request:"DescribeCoverage",version:this.version},i=this.version?.slice(0,3);"1.0"===i?t.coverage=this.coverageId:"1.1"===i?t.identifiers=this.coverageId:"2.0"===i&&(t.coverageId=this.coverageId);try{const{data:i}=await this.request(this.url,{query:t,responseType:"xml",signal:e});return m.parseCoverages(i,this.version)}catch(s){if(!r.isAbortError(s))throw new n("wcslayer:open","wcs coverage description is not valid or supported");throw s}},o._getPixelTypeAndBandCount=async function(e){const{pixelSize:t,extent:i,multidimensionalInfo:r}=this.rasterInfo,o=i.center,a=new y({xmin:o.x-t.x,xmax:o.x+t.x,ymin:o.y-t.y,ymax:o.y+t.y,spatialReference:i.spatialReference});let l=[];if(null!=r){const e=r.variables[0];l=[],e.dimensions.forEach((t=>{l.push(new u({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values?.[0],isSlice:!0}))}))}const{coverageDescription:c}=this.coverageInfo,d={interpolation:"nearest",multidimensionalDefinition:l,signal:e},{version:p}=c,{ioConfig:h}=this,f="2.0"===p&&null==h.allowAnyMediaType||"1.1"===p&&null==h.use2GridOffsets;let g;try{g=await this._getCoverage(a,2,2,1,d,!0)}catch(v){if(!f)throw v;if("1.1"===p){if(!v.details?.isResolutionMismatch)throw v;h.use2GridOffsets=!0}}if(!g&&f&&("2.0"===p&&(h.allowAnyMediaType=!0),g=await this._getCoverage(a,2,2,1,d),g&&s.getLogger(this).warn("wcsraster:getcoverage",C)),!g)throw new n("wcsraster-open","unable to determine pixel type");const m=await this.decodePixelBlock(g,{width:2,height:2,planes:null,pixelType:null});if(null==m)throw new n("wcsraster-open","unable to determine pixel type");return{pixelType:m.pixelType,bandCount:m.getPlaneCount()??0}},o._getCoverage=async function(e,t,i,r,o,a=!1){const{coverageDescription:l}=this.coverageInfo,{version:c}=l,d="2.0"===c?this._getCoverage201Parameters(e,t,i,r,o,l):"1.1"===c?this._getCoverage110Parameters(e,t,i,o,l):this._getCoverage100Parameters(e,t,i,o),p="2.0"===c?await this.request(this._constructWCS201Url(d),{signal:o.signal,responseType:"array-buffer"}):await this.request(this.url,{query:d,signal:o.signal,responseType:"array-buffer"});if("1.0"===c)return p.data;if("2.0"===c&&!1!==this.ioConfig.allowAnyMediaType){if("tiff"===v.getFormat(p.data))return a&&(this.ioConfig.allowAnyMediaType=!0,s.getLogger(this).warn("wcsraster:getcoverage",C)),p.data}const u=f.parse(p);if(u.isMultipart&&u.data){const e=u.data.find((e=>e.contentType?.toLowerCase().includes("image")&&null!=e.contentData));return a&&"base64"===e?.contentTransferEncoding&&s.getLogger(this).warn("wcsraster:getcoverage",$),e?.contentData}const h=new Uint8Array(p.data,0,Math.min(p.data.byteLength,2e3)),g=String.fromCharCode.apply(null,h).toLowerCase().includes("exception"),m=g&&String.fromCharCode.apply(null,h).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");if(g)throw new n("wcsraster:getcoverage",S,{isResolutionMismatch:m});throw new n("wcsraster:getcoverage",I)},o._getInterpolationIndex=function(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0:0},o._getCoverage100Parameters=function(e,t,i,n){const s=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,r=e.spatialReference.wkid,o=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"GEOTIFF",{bandIds:a,interpolation:l}=n,c=this._getInterpolationIndex(l),d=a?a.map((e=>this.coverageInfo.bandNames[e])):null,p=x[c],{multidimensionalDefinition:u}=n;let h;if(null!=u&&null!=this.rasterInfo.multidimensionalInfo){const e=u.find((e=>"StdTime"===e.dimensionName));let t=e?.values;t&&t.length>0&&(t[0]instanceof Array&&(t=t[0]),h=t.map((e=>this._convertToISOTime(e))).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:o,crs:`EPSG:${r}`,bbox:s,width:t,height:i,time:h,interpolation:p,band:d?.join(",")}},o._getCoverage110Parameters=function(e,t,i,n,s){const{multidimensionalDefinition:r,bandIds:o,interpolation:a}=n,l=e.spatialReference.wkid,c=`urn:ogc:def:crs:EPSG::${l}`,d=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",u=this._getInterpolationIndex(a),h=b[u],f=null==a||0===this.coverageInfo.supportedInterpolations?.indexOf(a),g=s.domain.spatialDomain,m=g.origin.x<=g.envelope.xmin&&g.origin.y<=g.envelope.ymin,v=e.width/t,w=e.height/i*(m?1:-1),y=m?[e.xmin,e.ymin]:[e.xmin,e.ymax],x=g.useEPSGAxis&&p.isAxesOrderReversedForWkid(l),C=x?`${y[1]},${y[0]}`:`${y[0]},${y[1]}`,I=this.ioConfig.use2GridOffsets,$=x?I?`${w},${v}`:`${w},0,0,${v}`:I?`${v},${w}`:`${v},0,0,${w}`,S=v/2,T=e.xmin+S,_=e.xmax-S,L=Math.abs(w)/2,E=e.ymin+L,P=e.ymax-L,R=x?`${E},${T},${P},${_},${c}`:`${T},${E},${_},${P},${c}`,A=s.range.find((e=>e.axis.some((e=>e.identifier.toLowerCase().includes("band")))));let D,O=A&&h&&o?f?`${A.identifier}[${A.axis[0].identifier}[${o.join(",")}]]`:`${A.identifier}:${h}[${A.axis[0].identifier}[${o.join(",")}]]`:null;if(null!=r&&r.length)for(let p=0;p<r.length;p++){let e=r[p].values;const t=r[p].dimensionName?.toLowerCase(),i=r[p].variableName?.toLowerCase();if(e.length>0)if(e[0]instanceof Array&&(e=e[0]),"stdtime"===t)D=e.map((e=>this._convertToISOTime(e))).join(",");else{const n=s.range.find((e=>e.identifier.toLowerCase()===i));if(n){const i=n.axis.find((e=>e.identifier.toLowerCase()===t));i&&(O=f?n.identifier+"["+i.identifier+"["+e.join(",")+"]]":n.identifier+":"+h+"["+i.identifier+"["+e.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:d,crs:`EPSG:${l}`,boundingbox:R,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:C,gridOffsets:$,gridBaseCRS:c,timeSequence:D,rangeSubset:O}},o._convertToISOTime=function(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()},o._getCoverage201Parameters=function(e,t,i,n,s,r){const{multidimensionalDefinition:o,interpolation:a}=s,l=this._getInterpolationIndex(a);let c=null;const{supportedInterpolations:d}=this.capabilities;if(d?.length)switch(l){case 0:c=d.find((e=>e.toLowerCase().includes("nearest")));break;case 1:c=d.find((e=>e.toLowerCase().includes("linear")));break;case 2:c=d.find((e=>e.toLowerCase().includes("cubic")||e.toLowerCase().includes("quadratic")))}const p=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",{bandNames:u}=this.coverageInfo,{boundedBy:h,domainSet:f,rangeType:g}=r,m=h.isEastFirst?0:1,v=1-m,{axisLabels:w}=h,y=w[m],x=w[v],b=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,C=b,I=[];I.push(`${y}(${e.xmin},${e.xmax})`),I.push(`${x}(${e.ymin},${e.ymax})`);const $=[];if(w.length>2)for(let P=2;P<w.length;P++){const e=f.origin[P];if(w[P].toLowerCase().includes("time")){let t=e.toString();h.uomLabels?.[P].toLowerCase().includes("ole")&&($.push(w[P]),t=this._convertToISOTime(e,!0)),I.push(w[P]+",http://www.opengis.net("+t+")")}else I.push(w[P]+",http://www.opengis.net("+e+")")}let S=null;if(null!=o&&o.length){const e=[];g.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let i=0;i<o.length;i++){const n=w.find((e=>e===o[i].dimensionName)),s=e.find((e=>e===o[i].variableName));if(t.includes(s)||t.push(s),n){let e=o[i].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=n.toLowerCase().includes("time")?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const i=I.findIndex((e=>0===e.indexOf(n+",http://www.opengis.net")));-1===i&&I.push(n+",http://www.opengis.net("+t+")"),-1===i||I[i].includes("("+t+")")||I.splice(i,1,n+",http://www.opengis.net("+t+")")}}}t.length&&(S=t.join(","))}else if(u?.length>=2){S=(s.bandIds?s.bandIds.map((e=>u[e])):u).join(",")}const T=I.join("&subset="),_=!r.domainSet.hasSameAxisLabelsAsBoundedBy&&!1!==this.ioConfig.allowScaleFactor,L=_?null:`${y}(${t}),${x}(${i})`,E=_?1/n:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:S,interpolation:c,scaleSize:L,scaleFactor:E,subset:T,format:p,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:b,subsettingcrs:C}},o._constructWCS201Url=function(e){const t={...this.ioConfig.customFetchParameters,...e},i=[];Object.keys(t).forEach((e=>{const n=t[e];null!=n&&("subset"===e?"string"==typeof n&&n.split("&subset=").forEach((e=>{e&&i.push(`subset=${encodeURIComponent(e)}`)})):i.push(`${e}=${encodeURIComponent(n)}`))}));return`${encodeURI(this.url)}?${i.join("&")}`},e._createClass(i)}(h);t.__decorate([o.property({type:String,json:{write:!0}})],T.prototype,"datasetFormat",void 0),t.__decorate([o.property()],T.prototype,"tileType",void 0),t.__decorate([o.property({type:String,json:{write:!0}})],T.prototype,"version",void 0),t.__decorate([o.property({type:String,json:{write:!0}})],T.prototype,"coverageId",void 0),T=t.__decorate([d.subclass("esri.layers.support.rasterDatasets.WCSRaster")],T);return T}));
