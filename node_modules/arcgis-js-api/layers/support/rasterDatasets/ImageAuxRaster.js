/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/has","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/accessorSupport/decorators/subclass","./BaseRaster","./InMemoryRaster","./pamParser","../rasterFormats/RasterCodec","../rasterFunctions/stretchUtils","../rasterTransforms/PolynomialTransform","../../../geometry/SpatialReference","../../../geometry/Extent"],(function(t,e,s,a,r,o,i,n,l,c,u,p,f,h,m,d,y,w){"use strict";let g=function(e){function s(){return e.apply(this,arguments)||this}t._inherits(s,e);var i=s.prototype;return i.open=async function(t){await this.init();const e=await this._fetchData(t);let{spatialReference:s,statistics:a,histograms:r,transform:o}=await this._fetchAuxiliaryData(t);const i=!s;i&&(s=new y({wkid:3857})),r?.length&&null==a&&(a=m.estimateStatisticsFromHistograms(r));const{width:n,height:l}=e;let c=new w({xmin:-.5,ymin:.5-l,xmax:n-.5,ymax:.5,spatialReference:s});const u=o?o.forwardTransform(c):c;let f=!0;if(o){const t=o.forwardCoefficients;f=t&&0===t[1]&&0===t[2],f&&(o=null,c=u)}const h=new p({data:{extent:u,nativeExtent:c,transform:o,pixelBlock:e,statistics:a,histograms:r,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:i}});await h.open(),h.data=null,this._set("rasterInfo",h.rasterInfo),this._inMemoryRaster=h},i.fetchRawTile=function(t,e,s,a={}){return this._inMemoryRaster.fetchRawTile(t,e,s,a)},i._fetchData=async function(t){const{data:e}=await this.request(this.url,{responseType:"array-buffer",signal:t?.signal}),s=h.getFormat(e).toUpperCase();if("JPG"!==s&&"PNG"!==s&&"GIF"!==s&&"BMP"!==s)throw new a("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",s);const o=s.toLowerCase(),i="gif"===o||"bmp"===o||!r("ios"),n=await this.decodePixelBlock(e,{format:o,useCanvas:i,hasNoZlibMask:!0});if(null==n)throw new a("image-aux-raster:open","the data cannot be decoded");return n},i._fetchAuxiliaryData=async function(t){const e=t?.signal,s=this.ioConfig.skipExtensions??[],a=s.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:e}),r=this.datasetFormat,i="JPG"===r?"jgw":"PNG"===r?"pgw":"BMP"===r?"bpw":null,n=i&&s.includes(i)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+i,{responseType:"text",signal:e}),l=await o.eachAlways([a,n]);if(e?.aborted)throw o.createAbortError();const c=f.parsePAMInfo(l[0].value?.data);if(!c.transform){const t=l[1].value?l[1].value.data.split("\n").slice(0,6).map((t=>Number(t))):null;c.transform=6===t?.length?new d({forwardCoefficients:[t[4],t[5],t[0],-t[1],t[2],-t[3]]}):null}return c},t._createClass(s)}(u);e.__decorate([i.property({type:String,json:{write:!0}})],g.prototype,"datasetFormat",void 0),g=e.__decorate([c.subclass("esri.layers.support.rasterDatasets.ImageAuxRaster")],g);return g}));
