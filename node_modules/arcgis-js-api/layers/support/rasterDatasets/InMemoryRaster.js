/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","../../../chunks/tslib.es6","../../../geometry","../../../core/Error","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/arrayUtils","../../../core/has","../../../core/accessorSupport/decorators/subclass","../RasterInfo","./BaseRaster","../rasterFunctions/pixelUtils","../rasterFunctions/stretchUtils","../../../geometry/Extent","../../../geometry/SpatialReference"],(function(e,t,s,r,i,a,o,n,l,c,p,h,m,u,d,y){"use strict";let f=function(t){function s(){var e;return(e=t.apply(this,arguments)||this).datasetFormat="MEMORY",e.data=null,e}e._inherits(s,t);var a=s.prototype;return a.open=async function(e){await this.init();const t=this.data,{pixelBlock:s,statistics:r,histograms:i,name:a,keyProperties:o,nativeExtent:n,transform:l}=this.data,{width:c,height:h,pixelType:m}=s,u=t.extent??new d({xmin:-.5,ymin:.5,xmax:c-.5,ymax:h-.5,spatialReference:new y({wkid:3857})}),f=t.isPseudoSpatialReference??!t.extent,x={x:u.width/c,y:u.height/h},g=new p({width:c,height:h,pixelType:m,extent:u,nativeExtent:n,transform:l,pixelSize:x,spatialReference:u.spatialReference,bandCount:s.pixels.length,keyProperties:o||{},statistics:r,isPseudoSpatialReference:f,histograms:i});this.createRemoteDatasetStorageInfo(g,512,512),this._set("rasterInfo",g),this.updateTileInfo(),await this._buildInMemoryRaster(s,{width:512,height:512},e),this.datasetName=a,this.url="/InMemory/"+a},a.fetchRawTile=function(e,t,s,r={}){const i=this._pixelBlockTiles.get(`${e}/${t}/${s}`);return Promise.resolve(i)},a._buildInMemoryRaster=async function(e,t,s){const a=this.rasterInfo.storageInfo.maximumPyramidLevel,o=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:a},s):Promise.resolve(m.split(e,t,a)),n=null!=this.rasterInfo.statistics,l=null!=this.rasterInfo.histograms,c=n?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},s):Promise.resolve(u.estimateStatisticsHistograms(e)),p=await i.eachAlways([o,c]);if(!p[0].value&&p[1].value)throw new r("inmemory-raster:open","failed to build in memory raster");this._pixelBlockTiles=p[0].value,n||(this.rasterInfo.statistics=p[1].value?.statistics),l||(this.rasterInfo.histograms=p[1].value?.histograms)},e._createClass(s)}(h);t.__decorate([a.property({type:String,json:{write:!0}})],f.prototype,"datasetFormat",void 0),t.__decorate([a.property()],f.prototype,"data",void 0),f=t.__decorate([c.subclass("esri.layers.support.rasterDatasets.InMemoryRaster")],f);return f}));
