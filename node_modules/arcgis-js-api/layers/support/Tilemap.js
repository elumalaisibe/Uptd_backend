/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../chunks/_rollupPluginBabelHelpers","../../request","../../core/arrayUtils","../../core/Error","../../core/lang","../../core/typedArrayUtil","../../geometry/support/UintArray"],(function(t,i,e,a,o,l,n,r){"use strict";let s=function(){function t(t){this._validateJSON(t);const{location:i,data:e}=t;this.location=Object.freeze(l.clone(i));const a=this.location.width,o=this.location.height;let s=!0,h=!0;const c=Math.ceil(a*o/32),f=r.newUintArray(c);let u=0;for(let l=0;l<e.length;l++){const t=l%32;e[l]?(h=!1,f[u]|=1<<t):s=!1,31===t&&++u}h?(this._availability="unavailable",this.byteSize=40):s?(this._availability="available",this.byteSize=40):(this._availability=f,this.byteSize=40+n.estimateSize(f))}var s=t.prototype;return s.getAvailability=function(t,i){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const e=(t-this.location.top)*this.location.width+(i-this.location.left),a=e%32,o=e>>5,l=this._availability;return o<0||o>l.length?"unknown":l[o]&1<<a?"available":"unavailable"},t.fromDefinition=function(i,l){const n=i.service.request||e,{row:r,col:s,width:h,height:f}=i,u={query:{f:"json"}};return l=l?{...u,...l}:u,n(c(i),l).then((t=>t.data)).catch((t=>{if(t&&t.details&&422===t.details.httpStatus)return{location:{top:r,left:s,width:h,height:f},valid:!0,data:a.constant(h*f,0)};throw t})).then((i=>{if(i.location&&(i.location.top!==r||i.location.left!==s||i.location.width!==h||i.location.height!==f))throw new o("tilemap:location-mismatch","Tilemap response for different location than requested",{response:i,definition:{top:r,left:s,width:h,height:f}});return t.fromJSON(i)}))},t.fromJSON=function(i){return Object.freeze(new t(i))},s._validateJSON=function(t){if(!t||!t.location)throw new o("tilemap:missing-location","Location missing from tilemap response");if(!1===t.valid)throw new o("tilemap:invalid","Tilemap response was marked as invalid");if(!t.data)throw new o("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(t.data))throw new o("tilemap:data-mismatch","Data must be an array of numbers");if(t.data.length!==t.location.width*t.location.height)throw new o("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")},i._createClass(t)}();function h(t){return`${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}function c(t){let i;if(t.service.tileServers?.length){const e=t.service.tileServers;i=`${e&&e.length?e[t.row%e.length]:t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}else i=`${t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`;const e=t.service.query;return e&&(i=`${i}?${e}`),i}t.Tilemap=s,t.tilemapDefinitionId=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
