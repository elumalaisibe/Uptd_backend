/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../chunks/_rollupPluginBabelHelpers","../../chunks/tslib.es6","../../geometry","../../PopupTemplate","../../renderers/ClassBreaksRenderer","../../renderers/DictionaryRenderer","../../renderers/DotDensityRenderer","../../renderers/HeatmapRenderer","../../renderers/PieChartRenderer","../../renderers/Renderer","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../renderers/support/jsonUtils","../../renderers/support/types","../../core/workers/workers","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/arrayUtils","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/projection","../../geometry/support/spatialReferenceUtils","../Layer","../graphics/data/FeatureStore","../graphics/data/QueryEngine","../graphics/sources/support/clientSideDefaults","./KnowledgeGraphLayerDataManager","./KnowledgeGraphSublayerBase","../mixins/BlendLayer","../mixins/FeatureReductionLayer","../mixins/RefreshableLayer","../mixins/ScaleRangeLayer","../support/Field","../support/fieldUtils","../../rest/support/FeatureSet","../../rest/support/Query","../../support/popupUtils","../../geometry/Extent","../../geometry/Polygon","../../geometry/Polyline","../../core/workers/RemoteClient","../../geometry/support/typeUtils"],(function(e,r,t,o,a,n,i,p,s,y,l,u,d,c,h,g,m,f,_,b,T,S,w,F,O,E,L,N,M,Q,j,x,v,C,I,D,R,J,G,k,q,K){"use strict";let P=function(r){function t(e){var t;if((t=r.call(this,e)||this).capabilities=E.createCapabilities(!1,!1),t.definitionExpression="",t.displayField="",t.elevationInfo=null,t.geometryType=null,t.geometryFieldName=null,t.graphType=null,t.hasM=!1,t.hasZ=!1,t.labelsVisible=null,t.labelingInfo=null,t.objectIdField=L.MOCK_OID_FIELD_NAME,t.objectType=null,t.parentCompositeLayer=null,t.popupTemplate=null,t.source={openPorts:()=>t.load().then((()=>{const e=new MessageChannel;return new q(e.port1,{channel:e,client:{queryFeatures:(e,r={})=>{const o=D.fromJSON(e);return t.queryFeaturesJSON(o,r)}}},(()=>null)),[e.port2]}))},t.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?t.geometryType="polyline":t.geometryType="point",t.geometryFieldName=L.MOCK_LAYOUT_GEOMETRY_FIELD_NAME;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const r=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);t.geometryFieldName=r?.name??null,t.geometryType=r?.geometryType?K.featureGeometryTypeKebabDictionary.fromJSON(r.geometryType):null;const o=r?.name,a=o?e.objectType.properties?.[o]:null;a?(t.hasM=a.hasM??!1,t.hasZ=a.hasZ??!1):(t.hasM=!1,t.hasZ=!1)}else t.geometryType=null;return e.objectType.properties?.forEach((e=>{let r=null,o=e.fieldType;"esriFieldTypeOID"===o&&(o="esriFieldTypeInteger"),t.fields.push(v.fromJSON({name:e.name,type:o,alias:e.alias,defaultValue:r,editable:e.editable,nullable:e.nullable}))})),t.fields.push(v.fromJSON({name:t.objectIdField,type:"esriFieldTypeString",alias:t.objectIdField,editable:!1})),t._set("fields",[...t.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(t.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?t.renderer=d.fromJSON(E.createDrawingInfo(K.featureGeometryTypeKebabDictionary.toJSON("polyline")).renderer):t.renderer=d.fromJSON(E.createDrawingInfo(K.featureGeometryTypeKebabDictionary.toJSON("point")).renderer):t.renderer=d.fromJSON(E.createDrawingInfo(K.featureGeometryTypeKebabDictionary.toJSON(t.geometryType)).renderer),t}e._inherits(t,r);var o=t.prototype;return o.createPopupTemplate=function(e){return R.createPopupTemplate(this,e)},o.createQuery=function(){return new D({where:"1=1",outFields:["*"]})},o.getField=function(e){for(let r=0;r<this.fields.length;r++)if(this.fields[r].name===e)return this.fields[r];throw new Error("Field not found")},o.getFieldDomain=function(e,r){return null},o.queryFeatures=async function(e,r){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e),a=I.fromJSON(await o.executeQuery(t.toJSON(),r?.signal));return a.features.forEach((e=>{e.sourceLayer=this})),a},o.queryFeaturesJSON=async function(e,r){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e);return await o.executeQuery(t.toJSON(),r?.signal)},o.queryFeatureCount=async function(e,r){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e);return o.executeQueryForCount(t.toJSON(),r?.signal)},o.queryExtent=async function(e={},r){const t={...e,returnGeometry:!0},{resolvedQuery:o,queryEngine:a}=await this._setupQueryObjects(t),n=await a.executeQueryForExtent(o.toJSON(),r?.signal);let i;return i=null!=n.extent?.xmin&&null!=n.extent?.xmax&&null!=n.extent?.ymin&&null!=n.extent?.ymax?new J(n.extent):new J,{count:n.count,extent:i}},o.queryObjectIds=async function(e,r){const t=D.from(e);let o;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(t,this,r);o=this.loadQueryEngine(e)}return o.executeQueryForIds(t.toJSON(),r?.signal)},o.loadQueryEngine=function(e){const r=new F({geometryType:K.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),t=new O.QueryEngine({fields:this.fields.map((e=>e.toJSON())),geometryType:K.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:r});return t.featureStore.addMany(e),t},o.refreshCachedQueryEngine=async function(){const e=await this.parentCompositeLayer.dataManager.getData(new D({where:"1=1",outFields:[L.MOCK_OID_FIELD_NAME]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)},o._setupQueryObjects=async function(e,r){const t=D.from(e),o=t.geometry;let a;if(o&&!o.spatialReference?.isWGS84&&(await T.initializeProjection(o.spatialReference,S.WGS84),t.geometry=o instanceof G||o instanceof k?T.project(o,S.WGS84):T.project(o.extent,S.WGS84)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)a=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(t,this,r);a=this.loadQueryEngine(e)}return{resolvedQuery:t,queryEngine:a}},e._createClass(t,[{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"renderer",set:function(e){C.fixRendererFields(e,this.fieldsIndex),this._set("renderer",e)}}]),t}(Q.FeatureReductionLayer(N.KnowledgeGraphSublayerBase(M.BlendLayer(x.ScaleRangeLayer(j.RefreshableLayer(w))))));r.__decorate([g.property()],P.prototype,"capabilities",void 0),r.__decorate([g.property({readOnly:!0})],P.prototype,"defaultPopupTemplate",null),r.__decorate([g.property()],P.prototype,"definitionExpression",void 0),r.__decorate([g.property()],P.prototype,"displayField",void 0),r.__decorate([g.property()],P.prototype,"elevationInfo",void 0),r.__decorate([g.property()],P.prototype,"geometryType",void 0),r.__decorate([g.property()],P.prototype,"geometryFieldName",void 0),r.__decorate([g.property()],P.prototype,"graphType",void 0),r.__decorate([g.property()],P.prototype,"hasM",void 0),r.__decorate([g.property()],P.prototype,"hasZ",void 0),r.__decorate([g.property()],P.prototype,"labelsVisible",void 0),r.__decorate([g.property()],P.prototype,"labelingInfo",void 0),r.__decorate([g.property()],P.prototype,"objectIdField",void 0),r.__decorate([g.property()],P.prototype,"objectType",void 0),r.__decorate([g.property()],P.prototype,"parentCompositeLayer",void 0),r.__decorate([g.property({type:o,json:{name:"popupInfo",write:!0}})],P.prototype,"popupTemplate",void 0),r.__decorate([g.property({types:c.rendererTypes,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],P.prototype,"renderer",null),r.__decorate([g.property()],P.prototype,"source",void 0),r.__decorate([g.property({json:{read:!1}})],P.prototype,"type",void 0),P=r.__decorate([b.subclass("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],P);return P}));
