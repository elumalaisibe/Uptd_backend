/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../core/Error","../../../chunks/mat3","../../../geometry/Point","../../../geometry/projection","../../../geometry/support/webMercatorUtils","../../ElevationLayer","./utils"],(function(e,t,a,r,i,n,o,c){"use strict";function s(e){return"esri.Graphic"===e?.declaredClass}const l=Math.PI/180;async function u(e,t,a=!1){if(!e)return[];e=e.map((e=>"esri.geometry.Point"===e.declaredClass?e:r.fromJSON(e)));const{feature:i}=t,{attributes:n}=i;if(isNaN(parseFloat(n.elevation))){const e=await m([i.geometry],t);i.attributes.elevation=e[0].z}return m(e,t,a).then((e=>p(e,t)))}async function m(e,t,a=!1){if(a)return f(e,1);const{feature:r,options:n,currentCoveragePolygon:c}=t,l=r.attributes.elevationSource;if(!l?.url&&!l?.constantElevation)return e;const{url:u,constantElevation:m}=l;if(m)return f(e,m);if(!r.elevationSample){const e=s(c)?c.geometry?.extent:c.extent;if(e){const t=e.clone(),a=new o(u);t.xmin/=2,t.xmax*=2,t.ymin/=2,t.ymax*=2,r.elevationSample=await a.createElevationSampler(t,n),a.destroy()}}return Promise.all(e.map((async e=>{e.z=1;const t=r.elevationSample?.queryElevation(i.project(e,r.elevationSample.spatialReference));return t?.z&&(e.z=t.z),e})))}function f(e,t){return e.map((e=>(e.z=t,e)))}function p(e,t){const{attributes:a}=t.feature;return a.isSpherical||360===a.horizontalFieldOfView?{}:a.cameraOrientation?.isAdvanced?y(e,t):Promise.resolve(g(e,t))}function g(e,t){const{feature:i,imageProperties:o}=t,{width:s,height:u}=o,{attributes:m}=i,f=c.calculateRotationMatrix("HPR",[m.cameraHeading,m.cameraPitch,m.cameraRoll]),p=Math.sin(m.imageRotation??0*l),g=Math.cos(m.imageRotation??0*l),y=s??1,h=u??1,d=[Math.abs(g*y+p*h),Math.abs(g*h-p*y)],M={horizontal:1/(2*Math.tan(m.horizontalFieldOfView*l/2)),vertical:1/(2*Math.tan(m.verticalFieldOfView*l/2))},b=[-M.horizontal,0,.5,0,M.vertical,.5,0,0,1];let P=new r(m.geometry);P.spatialReference.isWGS84&&4!==m.cameraOrientation?.type&&(P=n.geographicToWebMercator(P));const v=P.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*P.y/6378137))):1,x=a.mul(new Array(9),f,b);return e.map((e=>{let t=new r(e);if(t.spatialReference.isWGS84)if(4===m.cameraOrientation?.type){const e=m.cameraOrientation;t=new r(c.geographicToLTP(t,[e.latitude,e.longitude,e.ellipsoidRadius,e.squaredEccentricity]))}else t=new r(n.geographicToWebMercator(t));const a=(t.z??0)-(P.z??0),i=(t.x-P.x)/v,o=(t.y-P.y)/v,s=(x[0]*i+x[1]*o+x[2]*a)/(x[6]*i+x[7]*o+x[8]*a),l=(x[3]*i+x[4]*o+x[5]*a)/(x[6]*i+x[7]*o+x[8]*a),u={x:s*d[0],y:l*d[1]};return{x:g*(u.x-d[0]/2)+p*(u.y-d[1]/2)+y/2,y:-p*(u.x-d[0]/2)+g*(u.y-d[1]/2)+h/2}}))}function y(e,a){const{feature:o}=a,{attributes:s}=o,l=s.cameraOrientation;if(!l)throw new t("groundToImageUtils:missing-camera-orientation-parameters","CameraOrientation Parameters are required to perform advanced transformations");let u=new r(s.location);u.spatialReference.isWGS84&&4!==s.cameraOrientation?.type&&(u=n.geographicToWebMercator(u));const m=u.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*u.y/6378137))):1;let f;if("esri.layers.orientedImagery.core.CameraOrientationOPK"===l.declaredClass){const{omega:e,phi:t,kappa:a}=l;f=c.calculateRotationMatrix("OPK",[e,t,a])}else{const{cameraHeading:e,cameraPitch:t,cameraRoll:a}=s;f=c.calculateRotationMatrix("HPR",[e,t,a])}const{principalOffsetPoint:p,focalLength:g,radialDistortionCoefficients:y,affineTransformations:h,tangentialDistortionCoefficients:d}=l;return Promise.all(e.map((e=>{let t;return e.spatialReference.equals(u.spatialReference)?(t=new r(e),a(t)):(t=i.project(e,u.spatialReference),t?a(t):null);function a(e){if(e.spatialReference.isWGS84)if(4===s.cameraOrientation?.type){const t=s.cameraOrientation;e=new r(c.geographicToLTP(e,[t.latitude,t.longitude,t.ellipsoidRadius,t.squaredEccentricity]))}else e=new r(n.geographicToWebMercator(e));const t=(e.z??0)-(u.z??0),a=(e.x-u.x)/m,i=(e.y-u.y)/m,o=(f[0]*a+f[1]*i+f[2]*t)/(f[6]*a+f[7]*i+f[8]*t),l=(f[3]*a+f[4]*i+f[5]*t)/(f[6]*a+f[7]*i+f[8]*t),M=o**2+l**2;let b=0,P=0,v=0,x=0,R=0,w=0,O=0;y&&(b=y[0]??0,P=y[1]??0,v=y[2]??0),d&&(x=d[0],R=d[1]),p&&(w=p[0]??0,O=p[1]??0);const z=1+(b||0)*M+(P||0)*M*M+(v||0)*M*M*M;let S=o*z+(x||0)*(M+2*o**2)+2*(R||0)*o*l,T=l*z+(R||0)*(M+2*l**2)+2*(x||0)*o*l;S=-(g??0)*S+w,T=-(g??0)*T+O;return{x:Number(h[0])+Number(h[1])*S+Number(h[2])*T,y:Number(h[3])+Number(h[4])*S+Number(h[5])*T}}})))}e.transformPoints=u,e.updateElevation=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
