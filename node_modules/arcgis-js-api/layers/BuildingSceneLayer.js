/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../core/Collection","../core/CollectionFlattener","../core/Error","../core/lang","../core/loadAll","../core/Logger","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/SpatialReference","./Layer","./buildingSublayers/BuildingComponentSublayer","./buildingSublayers/BuildingGroupSublayer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./support/BuildingFilter","./support/BuildingSummaryStatistics","./support/commonProperties","./support/FetchAssociatedFeatureLayer"],(function(e,r,t,i,o,s,a,n,l,y,u,p,c,d,h,b,v,g,f,S,_,m,w,O,I,L,A,E,T){"use strict";const x=t.ofType(L),F=s.clone(f.sublayersProperty),P=F.json?.origins;P&&(P["web-scene"]={type:[g],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}},P["portal-item"]={type:[g],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}});let B=function(r){function t(e){var t;return(t=r.call(this,e)||this).operationalLayerType="BuildingSceneLayer",t.allSublayers=new i({getCollections:()=>[t.sublayers],getChildrenFunction:e=>"building-group"===e.type?e.sublayers:null}),t.sublayers=null,t._sublayerOverrides=null,t.filters=new x,t.activeFilterId=null,t.summaryStatistics=null,t.outFields=null,t.legendEnabled=!0,t.type="building-scene",t}e._inherits(t,r);var l=t.prototype;return l.normalizeCtorArgs=function(e){return"string"==typeof e?{url:e}:e??{}},l.destroy=function(){this.allSublayers.destroy()},l.readSublayers=function(e,r,t){const i=f.readSublayers(e,r,t);return f.forEachSublayer(i,(e=>e.layer=this)),this._sublayerOverrides&&(this.applySublayerOverrides(i,this._sublayerOverrides),this._sublayerOverrides=null),i},l.applySublayerOverrides=function(e,{overrides:r,context:t}){f.forEachSublayer(e,(e=>e.read(r.get(e.id),t)))},l.readSublayerOverrides=function(e,r){const t=new Map;for(const i of e)null!=i&&"object"==typeof i&&"number"==typeof i.id?t.set(i.id,i):r.messages?.push(new o("building-scene-layer:invalid-sublayer-override","Invalid value for sublayer override. Not an object or no id specified.",{value:i}));return{overrides:t,context:r}},l.writeSublayerOverrides=function(e,r,t){const i=[];f.forEachSublayer(this.sublayers,(e=>{const r=e.write({},t);Object.keys(r).length>1&&i.push(r)})),i.length>0&&(r.sublayers=i)},l.writeUnappliedOverrides=function(e,r){r.sublayers=[],e.overrides.forEach((e=>{r.sublayers.push(s.clone(e))}))},l.write=function(r,i){return r=e._get(e._getPrototypeOf(t.prototype),"write",this).call(this,r,i),!i||"web-scene"!==i.origin&&"portal-item"!==i.origin||(this.sublayers?this.writeSublayerOverrides(this.sublayers,r,i):this._sublayerOverrides&&this.writeUnappliedOverrides(this._sublayerOverrides,r)),r},l.read=function(r,i){if(e._get(e._getPrototypeOf(t.prototype),"read",this).call(this,r,i),i&&("web-scene"===i.origin||"portal-item"===i.origin)&&null!=r&&Array.isArray(r.sublayers)){const e=this.readSublayerOverrides(r.sublayers,i);this.sublayers?this.applySublayerOverrides(this.sublayers,e):this._sublayerOverrides=e}},l.readSummaryStatistics=function(e,r){if("string"==typeof r.statisticsHRef){const e=u.join(this.parsedUrl?.path,r.statisticsHRef);return new A({url:e})}return null},l.load=function(e){const r=null!=e?e.signal:null,t=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(y.throwIfAbortError).then((()=>this._fetchService(r))).then((()=>this._fetchAssociatedFeatureService(r)));return this.addResolvingPromise(t),Promise.resolve(this)},l.loadAll=function(){return a.loadAll(this,(e=>{f.forEachSublayer(this.sublayers,(r=>{"building-group"!==r.type&&e(r)})),this.summaryStatistics&&e(this.summaryStatistics)}))},l.saveAs=async function(e,r){return this._debouncedSaveOperations(I.SaveOperationType.SAVE_AS,{...r,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"},e)},l.save=async function(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"};return this._debouncedSaveOperations(I.SaveOperationType.SAVE,e)},l.validateLayer=function(e){if(!e.layerType||"Building"!==e.layerType)throw new o("buildingscenelayer:layer-type-not-supported","BuildingSceneLayer does not support this layer type",{layerType:e.layerType})},l._getTypeKeywords=function(){return["Building"]},l._validateElevationInfo=function(){const e=this.elevationInfo;e&&("absolute-height"!==e.mode&&n.getLogger(this).warn(".elevationInfo=","Building scene layers only support absolute-height elevation mode"),e.featureExpressionInfo&&"0"!==e.featureExpressionInfo.expression&&n.getLogger(this).warn(".elevationInfo=","Building scene layers do not support featureExpressionInfo"))},l._fetchAssociatedFeatureService=async function(e){const r=new T.FetchAssociatedFeatureLayer(this.parsedUrl,this.portalItem,this.apiKey,e);try{this.associatedFeatureServiceItem=await r.fetchPortalItem()}catch(t){n.getLogger(this).warn("Associated feature service item could not be loaded",t)}},e._createClass(t,[{key:"elevationInfo",set:function(e){this._set("elevationInfo",e),this._validateElevationInfo()}}]),t}(I.SceneService(_.ArcGISService(m.OperationalLayer(w.PortalLayer(O.ScaleRangeLayer(l.MultiOriginJSONMixin(S.APIKeyMixin(v))))))));r.__decorate([p.property({type:["BuildingSceneLayer"]})],B.prototype,"operationalLayerType",void 0),r.__decorate([p.property({readOnly:!0})],B.prototype,"allSublayers",void 0),r.__decorate([p.property(F)],B.prototype,"sublayers",void 0),r.__decorate([d.reader("service","sublayers")],B.prototype,"readSublayers",null),r.__decorate([p.property({type:x,nonNullable:!0,json:{write:!0}})],B.prototype,"filters",void 0),r.__decorate([p.property({type:String,json:{write:!0}})],B.prototype,"activeFilterId",void 0),r.__decorate([p.property({readOnly:!0,type:A})],B.prototype,"summaryStatistics",void 0),r.__decorate([d.reader("summaryStatistics",["statisticsHRef"])],B.prototype,"readSummaryStatistics",null),r.__decorate([p.property({type:[String],json:{read:!1}})],B.prototype,"outFields",void 0),r.__decorate([p.property(E.sceneLayerFullExtent)],B.prototype,"fullExtent",void 0),r.__decorate([p.property(E.legendEnabled)],B.prototype,"legendEnabled",void 0),r.__decorate([p.property({type:["show","hide","hide-children"]})],B.prototype,"listMode",void 0),r.__decorate([p.property(E.readOnlyService(b))],B.prototype,"spatialReference",void 0),r.__decorate([p.property(E.elevationInfo)],B.prototype,"elevationInfo",null),r.__decorate([p.property({json:{read:!1},readOnly:!0})],B.prototype,"type",void 0),r.__decorate([p.property()],B.prototype,"associatedFeatureServiceItem",void 0),B=r.__decorate([h.subclass("esri.layers.BuildingSceneLayer")],B);return B}));
