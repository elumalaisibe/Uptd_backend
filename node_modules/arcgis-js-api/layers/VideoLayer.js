/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../chunks/_rollupPluginBabelHelpers","../chunks/tslib.es6","../geometry","../request","../core/mathUtils","../core/MultiOriginJSONSupport","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/arrayUtils","../core/has","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/Polyline","../geometry/SpatialReference","./Layer","./mixins/BlendLayer","./mixins/CustomParametersMixin","./mixins/ScaleRangeLayer","./support/commonProperties","./support/PlaybackInfo","./support/serviceCapabilitiesUtils","./support/TelemetryData","./support/TelemetryDisplay","./support/VideoFrame","./video/VideoController","./video/videoUtils","../geometry/Polygon","../geometry/Extent"],(function(e,t,r,o,n,i,l,a,p,s,c,u,y,d,_,h,m,f,g,v,S,b,k,O,T,U,C,x,P){"use strict";let N=function(t){function r(e){var r;return(r=t.call(this,e)||this)._trailPoints=[],r.capabilities=null,r.connectionInfo=null,r.controller=new U,r.copyright=null,r.coverage=null,r.description=null,r.frame=null,r.frameCount=null,r.initialExtent=null,r.playbackInfo=null,r.posterUrl=null,r.protocol="hls",r.qualities=null,r.sourceJSON=null,r.spatialReference=_.WGS84,r.telemetryDisplay=null,r.videoTimeExtent=null,r.title=null,r.type="video",r.url=null,r}e._inherits(r,t);var i=r.prototype;return i.initialize=function(){this.telemetryDisplay=new O({frameCenter:!0,frameOutline:!0,lineOfSight:!0,sensorLocation:!0,sensorTrail:!0}),this.addHandles([l.watch((()=>this.metadata),(()=>this.notifyChange("telemetry"))),l.watch((()=>this.telemetry?.sensorLocation),(e=>this._setSensorTrail(e)),l.initial)])},i.load=function(e){const t=null!=e?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),Promise.resolve(this)},i.readCapabilitiesFromService=function(e,t){return b.getVideoLayerCapabilities(t)},i.play=function(){this.controller.play()},i.pause=function(){this.controller.pause()},i.reset=function(){this.controller.reset()},i.setCurrentTime=function(e){if(!this.duration)return;const t=n.clamp(e,0,this.duration);this.controller.setCurrentTime(t)},i.getCurrentFrame=function(){},i.toGround=function(e,t){return this.controller?.cameraSensorModel?.metadataSupportsTransforms?this.controller.cameraSensorModel.transformImageToGeo(e,t):null},i.toVideo=function(e){if(!this.controller?.cameraSensorModel?.metadataSupportsTransforms)return null;const t=this.controller.cameraSensorModel.transformGeoToImage(e.x,e.y,e.z);return{x:t[0],y:t[1]}},i._fetchService=async function(e){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:t,ssl:r}=await o(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters},signal:e});r&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=t,this.read(t,{origin:"service",url:this.parsedUrl})},i._setSensorTrail=function(e){if(!e)return;const t=C.getSensorTrailPoints(e,this._trailPoints);this._trailPoints=[...t];const r=this._trailPoints.map((e=>e.toArray())),o=new d({hasZ:e.hasZ,paths:[r]});this.telemetry.sensorTrail=o.clone()},e._createClass(r,[{key:"buffered",get:function(){return this.controller.buffered}},{key:"currentTime",get:function(){return this.controller.currentTime}},{key:"duration",get:function(){return this.controller.duration}},{key:"ended",get:function(){return this.controller.ended}},{key:"loop",get:function(){return this.controller.loop},set:function(e){this.controller.loop=e}},{key:"metadata",get:function(){return this.controller?.currentMetadata}},{key:"muted",get:function(){return this.controller.muted},set:function(e){this.controller.muted=e}},{key:"playbackRate",get:function(){return this.controller.rate},set:function(e){this.controller.rate=e}},{key:"playbackUrl",get:function(){return this.connectionInfo&&this.protocol?this.connectionInfo[this.protocol]:null}},{key:"sourceUrl",get:function(){return this.controller.sourceUrl??""},set:function(e){this.controller.sourceUrl=e}},{key:"state",get:function(){return this.controller.state}},{key:"telemetry",get:function(){return C.getTelemetryData(this.metadata)}},{key:"waiting",get:function(){return this.controller.waiting}}]),r}(m.BlendLayer(g.ScaleRangeLayer(i.MultiOriginJSONMixin(f.CustomParametersMixin(h)))));t.__decorate([a.property({readOnly:!0})],N.prototype,"buffered",null),t.__decorate([a.property({readOnly:!0,json:{read:!1}})],N.prototype,"capabilities",void 0),t.__decorate([u.reader("service","capabilities",["supportsCoverageQuery","supportsExportClip","supportsMensuration"])],N.prototype,"readCapabilitiesFromService",null),t.__decorate([a.property({readOnly:!0,json:{read:{source:"connectionUrl"}}})],N.prototype,"connectionInfo",void 0),t.__decorate([a.property()],N.prototype,"controller",void 0),t.__decorate([a.property({type:String})],N.prototype,"copyright",void 0),t.__decorate([a.property({type:x})],N.prototype,"coverage",void 0),t.__decorate([a.property({type:Number})],N.prototype,"currentTime",null),t.__decorate([a.property({type:String})],N.prototype,"description",void 0),t.__decorate([a.property({type:Number})],N.prototype,"duration",null),t.__decorate([a.property({type:Boolean})],N.prototype,"ended",null),t.__decorate([a.property({type:T})],N.prototype,"frame",void 0),t.__decorate([a.property({type:Number})],N.prototype,"frameCount",void 0),t.__decorate([a.property({type:P})],N.prototype,"initialExtent",void 0),t.__decorate([a.property({type:Boolean})],N.prototype,"loop",null),t.__decorate([a.property({readOnly:!0})],N.prototype,"metadata",null),t.__decorate([a.property({type:Boolean})],N.prototype,"muted",null),t.__decorate([a.property({type:S})],N.prototype,"playbackInfo",void 0),t.__decorate([a.property({type:Number})],N.prototype,"playbackRate",null),t.__decorate([a.property({readOnly:!0})],N.prototype,"playbackUrl",null),t.__decorate([a.property({readOnly:!0,json:{read:{source:"poster"}}})],N.prototype,"posterUrl",void 0),t.__decorate([a.property({type:String})],N.prototype,"protocol",void 0),t.__decorate([a.property({readOnly:!0})],N.prototype,"qualities",void 0),t.__decorate([a.property()],N.prototype,"sourceJSON",void 0),t.__decorate([a.property({type:String})],N.prototype,"sourceUrl",null),t.__decorate([a.property()],N.prototype,"spatialReference",void 0),t.__decorate([a.property({type:String})],N.prototype,"state",null),t.__decorate([a.property({type:k})],N.prototype,"telemetry",null),t.__decorate([a.property({type:O})],N.prototype,"telemetryDisplay",void 0),t.__decorate([a.property({readOnly:!0,nonNullable:!1,json:{read:{reader:C.readVideoTimeExtent,source:"time"}}})],N.prototype,"videoTimeExtent",void 0),t.__decorate([a.property({readOnly:!0,json:{read:{source:"name"}}})],N.prototype,"title",void 0),t.__decorate([a.property({readOnly:!0})],N.prototype,"type",void 0),t.__decorate([a.property(v.url)],N.prototype,"url",void 0),t.__decorate([a.property({readOnly:!0})],N.prototype,"waiting",null),N=t.__decorate([y.subclass("esri.layers.VideoLayer")],N);return N}));
