/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","exports","../../../core/jsonMap","../../../core/unitUtils","../../../geometry/projection","../../../geometry/support/extentUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","../OptimizedGeometry","./projectionSupport"],(function(e,t,i,n,r,o,l,s,a,c,u,m){"use strict";const f=new i.JSONMap({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),y=Object.freeze({}),p=new u,g=new u,S=new u,d={esriGeometryPoint:c.convertToPoint,esriGeometryPolyline:c.convertToPolyline,esriGeometryPolygon:c.convertToPolygon,esriGeometryMultipoint:c.convertToMultipoint};function R(e,t,i,n=e.hasZ,r=e.hasM){if(null==t)return null;const o=e.hasZ&&n,l=e.hasM&&r;if(i){const s=c.quantizeOptimizedGeometry(S,t,e.hasZ,e.hasM,"esriGeometryPoint",i,n,r);return c.convertToPoint(s,o,l)}return c.convertToPoint(t,o,l)}function h(e,t,i,n,r,o,l=t,s=i){const a=t&&l,u=i&&s,m=null!=n?"coords"in n?n:n.geometry:null;if(null==m)return null;if(r){let n=c.generalizeOptimizedGeometry(g,m,t,i,e,r,l,s);return o&&(n=c.quantizeOptimizedGeometry(S,n,a,u,e,o)),d[e]?.(n,a,u)??null}if(o){const n=c.quantizeOptimizedGeometry(S,m,t,i,e,o,l,s);return d[e]?.(n,a,u)??null}return c.removeZMValues(p,m,t,i,l,s),d[e]?.(p,a,u)??null}async function w(e,t,i){const{outFields:n,orderByFields:r,groupByFieldsForStatistics:o,outStatistics:l}=e;if(n)for(let s=0;s<n.length;s++)n[s]=n[s].trim();if(r)for(let s=0;s<r.length;s++)r[s]=r[s].trim();if(o)for(let s=0;s<o.length;s++)o[s]=o[s].trim();if(l)for(let s=0;s<l.length;s++)l[s].onStatisticField&&(l[s].onStatisticField=l[s].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),P(e,t,i)}async function P(e,t,i){if(!e)return null;let{where:n}=e;if(e.where=n=n&&n.trim(),(!n||/^1 *= *1$/.test(n)||t&&t===n)&&(e.where=null),!e.geometry)return e;let r=await z(e);if(e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel){const{spatialReference:t}=e.geometry;r=o.getGeometryExtent(r),r.spatialReference=t}if(r){await m.checkProjectionSupport(r.spatialReference,i),r=G(r,i);const t=(await s.normalizeCentralMeridian(l.fromJSON(r)))[0];if(null==t)throw y;const n="quantizationParameters"in e&&e.quantizationParameters?.tolerance||"maxAllowableOffset"in e&&e.maxAllowableOffset||0,o=n&&x(r,i)?{densificationStep:8*n}:void 0,a=t.toJSON(),c=await m.project(a,a.spatialReference,i,o);if(!c)throw y;c.spatialReference=i,e.geometry=c}return e}function x(e,t){if(!e)return!1;const i=e.spatialReference;return(l.isExtent(e)||l.isPolygon(e)||l.isPolyline(e))&&!a.equals(i,t)&&!r.canProjectWithoutEngine(i,t)}function G(e,t){const i=e.spatialReference;return x(e,t)&&l.isExtent(e)?{spatialReference:i,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}:e}async function z(e){const{distance:t,units:i}=e,r=e.geometry;if(null==t||"vertexAttributes"in r)return r;const o=r.spatialReference,l=i?f.fromJSON(i):n.getUnitString(o),s=o&&(a.isGeographic(o)||a.isWebMercator(o))?r:await m.checkProjectionSupport(o,a.WGS84).then((()=>m.project(r,a.WGS84)));return(await M())(s.spatialReference,s,t,l)}async function M(){return(await new Promise(((t,i)=>e(["../../../geometry/geometryEngineJSON"],t,i)))).geodesicBuffer}function O(e){return e&&U in e?JSON.parse(JSON.stringify(e,v)):e}const U="_geVersion",v=(e,t)=>e!==U?t:void 0;t.QUERY_ENGINE_EMPTY_RESULT=y,t.cleanFromGeometryEngine=O,t.getGeometry=h,t.normalizeQuery=w,t.normalizeQueryLike=P,t.transformCentroid=R,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
