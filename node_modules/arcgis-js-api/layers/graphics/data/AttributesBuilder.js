/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["../../../chunks/_rollupPluginBabelHelpers","./attributeSupport","./utils","../../../statistics/utils","../../../support/arcadeOnDemand"],(function(e,t,i,s,a){"use strict";return function(){function l(e,i,s){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues??!1,this.fieldsIndex=s,this.featureAdapter=i;const a=e.outFields;if(a&&!a.includes("*")){this.outFields=a;let e=0;for(const i of a){const a=t.getExpressionFromFieldName(i),l=this.fieldsIndex.get(a),r=l?null:t.getWhereClause(a,s),n=l?l.name:t.getAliasFromFieldName(i)||"FIELD_EXP_"+e++;this._fieldDataCache.set(i,{alias:n,clause:r})}}}var r=l.prototype;return r.countDistinctValues=function(e){return this.returnDistinctValues?(e.forEach((e=>this.getAttributes(e))),this._returnDistinctMap.size):e.length},r.getAttributes=function(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)},r.getFieldValue=function(e,i,s){const a=s?s.name:i;let l=null;return this._fieldDataCache.has(a)?l=this._fieldDataCache.get(a)?.clause:s||(l=t.getWhereClause(i,this.fieldsIndex),this._fieldDataCache.set(a,{alias:a,clause:l})),s?this.featureAdapter.getAttribute(e,a):l?.calculateValue(e,this.featureAdapter)},r.getDataValues=function(e,t){const i=t.normalizationType,a=t.normalizationTotal;return e.map((e=>{let l=t.field&&this.getFieldValue(e,t.field,this.fieldsIndex.get(t.field));if(t.field2&&(l=`${s.processNullValue(l)}${t.fieldDelimiter}${s.processNullValue(this.getFieldValue(e,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(l=`${l}${t.fieldDelimiter}${s.processNullValue(this.getFieldValue(e,t.field3,this.fieldsIndex.get(t.field3)))}`)),i&&Number.isFinite(l)){const r="field"===i&&t.normalizationField?this.getFieldValue(e,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;l=s.getNormalizedValue(l,i,r,a)}return l}))},r.getExpressionValues=async function(e,t,s,l){const{arcadeUtils:r}=await a.loadArcade(),n=r.hasGeometryOperations(t);n&&await r.enableGeometryOperations();const u=r.createFunction(t),c=s&&r.getViewInfo(s),o={fields:this.fieldsIndex.fields};return e.map((e=>{const t={attributes:this.featureAdapter.getAttributes(e),layer:o,geometry:n?{...i.getGeometry(l.geometryType,l.hasZ,l.hasM,this.featureAdapter.getGeometry(e)),spatialReference:s?.spatialReference}:null},a=r.createExecContext(t,c);return r.executeFunction(u,a)}))},r.validateItem=function(e,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:t.getWhereClause(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testFeature(e,this.featureAdapter)??!1},r.validateItems=function(e,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:t.getWhereClause(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testSet(e,this.featureAdapter)??!1},r._processAttributesForOutFields=function(e){const t=this.outFields;if(!t||!t.length)return this.featureAdapter.getAttributes(e);const i={};for(const s of t){const{alias:t,clause:a}=this._fieldDataCache.get(s);i[t]=a?a.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return i},r._processAttributesForDistinctValues=function(e){if(null==e||!this.returnDistinctValues)return e;const t=this.outFields,i=[];if(t)for(const l of t){const{alias:t}=this._fieldDataCache.get(l);i.push(e[t])}else for(const l in e)i.push(e[l]);const s=`${(t||["*"]).join(",")}=${i.join(",")}`;let a=this._returnDistinctMap.get(s)||0;return this._returnDistinctMap.set(s,++a),a>1?null:e},e._createClass(l)}()}));
