/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["exports","../../../../request","../../../../core/promiseUtils","../../../../core/urlUtils","../../../support/arcgisLayerUrl"],(function(e,o,t,r,s){"use strict";const n=1e6,i=20*n,a=2e9,p=3;async function l({data:e,name:l,description:c},d,f){let u=null;try{const m=r.join(d,"uploads"),h=r.join(m,"info"),{data:w}=await o(h,{query:{f:"json"},responseType:"json"});t.throwIfAborted(f);const j=s.isHostedAgolService(d),y=w.maxUploadFileSize*n,g=j?a:y,b=j?Math.min(i,y):i;if(e.size>g)throw new Error("Data too large");const A=r.join(m,"register"),{data:I}=await o(A,{query:{f:"json",itemName:l,description:c},responseType:"json",method:"post"});if(t.throwIfAborted(f),!I.success)throw new Error("Registration failed");const{itemID:T}=I.item;u=r.join(m,T);const q=r.join(u,"uploadPart"),z=Math.ceil(e.size/b),E=new Array;for(let o=0;o<z;++o)E.push(e.slice(o*b,Math.min((o+1)*b,e.size)));const M=E.slice().reverse(),P=new Array,S=async()=>{for(;0!==M.length;){const e=E.length-M.length,r=M.pop(),s=new FormData;s.append("f","json"),s.append("file",r),s.append("partId",`${e}`);const{data:n}=await o(q,{timeout:0,body:s,responseType:"json",method:"post"});if(t.throwIfAborted(f),!n.success)throw new Error("Part upload failed")}};for(let e=0;e<p&&0!==M.length;++e)P.push(S());await Promise.all(P);const U=r.join(u,"commit"),{data:v}=await o(U,{query:{f:"json",parts:E.map(((e,o)=>o)).join(",")},responseType:"json",method:"post"});if(t.throwIfAborted(f),!v.success)throw new Error("Commit failed");return v.item}catch(m){if(null!=u){const e=r.join(u,"delete");await o(e,{query:{f:"json"},responseType:"json",method:"post"})}throw m}}e.uploadItem=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
