/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
define(["require","../../../../chunks/_rollupPluginBabelHelpers","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Error","../../../../core/has","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/ensureType","../../../../core/arrayUtils","../../../../core/accessorSupport/decorators/subclass","../../../support/infoFor3D","../../../support/source/DataLayerSource","../../../../rest/utils","../../../../rest/query/executeForCount","../../../../rest/query/executeForExtent","../../../../rest/query/executeForIds","../../../../rest/query/executeQueryJSON","../../../../rest/query/executeQueryPBF","../../../../rest/support/FeatureSet","../../../../rest/support/Query"],(function(e,t,r,o,s,n,u,i,a,c,l,p,y,d,f,h,m,F,S,b,x,_){"use strict";const D=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let O=function(r){function o(e){var t;return(t=r.call(this,e)||this).dynamicDataSource=null,t.fieldsIndex=null,t.gdbVersion=null,t.infoFor3D=null,t.pbfSupported=!1,t.queryAttachmentsSupported=!1,t.sourceSpatialReference=null,t.url=null,t}t._inherits(o,r);var a=o.prototype;return a.execute=async function(e,t){const r=await this.executeJSON(e,t);return this.featureSetFromJSON(e,r,t)},a.executeJSON=async function(e,t){const r=this._normalizeQuery(e),o=null!=e.outStatistics?.[0],s=n("featurelayer-pbf-statistics"),u=!o||s;let i;if(this.pbfSupported&&u)try{i=await b.executeRawQueryPBF(this.url,r,t)}catch(a){if("query:parsing-pbf"!==a.name)throw a;this.pbfSupported=!1}return this.pbfSupported&&u||(i=await S.executeRawQueryJSON(this.url,r,t)),this._normalizeFields(i.fields),i},a.featureSetFromJSON=async function(t,r,o){if(!this._queryIs3DObjectFormat(t)||null==this.infoFor3D||!r.features)return x.fromJSON(r);const{meshFeatureSetFromJSON:s}=await u.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/support/meshFeatureSet"],t,r))),o);return s(t,this.infoFor3D,r)},a.executeForCount=function(e,t){return h.executeForCount(this.url,this._normalizeQuery(e),t)},a.executeForExtent=function(e,t){return m.executeForExtent(this.url,this._normalizeQuery(e),t)},a.executeForIds=function(e,t){return F.executeForIds(this.url,this._normalizeQuery(e),t)},a.executeRelationshipQuery=async function(t,r){const[{default:o},{executeRelationshipQuery:s}]=await u.whenOrAbort(Promise.all([new Promise(((t,r)=>e(["../../../../rest/support/RelationshipQuery"],(e=>t(D(e))),r))),new Promise(((t,r)=>e(["../../../../rest/query/executeRelationshipQuery"],t,r)))]),r);return t=o.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),s(this.url,t,r)},a.executeRelationshipQueryForCount=async function(t,r){const[{default:o},{executeRelationshipQueryForCount:s}]=await u.whenOrAbort(Promise.all([new Promise(((t,r)=>e(["../../../../rest/support/RelationshipQuery"],(e=>t(D(e))),r))),new Promise(((t,r)=>e(["../../../../rest/query/executeRelationshipQuery"],t,r)))]),r);return t=o.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),s(this.url,t,r)},a.executeAttachmentQuery=async function(t,r){const{executeAttachmentQuery:o,fetchAttachments:s,processAttachmentQueryResult:n}=await u.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/operations/queryAttachments"],t,r))),r),i=f.parseUrl(this.url);return n(i,await(this.queryAttachmentsSupported?o(i,t,r):s(i,t,r)))},a.executeTopFeaturesQuery=async function(t,r){const{executeTopFeaturesQuery:o}=await u.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeTopFeaturesQuery"],t,r))),r);return o(this.parsedUrl,t,this.sourceSpatialReference,r)},a.executeForTopIds=async function(t,r){const{executeForTopIds:o}=await u.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeForTopIds"],t,r))),r);return o(this.parsedUrl,t,r)},a.executeForTopExtents=async function(t,r){const{executeForTopExtents:o}=await u.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeForTopExtents"],t,r))),r);return o(this.parsedUrl,t,r)},a.executeForTopCount=async function(t,r){const{executeForTopCount:o}=await u.whenOrAbort(new Promise(((t,r)=>e(["../../../../rest/query/executeForTopCount"],t,r))),r);return o(this.parsedUrl,t,r)},a._normalizeQuery=function(e){let t=_.from(e);t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===e?t.clone():t,t.gdbVersion=e.gdbVersion||this.gdbVersion,t.dynamicDataSource=e.dynamicDataSource?d.DataLayerSource.from(e.dynamicDataSource):this.dynamicDataSource);const{infoFor3D:r}=this;if(null!=r&&this._queryIs3DObjectFormat(e)){t=t===e?t.clone():t,t.formatOf3DObjects=null;const{supportedFormats:o,queryFormats:n}=r,u=y.getMimeTypeFormatId("model/gltf-binary",o)??y.getFilenameFormatId("glb",o),i=y.getMimeTypeFormatId("model/gltf+json",o)??y.getFilenameFormatId("gtlf",o);for(const e of n){if(e===u){t.formatOf3DObjects=e;break}e!==i||t.formatOf3DObjects||(t.formatOf3DObjects=e)}if(!t.formatOf3DObjects)throw new s("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==t.outFields||!t.outFields.includes("*")){t=t===e?t.clone():t,null==t.outFields&&(t.outFields=[]);const{originX:o,originY:s,originZ:n,translationX:u,translationY:i,translationZ:a,scaleX:c,scaleY:l,scaleZ:p,rotationX:y,rotationY:d,rotationZ:f,rotationDeg:h}=r.transformFieldRoles;t.outFields.push(o,s,n,u,i,a,c,l,p,y,d,f,h)}}return t},a._normalizeFields=function(e){if(null!=this.fieldsIndex&&null!=e)for(const t of e){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}},a._queryIs3DObjectFormat=function(e){return null!=this.infoFor3D&&!0===e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics},t._createClass(o,[{key:"parsedUrl",get:function(){return i.urlToObject(this.url)}}]),o}(o);r.__decorate([a.property({type:d.DataLayerSource})],O.prototype,"dynamicDataSource",void 0),r.__decorate([a.property()],O.prototype,"fieldsIndex",void 0),r.__decorate([a.property()],O.prototype,"gdbVersion",void 0),r.__decorate([a.property()],O.prototype,"infoFor3D",void 0),r.__decorate([a.property({readOnly:!0})],O.prototype,"parsedUrl",null),r.__decorate([a.property()],O.prototype,"pbfSupported",void 0),r.__decorate([a.property()],O.prototype,"queryAttachmentsSupported",void 0),r.__decorate([a.property()],O.prototype,"sourceSpatialReference",void 0),r.__decorate([a.property({type:String})],O.prototype,"url",void 0),O=r.__decorate([p.subclass("esri.tasks.QueryTask")],O);return O}));
